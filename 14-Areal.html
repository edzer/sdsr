<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Spatial Data Science - 14&nbsp; Proximity and Areal Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./15-Measures.html" rel="next">
<link href="./13-Geostatistics.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-04YTZNEH1K"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
 
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'analytics_storage': 'denied'
  });
gtag('config', 'G-04YTZNEH1K', { 'anonymize_ip': true});
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-3.html">Models for Spatial Data</a></li><li class="breadcrumb-item"><a href="./14-Areal.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/edzer/sdsr/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-hello.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting Started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-Spaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Coordinates</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-Geometries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Spherical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spherical Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-Attributes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Attributes and Support</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-Cubes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R for Spatial Data Science</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-Introsf.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-Plotting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-Large.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Models for Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Statistical modelling of spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-PointPattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Point Pattern Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-Interpolation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-Geostatistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-Areal.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-Measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of Spatial Autocorrelation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-SpatialRegression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-Econometrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Spatial Econometrics Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sp-raster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Older R Spatial Packages</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rbasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">R Basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ERRATA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Errata to the printed ed.</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#representing-proximity-in-spdep" id="toc-representing-proximity-in-spdep" class="nav-link active" data-scroll-target="#representing-proximity-in-spdep"><span class="header-section-number">14.1</span> Representing proximity in <code>spdep</code></a></li>
  <li><a href="#contiguous-neighbours" id="toc-contiguous-neighbours" class="nav-link" data-scroll-target="#contiguous-neighbours"><span class="header-section-number">14.2</span> Contiguous neighbours</a></li>
  <li><a href="#graph-based-neighbours" id="toc-graph-based-neighbours" class="nav-link" data-scroll-target="#graph-based-neighbours"><span class="header-section-number">14.3</span> Graph-based neighbours</a></li>
  <li><a href="#distance-based-neighbours" id="toc-distance-based-neighbours" class="nav-link" data-scroll-target="#distance-based-neighbours"><span class="header-section-number">14.4</span> Distance-based neighbours</a></li>
  <li><a href="#weights-specification" id="toc-weights-specification" class="nav-link" data-scroll-target="#weights-specification"><span class="header-section-number">14.5</span> Weights specification</a></li>
  <li><a href="#higher-order-neighbours" id="toc-higher-order-neighbours" class="nav-link" data-scroll-target="#higher-order-neighbours"><span class="header-section-number">14.6</span> Higher order neighbours</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">14.7</span> Exercises</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/14-Areal.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-3.html">Models for Spatial Data</a></li><li class="breadcrumb-item"><a href="./14-Areal.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-area" class="quarto-section-identifier"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>Areal units of observation are very often used when simultaneous observations are aggregated within non-overlapping boundaries. The boundaries may be those of administrative entities and may be related to underlying spatial processes, such as commuting flows, but are usually arbitrary. If they do not match the underlying and unobserved spatial processes in one or more variables of interest, proximate areal units will contain parts of the underlying processes, engendering spatial autocorrelation. By proximity, we mean <em>closeness</em> in ways that make sense for the data generation processes thought to be involved. In cross-sectional geostatistical analysis with point support, measured distance makes sense for typical data generation processes. In similar analysis of areal data, sharing a border may make more sense, because that is what we do know, but we cannot measure the distance between the areas in as adequate a way.</p>
<p> </p>
<p>By support of data we mean the physical size (length, area, volume) associated with an individual observational unit (measurement; see <a href="05-Attributes.html" class="quarto-xref"><span>Chapter 5</span></a>). It is possible to represent the support of areal data by a point, despite the fact that the data have polygonal support. The centroid of the polygon may be taken as a representative point, or the centroid of the largest polygon in a multi-polygon object. When data with intrinsic point support are treated as areal data, the change of support goes the other way, from the known point to a non-overlapping tessellation such as a Voronoi diagram or Dirichlet tessellation or Thiessen polygons often through a Delaunay triangulation using projected coordinates. Here, different metrics may also be chosen, or distances measured on a network rather than on the plane. There is also a literature using weighted Voronoi diagrams in local spatial analysis <span class="citation" data-cites="doi:10.1080/13658810601034267 doi:10.1080/13658810701587891 SHE201570">(see for example <a href="references.html#ref-doi:10.1080/13658810601034267" role="doc-biblioref">Boots and Okabe 2007</a>; <a href="references.html#ref-doi:10.1080/13658810701587891" role="doc-biblioref">Okabe et al. 2008</a>; <a href="references.html#ref-SHE201570" role="doc-biblioref">She et al. 2015</a>)</span>.</p>
<p></p>
<p>When the intrinsic support of the data is represented as points, but the underlying process is between proximate observations rather than driven chiefly by distance between observations, the data may be aggregate counts or totals (polling stations, retail turnover) or represent a directly observed characteristic of the observation (opening hours of the polling station). Obviously, the risk of misrepresenting the footprint of the underlying spatial processes remains in all of these cases, not least because the observations are taken as encompassing the entirety of the underlying process in the case of tessellation of the whole area of interest. This is distinct from the geostatistical setting in which observations are rather samples taken using some scheme within the area of interest. It is also partly distinct from the practice of taking areal sample plots within the area of interest but covering only a small proportion of the area, typically used in ecological and environmental research.</p>
<p></p>
<p>In order to explore and analyse areal data of these kinds in Chapters <a href="15-Measures.html" class="quarto-xref"><span>15</span></a>-<a href="17-Econometrics.html" class="quarto-xref"><span>17</span></a>, methods are needed to represent the proximity of observations. This chapter considers a subset of such methods, where the spatial processes are considered as working through proximity understood in the first instance as contiguity, as a graph linking observations taken as neighbours. This graph is typically undirected and unweighted, but may be directed and/or weighted in certain settings, which then leads to further issues with regard to symmetry. In principle, proximity would be expected to operate symmetrically in space, that is that the influence of <span class="math inline">\(i\)</span> on <span class="math inline">\(j\)</span> and of <span class="math inline">\(j\)</span> on <span class="math inline">\(i\)</span> based on their relative positions should be equivalent. Edge effects are not considered in standard treatments.</p>
<p></p>
<section id="representing-proximity-in-spdep" class="level2" data-number="14.1"><h2 data-number="14.1" class="anchored" data-anchor-id="representing-proximity-in-spdep">
<span class="header-section-number">14.1</span> Representing proximity in <code>spdep</code>
</h2>
<p>Handling spatial autocorrelation using relationships to neighbours on a graph takes the graph as given, chosen by the analyst. This differs from the geostatistical approach in which the analyst chooses the binning of the empirical variogram and function used, and then the way the variogram is fitted. Both involve a priori choices, but represent the underlying correlation in different ways <span class="citation" data-cites="wall:04">(<a href="references.html#ref-wall:04" role="doc-biblioref">Wall 2004</a>)</span>. In Bavaud <span class="citation" data-cites="bavaud:98">(<a href="references.html#ref-bavaud:98" role="doc-biblioref">1998</a>)</span> and work citing his contribution, attempts have been made to place graph-based neighbours in a broader context.</p>
<p></p>
<p>One issue arising in the creation of objects representing neighbourhood relationships is that of no-neighbour areal units <span class="citation" data-cites="bivand+portnov:04">(<a href="references.html#ref-bivand+portnov:04" role="doc-biblioref">Bivand and Portnov 2004</a>)</span>. Islands or units separated by rivers may not be recognised as neighbours when the units have areal support and when using topological relationships such as shared boundaries. In some settings, for example <code>mrf</code> (Markov Random Field) terms in <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html">mgcv::gam</a></code> and similar model fitting functions, undirected connected graphs are required, which is violated when there are disconnected subgraphs.</p>
<p></p>
<p>No-neighbour observations can also occur when a distance threshold is used between points, where the threshold is smaller than the maximum nearest neighbour distance. Shared boundary contiguities are not affected by using geographical, unprojected coordinates, but all point-based approaches use distance in one way or another, and need to calculate distances in an appropriate way.</p>
<p>The <strong>spdep</strong> package provides an <code>nb</code> class for neighbours, a list of length equal to the number of observations, with integer vector components. No-neighbours are encoded as an integer vector with a single element <code>0L</code>, and observations with neighbours as sorted integer vectors containing values in <code>1L:n</code> pointing to the neighbouring observations. This is a typical row-oriented sparse representation of neighbours. <strong>spdep</strong> provides many ways of constructing <code>nb</code> objects, and the representation and construction functions are widely used in other packages.</p>
<p> </p>
<p><strong>spdep</strong> builds on the <code>nb</code> representation (undirected or directed graphs) with the <code>listw</code> object, a list with three components, an <code>nb</code> object, a matching list of numerical weights, and a single element character vector containing the single letter name of the way in which the weights were calculated. The most frequently used approach in the social sciences is calculating weights by row standardisation, so that all the non-zero weights for one observation will be the inverse of the cardinality of its set of neighbours (<code>1/card(nb)[i]</code>).</p>
<p>We will be using election data from the 2015 Polish presidential election in this chapter, with 2495 municipalities and Warsaw boroughs (see <a href="#fig-plotpolpres15" class="quarto-xref">Figure&nbsp;<span>14.1</span></a>) for a <strong>tmap</strong> map (<a href="08-Plotting.html#sec-tmap" class="quarto-xref"><span>Section 8.5</span></a>) of the municipality types, and complete count data from polling stations aggregated to these areal units. The data are an <strong>sf</strong> <code>sf</code> object:</p>
<p> </p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="co"># Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">pol_pres15</span>, package <span class="op">=</span> <span class="st">"spDataLarge"</span><span class="op">)</span></span>
<span><span class="va">pol_pres15</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">TERYT</span>, <span class="va">name</span>, <span class="va">types</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 6 features and 3 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: 235000 ymin: 367000 xmax: 281000 ymax: 413000</span></span>
<span><span class="co"># Projected CRS: ETRS89 / Poland CS92</span></span>
<span><span class="co">#    TERYT                name       types</span></span>
<span><span class="co"># 1 020101         BOLESŁAWIEC       Urban</span></span>
<span><span class="co"># 2 020102         BOLESŁAWIEC       Rural</span></span>
<span><span class="co"># 3 020103            GROMADKA       Rural</span></span>
<span><span class="co"># 4 020104        NOWOGRODZIEC Urban/rural</span></span>
<span><span class="co"># 5 020105          OSIECZNICA       Rural</span></span>
<span><span class="co"># 6 020106 WARTA BOLESŁAWIECKA       Rural</span></span>
<span><span class="co">#                         geometry</span></span>
<span><span class="co"># 1 MULTIPOLYGON (((261089 3855...</span></span>
<span><span class="co"># 2 MULTIPOLYGON (((254150 3837...</span></span>
<span><span class="co"># 3 MULTIPOLYGON (((275346 3846...</span></span>
<span><span class="co"># 4 MULTIPOLYGON (((251770 3770...</span></span>
<span><span class="co"># 5 MULTIPOLYGON (((263424 4060...</span></span>
<span><span class="co"># 6 MULTIPOLYGON (((267031 3870...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-tmap.github.io/tmap/">tmap</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># Breaking News: tmap 3.x is retiring. Please test v4, e.g. with</span></span>
<span><span class="co"># remotes::install_github('r-tmap/tmap')</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"types"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plotpolpres15" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plotpolpres15-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-Areal_files/figure-html/fig-plotpolpres15-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plotpolpres15-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14.1: Polish municipality types 2015
</figcaption></figure>
</div>
</div>
</div>
<p>For safety’s sake, we impose topological validity:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html">st_is_valid</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">pol_pres15</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html">st_make_valid</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Between early 2002 and April 2019, <strong>spdep</strong> contained functions for constructing and handling neighbour and spatial weights objects, tests for spatial autocorrelation, and model fitting functions. The latter have been split out into <strong>spatialreg</strong>, and will be discussed in subsequent chapters. <strong>spdep</strong> <span class="citation" data-cites="R-spdep">(<a href="references.html#ref-R-spdep" role="doc-biblioref">Bivand 2022</a>)</span> now accommodates objects represented using <strong>sf</strong> classes and <strong>sp</strong> classes directly.</p>
<p> </p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/">spdep</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="contiguous-neighbours" class="level2" data-number="14.2"><h2 data-number="14.2" class="anchored" data-anchor-id="contiguous-neighbours">
<span class="header-section-number">14.2</span> Contiguous neighbours</h2>
<p> </p>
<p>The <code>poly2nb</code> function in <strong>spdep</strong> takes the boundary points making up the polygon boundaries in the object passed as the <code>pl</code> argument, typically an <code>"sf"</code> or <code>"sfc"</code> object with <code>"POLYGON"</code> or <code>"MULTIPOLYGON"</code> geometries. For each observation, the function checks whether at least one (<code>queen=TRUE</code>, default), or at least two (rook, <code>queen=FALSE</code>) points are within <code>snap</code> distance units of each other. The distances are planar in the raw coordinate units, ignoring geographical projections. Once the required number of sufficiently close points is found, the search is stopped.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="va">poly2nb</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>#  function (pl, row.names = NULL, snap = sqrt(.Machine$double.eps),
#    queen = TRUE, useC = TRUE, foundInBox = NULL)</code></pre>
</div>
<p>From <strong>spdep</strong> 1.1-7, the <strong>sf</strong> package GEOS interface is used within <code>poly2nb</code> to find the candidate neighbours and populate <code>foundInBox</code> internally. In this case, the use of spatial indexing (STRtree queries) in GEOS through <strong>sf</strong> is the default:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pol_pres15</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">poly2nb</a></span><span class="op">(</span>queen <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_q</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The print method shows the summary structure of the neighbour object:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb_q</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 14242 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.229 </span></span>
<span><span class="co"># Average number of links: 5.71</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From <strong>sf</strong> version 1.0-0, the <strong>s2</strong> package <span class="citation" data-cites="R-s2">(<a href="references.html#ref-R-s2" role="doc-biblioref">Dunnington, Pebesma, and Rubak 2023</a>)</span> is used by default for spherical geometries, as <code>st_intersects</code> used in <code>poly2nb</code> passes calculation to <code><a href="https://r-spatial.github.io/s2/reference/s2_closest_feature.html">s2::s2_intersects_matrix</a></code> (see <a href="04-Spherical.html" class="quarto-xref"><span>Chapter 4</span></a>). From <strong>spdep</strong> version 1.1-9, if <code><a href="https://r-spatial.github.io/sf/reference/s2.html">sf_use_s2()</a></code> is <code>TRUE</code>, spherical intersection is used to find candidate neighbours; as with GEOS, the underlying <code>s2</code> library uses fast spatial indexing.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">old_use_s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html">sf_use_s2</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html">sf_use_s2</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">pol_pres15</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="st">"OGC:CRS84"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15_ll</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">poly2nb</a></span><span class="op">(</span>queen <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_q_s2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p> </p>
<p>Spherical and planar intersection of the input polygons yield the same contiguity neighbours in this case; in both cases valid input geometries are desirable:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">nb_q</span>, <span class="va">nb_q_s2</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that <code>nb</code> objects record both symmetric neighbour relationships <code>i</code> to <code>j</code> and <code>j</code> to <code>i</code>, because these objects admit asymmetric relationships as well, but these duplications are not needed for object construction.</p>
<p>Most of the <strong>spdep</strong> functions for constructing neighbour objects take a <code>row.names</code> argument, the value of which is stored as a <code>region.id</code> attribute. If not given, the values are taken from <code><a href="https://rdrr.io/r/base/row.names.html">row.names()</a></code> of the first argument. These can be used to check that the neighbours object is in the same order as data. If <code>nb</code> objects are subsetted, the indices change to continue to be within <code>1:length(subsetted_nb)</code>, but the <code>region.id</code> attribute values point back to the object from which it was constructed. This is used in out-of-sample prediction from spatial regression models discussed briefly in <a href="17-Econometrics.html#sec-spateconpred" class="quarto-xref"><span>Section 17.4</span></a>.</p>
<p>We can also check that this undirected graph is connected using the <code>n.comp.nb</code> function; while some model estimation techniques do not support graphs that are not connected, it is helpful to be aware of possible problems <span class="citation" data-cites="FRENISTERRANTINO201825">(<a href="references.html#ref-FRENISTERRANTINO201825" role="doc-biblioref">Freni-Sterrantino, Ventrucci, and Rue 2018</a>)</span>:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_q</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/compon.html">n.comp.nb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">nc</span></span>
<span><span class="co"># [1] 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>This approach is equivalent to treating the neighbour object as a graph and using graph analysis on that graph <span class="citation" data-cites="csardi+nepusz:06 R-igraph">(<a href="references.html#ref-csardi+nepusz:06" role="doc-biblioref">Csardi and Nepusz 2006</a>; <a href="references.html#ref-R-igraph" role="doc-biblioref">Nepusz 2022</a>)</span>, by first coercing to a binary sparse matrix <span class="citation" data-cites="R-Matrix">(<a href="references.html#ref-R-Matrix" role="doc-biblioref">Bates, Maechler, and Jagan 2022</a>)</span>:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org/">Matrix</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spatialreg/">spatialreg</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">nb_q</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="st">"CsparseMatrix"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">smat</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r.igraph.org/">igraph</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">smat</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r.igraph.org/reference/graph_from_adjacency_matrix.html">graph_from_adjacency_matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">g1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r.igraph.org/reference/components.html">count_components</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># [1] 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p> </p>
<p>Neighbour objects may be exported and imported in GAL format for exchange with other software, using <code>write.nb.gal</code> and <code>read.gal</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".gal"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/write.nb.gal.html">write.nb.gal</a></span><span class="op">(</span><span class="va">nb_q</span>, <span class="va">tf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section><section id="graph-based-neighbours" class="level2" data-number="14.3"><h2 data-number="14.3" class="anchored" data-anchor-id="graph-based-neighbours">
<span class="header-section-number">14.3</span> Graph-based neighbours</h2>
<p>If areal units are an appropriate representation, but only points on the plane have been observed, contiguity relationships may be approximated using graph-based neighbours. In this case, the imputed boundaries tessellate the plane such that points closer to one observation than any other fall within its polygon. The simplest form is by using triangulation, here using the <code>deldir</code> function in the <strong>deldir</strong> package. Because the function returns from <span class="math inline">\(i\)</span> and to <span class="math inline">\(j\)</span> identifiers, it is easy to construct a long representation of a <code>listw</code> object, as used in the S-Plus SpatialStats module and the <code>sn2listw</code> function internally to construct an <code>nb</code> object (ragged wide representation). Alternatives such as GEOS often fail to return sufficient information to permit the neighbours to be identified.</p>
<p>The output of these functions is then converted to the <code>nb</code> representation using <code>graph2nb</code>, with the possible use of the <code>sym</code> argument to coerce to symmetry. We take the centroids of the largest component polygon for each observation as the point representation; population-weighted centroids might have been a better choice if they were available:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pol_pres15</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span>of_largest_polygon <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">coords</span> </span>
<span><span class="op">(</span><span class="va">coords</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/tri2nb.html">tri2nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_tri</span><span class="op">)</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 14930 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.24 </span></span>
<span><span class="co"># Average number of links: 5.98</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The average number of neighbours is similar to the Queen boundary contiguity case, but if we look at the distribution of edge lengths using <code><a href="https://r-spatial.github.io/spdep/reference/nbdists.html">nbdists()</a></code>, we can see that although the upper quartile is about 15 km, the maximum is almost 300 km, an edge along much of one side of the convex hull. The short minimum distance is also of interest, as many centroids of urban municipalities are very close to the centroids of their surrounding rural counterparts.</p>
<p> </p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb_tri</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nbdists.html">nbdists</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#     247    9847   12151   13485   14994  296974</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Triangulated neighbours also yield a connected graph:</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_tri</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/compon.html">n.comp.nb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">nc</span></span>
<span><span class="co"># [1] 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Graph-based approaches include <code>soi.graph</code> - discussed here, <code>relativeneigh</code> and <code>gabrielneigh</code>.</p>
<p>The Sphere of Influence <code>soi.graph</code> function takes triangulated neighbours and prunes off neighbour relationships represented by edges that are unusually long for each point, especially around the convex hull <span class="citation" data-cites="avis+horton:1985">(<a href="references.html#ref-avis+horton:1985" role="doc-biblioref">Avis and Horton 1985</a>)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_tri</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/graphneigh.html">soi.graph</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/graphneigh.html">graph2nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_soi</span><span class="op">)</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 12792 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.205 </span></span>
<span><span class="co"># Average number of links: 5.13 </span></span>
<span><span class="co"># 16 disjoint connected subgraphs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unpicking the triangulated neighbours does however remove the connected character of the underlying graph:</p>
<p> </p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_soi</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/compon.html">n.comp.nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">n_comp</span><span class="op">)</span><span class="op">$</span><span class="va">nc</span></span>
<span><span class="co"># [1] 16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The algorithm has stripped out longer edges leading to urban and rural municipality pairs where their centroids are very close to each other because the rural ones completely surround the urban, giving 15 pairs of neighbours unconnected to the main graph:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">n_comp</span><span class="op">$</span><span class="va">comp.id</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#    1    2    3    4    5    6    7    8    9   10   11   12   13 </span></span>
<span><span class="co"># 2465    2    2    2    2    2    2    2    2    2    2    2    2 </span></span>
<span><span class="co">#   14   15   16 </span></span>
<span><span class="co">#    2    2    2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The largest length edges along the convex hull have been removed, but “holes” have appeared where the unconnected pairs of neighbours have appeared. The differences between <code>nb_tri</code> and <code>nb_soi</code> are shown in orange in <a href="#fig-plotnbdiff" class="quarto-xref">Figure&nbsp;<span>14.2</span></a>. <!---
unsure whether the new cross-reference in the caption will be rendered correctly
---></p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">opar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">+</span><span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">pol_pres15</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>border <span class="op">=</span> <span class="st">"grey"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">nb_soi</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="va">coords</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>               points <span class="op">=</span> <span class="cn">FALSE</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">nb_tri</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/diffnb.html">diffnb</a></span><span class="op">(</span><span class="va">nb_soi</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="va">coords</span>, col <span class="op">=</span> <span class="st">"orange"</span>, add <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>         points <span class="op">=</span> <span class="cn">FALSE</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">opar</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-plotnbdiff" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plotnbdiff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-Areal_files/figure-html/fig-plotnbdiff-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plotnbdiff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14.2: Triangulated (orange + black) and sphere of influence neighbours (black); apparent holes appear for sphere of influence neighbours where an urban municipality is surrounded by a dominant rural municipality (see <a href="#fig-plotpolpres15" class="quarto-xref">Figure&nbsp;<span>14.1</span></a>)
</figcaption></figure>
</div>
</div>
</div>
</section><section id="distance-based-neighbours" class="level2" data-number="14.4"><h2 data-number="14.4" class="anchored" data-anchor-id="distance-based-neighbours">
<span class="header-section-number">14.4</span> Distance-based neighbours</h2>
<p> </p>
<p>Distance-based neighbours can be constructed using <code>dnearneigh</code>, with a distance band with lower <code>d1</code> and upper <code>d2</code> bounds controlled by the <code>bounds</code> argument. If spherical coordinates are used and either specified in the coordinates object <code>x</code> or with <code>x</code> as a two-column matrix and <code>longlat=TRUE</code>, great circle distances in kilometre will be calculated assuming the WGS84 reference ellipsoid, or if <code>use_s2=TRUE</code> (the default value) using the spheroid (see <a href="04-Spherical.html" class="quarto-xref"><span>Chapter 4</span></a>). If <code>dwithin</code> is <code>FALSE</code> and the version of <strong>s2</strong> is greater than <code>1.0.7</code>, <code>s2_closest_edges</code> may be used, if <code>TRUE</code> and <code>use_s2=TRUE</code>, <code>s2_dwithin_matrix</code> is used; both of these methods use fast spherical spatial indexing, but because <code>s2_closest_edges</code> takes minimum and maximum bounds, it only needs one pass in the R code of <code>dnearneigh</code>.</p>
<p></p>
<p>Arguments have been added to use functionality in the <strong>dbscan</strong> package <span class="citation" data-cites="R-dbscan">(<a href="references.html#ref-R-dbscan" role="doc-biblioref">Hahsler and Piekenbrock 2022</a>)</span> for finding neighbours using planar spatial indexing in two or three dimensions by default, and not to test the symmetry of the output neighbour object. In addition, three arguments relate to the use of spherical geometry distance measurements.</p>
<p> </p>
<p>The <code>knearneigh</code> function for <span class="math inline">\(k\)</span>-nearest neighbours returns a <code>knn</code> object, converted to an <code>nb</code> object using <code>knn2nb</code>. It can also use great circle distances, not least because nearest neighbours may differ when unprojected coordinates are treated as planar. <code>k</code> should be a small number. For projected coordinates, the <strong>dbscan</strong> package is used to compute nearest neighbours more efficiently. Note that <code>nb</code> objects constructed in this way are most unlikely to be symmetric hence <code>knn2nb</code> has a <code>sym</code> argument to permit the imposition of symmetry, which will mean that all units have at least <code>k</code> neighbours, not that all units will have exactly <code>k</code> neighbours. When <code><a href="https://r-spatial.github.io/sf/reference/s2.html">sf_use_s2()</a></code> is <code>TRUE</code>, <code>knearneigh</code> will use fast spherical spatial indexing when the input object is of class <code>"sf"</code> or <code>"sfc"</code>.</p>
<p></p>
<p>The <code>nbdists</code> function returns the length of neighbour relationship edges in the units of the coordinates if the coordinates are projected, in kilometre otherwise. In order to set the upper limit for distance bands, one may first find the maximum first nearest neighbour distance, using <code>unlist</code> to remove the list structure of the returned object. When <code><a href="https://r-spatial.github.io/sf/reference/s2.html">sf_use_s2()</a></code> is <code>TRUE</code>, <code>nbdists</code> will use fast spherical distance calculations when the input object is of class <code>"sf"</code> or <code>"sfc"</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">coords</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knearneigh.html">knearneigh</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nbdists.html">nbdists</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#     247    6663    8538    8275   10124   17979</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here the largest first nearest neighbour distance is just under 18 km, so using this as the upper threshold gives certainty that all units will have at least one neighbour:</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">coords</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">18000</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_d18</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For this moderate number of observations, use of spatial indexing does not yield advantages in run times:</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">coords</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">18000</span>, use_kd_tree <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_d18a</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and the output objects are the same:</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">nb_d18</span>, <span class="va">nb_d18a</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb_d18</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 20358 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.327 </span></span>
<span><span class="co"># Average number of links: 8.16 </span></span>
<span><span class="co"># 2 disjoint connected subgraphs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, even though there are no no-neighbour observations (their presence is reported by the print method for <code>nb</code> objects), the graph is not connected, as a pair of observations are each others’ only neighbours.</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_d18</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/compon.html">n.comp.nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">n_comp</span><span class="op">)</span><span class="op">$</span><span class="va">nc</span></span>
<span><span class="co"># [1] 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">n_comp</span><span class="op">$</span><span class="va">comp.id</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#    1    2 </span></span>
<span><span class="co"># 2493    2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Adding 300 m to the threshold gives us a neighbour object with no no-neighbour units, and all units can be reached from all others across the graph.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">coords</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">18300</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_d183</span><span class="op">)</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 21086 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.339 </span></span>
<span><span class="co"># Average number of links: 8.45</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_d183</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/compon.html">n.comp.nb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">nc</span></span>
<span><span class="co"># [1] 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One characteristic of distance-based neighbours is that more densely settled areas, with units which are smaller in terms of area, have higher neighbour counts (Warsaw boroughs are much smaller on average, but have almost 30 neighbours for this distance criterion). Having many neighbours smooths the neighbour relationship across more neighbours.</p>
<p>For use later, we also construct a neighbour object with no-neighbour units, using a threshold of 16 km:</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">coords</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">16000</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_d16</span><span class="op">)</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 15850 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.255 </span></span>
<span><span class="co"># Average number of links: 6.35 </span></span>
<span><span class="co"># 7 regions with no links:</span></span>
<span><span class="co"># 569 1371 1522 2374 2385 2473 2474</span></span>
<span><span class="co"># 17 disjoint connected subgraphs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is possible to control the numbers of neighbours directly using <span class="math inline">\(k\)</span>-nearest neighbours, either accepting asymmetric neighbours:</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="op">(</span><span class="va">coords</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knearneigh.html">knearneigh</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">knn_k6</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_k6</span><span class="op">)</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 14970 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.24 </span></span>
<span><span class="co"># Average number of links: 6 </span></span>
<span><span class="co"># Non-symmetric neighbours list</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or imposing symmetry:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">knn_k6</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knn2nb.html">knn2nb</a></span><span class="op">(</span>sym <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_k6s</span><span class="op">)</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 16810 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.27 </span></span>
<span><span class="co"># Average number of links: 6.74</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here the size of <code>k</code> is sufficient to ensure connectedness, although the graph is not planar as edges cross at locations other than nodes, which is not the case for contiguous or graph-based neighbours.</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_k6s</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/compon.html">n.comp.nb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">nc</span></span>
<span><span class="co"># [1] 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the case of points on the sphere (see <a href="04-Spherical.html" class="quarto-xref"><span>Chapter 4</span></a>), the output of <code>st_centroid</code> will differ, so rather than inverse projecting the points, we extract points as geographical coordinates from the inverse projected polygon geometries:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">old_use_s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html">sf_use_s2</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html">sf_use_s2</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pol_pres15_ll</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span>of_largest_polygon <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">coords_ll</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For spherical coordinates, distance bounds are in kilometres:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">coords_ll</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">18.3</span>, use_s2 <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                         dwithin <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_d183_ll</span><span class="op">)</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 21140 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.34 </span></span>
<span><span class="co"># Average number of links: 8.47</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These neighbours differ from the spherical 18.3 km neighbours as would be expected:</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">nb_d183</span>, <span class="va">nb_d183_ll</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If <strong>s2</strong> providing faster distance neighbour indexing is available, by default <code>s2_closest_edges</code> will be used for geographical coordinates:</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">coords_ll</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">18.3</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_d183_llce</span><span class="op">)</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 21140 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.34 </span></span>
<span><span class="co"># Average number of links: 8.47</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where the two <strong>s2</strong>-based neighbour objects are the same:</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">nb_d183_llce</span>, <span class="va">nb_d183_ll</span>,</span>
<span>                 check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fast spherical spatial indexing in <strong>s2</strong> is used to find <span class="math inline">\(k\)</span> nearest neighbours:</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">coords_ll</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knearneigh.html">knearneigh</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_k6_ll</span><span class="op">)</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 14970 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.24 </span></span>
<span><span class="co"># Average number of links: 6 </span></span>
<span><span class="co"># Non-symmetric neighbours list</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These neighbours differ from the planar <code>k=6</code> nearest neighbours as would be expected, but will also differ slightly from legacy brute-force ellipsoid distances:</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">nb_k6</span>, <span class="va">nb_k6_ll</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>nbdists</code> function also uses <strong>s2</strong> to find distances on the sphere when the <code>"sf"</code> or <code>"sfc"</code>input object is in geographical coordinates (distances returned in kilometres):</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb_q</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nbdists.html">nbdists</a></span><span class="op">(</span><span class="va">coords_ll</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#     0.2     9.8    12.2    12.6    15.1    33.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These differ a little for the same weights object when planar coordinates are used (distances returned in the metric of the points for planar geometries and kilometres for ellipsoidal and spherical geometries):</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb_q</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nbdists.html">nbdists</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#     247    9822   12173   12651   15117   33102</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html">sf_use_s2</a></span><span class="op">(</span><span class="va">old_use_s2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="weights-specification" class="level2" data-number="14.5"><h2 data-number="14.5" class="anchored" data-anchor-id="weights-specification">
<span class="header-section-number">14.5</span> Weights specification</h2>
<p>Once neighbour objects are available, further choices need to be made in specifying the weights objects. The <code>nb2listw</code> function is used to create a <code>listw</code> weights object with an <code>nb</code> object, a matching list of weights vectors, and a style specification. Because handling no-neighbour observations now begins to matter, the <code>zero.policy</code> argument is introduced. By default, this is <code>FALSE</code>, indicating that no-neighbour observations will cause an error, as the spatially lagged value for an observation with no neighbours is not available. By convention, zero is substituted for the lagged value, as the cross-product of a vector of zero-valued weights and a data vector, hence the name of <code>zero.policy</code>.</p>
<p> </p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="va">nb2listw</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>#  function (neighbours, glist = NULL, style = "W", zero.policy =
#    NULL)</code></pre>
</div>
<p>We will be using the helper function <code>spweights.constants</code> below to show some consequences of varying style choices. It returns constants for a <code>listw</code> object, <span class="math inline">\(n\)</span> is the number of observations, <code>n1</code> to <code>n3</code> are <span class="math inline">\(n-1, \ldots\)</span>, <code>nn</code> is <span class="math inline">\(n^2\)</span> and <span class="math inline">\(S_0\)</span>, <span class="math inline">\(S_1\)</span> and <span class="math inline">\(S_2\)</span> are constants, <span class="math inline">\(S_0\)</span> being the sum of the weights. There is a full discussion of the constants in <span class="citation" data-cites="Bivand2018">Bivand and Wong (<a href="references.html#ref-Bivand2018" role="doc-biblioref">2018</a>)</span>.</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="va">spweights.constants</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>#  function (listw, zero.policy = attr(listw, "zero.policy"),
#    adjust.n = TRUE)</code></pre>
</div>
<p>The <code>"B"</code> binary style gives a weight of unity to each neighbour relationship, and typically up-weights units with no boundaries on the edge of the study area, having a higher count of neighbours.</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_q</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">lw_q_B</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/spweights.constants.html">spweights.constants</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">S0</span>, <span class="va">S1</span>, <span class="va">S2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#      n    S0    S1     S2</span></span>
<span><span class="co"># 1 2495 14242 28484 357280</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The <code>"W"</code> row-standardised style up-weights units around the edge of the study area that necessarily have fewer neighbours. This style first gives a weight of unity to each neighbour relationship, then it divides these weights by the per unit sums of weights. Naturally this leads to division by zero where there are no neighbours, a not-a-number result, unless the chosen policy is to permit no-neighbour observations. We can see that <span class="math inline">\(S_0\)</span> is now equal to <span class="math inline">\(n\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_q</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"W"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">lw_q_W</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/spweights.constants.html">spweights.constants</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">S0</span>, <span class="va">S1</span>, <span class="va">S2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#      n   S0  S1    S2</span></span>
<span><span class="co"># 1 2495 2495 958 10406</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Inverse distance weights are used in a number of scientific fields. Some use dense inverse distance matrices, but many of the inverse distances are close to zero, have little practical contribution, especially as the spatial process matrix is itself dense. Inverse distance weights may be constructed by taking the lengths of edges, changing units to avoid most weights being too large or small (here from metre to kilometre), taking the inverse, and passing through the <code>glist</code> argument to <code>nb2listw</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb_d183</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nbdists.html">nbdists</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">gwts</span></span>
<span><span class="op">(</span><span class="va">nb_d183</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span>glist<span class="op">=</span><span class="va">gwts</span>, style<span class="op">=</span><span class="st">"B"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">lw_d183_idw_B</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/spweights.constants.html">spweights.constants</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">S0</span>, <span class="va">S1</span>, <span class="va">S2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#      n   S0  S1   S2</span></span>
<span><span class="co"># 1 2495 1841 534 7265</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>No-neighbour handling is by default to prevent the construction of a weights object, making the analyst take a position on how to proceed.</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="va">nb_d16</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span>style<span class="op">=</span><span class="st">"B"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">lw_d16_B</span><span class="op">)</span></span>
<span><span class="co"># Error in nb2listw(nb_d16, style = "B") : Empty neighbour sets found</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use can be made of the <code>zero.policy</code> argument to many functions used with <code>nb</code> and <code>listw</code> objects.</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb_d16</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span>style<span class="op">=</span><span class="st">"B"</span>, zero.policy<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/spweights.constants.html">spweights.constants</a></span><span class="op">(</span>zero.policy<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">S0</span>, <span class="va">S1</span>, <span class="va">S2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#      n    S0    S1     S2</span></span>
<span><span class="co"># 1 2488 15850 31700 506480</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that by default the <code>adjust.n</code> argument to <code>spweights.constants</code> is set by default to <code>TRUE</code>, subtracting the count of no-neighbour observations from the observation count, so <span class="math inline">\(n\)</span> is smaller with possible consequences for inference. The complete count can be retrieved by changing the argument.</p>
</section><section id="higher-order-neighbours" class="level2" data-number="14.6"><h2 data-number="14.6" class="anchored" data-anchor-id="higher-order-neighbours">
<span class="header-section-number">14.6</span> Higher order neighbours</h2>
<p></p>
<p>We recall the characteristics of the neighbour object based on Queen contiguities:</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb_q</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 14242 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.229 </span></span>
<span><span class="co"># Average number of links: 5.71</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we wish to create an object showing <span class="math inline">\(i\)</span> to <span class="math inline">\(k\)</span> neighbours, where <span class="math inline">\(i\)</span> is a neighbour of <span class="math inline">\(j\)</span>, and <span class="math inline">\(j\)</span> in turn is a neighbour of <span class="math inline">\(k\)</span>, so taking two steps on the neighbour graph, we can use <code>nblag</code>, which automatically removes <span class="math inline">\(i\)</span> to <span class="math inline">\(i\)</span> self-neighbours:</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_q</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nblag.html">nblag</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_q2</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 32930 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.529 </span></span>
<span><span class="co"># Average number of links: 13.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>nblag_cumul</code> function cumulates the list of neighbours for the whole list of lags:</p>
<p> </p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nblag.html">nblag_cumul</a></span><span class="op">(</span><span class="va">nb_q2</span><span class="op">)</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 47172 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.758 </span></span>
<span><span class="co"># Average number of links: 18.9</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>while the set operation <code>union.nb</code> takes two objects, giving here the same outcome: </p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nboperations.html">union.nb</a></span><span class="op">(</span><span class="va">nb_q2</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">nb_q2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># Neighbour list object:</span></span>
<span><span class="co"># Number of regions: 2495 </span></span>
<span><span class="co"># Number of nonzero links: 47172 </span></span>
<span><span class="co"># Percentage nonzero weights: 0.758 </span></span>
<span><span class="co"># Average number of links: 18.9</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Returning to the graph representation of the same neighbour object, we can ask how many steps might be needed to traverse the graph:</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r.igraph.org/reference/diameter.html">diameter</a></span><span class="op">(</span><span class="va">g1</span><span class="op">)</span></span>
<span><span class="co"># [1] 52</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We step out from each observation across the graph to establish the number of steps needed to reach each other observation by the shortest path (creating an <span class="math inline">\(n \times n\)</span> matrix <code>sps</code>), once again finding the same maximum count.</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g1</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r.igraph.org/reference/distances.html">distances</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">sps</span></span>
<span><span class="op">(</span><span class="va">sps</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">max</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">spmax</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># [1] 52</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The municipality with the maximum count is called Lutowiska, close to the Ukrainian border in the far south east of the country:</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="va">spmax</span><span class="op">)</span></span>
<span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">name0</span><span class="op">[</span><span class="va">mr</span><span class="op">]</span></span>
<span><span class="co"># [1] "Lutowiska"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-shortestpath" class="quarto-xref">Figure&nbsp;<span>14.3</span></a> shows that contiguity neighbours represent the same kinds of relationships with other observations as distance. Some approaches prefer distance neighbours on the basis that, for example, inverse distance neighbours show clearly how all observations are related to each other. However, the development of tests for spatial autocorrelation and spatial regression models has involved the inverse of a spatial process model, which in turn can be represented as the sum of a power series of the product of a coefficient and a spatial weights matrix, intrinsically acknowledging the relationships of all observations with all other observations. Sparse contiguity neighbour objects accommodate rich dependency structures without the need to make the structures explicit.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">sps1</span> <span class="op">&lt;-</span> <span class="va">sps</span><span class="op">[</span>,<span class="va">mr</span><span class="op">]</span></span>
<span><span class="va">tm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"sps1"</span>, title <span class="op">=</span> <span class="st">"Shortest path\ncount"</span><span class="op">)</span></span>
<span><span class="va">coords</span><span class="op">[</span><span class="va">mr</span><span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_distance</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">dist_52</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">pol_pres15</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sps1</span>, y <span class="op">=</span> <span class="va">dist_52</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Shortest path count"</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"km distance"</span><span class="op">)</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tmap_grob.html">tmap_grob</a></span><span class="op">(</span><span class="va">tm1</span><span class="op">)</span>, <span class="va">g1</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-shortestpath" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-shortestpath-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-Areal_files/figure-html/fig-shortestpath-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shortestpath-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14.3: Relationship of shortest paths to distance for Lutowiska; left panel: shortest path counts from Lutowiska; right panel: plot of shortest paths from Lutowiska to other observations, and distances from Lutowiska to other observations
</figcaption></figure>
</div>
</div>
</div>
</section><section id="exercises" class="level2" data-number="14.7"><h2 data-number="14.7" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">14.7</span> Exercises</h2>
<ol type="1">
<li>Which kinds of geometry support are appropriate for which functions creating neighbour objects?</li>
<li>Which functions creating neighbour objects are only appropriate for planar representations?</li>
<li>What difference might the choice of <code>rook</code> rather than <code>queen</code> contiguities make on a chessboard?</li>
<li>What are the relationships between neighbour set cardinalities (neighbour counts) and row-standardised weights, and how do they open analyses up to edge effects? Use the chessboard you constructed in exercise 3 for both <code>rook</code> and <code>queen</code> neighbours.</li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-avis+horton:1985" class="csl-entry" role="listitem">
Avis, D., and J. Horton. 1985. <span>“Remarks on the Sphere of Influence Graph.”</span> In <em>Discrete Geometry and Convexity</em>, edited by J. E. Goodman, 323–27. New York: New York Academy of Sciences, New York.
</div>
<div id="ref-R-Matrix" class="csl-entry" role="listitem">
Bates, Douglas, Martin Maechler, and Mikael Jagan. 2022. <em>Matrix: Sparse and Dense Matrix Classes and Methods</em>. <a href="https://CRAN.R-project.org/package=Matrix">https://CRAN.R-project.org/package=Matrix</a>.
</div>
<div id="ref-bavaud:98" class="csl-entry" role="listitem">
Bavaud, F. 1998. <span>“Models for Spatial Weights: A Systematic Look.”</span> <em>Geographical Analysis</em> 30: 153–71. <a href="https://doi.org/10.1111/j.1538-4632.1998.tb00394.x">https://doi.org/10.1111/j.1538-4632.1998.tb00394.x</a>.
</div>
<div id="ref-R-spdep" class="csl-entry" role="listitem">
Bivand, Roger. 2022. <em>Spdep: Spatial Dependence: Weighting Schemes, Statistics</em>.
</div>
<div id="ref-bivand+portnov:04" class="csl-entry" role="listitem">
Bivand, Roger, and B. A. Portnov. 2004. <span>“Exploring Spatial Data Analysis Techniques Using <span>R</span>: The Case of Observations with No Neighbours.”</span> In <em>Advances in Spatial Econometrics: Methodology, Tools, Applications</em>, edited by Luc Anselin, Raymond J. G. M. Florax, and S. J. Rey, 121–42. Berlin: Springer.
</div>
<div id="ref-Bivand2018" class="csl-entry" role="listitem">
Bivand, Roger, and David W. S. Wong. 2018. <span>“Comparing Implementations of Global and Local Indicators of Spatial Association.”</span> <em>TEST</em> 27 (3): 716–48. <a href="https://doi.org/10.1007/s11749-018-0599-x">https://doi.org/10.1007/s11749-018-0599-x</a>.
</div>
<div id="ref-doi:10.1080/13658810601034267" class="csl-entry" role="listitem">
Boots, B., and A. Okabe. 2007. <span>“Local Statistical Spatial Analysis: Inventory and Prospect.”</span> <em>International Journal of Geographical Information Science</em> 21 (4): 355–75. <a href="https://doi.org/10.1080/13658810601034267">https://doi.org/10.1080/13658810601034267</a>.
</div>
<div id="ref-csardi+nepusz:06" class="csl-entry" role="listitem">
Csardi, Gabor, and Tamas Nepusz. 2006. <span>“The Igraph Software Package for Complex Network Research.”</span> <em>InterJournal</em> Complex Systems: 1695. <a href="https://igraph.org">https://igraph.org</a>.
</div>
<div id="ref-R-s2" class="csl-entry" role="listitem">
Dunnington, Dewey, Edzer Pebesma, and Ege Rubak. 2023. <em>S2: Spherical Geometry Operators Using the S2 Geometry Library</em>. <a href="https://CRAN.R-project.org/package=s2">https://CRAN.R-project.org/package=s2</a>.
</div>
<div id="ref-FRENISTERRANTINO201825" class="csl-entry" role="listitem">
Freni-Sterrantino, Anna, Massimo Ventrucci, and Håvard Rue. 2018. <span>“A Note on Intrinsic Conditional Autoregressive Models for Disconnected Graphs.”</span> <em>Spatial and Spatio-Temporal Epidemiology</em> 26: 25–34. <a href="https://doi.org/10.1016/j.sste.2018.04.002">https://doi.org/10.1016/j.sste.2018.04.002</a>.
</div>
<div id="ref-R-dbscan" class="csl-entry" role="listitem">
Hahsler, Michael, and Matthew Piekenbrock. 2022. <em>Dbscan: Density-Based Spatial Clustering of Applications with Noise (DBSCAN) and Related Algorithms</em>. <a href="https://github.com/mhahsler/dbscan">https://github.com/mhahsler/dbscan</a>.
</div>
<div id="ref-R-igraph" class="csl-entry" role="listitem">
Nepusz, Tamás. 2022. <em>Igraph: Network Analysis and Visualization</em>. <a href="https://CRAN.R-project.org/package=igraph">https://CRAN.R-project.org/package=igraph</a>.
</div>
<div id="ref-doi:10.1080/13658810701587891" class="csl-entry" role="listitem">
Okabe, A., T. Satoh, T. Furuta, A. Suzuki, and K. Okano. 2008. <span>“Generalized Network Voronoi Diagrams: Concepts, Computational Methods, and Applications.”</span> <em>International Journal of Geographical Information Science</em> 22 (9): 965–94. <a href="https://doi.org/10.1080/13658810701587891">https://doi.org/10.1080/13658810701587891</a>.
</div>
<div id="ref-SHE201570" class="csl-entry" role="listitem">
She, Bing, Xinyan Zhu, Xinyue Ye, Wei Guo, Kehua Su, and Jay Lee. 2015. <span>“Weighted Network Voronoi Diagrams for Local Spatial Analysis.”</span> <em>Computers, Environment and Urban Systems</em> 52: 70–80. <a href="https://doi.org/10.1016/j.compenvurbsys.2015.03.005">https://doi.org/10.1016/j.compenvurbsys.2015.03.005</a>.
</div>
<div id="ref-wall:04" class="csl-entry" role="listitem">
Wall, M. M. 2004. <span>“A Close Look at the Spatial Structure Implied by the <span>CAR</span> and <span>SAR</span> Models.”</span> <em>Journal of Statistical Planning and Inference</em> 121: 311–24.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/r-spatial\.org\/book\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./13-Geostatistics.html" class="pagination-link" aria-label="Multivariate and Spatiotemporal Geostatistics">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./15-Measures.html" class="pagination-link" aria-label="Measures of Spatial Autocorrelation">
        <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of Spatial Autocorrelation</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb66" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Proximity and Areal Data  {#sec-area}</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>Areal units of observation are very often used when simultaneous observations are aggregated within non-overlapping boundaries. The boundaries may be those of administrative entities and may be related to underlying spatial processes, such as commuting flows, but are usually arbitrary. If they do not match the underlying and unobserved spatial processes in one or more variables of interest, proximate areal units will contain parts of the underlying processes, engendering spatial autocorrelation. By proximity, we mean _closeness_ in ways that make sense for the data generation processes thought to be involved. In cross-sectional geostatistical analysis with point support, measured distance makes sense for typical data generation processes. In similar analysis of areal data, sharing a border may make more sense, because that is what we do know, but we cannot measure the distance between the areas in as adequate a way.  </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>\index{areal data}</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>\index{proximity, areal data}</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>By support of data we mean the physical size (length, area, volume) associated with an individual observational unit (measurement; see @sec-featureattributes).  It is possible to represent the support of areal data by a point, despite the fact that the data have polygonal support. The centroid of the polygon may be taken as a representative point, or the centroid of the largest polygon in a multi-polygon object. When data with intrinsic point support are treated as areal data, the change of support goes the other way, from the known point to a non-overlapping tessellation such as a Voronoi diagram or Dirichlet tessellation or Thiessen polygons often through a Delaunay triangulation using projected coordinates. Here, different metrics may also be chosen, or distances measured on a network rather than on the plane. There is also a literature using weighted Voronoi diagrams in local spatial analysis <span class="co">[</span><span class="ot">see for example @doi:10.1080/13658810601034267; @doi:10.1080/13658810701587891; @SHE201570</span><span class="co">]</span>.</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>\index{weighted Voronoi diagram}</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>When the intrinsic support of the data is represented as points, but the underlying process is between proximate observations rather than driven chiefly by distance between observations, the data may be aggregate counts or totals (polling stations, retail turnover) or represent a directly observed characteristic of the observation (opening hours of the polling station). Obviously, the risk of misrepresenting the footprint of the underlying spatial processes remains in all of these cases, not least because the observations are taken as encompassing the entirety of the underlying process in the case of tessellation of the whole area of interest. This is distinct from the geostatistical setting in which observations are rather samples taken using some scheme within the area of interest. It is also partly distinct from the practice of taking areal sample plots within the area of interest but covering only a small proportion of the area, typically used in ecological and environmental research.</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>\index{footprint, spatial}</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>In order to explore and analyse areal data of these kinds in Chapters <span class="co">[</span><span class="ot">-@sec-spatautocorr</span><span class="co">]</span>-<span class="co">[</span><span class="ot">-@sec-spatecon</span><span class="co">]</span>, methods are needed to represent the proximity of observations. This chapter considers a subset of such methods, where the spatial processes are considered as working through proximity understood in the first instance as contiguity, as a graph linking observations taken as neighbours. This graph is typically undirected and unweighted, but may be directed and/or weighted in certain settings, which then leads to further issues with regard to symmetry. In principle, proximity would be expected to operate symmetrically in space, that is that the influence of $i$ on $j$ and of $j$ on $i$ based on their relative positions should be equivalent. Edge effects are not considered in standard treatments.</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>\index{neighbourhood graph}</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Representing proximity in `spdep`</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>Handling spatial autocorrelation using relationships to neighbours on a graph takes the graph as given, chosen by the analyst. This differs from the geostatistical approach in which the analyst chooses the binning of the empirical variogram and function used, and then the way the variogram is fitted. Both involve a priori choices, but represent the underlying correlation in different ways <span class="co">[</span><span class="ot">@wall:04</span><span class="co">]</span>. In Bavaud <span class="co">[</span><span class="ot">-@bavaud:98</span><span class="co">]</span> and work citing his contribution, attempts have been made to place graph-based neighbours in a broader context.</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>\index{spatial autocorrelation on graphs}</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>One issue arising in the creation of objects representing neighbourhood relationships is that of no-neighbour areal units <span class="co">[</span><span class="ot">@bivand+portnov:04</span><span class="co">]</span>. Islands or units separated by rivers may not be recognised as neighbours when the units have areal support and when using topological relationships such as shared boundaries. In some settings, for example <span class="in">`mrf`</span> (Markov Random Field) terms in <span class="in">`mgcv::gam`</span> and similar model fitting functions, undirected connected graphs are required, which is violated when there are disconnected subgraphs.</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>\index{spatial graphs, disconnected}</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>No-neighbour observations can also occur when a distance threshold is used between points, where the threshold is smaller than the maximum nearest neighbour distance. Shared boundary contiguities are not affected by using geographical, unprojected coordinates, but all point-based approaches use distance in one way or another, and need to calculate distances in an appropriate way.</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>The **spdep** package provides an `nb` class for neighbours, a list of length equal to the number of observations, with integer vector components. No-neighbours are encoded as an integer vector with a single element `0L`, and observations with neighbours as sorted integer vectors containing values in `1L:n` pointing to the neighbouring observations. This is a typical row-oriented sparse representation of neighbours. **spdep** provides many ways of constructing <span class="in">`nb`</span> objects, and the representation and construction functions are widely used in other packages. </span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>\index{nb objects}</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>\index{listw objects}</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>**spdep** builds on the <span class="in">`nb`</span> representation (undirected or directed graphs) with the <span class="in">`listw`</span> object, a list with three components, an <span class="in">`nb`</span> object, a matching list of numerical weights, and a single element character vector containing the single letter name of the way in which the weights were calculated. The most frequently used approach in the social sciences is calculating weights by row standardisation, so that all the non-zero weights for one observation will be the inverse of the cardinality of its set of neighbours (<span class="in">`1/card(nb)[i]`</span>).</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>We will be using election data from the 2015 Polish presidential election in this chapter, with 2495 municipalities and Warsaw boroughs (see @fig-plotpolpres15) for a **tmap** map (@sec-tmap) of the municipality types, and complete count data from polling stations aggregated to these areal units. The data are an **sf** <span class="in">`sf`</span> object:</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>\index{Polish Presidential election data}</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>\index{tmap}</span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>\index{spDataLarge}</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup_sa0, include=FALSE}</span></span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)</span></span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a><span class="in">owidth &lt;- getOption("width")</span></span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a><span class="in">xargs &lt;- function(x) {</span></span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a><span class="in">    o &lt;- capture.output(args(x))</span></span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a><span class="in">    oo &lt;- gsub("  *", " ", paste(o[-length(o)], collapse=""))</span></span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a><span class="in">    ooo &lt;- strwrap(oo, width=getOption("width"), indent=1, exdent=3)</span></span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(paste(ooo, collapse="\n"), "\n")</span></span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(pol_pres15, <span class="at">package =</span> <span class="st">"spDataLarge"</span>)</span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a>pol_pres15 <span class="sc">|&gt;</span></span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">select =</span> <span class="fu">c</span>(TERYT, name, types)) <span class="sc">|&gt;</span></span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>()</span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-plotpolpres15}</span></span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 100%</span></span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Polish municipality types 2015"</span></span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a><span class="in">library(tmap, warn.conflicts = FALSE)</span></span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a><span class="in">tm_shape(pol_pres15) + tm_fill("types")</span></span>
<span id="cb66-75"><a href="#cb66-75" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-76"><a href="#cb66-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-77"><a href="#cb66-77" aria-hidden="true" tabindex="-1"></a>For safety's sake, we impose topological validity:</span>
<span id="cb66-78"><a href="#cb66-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-81"><a href="#cb66-81" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-82"><a href="#cb66-82" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">st_is_valid</span>(pol_pres15)))</span>
<span id="cb66-83"><a href="#cb66-83" aria-hidden="true" tabindex="-1"></a>        pol_pres15 <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(pol_pres15)</span>
<span id="cb66-84"><a href="#cb66-84" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-85"><a href="#cb66-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-86"><a href="#cb66-86" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>make<span class="sc">\_</span>valid}</span>
<span id="cb66-87"><a href="#cb66-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-88"><a href="#cb66-88" aria-hidden="true" tabindex="-1"></a>Between early 2002 and April 2019, **spdep** contained functions for constructing and handling neighbour and spatial weights objects, tests for spatial autocorrelation, and model fitting functions. The latter have been split out into **spatialreg**, and will be discussed in subsequent chapters. **spdep** [@R-spdep] now accommodates objects represented using **sf** classes and **sp** classes directly.</span>
<span id="cb66-89"><a href="#cb66-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-90"><a href="#cb66-90" aria-hidden="true" tabindex="-1"></a>\index{spatialreg}</span>
<span id="cb66-91"><a href="#cb66-91" aria-hidden="true" tabindex="-1"></a>\index{spdep}</span>
<span id="cb66-92"><a href="#cb66-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-93"><a href="#cb66-93" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb66-94"><a href="#cb66-94" aria-hidden="true" tabindex="-1"></a><span class="in">library(spdep) |&gt; suppressPackageStartupMessages()</span></span>
<span id="cb66-95"><a href="#cb66-95" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-96"><a href="#cb66-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-97"><a href="#cb66-97" aria-hidden="true" tabindex="-1"></a><span class="fu">## Contiguous neighbours</span></span>
<span id="cb66-98"><a href="#cb66-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-99"><a href="#cb66-99" aria-hidden="true" tabindex="-1"></a>\index{neighbours!contiguous}</span>
<span id="cb66-100"><a href="#cb66-100" aria-hidden="true" tabindex="-1"></a>\index{contiguous neighbours}</span>
<span id="cb66-101"><a href="#cb66-101" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{poly2nb}</span>
<span id="cb66-102"><a href="#cb66-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-103"><a href="#cb66-103" aria-hidden="true" tabindex="-1"></a>The <span class="in">`poly2nb`</span> function in **spdep** takes the boundary points making up the polygon boundaries in the object passed as the <span class="in">`pl`</span> argument, typically an <span class="in">`"sf"`</span> or <span class="in">`"sfc"`</span> object with <span class="in">`"POLYGON"`</span> or <span class="in">`"MULTIPOLYGON"`</span> geometries. For each observation, the function checks whether at least one (<span class="in">`queen=TRUE`</span>, default), or at least two (rook, <span class="in">`queen=FALSE`</span>) points are within <span class="in">`snap`</span> distance units of each other. The distances are planar in the raw coordinate units, ignoring geographical projections. Once the required number of sufficiently close points is found, the search is stopped.</span>
<span id="cb66-104"><a href="#cb66-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-105"><a href="#cb66-105" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, eval=FALSE}</span></span>
<span id="cb66-106"><a href="#cb66-106" aria-hidden="true" tabindex="-1"></a><span class="in">args(poly2nb)</span></span>
<span id="cb66-107"><a href="#cb66-107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-108"><a href="#cb66-108" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE, eval=TRUE}</span></span>
<span id="cb66-109"><a href="#cb66-109" aria-hidden="true" tabindex="-1"></a><span class="in">xargs(poly2nb)</span></span>
<span id="cb66-110"><a href="#cb66-110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-111"><a href="#cb66-111" aria-hidden="true" tabindex="-1"></a>From **spdep** 1.1-7, the **sf** package GEOS interface is used within `poly2nb` to find the candidate neighbours and populate `foundInBox` internally. In this case, the use of spatial indexing (STRtree queries) in GEOS through **sf** is the default:</span>
<span id="cb66-112"><a href="#cb66-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-115"><a href="#cb66-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-116"><a href="#cb66-116" aria-hidden="true" tabindex="-1"></a>pol_pres15 <span class="sc">|&gt;</span> <span class="fu">poly2nb</span>(<span class="at">queen =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> nb_q</span>
<span id="cb66-117"><a href="#cb66-117" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-118"><a href="#cb66-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-119"><a href="#cb66-119" aria-hidden="true" tabindex="-1"></a>The print method shows the summary structure of the neighbour object:</span>
<span id="cb66-120"><a href="#cb66-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-123"><a href="#cb66-123" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-124"><a href="#cb66-124" aria-hidden="true" tabindex="-1"></a>nb_q</span>
<span id="cb66-125"><a href="#cb66-125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-126"><a href="#cb66-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-127"><a href="#cb66-127" aria-hidden="true" tabindex="-1"></a>From **sf** version 1.0-0, the **s2** package [@R-s2] is used by default for spherical geometries, as `st_intersects` used in `poly2nb` passes calculation to `s2::s2_intersects_matrix` (see @sec-spherical). From **spdep** version 1.1-9, if <span class="in">`sf_use_s2()`</span> is <span class="in">`TRUE`</span>, spherical intersection is used to find candidate neighbours; as with GEOS, the underlying <span class="in">`s2`</span> library uses fast spatial indexing.</span>
<span id="cb66-128"><a href="#cb66-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-131"><a href="#cb66-131" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-132"><a href="#cb66-132" aria-hidden="true" tabindex="-1"></a>old_use_s2 <span class="ot">&lt;-</span> <span class="fu">sf_use_s2</span>()</span>
<span id="cb66-133"><a href="#cb66-133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-134"><a href="#cb66-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-135"><a href="#cb66-135" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{sf<span class="sc">\_</span>use<span class="sc">\_</span>s2}</span>
<span id="cb66-136"><a href="#cb66-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-139"><a href="#cb66-139" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-140"><a href="#cb66-140" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_use_s2</span>(<span class="cn">TRUE</span>)</span>
<span id="cb66-141"><a href="#cb66-141" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-142"><a href="#cb66-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-145"><a href="#cb66-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-146"><a href="#cb66-146" aria-hidden="true" tabindex="-1"></a>(pol_pres15 <span class="sc">|&gt;</span> <span class="fu">st_transform</span>(<span class="st">"OGC:CRS84"</span>) <span class="ot">-&gt;</span> pol_pres15_ll) <span class="sc">|&gt;</span> </span>
<span id="cb66-147"><a href="#cb66-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">poly2nb</span>(<span class="at">queen =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> nb_q_s2</span>
<span id="cb66-148"><a href="#cb66-148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-149"><a href="#cb66-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-150"><a href="#cb66-150" aria-hidden="true" tabindex="-1"></a>\index{queen neighbours}</span>
<span id="cb66-151"><a href="#cb66-151" aria-hidden="true" tabindex="-1"></a>\index{neighbours!queen}</span>
<span id="cb66-152"><a href="#cb66-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-153"><a href="#cb66-153" aria-hidden="true" tabindex="-1"></a>Spherical and planar intersection of the input polygons yield the same contiguity neighbours in this case; in both cases valid input geometries are desirable:</span>
<span id="cb66-154"><a href="#cb66-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-157"><a href="#cb66-157" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-158"><a href="#cb66-158" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(nb_q, nb_q_s2, <span class="at">check.attributes=</span><span class="cn">FALSE</span>)</span>
<span id="cb66-159"><a href="#cb66-159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-160"><a href="#cb66-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-161"><a href="#cb66-161" aria-hidden="true" tabindex="-1"></a>Note that <span class="in">`nb`</span> objects record both symmetric neighbour relationships <span class="in">`i`</span> to <span class="in">`j`</span> and <span class="in">`j`</span> to <span class="in">`i`</span>, because these objects admit asymmetric relationships as well, but these duplications are not needed for object construction.</span>
<span id="cb66-162"><a href="#cb66-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-163"><a href="#cb66-163" aria-hidden="true" tabindex="-1"></a>Most of the **spdep** functions for constructing neighbour objects take a <span class="in">`row.names`</span> argument, the value of which is stored as a <span class="in">`region.id`</span> attribute. If not given, the values are taken from <span class="in">`row.names()`</span> of the first argument. These can be used to check that the neighbours object is in the same order as data. If <span class="in">`nb`</span> objects are subsetted, the indices change to continue to be within <span class="in">`1:length(subsetted_nb)`</span>, but the <span class="in">`region.id`</span> attribute values point back to the object from which it was constructed. This is used in out-of-sample prediction from spatial regression models discussed briefly in @sec-spateconpred.</span>
<span id="cb66-164"><a href="#cb66-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-165"><a href="#cb66-165" aria-hidden="true" tabindex="-1"></a>We can also check that this undirected graph is connected using the <span class="in">`n.comp.nb`</span> function; while some model estimation techniques do not support graphs that are not connected, it is helpful to be aware of possible problems <span class="co">[</span><span class="ot">@FRENISTERRANTINO201825</span><span class="co">]</span>:</span>
<span id="cb66-168"><a href="#cb66-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-169"><a href="#cb66-169" aria-hidden="true" tabindex="-1"></a>(nb_q <span class="sc">|&gt;</span> <span class="fu">n.comp.nb</span>())<span class="sc">$</span>nc</span>
<span id="cb66-170"><a href="#cb66-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-171"><a href="#cb66-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-172"><a href="#cb66-172" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{n.comp.nb}</span>
<span id="cb66-173"><a href="#cb66-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-174"><a href="#cb66-174" aria-hidden="true" tabindex="-1"></a>This approach is equivalent to treating the neighbour object as a graph and using graph analysis on that graph <span class="co">[</span><span class="ot">@csardi+nepusz:06; @R-igraph</span><span class="co">]</span>, by first coercing to a binary sparse matrix <span class="co">[</span><span class="ot">@R-Matrix</span><span class="co">]</span>:</span>
<span id="cb66-175"><a href="#cb66-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-178"><a href="#cb66-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-179"><a href="#cb66-179" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb66-180"><a href="#cb66-180" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spatialreg, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb66-181"><a href="#cb66-181" aria-hidden="true" tabindex="-1"></a>nb_q <span class="sc">|&gt;</span> </span>
<span id="cb66-182"><a href="#cb66-182" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nb2listw</span>(<span class="at">style =</span> <span class="st">"B"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-183"><a href="#cb66-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as</span>(<span class="st">"CsparseMatrix"</span>) <span class="ot">-&gt;</span> smat</span>
<span id="cb66-184"><a href="#cb66-184" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb66-185"><a href="#cb66-185" aria-hidden="true" tabindex="-1"></a>(smat <span class="sc">|&gt;</span> <span class="fu">graph_from_adjacency_matrix</span>() <span class="ot">-&gt;</span> g1) <span class="sc">|&gt;</span> </span>
<span id="cb66-186"><a href="#cb66-186" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count_components</span>()</span>
<span id="cb66-187"><a href="#cb66-187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-188"><a href="#cb66-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-189"><a href="#cb66-189" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{nb2listw}</span>
<span id="cb66-190"><a href="#cb66-190" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{graph<span class="sc">\_</span>from<span class="sc">\_</span>adjacency<span class="sc">\_</span>matrix}</span>
<span id="cb66-191"><a href="#cb66-191" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{count<span class="sc">\_</span>components}</span>
<span id="cb66-192"><a href="#cb66-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-193"><a href="#cb66-193" aria-hidden="true" tabindex="-1"></a>Neighbour objects may be exported and imported in GAL format for exchange with other software, using <span class="in">`write.nb.gal`</span> and <span class="in">`read.gal`</span>:</span>
<span id="cb66-194"><a href="#cb66-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-197"><a href="#cb66-197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-198"><a href="#cb66-198" aria-hidden="true" tabindex="-1"></a>tf <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".gal"</span>)</span>
<span id="cb66-199"><a href="#cb66-199" aria-hidden="true" tabindex="-1"></a><span class="fu">write.nb.gal</span>(nb_q, tf)</span>
<span id="cb66-200"><a href="#cb66-200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-201"><a href="#cb66-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-202"><a href="#cb66-202" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{write.nb.gal}</span>
<span id="cb66-203"><a href="#cb66-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-204"><a href="#cb66-204" aria-hidden="true" tabindex="-1"></a><span class="fu">## Graph-based neighbours</span></span>
<span id="cb66-205"><a href="#cb66-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-206"><a href="#cb66-206" aria-hidden="true" tabindex="-1"></a>If areal units are an appropriate representation, but only points on the plane have been observed, contiguity relationships may be approximated using graph-based neighbours. In this case, the imputed boundaries tessellate the plane such that points closer to one observation than any other fall within its polygon. The simplest form is by using triangulation, here using the <span class="in">`deldir`</span> function in the **deldir** package. Because the function returns from $i$ and to $j$ identifiers, it is easy to construct a long representation of a <span class="in">`listw`</span> object, as used in the S-Plus SpatialStats module and the <span class="in">`sn2listw`</span> function internally to construct an <span class="in">`nb`</span> object (ragged wide representation). Alternatives such as GEOS often fail to return sufficient information to permit the neighbours to be identified.</span>
<span id="cb66-207"><a href="#cb66-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-208"><a href="#cb66-208" aria-hidden="true" tabindex="-1"></a>The output of these functions is then converted to the <span class="in">`nb`</span> representation using <span class="in">`graph2nb`</span>, with the possible use of the <span class="in">`sym`</span> argument to coerce to symmetry. We take the centroids of the largest component polygon for each observation as the point representation; population-weighted centroids might have been a better choice if they were available:</span>
<span id="cb66-209"><a href="#cb66-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-212"><a href="#cb66-212" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-213"><a href="#cb66-213" aria-hidden="true" tabindex="-1"></a>pol_pres15 <span class="sc">|&gt;</span> </span>
<span id="cb66-214"><a href="#cb66-214" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-215"><a href="#cb66-215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_centroid</span>(<span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> coords </span>
<span id="cb66-216"><a href="#cb66-216" aria-hidden="true" tabindex="-1"></a>(coords <span class="sc">|&gt;</span> <span class="fu">tri2nb</span>() <span class="ot">-&gt;</span> nb_tri)</span>
<span id="cb66-217"><a href="#cb66-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-218"><a href="#cb66-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-219"><a href="#cb66-219" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{tri2nb}</span>
<span id="cb66-220"><a href="#cb66-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-221"><a href="#cb66-221" aria-hidden="true" tabindex="-1"></a>The average number of neighbours is similar to the Queen boundary contiguity case, but if we look at the distribution of edge lengths using <span class="in">`nbdists()`</span>, we can see that although the upper quartile is about 15 km, the maximum is almost 300 km, an edge along much of one side of the convex hull. The short minimum distance is also of interest, as many centroids of urban municipalities are very close to the centroids of their surrounding rural counterparts.</span>
<span id="cb66-222"><a href="#cb66-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-223"><a href="#cb66-223" aria-hidden="true" tabindex="-1"></a>\index{neighbours!edge lengths}</span>
<span id="cb66-224"><a href="#cb66-224" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{nbdists}</span>
<span id="cb66-225"><a href="#cb66-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-228"><a href="#cb66-228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-229"><a href="#cb66-229" aria-hidden="true" tabindex="-1"></a>nb_tri <span class="sc">|&gt;</span> </span>
<span id="cb66-230"><a href="#cb66-230" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nbdists</span>(coords) <span class="sc">|&gt;</span> </span>
<span id="cb66-231"><a href="#cb66-231" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-232"><a href="#cb66-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>()</span>
<span id="cb66-233"><a href="#cb66-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-234"><a href="#cb66-234" aria-hidden="true" tabindex="-1"></a>Triangulated neighbours also yield a connected graph:</span>
<span id="cb66-237"><a href="#cb66-237" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-238"><a href="#cb66-238" aria-hidden="true" tabindex="-1"></a>(nb_tri <span class="sc">|&gt;</span> <span class="fu">n.comp.nb</span>())<span class="sc">$</span>nc</span>
<span id="cb66-239"><a href="#cb66-239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-240"><a href="#cb66-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-241"><a href="#cb66-241" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{n.comp.nb}</span>
<span id="cb66-242"><a href="#cb66-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-243"><a href="#cb66-243" aria-hidden="true" tabindex="-1"></a>Graph-based approaches include <span class="in">`soi.graph`</span> - discussed here, <span class="in">`relativeneigh`</span> and <span class="in">`gabrielneigh`</span>.</span>
<span id="cb66-244"><a href="#cb66-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-245"><a href="#cb66-245" aria-hidden="true" tabindex="-1"></a>The Sphere of Influence <span class="in">`soi.graph`</span> function takes triangulated neighbours and prunes off neighbour relationships represented by edges that are unusually long for each point, especially around the convex hull <span class="co">[</span><span class="ot">@avis+horton:1985</span><span class="co">]</span>.</span>
<span id="cb66-248"><a href="#cb66-248" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-249"><a href="#cb66-249" aria-hidden="true" tabindex="-1"></a>(nb_tri <span class="sc">|&gt;</span> </span>
<span id="cb66-250"><a href="#cb66-250" aria-hidden="true" tabindex="-1"></a>        <span class="fu">soi.graph</span>(coords) <span class="sc">|&gt;</span> </span>
<span id="cb66-251"><a href="#cb66-251" aria-hidden="true" tabindex="-1"></a>        <span class="fu">graph2nb</span>() <span class="ot">-&gt;</span> nb_soi)</span>
<span id="cb66-252"><a href="#cb66-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-253"><a href="#cb66-253" aria-hidden="true" tabindex="-1"></a>Unpicking the triangulated neighbours does however remove the connected character of the underlying graph:</span>
<span id="cb66-254"><a href="#cb66-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-255"><a href="#cb66-255" aria-hidden="true" tabindex="-1"></a>\index{neighbours!sphere of influence}</span>
<span id="cb66-256"><a href="#cb66-256" aria-hidden="true" tabindex="-1"></a>\index{sphere of influence}</span>
<span id="cb66-257"><a href="#cb66-257" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{soi.graph}</span>
<span id="cb66-258"><a href="#cb66-258" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{relativeneigh}</span>
<span id="cb66-259"><a href="#cb66-259" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{gabrielneigh}</span>
<span id="cb66-260"><a href="#cb66-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-263"><a href="#cb66-263" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-264"><a href="#cb66-264" aria-hidden="true" tabindex="-1"></a>(nb_soi <span class="sc">|&gt;</span> <span class="fu">n.comp.nb</span>() <span class="ot">-&gt;</span> n_comp)<span class="sc">$</span>nc</span>
<span id="cb66-265"><a href="#cb66-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-266"><a href="#cb66-266" aria-hidden="true" tabindex="-1"></a>The algorithm has stripped out longer edges leading to urban and rural municipality pairs where their centroids are very close to each other because the rural ones completely surround the urban, giving 15 pairs of neighbours unconnected to the main graph:</span>
<span id="cb66-267"><a href="#cb66-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-270"><a href="#cb66-270" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-271"><a href="#cb66-271" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(n_comp<span class="sc">$</span>comp.id)</span>
<span id="cb66-272"><a href="#cb66-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-273"><a href="#cb66-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-274"><a href="#cb66-274" aria-hidden="true" tabindex="-1"></a>The largest length edges along the convex hull have been removed, but "holes" have appeared where the unconnected pairs of neighbours have appeared. The differences between <span class="in">`nb_tri`</span> and <span class="in">`nb_soi`</span> are shown in orange in @fig-plotnbdiff.</span>
<span id="cb66-275"><a href="#cb66-275" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!---</span></span>
<span id="cb66-276"><a href="#cb66-276" aria-hidden="true" tabindex="-1"></a><span class="co">unsure whether the new cross-reference in the caption will be rendered correctly</span></span>
<span id="cb66-277"><a href="#cb66-277" aria-hidden="true" tabindex="-1"></a><span class="co">---&gt;</span></span>
<span id="cb66-278"><a href="#cb66-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-plotnbdiff, echo=!knitr::is_latex_output()}</span></span>
<span id="cb66-279"><a href="#cb66-279" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Triangulated (orange + black) and sphere of influence neighbours (black); apparent holes appear for sphere of influence neighbours where an urban municipality is surrounded by a dominant rural municipality (see @fig-plotpolpres15)"</span></span>
<span id="cb66-280"><a href="#cb66-280" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb66-281"><a href="#cb66-281" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 100%</span></span>
<span id="cb66-282"><a href="#cb66-282" aria-hidden="true" tabindex="-1"></a><span class="in">opar &lt;- par(mar = c(0,0,0,0)+0.5)</span></span>
<span id="cb66-283"><a href="#cb66-283" aria-hidden="true" tabindex="-1"></a><span class="in">pol_pres15 |&gt; </span></span>
<span id="cb66-284"><a href="#cb66-284" aria-hidden="true" tabindex="-1"></a><span class="in">    st_geometry() |&gt; </span></span>
<span id="cb66-285"><a href="#cb66-285" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(border = "grey", lwd = 0.5)</span></span>
<span id="cb66-286"><a href="#cb66-286" aria-hidden="true" tabindex="-1"></a><span class="in">nb_soi |&gt; plot(coords = coords, add = TRUE, </span></span>
<span id="cb66-287"><a href="#cb66-287" aria-hidden="true" tabindex="-1"></a><span class="in">               points = FALSE, lwd = 0.5)</span></span>
<span id="cb66-288"><a href="#cb66-288" aria-hidden="true" tabindex="-1"></a><span class="in">nb_tri |&gt; </span></span>
<span id="cb66-289"><a href="#cb66-289" aria-hidden="true" tabindex="-1"></a><span class="in">    diffnb(nb_soi) |&gt; </span></span>
<span id="cb66-290"><a href="#cb66-290" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(coords = coords, col = "orange", add = TRUE,</span></span>
<span id="cb66-291"><a href="#cb66-291" aria-hidden="true" tabindex="-1"></a><span class="in">         points = FALSE, lwd = 0.5)</span></span>
<span id="cb66-292"><a href="#cb66-292" aria-hidden="true" tabindex="-1"></a><span class="in">par(opar)</span></span>
<span id="cb66-293"><a href="#cb66-293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-294"><a href="#cb66-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-295"><a href="#cb66-295" aria-hidden="true" tabindex="-1"></a><span class="fu">## Distance-based neighbours</span></span>
<span id="cb66-296"><a href="#cb66-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-297"><a href="#cb66-297" aria-hidden="true" tabindex="-1"></a>\index{neighbours!distance-based}</span>
<span id="cb66-298"><a href="#cb66-298" aria-hidden="true" tabindex="-1"></a>\index{distance-based neighbours}</span>
<span id="cb66-299"><a href="#cb66-299" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{dnearneigh}</span>
<span id="cb66-300"><a href="#cb66-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-301"><a href="#cb66-301" aria-hidden="true" tabindex="-1"></a>Distance-based neighbours can be constructed using <span class="in">`dnearneigh`</span>, with a distance band with lower <span class="in">`d1`</span> and upper <span class="in">`d2`</span> bounds controlled by the <span class="in">`bounds`</span> argument. If spherical coordinates are used and either specified in the coordinates object <span class="in">`x`</span> or with <span class="in">`x`</span> as a two-column matrix and <span class="in">`longlat=TRUE`</span>, great circle distances in kilometre will be calculated assuming the WGS84 reference ellipsoid, or if <span class="in">`use_s2=TRUE`</span> (the default value) using the spheroid (see @sec-spherical). If <span class="in">`dwithin`</span> is <span class="in">`FALSE`</span> and the version of **s2** is greater than <span class="in">`1.0.7`</span>, <span class="in">`s2_closest_edges`</span> may be used, if <span class="in">`TRUE`</span> and <span class="in">`use_s2=TRUE`</span>, <span class="in">`s2_dwithin_matrix`</span> is used; both of these methods use fast spherical spatial indexing, but because <span class="in">`s2_closest_edges`</span> takes minimum and maximum bounds, it only needs one pass in the R code of <span class="in">`dnearneigh`</span>. </span>
<span id="cb66-302"><a href="#cb66-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-303"><a href="#cb66-303" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{s2<span class="sc">\_</span>closest<span class="sc">\_</span>edges}</span>
<span id="cb66-304"><a href="#cb66-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-305"><a href="#cb66-305" aria-hidden="true" tabindex="-1"></a>Arguments have been added to use functionality in the **dbscan** package <span class="co">[</span><span class="ot">@R-dbscan</span><span class="co">]</span> for finding neighbours using planar spatial indexing in two or three dimensions by default, and not to test the symmetry of the output neighbour object. In addition, three arguments relate to the use of spherical geometry distance measurements.</span>
<span id="cb66-306"><a href="#cb66-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-307"><a href="#cb66-307" aria-hidden="true" tabindex="-1"></a>\index{neighbours!k nearest}</span>
<span id="cb66-308"><a href="#cb66-308" aria-hidden="true" tabindex="-1"></a>\index{nearest neighbours}</span>
<span id="cb66-309"><a href="#cb66-309" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{knearneigh}</span>
<span id="cb66-310"><a href="#cb66-310" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{knn2nb}</span>
<span id="cb66-311"><a href="#cb66-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-312"><a href="#cb66-312" aria-hidden="true" tabindex="-1"></a>The <span class="in">`knearneigh`</span> function for $k$-nearest neighbours returns a <span class="in">`knn`</span> object, converted to an <span class="in">`nb`</span> object using <span class="in">`knn2nb`</span>. It can also use great circle distances, not least because nearest neighbours may differ when unprojected coordinates are treated as planar. <span class="in">`k`</span> should be a small number. For projected coordinates, the **dbscan** package is used to compute nearest neighbours more efficiently. Note that <span class="in">`nb`</span> objects constructed in this way are most unlikely to be symmetric hence <span class="in">`knn2nb`</span> has a <span class="in">`sym`</span> argument to permit the imposition of symmetry, which will mean that all units have at least <span class="in">`k`</span> neighbours, not that all units will have exactly <span class="in">`k`</span> neighbours. When <span class="in">`sf_use_s2()`</span> is <span class="in">`TRUE`</span>, <span class="in">`knearneigh`</span> will use fast spherical spatial indexing when the input object is of class <span class="in">`"sf"`</span> or <span class="in">`"sfc"`</span>.</span>
<span id="cb66-313"><a href="#cb66-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-314"><a href="#cb66-314" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{nbdists}</span>
<span id="cb66-315"><a href="#cb66-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-316"><a href="#cb66-316" aria-hidden="true" tabindex="-1"></a>The <span class="in">`nbdists`</span> function returns the length of neighbour relationship edges in the units of the coordinates if the coordinates are projected, in kilometre otherwise. In order to set the upper limit for distance bands, one may first find the maximum first nearest neighbour distance, using <span class="in">`unlist`</span> to remove the list structure of the returned object. When <span class="in">`sf_use_s2()`</span> is <span class="in">`TRUE`</span>, <span class="in">`nbdists`</span> will use fast spherical distance calculations when the input object is of class <span class="in">`"sf"`</span> or <span class="in">`"sfc"`</span>.</span>
<span id="cb66-317"><a href="#cb66-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-320"><a href="#cb66-320" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-321"><a href="#cb66-321" aria-hidden="true" tabindex="-1"></a>coords <span class="sc">|&gt;</span> </span>
<span id="cb66-322"><a href="#cb66-322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">knearneigh</span>(<span class="at">k =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-323"><a href="#cb66-323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">knn2nb</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-324"><a href="#cb66-324" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nbdists</span>(coords) <span class="sc">|&gt;</span> </span>
<span id="cb66-325"><a href="#cb66-325" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-326"><a href="#cb66-326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>()</span>
<span id="cb66-327"><a href="#cb66-327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-328"><a href="#cb66-328" aria-hidden="true" tabindex="-1"></a>Here the largest first nearest neighbour distance is just under 18 km, so using this as the upper threshold gives certainty that all units will have at least one neighbour:</span>
<span id="cb66-329"><a href="#cb66-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-332"><a href="#cb66-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-333"><a href="#cb66-333" aria-hidden="true" tabindex="-1"></a>coords <span class="sc">|&gt;</span> <span class="fu">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18000</span>) <span class="ot">-&gt;</span> nb_d18</span>
<span id="cb66-334"><a href="#cb66-334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-335"><a href="#cb66-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-336"><a href="#cb66-336" aria-hidden="true" tabindex="-1"></a>For this moderate number of observations, use of spatial indexing does not yield advantages in run times:</span>
<span id="cb66-337"><a href="#cb66-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-340"><a href="#cb66-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-341"><a href="#cb66-341" aria-hidden="true" tabindex="-1"></a>coords <span class="sc">|&gt;</span> <span class="fu">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18000</span>, <span class="at">use_kd_tree =</span> <span class="cn">FALSE</span>) <span class="ot">-&gt;</span> nb_d18a</span>
<span id="cb66-342"><a href="#cb66-342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-343"><a href="#cb66-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-344"><a href="#cb66-344" aria-hidden="true" tabindex="-1"></a>and the output objects are the same:</span>
<span id="cb66-345"><a href="#cb66-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-348"><a href="#cb66-348" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-349"><a href="#cb66-349" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(nb_d18, nb_d18a, <span class="at">check.attributes =</span> <span class="cn">FALSE</span>)</span>
<span id="cb66-350"><a href="#cb66-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-353"><a href="#cb66-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-354"><a href="#cb66-354" aria-hidden="true" tabindex="-1"></a>nb_d18</span>
<span id="cb66-355"><a href="#cb66-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-356"><a href="#cb66-356" aria-hidden="true" tabindex="-1"></a>However, even though there are no no-neighbour observations (their presence is reported by the print method for <span class="in">`nb`</span> objects), the graph is not connected, as a pair of observations are each others' only neighbours.</span>
<span id="cb66-359"><a href="#cb66-359" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-360"><a href="#cb66-360" aria-hidden="true" tabindex="-1"></a>(nb_d18 <span class="sc">|&gt;</span> <span class="fu">n.comp.nb</span>() <span class="ot">-&gt;</span> n_comp)<span class="sc">$</span>nc</span>
<span id="cb66-361"><a href="#cb66-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-364"><a href="#cb66-364" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-365"><a href="#cb66-365" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(n_comp<span class="sc">$</span>comp.id)</span>
<span id="cb66-366"><a href="#cb66-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-367"><a href="#cb66-367" aria-hidden="true" tabindex="-1"></a>Adding 300 m to the threshold gives us a neighbour object with no no-neighbour units, and all units can be reached from all others across the graph.</span>
<span id="cb66-370"><a href="#cb66-370" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-371"><a href="#cb66-371" aria-hidden="true" tabindex="-1"></a>(coords <span class="sc">|&gt;</span> <span class="fu">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18300</span>) <span class="ot">-&gt;</span> nb_d183)</span>
<span id="cb66-372"><a href="#cb66-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-375"><a href="#cb66-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-376"><a href="#cb66-376" aria-hidden="true" tabindex="-1"></a>(nb_d183 <span class="sc">|&gt;</span> <span class="fu">n.comp.nb</span>())<span class="sc">$</span>nc</span>
<span id="cb66-377"><a href="#cb66-377" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-378"><a href="#cb66-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-379"><a href="#cb66-379" aria-hidden="true" tabindex="-1"></a>One characteristic of distance-based neighbours is that more densely settled areas, with units which are smaller in terms of area, have higher neighbour counts (Warsaw boroughs are much smaller on average, but have almost 30 neighbours for this distance criterion). Having many neighbours smooths the neighbour relationship across more neighbours. </span>
<span id="cb66-380"><a href="#cb66-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-381"><a href="#cb66-381" aria-hidden="true" tabindex="-1"></a>For use later, we also construct a neighbour object with no-neighbour units, using a threshold of 16 km:</span>
<span id="cb66-384"><a href="#cb66-384" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-385"><a href="#cb66-385" aria-hidden="true" tabindex="-1"></a>(coords <span class="sc">|&gt;</span> <span class="fu">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">16000</span>) <span class="ot">-&gt;</span> nb_d16)</span>
<span id="cb66-386"><a href="#cb66-386" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-387"><a href="#cb66-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-388"><a href="#cb66-388" aria-hidden="true" tabindex="-1"></a>It is possible to control the numbers of neighbours directly using $k$-nearest neighbours, either accepting asymmetric neighbours:</span>
<span id="cb66-391"><a href="#cb66-391" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-392"><a href="#cb66-392" aria-hidden="true" tabindex="-1"></a>((coords <span class="sc">|&gt;</span> <span class="fu">knearneigh</span>(<span class="at">k =</span> <span class="dv">6</span>) <span class="ot">-&gt;</span> knn_k6) <span class="sc">|&gt;</span> <span class="fu">knn2nb</span>() <span class="ot">-&gt;</span> nb_k6)</span>
<span id="cb66-393"><a href="#cb66-393" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-394"><a href="#cb66-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-395"><a href="#cb66-395" aria-hidden="true" tabindex="-1"></a>or imposing symmetry:</span>
<span id="cb66-398"><a href="#cb66-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-399"><a href="#cb66-399" aria-hidden="true" tabindex="-1"></a>(knn_k6 <span class="sc">|&gt;</span> <span class="fu">knn2nb</span>(<span class="at">sym =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> nb_k6s)</span>
<span id="cb66-400"><a href="#cb66-400" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-401"><a href="#cb66-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-402"><a href="#cb66-402" aria-hidden="true" tabindex="-1"></a>Here the size of <span class="in">`k`</span> is sufficient to ensure connectedness, although the graph is not planar as edges cross at locations other than nodes, which is not the case for contiguous or graph-based neighbours.</span>
<span id="cb66-405"><a href="#cb66-405" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-406"><a href="#cb66-406" aria-hidden="true" tabindex="-1"></a>(nb_k6s <span class="sc">|&gt;</span> <span class="fu">n.comp.nb</span>())<span class="sc">$</span>nc</span>
<span id="cb66-407"><a href="#cb66-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-408"><a href="#cb66-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-409"><a href="#cb66-409" aria-hidden="true" tabindex="-1"></a>In the case of points on the sphere (see @sec-spherical), the output of <span class="in">`st_centroid`</span> will differ, so rather than inverse projecting the points, we extract points as geographical coordinates from the inverse projected polygon geometries:</span>
<span id="cb66-410"><a href="#cb66-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-413"><a href="#cb66-413" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-414"><a href="#cb66-414" aria-hidden="true" tabindex="-1"></a>old_use_s2 <span class="ot">&lt;-</span> <span class="fu">sf_use_s2</span>()</span>
<span id="cb66-415"><a href="#cb66-415" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-416"><a href="#cb66-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-419"><a href="#cb66-419" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-420"><a href="#cb66-420" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_use_s2</span>(<span class="cn">TRUE</span>)</span>
<span id="cb66-421"><a href="#cb66-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-422"><a href="#cb66-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-425"><a href="#cb66-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-426"><a href="#cb66-426" aria-hidden="true" tabindex="-1"></a>pol_pres15_ll <span class="sc">|&gt;</span> </span>
<span id="cb66-427"><a href="#cb66-427" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-428"><a href="#cb66-428" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_centroid</span>(<span class="at">of_largest_polygon =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> coords_ll</span>
<span id="cb66-429"><a href="#cb66-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-430"><a href="#cb66-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-431"><a href="#cb66-431" aria-hidden="true" tabindex="-1"></a>For spherical coordinates, distance bounds are in kilometres:</span>
<span id="cb66-432"><a href="#cb66-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-435"><a href="#cb66-435" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-436"><a href="#cb66-436" aria-hidden="true" tabindex="-1"></a>(coords_ll <span class="sc">|&gt;</span> <span class="fu">dnearneigh</span>(<span class="dv">0</span>, <span class="fl">18.3</span>, <span class="at">use_s2 =</span> <span class="cn">TRUE</span>, </span>
<span id="cb66-437"><a href="#cb66-437" aria-hidden="true" tabindex="-1"></a>                         <span class="at">dwithin =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> nb_d183_ll)</span>
<span id="cb66-438"><a href="#cb66-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-439"><a href="#cb66-439" aria-hidden="true" tabindex="-1"></a>These neighbours differ from the spherical 18.3 km neighbours as would be expected:</span>
<span id="cb66-440"><a href="#cb66-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-443"><a href="#cb66-443" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-444"><a href="#cb66-444" aria-hidden="true" tabindex="-1"></a><span class="fu">isTRUE</span>(<span class="fu">all.equal</span>(nb_d183, nb_d183_ll, <span class="at">check.attributes =</span> <span class="cn">FALSE</span>))</span>
<span id="cb66-445"><a href="#cb66-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-446"><a href="#cb66-446" aria-hidden="true" tabindex="-1"></a>If **s2** providing faster distance neighbour indexing is available, by default <span class="in">`s2_closest_edges`</span> will be used for geographical coordinates:</span>
<span id="cb66-447"><a href="#cb66-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-450"><a href="#cb66-450" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-451"><a href="#cb66-451" aria-hidden="true" tabindex="-1"></a>(coords_ll <span class="sc">|&gt;</span> <span class="fu">dnearneigh</span>(<span class="dv">0</span>, <span class="fl">18.3</span>) <span class="ot">-&gt;</span> nb_d183_llce)</span>
<span id="cb66-452"><a href="#cb66-452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-453"><a href="#cb66-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-454"><a href="#cb66-454" aria-hidden="true" tabindex="-1"></a>where the two **s2**-based neighbour objects are the same:</span>
<span id="cb66-455"><a href="#cb66-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-458"><a href="#cb66-458" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-459"><a href="#cb66-459" aria-hidden="true" tabindex="-1"></a><span class="fu">isTRUE</span>(<span class="fu">all.equal</span>(nb_d183_llce, nb_d183_ll,</span>
<span id="cb66-460"><a href="#cb66-460" aria-hidden="true" tabindex="-1"></a>                 <span class="at">check.attributes =</span> <span class="cn">FALSE</span>))</span>
<span id="cb66-461"><a href="#cb66-461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-462"><a href="#cb66-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-463"><a href="#cb66-463" aria-hidden="true" tabindex="-1"></a>Fast spherical spatial indexing in **s2** is used to find $k$ nearest neighbours:</span>
<span id="cb66-464"><a href="#cb66-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-467"><a href="#cb66-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-468"><a href="#cb66-468" aria-hidden="true" tabindex="-1"></a>(coords_ll <span class="sc">|&gt;</span> <span class="fu">knearneigh</span>(<span class="at">k =</span> <span class="dv">6</span>) <span class="sc">|&gt;</span> <span class="fu">knn2nb</span>() <span class="ot">-&gt;</span> nb_k6_ll)</span>
<span id="cb66-469"><a href="#cb66-469" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-470"><a href="#cb66-470" aria-hidden="true" tabindex="-1"></a>These neighbours differ from the planar <span class="in">`k=6`</span> nearest neighbours as would be expected, but will also differ slightly from legacy brute-force ellipsoid distances:</span>
<span id="cb66-471"><a href="#cb66-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-474"><a href="#cb66-474" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-475"><a href="#cb66-475" aria-hidden="true" tabindex="-1"></a><span class="fu">isTRUE</span>(<span class="fu">all.equal</span>(nb_k6, nb_k6_ll, <span class="at">check.attributes =</span> <span class="cn">FALSE</span>))</span>
<span id="cb66-476"><a href="#cb66-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-477"><a href="#cb66-477" aria-hidden="true" tabindex="-1"></a>The <span class="in">`nbdists`</span> function also uses **s2** to find distances on the sphere when the <span class="in">`"sf"`</span> or <span class="in">`"sfc"`</span>input object is in geographical coordinates (distances returned in kilometres):</span>
<span id="cb66-478"><a href="#cb66-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-481"><a href="#cb66-481" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-482"><a href="#cb66-482" aria-hidden="true" tabindex="-1"></a>nb_q <span class="sc">|&gt;</span> <span class="fu">nbdists</span>(coords_ll) <span class="sc">|&gt;</span> <span class="fu">unlist</span>() <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb66-483"><a href="#cb66-483" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-484"><a href="#cb66-484" aria-hidden="true" tabindex="-1"></a>These differ a little for the same weights object when planar coordinates are used (distances returned in the metric of the points for planar geometries and kilometres for ellipsoidal and spherical geometries):</span>
<span id="cb66-485"><a href="#cb66-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-488"><a href="#cb66-488" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-489"><a href="#cb66-489" aria-hidden="true" tabindex="-1"></a>nb_q <span class="sc">|&gt;</span> <span class="fu">nbdists</span>(coords) <span class="sc">|&gt;</span> <span class="fu">unlist</span>() <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb66-490"><a href="#cb66-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-491"><a href="#cb66-491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, results='hide'}</span></span>
<span id="cb66-492"><a href="#cb66-492" aria-hidden="true" tabindex="-1"></a><span class="in">sf_use_s2(old_use_s2)</span></span>
<span id="cb66-493"><a href="#cb66-493" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-494"><a href="#cb66-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-495"><a href="#cb66-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-496"><a href="#cb66-496" aria-hidden="true" tabindex="-1"></a><span class="fu">## Weights specification</span></span>
<span id="cb66-497"><a href="#cb66-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-498"><a href="#cb66-498" aria-hidden="true" tabindex="-1"></a>Once neighbour objects are available, further choices need to be made in specifying the weights objects. The <span class="in">`nb2listw`</span> function is used to create a <span class="in">`listw`</span> weights object with an <span class="in">`nb`</span> object, a matching list of weights vectors, and a style specification. Because handling no-neighbour observations now begins to matter, the <span class="in">`zero.policy`</span> argument is introduced. By default, this is <span class="in">`FALSE`</span>, indicating that no-neighbour observations will cause an error, as the spatially lagged value for an observation with no neighbours is not available. By convention, zero is substituted for the lagged value, as the cross-product of a vector of zero-valued weights and a data vector, hence the name of <span class="in">`zero.policy`</span>.</span>
<span id="cb66-499"><a href="#cb66-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-500"><a href="#cb66-500" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{nb2listw}</span>
<span id="cb66-501"><a href="#cb66-501" aria-hidden="true" tabindex="-1"></a>\index{weights!objects}</span>
<span id="cb66-502"><a href="#cb66-502" aria-hidden="true" tabindex="-1"></a>\index{weights!listw}</span>
<span id="cb66-503"><a href="#cb66-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-504"><a href="#cb66-504" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, eval=FALSE}</span></span>
<span id="cb66-505"><a href="#cb66-505" aria-hidden="true" tabindex="-1"></a><span class="in">args(nb2listw)</span></span>
<span id="cb66-506"><a href="#cb66-506" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-507"><a href="#cb66-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE, eval=TRUE}</span></span>
<span id="cb66-508"><a href="#cb66-508" aria-hidden="true" tabindex="-1"></a><span class="in">xargs(nb2listw)</span></span>
<span id="cb66-509"><a href="#cb66-509" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-510"><a href="#cb66-510" aria-hidden="true" tabindex="-1"></a>We will be using the helper function <span class="in">`spweights.constants`</span> below to show some consequences of varying style choices. It returns constants for a <span class="in">`listw`</span> object, $n$ is the number of observations, <span class="in">`n1`</span> to <span class="in">`n3`</span> are $n-1, \ldots$, <span class="in">`nn`</span> is $n^2$ and $S_0$, $S_1$ and $S_2$ are constants, $S_0$ being the sum of the weights. There is a full discussion of the constants in @Bivand2018.</span>
<span id="cb66-511"><a href="#cb66-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-512"><a href="#cb66-512" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{spweights.constants}</span>
<span id="cb66-513"><a href="#cb66-513" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, eval=FALSE}</span></span>
<span id="cb66-514"><a href="#cb66-514" aria-hidden="true" tabindex="-1"></a><span class="in">args(spweights.constants)</span></span>
<span id="cb66-515"><a href="#cb66-515" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-516"><a href="#cb66-516" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE, eval=TRUE}</span></span>
<span id="cb66-517"><a href="#cb66-517" aria-hidden="true" tabindex="-1"></a><span class="in">xargs(spweights.constants)</span></span>
<span id="cb66-518"><a href="#cb66-518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-519"><a href="#cb66-519" aria-hidden="true" tabindex="-1"></a>The <span class="in">`"B"`</span> binary style gives a weight of unity to each neighbour relationship, and typically up-weights units with no boundaries on the edge of the study area, having a higher count of neighbours.</span>
<span id="cb66-520"><a href="#cb66-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-523"><a href="#cb66-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-524"><a href="#cb66-524" aria-hidden="true" tabindex="-1"></a>(nb_q <span class="sc">|&gt;</span> </span>
<span id="cb66-525"><a href="#cb66-525" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nb2listw</span>(<span class="at">style =</span> <span class="st">"B"</span>) <span class="ot">-&gt;</span> lw_q_B) <span class="sc">|&gt;</span> </span>
<span id="cb66-526"><a href="#cb66-526" aria-hidden="true" tabindex="-1"></a>    <span class="fu">spweights.constants</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-527"><a href="#cb66-527" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-528"><a href="#cb66-528" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">select =</span> <span class="fu">c</span>(n, S0, S1, S2))</span>
<span id="cb66-529"><a href="#cb66-529" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-530"><a href="#cb66-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-531"><a href="#cb66-531" aria-hidden="true" tabindex="-1"></a>\index{weights!row-standardised}</span>
<span id="cb66-532"><a href="#cb66-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-533"><a href="#cb66-533" aria-hidden="true" tabindex="-1"></a>The <span class="in">`"W"`</span> row-standardised style up-weights units around the edge of the study area that necessarily have fewer neighbours. This style first gives a weight of unity to each neighbour relationship, then it divides these weights by the per unit sums of weights. Naturally this leads to division by zero where there are no neighbours, a not-a-number result, unless the chosen policy is to permit no-neighbour observations. We can see that $S_0$ is now equal to $n$.</span>
<span id="cb66-534"><a href="#cb66-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-537"><a href="#cb66-537" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-538"><a href="#cb66-538" aria-hidden="true" tabindex="-1"></a>(nb_q <span class="sc">|&gt;</span> </span>
<span id="cb66-539"><a href="#cb66-539" aria-hidden="true" tabindex="-1"></a>        <span class="fu">nb2listw</span>(<span class="at">style =</span> <span class="st">"W"</span>) <span class="ot">-&gt;</span> lw_q_W) <span class="sc">|&gt;</span> </span>
<span id="cb66-540"><a href="#cb66-540" aria-hidden="true" tabindex="-1"></a>    <span class="fu">spweights.constants</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-541"><a href="#cb66-541" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-542"><a href="#cb66-542" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">select =</span> <span class="fu">c</span>(n, S0, S1, S2))</span>
<span id="cb66-543"><a href="#cb66-543" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-544"><a href="#cb66-544" aria-hidden="true" tabindex="-1"></a>\index{weights!inverse distance}</span>
<span id="cb66-545"><a href="#cb66-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-546"><a href="#cb66-546" aria-hidden="true" tabindex="-1"></a>Inverse distance weights are used in a number of scientific fields. Some use dense inverse distance matrices, but many of the inverse distances are close to zero, have little practical contribution, especially as the spatial process matrix is itself dense. Inverse distance weights may be constructed by taking the lengths of edges, changing units to avoid most weights being too large or small (here from metre to kilometre), taking the inverse, and passing through the <span class="in">`glist`</span> argument to <span class="in">`nb2listw`</span>:</span>
<span id="cb66-547"><a href="#cb66-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-550"><a href="#cb66-550" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-551"><a href="#cb66-551" aria-hidden="true" tabindex="-1"></a>nb_d183 <span class="sc">|&gt;</span> </span>
<span id="cb66-552"><a href="#cb66-552" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nbdists</span>(coords) <span class="sc">|&gt;</span> </span>
<span id="cb66-553"><a href="#cb66-553" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(<span class="cf">function</span>(x) <span class="dv">1</span><span class="sc">/</span>(x<span class="sc">/</span><span class="dv">1000</span>)) <span class="ot">-&gt;</span> gwts</span>
<span id="cb66-554"><a href="#cb66-554" aria-hidden="true" tabindex="-1"></a>(nb_d183 <span class="sc">|&gt;</span> <span class="fu">nb2listw</span>(<span class="at">glist=</span>gwts, <span class="at">style=</span><span class="st">"B"</span>) <span class="ot">-&gt;</span> lw_d183_idw_B) <span class="sc">|&gt;</span> </span>
<span id="cb66-555"><a href="#cb66-555" aria-hidden="true" tabindex="-1"></a>    <span class="fu">spweights.constants</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-556"><a href="#cb66-556" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-557"><a href="#cb66-557" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">select=</span><span class="fu">c</span>(n, S0, S1, S2))</span>
<span id="cb66-558"><a href="#cb66-558" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-559"><a href="#cb66-559" aria-hidden="true" tabindex="-1"></a>No-neighbour handling is by default to prevent the construction of a weights object, making the analyst take a position on how to proceed.</span>
<span id="cb66-560"><a href="#cb66-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-563"><a href="#cb66-563" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-564"><a href="#cb66-564" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(nb_d16 <span class="sc">|&gt;</span> <span class="fu">nb2listw</span>(<span class="at">style=</span><span class="st">"B"</span>) <span class="ot">-&gt;</span> lw_d16_B)</span>
<span id="cb66-565"><a href="#cb66-565" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-566"><a href="#cb66-566" aria-hidden="true" tabindex="-1"></a>Use can be made of the <span class="in">`zero.policy`</span> argument to many functions used with <span class="in">`nb`</span> and <span class="in">`listw`</span> objects.</span>
<span id="cb66-567"><a href="#cb66-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-570"><a href="#cb66-570" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-571"><a href="#cb66-571" aria-hidden="true" tabindex="-1"></a>nb_d16 <span class="sc">|&gt;</span> </span>
<span id="cb66-572"><a href="#cb66-572" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nb2listw</span>(<span class="at">style=</span><span class="st">"B"</span>, <span class="at">zero.policy=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-573"><a href="#cb66-573" aria-hidden="true" tabindex="-1"></a>    <span class="fu">spweights.constants</span>(<span class="at">zero.policy=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-574"><a href="#cb66-574" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-575"><a href="#cb66-575" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">select=</span><span class="fu">c</span>(n, S0, S1, S2))</span>
<span id="cb66-576"><a href="#cb66-576" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-577"><a href="#cb66-577" aria-hidden="true" tabindex="-1"></a>Note that by default the <span class="in">`adjust.n`</span> argument to <span class="in">`spweights.constants`</span> is set by default to <span class="in">`TRUE`</span>, subtracting the count of no-neighbour observations from the observation count, so $n$ is smaller with possible consequences for inference. The complete count can be retrieved by changing the argument.</span>
<span id="cb66-578"><a href="#cb66-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-579"><a href="#cb66-579" aria-hidden="true" tabindex="-1"></a><span class="fu">## Higher order neighbours</span></span>
<span id="cb66-580"><a href="#cb66-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-581"><a href="#cb66-581" aria-hidden="true" tabindex="-1"></a>\index{neighbours!higher order}</span>
<span id="cb66-582"><a href="#cb66-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-583"><a href="#cb66-583" aria-hidden="true" tabindex="-1"></a>We recall the characteristics of the neighbour object based on Queen contiguities:</span>
<span id="cb66-584"><a href="#cb66-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-587"><a href="#cb66-587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-588"><a href="#cb66-588" aria-hidden="true" tabindex="-1"></a>nb_q</span>
<span id="cb66-589"><a href="#cb66-589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-590"><a href="#cb66-590" aria-hidden="true" tabindex="-1"></a>If we wish to create an object showing $i$ to $k$ neighbours, where $i$ is a neighbour of $j$, and $j$ in turn is a neighbour of $k$, so taking two steps on the neighbour graph, we can use <span class="in">`nblag`</span>, which automatically removes $i$ to $i$ self-neighbours:</span>
<span id="cb66-591"><a href="#cb66-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-594"><a href="#cb66-594" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-595"><a href="#cb66-595" aria-hidden="true" tabindex="-1"></a>(nb_q <span class="sc">|&gt;</span> <span class="fu">nblag</span>(<span class="dv">2</span>) <span class="ot">-&gt;</span> nb_q2)[[<span class="dv">2</span>]]</span>
<span id="cb66-596"><a href="#cb66-596" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-597"><a href="#cb66-597" aria-hidden="true" tabindex="-1"></a>The <span class="in">`nblag_cumul`</span> function cumulates the list of neighbours for the whole list of lags:</span>
<span id="cb66-598"><a href="#cb66-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-599"><a href="#cb66-599" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{nblag}</span>
<span id="cb66-600"><a href="#cb66-600" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{nblag<span class="sc">\_</span>cumul}</span>
<span id="cb66-601"><a href="#cb66-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-604"><a href="#cb66-604" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-605"><a href="#cb66-605" aria-hidden="true" tabindex="-1"></a><span class="fu">nblag_cumul</span>(nb_q2)</span>
<span id="cb66-606"><a href="#cb66-606" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-607"><a href="#cb66-607" aria-hidden="true" tabindex="-1"></a>while the set operation <span class="in">`union.nb`</span> takes two objects, giving here the same outcome:</span>
<span id="cb66-608"><a href="#cb66-608" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{union.nb}</span>
<span id="cb66-609"><a href="#cb66-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-612"><a href="#cb66-612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-613"><a href="#cb66-613" aria-hidden="true" tabindex="-1"></a><span class="fu">union.nb</span>(nb_q2[[<span class="dv">2</span>]], nb_q2[[<span class="dv">1</span>]])</span>
<span id="cb66-614"><a href="#cb66-614" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-615"><a href="#cb66-615" aria-hidden="true" tabindex="-1"></a>Returning to the graph representation of the same neighbour object, we can ask how many steps might be needed to traverse the graph:</span>
<span id="cb66-616"><a href="#cb66-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-617"><a href="#cb66-617" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{diameter}</span>
<span id="cb66-620"><a href="#cb66-620" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-621"><a href="#cb66-621" aria-hidden="true" tabindex="-1"></a><span class="fu">diameter</span>(g1)</span>
<span id="cb66-622"><a href="#cb66-622" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-623"><a href="#cb66-623" aria-hidden="true" tabindex="-1"></a>We step out from each observation across the graph to establish the number of steps needed to reach each other observation by the shortest path (creating an $n \times n$ matrix <span class="in">`sps`</span>), once again finding the same maximum count. </span>
<span id="cb66-626"><a href="#cb66-626" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-627"><a href="#cb66-627" aria-hidden="true" tabindex="-1"></a>g1 <span class="sc">|&gt;</span> <span class="fu">distances</span>() <span class="ot">-&gt;</span> sps</span>
<span id="cb66-628"><a href="#cb66-628" aria-hidden="true" tabindex="-1"></a>(sps <span class="sc">|&gt;</span> <span class="fu">apply</span>(<span class="dv">2</span>, max) <span class="ot">-&gt;</span> spmax) <span class="sc">|&gt;</span> <span class="fu">max</span>()</span>
<span id="cb66-629"><a href="#cb66-629" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-630"><a href="#cb66-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-631"><a href="#cb66-631" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{distances}</span>
<span id="cb66-632"><a href="#cb66-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-633"><a href="#cb66-633" aria-hidden="true" tabindex="-1"></a>The municipality with the maximum count is called Lutowiska, close to the Ukrainian border in the far south east of the country:</span>
<span id="cb66-634"><a href="#cb66-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-637"><a href="#cb66-637" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-638"><a href="#cb66-638" aria-hidden="true" tabindex="-1"></a>mr <span class="ot">&lt;-</span> <span class="fu">which.max</span>(spmax)</span>
<span id="cb66-639"><a href="#cb66-639" aria-hidden="true" tabindex="-1"></a>pol_pres15<span class="sc">$</span>name0[mr]</span>
<span id="cb66-640"><a href="#cb66-640" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-641"><a href="#cb66-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-642"><a href="#cb66-642" aria-hidden="true" tabindex="-1"></a>@fig-shortestpath  shows that contiguity neighbours represent the same kinds of relationships with other observations as distance. Some approaches prefer distance neighbours on the basis that, for example, inverse distance neighbours show clearly how all observations are related to each other. However, the development of tests for spatial autocorrelation and spatial regression models has involved the inverse of a spatial process model, which in turn can be represented as the sum of a power series of the product of a coefficient and a spatial weights matrix, intrinsically acknowledging the relationships of all observations with all other observations. Sparse contiguity neighbour objects accommodate rich dependency structures without the need to make the structures explicit.</span>
<span id="cb66-643"><a href="#cb66-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-644"><a href="#cb66-644" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-shortestpath, message=FALSE, echo=!knitr::is_latex_output()}</span></span>
<span id="cb66-645"><a href="#cb66-645" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 100%</span></span>
<span id="cb66-646"><a href="#cb66-646" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb66-647"><a href="#cb66-647" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Relationship of shortest paths to distance for Lutowiska; left panel: shortest path counts from Lutowiska; right panel: plot of shortest paths from Lutowiska to other observations, and distances from Lutowiska to other observations"</span></span>
<span id="cb66-648"><a href="#cb66-648" aria-hidden="true" tabindex="-1"></a><span class="in">pol_pres15$sps1 &lt;- sps[,mr]</span></span>
<span id="cb66-649"><a href="#cb66-649" aria-hidden="true" tabindex="-1"></a><span class="in">tm1 &lt;- tm_shape(pol_pres15) +</span></span>
<span id="cb66-650"><a href="#cb66-650" aria-hidden="true" tabindex="-1"></a><span class="in">          tm_fill("sps1", title = "Shortest path\ncount")</span></span>
<span id="cb66-651"><a href="#cb66-651" aria-hidden="true" tabindex="-1"></a><span class="in">coords[mr] |&gt; </span></span>
<span id="cb66-652"><a href="#cb66-652" aria-hidden="true" tabindex="-1"></a><span class="in">    st_distance(coords) |&gt; </span></span>
<span id="cb66-653"><a href="#cb66-653" aria-hidden="true" tabindex="-1"></a><span class="in">    c() |&gt; </span></span>
<span id="cb66-654"><a href="#cb66-654" aria-hidden="true" tabindex="-1"></a><span class="in">    (function(x) x/1000)() |&gt; </span></span>
<span id="cb66-655"><a href="#cb66-655" aria-hidden="true" tabindex="-1"></a><span class="in">    units::set_units(NULL) -&gt; pol_pres15$dist_52</span></span>
<span id="cb66-656"><a href="#cb66-656" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb66-657"><a href="#cb66-657" aria-hidden="true" tabindex="-1"></a><span class="in">g1 &lt;- ggplot(pol_pres15, aes(x = sps1, y = dist_52)) +</span></span>
<span id="cb66-658"><a href="#cb66-658" aria-hidden="true" tabindex="-1"></a><span class="in">        geom_point() +</span></span>
<span id="cb66-659"><a href="#cb66-659" aria-hidden="true" tabindex="-1"></a><span class="in">        xlab("Shortest path count") +</span></span>
<span id="cb66-660"><a href="#cb66-660" aria-hidden="true" tabindex="-1"></a><span class="in">        ylab("km distance")</span></span>
<span id="cb66-661"><a href="#cb66-661" aria-hidden="true" tabindex="-1"></a><span class="in">gridExtra::grid.arrange(tmap_grob(tm1), g1, nrow=1)</span></span>
<span id="cb66-662"><a href="#cb66-662" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-663"><a href="#cb66-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-664"><a href="#cb66-664" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb66-665"><a href="#cb66-665" aria-hidden="true" tabindex="-1"></a><span class="in">save(list = ls(), file = "ch14.RData")</span></span>
<span id="cb66-666"><a href="#cb66-666" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-667"><a href="#cb66-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-668"><a href="#cb66-668" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb66-669"><a href="#cb66-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-670"><a href="#cb66-670" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Which kinds of geometry support are appropriate for which functions creating neighbour objects?</span>
<span id="cb66-671"><a href="#cb66-671" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Which functions creating neighbour objects are only appropriate for planar representations?</span>
<span id="cb66-672"><a href="#cb66-672" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>What difference might the choice of <span class="in">`rook`</span> rather than <span class="in">`queen`</span> contiguities make on a chessboard?</span>
<span id="cb66-673"><a href="#cb66-673" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>What are the relationships between neighbour set cardinalities (neighbour counts) and row-standardised weights, and how do they open analyses up to edge effects? Use the chessboard you constructed in exercise 3 for both <span class="in">`rook`</span> and <span class="in">`queen`</span> neighbours.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/14-Areal.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>