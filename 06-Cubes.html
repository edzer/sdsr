<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Spatial Data Science - 6&nbsp; Data Cubes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./part-2.html" rel="next">
<link href="./05-Attributes.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-04YTZNEH1K"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
 
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'analytics_storage': 'denied'
  });
gtag('config', 'G-04YTZNEH1K', { 'anonymize_ip': true});
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-1.html">Spatial Data</a></li><li class="breadcrumb-item"><a href="./06-Cubes.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/edzer/sdsr/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-hello.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting Started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-Spaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Coordinates</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-Geometries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Spherical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spherical Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-Attributes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Attributes and Support</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-Cubes.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R for Spatial Data Science</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-Introsf.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-Plotting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-Large.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Models for Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Statistical modelling of spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-PointPattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Point Pattern Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-Interpolation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-Geostatistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-Areal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-Measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of Spatial Autocorrelation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-SpatialRegression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-Econometrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Spatial Econometrics Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sp-raster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Older R Spatial Packages</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rbasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">R Basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ERRATA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Errata to the printed ed.</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#a-four-dimensional-data-cube" id="toc-a-four-dimensional-data-cube" class="nav-link active" data-scroll-target="#a-four-dimensional-data-cube"><span class="header-section-number">6.1</span> A four-dimensional data cube</a></li>
  <li>
<a href="#dimensions-attributes-and-support" id="toc-dimensions-attributes-and-support" class="nav-link" data-scroll-target="#dimensions-attributes-and-support"><span class="header-section-number">6.2</span> Dimensions, attributes, and support</a>
  <ul class="collapse">
<li><a href="#regular-dimensions-gdals-geotransform" id="toc-regular-dimensions-gdals-geotransform" class="nav-link" data-scroll-target="#regular-dimensions-gdals-geotransform">Regular dimensions, GDAL’s geotransform</a></li>
  <li><a href="#support-along-cube-dimensions" id="toc-support-along-cube-dimensions" class="nav-link" data-scroll-target="#support-along-cube-dimensions">Support along cube dimensions</a></li>
  </ul>
</li>
  <li>
<a href="#sec-dcoperations" id="toc-sec-dcoperations" class="nav-link" data-scroll-target="#sec-dcoperations"><span class="header-section-number">6.3</span> Operations on data cubes</a>
  <ul class="collapse">
<li><a href="#slicing-a-cube-filter" id="toc-slicing-a-cube-filter" class="nav-link" data-scroll-target="#slicing-a-cube-filter">Slicing a cube: filter</a></li>
  <li><a href="#sec-applydimension" id="toc-sec-applydimension" class="nav-link" data-scroll-target="#sec-applydimension">Applying functions to dimensions</a></li>
  <li><a href="#sec-reducedimension" id="toc-sec-reducedimension" class="nav-link" data-scroll-target="#sec-reducedimension">Reducing dimensions</a></li>
  </ul>
</li>
  <li><a href="#sec-vectordatacubes" id="toc-sec-vectordatacubes" class="nav-link" data-scroll-target="#sec-vectordatacubes"><span class="header-section-number">6.4</span> Aggregating raster to vector cubes</a></li>
  <li><a href="#sec-switching" id="toc-sec-switching" class="nav-link" data-scroll-target="#sec-switching"><span class="header-section-number">6.5</span> Switching dimension with attributes</a></li>
  <li><a href="#sec-otherdynamic" id="toc-sec-otherdynamic" class="nav-link" data-scroll-target="#sec-otherdynamic"><span class="header-section-number">6.6</span> Other dynamic spatial data</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">6.7</span> Exercises</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/06-Cubes.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-1.html">Spatial Data</a></li><li class="breadcrumb-item"><a href="./06-Cubes.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-datacube" class="quarto-section-identifier"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p> </p>
<p>Data cubes arise naturally when we observe properties of a set of geometries repeatedly over time. Time information may sometimes be considered as an attribute of a feature, such as when we register the year of construction of a building or the date of birth of a person (<a href="05-Attributes.html" class="quarto-xref"><span>Chapter 5</span></a>). In other cases it may refer to the time of observing an attribute, or the time for which a prediction of an attribute has been made. In these cases, time is on equal footing with space, and time and space together describe the physical dimensions over which we observe, model, predict, or make forecasts for.</p>
<p>One way of considering our world is that of a four-dimensional space, with three space dimensions and one time dimension. In that view, events become “things” or “objects” that have as duration their size on the time dimension <span class="citation" data-cites="galton">(<a href="references.html#ref-galton" role="doc-biblioref">Galton 2004</a>)</span>. Although such a view does not align well with how we experience and describe the world, from a data analytical perspective, four numbers, along with their reference systems, suffice to describe space and time coordinates of an observation associated with a point location and time instance.</p>
<p>We define data cubes as array data with one or more array dimensions associated with space and/or time <span class="citation" data-cites="lu2018multidimensional">(<a href="references.html#ref-lu2018multidimensional" role="doc-biblioref">Lu, Appel, and Pebesma 2018</a>)</span>. This implies that raster data, features with attributes, and time series data are all special cases of data cubes. Since we do not restrict to three-dimensional structures, we actually mean <em>hypercubes</em> rather than cubes, and as the cube extent of the different dimensions does not have to be identical, or have comparable units, the better term would be <em>hyper-rectangle</em>. For simplicity, we talk about data cubes instead.</p>
<p></p>
<p>A canonical form of a data cube is shown in <a href="#fig-cube" class="quarto-xref">Figure&nbsp;<span>6.1</span></a>: it shows in a perspective plot a set of raster layers for the same region that were collected (observed, or modelled) at different time steps. The three cube dimensions longitude, latitude, and time, are thought of as being orthogonal. Arbitrary two-dimensional cube slices are obtained by fixing one of the dimensions at a particular value, one-dimensional slices are obtained by fixing two of the dimensions at a particular value, and a scalar is obtained by fixing three dimensions at a particular value.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># (C) 2019, Edzer Pebesma, CC-BY-SA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1331</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://colorspace.R-Forge.R-project.org/">colorspace</a></span><span class="op">)</span></span>
<span><span class="va">tif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nrow</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">ncol</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">nrow</span>,<span class="fl">1</span><span class="op">:</span><span class="va">ncol</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">nrow</span>, y <span class="op">=</span> <span class="va">ncol</span><span class="op">)</span> <span class="co"># named dim</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="co"># s</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">delta</span> <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">delta</span> <span class="op">=</span> <span class="op">-</span><span class="fl">.5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span>, <span class="st">"raster"</span><span class="op">)</span><span class="op">$</span><span class="va">affine</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.2</span>, <span class="fl">0.0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">yoffset</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">add</span>, <span class="va">li</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">+</span> <span class="va">yoffset</span></span>
<span>    <span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">x</span>, as_points <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">sf.colors</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">li</span><span class="op">)</span></span>
<span>        <span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/lighten.html">lighten</a></span><span class="op">(</span><span class="va">pal</span>, <span class="fl">0.3</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span> <span class="va">add</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">l</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="st">"equal"</span>, pal <span class="op">=</span> <span class="va">pal</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="fl">.75</span><span class="op">)</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span>, main <span class="op">=</span> <span class="cn">NULL</span>, xlab <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span></span>
<span>    <span class="kw">else</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">l</span>, axes <span class="op">=</span> <span class="cn">TRUE</span>, breaks <span class="op">=</span> <span class="st">"equal"</span>, pal <span class="op">=</span> <span class="va">pal</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="fl">.75</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span></span>
<span>    <span class="co"># print(u)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">pl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">add</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">randomize</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">x</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">y</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">nrow</span>,<span class="va">x</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">ncol</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">randomize</span><span class="op">)</span></span>
<span>    <span class="va">m</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">y</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">nrow</span><span class="op">)</span>,<span class="va">x</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">ncol</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">nrow</span>, y <span class="op">=</span> <span class="va">ncol</span><span class="op">)</span> <span class="co"># named dim</span></span>
<span>  <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">m</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span>, <span class="va">add</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">1</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">2</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">3</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">4</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">5</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">6</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">7</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">8</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">plot.window</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">12</span>,<span class="fl">15</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>,<span class="fl">10</span><span class="op">)</span>, asp<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co"># box()</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">0</span>, <span class="st">"time"</span>, srt <span class="op">=</span> <span class="op">-</span><span class="fl">90</span>, col <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>,  <span class="fl">6.5</span>, <span class="st">"latitude"</span>, srt <span class="op">=</span> <span class="fl">25</span>, col <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">5</span>,  <span class="fl">8.5</span>, <span class="st">"longitude"</span>, srt <span class="op">=</span> <span class="fl">0</span>, col <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cube" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cube-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-Cubes_files/figure-html/fig-cube-1.png" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cube-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.1: Raster data cube with dimensions latitude, longitude, and time
</figcaption></figure>
</div>
</div>
</div>
<section id="a-four-dimensional-data-cube" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="a-four-dimensional-data-cube">
<span class="header-section-number">6.1</span> A four-dimensional data cube</h2>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># (C) 2021, Jonathan Bahlmann, CC-BY-SA</span></span>
<span><span class="co"># https://github.com/Open-EO/openeo.org/tree/master/documentation/1.0/datacubes/.scripts</span></span>
<span><span class="co"># based on work by Edzer Pebesma, 2019, here: https://gist.github.com/edzer/5f1b0faa3e93073784e01d5a4bb60eca</span></span>
<span></span>
<span><span class="co"># plotting runs via a dummy stars object with x, y dimensions (no bands)</span></span>
<span><span class="co"># to not be overly dependent on an input image, time steps and bands</span></span>
<span><span class="co"># are displayed by replacing the matrix contained in the dummy stars object</span></span>
<span><span class="co"># every time something is plotted</span></span>
<span></span>
<span><span class="co"># packages, read input ----</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1331</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://colorspace.R-Forge.R-project.org/">colorspace</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make color palettes ----</span></span>
<span><span class="va">blues</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/hcl_palettes.html">sequential_hcl</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">20</span>, h1 <span class="op">=</span> <span class="fl">211</span>, c1 <span class="op">=</span> <span class="fl">80</span>, l1 <span class="op">=</span> <span class="fl">40</span>, l2 <span class="op">=</span> <span class="fl">100</span>, p1 <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">greens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/hcl_palettes.html">sequential_hcl</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">20</span>, h1 <span class="op">=</span> <span class="fl">134</span>, c1 <span class="op">=</span> <span class="fl">80</span>, l1 <span class="op">=</span> <span class="fl">40</span>, l2 <span class="op">=</span> <span class="fl">100</span>, p1 <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">reds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/hcl_palettes.html">sequential_hcl</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">20</span>, h1 <span class="op">=</span> <span class="fl">360</span>, c1 <span class="op">=</span> <span class="fl">80</span>, l1 <span class="op">=</span> <span class="fl">40</span>, l2 <span class="op">=</span> <span class="fl">100</span>, p1 <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">purples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/hcl_palettes.html">sequential_hcl</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">20</span>, h1 <span class="op">=</span> <span class="fl">299</span>, c1 <span class="op">=</span> <span class="fl">80</span>, l1 <span class="op">=</span> <span class="fl">40</span>, l2 <span class="op">=</span> <span class="fl">100</span>, p1 <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">greys</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/hcl_palettes.html">sequential_hcl</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">20</span>, h1 <span class="op">=</span> <span class="fl">0</span>, c1 <span class="op">=</span> <span class="fl">0</span>, l1 <span class="op">=</span> <span class="fl">40</span>, l2 <span class="op">=</span> <span class="fl">100</span>, p1 <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># matrices from raster ----</span></span>
<span><span class="co"># make input matrices from an actual raster image</span></span>
<span><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="st">"data/iceland_delta_cutout_2.tif"</span><span class="op">)</span> <span class="co"># this raster needs approx 6x7 format</span></span>
<span><span class="co"># if the input raster is changed, every image where a pixel value is written as text needs to be checked and corrected accordingly</span></span>
<span><span class="va">input</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">warped</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_warp.html">st_warp</a></span><span class="op">(</span><span class="va">input</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span>, cellsize <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> <span class="co"># warp to approx. 6x7 pixel</span></span>
<span></span>
<span><span class="co"># these are only needed for resampling</span></span>
<span><span class="va">warped_highres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_warp.html">st_warp</a></span><span class="op">(</span><span class="va">warped</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">warped</span><span class="op">)</span>, cellsize <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="co"># with different input, cellsize must be adapted</span></span>
<span><span class="co"># this is a bit of a trick, because 3:4 is different format than 6:7</span></span>
<span><span class="co"># when downsampling, the raster of origin isn't so important anyway</span></span>
<span><span class="va">warped_lowres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_warp.html">st_warp</a></span><span class="op">(</span><span class="va">warped_highres</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">11</span>,,<span class="op">]</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">warped</span><span class="op">)</span>, cellsize <span class="op">=</span> <span class="fl">390</span><span class="op">)</span></span>
<span><span class="co"># plot(warped_lowres)</span></span>
<span><span class="co"># image(warped[,,,1], text_values = TRUE)</span></span>
<span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">42</span>, <span class="op">-</span><span class="fl">30</span>, <span class="fl">150</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="co"># create timesteps 2 and 3 randomly</span></span>
<span><span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">42</span>, <span class="op">-</span><span class="fl">250</span>, <span class="fl">50</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create dummy stars object ----</span></span>
<span><span class="va">make_dummy_stars</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">d1</span>, <span class="va">d2</span>, <span class="va">aff</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">m</span> <span class="op">=</span> <span class="va">warped_highres</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">x</span>,<span class="fl">1</span><span class="op">:</span><span class="va">y</span>,<span class="fl">1</span><span class="op">]</span> <span class="co"># underlying raster doesn't matter because it's just dummy construct</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span> <span class="co"># named dim</span></span>
<span>  <span class="va">dummy</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">dummy</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">delta</span> <span class="op">=</span> <span class="va">d1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">dummy</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">delta</span> <span class="op">=</span> <span class="va">d2</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">dummy</span>, <span class="st">"dimensions"</span><span class="op">)</span>, <span class="st">"raster"</span><span class="op">)</span><span class="op">$</span><span class="va">affine</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">aff</span>, <span class="fl">0.0</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dummy</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">make_dummy_stars</span><span class="op">(</span><span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">2.5</span>, <span class="op">-</span><span class="fl">.5714286</span>, <span class="op">-</span><span class="fl">1.14</span><span class="op">)</span> <span class="co"># mainly used, perspective</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu">make_dummy_stars</span><span class="op">(</span><span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># flat</span></span>
<span><span class="va">highres</span> <span class="op">&lt;-</span> <span class="fu">make_dummy_stars</span><span class="op">(</span><span class="fl">12</span>, <span class="fl">14</span>, <span class="fl">1.25</span>, <span class="op">-</span><span class="fl">.2857143</span>, <span class="op">-</span><span class="fl">.57</span><span class="op">)</span> <span class="co"># for resampling</span></span>
<span><span class="va">lowres</span> <span class="op">&lt;-</span> <span class="fu">make_dummy_stars</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">2</span><span class="op">)</span> <span class="co"># for resampling</span></span>
<span></span>
<span><span class="co"># matrices from image ----</span></span>
<span><span class="va">make_matrix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">image</span>, <span class="va">band</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">42</span>, <span class="va">ncol</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">t</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># this is based on an input image with &gt;= 4 input bands</span></span>
<span>  <span class="co"># n is meant to cut off NAs, ncol is y, t is random matrix for time difference</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">image</span><span class="op">[</span>,,,<span class="va">band</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="va">ncol</span><span class="op">)</span> <span class="op">-</span> <span class="va">t</span><span class="op">)</span></span>
<span>  <span class="co"># before: b3 &lt;- matrix(warped[,,,1][[1]][1:42], ncol = 7) - t2</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># now use function: </span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">b2</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">1</span>, t <span class="op">=</span> <span class="va">t1</span><span class="op">)</span></span>
<span><span class="va">b3</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">1</span>, t <span class="op">=</span> <span class="va">t2</span><span class="op">)</span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">2</span>, t <span class="op">=</span> <span class="va">t1</span><span class="op">)</span></span>
<span><span class="va">g3</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">2</span>, t <span class="op">=</span> <span class="va">t2</span><span class="op">)</span></span>
<span><span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">3</span>, t <span class="op">=</span> <span class="va">t1</span><span class="op">)</span></span>
<span><span class="va">r3</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">3</span>, t <span class="op">=</span> <span class="va">t2</span><span class="op">)</span></span>
<span><span class="va">n1</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">n2</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">4</span>, t <span class="op">=</span> <span class="va">t1</span><span class="op">)</span></span>
<span><span class="va">n3</span> <span class="op">&lt;-</span> <span class="fu">make_matrix</span><span class="op">(</span><span class="va">warped</span>, <span class="fl">4</span>, t <span class="op">=</span> <span class="va">t2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot functions ----</span></span>
<span><span class="va">plt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">yoffset</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">add</span>, <span class="va">li</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">pal</span>, <span class="va">print_geom</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">border</span> <span class="op">=</span> <span class="fl">.75</span>, <span class="va">breaks</span> <span class="op">=</span> <span class="st">"equal"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># pal is color palette</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">+</span> <span class="va">yoffset</span> </span>
<span>  <span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">x</span>, as_points <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">li</span><span class="op">)</span></span>
<span>    <span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/lighten.html">lighten</a></span><span class="op">(</span><span class="va">pal</span>, <span class="fl">0.2</span><span class="op">)</span> <span class="co"># + rnorm(1, 0, 0.1))</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span> <span class="va">add</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">l</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="va">breaks</span>, pal <span class="op">=</span> <span class="va">pal</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="va">border</span><span class="op">)</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span>, main <span class="op">=</span> <span class="cn">NULL</span>, xlab <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span></span>
<span>  <span class="kw">else</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">l</span>, axes <span class="op">=</span> <span class="cn">TRUE</span>, breaks <span class="op">=</span> <span class="va">breaks</span>, pal <span class="op">=</span> <span class="va">pal</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="va">border</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span></span>
<span>  <span class="co"># print(u)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">print_geom</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># not print geometry</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">pl_stack</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">add</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">nrM</span>, <span class="va">imgY</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">inner</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># nrM is the timestep {1, 2, 3}, cause this function</span></span>
<span>  <span class="co"># prints all 4 bands at once</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">x</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="co"># m &lt;- r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"n"</span>, <span class="va">nrM</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">imgY</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="co"># turn around to have same orientation as flat plot</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span>, <span class="cn">TRUE</span>,  pal <span class="op">=</span> <span class="va">purples</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"r"</span>, <span class="va">nrM</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">imgY</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">1</span><span class="op">*</span><span class="va">inner</span>, <span class="cn">TRUE</span>,  pal <span class="op">=</span> <span class="va">reds</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"g"</span>, <span class="va">nrM</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">imgY</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">2</span><span class="op">*</span><span class="va">inner</span>, <span class="cn">TRUE</span>,  pal <span class="op">=</span> <span class="va">greens</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="va">nrM</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">imgY</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">3</span><span class="op">*</span><span class="va">inner</span>, <span class="cn">TRUE</span>, pal <span class="op">=</span> <span class="va">blues</span><span class="op">)</span> <span class="co"># li FALSE deleted</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># flat plot function</span></span>
<span><span class="co"># prints any dummy stars with any single matrix to position</span></span>
<span><span class="va">pl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">add</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">randomize</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">pal</span>, <span class="va">m</span>, <span class="va">print_geom</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">border</span> <span class="op">=</span> <span class="fl">.75</span>, <span class="va">breaks</span> <span class="op">=</span> <span class="st">"equal"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># m is matrix to replace image with</span></span>
<span>  <span class="co"># m &lt;- t(m)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">x</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="co"># print(m)</span></span>
<span>  <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">m</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, pal <span class="op">=</span> <span class="va">pal</span>, print_geom <span class="op">=</span> <span class="va">print_geom</span>, border <span class="op">=</span> <span class="va">border</span>, breaks <span class="op">=</span> <span class="va">breaks</span><span class="op">)</span></span>
<span>  <span class="co">#plot(s, text_values = TRUE)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">print_segments</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">seg</span>, <span class="va">by</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">lwd</span> <span class="op">=</span> <span class="fl">4</span>, <span class="va">col</span> <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">seg</span> <span class="op">&lt;-</span> <span class="va">seg</span> <span class="op">*</span> <span class="va">by</span></span>
<span>  <span class="va">seg</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">seg</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span></span>
<span>  <span class="va">seg</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">seg</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span></span>
<span>  <span class="va">seg</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">seg</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">y</span></span>
<span>  <span class="va">seg</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">seg</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="va">y</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="va">seg</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">seg</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">seg</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, <span class="va">seg</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="va">lwd</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># time series ----</span></span>
<span></span>
<span><span class="co"># from: cube1_ts_6x7_bigger.png</span></span>
<span><span class="va">offset</span> <span class="op">=</span> <span class="fl">26</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#par(mar = c(3, 2, 7, 2))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#plot.window(xlim = c(10, 50), ylim = c(-3, 10), asp = 1)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">plot.window</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">15</span>, <span class="fl">75</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">10</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">pl_stack</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span>, <span class="fl">0</span>, nrM <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">pl_stack</span><span class="op">(</span><span class="va">s</span>, <span class="va">offset</span>, <span class="fl">0</span>, nrM <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">pl_stack</span><span class="op">(</span><span class="va">s</span>, <span class="fl">2</span> <span class="op">*</span> <span class="va">offset</span>, <span class="fl">0</span>, nrM <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># po &lt;- matrix(c(0,-8,7,0,15,3.5,  0,1,1,5,5,14), ncol = 2)</span></span>
<span><span class="va">heads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.5</span>, <span class="fl">3.5</span> <span class="op">+</span> <span class="va">offset</span>, <span class="fl">3.5</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">offset</span>, <span class="fl">14</span>,<span class="fl">14</span>,<span class="fl">14</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">heads</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span> <span class="co"># 4 or 16</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">8</span>, <span class="fl">7</span>, <span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span>, <span class="fl">3.5</span>, <span class="fl">14</span><span class="op">)</span> <span class="co"># first stack pyramid</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">8</span>, <span class="fl">7</span>, <span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span> <span class="op">+</span> <span class="va">offset</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span>, <span class="fl">3.5</span> <span class="op">+</span> <span class="va">offset</span>, <span class="fl">14</span><span class="op">)</span> <span class="co"># second stack pyramid</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">8</span>, <span class="fl">7</span>, <span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">offset</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span>, <span class="fl">3.5</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">offset</span>, <span class="fl">14</span><span class="op">)</span> <span class="co"># third stack pyramid</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="op">-</span><span class="fl">13</span>, <span class="fl">14</span>, <span class="fl">72</span>, <span class="fl">14</span>, angle <span class="op">=</span> <span class="fl">20</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>  <span class="co"># timeline</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">7.5</span>, <span class="fl">3.8</span>, <span class="st">"x"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="st">"bands"</span>, srt <span class="op">=</span> <span class="fl">90</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4.5</span>, <span class="fl">1.8</span>, <span class="st">"y"</span>, srt <span class="op">=</span> <span class="fl">27.5</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">15.8</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">69</span>, <span class="va">y</span>, <span class="st">"time"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3.5</span>, <span class="va">y</span>, <span class="st">"2020-10-01"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3.5</span> <span class="op">+</span> <span class="va">offset</span>, <span class="va">y</span>, <span class="st">"2020-10-13"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3.5</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">offset</span>, <span class="va">y</span>, <span class="st">"2020-10-25"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cube4d" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cube4d-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-Cubes_files/figure-html/fig-cube4d-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cube4d-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.2: Four-dimensional raster data cube with dimensions x, y, bands, and time
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-cube4d" class="quarto-xref">Figure&nbsp;<span>6.2</span></a> depicts a four-dimensional raster data cube <span class="citation" data-cites="appel2019demand">(<a href="references.html#ref-appel2019demand" role="doc-biblioref">Appel and Pebesma 2019</a>)</span>, where three-dimensional raster data cubes with a spectral dimension (“bands”) are organised along a fourth dimension, a time axis. Colour image data always has three bands (blue, green, red), and this example has a fourth band (near infrared, NIR), which is commonly found in spectral remote sensing data.</p>
<p><a href="#fig-cube4d2" class="quarto-xref">Figure&nbsp;<span>6.3</span></a> shows exactly the same data, but layed out flat as a facet plot (or scatterplot matrix), where two dimensions (<span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>) are aligned with (or nested within) the dimensions <em>bands</em> and <em>time</em>, respectively.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># flat ----</span></span>
<span><span class="va">xlabels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">warped</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">warped</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">delta</span> <span class="op">/</span> <span class="fl">2</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">warped</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">to</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">warped</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">delta</span><span class="op">)</span></span>
<span><span class="va">ylabels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">warped</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">warped</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">delta</span> <span class="op">/</span> <span class="fl">2</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">warped</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">to</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">warped</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">delta</span><span class="op">)</span></span>
<span></span>
<span><span class="va">print_labels</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">off</span>, <span class="va">lab</span>, <span class="va">horizontal</span>, <span class="va">cex</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">horizontal</span><span class="op">)</span> <span class="op">{</span> <span class="co"># x</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">lab</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">i</span><span class="op">*</span><span class="va">off</span>, <span class="va">y</span>, <span class="va">lab</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>, cex <span class="op">=</span> <span class="va">cex</span>, srt <span class="op">=</span> <span class="fl">90</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="co"># y</span></span>
<span>    <span class="va">lab</span> <span class="op">&lt;-</span> <span class="va">lab</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">lab</span><span class="op">)</span><span class="op">:</span><span class="fl">0</span><span class="op">]</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">lab</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span> <span class="op">+</span> <span class="va">i</span><span class="op">*</span><span class="va">off</span>, <span class="va">lab</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># before: width=1000, xlim(-2, 33), date labels x=31</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># par(mar = c(0,0,0,0))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">plot.window</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">40</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">25</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span>, <span class="fl">0</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b1</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span>, <span class="fl">10</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b2</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span>, <span class="fl">20</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b3</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span>, <span class="fl">0</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="va">g1</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span>, <span class="fl">10</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="va">g2</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span>, <span class="fl">20</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="va">g3</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span>, <span class="fl">0</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="va">r1</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span>, <span class="fl">10</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="va">r2</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span>, <span class="fl">20</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="va">r3</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">28</span>, <span class="fl">0</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="va">n1</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">28</span>, <span class="fl">10</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="va">n2</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">28</span>, <span class="fl">20</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="va">n3</span><span class="op">)</span></span>
<span><span class="fu">print_labels</span><span class="op">(</span><span class="fl">28.5</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="va">xlabels</span>, horizontal <span class="op">=</span> <span class="cn">TRUE</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">print_labels</span><span class="op">(</span><span class="fl">36</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="va">ylabels</span>, horizontal <span class="op">=</span> <span class="cn">FALSE</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="co"># arrows(6, 27, 6, 0, angle = 20, lwd = 2)</span></span>
<span><span class="co"># text(5, 14, "time", srt = 90, col = "black")</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">28</span>, <span class="st">"blue"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">17</span>, <span class="fl">28</span>, <span class="st">"green"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">24</span>, <span class="fl">28</span>, <span class="st">"red"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">31</span>, <span class="fl">28</span>, <span class="st">"nir"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">23.5</span>, <span class="st">"2020-10-01"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">13.5</span>, <span class="st">"2020-10-13"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3.5</span>, <span class="st">"2020-10-25"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cube4d2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cube4d2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-Cubes_files/figure-html/fig-cube4d2-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cube4d2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.3: Four-dimensional raster data cube layed out flat over two dimensions
</figcaption></figure>
</div>
</div>
</div>
</section><section id="dimensions-attributes-and-support" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="dimensions-attributes-and-support">
<span class="header-section-number">6.2</span> Dimensions, attributes, and support</h2>
<p> </p>
<p>Phenomena in space and time can be thought of as functions with <em>domain</em> space and time, and with <em>range</em> one or more observed attributes. For clearly identifiable discrete events or objects, the range is typically discrete, and precise delineation involves describing the precise coordinates where a thing starts or stops, which is best suited by vector geometries. For continuous phenomena, variables that take on a value everywhere such as air temperature or land use type, there are infinitely many values to represent and a common approach is to discretise space and time <em>regularly</em> over the spatiotemporal domain (extent) of interest. This leads to a number of familiar data structures:</p>
<ul>
<li>time series, depicted as time lines for functions of time</li>
<li>image or raster data for two-dimensional spatial data</li>
<li>time sequences of images for dynamic spatial data</li>
</ul>
<p>The third form of this, where a variable <span class="math inline">\(Z\)</span> depends on <span class="math inline">\(x\)</span>, <span class="math inline">\(y\)</span> and <span class="math inline">\(t\)</span>, as in</p>
<p><span class="math display">\[Z = f(x, y, t)\]</span></p>
<p>is the archetype of a spatiotemporal array or <em>data cube</em>: the shape of the volume where points regularly discretising the domain forms a cube. We call the variables that form the range (here: <span class="math inline">\(x, y, t\)</span>) the cube <em>dimensions</em>. Data cubes may have multiple attributes, as in</p>
<p><span class="math display">\[\{Z_1,Z_2,...,Z_p\} = f(x, y, t)\]</span></p>
<p>and if <span class="math inline">\(Z\)</span> is functional, for instance reflectance values measured over the electromagnetic spectrum, the spectral wavelengths <span class="math inline">\(\lambda\)</span> may form an additional dimension, as in <span class="math inline">\(Z = f(x,y,t,\lambda)\)</span>. <a href="#sec-switching" class="quarto-xref"><span>Section 6.5</span></a> discusses the alternative of representing colour bands as attributes.</p>
<p>Multiple time dimensions arise for instance when making forecasts for different times in the future <span class="math inline">\(t'\)</span> at different times <span class="math inline">\(t\)</span>, or when time is split over multiple dimensions (as in year, day-of-year, and hour-of-day). The most general definition of a data cube is a functional mapping from <span class="math inline">\(n\)</span> dimensions to <span class="math inline">\(p\)</span> attributes:</p>
<p><span class="math display">\[\{Z_1,Z_2,...,Z_p\} = f(D_1,D_2,...,D_n)\]</span></p>
<p>Here, we will consider any dataset with one or more space dimensions and zero or more time dimensions as data cubes. That includes:</p>
<ul>
<li>simple features (<a href="03-Geometries.html#sec-simplefeatures" class="quarto-xref"><span>Section 3.1</span></a>)</li>
<li>time series for sets of features</li>
<li>raster data</li>
<li>multi-spectral raster data (images)</li>
<li>time series of multi-spectral raster data (video)</li>
</ul>
<p> </p>
<section id="regular-dimensions-gdals-geotransform" class="level3"><h3 class="anchored" data-anchor-id="regular-dimensions-gdals-geotransform">Regular dimensions, GDAL’s geotransform</h3>
<p> </p>
<p>Data cubes are usually stored in multi-dimensional arrays, and the usual relationship between 1-based array index <span class="math inline">\(i\)</span> and an associated regularly discretised dimension variable <span class="math inline">\(x\)</span> is</p>
<p><span class="math display">\[x = o_x + (i-1) d_x\]</span></p>
<p>with <span class="math inline">\(o_x\)</span> the origin, and <span class="math inline">\(d_x\)</span> the grid spacing for this dimension.</p>
<p>For more general cases like those in Figures <a href="01-hello.html#fig-rastertypes01" class="quarto-xref"><span>1.6</span></a> b-c, the relation between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> and array indexes <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> is</p>
<p><span class="math display">\[x = o_x + (i-1) d_x + (j-1) a_1\]</span></p>
<p><span class="math display">\[y = o_y + (i-1) a_2 + (j-1) d_y\]</span></p>
<p>With two affine parameters <span class="math inline">\(a_1\)</span> and <span class="math inline">\(a_2\)</span>; this is the so-called <em>geotransform</em> as used in GDAL. When <span class="math inline">\(a_1=a_2=0\)</span>, this reduces to the regular raster of <a href="01-hello.html#fig-rastertypes01" class="quarto-xref">Figure&nbsp;<span>1.6</span></a> a with square cells if <span class="math inline">\(d_x = d_y\)</span>. For integer indexes, the coordinates are that of the starting <em>edge</em> of a grid cell, and the cell area (pixel) spans a range corresponding to index values ranging from <span class="math inline">\(i\)</span> (inclusive) to <span class="math inline">\(i+1\)</span> (exclusive). For most common imagery formats, <span class="math inline">\(d_y\)</span> is negative, indicating that image row index increases with decreasing <span class="math inline">\(y\)</span> values (southward). To get the <span class="math inline">\(x\)</span>- and <span class="math inline">\(y\)</span>-coordinate of the grid cell <em>centre</em> of the top left grid cell (in case of a negative <span class="math inline">\(d_y\)</span>), we use <span class="math inline">\(i=1.5\)</span> and <span class="math inline">\(j=1.5\)</span>.</p>
<p>For rectilinear rasters, a table that maps array index to dimension values is needed. NetCDF files for instance always store all values of spatial dimension (coordinate) variables that may correspond to the centre or offset of spatial grid cells, and in addition may store grid cell boundaries (to define rectilinear dimensions or to disambiguate the relation of the coordinate variable values to the cell boundaries).</p>
<p> </p>
<p>For curvilinear rasters, an array that maps every combination of <span class="math inline">\(i,j\)</span> into <span class="math inline">\(x,y\)</span> pairs is needed, or a parametric function that does this (a projection or its inverse). NetCDF files often provide both, when available. GDAL calls such arrays <em>geolocation arrays</em>, and has extensive support for transformations involving them.</p>
<p> </p>
</section><section id="support-along-cube-dimensions" class="level3"><h3 class="anchored" data-anchor-id="support-along-cube-dimensions">Support along cube dimensions</h3>
<p> </p>
<p><a href="05-Attributes.html#sec-agr" class="quarto-xref"><span>Section 5.1</span></a> defined <em>spatial</em> support of an attribute variable as the size (length, area, volume) of a geometry associated with a particular observation or prediction. The same notion applies to temporal support. Although time is rarely reported by explicit time periods having a start- and end-time, in many cases either the time stamp implies a period (ISO-8601 uses “2021” for the full year, “2021-01” for the full month) or the time period is taken as the period from the time stamp of the current record up to but not including the time stamp of the next record.</p>
<p>An example is MODIS satellite imagery, where vegetation indexes (NDVI and EVI) are available as 16-day composites, meaning that over 16-day periods all available imagery is aggregated into a single image; such composites have temporal “block support”. Sentinel-2 or Landsat-8 data on the other hand are “snapshot” images and have temporal “point support”. When temporally aggregating data with temporal point support, for instance to monthly values, all images falling in the target time interval are selected. When aggregating temporal block support imagery such as the MODIS 16-day composite, one might weigh images according to the amount of overlap of the 16-day composite period and the target period, similar to area-weighted interpolation <a href="05-Attributes.html#sec-area-weighted" class="quarto-xref"><span>Section 5.3</span></a> but over the time dimension.</p>
</section></section><section id="sec-dcoperations" class="level2" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="sec-dcoperations">
<span class="header-section-number">6.3</span> Operations on data cubes</h2>
<section id="slicing-a-cube-filter" class="level3"><h3 class="anchored" data-anchor-id="slicing-a-cube-filter">Slicing a cube: filter</h3>
<p></p>
<p>Data cubes can be sliced into sub-cubes by fixing a dimension at a particular value. <a href="#fig-cube4filter" class="quarto-xref">Figure&nbsp;<span>6.4</span></a> shows the sub-cubes obtained by doing this with the temporal, spectral, or spatial dimension. In this figure, the spatial filtering does not happen by fixing a single spatial dimension at a particular value, but by selecting a particular sub-region, which is a more common operation. Fixing <span class="math inline">\(x\)</span> or <span class="math inline">\(y\)</span> would give a sub-cube along a transect of constant <span class="math inline">\(x\)</span> or <span class="math inline">\(y\)</span>, which can be used to show a Hovmöller diagram, where an attribute is plotted (coloured) in the space of one space and one time dimension.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># filter ----</span></span>
<span><span class="co"># mask &lt;- matrix(c(rep(NA, 26), 1,NA,1,NA,1,1,1, rep(NA, 9)), ncol = 7)</span></span>
<span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>                 <span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>                 <span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>,</span>
<span>                 <span class="cn">NA</span>,<span class="cn">NA</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>,<span class="cn">NA</span>,</span>
<span>                 <span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>, <span class="fl">1</span>, <span class="fl">1</span>,<span class="cn">NA</span>,</span>
<span>                 <span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>                 <span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span></span>
<span><span class="va">print_grid</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b2</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b3</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="va">g1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="va">g2</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="va">g3</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="va">r1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="va">r2</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="va">r3</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="va">n1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="va">n2</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="va">n3</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">print_alpha_grid</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>, <span class="va">alp</span> <span class="op">=</span> <span class="fl">0.2</span>, <span class="va">geom</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">blues</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">b1</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">blues</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">b2</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">blues</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">b3</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">greens</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">g1</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">greens</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">g2</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">greens</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">g3</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">reds</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">r1</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">reds</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">r2</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">reds</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">r3</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">purples</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">n1</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">purples</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">n2</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">purples</span>, <span class="va">alp</span><span class="op">)</span>, print_geom <span class="op">=</span> <span class="va">geom</span>,  m <span class="op">=</span> <span class="va">n3</span>, border <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">print_grid_filter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">b1</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">b2</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">b3</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">g1</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">g2</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">g3</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">r1</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">r2</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">r3</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">n1</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">n2</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">n3</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">print_grid_time_filter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span> <span class="co"># 3x1, 28x7</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b3</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="va">g3</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="va">r3</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="va">n3</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">print_grid_bands_filter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">pal</span> <span class="op">=</span> <span class="va">greys</span><span class="op">)</span> <span class="op">{</span> <span class="co"># 1x3 6x27</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">pal</span>, m <span class="op">=</span> <span class="va">n1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">pal</span>, m <span class="op">=</span> <span class="va">n2</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">pal</span>, m <span class="op">=</span> <span class="va">n3</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># build exactly like reduce</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">120</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">down</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">plot.window</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">x</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">y</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">print_grid</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">-</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span>,<span class="va">y</span><span class="op">-</span><span class="fl">27</span><span class="op">)</span></span>
<span><span class="fu">print_alpha_grid</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">-</span><span class="fl">28</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span>, <span class="fl">0</span><span class="op">-</span><span class="va">down</span><span class="op">)</span> <span class="co"># alpha grid</span></span>
<span><span class="fu">print_grid_time_filter</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">-</span><span class="fl">28</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span>, <span class="op">-</span><span class="fl">10</span><span class="op">-</span><span class="va">down</span><span class="op">)</span> <span class="co"># select 3rd</span></span>
<span><span class="fu">print_alpha_grid</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">-</span><span class="fl">6</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span><span class="fl">10.5</span>, <span class="fl">0</span><span class="op">-</span><span class="va">down</span><span class="op">)</span> <span class="co"># alpha grid</span></span>
<span><span class="fu">print_grid_bands_filter</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">-</span><span class="fl">12.4</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">-</span><span class="va">down</span>, pal <span class="op">=</span> <span class="va">purples</span><span class="op">)</span></span>
<span><span class="fu">print_alpha_grid</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">-</span><span class="fl">28</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0</span><span class="op">-</span><span class="va">down</span><span class="op">)</span> <span class="co"># alpha grid</span></span>
<span><span class="fu">print_grid_filter</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">-</span><span class="fl">28</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0</span><span class="op">-</span><span class="va">down</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">13.5</span><span class="op">-</span><span class="va">down</span>, <span class="st">"time"</span>, srt <span class="op">=</span> <span class="fl">90</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">43</span>, <span class="fl">13.5</span><span class="op">-</span><span class="va">down</span>, <span class="st">"time"</span>, srt <span class="op">=</span> <span class="fl">90</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">83</span>, <span class="fl">13.5</span><span class="op">-</span><span class="va">down</span>, <span class="st">"time"</span>, srt <span class="op">=</span> <span class="fl">90</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">30</span>, <span class="st">"bands"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">60</span>, <span class="fl">30</span>, <span class="st">"bands"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">30</span>, <span class="st">"bands"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">-</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span>,<span class="va">y</span><span class="op">-</span><span class="fl">30</span>, <span class="va">x</span><span class="op">/</span><span class="fl">6</span>,<span class="fl">32</span>, angle <span class="op">=</span> <span class="fl">20</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span>,<span class="va">y</span><span class="op">-</span><span class="fl">30</span>, <span class="va">x</span><span class="op">/</span><span class="fl">2</span>,<span class="fl">32</span>, angle <span class="op">=</span> <span class="fl">20</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span>,<span class="va">y</span><span class="op">-</span><span class="fl">30</span>, <span class="fl">100</span>, <span class="fl">32</span>, angle <span class="op">=</span> <span class="fl">20</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co"># points(seq(1,120,10), seq(1,120,10))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">28.5</span>,<span class="fl">49</span>, <span class="st">"filter temporally"</span>, srt <span class="op">=</span> <span class="fl">55.5</span>, col <span class="op">=</span> <span class="st">"black"</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">57</span>,<span class="fl">49</span>, <span class="st">"filter bands"</span>, srt <span class="op">=</span> <span class="fl">90</span>, col <span class="op">=</span> <span class="st">"black"</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">91.5</span>,<span class="fl">49</span>, <span class="st">"filter spatially"</span>, srt <span class="op">=</span> <span class="op">-</span><span class="fl">55.5</span>, col <span class="op">=</span> <span class="st">"black"</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="fu">print_labels</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">-</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">3</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">+</span><span class="fl">4</span>, off <span class="op">=</span> <span class="fl">7</span>, lab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"green"</span>, <span class="st">"red"</span>, <span class="st">"nir"</span><span class="op">)</span>,</span>
<span>             horizontal <span class="op">=</span> <span class="cn">TRUE</span>, cex <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span><span class="fu">print_labels</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">-</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span> <span class="op">-</span> <span class="fl">9</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">-</span><span class="fl">23</span>, off <span class="op">=</span> <span class="fl">10</span>, lab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2020-10-01"</span>, <span class="st">"2020-10-13"</span>, <span class="st">"2020-10-25"</span><span class="op">)</span>,</span>
<span>             horizontal <span class="op">=</span> <span class="cn">FALSE</span>, cex <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span><span class="fu">print_labels</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">-</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">21.5</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">-</span><span class="fl">30</span>, off <span class="op">=</span> <span class="fl">1</span>, lab <span class="op">=</span> <span class="va">xlabels</span>,</span>
<span>             horizontal <span class="op">=</span> <span class="cn">TRUE</span>, cex <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="fu">print_labels</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">-</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">30</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">-</span><span class="fl">26.5</span>, off <span class="op">=</span> <span class="fl">1</span>, lab <span class="op">=</span> <span class="va">ylabels</span>,</span>
<span>             horizontal <span class="op">=</span> <span class="cn">FALSE</span>, cex <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cube4filter" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cube4filter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-Cubes_files/figure-html/fig-cube4filter-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cube4filter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.4: Data cube filtering by time, band or spatially
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-applydimension" class="level3"><h3 class="anchored" data-anchor-id="sec-applydimension">Applying functions to dimensions</h3>
<p> </p>
<p>A common analysis involves applying a function over one or more cube dimensions. Simple cases arise where a function such as <code>abs</code>, <code>sin</code>, or <code>sqrt</code> is applied to all values in the cube, or when a function takes all values in the cube and returns a single scalar, such as when computing the mean or maximum value over the entire cube. Other options include applying the function to selected dimensions, such as applying a <em>temporal</em> low-pass filter to every individual (pixel/band) time series as shown in <a href="#fig-cube4apply1" class="quarto-xref">Figure&nbsp;<span>6.5</span></a>, or applying a <em>spatial</em> low-pass filter to every spatial slice for every band/time combination, shown in <a href="#fig-cube4apply2" class="quarto-xref">Figure&nbsp;<span>6.6</span></a>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">print_text</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># m &lt;- t(m) # transverse for correct order</span></span>
<span>  <span class="co"># print(m)</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">5.5</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">7</span><span class="op">)</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">+</span> <span class="va">x</span> <span class="co"># consider offsets</span></span>
<span>  <span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">6</span><span class="op">)</span>, </span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">3.5</span>, <span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">4.5</span>, <span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">5.5</span>, <span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">6.5</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">u</span> <span class="op">&lt;-</span> <span class="va">u</span> <span class="op">+</span> <span class="va">y</span> <span class="co"># offset</span></span>
<span>  <span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">r</span>,<span class="va">u</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">42</span>, byrow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># make point table</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">42</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">#text(tab[i, 1], tab[i, 2], labels = paste0("", m[i]), cex = 1.1)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">tab</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">tab</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">""</span>, <span class="va">m</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">time_arrow_seg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.0</span>, <span class="fl">0.3</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>, <span class="fl">5.1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.0</span>, <span class="fl">0.3</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>, <span class="fl">5.1</span><span class="op">)</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">4.3</span>, <span class="fl">5.6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">4.3</span>, <span class="fl">5.6</span><span class="op">)</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">time_arrow_flag_seg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span><span class="op">)</span>,</span>
<span>                                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">5.6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">5.6</span><span class="op">)</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b11</span> <span class="op">&lt;-</span> <span class="va">b2</span> <span class="op">-</span> <span class="va">t1</span></span>
<span><span class="va">b12</span> <span class="op">&lt;-</span> <span class="va">b1</span> <span class="op">-</span> <span class="va">t2</span> <span class="op">+</span> <span class="va">t1</span></span>
<span></span>
<span><span class="va">brks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000</span>, <span class="fl">50</span><span class="op">)</span></span>
<span><span class="co"># png("exp_apply_ts.png", width = 2400, height = 1000, pointsize = 24)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># 7.5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">plot.window</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">x</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">y</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">4.8</span>, <span class="fl">3.8</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b3</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">print_text</span><span class="op">(</span><span class="va">s</span>, <span class="fl">4.8</span>, <span class="fl">3.8</span>, m <span class="op">=</span> <span class="va">b3</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">3.6</span>, <span class="fl">2.6</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b11</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">print_text</span><span class="op">(</span><span class="va">s</span>, <span class="fl">3.6</span>, <span class="fl">2.6</span>, m <span class="op">=</span> <span class="va">b11</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">2.4</span>, <span class="fl">1.4</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b12</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">print_text</span><span class="op">(</span><span class="va">s</span>, <span class="fl">2.4</span>, <span class="fl">1.4</span>, m <span class="op">=</span> <span class="va">b12</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">1.2</span>, <span class="fl">.2</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b2</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">print_text</span><span class="op">(</span><span class="va">s</span>, <span class="fl">1.2</span>, <span class="fl">.2</span>, m <span class="op">=</span> <span class="va">b2</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b1</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">print_text</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, m <span class="op">=</span> <span class="va">b1</span><span class="op">)</span> <span class="co"># print text on left first stack</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">24.8</span>, <span class="fl">3.8</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">greys</span>, <span class="fl">0.1</span><span class="op">)</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"NA"</span>, <span class="fl">42</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">23.6</span>, <span class="fl">2.6</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="op">(</span><span class="va">b12</span> <span class="op">+</span> <span class="va">b11</span> <span class="op">+</span> <span class="va">b3</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">print_text</span><span class="op">(</span><span class="va">s</span>, <span class="fl">23.6</span>, <span class="fl">2.6</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="op">(</span><span class="va">b12</span> <span class="op">+</span> <span class="va">b11</span> <span class="op">+</span> <span class="va">b3</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">22.4</span>, <span class="fl">1.4</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="op">(</span><span class="va">b2</span> <span class="op">+</span> <span class="va">b12</span> <span class="op">+</span> <span class="va">b11</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">print_text</span><span class="op">(</span><span class="va">s</span>, <span class="fl">22.4</span>, <span class="fl">1.4</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="op">(</span><span class="va">b2</span> <span class="op">+</span> <span class="va">b12</span> <span class="op">+</span> <span class="va">b11</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21.2</span>, <span class="fl">.2</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="op">(</span><span class="va">b1</span> <span class="op">+</span> <span class="va">b2</span> <span class="op">+</span> <span class="va">b12</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">print_text</span><span class="op">(</span><span class="va">s</span>, <span class="fl">21.2</span>, <span class="fl">.2</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="op">(</span><span class="va">b1</span> <span class="op">+</span> <span class="va">b2</span> <span class="op">+</span> <span class="va">b12</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">20</span>, <span class="op">-</span><span class="fl">1</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="va">greys</span>, <span class="fl">0.1</span><span class="op">)</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"NA"</span>, <span class="fl">42</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">print_segments</span><span class="op">(</span><span class="fl">5.7</span>, <span class="fl">1.7</span>, seg <span class="op">=</span> <span class="va">time_arrow_seg</span>, col <span class="op">=</span> <span class="st">"forestgreen"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="fl">12.5</span>, <span class="fl">9</span>, <span class="fl">20</span>, <span class="fl">9</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">cex</span> <span class="op">&lt;-</span> <span class="fl">.9</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">16.3</span>, <span class="fl">8.3</span>, <span class="st">"apply_dimension(dimension = 't')"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu">print_segments</span><span class="op">(</span><span class="fl">9.7</span>, <span class="fl">1.7</span>, <span class="va">time_arrow_seg</span>, col <span class="op">=</span> <span class="st">"forestgreen"</span><span class="op">)</span> <span class="co"># draw ma explanation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span> <span class="fl">10</span>, <span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"496"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">.7</span> <span class="op">+</span> <span class="fl">10</span>, <span class="fl">.7</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"363"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">1.9</span> <span class="op">+</span> <span class="fl">10</span>, <span class="fl">1.9</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"658"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3.1</span> <span class="op">+</span> <span class="fl">10</span>, <span class="fl">3.1</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"230"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">4.3</span> <span class="op">+</span> <span class="fl">10</span>, <span class="fl">4.3</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"525"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="va">t_formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"t"</span><span class="op">[</span><span class="va">n</span><span class="op">]</span><span class="op">*</span><span class="st">" = (t"</span><span class="op">[</span><span class="va">n</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="st">" + t"</span><span class="op">[</span><span class="va">n</span><span class="op">]</span><span class="op">*</span><span class="st">" + t"</span><span class="op">[</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="st">") / 3"</span><span class="op">)</span></span>
<span><span class="co"># text(13.8, 3, t_formula, srt = 45, cex = 1.2)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">14.4</span>, <span class="fl">3.6</span>, <span class="st">"calculate moving average"</span>, srt <span class="op">=</span> <span class="fl">45</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">5.7</span>, <span class="fl">18</span>, <span class="fl">5.7</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">print_segments</span><span class="op">(</span><span class="fl">15.4</span>, <span class="fl">1.7</span>, seg <span class="op">=</span> <span class="va">time_arrow_seg</span>, col <span class="op">=</span> <span class="st">"forestgreen"</span><span class="op">)</span> <span class="co"># draw ma explanation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span> <span class="fl">15.7</span>, <span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"NA"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">.7</span> <span class="op">+</span> <span class="fl">15.7</span>, <span class="fl">.7</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"505"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">1.9</span> <span class="op">+</span> <span class="fl">15.7</span>, <span class="fl">1.9</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"417"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3.1</span> <span class="op">+</span> <span class="fl">15.7</span>, <span class="fl">3.1</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"471"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">4.3</span> <span class="op">+</span> <span class="fl">15.7</span>, <span class="fl">4.3</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"NA"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu">print_segments</span><span class="op">(</span><span class="fl">25.7</span>, <span class="fl">1.7</span>, seg <span class="op">=</span> <span class="va">time_arrow_seg</span>, col <span class="op">=</span> <span class="st">"forestgreen"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cube4apply1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cube4apply1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-Cubes_files/figure-html/fig-cube4apply1-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cube4apply1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.5: Low-pass filtering of time series
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># apply ----</span></span>
<span></span>
<span><span class="va">abs_brks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">500</span>,<span class="fl">500</span>, <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">abs_pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/hcl_palettes.html">sequential_hcl</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">20</span>, h1 <span class="op">=</span> <span class="fl">211</span>, c1 <span class="op">=</span> <span class="fl">80</span>, l1 <span class="op">=</span> <span class="fl">30</span>, l2 <span class="op">=</span> <span class="fl">100</span>, p1 <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vNeumann_seg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>, </span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">apply_filter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">pad</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">padValue</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ras</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/focal.html">focal</a></span><span class="op">(</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span>, w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.2</span>,<span class="fl">0</span>, <span class="fl">0.2</span>,<span class="fl">0.2</span>,<span class="fl">0.2</span>, <span class="fl">0</span>,<span class="fl">0.2</span>,<span class="fl">0</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, pad <span class="op">=</span> <span class="va">pad</span>, padValue <span class="op">=</span> <span class="va">padValue</span><span class="op">)</span></span>
<span>  <span class="va">ras</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span></span>
<span>  <span class="va">ras</span><span class="op">[</span><span class="va">ras</span> <span class="op">==</span> <span class="st">"NaN"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">999</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">brks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000</span>, <span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fl">7.5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">plot.window</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">x</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">y</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">3</span>, <span class="fl">2</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b3</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">1.5</span>, <span class="fl">.5</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b2</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b1</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">print_text</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, m <span class="op">=</span> <span class="va">b1</span><span class="op">)</span> <span class="co"># print text on left first stack</span></span>
<span><span class="fu">print_segments</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, seg <span class="op">=</span> <span class="va">vNeumann_seg</span>, lwd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">23</span>, <span class="fl">2</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="fu">apply_filter</span><span class="op">(</span><span class="va">b3</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21.5</span>, <span class="fl">0.5</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="fu">apply_filter</span><span class="op">(</span><span class="va">b2</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">20</span>, <span class="op">-</span><span class="fl">1</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="fu">apply_filter</span><span class="op">(</span><span class="va">b1</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="va">brks</span><span class="op">)</span></span>
<span><span class="fu">print_text</span><span class="op">(</span><span class="va">s</span>, <span class="fl">20</span>, <span class="op">-</span><span class="fl">1</span>, m <span class="op">=</span> <span class="fu">apply_filter</span><span class="op">(</span><span class="va">b1</span><span class="op">)</span><span class="op">)</span> <span class="co"># set pad = FALSE for -99</span></span>
<span><span class="fu">print_segments</span><span class="op">(</span><span class="fl">22</span>, <span class="fl">3</span>, seg <span class="op">=</span> <span class="va">vNeumann_seg</span>, lwd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="fl">11</span>, <span class="fl">4</span>, <span class="fl">17.5</span>, <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">14.3</span>, <span class="fl">3.5</span>, <span class="st">"apply_kernel()"</span>, cex <span class="op">=</span> <span class="fl">1.4</span><span class="op">)</span></span>
<span><span class="fu">print_segments</span><span class="op">(</span><span class="fl">13.8</span>, <span class="fl">1</span>, seg <span class="op">=</span> <span class="va">vNeumann_seg</span>, lwd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">cex</span> <span class="op">=</span> <span class="fl">.8</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">14.3</span>, <span class="fl">1.5</span>, <span class="st">"0.2"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">13.3</span>, <span class="fl">1.5</span>, <span class="st">"0.2"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">15.3</span>, <span class="fl">1.5</span>, <span class="st">"0.2"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">14.3</span>, <span class="fl">2.5</span>, <span class="st">"0.2"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">14.3</span>, <span class="fl">.5</span>, <span class="st">"0.2"</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cube4apply2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cube4apply2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-Cubes_files/figure-html/fig-cube4apply2-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cube4apply2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.6: Low pass filtering of spatial slices
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-reducedimension" class="level3"><h3 class="anchored" data-anchor-id="sec-reducedimension">Reducing dimensions</h3>
<p> </p>
<p>When applying function <code>mean</code> to an entire data cube, all dimensions vanish: the resulting “data cube” has dimensionality zero. We can also apply functions to a limited set of dimensions such that selected dimensions vanish, or are <em>reduced</em>. We already saw that filtering is a special case of this, but more in general we could for instance compute the maximum of every time series, the mean over every spatial slice, or a band index such as NDVI that summarises different spectral values into a single new “band” with the index value. <a href="#fig-cube4reduce" class="quarto-xref">Figure&nbsp;<span>6.7</span></a> illustrates these options.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># reduce ----</span></span>
<span></span>
<span><span class="co"># calc mean over time</span></span>
<span><span class="va">timeB</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">b1</span> <span class="op">+</span> <span class="va">b2</span> <span class="op">+</span> <span class="va">b3</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span></span>
<span><span class="va">timeG</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">g1</span> <span class="op">+</span> <span class="va">g2</span> <span class="op">+</span> <span class="va">g3</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span></span>
<span><span class="va">timeR</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">r1</span> <span class="op">+</span> <span class="va">r2</span> <span class="op">+</span> <span class="va">r3</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span></span>
<span><span class="va">timeN</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n1</span> <span class="op">+</span> <span class="va">n2</span> <span class="op">+</span> <span class="va">n3</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span></span>
<span></span>
<span><span class="va">print_grid_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span> <span class="co"># 3x1, 28x7</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">timeB</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="va">timeG</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="va">timeR</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="va">timeN</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># calc ndvi</span></span>
<span><span class="va">ndvi1</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n1</span> <span class="op">-</span> <span class="va">r1</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">n1</span> <span class="op">+</span> <span class="va">r1</span><span class="op">)</span></span>
<span><span class="va">ndvi2</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n2</span> <span class="op">-</span> <span class="va">r2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">n2</span> <span class="op">+</span> <span class="va">r2</span><span class="op">)</span></span>
<span><span class="va">ndvi3</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n3</span> <span class="op">-</span> <span class="va">r3</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">n3</span> <span class="op">+</span> <span class="va">r3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">print_grid_bands</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">pal</span> <span class="op">=</span> <span class="va">greys</span><span class="op">)</span> <span class="op">{</span> <span class="co"># 1x3 6x27</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">pal</span>, m <span class="op">=</span> <span class="va">ndvi1</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">pal</span>, m <span class="op">=</span> <span class="va">ndvi2</span><span class="op">)</span></span>
<span>  <span class="fu">pl</span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">pal</span>, m <span class="op">=</span> <span class="va">ndvi3</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">plte</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">add</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">randomize</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">pal</span>, <span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">x</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="co"># m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span>  <span class="co"># dim(m) = c(x = nrow, y = ncol) # named dim</span></span>
<span>  <span class="co"># s[[1]] = m</span></span>
<span>  <span class="co"># me &lt;- floor(mean(s[[1]]))</span></span>
<span>  <span class="va">me</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">me</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">100</span><span class="op">)</span> <span class="op">{</span> <span class="co"># in case non-artificial grids with very high</span></span>
<span>    <span class="va">me</span> <span class="op">&lt;-</span> <span class="va">m</span> <span class="op">/</span> <span class="fl">10</span>     <span class="co"># numbers are used, make them smaller</span></span>
<span>    <span class="va">me</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">me</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,<span class="va">me</span>,cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">print_grid_spat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">=</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span></span>
<span>  <span class="va">y</span> <span class="op">=</span> <span class="va">y</span> <span class="op">+</span> <span class="fl">3.5</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b1</span><span class="op">)</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b2</span><span class="op">)</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">blues</span>, m <span class="op">=</span> <span class="va">b3</span><span class="op">)</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="va">g1</span><span class="op">)</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="va">g2</span><span class="op">)</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">7</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">greens</span>, m <span class="op">=</span> <span class="va">g3</span><span class="op">)</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="va">r1</span><span class="op">)</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="va">r2</span><span class="op">)</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">14</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">reds</span>, m <span class="op">=</span> <span class="va">r3</span><span class="op">)</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">0</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="va">n1</span><span class="op">)</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">10</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="va">n2</span><span class="op">)</span></span>
<span>  <span class="fu">plte</span><span class="op">(</span><span class="va">s</span>, <span class="fl">21</span><span class="op">+</span><span class="va">x</span>, <span class="fl">20</span><span class="op">+</span><span class="va">y</span>, pal <span class="op">=</span> <span class="va">purples</span>, m <span class="op">=</span> <span class="va">n3</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># png("exp_reduce.png", width = 1200, height = 1000, pointsize = 32)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#par(mar = c(3,3,3,3))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">0</span>,<span class="fl">2</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fl">120</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">plot.window</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">x</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">y</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">print_grid</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">-</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span>,<span class="va">y</span><span class="op">-</span><span class="fl">27</span><span class="op">)</span></span>
<span><span class="co"># print_alpha_grid((x/3-28)/2, 0) # alpha grid</span></span>
<span><span class="fu">print_grid_time</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">-</span><span class="fl">28</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># off = 5.5</span></span>
<span><span class="co"># print_alpha_grid(x/3+((x/3-6)/2) -10.5, 0) # alpha grid</span></span>
<span><span class="fu">print_grid_bands</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">-</span><span class="fl">6</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu">print_alpha_grid</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">-</span><span class="fl">28</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0</span>, alp <span class="op">=</span> <span class="fl">0</span>, geom <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># alpha grid</span></span>
<span><span class="fu">print_grid_spat</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">3</span><span class="op">-</span><span class="fl">28</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">13.5</span>, <span class="st">"time"</span>, srt <span class="op">=</span> <span class="fl">90</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="co">#segments(3.6, 8, 3.7, 19, col = "red", lwd=3)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fl">3.4</span>, <span class="fl">8</span>, <span class="fl">3.4</span>, <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">43</span>, <span class="fl">13.5</span>, <span class="st">"time"</span>, srt <span class="op">=</span> <span class="fl">90</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">83</span>, <span class="fl">13.5</span>, <span class="st">"time"</span>, srt <span class="op">=</span> <span class="fl">90</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">30</span>, <span class="st">"bands"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">60</span>, <span class="fl">30</span>, <span class="st">"bands"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fl">53</span>,<span class="fl">29.8</span>, <span class="fl">67</span>,<span class="fl">29.8</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">30</span>, <span class="st">"bands"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">7</span>, <span class="st">"x"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">36</span>, <span class="fl">13</span>, <span class="st">"y"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">60</span>, <span class="op">-</span><span class="fl">3</span>, <span class="st">"x"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">66</span>, <span class="fl">3</span>, <span class="st">"y"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">110</span>, <span class="op">-</span><span class="fl">3</span>, <span class="st">"x"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">116</span>, <span class="fl">3</span>, <span class="st">"y"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fl">108</span>,<span class="op">-</span><span class="fl">2.4</span>, <span class="fl">112</span>,<span class="op">-</span><span class="fl">3.2</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fl">114</span>,<span class="fl">3.2</span>, <span class="fl">118</span>,<span class="fl">2.4</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">60</span>, <span class="va">y</span><span class="op">+</span><span class="fl">4</span>, <span class="st">"bands"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="co"># dim names on main</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">43</span>, <span class="va">y</span><span class="op">-</span><span class="fl">14</span>, <span class="st">"time"</span>, srt <span class="op">=</span> <span class="fl">90</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">-</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">24</span>, <span class="va">y</span><span class="op">-</span><span class="fl">30</span>, <span class="st">"x"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">-</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">30</span>, <span class="va">y</span><span class="op">-</span><span class="fl">24</span>, <span class="st">"y"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">-</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span>,<span class="va">y</span><span class="op">-</span><span class="fl">30</span>, <span class="va">x</span><span class="op">/</span><span class="fl">6</span>,<span class="fl">32</span>, angle <span class="op">=</span> <span class="fl">20</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span>,<span class="va">y</span><span class="op">-</span><span class="fl">30</span>, <span class="va">x</span><span class="op">/</span><span class="fl">2</span>,<span class="fl">32</span>, angle <span class="op">=</span> <span class="fl">20</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">28</span><span class="op">/</span><span class="fl">2</span>,<span class="va">y</span><span class="op">-</span><span class="fl">30</span>, <span class="fl">100</span>, <span class="fl">32</span>, angle <span class="op">=</span> <span class="fl">20</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co"># points(seq(1,120,10), seq(1,120,10))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">28.5</span>,<span class="fl">49</span>, <span class="st">"reduce temporally"</span>, srt <span class="op">=</span> <span class="fl">55.5</span>, col <span class="op">=</span> <span class="st">"black"</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">57</span>,<span class="fl">49</span>, <span class="st">"reduce bands"</span>, srt <span class="op">=</span> <span class="fl">90</span>, col <span class="op">=</span> <span class="st">"black"</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">91.5</span>,<span class="fl">49</span>, <span class="st">"reduce spatially"</span>, srt <span class="op">=</span> <span class="op">-</span><span class="fl">55.5</span>, col <span class="op">=</span> <span class="st">"black"</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cube4reduce" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cube4reduce-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-Cubes_files/figure-html/fig-cube4reduce-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cube4reduce-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.7: Reducing data cube dimensions
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="sec-vectordatacubes" class="level2" data-number="6.4"><h2 data-number="6.4" class="anchored" data-anchor-id="sec-vectordatacubes">
<span class="header-section-number">6.4</span> Aggregating raster to vector cubes</h2>
<p> </p>
<p><a href="#fig-cube4agg" class="quarto-xref">Figure&nbsp;<span>6.8</span></a> illustrates how a four-dimensional raster data cube can be aggregated to a three-dimensional <em>vector data cube</em>. Pixels in the raster are grouped by spatial intersection with a set of vector geometries, and each group is then reduced to a single value by an aggregation function such as <code>mean</code> or <code>max</code>. In the example, the <em>two</em> spatial dimensions <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> reduce to a single dimension, the one-dimensional sequence of feature geometries, with geometries that are defined in the space of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>. Grouping geometries can also be <code>POINT</code> geometries, in which case the aggregation function is obsolete as single values at the <code>POINT</code> locations are <em>extracted</em> by querying a pixel value or by interpolating from the nearest pixels.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># aggregate ----</span></span>
<span></span>
<span><span class="va">mask_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>                 <span class="cn">NA</span>, <span class="fl">1</span>, <span class="fl">1</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>                  <span class="fl">1</span>, <span class="fl">1</span>,<span class="cn">NA</span>,<span class="cn">NA</span>, <span class="fl">1</span>,<span class="cn">NA</span>,</span>
<span>                  <span class="fl">1</span>,<span class="cn">NA</span>,<span class="cn">NA</span>, <span class="fl">1</span>, <span class="fl">1</span>,<span class="cn">NA</span>,</span>
<span>                  <span class="fl">1</span>,<span class="cn">NA</span>,<span class="cn">NA</span>, <span class="fl">1</span>, <span class="fl">1</span>,<span class="cn">NA</span>,</span>
<span>                  <span class="fl">1</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>, <span class="fl">1</span>,<span class="cn">NA</span>,</span>
<span>                 <span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pl_stack_agg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">add</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">nrM</span>, <span class="va">imgY</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">inner</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># pl_stack that masks the added matrices</span></span>
<span>  <span class="co"># nrM is the timestep {1, 2, 3}, cause this function</span></span>
<span>  <span class="co"># prints all 4 bands at once</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">x</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="co"># m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"n"</span>, <span class="va">nrM</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">m</span><span class="op">[</span><span class="va">mask_agg</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span>  <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">m</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">imgY</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="co"># turn around to have same orientation as flat plot</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span>, <span class="cn">TRUE</span>,  pal <span class="op">=</span> <span class="va">purples</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"r"</span>, <span class="va">nrM</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">m</span><span class="op">[</span><span class="va">mask_agg</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span>  <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">m</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">imgY</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">1</span><span class="op">*</span><span class="va">inner</span>, <span class="cn">TRUE</span>,  pal <span class="op">=</span> <span class="va">reds</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"g"</span>, <span class="va">nrM</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">m</span><span class="op">[</span><span class="va">mask_agg</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span>  <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">m</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">imgY</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">2</span><span class="op">*</span><span class="va">inner</span>, <span class="cn">TRUE</span>,  pal <span class="op">=</span> <span class="va">greens</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="va">nrM</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">m</span><span class="op">[</span><span class="va">mask_agg</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span>  <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">m</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">imgY</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">3</span><span class="op">*</span><span class="va">inner</span>, <span class="cn">TRUE</span>, pal <span class="op">=</span> <span class="va">blues</span><span class="op">)</span> <span class="co"># li FALSE</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">polygon_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">5.1</span>, <span class="fl">4.9</span>,<span class="op">-</span><span class="fl">2.3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">2.4</span>, <span class="fl">3.1</span>, <span class="fl">1.8</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5.1</span>, <span class="fl">4.9</span>,<span class="op">-</span><span class="fl">2.3</span>, <span class="fl">0.0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.4</span>, <span class="fl">3.1</span>, <span class="fl">1.8</span>, <span class="fl">0.0</span><span class="op">)</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">make_dummy_stars</span><span class="op">(</span><span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">5</span>, <span class="op">-</span><span class="fl">1.14</span>, <span class="op">-</span><span class="fl">2.28</span><span class="op">)</span></span>
<span></span>
<span><span class="va">print_vector_content</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">cex</span> <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">250</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">x</span>,<span class="fl">12</span> <span class="op">+</span> <span class="va">y</span>, <span class="va">vec</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">x</span>, <span class="fl">8</span> <span class="op">+</span> <span class="va">y</span>, <span class="va">vec</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">x</span>, <span class="fl">4</span> <span class="op">+</span> <span class="va">y</span>, <span class="va">vec</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">x</span>, <span class="fl">0</span> <span class="op">+</span> <span class="va">y</span>, <span class="va">vec</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">12</span> <span class="op">+</span> <span class="va">x</span>,<span class="fl">12</span> <span class="op">+</span> <span class="va">y</span>, <span class="va">vec</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">12</span> <span class="op">+</span> <span class="va">x</span>, <span class="fl">8</span> <span class="op">+</span> <span class="va">y</span>, <span class="va">vec</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">12</span> <span class="op">+</span> <span class="va">x</span>, <span class="fl">4</span> <span class="op">+</span> <span class="va">y</span>, <span class="va">vec</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">12</span> <span class="op">+</span> <span class="va">x</span>, <span class="fl">0</span> <span class="op">+</span> <span class="va">y</span>, <span class="va">vec</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span>, cex <span class="op">=</span> <span class="va">cex</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">print_ts</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">off2</span>, <span class="va">yoff2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">pl_stack</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span> <span class="op">+</span> <span class="va">off2</span>, <span class="va">yoff2</span>, nrM <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="co"># input 2</span></span>
<span>  <span class="fu">pl_stack</span><span class="op">(</span><span class="va">s</span>, <span class="va">off</span> <span class="op">+</span> <span class="va">off2</span>, <span class="va">yoff2</span>, nrM <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu">pl_stack</span><span class="op">(</span><span class="va">s</span>, <span class="fl">2</span> <span class="op">*</span> <span class="va">off</span> <span class="op">+</span> <span class="va">off2</span>, <span class="va">yoff2</span>, nrM <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="op">-</span><span class="fl">13</span> <span class="op">+</span> <span class="va">off2</span>, <span class="fl">14</span> <span class="op">+</span> <span class="va">yoff2</span>, <span class="fl">72</span> <span class="op">+</span> <span class="va">off2</span>, <span class="fl">14</span> <span class="op">+</span> <span class="va">yoff2</span>, angle <span class="op">=</span> <span class="fl">20</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>  <span class="co"># timeline</span></span>
<span>  <span class="va">heads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.5</span><span class="op">+</span><span class="va">off2</span>, <span class="fl">3.5</span> <span class="op">+</span> <span class="va">off</span> <span class="op">+</span> <span class="va">off2</span>, <span class="fl">3.5</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">off</span> <span class="op">+</span> <span class="va">off2</span>, <span class="fl">14</span><span class="op">+</span><span class="va">yoff2</span>,<span class="fl">14</span><span class="op">+</span><span class="va">yoff2</span>,<span class="fl">14</span><span class="op">+</span><span class="va">yoff2</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">heads</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span> <span class="co"># 4 or 16</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">8</span>, <span class="fl">7</span>, <span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span><span class="op">+</span><span class="va">off2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span><span class="op">+</span><span class="va">yoff2</span>, <span class="fl">3.5</span><span class="op">+</span><span class="va">off2</span>, <span class="fl">14</span><span class="op">+</span><span class="va">yoff2</span><span class="op">)</span> <span class="co"># first stack pyramid</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">8</span>, <span class="fl">7</span>, <span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span> <span class="op">+</span> <span class="va">off</span> <span class="op">+</span> <span class="va">off2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span><span class="op">+</span><span class="va">yoff2</span>, <span class="fl">3.5</span> <span class="op">+</span> <span class="va">off</span> <span class="op">+</span> <span class="va">off2</span>, <span class="fl">14</span><span class="op">+</span><span class="va">yoff2</span><span class="op">)</span> <span class="co"># second stack pyramid</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">8</span>, <span class="fl">7</span>, <span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">off</span> <span class="op">+</span> <span class="va">off2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span><span class="op">+</span><span class="va">yoff2</span>, <span class="fl">3.5</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">off</span> <span class="op">+</span> <span class="va">off2</span>, <span class="fl">14</span><span class="op">+</span><span class="va">yoff2</span><span class="op">)</span> <span class="co"># third stack pyramid</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">7.5</span><span class="op">+</span><span class="va">off2</span>, <span class="fl">4.3</span><span class="op">+</span><span class="va">yoff2</span>, <span class="st">"x"</span>, col <span class="op">=</span> <span class="st">"black"</span>, cex <span class="op">=</span> <span class="va">secText</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="op">-</span><span class="fl">9.5</span><span class="op">+</span><span class="va">off2</span>, <span class="op">-</span><span class="fl">2.5</span><span class="op">+</span><span class="va">yoff2</span>, <span class="st">"bands"</span>, srt <span class="op">=</span> <span class="fl">90</span>, col <span class="op">=</span> <span class="st">"black"</span>, cex <span class="op">=</span> <span class="va">secText</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4.5</span><span class="op">+</span><span class="va">off2</span>, <span class="fl">2</span><span class="op">+</span><span class="va">yoff2</span>, <span class="st">"y"</span>, srt <span class="op">=</span> <span class="fl">27.5</span>, col <span class="op">=</span> <span class="st">"black"</span>, cex <span class="op">=</span> <span class="va">secText</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">69</span><span class="op">+</span><span class="va">off2</span>, <span class="fl">15.5</span><span class="op">+</span><span class="va">yoff2</span><span class="op">+</span><span class="fl">1</span>, <span class="st">"time"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3.5</span><span class="op">+</span><span class="va">off2</span>, <span class="fl">15.5</span><span class="op">+</span><span class="va">yoff2</span>, <span class="st">"2020-10-01"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3.5</span> <span class="op">+</span> <span class="va">off</span> <span class="op">+</span> <span class="va">off2</span>, <span class="fl">15.5</span><span class="op">+</span><span class="va">yoff2</span>, <span class="st">"2020-10-13"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">3.5</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">off</span> <span class="op">+</span> <span class="va">off2</span>, <span class="fl">15.5</span><span class="op">+</span><span class="va">yoff2</span>, <span class="st">"2020-10-25"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">secText</span> <span class="op">&lt;-</span> <span class="fl">0.8</span> <span class="co"># secondary text size (dimension naming)</span></span>
<span><span class="va">off</span> <span class="op">&lt;-</span> <span class="fl">26</span> <span class="co"># image stacks are always 26 apart</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">72</span> <span class="co"># png X</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">48</span> <span class="co"># png Y</span></span>
<span><span class="va">yoff</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">plot.window</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="va">x</span><span class="op">+</span><span class="fl">4</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="va">y</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">print_ts</span><span class="op">(</span><span class="fl">5</span>, <span class="va">yoff</span><span class="op">)</span></span>
<span><span class="va">col</span> <span class="op">&lt;-</span> <span class="st">'#ff5555'</span></span>
<span><span class="fu">print_segments</span><span class="op">(</span><span class="fl">10.57</span>, <span class="va">yoff</span><span class="op">-</span><span class="fl">.43</span>, seg <span class="op">=</span> <span class="va">polygon_1</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1.3</span><span class="op">)</span><span class="op">+</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.2</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">+</span><span class="va">yoff</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">1.3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">+</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="va">yoff</span>, lwd <span class="op">=</span> <span class="fl">4</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="fu">print_segments</span><span class="op">(</span><span class="fl">10.57</span><span class="op">+</span><span class="va">off</span>, <span class="va">yoff</span><span class="op">-</span><span class="fl">.43</span>, seg <span class="op">=</span> <span class="va">polygon_1</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fl">3</span> <span class="op">+</span> <span class="va">off</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1.3</span><span class="op">)</span><span class="op">+</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.2</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">+</span><span class="va">yoff</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">1.3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">+</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="va">yoff</span>, lwd <span class="op">=</span> <span class="fl">4</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="fu">print_segments</span><span class="op">(</span><span class="fl">10.57</span><span class="op">+</span><span class="fl">2</span><span class="op">*</span><span class="va">off</span>, <span class="va">yoff</span><span class="op">-</span><span class="fl">.43</span>, seg <span class="op">=</span> <span class="va">polygon_1</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fl">3</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">off</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1.3</span><span class="op">)</span><span class="op">+</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.2</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">+</span><span class="va">yoff</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">1.3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">+</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="va">yoff</span>, lwd <span class="op">=</span> <span class="fl">4</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="co"># old 75 28 poly 86.25, 27.15</span></span>
<span><span class="fu">pl_stack_agg</span><span class="op">(</span><span class="va">a</span>, <span class="fl">5</span>, <span class="fl">5</span>, nrM <span class="op">=</span> <span class="fl">1</span>, inner <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="co"># print masked enlargement</span></span>
<span><span class="fu">print_segments</span><span class="op">(</span><span class="fl">16.25</span>, <span class="fl">7.15</span>, seg <span class="op">=</span> <span class="va">polygon_1</span>, by <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">2.6</span><span class="op">)</span><span class="op">+</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.4</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="va">y</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">2.6</span>, <span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">+</span><span class="va">y</span>, lwd <span class="op">=</span> <span class="fl">4</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span> <span class="co"># line in large</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">25</span>, <span class="op">-</span><span class="fl">7</span>, <span class="fl">9</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">'grey'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fl">21</span>, <span class="fl">29</span>, <span class="fl">27.5</span>, <span class="fl">14</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">'grey'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="st">"1. Group by geometry"</span>, cex <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span></span>
<span><span class="va">vecM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">8</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">57</span>, <span class="fl">21</span>, <span class="st">"2. Reduce to vector cube"</span>, cex <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">make_dummy_stars</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">12</span>, <span class="fl">4</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">b</span>, <span class="fl">48</span>, <span class="op">-</span><span class="fl">5</span>, m <span class="op">=</span> <span class="va">vecM</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="fl">0.9</span><span class="op">)</span>, border <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu">print_vector_content</span><span class="op">(</span><span class="fl">54</span>, <span class="op">-</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">b</span>, <span class="fl">46.5</span>, <span class="op">-</span><span class="fl">3.5</span>, m <span class="op">=</span> <span class="va">vecM</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="fl">0.9</span><span class="op">)</span>, border <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu">print_vector_content</span><span class="op">(</span><span class="fl">52.5</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">b</span>, <span class="fl">45</span>, <span class="op">-</span><span class="fl">2</span>, m <span class="op">=</span> <span class="va">vecM</span>, pal <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="fl">0.9</span><span class="op">)</span>, border <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu">print_vector_content</span><span class="op">(</span><span class="fl">51</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">51.5</span>, <span class="fl">15</span>, <span class="st">"Line_1"</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">63</span>, <span class="fl">15</span>, <span class="st">"Polygon_1"</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">57</span>, <span class="fl">17.5</span>, <span class="st">"Geometries"</span>, cex <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">42</span>, <span class="fl">12</span>, <span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">42</span>,  <span class="fl">8</span>, <span class="st">"green"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">42</span>,  <span class="fl">4</span>, <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">42</span>,  <span class="fl">0</span>, <span class="st">"nir"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">38</span>, <span class="fl">6</span>, <span class="st">"Bands"</span>, srt <span class="op">=</span> <span class="fl">90</span>, cex <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span></span>
<span><span class="co"># arrows(13.5, -2, 13.5, -6, angle = 20, lwd = 3)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">72</span>, <span class="fl">15.5</span>, <span class="st">"time"</span>, srt <span class="op">=</span> <span class="fl">315</span>, cex <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="fl">69.5</span>, <span class="fl">15</span>, <span class="fl">72.5</span>, <span class="fl">12</span>, angle <span class="op">=</span> <span class="fl">20</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co"># print_segments(30, 35, seg = arrow_seg)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cube4agg" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cube4agg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-Cubes_files/figure-html/fig-cube4agg-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cube4agg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.8: Aggregating a raster data cube to a vector data cube
</figcaption></figure>
</div>
</div>
</div>
<p>Further examples of vector data cubes include air quality data, where we could have <span class="math inline">\(PM_{10}\)</span> measurements over two dimensions, as a sequence of</p>
<ul>
<li>monitoring stations, and</li>
<li>time intervals</li>
</ul>
<p>or where we consider time series of demographic or epidemiological data, consisting of (population, disease) counts, with number of persons by</p>
<ul>
<li>region, for a sequence of <span class="math inline">\(n\)</span> regions</li>
<li>age class, for <span class="math inline">\(m\)</span> age classes, and</li>
<li>year, for <span class="math inline">\(p\)</span> years</li>
</ul>
<p>which forms an array with <span class="math inline">\(n m p\)</span> elements.</p>
<p>For spatial data science, handling vector and raster data cubes is extremely useful, because many variables are both spatially and temporaly varying, and because we often want to either change dimensions or aggregate them out, but in a fully flexible manner and order. Examples of changing dimensions are:</p>
<ul>
<li>interpolating air quality measurements to values on a regular grid (raster; <a href="12-Interpolation.html" class="quarto-xref"><span>Chapter 12</span></a>)</li>
<li>estimating density maps from points or lines, for instance estimating the number of flights passing by per week within a range of 1 km (<a href="11-PointPattern.html" class="quarto-xref"><span>Chapter 11</span></a>)</li>
<li>aggregating climate model predictions to summary indicators for administrative regions</li>
<li>combining Earth observation data from different sensors, such as MODIS (250~m pixels, every 16 days) with Sentinel-2 (10~m pixels, every 5 days)</li>
</ul>
<p>Examples of aggregating one or more full dimensions are assessments of:</p>
<ul>
<li>which air quality monitoring stations indicate unhealthy conditions (time)</li>
<li>which region has the highest increase in disease incidence (space, time)</li>
<li>global warming (global change in degrees Celcius per decade)</li>
</ul></section><section id="sec-switching" class="level2" data-number="6.5"><h2 data-number="6.5" class="anchored" data-anchor-id="sec-switching">
<span class="header-section-number">6.5</span> Switching dimension with attributes</h2>
<p> </p>
<p>When we accept that a dimension can also reflect an unordered, categorical variable, then one can easily swap a set of attributes for a single dimension, by replacing</p>
<p><span class="math display">\[\{Z_1,Z_2,...,Z_p\} = f(D_1,D_2,...,D_n)\]</span></p>
<p>with</p>
<p><span class="math display">\[Z = f(D_1,D_2,...,D_n, D_{n+1})\]</span></p>
<p>where <span class="math inline">\(D_{n+1}\)</span> has cardinality <span class="math inline">\(p\)</span> and has as labels (the names of) <span class="math inline">\(Z_1,Z_2,...,Z_p\)</span>. <a href="#fig-aqdc" class="quarto-xref">Figure&nbsp;<span>6.9</span></a> shows a vector data cube for air quality stations where one cube dimension reflects air quality parameters. When the <span class="math inline">\(Z_i\)</span> have incompatible measurement units, as in <a href="#fig-aqdc" class="quarto-xref">Figure&nbsp;<span>6.9</span></a>, one would have to take care when reducing the “parameter” dimension <span class="math inline">\(D_{n+1}\)</span>: numeric functions like <code>mean</code> or <code>max</code> would be meaningless. Counting the number of variables that exceed their respective threshold values may however be meaningful.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1331</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://colorspace.R-Forge.R-project.org/">colorspace</a></span><span class="op">)</span></span>
<span><span class="va">tif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nrow</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">ncol</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="co">#m = matrix(runif(nrow * ncol), nrow = nrow, ncol = ncol)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">nrow</span>,<span class="fl">1</span><span class="op">:</span><span class="va">ncol</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">nrow</span>, y <span class="op">=</span> <span class="va">ncol</span><span class="op">)</span> <span class="co"># named dim</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="co"># s</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">delta</span> <span class="op">=</span> <span class="fl">3</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">delta</span> <span class="op">=</span> <span class="op">-</span><span class="fl">.5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span>, <span class="st">"raster"</span><span class="op">)</span><span class="op">$</span><span class="va">affine</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.2</span>, <span class="fl">0.0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">yoffset</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">add</span>, <span class="va">li</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">+</span> <span class="va">yoffset</span> </span>
<span>    <span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">x</span>, as_points <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">pal</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">sf.colors</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">li</span><span class="op">)</span></span>
<span>        <span class="va">pal</span> <span class="op">=</span> <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/lighten.html">lighten</a></span><span class="op">(</span><span class="va">pal</span>, <span class="fl">0.3</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span> <span class="va">add</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">l</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="st">"equal"</span>, pal <span class="op">=</span> <span class="va">pal</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="fl">.75</span><span class="op">)</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span>, main <span class="op">=</span> <span class="cn">NULL</span>, xlab <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span></span>
<span>    <span class="kw">else</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">l</span>, axes <span class="op">=</span> <span class="cn">TRUE</span>, breaks <span class="op">=</span> <span class="st">"equal"</span>, pal <span class="op">=</span> <span class="va">pal</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="fl">.75</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">u</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">pl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">add</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">randomize</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">x</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dimensions"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">offset</span> <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="va">m</span> <span class="op">=</span> <span class="va">r</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">y</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">nrow</span>,<span class="va">x</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">ncol</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">randomize</span><span class="op">)</span></span>
<span>    <span class="va">m</span> <span class="op">=</span> <span class="va">m</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">y</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">nrow</span><span class="op">)</span>,<span class="va">x</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">ncol</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">nrow</span>, y <span class="op">=</span> <span class="va">ncol</span><span class="op">)</span> <span class="co"># named dim</span></span>
<span>  <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">m</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span>, <span class="va">add</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">1</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">2</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">3</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">4</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">5</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">6</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">7</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">plt</span><span class="op">(</span><span class="va">s</span>, <span class="fl">8</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># point vector data cube:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">plot.window</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">16</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>,<span class="fl">12</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/spacetime">spacetime</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">air</span><span class="op">)</span></span>
<span><span class="va">de</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_normalize.html">st_normalize</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">DE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="fu">pl</span><span class="op">(</span><span class="va">s</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="cn">TRUE</span>, randomize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">de</span> <span class="op">=</span> <span class="va">de</span> <span class="op">*</span> <span class="fl">6</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">7</span>, <span class="fl">9</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">de</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="fl">.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">0</span>, <span class="st">"time"</span>, srt <span class="op">=</span> <span class="op">-</span><span class="fl">90</span>, col <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>,  <span class="fl">7.5</span>, <span class="st">"sensor location"</span>, srt <span class="op">=</span> <span class="fl">25</span>, col <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">7</span>,  <span class="fl">10.5</span>, <span class="st">"air quality parameter"</span>, srt <span class="op">=</span> <span class="fl">0</span>, col <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">1.5</span>,  <span class="fl">8.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">PM</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'black'</span>, cex <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">4.5</span>,  <span class="fl">8.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">NO</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'black'</span>, cex <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">8</span>,  <span class="fl">8.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">SO</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'black'</span>, cex <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">11</span>,  <span class="fl">8.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">O</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'black'</span>, cex <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span> <span class="fl">14</span>,  <span class="fl">8.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">CO</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'black'</span>, cex <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span></span>
<span><span class="co"># location points:</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">s</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fl">1.4</span></span>
<span><span class="va">p</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">8.2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">p</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="fl">.7</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span><span class="co"># centroids:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">131</span><span class="op">)</span></span>
<span><span class="va">cent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html">st_sample</a></span><span class="op">(</span><span class="va">de</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">cent</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="fl">.7</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span><span class="va">cent</span> <span class="op">&lt;-</span> <span class="va">cent</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">cent</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">seg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">cent</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="va">seg</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">seg</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">seg</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, <span class="va">seg</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'grey'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-aqdc" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-aqdc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-Cubes_files/figure-html/fig-aqdc-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-aqdc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.9: Vector data cube with air quality time series
</figcaption></figure>
</div>
</div>
</div>
<p>Being able to swap dimensions to attributes flexibly and vice versa leads to highly flexible analysis possibilities <span class="citation" data-cites="brown2010overview">(<a href="references.html#ref-brown2010overview" role="doc-biblioref">Brown 2010</a>)</span>.</p>
</section><section id="sec-otherdynamic" class="level2" data-number="6.6"><h2 data-number="6.6" class="anchored" data-anchor-id="sec-otherdynamic">
<span class="header-section-number">6.6</span> Other dynamic spatial data</h2>
<p> </p>
<p>We have seen several dynamic raster and vector data examples that match the data cube structure well. Other data examples do less so: in particular spatiotemporal point patterns (<a href="11-PointPattern.html" class="quarto-xref"><span>Chapter 11</span></a>) and trajectories [movement data; for a recent review, see <span class="citation" data-cites="https://doi.org/10.1111/1365-2656.13116">Joo et al. (<a href="references.html#ref-https://doi.org/10.1111/1365-2656.13116" role="doc-biblioref">2020</a>)</span>] are often more straightforward to not handle as a data cube. Spatiotemporal point patterns are the sets of spatiotemporal coordinates of events or objects: accidents, disease cases, traffic jams, lightning strikes, and so on. Trajectory data are time sequences of spatial locations of moving objects (persons, cars, satellites, animals). For such data, the primary information is in the coordinates, and shifting these to a limited set of regularly discretised grid cells covering the space may help some analysis, for instance to quickly explore patterns in areas of higher densities, but the loss of the exact coordinates also hinders a number of analysis approaches involving distance, direction, or speed calculations. Nevertheless, for such data often the first computational steps involves generation of data cube representations by aggregating to a time-fixed spatial and/or space-fixed temporal discretisation.</p>
<p>Using sparse array representations of data cubes to represent point pattern or trajectory data, which is possible for instance with SciDB <span class="citation" data-cites="brown2010overview">(<a href="references.html#ref-brown2010overview" role="doc-biblioref">Brown 2010</a>)</span> or TileDB <span class="citation" data-cites="tiledb">(<a href="references.html#ref-tiledb" role="doc-biblioref">Papadopoulos et al. 2016</a>)</span>, may strongly limit the loss of coordinate accuracy by choosing dimensions that represent an extremely dense grid, and storing only those grid cells that contain data points. For trajectory data, such representations would need to add a grouping dimension to identify individuals, or individual sequences of consecutive movement observations.</p>
</section><section id="exercises" class="level2" data-number="6.7"><h2 data-number="6.7" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">6.7</span> Exercises</h2>
<p>Use words to solve the following exercises. If needed or relevant use R code to illustrate the argument(s).</p>
<ol type="1">
<li><p>Why is it difficult to represent trajectories, sequences of <span class="math inline">\((x,y,t)\)</span> obtained by tracking moving objects, by data cubes as described in this chapter?</p></li>
<li><p>In a socio-economic vector data cube with variables population, life expectancy, and gross domestic product ordered by dimensions country and year, which variables have block support for the spatial dimension, and which have block support for the temporal dimension?</p></li>
<li><p>The Sentinel-2 satellites collect images in 12 spectral bands; list advantages and disadvantages to represent them as (i) different data cubes, (ii) a data cube with 12 attributes, one for each band, and (iii) a single attribute data cube with a spectral dimension.</p></li>
<li><p>Explain why a curvilinear raster as shown in <a href="01-hello.html#fig-rastertypes01" class="quarto-xref">Figure&nbsp;<span>1.6</span></a> can be considered a special case of a data cube.</p></li>
<li>
<p>Explain how the following problems can be solved with data cube operations <code>filter</code>, <code>apply</code>, <code>reduce</code> and/or <code>aggregate</code>, and in which order. Also mention for each which function is applied, and what the dimensionality of the resulting data cube is (if any):</p>
<ul>
<li>from hourly <span class="math inline">\(PM_{10}\)</span> measurements for a set of air quality monitoring stations, compute per station the amount of days per year that the average daily <span class="math inline">\(PM_{10}\)</span> value exceeds 50 <span class="math inline">\(\mu g/m^3\)</span>
</li>
<li>for a sequence of aerial images of an oil spill, find the time at which the oil spill had its largest extent, and the corresponding extent</li>
<li>from a 10-year period with global daily sea surface temperature (SST) raster maps, find the area with the 10% largest and 10% smallest temporal trends in SST values.</li>
</ul>
</li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-appel2019demand" class="csl-entry" role="listitem">
Appel, Marius, and Edzer Pebesma. 2019. <span>“On-Demand Processing of Data Cubes from Satellite Image Collections with the Gdalcubes Library.”</span> <em>Data</em> 4 (3): 92. <a href="https://www.mdpi.com/2306-5729/4/3/92">https://www.mdpi.com/2306-5729/4/3/92</a>.
</div>
<div id="ref-brown2010overview" class="csl-entry" role="listitem">
Brown, P. G. 2010. <span>“Overview of <span>SciDB</span>: Large Scale Array Storage, Processing and Analysis.”</span> In <em>Proceedings of the 2010 <span>ACM</span> <span>SIGMOD</span> International Conference on Management of Data</em>, 963–68. ACM.
</div>
<div id="ref-galton" class="csl-entry" role="listitem">
Galton, A. 2004. <span>“Fields and Objects in Space, Time and Space-Time.”</span> <em>Spatial Cognition and Computation</em> 4.
</div>
<div id="ref-https://doi.org/10.1111/1365-2656.13116" class="csl-entry" role="listitem">
Joo, Rocío, Matthew E. Boone, Thomas A. Clay, Samantha C. Patrick, Susana Clusella-Trullas, and Mathieu Basille. 2020. <span>“Navigating Through the <span>R</span> Packages for Movement.”</span> <em>Journal of Animal Ecology</em> 89 (1): 248–67. <a href="https://doi.org/10.1111/1365-2656.13116">https://doi.org/10.1111/1365-2656.13116</a>.
</div>
<div id="ref-lu2018multidimensional" class="csl-entry" role="listitem">
Lu, Meng, Marius Appel, and Edzer Pebesma. 2018. <span>“Multidimensional Arrays for Analysing Geoscientific Data.”</span> <em>ISPRS International Journal of Geo-Information</em> 7 (8): 313.
</div>
<div id="ref-tiledb" class="csl-entry" role="listitem">
Papadopoulos, Stavros, Kushal Datta, Samuel Madden, and Timothy Mattson. 2016. <span>“The Tiledb Array Data Storage Manager.”</span> <em>Proceedings of the VLDB Endowment</em> 10 (4): 349–60.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/r-spatial\.org\/book\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./05-Attributes.html" class="pagination-link" aria-label="Attributes and Support">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Attributes and Support</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./part-2.html" class="pagination-link" aria-label="R for Spatial Data Science">
        <span class="nav-page-text">R for Spatial Data Science</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb10" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data Cubes {#sec-datacube}</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>\index{data cubes}</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>\index{array data}</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>Data cubes arise naturally when we observe properties of a set of</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>geometries repeatedly over time. Time information may sometimes be</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>considered as an attribute of a feature, such as when we register the year</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>of construction of a building or the date of birth of a person</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>(@sec-featureattributes). In other cases it may refer to the time</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>of observing an attribute, or the time for which a prediction of an</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>attribute has been made. In these cases, time is on equal footing</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>with space, and time and space together describe the physical</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>dimensions over which we observe, model, predict, or make</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>forecasts for.</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>One way of considering our world is that of a four-dimensional</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>space, with three space dimensions and one time dimension. In that view,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>events become "things" or "objects" that have as duration their</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>size on the time dimension <span class="co">[</span><span class="ot">@galton</span><span class="co">]</span>. Although such a view does</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>not align well with how we experience and describe the world,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>from a data analytical perspective, four numbers, along with their</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>reference systems, suffice to describe space and time coordinates</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>of an observation associated with a point location and time instance.</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>We define data cubes as array data with one or more array dimensions</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>associated with space and/or time <span class="co">[</span><span class="ot">@lu2018multidimensional</span><span class="co">]</span>. This</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>implies that raster data, features with attributes, and time series</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>data are all special cases of data cubes. Since we do not restrict</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>to three-dimensional structures, we actually mean _hypercubes_</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>rather than cubes, and as the cube extent of the different dimensions</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>does not have to be identical, or have comparable units, the better</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>term would be _hyper-rectangle_.  For simplicity, we talk about data</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>cubes instead.</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>\index{hypercube}</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>A canonical form of a data cube is shown in @fig-cube:</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>it shows in a perspective plot a set of raster layers for the same</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>region that were collected (observed, or modelled) at different time</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>steps. The three cube dimensions longitude, latitude, and time, are</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>thought of as being orthogonal. Arbitrary two-dimensional cube</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>slices are obtained by fixing one of the dimensions at a particular</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>value, one-dimensional slices are obtained by fixing two of the</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>dimensions at a particular value, and a scalar is obtained by fixing</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>three dimensions at a particular value.</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-cube, echo=!knitr::is_latex_output()}</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Raster data cube with dimensions latitude, longitude, and time"</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 70%</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a><span class="in"># (C) 2019, Edzer Pebesma, CC-BY-SA</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1331)</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a><span class="in">library(stars) |&gt; suppressPackageStartupMessages()</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="in">library(colorspace)</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a><span class="in">tif &lt;- system.file("tif/L7_ETMs.tif", package = "stars")</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a><span class="in">r &lt;- read_stars(tif)</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a><span class="in">nrow &lt;- 5</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="in">ncol &lt;- 8</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a><span class="in">m &lt;- r[[1]][1:nrow,1:ncol,1]</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a><span class="in">dim(m) &lt;- c(x = nrow, y = ncol) # named dim</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="in">s &lt;- st_as_stars(m)</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a><span class="in"># s</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a><span class="in">attr(s, "dimensions")[[1]]$delta = 3</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a><span class="in">attr(s, "dimensions")[[2]]$delta = -.5</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a><span class="in">attr(attr(s, "dimensions"), "raster")$affine = c(-1.2, 0.0)</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a><span class="in">plt &lt;- function(x, yoffset = 0, add, li = TRUE) {</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="in">    attr(x, "dimensions")[[2]]$offset = attr(x, "dimensions")[[2]]$offset + yoffset</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a><span class="in">    l &lt;- st_as_sf(x, as_points = FALSE)</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a><span class="in">    pal &lt;- sf.colors(10)</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a><span class="in">    if (li)</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a><span class="in">        pal &lt;- lighten(pal, 0.3 + rnorm(1, 0, 0.1))</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a><span class="in">    if (! add)</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a><span class="in">        plot(l, axes = FALSE, breaks = "equal", pal = pal, reset = FALSE, border = grey(.75), key.pos = NULL, main = NULL, xlab = "time")</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a><span class="in">    else</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a><span class="in">        plot(l, axes = TRUE, breaks = "equal", pal = pal, add = TRUE, border = grey(.75))</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a><span class="in">    u &lt;- st_union(l)</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a><span class="in">    # print(u)</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(st_geometry(u), add = TRUE, col = NA, border = 'black', lwd = 2.5)</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a><span class="in">pl &lt;- function(s, x, y, add = TRUE, randomize = FALSE) {</span></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[1]]$offset = x</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[2]]$offset = y</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a><span class="in">  if (randomize)</span></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a><span class="in">    m &lt;- m[sample(y + 1:nrow),x + 1:ncol]</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a><span class="in">  dim(m) = c(x = nrow, y = ncol) # named dim</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a><span class="in">  s[[1]] = m</span></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 0, add)</span></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 1, TRUE)</span></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 2, TRUE)</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 3, TRUE)</span></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 4, TRUE)</span></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 5, TRUE)</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 6, TRUE)</span></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 7, TRUE)</span></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 8, TRUE, FALSE)</span></span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a><span class="in">plot.new()</span></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = rep(0.5,4))</span></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a><span class="in">plot.window(xlim = c(-12,15), ylim = c(-5,10), asp=1)</span></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a><span class="in">pl(s, 0, 0)</span></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a><span class="in"># box()</span></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a><span class="in">text(-10, 0, "time", srt = -90, col = 'black')</span></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a><span class="in">text(-5,  6.5, "latitude", srt = 25, col = 'black')</span></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a><span class="in">text( 5,  8.5, "longitude", srt = 0, col = 'black')</span></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a><span class="fu">## A four-dimensional data cube</span></span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-cube4d, echo=!knitr::is_latex_output()}</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.width: 8</span></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Four-dimensional raster data cube with dimensions x, y, bands, and time"</span></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a><span class="in"># (C) 2021, Jonathan Bahlmann, CC-BY-SA</span></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a><span class="in"># https://github.com/Open-EO/openeo.org/tree/master/documentation/1.0/datacubes/.scripts</span></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a><span class="in"># based on work by Edzer Pebesma, 2019, here: https://gist.github.com/edzer/5f1b0faa3e93073784e01d5a4bb60eca</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a><span class="in"># plotting runs via a dummy stars object with x, y dimensions (no bands)</span></span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a><span class="in"># to not be overly dependent on an input image, time steps and bands</span></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a><span class="in"># are displayed by replacing the matrix contained in the dummy stars object</span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a><span class="in"># every time something is plotted</span></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a><span class="in"># packages, read input ----</span></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1331)</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a><span class="in">library(stars)</span></span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a><span class="in">library(colorspace) |&gt; suppressPackageStartupMessages()</span></span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales) |&gt; suppressPackageStartupMessages()</span></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a><span class="in"># make color palettes ----</span></span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a><span class="in">blues &lt;- sequential_hcl(n = 20, h1 = 211, c1 = 80, l1 = 40, l2 = 100, p1 = 2)</span></span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a><span class="in">greens &lt;- sequential_hcl(n = 20, h1 = 134, c1 = 80, l1 = 40, l2 = 100, p1 = 2)</span></span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a><span class="in">reds &lt;- sequential_hcl(n = 20, h1 = 360, c1 = 80, l1 = 40, l2 = 100, p1 = 2)</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a><span class="in">purples &lt;- sequential_hcl(n = 20, h1 = 299, c1 = 80, l1 = 40, l2 = 100, p1 = 2)</span></span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a><span class="in">greys &lt;- sequential_hcl(n = 20, h1 = 0, c1 = 0, l1 = 40, l2 = 100, p1 = 2)</span></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a><span class="in"># matrices from raster ----</span></span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a><span class="in"># make input matrices from an actual raster image</span></span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a><span class="in">input &lt;- read_stars("data/iceland_delta_cutout_2.tif") # this raster needs approx 6x7 format</span></span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a><span class="in"># if the input raster is changed, every image where a pixel value is written as text needs to be checked and corrected accordingly</span></span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a><span class="in">input &lt;- input[,,,1:4]</span></span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a><span class="in">warped &lt;- st_warp(input, crs = st_crs(input), cellsize = 200) # warp to approx. 6x7 pixel</span></span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a><span class="in"># these are only needed for resampling</span></span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a><span class="in">warped_highres &lt;- st_warp(warped, crs = st_crs(warped), cellsize = 100) # with different input, cellsize must be adapted</span></span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a><span class="in"># this is a bit of a trick, because 3:4 is different format than 6:7</span></span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a><span class="in"># when downsampling, the raster of origin isn't so important anyway</span></span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a><span class="in">warped_lowres &lt;- st_warp(warped_highres[,1:11,,], crs = st_crs(warped), cellsize = 390)</span></span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a><span class="in"># plot(warped_lowres)</span></span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a><span class="in"># image(warped[,,,1], text_values = TRUE)</span></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a><span class="in">t1 &lt;- floor(matrix(runif(42, -30, 150), ncol = 7)) # create timesteps 2 and 3 randomly</span></span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a><span class="in">t2 &lt;- floor(matrix(runif(42, -250, 50), ncol = 7))</span></span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a><span class="in"># create dummy stars object ----</span></span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a><span class="in">make_dummy_stars &lt;- function(x, y, d1, d2, aff) {</span></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a><span class="in">  m = warped_highres[[1]][1:x,1:y,1] # underlying raster doesn't matter because it's just dummy construct</span></span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a><span class="in">  dim(m) = c(x = x, y = y) # named dim</span></span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a><span class="in">  dummy = st_as_stars(m)</span></span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(dummy, "dimensions")[[1]]$delta = d1</span></span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(dummy, "dimensions")[[2]]$delta = d2</span></span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(attr(dummy, "dimensions"), "raster")$affine = c(aff, 0.0)</span></span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a><span class="in">  return(dummy)</span></span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a><span class="in">s &lt;- make_dummy_stars(6, 7, 2.5, -.5714286, -1.14) # mainly used, perspective</span></span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a><span class="in">f &lt;- make_dummy_stars(6, 7, 1, 1, 0) # flat</span></span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a><span class="in">highres &lt;- make_dummy_stars(12, 14, 1.25, -.2857143, -.57) # for resampling</span></span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a><span class="in">lowres &lt;- make_dummy_stars(3, 4, 5, -1, -2) # for resampling</span></span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a><span class="in"># matrices from image ----</span></span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a><span class="in">make_matrix &lt;- function(image, band, n = 42, ncol = 7, t = 0) {</span></span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a><span class="in">  # this is based on an input image with &gt;= 4 input bands</span></span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a><span class="in">  # n is meant to cut off NAs, ncol is y, t is random matrix for time difference</span></span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a><span class="in">  return(matrix(image[,,,band][[1]][1:n], ncol = ncol) - t)</span></span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a><span class="in">  # before: b3 &lt;- matrix(warped[,,,1][[1]][1:42], ncol = 7) - t2</span></span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a><span class="in"># now use function: </span></span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a><span class="in">b1 &lt;- make_matrix(warped, 1)</span></span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a><span class="in">b2 &lt;- make_matrix(warped, 1, t = t1)</span></span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a><span class="in">b3 &lt;- make_matrix(warped, 1, t = t2)</span></span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a><span class="in">g1 &lt;- make_matrix(warped, 2)</span></span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a><span class="in">g2 &lt;- make_matrix(warped, 2, t = t1)</span></span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a><span class="in">g3 &lt;- make_matrix(warped, 2, t = t2)</span></span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a><span class="in">r1 &lt;- make_matrix(warped, 3)</span></span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a><span class="in">r2 &lt;- make_matrix(warped, 3, t = t1)</span></span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a><span class="in">r3 &lt;- make_matrix(warped, 3, t = t2)</span></span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a><span class="in">n1 &lt;- make_matrix(warped, 4)</span></span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a><span class="in">n2 &lt;- make_matrix(warped, 4, t = t1)</span></span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a><span class="in">n3 &lt;- make_matrix(warped, 4, t = t2)</span></span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a><span class="in"># plot functions ----</span></span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a><span class="in">plt &lt;- function(x, yoffset = 0, add, li = TRUE, pal, print_geom = TRUE, border = .75, breaks = "equal") {</span></span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a><span class="in">  # pal is color palette</span></span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(x, "dimensions")[[2]]$offset = attr(x, "dimensions")[[2]]$offset + yoffset </span></span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a><span class="in">  l = st_as_sf(x, as_points = FALSE)</span></span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a><span class="in">  if (li)</span></span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a><span class="in">    pal &lt;- lighten(pal, 0.2) # + rnorm(1, 0, 0.1))</span></span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a><span class="in">  if (! add)</span></span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(l, axes = FALSE, breaks = breaks, pal = pal, reset = FALSE, border = grey(border), key.pos = NULL, main = NULL, xlab = "time")</span></span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a><span class="in">  else</span></span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(l, axes = TRUE, breaks = breaks, pal = pal, add = TRUE, border = grey(border))</span></span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a><span class="in">  u &lt;- st_union(l)</span></span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a><span class="in">  # print(u)</span></span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a><span class="in">  if(print_geom) {</span></span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(st_geometry(u), add = TRUE, col = NA, border = 'black', lwd = 2.5)</span></span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a><span class="in">  } else {</span></span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a><span class="in">    # not print geometry</span></span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a><span class="in">pl_stack &lt;- function(s, x, y, add = TRUE, nrM, imgY = 7, inner = 1) {</span></span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a><span class="in">  # nrM is the timestep {1, 2, 3}, cause this function</span></span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a><span class="in">  # prints all 4 bands at once</span></span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[1]]$offset = x</span></span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[2]]$offset = y</span></span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true" tabindex="-1"></a><span class="in">  # m &lt;- r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- eval(parse(text=paste0("n", nrM)))</span></span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true" tabindex="-1"></a><span class="in">  s[[1]] &lt;- m[,c(imgY:1)] # turn around to have same orientation as flat plot</span></span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 0, TRUE,  pal = purples)</span></span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- eval(parse(text=paste0("r", nrM)))</span></span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true" tabindex="-1"></a><span class="in">  s[[1]] &lt;- m[,c(imgY:1)]</span></span>
<span id="cb10-228"><a href="#cb10-228" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 1*inner, TRUE,  pal = reds)</span></span>
<span id="cb10-229"><a href="#cb10-229" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- eval(parse(text=paste0("g", nrM)))</span></span>
<span id="cb10-230"><a href="#cb10-230" aria-hidden="true" tabindex="-1"></a><span class="in">  s[[1]] &lt;- m[,c(imgY:1)]</span></span>
<span id="cb10-231"><a href="#cb10-231" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 2*inner, TRUE,  pal = greens)</span></span>
<span id="cb10-232"><a href="#cb10-232" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- eval(parse(text=paste0("b", nrM)))</span></span>
<span id="cb10-233"><a href="#cb10-233" aria-hidden="true" tabindex="-1"></a><span class="in">  s[[1]] &lt;- m[,c(imgY:1)]</span></span>
<span id="cb10-234"><a href="#cb10-234" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 3*inner, TRUE, pal = blues) # li FALSE deleted</span></span>
<span id="cb10-235"><a href="#cb10-235" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-236"><a href="#cb10-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-237"><a href="#cb10-237" aria-hidden="true" tabindex="-1"></a><span class="in"># flat plot function</span></span>
<span id="cb10-238"><a href="#cb10-238" aria-hidden="true" tabindex="-1"></a><span class="in"># prints any dummy stars with any single matrix to position</span></span>
<span id="cb10-239"><a href="#cb10-239" aria-hidden="true" tabindex="-1"></a><span class="in">pl &lt;- function(s, x, y, add = TRUE, randomize = FALSE, pal, m, print_geom = TRUE, border = .75, breaks = "equal") {</span></span>
<span id="cb10-240"><a href="#cb10-240" aria-hidden="true" tabindex="-1"></a><span class="in">  # m is matrix to replace image with</span></span>
<span id="cb10-241"><a href="#cb10-241" aria-hidden="true" tabindex="-1"></a><span class="in">  # m &lt;- t(m)</span></span>
<span id="cb10-242"><a href="#cb10-242" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[1]]$offset = x</span></span>
<span id="cb10-243"><a href="#cb10-243" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[2]]$offset = y</span></span>
<span id="cb10-244"><a href="#cb10-244" aria-hidden="true" tabindex="-1"></a><span class="in">  # print(m)</span></span>
<span id="cb10-245"><a href="#cb10-245" aria-hidden="true" tabindex="-1"></a><span class="in">  s[[1]] &lt;- m</span></span>
<span id="cb10-246"><a href="#cb10-246" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 0, add = TRUE, pal = pal, print_geom = print_geom, border = border, breaks = breaks)</span></span>
<span id="cb10-247"><a href="#cb10-247" aria-hidden="true" tabindex="-1"></a><span class="in">  #plot(s, text_values = TRUE)</span></span>
<span id="cb10-248"><a href="#cb10-248" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-249"><a href="#cb10-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-250"><a href="#cb10-250" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments &lt;- function(x, y, seg, by = 1, lwd = 4, col = "black") {</span></span>
<span id="cb10-251"><a href="#cb10-251" aria-hidden="true" tabindex="-1"></a><span class="in">  seg &lt;- seg * by</span></span>
<span id="cb10-252"><a href="#cb10-252" aria-hidden="true" tabindex="-1"></a><span class="in">  seg[,1] &lt;- seg[,1] + x</span></span>
<span id="cb10-253"><a href="#cb10-253" aria-hidden="true" tabindex="-1"></a><span class="in">  seg[,3] &lt;- seg[,3] + x</span></span>
<span id="cb10-254"><a href="#cb10-254" aria-hidden="true" tabindex="-1"></a><span class="in">  seg[,2] &lt;- seg[,2] + y</span></span>
<span id="cb10-255"><a href="#cb10-255" aria-hidden="true" tabindex="-1"></a><span class="in">  seg[,4] &lt;- seg[,4] + y</span></span>
<span id="cb10-256"><a href="#cb10-256" aria-hidden="true" tabindex="-1"></a><span class="in">  segments(seg[,1], seg[,2], seg[,3], seg[,4], lwd = lwd, col = col)</span></span>
<span id="cb10-257"><a href="#cb10-257" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-258"><a href="#cb10-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-259"><a href="#cb10-259" aria-hidden="true" tabindex="-1"></a><span class="in"># time series ----</span></span>
<span id="cb10-260"><a href="#cb10-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-261"><a href="#cb10-261" aria-hidden="true" tabindex="-1"></a><span class="in"># from: cube1_ts_6x7_bigger.png</span></span>
<span id="cb10-262"><a href="#cb10-262" aria-hidden="true" tabindex="-1"></a><span class="in">offset = 26</span></span>
<span id="cb10-263"><a href="#cb10-263" aria-hidden="true" tabindex="-1"></a><span class="in">plot.new()</span></span>
<span id="cb10-264"><a href="#cb10-264" aria-hidden="true" tabindex="-1"></a><span class="in">#par(mar = c(3, 2, 7, 2))</span></span>
<span id="cb10-265"><a href="#cb10-265" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = c(0, 0, 0, 0))</span></span>
<span id="cb10-266"><a href="#cb10-266" aria-hidden="true" tabindex="-1"></a><span class="in">#plot.window(xlim = c(10, 50), ylim = c(-3, 10), asp = 1)</span></span>
<span id="cb10-267"><a href="#cb10-267" aria-hidden="true" tabindex="-1"></a><span class="in">plot.window(xlim = c(-15, 75), ylim = c(-3, 10), asp = 1)</span></span>
<span id="cb10-268"><a href="#cb10-268" aria-hidden="true" tabindex="-1"></a><span class="in">pl_stack(s, 0, 0, nrM = 3)</span></span>
<span id="cb10-269"><a href="#cb10-269" aria-hidden="true" tabindex="-1"></a><span class="in">pl_stack(s, offset, 0, nrM = 2)</span></span>
<span id="cb10-270"><a href="#cb10-270" aria-hidden="true" tabindex="-1"></a><span class="in">pl_stack(s, 2 * offset, 0, nrM = 1)</span></span>
<span id="cb10-271"><a href="#cb10-271" aria-hidden="true" tabindex="-1"></a><span class="in"># po &lt;- matrix(c(0,-8,7,0,15,3.5,  0,1,1,5,5,14), ncol = 2)</span></span>
<span id="cb10-272"><a href="#cb10-272" aria-hidden="true" tabindex="-1"></a><span class="in">heads &lt;- matrix(c(3.5, 3.5 + offset, 3.5 + 2*offset, 14,14,14), ncol = 2)</span></span>
<span id="cb10-273"><a href="#cb10-273" aria-hidden="true" tabindex="-1"></a><span class="in">points(heads, pch = 16) # 4 or 16</span></span>
<span id="cb10-274"><a href="#cb10-274" aria-hidden="true" tabindex="-1"></a><span class="in">segments(c(-8, 7, 0, 15), c(-1,-1,3,3), 3.5, 14) # first stack pyramid</span></span>
<span id="cb10-275"><a href="#cb10-275" aria-hidden="true" tabindex="-1"></a><span class="in">segments(c(-8, 7, 0, 15) + offset, c(-1,-1,3,3), 3.5 + offset, 14) # second stack pyramid</span></span>
<span id="cb10-276"><a href="#cb10-276" aria-hidden="true" tabindex="-1"></a><span class="in">segments(c(-8, 7, 0, 15) + 2*offset, c(-1,-1,3,3), 3.5 + 2*offset, 14) # third stack pyramid</span></span>
<span id="cb10-277"><a href="#cb10-277" aria-hidden="true" tabindex="-1"></a><span class="in">arrows(-13, 14, 72, 14, angle = 20, lwd = 2)  # timeline</span></span>
<span id="cb10-278"><a href="#cb10-278" aria-hidden="true" tabindex="-1"></a><span class="in">text(7.5, 3.8, "x", col = "black")</span></span>
<span id="cb10-279"><a href="#cb10-279" aria-hidden="true" tabindex="-1"></a><span class="in">text(-10, -2.5, "bands", srt = 90, col = "black")</span></span>
<span id="cb10-280"><a href="#cb10-280" aria-hidden="true" tabindex="-1"></a><span class="in">text(-4.5, 1.8, "y", srt = 27.5, col = "black")</span></span>
<span id="cb10-281"><a href="#cb10-281" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- 15.8</span></span>
<span id="cb10-282"><a href="#cb10-282" aria-hidden="true" tabindex="-1"></a><span class="in">text(69, y, "time", col = "black")</span></span>
<span id="cb10-283"><a href="#cb10-283" aria-hidden="true" tabindex="-1"></a><span class="in">text(3.5, y, "2020-10-01", col = "black")</span></span>
<span id="cb10-284"><a href="#cb10-284" aria-hidden="true" tabindex="-1"></a><span class="in">text(3.5 + offset, y, "2020-10-13", col = "black")</span></span>
<span id="cb10-285"><a href="#cb10-285" aria-hidden="true" tabindex="-1"></a><span class="in">text(3.5 + 2*offset, y, "2020-10-25", col = "black")</span></span>
<span id="cb10-286"><a href="#cb10-286" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-287"><a href="#cb10-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-288"><a href="#cb10-288" aria-hidden="true" tabindex="-1"></a>@fig-cube4d depicts a four-dimensional raster data</span>
<span id="cb10-289"><a href="#cb10-289" aria-hidden="true" tabindex="-1"></a>cube <span class="co">[</span><span class="ot">@appel2019demand</span><span class="co">]</span>, where three-dimensional raster data cubes with a spectral</span>
<span id="cb10-290"><a href="#cb10-290" aria-hidden="true" tabindex="-1"></a>dimension ("bands") are organised along a fourth dimension, a time</span>
<span id="cb10-291"><a href="#cb10-291" aria-hidden="true" tabindex="-1"></a>axis. Colour image data always has three bands (blue, green, red),</span>
<span id="cb10-292"><a href="#cb10-292" aria-hidden="true" tabindex="-1"></a>and this example has a fourth band (near infrared, NIR), which is</span>
<span id="cb10-293"><a href="#cb10-293" aria-hidden="true" tabindex="-1"></a>commonly found in spectral remote sensing data.</span>
<span id="cb10-294"><a href="#cb10-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-295"><a href="#cb10-295" aria-hidden="true" tabindex="-1"></a>@fig-cube4d2 shows exactly the same data, but layed out</span>
<span id="cb10-296"><a href="#cb10-296" aria-hidden="true" tabindex="-1"></a>flat as a facet plot (or scatterplot matrix), where two dimensions</span>
<span id="cb10-297"><a href="#cb10-297" aria-hidden="true" tabindex="-1"></a>($x$ and $y$) are aligned with (or nested within) the dimensions</span>
<span id="cb10-298"><a href="#cb10-298" aria-hidden="true" tabindex="-1"></a>_bands_ and _time_, respectively.</span>
<span id="cb10-299"><a href="#cb10-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-300"><a href="#cb10-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-cube4d2, echo=!knitr::is_latex_output()}</span></span>
<span id="cb10-301"><a href="#cb10-301" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Four-dimensional raster data cube layed out flat over two dimensions"</span></span>
<span id="cb10-302"><a href="#cb10-302" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb10-303"><a href="#cb10-303" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.height: 10</span></span>
<span id="cb10-304"><a href="#cb10-304" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.width: 10</span></span>
<span id="cb10-305"><a href="#cb10-305" aria-hidden="true" tabindex="-1"></a><span class="in"># flat ----</span></span>
<span id="cb10-306"><a href="#cb10-306" aria-hidden="true" tabindex="-1"></a><span class="in">xlabels &lt;- seq(attr(warped, "dimensions")[[1]]$offset + attr(warped, "dimensions")[[1]]$delta / 2, length.out = attr(warped, "dimensions")[[1]]$to, by = attr(warped, "dimensions")[[1]]$delta)</span></span>
<span id="cb10-307"><a href="#cb10-307" aria-hidden="true" tabindex="-1"></a><span class="in">ylabels &lt;- seq(attr(warped, "dimensions")[[2]]$offset + attr(warped, "dimensions")[[2]]$delta / 2, length.out = attr(warped, "dimensions")[[2]]$to, by = attr(warped, "dimensions")[[2]]$delta)</span></span>
<span id="cb10-308"><a href="#cb10-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-309"><a href="#cb10-309" aria-hidden="true" tabindex="-1"></a><span class="in">print_labels &lt;- function(x, y, off, lab, horizontal, cex = 1) {</span></span>
<span id="cb10-310"><a href="#cb10-310" aria-hidden="true" tabindex="-1"></a><span class="in">  if(horizontal) { # x</span></span>
<span id="cb10-311"><a href="#cb10-311" aria-hidden="true" tabindex="-1"></a><span class="in">    for(i in 0:(length(lab)-1)) {</span></span>
<span id="cb10-312"><a href="#cb10-312" aria-hidden="true" tabindex="-1"></a><span class="in">      text(x + i*off, y, lab[i+1], cex = cex, srt = 90)</span></span>
<span id="cb10-313"><a href="#cb10-313" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb10-314"><a href="#cb10-314" aria-hidden="true" tabindex="-1"></a><span class="in">  } else { # y</span></span>
<span id="cb10-315"><a href="#cb10-315" aria-hidden="true" tabindex="-1"></a><span class="in">    lab &lt;- lab[length(lab):0]</span></span>
<span id="cb10-316"><a href="#cb10-316" aria-hidden="true" tabindex="-1"></a><span class="in">    for(i in 0:(length(lab)-1)) {</span></span>
<span id="cb10-317"><a href="#cb10-317" aria-hidden="true" tabindex="-1"></a><span class="in">      text(x, y + i*off, lab[i+1], cex = cex)</span></span>
<span id="cb10-318"><a href="#cb10-318" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb10-319"><a href="#cb10-319" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb10-320"><a href="#cb10-320" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-321"><a href="#cb10-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-322"><a href="#cb10-322" aria-hidden="true" tabindex="-1"></a><span class="in"># before: width=1000, xlim(-2, 33), date labels x=31</span></span>
<span id="cb10-323"><a href="#cb10-323" aria-hidden="true" tabindex="-1"></a><span class="in">plot.new()</span></span>
<span id="cb10-324"><a href="#cb10-324" aria-hidden="true" tabindex="-1"></a><span class="in"># par(mar = c(0,0,0,0))</span></span>
<span id="cb10-325"><a href="#cb10-325" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = c(3,0,0,0))</span></span>
<span id="cb10-326"><a href="#cb10-326" aria-hidden="true" tabindex="-1"></a><span class="in">plot.window(xlim = c(-2, 40), ylim = c(0, 25), asp = 1)</span></span>
<span id="cb10-327"><a href="#cb10-327" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 7, 0, pal = blues, m = b1)</span></span>
<span id="cb10-328"><a href="#cb10-328" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 7, 10, pal = blues, m = b2)</span></span>
<span id="cb10-329"><a href="#cb10-329" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 7, 20, pal = blues, m = b3)</span></span>
<span id="cb10-330"><a href="#cb10-330" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 14, 0, pal = greens, m = g1)</span></span>
<span id="cb10-331"><a href="#cb10-331" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 14, 10, pal = greens, m = g2)</span></span>
<span id="cb10-332"><a href="#cb10-332" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 14, 20, pal = greens, m = g3)</span></span>
<span id="cb10-333"><a href="#cb10-333" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 21, 0, pal = reds, m = r1)</span></span>
<span id="cb10-334"><a href="#cb10-334" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 21, 10, pal = reds, m = r2)</span></span>
<span id="cb10-335"><a href="#cb10-335" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 21, 20, pal = reds, m = r3)</span></span>
<span id="cb10-336"><a href="#cb10-336" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 28, 0, pal = purples, m = n1)</span></span>
<span id="cb10-337"><a href="#cb10-337" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 28, 10, pal = purples, m = n2)</span></span>
<span id="cb10-338"><a href="#cb10-338" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 28, 20, pal = purples, m = n3)</span></span>
<span id="cb10-339"><a href="#cb10-339" aria-hidden="true" tabindex="-1"></a><span class="in">print_labels(28.5, -2, 1, xlabels, horizontal = TRUE, cex = 0.7)</span></span>
<span id="cb10-340"><a href="#cb10-340" aria-hidden="true" tabindex="-1"></a><span class="in">print_labels(36, 0.5, 1, ylabels, horizontal = FALSE, cex = 0.7)</span></span>
<span id="cb10-341"><a href="#cb10-341" aria-hidden="true" tabindex="-1"></a><span class="in"># arrows(6, 27, 6, 0, angle = 20, lwd = 2)</span></span>
<span id="cb10-342"><a href="#cb10-342" aria-hidden="true" tabindex="-1"></a><span class="in"># text(5, 14, "time", srt = 90, col = "black")</span></span>
<span id="cb10-343"><a href="#cb10-343" aria-hidden="true" tabindex="-1"></a><span class="in">text(10, 28, "blue", col = "black")</span></span>
<span id="cb10-344"><a href="#cb10-344" aria-hidden="true" tabindex="-1"></a><span class="in">text(17, 28, "green", col = "black")</span></span>
<span id="cb10-345"><a href="#cb10-345" aria-hidden="true" tabindex="-1"></a><span class="in">text(24, 28, "red", col = "black")</span></span>
<span id="cb10-346"><a href="#cb10-346" aria-hidden="true" tabindex="-1"></a><span class="in">text(31, 28, "nir", col = "black")</span></span>
<span id="cb10-347"><a href="#cb10-347" aria-hidden="true" tabindex="-1"></a><span class="in">text(3, 23.5, "2020-10-01", col = "black")</span></span>
<span id="cb10-348"><a href="#cb10-348" aria-hidden="true" tabindex="-1"></a><span class="in">text(3, 13.5, "2020-10-13", col = "black")</span></span>
<span id="cb10-349"><a href="#cb10-349" aria-hidden="true" tabindex="-1"></a><span class="in">text(3, 3.5, "2020-10-25", col = "black")</span></span>
<span id="cb10-350"><a href="#cb10-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-351"><a href="#cb10-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-352"><a href="#cb10-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-353"><a href="#cb10-353" aria-hidden="true" tabindex="-1"></a><span class="fu">## Dimensions, attributes, and support</span></span>
<span id="cb10-354"><a href="#cb10-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-355"><a href="#cb10-355" aria-hidden="true" tabindex="-1"></a>\index{data cube!dimensions}</span>
<span id="cb10-356"><a href="#cb10-356" aria-hidden="true" tabindex="-1"></a>\index{data cube!attributes}</span>
<span id="cb10-357"><a href="#cb10-357" aria-hidden="true" tabindex="-1"></a>\index{data cube!support}</span>
<span id="cb10-358"><a href="#cb10-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-359"><a href="#cb10-359" aria-hidden="true" tabindex="-1"></a>Phenomena in space and time can be thought of as functions</span>
<span id="cb10-360"><a href="#cb10-360" aria-hidden="true" tabindex="-1"></a>with _domain_ space and time, and with _range_ one or more observed</span>
<span id="cb10-361"><a href="#cb10-361" aria-hidden="true" tabindex="-1"></a>attributes. For clearly identifiable discrete events or objects,</span>
<span id="cb10-362"><a href="#cb10-362" aria-hidden="true" tabindex="-1"></a>the range is typically discrete, and precise delineation involves</span>
<span id="cb10-363"><a href="#cb10-363" aria-hidden="true" tabindex="-1"></a>describing the precise coordinates where a thing starts or stops,</span>
<span id="cb10-364"><a href="#cb10-364" aria-hidden="true" tabindex="-1"></a>which is best suited by vector geometries.  For continuous phenomena,</span>
<span id="cb10-365"><a href="#cb10-365" aria-hidden="true" tabindex="-1"></a>variables that take on a value everywhere such as air temperature</span>
<span id="cb10-366"><a href="#cb10-366" aria-hidden="true" tabindex="-1"></a>or land use type, there are infinitely many values to represent and</span>
<span id="cb10-367"><a href="#cb10-367" aria-hidden="true" tabindex="-1"></a>a common approach is to discretise space and time _regularly_ over</span>
<span id="cb10-368"><a href="#cb10-368" aria-hidden="true" tabindex="-1"></a>the spatiotemporal domain (extent) of interest. This leads to a</span>
<span id="cb10-369"><a href="#cb10-369" aria-hidden="true" tabindex="-1"></a>number of familiar data structures:</span>
<span id="cb10-370"><a href="#cb10-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-371"><a href="#cb10-371" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>time series, depicted as time lines for functions of time</span>
<span id="cb10-372"><a href="#cb10-372" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>image or raster data for two-dimensional spatial data</span>
<span id="cb10-373"><a href="#cb10-373" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>time sequences of images for dynamic spatial data</span>
<span id="cb10-374"><a href="#cb10-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-375"><a href="#cb10-375" aria-hidden="true" tabindex="-1"></a>The third form of this, where a variable $Z$ depends on $x$, $y$</span>
<span id="cb10-376"><a href="#cb10-376" aria-hidden="true" tabindex="-1"></a>and $t$, as in</span>
<span id="cb10-377"><a href="#cb10-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-378"><a href="#cb10-378" aria-hidden="true" tabindex="-1"></a>$$Z = f(x, y, t)$$</span>
<span id="cb10-379"><a href="#cb10-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-380"><a href="#cb10-380" aria-hidden="true" tabindex="-1"></a>is the archetype of a spatiotemporal array or _data cube_: the shape</span>
<span id="cb10-381"><a href="#cb10-381" aria-hidden="true" tabindex="-1"></a>of the volume where points regularly discretising the domain forms a</span>
<span id="cb10-382"><a href="#cb10-382" aria-hidden="true" tabindex="-1"></a>cube. We call the variables that form the range (here: $x, y, t$) the</span>
<span id="cb10-383"><a href="#cb10-383" aria-hidden="true" tabindex="-1"></a>cube _dimensions_.  Data cubes may have multiple attributes, as in</span>
<span id="cb10-384"><a href="#cb10-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-385"><a href="#cb10-385" aria-hidden="true" tabindex="-1"></a>$$<span class="sc">\{</span>Z_1,Z_2,...,Z_p<span class="sc">\}</span> = f(x, y, t)$$</span>
<span id="cb10-386"><a href="#cb10-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-387"><a href="#cb10-387" aria-hidden="true" tabindex="-1"></a>and if $Z$ is functional, for instance reflectance values measured over</span>
<span id="cb10-388"><a href="#cb10-388" aria-hidden="true" tabindex="-1"></a>the electromagnetic spectrum, the spectral wavelengths $\lambda$</span>
<span id="cb10-389"><a href="#cb10-389" aria-hidden="true" tabindex="-1"></a>may form an additional dimension, as in $Z = f(x,y,t,\lambda)$.</span>
<span id="cb10-390"><a href="#cb10-390" aria-hidden="true" tabindex="-1"></a>@sec-switching discusses the alternative of representing</span>
<span id="cb10-391"><a href="#cb10-391" aria-hidden="true" tabindex="-1"></a>colour bands as attributes. </span>
<span id="cb10-392"><a href="#cb10-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-393"><a href="#cb10-393" aria-hidden="true" tabindex="-1"></a>Multiple time dimensions arise for instance when making forecasts for</span>
<span id="cb10-394"><a href="#cb10-394" aria-hidden="true" tabindex="-1"></a>different times in the future $t'$ at different times $t$, or when</span>
<span id="cb10-395"><a href="#cb10-395" aria-hidden="true" tabindex="-1"></a>time is split over multiple dimensions (as in year, day-of-year,</span>
<span id="cb10-396"><a href="#cb10-396" aria-hidden="true" tabindex="-1"></a>and hour-of-day). The most general definition of a data cube is a</span>
<span id="cb10-397"><a href="#cb10-397" aria-hidden="true" tabindex="-1"></a>functional mapping from $n$ dimensions to $p$ attributes:</span>
<span id="cb10-398"><a href="#cb10-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-399"><a href="#cb10-399" aria-hidden="true" tabindex="-1"></a>$$<span class="sc">\{</span>Z_1,Z_2,...,Z_p<span class="sc">\}</span> = f(D_1,D_2,...,D_n)$$</span>
<span id="cb10-400"><a href="#cb10-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-401"><a href="#cb10-401" aria-hidden="true" tabindex="-1"></a>Here, we will consider any dataset with one or more space dimensions</span>
<span id="cb10-402"><a href="#cb10-402" aria-hidden="true" tabindex="-1"></a>and zero or more time dimensions as data cubes. That includes:</span>
<span id="cb10-403"><a href="#cb10-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-404"><a href="#cb10-404" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>simple features (@sec-simplefeatures)</span>
<span id="cb10-405"><a href="#cb10-405" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>time series for sets of features</span>
<span id="cb10-406"><a href="#cb10-406" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>raster data</span>
<span id="cb10-407"><a href="#cb10-407" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>multi-spectral raster data (images)</span>
<span id="cb10-408"><a href="#cb10-408" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>time series of multi-spectral raster data (video)</span>
<span id="cb10-409"><a href="#cb10-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-410"><a href="#cb10-410" aria-hidden="true" tabindex="-1"></a>\index{raster data cube}</span>
<span id="cb10-411"><a href="#cb10-411" aria-hidden="true" tabindex="-1"></a>\index{data cube!raster dimensions}</span>
<span id="cb10-412"><a href="#cb10-412" aria-hidden="true" tabindex="-1"></a>\index{data cube!vector geometry dimension}</span>
<span id="cb10-413"><a href="#cb10-413" aria-hidden="true" tabindex="-1"></a>\index{vector data cube}</span>
<span id="cb10-414"><a href="#cb10-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-415"><a href="#cb10-415" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regular dimensions, GDAL's geotransform</span></span>
<span id="cb10-416"><a href="#cb10-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-417"><a href="#cb10-417" aria-hidden="true" tabindex="-1"></a>\index{data cube!regular dimensions}</span>
<span id="cb10-418"><a href="#cb10-418" aria-hidden="true" tabindex="-1"></a>\index{dimension!regular}</span>
<span id="cb10-419"><a href="#cb10-419" aria-hidden="true" tabindex="-1"></a>\index{GDAL!geotransform}</span>
<span id="cb10-420"><a href="#cb10-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-421"><a href="#cb10-421" aria-hidden="true" tabindex="-1"></a>Data cubes are usually stored in multi-dimensional arrays, and the</span>
<span id="cb10-422"><a href="#cb10-422" aria-hidden="true" tabindex="-1"></a>usual relationship between 1-based array index $i$ and an associated</span>
<span id="cb10-423"><a href="#cb10-423" aria-hidden="true" tabindex="-1"></a>regularly discretised dimension variable $x$ is</span>
<span id="cb10-424"><a href="#cb10-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-425"><a href="#cb10-425" aria-hidden="true" tabindex="-1"></a>$$x = o_x + (i-1) d_x$$</span>
<span id="cb10-426"><a href="#cb10-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-427"><a href="#cb10-427" aria-hidden="true" tabindex="-1"></a>with $o_x$ the origin, and $d_x$ the grid spacing for this dimension.</span>
<span id="cb10-428"><a href="#cb10-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-429"><a href="#cb10-429" aria-hidden="true" tabindex="-1"></a>For more general cases like those in Figures</span>
<span id="cb10-430"><a href="#cb10-430" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">-@fig-rastertypes01</span><span class="co">]</span> b-c, the relation between $x$ and $y$</span>
<span id="cb10-431"><a href="#cb10-431" aria-hidden="true" tabindex="-1"></a>and array indexes $i$ and $j$ is</span>
<span id="cb10-432"><a href="#cb10-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-433"><a href="#cb10-433" aria-hidden="true" tabindex="-1"></a>$$x = o_x + (i-1) d_x + (j-1) a_1$$</span>
<span id="cb10-434"><a href="#cb10-434" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-435"><a href="#cb10-435" aria-hidden="true" tabindex="-1"></a>$$y = o_y + (i-1) a_2 + (j-1) d_y$$</span>
<span id="cb10-436"><a href="#cb10-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-437"><a href="#cb10-437" aria-hidden="true" tabindex="-1"></a>With two affine parameters $a_1$ and $a_2$; this is the so-called</span>
<span id="cb10-438"><a href="#cb10-438" aria-hidden="true" tabindex="-1"></a>_geotransform_ as used in GDAL.  When $a_1=a_2=0$, this</span>
<span id="cb10-439"><a href="#cb10-439" aria-hidden="true" tabindex="-1"></a>reduces to the regular raster of @fig-rastertypes01 a</span>
<span id="cb10-440"><a href="#cb10-440" aria-hidden="true" tabindex="-1"></a>with square cells if $d_x = d_y$.</span>
<span id="cb10-441"><a href="#cb10-441" aria-hidden="true" tabindex="-1"></a>For integer indexes, the coordinates are that of the starting _edge_</span>
<span id="cb10-442"><a href="#cb10-442" aria-hidden="true" tabindex="-1"></a>of a grid cell, and the cell area (pixel) spans a range corresponding to</span>
<span id="cb10-443"><a href="#cb10-443" aria-hidden="true" tabindex="-1"></a>index values ranging from $i$ (inclusive) to $i+1$ (exclusive). </span>
<span id="cb10-444"><a href="#cb10-444" aria-hidden="true" tabindex="-1"></a>For most common imagery formats, $d_y$ is negative,</span>
<span id="cb10-445"><a href="#cb10-445" aria-hidden="true" tabindex="-1"></a>indicating that image row index increases with decreasing $y$</span>
<span id="cb10-446"><a href="#cb10-446" aria-hidden="true" tabindex="-1"></a>values (southward).  To get the $x$- and $y$-coordinate of the grid</span>
<span id="cb10-447"><a href="#cb10-447" aria-hidden="true" tabindex="-1"></a>cell _centre_ of the top left grid cell (in case of a negative $d_y$),</span>
<span id="cb10-448"><a href="#cb10-448" aria-hidden="true" tabindex="-1"></a>we use $i=1.5$ and $j=1.5$.</span>
<span id="cb10-449"><a href="#cb10-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-450"><a href="#cb10-450" aria-hidden="true" tabindex="-1"></a>For rectilinear rasters, a table that maps array index to dimension</span>
<span id="cb10-451"><a href="#cb10-451" aria-hidden="true" tabindex="-1"></a>values is needed. NetCDF files for instance always store all values</span>
<span id="cb10-452"><a href="#cb10-452" aria-hidden="true" tabindex="-1"></a>of spatial dimension (coordinate) variables that may correspond to</span>
<span id="cb10-453"><a href="#cb10-453" aria-hidden="true" tabindex="-1"></a>the centre or offset of spatial grid cells, and in addition</span>
<span id="cb10-454"><a href="#cb10-454" aria-hidden="true" tabindex="-1"></a>may store grid cell boundaries (to define rectilinear dimensions</span>
<span id="cb10-455"><a href="#cb10-455" aria-hidden="true" tabindex="-1"></a>or to disambiguate the relation of the coordinate variable values</span>
<span id="cb10-456"><a href="#cb10-456" aria-hidden="true" tabindex="-1"></a>to the cell boundaries).</span>
<span id="cb10-457"><a href="#cb10-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-458"><a href="#cb10-458" aria-hidden="true" tabindex="-1"></a>\index{raster!rectilinear}</span>
<span id="cb10-459"><a href="#cb10-459" aria-hidden="true" tabindex="-1"></a>\index{NetCDF}</span>
<span id="cb10-460"><a href="#cb10-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-461"><a href="#cb10-461" aria-hidden="true" tabindex="-1"></a>For curvilinear rasters, an array that maps every combination of $i,j$</span>
<span id="cb10-462"><a href="#cb10-462" aria-hidden="true" tabindex="-1"></a>into $x,y$ pairs is needed, or a parametric function that does this</span>
<span id="cb10-463"><a href="#cb10-463" aria-hidden="true" tabindex="-1"></a>(a projection or its inverse). NetCDF files often provide both,</span>
<span id="cb10-464"><a href="#cb10-464" aria-hidden="true" tabindex="-1"></a>when available. GDAL calls such arrays _geolocation arrays_, and has</span>
<span id="cb10-465"><a href="#cb10-465" aria-hidden="true" tabindex="-1"></a>extensive support for transformations involving them.</span>
<span id="cb10-466"><a href="#cb10-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-467"><a href="#cb10-467" aria-hidden="true" tabindex="-1"></a>\index{raster!curvilinear}</span>
<span id="cb10-468"><a href="#cb10-468" aria-hidden="true" tabindex="-1"></a>\index{GDAL!geolocation arrays}</span>
<span id="cb10-469"><a href="#cb10-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-470"><a href="#cb10-470" aria-hidden="true" tabindex="-1"></a><span class="fu">### Support along cube dimensions</span></span>
<span id="cb10-471"><a href="#cb10-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-472"><a href="#cb10-472" aria-hidden="true" tabindex="-1"></a>\index{data cube!dimension!support}</span>
<span id="cb10-473"><a href="#cb10-473" aria-hidden="true" tabindex="-1"></a>\index{support!data cube}</span>
<span id="cb10-474"><a href="#cb10-474" aria-hidden="true" tabindex="-1"></a>\index{support!dimension}</span>
<span id="cb10-475"><a href="#cb10-475" aria-hidden="true" tabindex="-1"></a>\index{support!temporal}</span>
<span id="cb10-476"><a href="#cb10-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-477"><a href="#cb10-477" aria-hidden="true" tabindex="-1"></a>@sec-agr defined _spatial_ support of an attribute variable</span>
<span id="cb10-478"><a href="#cb10-478" aria-hidden="true" tabindex="-1"></a>as the size (length, area, volume) of a geometry associated with a particular</span>
<span id="cb10-479"><a href="#cb10-479" aria-hidden="true" tabindex="-1"></a>observation or prediction. The same notion</span>
<span id="cb10-480"><a href="#cb10-480" aria-hidden="true" tabindex="-1"></a>applies to temporal support. Although time is rarely reported by</span>
<span id="cb10-481"><a href="#cb10-481" aria-hidden="true" tabindex="-1"></a>explicit time periods having a start- and end-time, in many cases</span>
<span id="cb10-482"><a href="#cb10-482" aria-hidden="true" tabindex="-1"></a>either the time stamp implies a period (ISO-8601 uses</span>
<span id="cb10-483"><a href="#cb10-483" aria-hidden="true" tabindex="-1"></a>"2021" for the full year, "2021-01" for the full month) or the time</span>
<span id="cb10-484"><a href="#cb10-484" aria-hidden="true" tabindex="-1"></a>period is taken as the period from the time stamp of the current</span>
<span id="cb10-485"><a href="#cb10-485" aria-hidden="true" tabindex="-1"></a>record up to but not including the time stamp of the next record.</span>
<span id="cb10-486"><a href="#cb10-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-487"><a href="#cb10-487" aria-hidden="true" tabindex="-1"></a>An example is MODIS satellite imagery, where vegetation indexes (NDVI</span>
<span id="cb10-488"><a href="#cb10-488" aria-hidden="true" tabindex="-1"></a>and EVI) are available as 16-day composites, meaning that over 16-day</span>
<span id="cb10-489"><a href="#cb10-489" aria-hidden="true" tabindex="-1"></a>periods all available imagery is aggregated into a single image; such</span>
<span id="cb10-490"><a href="#cb10-490" aria-hidden="true" tabindex="-1"></a>composites have temporal "block support". Sentinel-2 or Landsat-8</span>
<span id="cb10-491"><a href="#cb10-491" aria-hidden="true" tabindex="-1"></a>data on the other hand are "snapshot" images and have temporal</span>
<span id="cb10-492"><a href="#cb10-492" aria-hidden="true" tabindex="-1"></a>"point support".  When temporally aggregating data with temporal</span>
<span id="cb10-493"><a href="#cb10-493" aria-hidden="true" tabindex="-1"></a>point support, for instance to monthly values, all images</span>
<span id="cb10-494"><a href="#cb10-494" aria-hidden="true" tabindex="-1"></a>falling in the target time interval are selected. When aggregating temporal block</span>
<span id="cb10-495"><a href="#cb10-495" aria-hidden="true" tabindex="-1"></a>support imagery such as the MODIS 16-day composite, one might</span>
<span id="cb10-496"><a href="#cb10-496" aria-hidden="true" tabindex="-1"></a>weigh images according to the amount of overlap of the 16-day</span>
<span id="cb10-497"><a href="#cb10-497" aria-hidden="true" tabindex="-1"></a>composite period and the target period, similar to area-weighted</span>
<span id="cb10-498"><a href="#cb10-498" aria-hidden="true" tabindex="-1"></a>interpolation <span class="co">[</span><span class="ot">@sec-area-weighted</span><span class="co">]</span> but over the time dimension.</span>
<span id="cb10-499"><a href="#cb10-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-500"><a href="#cb10-500" aria-hidden="true" tabindex="-1"></a><span class="fu">## Operations on data cubes {#sec-dcoperations}</span></span>
<span id="cb10-501"><a href="#cb10-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-502"><a href="#cb10-502" aria-hidden="true" tabindex="-1"></a><span class="fu">### Slicing a cube: filter</span></span>
<span id="cb10-503"><a href="#cb10-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-504"><a href="#cb10-504" aria-hidden="true" tabindex="-1"></a>\index{data cube!filter}</span>
<span id="cb10-505"><a href="#cb10-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-506"><a href="#cb10-506" aria-hidden="true" tabindex="-1"></a>Data cubes can be sliced into sub-cubes by fixing a dimension at</span>
<span id="cb10-507"><a href="#cb10-507" aria-hidden="true" tabindex="-1"></a>a particular value. @fig-cube4filter shows the sub-cubes obtained</span>
<span id="cb10-508"><a href="#cb10-508" aria-hidden="true" tabindex="-1"></a>by doing this with the temporal, spectral, or spatial dimension. In</span>
<span id="cb10-509"><a href="#cb10-509" aria-hidden="true" tabindex="-1"></a>this figure, the spatial filtering does not happen by fixing a</span>
<span id="cb10-510"><a href="#cb10-510" aria-hidden="true" tabindex="-1"></a>single spatial dimension at a particular value, but by selecting a</span>
<span id="cb10-511"><a href="#cb10-511" aria-hidden="true" tabindex="-1"></a>particular sub-region, which is a more common operation. Fixing $x$</span>
<span id="cb10-512"><a href="#cb10-512" aria-hidden="true" tabindex="-1"></a>or $y$ would give a sub-cube along a transect of constant $x$ or $y$,</span>
<span id="cb10-513"><a href="#cb10-513" aria-hidden="true" tabindex="-1"></a>which can be used to show a Hovmöller diagram, where an attribute is</span>
<span id="cb10-514"><a href="#cb10-514" aria-hidden="true" tabindex="-1"></a>plotted (coloured) in the space of one space and one time dimension.</span>
<span id="cb10-515"><a href="#cb10-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-516"><a href="#cb10-516" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-cube4filter, echo=!knitr::is_latex_output()}</span></span>
<span id="cb10-517"><a href="#cb10-517" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.width: 10</span></span>
<span id="cb10-518"><a href="#cb10-518" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.height: 11</span></span>
<span id="cb10-519"><a href="#cb10-519" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Data cube filtering by time, band or spatially"</span></span>
<span id="cb10-520"><a href="#cb10-520" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb10-521"><a href="#cb10-521" aria-hidden="true" tabindex="-1"></a><span class="in"># filter ----</span></span>
<span id="cb10-522"><a href="#cb10-522" aria-hidden="true" tabindex="-1"></a><span class="in"># mask &lt;- matrix(c(rep(NA, 26), 1,NA,1,NA,1,1,1, rep(NA, 9)), ncol = 7)</span></span>
<span id="cb10-523"><a href="#cb10-523" aria-hidden="true" tabindex="-1"></a><span class="in">mask &lt;- matrix(c(NA,NA,NA,NA,NA,NA,</span></span>
<span id="cb10-524"><a href="#cb10-524" aria-hidden="true" tabindex="-1"></a><span class="in">                 NA,NA,NA,NA,NA,NA,</span></span>
<span id="cb10-525"><a href="#cb10-525" aria-hidden="true" tabindex="-1"></a><span class="in">                 NA,NA,NA, 1, 1, 1,</span></span>
<span id="cb10-526"><a href="#cb10-526" aria-hidden="true" tabindex="-1"></a><span class="in">                 NA,NA, 1, 1, 1,NA,</span></span>
<span id="cb10-527"><a href="#cb10-527" aria-hidden="true" tabindex="-1"></a><span class="in">                 NA,NA,NA, 1, 1,NA,</span></span>
<span id="cb10-528"><a href="#cb10-528" aria-hidden="true" tabindex="-1"></a><span class="in">                 NA,NA,NA,NA,NA,NA,</span></span>
<span id="cb10-529"><a href="#cb10-529" aria-hidden="true" tabindex="-1"></a><span class="in">                 NA,NA,NA,NA,NA,NA), ncol = 7)</span></span>
<span id="cb10-530"><a href="#cb10-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-531"><a href="#cb10-531" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid &lt;- function(x, y) {</span></span>
<span id="cb10-532"><a href="#cb10-532" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 0+y, pal = blues, m = b1)</span></span>
<span id="cb10-533"><a href="#cb10-533" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 10+y, pal = blues, m = b2)</span></span>
<span id="cb10-534"><a href="#cb10-534" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 20+y, pal = blues, m = b3)</span></span>
<span id="cb10-535"><a href="#cb10-535" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 7+x, 0+y, pal = greens, m = g1)</span></span>
<span id="cb10-536"><a href="#cb10-536" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 7+x, 10+y, pal = greens, m = g2)</span></span>
<span id="cb10-537"><a href="#cb10-537" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 7+x, 20+y, pal = greens, m = g3)</span></span>
<span id="cb10-538"><a href="#cb10-538" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 14+x, 0+y, pal = reds, m = r1)</span></span>
<span id="cb10-539"><a href="#cb10-539" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 14+x, 10+y, pal = reds, m = r2)</span></span>
<span id="cb10-540"><a href="#cb10-540" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 14+x, 20+y, pal = reds, m = r3)</span></span>
<span id="cb10-541"><a href="#cb10-541" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 21+x, 0+y, pal = purples, m = n1)</span></span>
<span id="cb10-542"><a href="#cb10-542" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 21+x, 10+y, pal = purples, m = n2)</span></span>
<span id="cb10-543"><a href="#cb10-543" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 21+x, 20+y, pal = purples, m = n3)</span></span>
<span id="cb10-544"><a href="#cb10-544" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-545"><a href="#cb10-545" aria-hidden="true" tabindex="-1"></a><span class="in">print_alpha_grid &lt;- function(x,y, alp = 0.2, geom = FALSE) {</span></span>
<span id="cb10-546"><a href="#cb10-546" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 0+y, pal = alpha(blues, alp), print_geom = geom,  m = b1, border = 1)</span></span>
<span id="cb10-547"><a href="#cb10-547" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 10+y, pal = alpha(blues, alp), print_geom = geom,  m = b2, border = 1)</span></span>
<span id="cb10-548"><a href="#cb10-548" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 20+y, pal = alpha(blues, alp), print_geom = geom,  m = b3, border = 1)</span></span>
<span id="cb10-549"><a href="#cb10-549" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 7+x, 0+y, pal = alpha(greens, alp), print_geom = geom,  m = g1, border = 1)</span></span>
<span id="cb10-550"><a href="#cb10-550" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 7+x, 10+y, pal = alpha(greens, alp), print_geom = geom,  m = g2, border = 1)</span></span>
<span id="cb10-551"><a href="#cb10-551" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 7+x, 20+y, pal = alpha(greens, alp), print_geom = geom,  m = g3, border = 1)</span></span>
<span id="cb10-552"><a href="#cb10-552" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 14+x, 0+y, pal = alpha(reds, alp), print_geom = geom,  m = r1, border = 1)</span></span>
<span id="cb10-553"><a href="#cb10-553" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 14+x, 10+y, pal = alpha(reds, alp), print_geom = geom,  m = r2, border = 1)</span></span>
<span id="cb10-554"><a href="#cb10-554" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 14+x, 20+y, pal = alpha(reds, alp), print_geom = geom,  m = r3, border = 1)</span></span>
<span id="cb10-555"><a href="#cb10-555" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 21+x, 0+y, pal = alpha(purples, alp), print_geom = geom,  m = n1, border = 1)</span></span>
<span id="cb10-556"><a href="#cb10-556" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 21+x, 10+y, pal = alpha(purples, alp), print_geom = geom,  m = n2, border = 1)</span></span>
<span id="cb10-557"><a href="#cb10-557" aria-hidden="true" tabindex="-1"></a><span class="in">  invisible(pl(f, 21+x, 20+y, pal = alpha(purples, alp), print_geom = geom,  m = n3, border = 1))</span></span>
<span id="cb10-558"><a href="#cb10-558" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-559"><a href="#cb10-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-560"><a href="#cb10-560" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_filter &lt;- function(x, y) {</span></span>
<span id="cb10-561"><a href="#cb10-561" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 0+y, pal = blues, m = matrix(b1[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-562"><a href="#cb10-562" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 10+y, pal = blues, m = matrix(b2[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-563"><a href="#cb10-563" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 20+y, pal = blues, m = matrix(b3[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-564"><a href="#cb10-564" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 7+x, 0+y, pal = greens, m = matrix(g1[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-565"><a href="#cb10-565" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 7+x, 10+y, pal = greens, m = matrix(g2[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-566"><a href="#cb10-566" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 7+x, 20+y, pal = greens, m = matrix(g3[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-567"><a href="#cb10-567" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 14+x, 0+y, pal = reds, m = matrix(r1[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-568"><a href="#cb10-568" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 14+x, 10+y, pal = reds, m = matrix(r2[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-569"><a href="#cb10-569" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 14+x, 20+y, pal = reds, m = matrix(r3[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-570"><a href="#cb10-570" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 21+x, 0+y, pal = purples, m = matrix(n1[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-571"><a href="#cb10-571" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 21+x, 10+y, pal = purples, m = matrix(n2[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-572"><a href="#cb10-572" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 21+x, 20+y, pal = purples, m = matrix(n3[mask == TRUE], ncol = 7))</span></span>
<span id="cb10-573"><a href="#cb10-573" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-574"><a href="#cb10-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-575"><a href="#cb10-575" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_time_filter &lt;- function(x, y) { # 3x1, 28x7</span></span>
<span id="cb10-576"><a href="#cb10-576" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 10+y, pal = blues, m = b3)</span></span>
<span id="cb10-577"><a href="#cb10-577" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 7+x, 10+y, pal = greens, m = g3)</span></span>
<span id="cb10-578"><a href="#cb10-578" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 14+x, 10+y, pal = reds, m = r3)</span></span>
<span id="cb10-579"><a href="#cb10-579" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 21+x, 10+y, pal = purples, m = n3)</span></span>
<span id="cb10-580"><a href="#cb10-580" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-581"><a href="#cb10-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-582"><a href="#cb10-582" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_bands_filter &lt;- function(x, y, pal = greys) { # 1x3 6x27</span></span>
<span id="cb10-583"><a href="#cb10-583" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 0+y, pal = pal, m = n1)</span></span>
<span id="cb10-584"><a href="#cb10-584" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 10+y, pal = pal, m = n2)</span></span>
<span id="cb10-585"><a href="#cb10-585" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 20+y, pal = pal, m = n3)</span></span>
<span id="cb10-586"><a href="#cb10-586" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-587"><a href="#cb10-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-588"><a href="#cb10-588" aria-hidden="true" tabindex="-1"></a><span class="in"># build exactly like reduce</span></span>
<span id="cb10-589"><a href="#cb10-589" aria-hidden="true" tabindex="-1"></a><span class="in">plot.new()</span></span>
<span id="cb10-590"><a href="#cb10-590" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = c(3,3,3,3))</span></span>
<span id="cb10-591"><a href="#cb10-591" aria-hidden="true" tabindex="-1"></a><span class="in">x &lt;- 120</span></span>
<span id="cb10-592"><a href="#cb10-592" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- 100</span></span>
<span id="cb10-593"><a href="#cb10-593" aria-hidden="true" tabindex="-1"></a><span class="in">down &lt;- 0</span></span>
<span id="cb10-594"><a href="#cb10-594" aria-hidden="true" tabindex="-1"></a><span class="in">plot.window(xlim = c(0, x), ylim = c(0, y), asp = 1)</span></span>
<span id="cb10-595"><a href="#cb10-595" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid(x/2-28/2,y-27)</span></span>
<span id="cb10-596"><a href="#cb10-596" aria-hidden="true" tabindex="-1"></a><span class="in">print_alpha_grid((x/3-28)/2, 0-down) # alpha grid</span></span>
<span id="cb10-597"><a href="#cb10-597" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_time_filter((x/3-28)/2, -10-down) # select 3rd</span></span>
<span id="cb10-598"><a href="#cb10-598" aria-hidden="true" tabindex="-1"></a><span class="in">print_alpha_grid(x/3+((x/3-6)/2) -10.5, 0-down) # alpha grid</span></span>
<span id="cb10-599"><a href="#cb10-599" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_bands_filter(x/3+((x/3-12.4)), 0-down, pal = purples)</span></span>
<span id="cb10-600"><a href="#cb10-600" aria-hidden="true" tabindex="-1"></a><span class="in">print_alpha_grid(2*(x/3)+((x/3-28)/2), 0-down) # alpha grid</span></span>
<span id="cb10-601"><a href="#cb10-601" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_filter(2*(x/3)+((x/3-28)/2), 0-down)</span></span>
<span id="cb10-602"><a href="#cb10-602" aria-hidden="true" tabindex="-1"></a><span class="in">text(3, 13.5-down, "time", srt = 90, col = "black")</span></span>
<span id="cb10-603"><a href="#cb10-603" aria-hidden="true" tabindex="-1"></a><span class="in">text(43, 13.5-down, "time", srt = 90, col = "black")</span></span>
<span id="cb10-604"><a href="#cb10-604" aria-hidden="true" tabindex="-1"></a><span class="in">text(83, 13.5-down, "time", srt = 90, col = "black")</span></span>
<span id="cb10-605"><a href="#cb10-605" aria-hidden="true" tabindex="-1"></a><span class="in">text(20, 30, "bands", col = "black")</span></span>
<span id="cb10-606"><a href="#cb10-606" aria-hidden="true" tabindex="-1"></a><span class="in">text(60, 30, "bands", col = "black")</span></span>
<span id="cb10-607"><a href="#cb10-607" aria-hidden="true" tabindex="-1"></a><span class="in">text(100, 30, "bands", col = "black")</span></span>
<span id="cb10-608"><a href="#cb10-608" aria-hidden="true" tabindex="-1"></a><span class="in">arrows(x/2-28/2,y-30, x/6,32, angle = 20, lwd = 2)</span></span>
<span id="cb10-609"><a href="#cb10-609" aria-hidden="true" tabindex="-1"></a><span class="in">arrows(x/2,y-30, x/2,32, angle = 20, lwd = 2)</span></span>
<span id="cb10-610"><a href="#cb10-610" aria-hidden="true" tabindex="-1"></a><span class="in">arrows(x/2+28/2,y-30, 100, 32, angle = 20, lwd = 2)</span></span>
<span id="cb10-611"><a href="#cb10-611" aria-hidden="true" tabindex="-1"></a><span class="in"># points(seq(1,120,10), seq(1,120,10))</span></span>
<span id="cb10-612"><a href="#cb10-612" aria-hidden="true" tabindex="-1"></a><span class="in">text(28.5,49, "filter temporally", srt = 55.5, col = "black", cex = 0.8)</span></span>
<span id="cb10-613"><a href="#cb10-613" aria-hidden="true" tabindex="-1"></a><span class="in">text(57,49, "filter bands", srt = 90, col = "black", cex = 0.8)</span></span>
<span id="cb10-614"><a href="#cb10-614" aria-hidden="true" tabindex="-1"></a><span class="in">text(91.5,49, "filter spatially", srt = -55.5, col = "black", cex = 0.8)</span></span>
<span id="cb10-615"><a href="#cb10-615" aria-hidden="true" tabindex="-1"></a><span class="in">print_labels(x = x/2-28/2 + 3, y = y+4, off = 7, lab = c("blue", "green", "red", "nir"),</span></span>
<span id="cb10-616"><a href="#cb10-616" aria-hidden="true" tabindex="-1"></a><span class="in">             horizontal = TRUE, cex = 0.6)</span></span>
<span id="cb10-617"><a href="#cb10-617" aria-hidden="true" tabindex="-1"></a><span class="in">print_labels(x = x/2-28/2 - 9, y = y-23, off = 10, lab = c("2020-10-01", "2020-10-13", "2020-10-25"),</span></span>
<span id="cb10-618"><a href="#cb10-618" aria-hidden="true" tabindex="-1"></a><span class="in">             horizontal = FALSE, cex = 0.6)</span></span>
<span id="cb10-619"><a href="#cb10-619" aria-hidden="true" tabindex="-1"></a><span class="in">print_labels(x = x/2-28/2 + 21.5, y = y-30, off = 1, lab = xlabels,</span></span>
<span id="cb10-620"><a href="#cb10-620" aria-hidden="true" tabindex="-1"></a><span class="in">             horizontal = TRUE, cex = 0.3)</span></span>
<span id="cb10-621"><a href="#cb10-621" aria-hidden="true" tabindex="-1"></a><span class="in">print_labels(x = x/2-28/2 + 30, y = y-26.5, off = 1, lab = ylabels,</span></span>
<span id="cb10-622"><a href="#cb10-622" aria-hidden="true" tabindex="-1"></a><span class="in">             horizontal = FALSE, cex = 0.3)</span></span>
<span id="cb10-623"><a href="#cb10-623" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-624"><a href="#cb10-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-625"><a href="#cb10-625" aria-hidden="true" tabindex="-1"></a><span class="fu">### Applying functions to dimensions {#sec-applydimension}</span></span>
<span id="cb10-626"><a href="#cb10-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-627"><a href="#cb10-627" aria-hidden="true" tabindex="-1"></a>\index{data cube!apply function to dimension}</span>
<span id="cb10-628"><a href="#cb10-628" aria-hidden="true" tabindex="-1"></a>\index{dimension!apply function to dimension}</span>
<span id="cb10-629"><a href="#cb10-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-630"><a href="#cb10-630" aria-hidden="true" tabindex="-1"></a>A common analysis involves applying a function over one or more</span>
<span id="cb10-631"><a href="#cb10-631" aria-hidden="true" tabindex="-1"></a>cube dimensions. Simple cases arise where a function such as <span class="in">`abs`</span>,</span>
<span id="cb10-632"><a href="#cb10-632" aria-hidden="true" tabindex="-1"></a><span class="in">`sin`</span>, or <span class="in">`sqrt`</span> is applied to all values in the cube, or when a function</span>
<span id="cb10-633"><a href="#cb10-633" aria-hidden="true" tabindex="-1"></a>takes all values in the cube and returns a single scalar, such as when</span>
<span id="cb10-634"><a href="#cb10-634" aria-hidden="true" tabindex="-1"></a>computing the mean or maximum value over the entire cube. Other</span>
<span id="cb10-635"><a href="#cb10-635" aria-hidden="true" tabindex="-1"></a>options include applying the function to selected dimensions,</span>
<span id="cb10-636"><a href="#cb10-636" aria-hidden="true" tabindex="-1"></a>such as applying a _temporal_ low-pass filter to every individual</span>
<span id="cb10-637"><a href="#cb10-637" aria-hidden="true" tabindex="-1"></a>(pixel/band) time series as shown in @fig-cube4apply1,</span>
<span id="cb10-638"><a href="#cb10-638" aria-hidden="true" tabindex="-1"></a>or applying a _spatial_ low-pass filter to every spatial</span>
<span id="cb10-639"><a href="#cb10-639" aria-hidden="true" tabindex="-1"></a>slice for every band/time combination, shown in </span>
<span id="cb10-640"><a href="#cb10-640" aria-hidden="true" tabindex="-1"></a>@fig-cube4apply2.</span>
<span id="cb10-641"><a href="#cb10-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-642"><a href="#cb10-642" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-cube4apply1, echo=!knitr::is_latex_output()}</span></span>
<span id="cb10-643"><a href="#cb10-643" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.width: 10</span></span>
<span id="cb10-644"><a href="#cb10-644" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.height: 7</span></span>
<span id="cb10-645"><a href="#cb10-645" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Low-pass filtering of time series"</span></span>
<span id="cb10-646"><a href="#cb10-646" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb10-647"><a href="#cb10-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-648"><a href="#cb10-648" aria-hidden="true" tabindex="-1"></a><span class="in">print_text = function(s, x, y, m) {</span></span>
<span id="cb10-649"><a href="#cb10-649" aria-hidden="true" tabindex="-1"></a><span class="in">  # m &lt;- t(m) # transverse for correct order</span></span>
<span id="cb10-650"><a href="#cb10-650" aria-hidden="true" tabindex="-1"></a><span class="in">  # print(m)</span></span>
<span id="cb10-651"><a href="#cb10-651" aria-hidden="true" tabindex="-1"></a><span class="in">  r &lt;- rep(seq(0.5, 5.5, 1), 7)</span></span>
<span id="cb10-652"><a href="#cb10-652" aria-hidden="true" tabindex="-1"></a><span class="in">  r &lt;- r + x # consider offsets</span></span>
<span id="cb10-653"><a href="#cb10-653" aria-hidden="true" tabindex="-1"></a><span class="in">  u &lt;- c(rep(0.5, 6), rep(1.5, 6), rep(2.5, 6), </span></span>
<span id="cb10-654"><a href="#cb10-654" aria-hidden="true" tabindex="-1"></a><span class="in">         rep(3.5, 6), rep(4.5, 6), rep(5.5, 6), rep(6.5, 6))</span></span>
<span id="cb10-655"><a href="#cb10-655" aria-hidden="true" tabindex="-1"></a><span class="in">  u &lt;- u + y # offset</span></span>
<span id="cb10-656"><a href="#cb10-656" aria-hidden="true" tabindex="-1"></a><span class="in">  tab &lt;- matrix(c(r,u), nrow = 42, byrow = FALSE) # make point table</span></span>
<span id="cb10-657"><a href="#cb10-657" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i in 1:42) {</span></span>
<span id="cb10-658"><a href="#cb10-658" aria-hidden="true" tabindex="-1"></a><span class="in">    #text(tab[i, 1], tab[i, 2], labels = paste0("", m[i]), cex = 1.1)</span></span>
<span id="cb10-659"><a href="#cb10-659" aria-hidden="true" tabindex="-1"></a><span class="in">    text(tab[i, 1], tab[i, 2], labels = paste0("", m[i]), cex = 0.8)</span></span>
<span id="cb10-660"><a href="#cb10-660" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb10-661"><a href="#cb10-661" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-662"><a href="#cb10-662" aria-hidden="true" tabindex="-1"></a><span class="in">time_arrow_seg &lt;- matrix(c(c(-1.0, 0.3, 1.5, 2.7, 3.9, 5.1), c(-1.0, 0.3, 1.5, 2.7, 3.9, 5.1),</span></span>
<span id="cb10-663"><a href="#cb10-663" aria-hidden="true" tabindex="-1"></a><span class="in">                           c(-0.5, 0.7, 1.9, 3.1, 4.3, 5.6), c(-0.5, 0.7, 1.9, 3.1, 4.3, 5.6)), ncol = 4)</span></span>
<span id="cb10-664"><a href="#cb10-664" aria-hidden="true" tabindex="-1"></a><span class="in">time_arrow_flag_seg &lt;- matrix(c(c(-1.0, 1.5, 2.7, 3.9), c(-1.0, 1.5, 2.7, 3.9),</span></span>
<span id="cb10-665"><a href="#cb10-665" aria-hidden="true" tabindex="-1"></a><span class="in">                                c(0.7, 1.9, 3.1, 5.6), c(0.7, 1.9, 3.1, 5.6)), ncol = 4)</span></span>
<span id="cb10-666"><a href="#cb10-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-667"><a href="#cb10-667" aria-hidden="true" tabindex="-1"></a><span class="in">b11 &lt;- b2 - t1</span></span>
<span id="cb10-668"><a href="#cb10-668" aria-hidden="true" tabindex="-1"></a><span class="in">b12 &lt;- b1 - t2 + t1</span></span>
<span id="cb10-669"><a href="#cb10-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-670"><a href="#cb10-670" aria-hidden="true" tabindex="-1"></a><span class="in">brks &lt;- seq(0, 1000, 50)</span></span>
<span id="cb10-671"><a href="#cb10-671" aria-hidden="true" tabindex="-1"></a><span class="in"># png("exp_apply_ts.png", width = 2400, height = 1000, pointsize = 24)</span></span>
<span id="cb10-672"><a href="#cb10-672" aria-hidden="true" tabindex="-1"></a><span class="in">plot.new()</span></span>
<span id="cb10-673"><a href="#cb10-673" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = c(2,2,2,2))</span></span>
<span id="cb10-674"><a href="#cb10-674" aria-hidden="true" tabindex="-1"></a><span class="in">x &lt;- 30</span></span>
<span id="cb10-675"><a href="#cb10-675" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- 10 # 7.5</span></span>
<span id="cb10-676"><a href="#cb10-676" aria-hidden="true" tabindex="-1"></a><span class="in">plot.window(xlim = c(0, x), ylim = c(0, y), asp = 1)</span></span>
<span id="cb10-677"><a href="#cb10-677" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 4.8, 3.8, pal = blues, m = b3, breaks = brks)</span></span>
<span id="cb10-678"><a href="#cb10-678" aria-hidden="true" tabindex="-1"></a><span class="in">print_text(s, 4.8, 3.8, m = b3)</span></span>
<span id="cb10-679"><a href="#cb10-679" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 3.6, 2.6, pal = blues, m = b11, breaks = brks)</span></span>
<span id="cb10-680"><a href="#cb10-680" aria-hidden="true" tabindex="-1"></a><span class="in">print_text(s, 3.6, 2.6, m = b11)</span></span>
<span id="cb10-681"><a href="#cb10-681" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 2.4, 1.4, pal = blues, m = b12, breaks = brks)</span></span>
<span id="cb10-682"><a href="#cb10-682" aria-hidden="true" tabindex="-1"></a><span class="in">print_text(s, 2.4, 1.4, m = b12)</span></span>
<span id="cb10-683"><a href="#cb10-683" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 1.2, .2, pal = blues, m = b2, breaks = brks)</span></span>
<span id="cb10-684"><a href="#cb10-684" aria-hidden="true" tabindex="-1"></a><span class="in">print_text(s, 1.2, .2, m = b2)</span></span>
<span id="cb10-685"><a href="#cb10-685" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 0, -1, pal = blues, m = b1, breaks = brks)</span></span>
<span id="cb10-686"><a href="#cb10-686" aria-hidden="true" tabindex="-1"></a><span class="in">print_text(s, 0, -1, m = b1) # print text on left first stack</span></span>
<span id="cb10-687"><a href="#cb10-687" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 24.8, 3.8, pal = alpha(greys, 0.1), m = matrix(rep("NA", 42), ncol = 7))</span></span>
<span id="cb10-688"><a href="#cb10-688" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 23.6, 2.6, pal = blues, m = (b12 + b11 + b3) / 3, breaks = brks)</span></span>
<span id="cb10-689"><a href="#cb10-689" aria-hidden="true" tabindex="-1"></a><span class="in">print_text(s, 23.6, 2.6, m = floor((b12 + b11 + b3) / 3))</span></span>
<span id="cb10-690"><a href="#cb10-690" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 22.4, 1.4, pal = blues, m = (b2 + b12 + b11) / 3, breaks = brks)</span></span>
<span id="cb10-691"><a href="#cb10-691" aria-hidden="true" tabindex="-1"></a><span class="in">print_text(s, 22.4, 1.4, m = floor((b2 + b12 + b11) / 3))</span></span>
<span id="cb10-692"><a href="#cb10-692" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 21.2, .2, pal = blues, m = (b1 + b2 + b12) / 3, breaks = brks)</span></span>
<span id="cb10-693"><a href="#cb10-693" aria-hidden="true" tabindex="-1"></a><span class="in">print_text(s, 21.2, .2, m = floor((b1 + b2 + b12) / 3))</span></span>
<span id="cb10-694"><a href="#cb10-694" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 20, -1, pal = alpha(greys, 0.1), m = matrix(rep("NA", 42), ncol = 7))</span></span>
<span id="cb10-695"><a href="#cb10-695" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments(5.7, 1.7, seg = time_arrow_seg, col = "forestgreen")</span></span>
<span id="cb10-696"><a href="#cb10-696" aria-hidden="true" tabindex="-1"></a><span class="in">arrows(12.5, 9, 20, 9, lwd = 2)</span></span>
<span id="cb10-697"><a href="#cb10-697" aria-hidden="true" tabindex="-1"></a><span class="in">cex &lt;- .9</span></span>
<span id="cb10-698"><a href="#cb10-698" aria-hidden="true" tabindex="-1"></a><span class="in">text(16.3, 8.3, "apply_dimension(dimension = 't')", cex = cex)</span></span>
<span id="cb10-699"><a href="#cb10-699" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments(9.7, 1.7, time_arrow_seg, col = "forestgreen") # draw ma explanation</span></span>
<span id="cb10-700"><a href="#cb10-700" aria-hidden="true" tabindex="-1"></a><span class="in">text(-0.5 + 10, -0.5 + 2, "496", cex = cex)</span></span>
<span id="cb10-701"><a href="#cb10-701" aria-hidden="true" tabindex="-1"></a><span class="in">text(.7 + 10, .7 + 2, "363", cex = cex)</span></span>
<span id="cb10-702"><a href="#cb10-702" aria-hidden="true" tabindex="-1"></a><span class="in">text(1.9 + 10, 1.9 + 2, "658", cex = cex)</span></span>
<span id="cb10-703"><a href="#cb10-703" aria-hidden="true" tabindex="-1"></a><span class="in">text(3.1 + 10, 3.1 + 2, "230", cex = cex)</span></span>
<span id="cb10-704"><a href="#cb10-704" aria-hidden="true" tabindex="-1"></a><span class="in">text(4.3 + 10, 4.3 + 2, "525", cex = cex)</span></span>
<span id="cb10-705"><a href="#cb10-705" aria-hidden="true" tabindex="-1"></a><span class="in">t_formula &lt;- expression("t"[n]*" = (t"[n-1]*" + t"[n]*" + t"[n+1]*") / 3")</span></span>
<span id="cb10-706"><a href="#cb10-706" aria-hidden="true" tabindex="-1"></a><span class="in"># text(13.8, 3, t_formula, srt = 45, cex = 1.2)</span></span>
<span id="cb10-707"><a href="#cb10-707" aria-hidden="true" tabindex="-1"></a><span class="in">text(14.4, 3.6, "calculate moving average", srt = 45, cex = cex)</span></span>
<span id="cb10-708"><a href="#cb10-708" aria-hidden="true" tabindex="-1"></a><span class="in">arrows(15, 5.7, 18, 5.7, lwd = 2)</span></span>
<span id="cb10-709"><a href="#cb10-709" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments(15.4, 1.7, seg = time_arrow_seg, col = "forestgreen") # draw ma explanation</span></span>
<span id="cb10-710"><a href="#cb10-710" aria-hidden="true" tabindex="-1"></a><span class="in">text(-0.5 + 15.7, -0.5 + 2, "NA", cex = cex)</span></span>
<span id="cb10-711"><a href="#cb10-711" aria-hidden="true" tabindex="-1"></a><span class="in">text(.7 + 15.7, .7 + 2, "505", cex = cex)</span></span>
<span id="cb10-712"><a href="#cb10-712" aria-hidden="true" tabindex="-1"></a><span class="in">text(1.9 + 15.7, 1.9 + 2, "417", cex = cex)</span></span>
<span id="cb10-713"><a href="#cb10-713" aria-hidden="true" tabindex="-1"></a><span class="in">text(3.1 + 15.7, 3.1 + 2, "471", cex = cex)</span></span>
<span id="cb10-714"><a href="#cb10-714" aria-hidden="true" tabindex="-1"></a><span class="in">text(4.3 + 15.7, 4.3 + 2, "NA", cex = cex)</span></span>
<span id="cb10-715"><a href="#cb10-715" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments(25.7, 1.7, seg = time_arrow_seg, col = "forestgreen")</span></span>
<span id="cb10-716"><a href="#cb10-716" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-717"><a href="#cb10-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-718"><a href="#cb10-718" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-cube4apply2, echo=!knitr::is_latex_output()}</span></span>
<span id="cb10-719"><a href="#cb10-719" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.height: 6</span></span>
<span id="cb10-720"><a href="#cb10-720" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.width: 10</span></span>
<span id="cb10-721"><a href="#cb10-721" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Low pass filtering of spatial slices"</span></span>
<span id="cb10-722"><a href="#cb10-722" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb10-723"><a href="#cb10-723" aria-hidden="true" tabindex="-1"></a><span class="in"># apply ----</span></span>
<span id="cb10-724"><a href="#cb10-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-725"><a href="#cb10-725" aria-hidden="true" tabindex="-1"></a><span class="in">abs_brks &lt;- seq(-500,500, 50)</span></span>
<span id="cb10-726"><a href="#cb10-726" aria-hidden="true" tabindex="-1"></a><span class="in">abs_pal &lt;- sequential_hcl(n = 20, h1 = 211, c1 = 80, l1 = 30, l2 = 100, p1 = 1.2)</span></span>
<span id="cb10-727"><a href="#cb10-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-728"><a href="#cb10-728" aria-hidden="true" tabindex="-1"></a><span class="in">vNeumann_seg &lt;- matrix(c(c(0,0,1,1,2,2,1,1,0,0,-1,-1), c(0,-1,-1,0,0,1,1,2,2,1,1,0), </span></span>
<span id="cb10-729"><a href="#cb10-729" aria-hidden="true" tabindex="-1"></a><span class="in">                         c(0,1,1,2,2,1,1,0,0,-1,-1,0), c(-1,-1,0,0,1,1,2,2,1,1,0,0)), ncol = 4)</span></span>
<span id="cb10-730"><a href="#cb10-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-731"><a href="#cb10-731" aria-hidden="true" tabindex="-1"></a><span class="in">apply_filter &lt;- function(input, pad = TRUE, padValue = 1) {</span></span>
<span id="cb10-732"><a href="#cb10-732" aria-hidden="true" tabindex="-1"></a><span class="in">  ras &lt;- raster::focal(raster::raster(input), w = matrix(c(0,0.2,0, 0.2,0.2,0.2, 0,0.2,0), ncol = 3), pad = pad, padValue = padValue)</span></span>
<span id="cb10-733"><a href="#cb10-733" aria-hidden="true" tabindex="-1"></a><span class="in">  ras &lt;- raster::as.matrix(ras)</span></span>
<span id="cb10-734"><a href="#cb10-734" aria-hidden="true" tabindex="-1"></a><span class="in">  ras[ras == "NaN"] &lt;- -999</span></span>
<span id="cb10-735"><a href="#cb10-735" aria-hidden="true" tabindex="-1"></a><span class="in">  return(floor(ras))</span></span>
<span id="cb10-736"><a href="#cb10-736" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-737"><a href="#cb10-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-738"><a href="#cb10-738" aria-hidden="true" tabindex="-1"></a><span class="in">brks &lt;- seq(0, 1000, 50)</span></span>
<span id="cb10-739"><a href="#cb10-739" aria-hidden="true" tabindex="-1"></a><span class="in">plot.new()</span></span>
<span id="cb10-740"><a href="#cb10-740" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = c(0,2,0,0))</span></span>
<span id="cb10-741"><a href="#cb10-741" aria-hidden="true" tabindex="-1"></a><span class="in">x = 30</span></span>
<span id="cb10-742"><a href="#cb10-742" aria-hidden="true" tabindex="-1"></a><span class="in">y = 7.5</span></span>
<span id="cb10-743"><a href="#cb10-743" aria-hidden="true" tabindex="-1"></a><span class="in">plot.window(xlim = c(0, x), ylim = c(0, y), asp = 1)</span></span>
<span id="cb10-744"><a href="#cb10-744" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 3, 2, pal = blues, m = b3, breaks = brks)</span></span>
<span id="cb10-745"><a href="#cb10-745" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 1.5, .5, pal = blues, m = b2, breaks = brks)</span></span>
<span id="cb10-746"><a href="#cb10-746" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 0, -1, pal = blues, m = b1, breaks = brks)</span></span>
<span id="cb10-747"><a href="#cb10-747" aria-hidden="true" tabindex="-1"></a><span class="in">print_text(s, 0, -1, m = b1) # print text on left first stack</span></span>
<span id="cb10-748"><a href="#cb10-748" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments(2, 3, seg = vNeumann_seg, lwd = 3)</span></span>
<span id="cb10-749"><a href="#cb10-749" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 23, 2, pal = blues, m = apply_filter(b3), breaks = brks)</span></span>
<span id="cb10-750"><a href="#cb10-750" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 21.5, 0.5, pal = blues, m = apply_filter(b2), breaks = brks)</span></span>
<span id="cb10-751"><a href="#cb10-751" aria-hidden="true" tabindex="-1"></a><span class="in">pl(f, 20, -1, pal = blues, m = apply_filter(b1), breaks = brks)</span></span>
<span id="cb10-752"><a href="#cb10-752" aria-hidden="true" tabindex="-1"></a><span class="in">print_text(s, 20, -1, m = apply_filter(b1)) # set pad = FALSE for -99</span></span>
<span id="cb10-753"><a href="#cb10-753" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments(22, 3, seg = vNeumann_seg, lwd = 3)</span></span>
<span id="cb10-754"><a href="#cb10-754" aria-hidden="true" tabindex="-1"></a><span class="in">arrows(11, 4, 17.5, 4, lwd = 3)</span></span>
<span id="cb10-755"><a href="#cb10-755" aria-hidden="true" tabindex="-1"></a><span class="in">text(14.3, 3.5, "apply_kernel()", cex = 1.4)</span></span>
<span id="cb10-756"><a href="#cb10-756" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments(13.8, 1, seg = vNeumann_seg, lwd = 3)</span></span>
<span id="cb10-757"><a href="#cb10-757" aria-hidden="true" tabindex="-1"></a><span class="in">cex = .8</span></span>
<span id="cb10-758"><a href="#cb10-758" aria-hidden="true" tabindex="-1"></a><span class="in">text(14.3, 1.5, "0.2", cex = cex)</span></span>
<span id="cb10-759"><a href="#cb10-759" aria-hidden="true" tabindex="-1"></a><span class="in">text(13.3, 1.5, "0.2", cex = cex)</span></span>
<span id="cb10-760"><a href="#cb10-760" aria-hidden="true" tabindex="-1"></a><span class="in">text(15.3, 1.5, "0.2", cex = cex)</span></span>
<span id="cb10-761"><a href="#cb10-761" aria-hidden="true" tabindex="-1"></a><span class="in">text(14.3, 2.5, "0.2", cex = cex)</span></span>
<span id="cb10-762"><a href="#cb10-762" aria-hidden="true" tabindex="-1"></a><span class="in">text(14.3, .5, "0.2", cex = cex)</span></span>
<span id="cb10-763"><a href="#cb10-763" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-764"><a href="#cb10-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-765"><a href="#cb10-765" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reducing dimensions {#sec-reducedimension}</span></span>
<span id="cb10-766"><a href="#cb10-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-767"><a href="#cb10-767" aria-hidden="true" tabindex="-1"></a>\index{dimension!reduce}</span>
<span id="cb10-768"><a href="#cb10-768" aria-hidden="true" tabindex="-1"></a>\index{reduce dimension}</span>
<span id="cb10-769"><a href="#cb10-769" aria-hidden="true" tabindex="-1"></a>\index{data cube!reduce dimension}</span>
<span id="cb10-770"><a href="#cb10-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-771"><a href="#cb10-771" aria-hidden="true" tabindex="-1"></a>When applying function <span class="in">`mean`</span> to an entire data cube, all dimensions</span>
<span id="cb10-772"><a href="#cb10-772" aria-hidden="true" tabindex="-1"></a>vanish: the resulting "data cube" has dimensionality zero. We</span>
<span id="cb10-773"><a href="#cb10-773" aria-hidden="true" tabindex="-1"></a>can also apply functions to a limited set of dimensions such that</span>
<span id="cb10-774"><a href="#cb10-774" aria-hidden="true" tabindex="-1"></a>selected dimensions vanish, or are _reduced_. We already saw that</span>
<span id="cb10-775"><a href="#cb10-775" aria-hidden="true" tabindex="-1"></a>filtering is a special case of this, but more in general we could</span>
<span id="cb10-776"><a href="#cb10-776" aria-hidden="true" tabindex="-1"></a>for instance compute the maximum of every time series, the mean over</span>
<span id="cb10-777"><a href="#cb10-777" aria-hidden="true" tabindex="-1"></a>every spatial slice, or a band index such as NDVI that summarises</span>
<span id="cb10-778"><a href="#cb10-778" aria-hidden="true" tabindex="-1"></a>different spectral values into a single new "band" with the index</span>
<span id="cb10-779"><a href="#cb10-779" aria-hidden="true" tabindex="-1"></a>value. @fig-cube4reduce  illustrates these options.</span>
<span id="cb10-780"><a href="#cb10-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-781"><a href="#cb10-781" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-cube4reduce, echo=!knitr::is_latex_output()}</span></span>
<span id="cb10-782"><a href="#cb10-782" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.width: 10</span></span>
<span id="cb10-783"><a href="#cb10-783" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.height: 10</span></span>
<span id="cb10-784"><a href="#cb10-784" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Reducing data cube dimensions"</span></span>
<span id="cb10-785"><a href="#cb10-785" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb10-786"><a href="#cb10-786" aria-hidden="true" tabindex="-1"></a><span class="in"># reduce ----</span></span>
<span id="cb10-787"><a href="#cb10-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-788"><a href="#cb10-788" aria-hidden="true" tabindex="-1"></a><span class="in"># calc mean over time</span></span>
<span id="cb10-789"><a href="#cb10-789" aria-hidden="true" tabindex="-1"></a><span class="in">timeB &lt;- (b1 + b2 + b3) / 3</span></span>
<span id="cb10-790"><a href="#cb10-790" aria-hidden="true" tabindex="-1"></a><span class="in">timeG &lt;- (g1 + g2 + g3) / 3</span></span>
<span id="cb10-791"><a href="#cb10-791" aria-hidden="true" tabindex="-1"></a><span class="in">timeR &lt;- (r1 + r2 + r3) / 3</span></span>
<span id="cb10-792"><a href="#cb10-792" aria-hidden="true" tabindex="-1"></a><span class="in">timeN &lt;- (n1 + n2 + n3) / 3</span></span>
<span id="cb10-793"><a href="#cb10-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-794"><a href="#cb10-794" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_time &lt;- function(x, y) { # 3x1, 28x7</span></span>
<span id="cb10-795"><a href="#cb10-795" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 10+y, pal = blues, m = timeB)</span></span>
<span id="cb10-796"><a href="#cb10-796" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 7+x, 10+y, pal = greens, m = timeG)</span></span>
<span id="cb10-797"><a href="#cb10-797" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 14+x, 10+y, pal = reds, m = timeR)</span></span>
<span id="cb10-798"><a href="#cb10-798" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 21+x, 10+y, pal = purples, m = timeN)</span></span>
<span id="cb10-799"><a href="#cb10-799" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-800"><a href="#cb10-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-801"><a href="#cb10-801" aria-hidden="true" tabindex="-1"></a><span class="in"># calc ndvi</span></span>
<span id="cb10-802"><a href="#cb10-802" aria-hidden="true" tabindex="-1"></a><span class="in">ndvi1 &lt;- (n1 - r1) / (n1 + r1)</span></span>
<span id="cb10-803"><a href="#cb10-803" aria-hidden="true" tabindex="-1"></a><span class="in">ndvi2 &lt;- (n2 - r2) / (n2 + r2)</span></span>
<span id="cb10-804"><a href="#cb10-804" aria-hidden="true" tabindex="-1"></a><span class="in">ndvi3 &lt;- (n3 - r3) / (n3 + r3)</span></span>
<span id="cb10-805"><a href="#cb10-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-806"><a href="#cb10-806" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_bands &lt;- function(x, y, pal = greys) { # 1x3 6x27</span></span>
<span id="cb10-807"><a href="#cb10-807" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 0+y, pal = pal, m = ndvi1)</span></span>
<span id="cb10-808"><a href="#cb10-808" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 10+y, pal = pal, m = ndvi2)</span></span>
<span id="cb10-809"><a href="#cb10-809" aria-hidden="true" tabindex="-1"></a><span class="in">  pl(f, 0+x, 20+y, pal = pal, m = ndvi3)</span></span>
<span id="cb10-810"><a href="#cb10-810" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-811"><a href="#cb10-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-812"><a href="#cb10-812" aria-hidden="true" tabindex="-1"></a><span class="in">plte = function(s, x, y, add = TRUE, randomize = FALSE, pal, m) {</span></span>
<span id="cb10-813"><a href="#cb10-813" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[1]]$offset = x</span></span>
<span id="cb10-814"><a href="#cb10-814" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[2]]$offset = y</span></span>
<span id="cb10-815"><a href="#cb10-815" aria-hidden="true" tabindex="-1"></a><span class="in">  # m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span id="cb10-816"><a href="#cb10-816" aria-hidden="true" tabindex="-1"></a><span class="in">  # dim(m) = c(x = nrow, y = ncol) # named dim</span></span>
<span id="cb10-817"><a href="#cb10-817" aria-hidden="true" tabindex="-1"></a><span class="in">  # s[[1]] = m</span></span>
<span id="cb10-818"><a href="#cb10-818" aria-hidden="true" tabindex="-1"></a><span class="in">  # me &lt;- floor(mean(s[[1]]))</span></span>
<span id="cb10-819"><a href="#cb10-819" aria-hidden="true" tabindex="-1"></a><span class="in">  me &lt;- floor(mean(m))</span></span>
<span id="cb10-820"><a href="#cb10-820" aria-hidden="true" tabindex="-1"></a><span class="in">  if (me[1] &gt; 100) { # in case non-artificial grids with very high</span></span>
<span id="cb10-821"><a href="#cb10-821" aria-hidden="true" tabindex="-1"></a><span class="in">    me &lt;- m / 10     # numbers are used, make them smaller</span></span>
<span id="cb10-822"><a href="#cb10-822" aria-hidden="true" tabindex="-1"></a><span class="in">    me &lt;- floor(mean(me))</span></span>
<span id="cb10-823"><a href="#cb10-823" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb10-824"><a href="#cb10-824" aria-hidden="true" tabindex="-1"></a><span class="in">  text(x,y,me,cex = 0.8)</span></span>
<span id="cb10-825"><a href="#cb10-825" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-826"><a href="#cb10-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-827"><a href="#cb10-827" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_spat &lt;- function(x, y) {</span></span>
<span id="cb10-828"><a href="#cb10-828" aria-hidden="true" tabindex="-1"></a><span class="in">  x = x + 3</span></span>
<span id="cb10-829"><a href="#cb10-829" aria-hidden="true" tabindex="-1"></a><span class="in">  y = y + 3.5</span></span>
<span id="cb10-830"><a href="#cb10-830" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 0+x, 0+y, pal = blues, m = b1)</span></span>
<span id="cb10-831"><a href="#cb10-831" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 0+x, 10+y, pal = blues, m = b2)</span></span>
<span id="cb10-832"><a href="#cb10-832" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 0+x, 20+y, pal = blues, m = b3)</span></span>
<span id="cb10-833"><a href="#cb10-833" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 7+x, 0+y, pal = greens, m = g1)</span></span>
<span id="cb10-834"><a href="#cb10-834" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 7+x, 10+y, pal = greens, m = g2)</span></span>
<span id="cb10-835"><a href="#cb10-835" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 7+x, 20+y, pal = greens, m = g3)</span></span>
<span id="cb10-836"><a href="#cb10-836" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 14+x, 0+y, pal = reds, m = r1)</span></span>
<span id="cb10-837"><a href="#cb10-837" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 14+x, 10+y, pal = reds, m = r2)</span></span>
<span id="cb10-838"><a href="#cb10-838" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 14+x, 20+y, pal = reds, m = r3)</span></span>
<span id="cb10-839"><a href="#cb10-839" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 21+x, 0+y, pal = purples, m = n1)</span></span>
<span id="cb10-840"><a href="#cb10-840" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 21+x, 10+y, pal = purples, m = n2)</span></span>
<span id="cb10-841"><a href="#cb10-841" aria-hidden="true" tabindex="-1"></a><span class="in">  plte(s, 21+x, 20+y, pal = purples, m = n3)</span></span>
<span id="cb10-842"><a href="#cb10-842" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-843"><a href="#cb10-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-844"><a href="#cb10-844" aria-hidden="true" tabindex="-1"></a><span class="in"># png("exp_reduce.png", width = 1200, height = 1000, pointsize = 32)</span></span>
<span id="cb10-845"><a href="#cb10-845" aria-hidden="true" tabindex="-1"></a><span class="in">plot.new()</span></span>
<span id="cb10-846"><a href="#cb10-846" aria-hidden="true" tabindex="-1"></a><span class="in">#par(mar = c(3,3,3,3))</span></span>
<span id="cb10-847"><a href="#cb10-847" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = c(3,0,2,0))</span></span>
<span id="cb10-848"><a href="#cb10-848" aria-hidden="true" tabindex="-1"></a><span class="in">x = 120</span></span>
<span id="cb10-849"><a href="#cb10-849" aria-hidden="true" tabindex="-1"></a><span class="in">y = 100</span></span>
<span id="cb10-850"><a href="#cb10-850" aria-hidden="true" tabindex="-1"></a><span class="in">plot.window(xlim = c(0, x), ylim = c(0, y), asp = 1)</span></span>
<span id="cb10-851"><a href="#cb10-851" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid(x/2-28/2,y-27)</span></span>
<span id="cb10-852"><a href="#cb10-852" aria-hidden="true" tabindex="-1"></a><span class="in"># print_alpha_grid((x/3-28)/2, 0) # alpha grid</span></span>
<span id="cb10-853"><a href="#cb10-853" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_time((x/3-28)/2, 0) # off = 5.5</span></span>
<span id="cb10-854"><a href="#cb10-854" aria-hidden="true" tabindex="-1"></a><span class="in"># print_alpha_grid(x/3+((x/3-6)/2) -10.5, 0) # alpha grid</span></span>
<span id="cb10-855"><a href="#cb10-855" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_bands(x/3+((x/3-6)/2), 0)</span></span>
<span id="cb10-856"><a href="#cb10-856" aria-hidden="true" tabindex="-1"></a><span class="in">print_alpha_grid(2*(x/3)+((x/3-28)/2), 0, alp = 0, geom = TRUE) # alpha grid</span></span>
<span id="cb10-857"><a href="#cb10-857" aria-hidden="true" tabindex="-1"></a><span class="in">print_grid_spat(2*(x/3)+((x/3-28)/2), 0)</span></span>
<span id="cb10-858"><a href="#cb10-858" aria-hidden="true" tabindex="-1"></a><span class="in">text(3, 13.5, "time", srt = 90, col = "black")</span></span>
<span id="cb10-859"><a href="#cb10-859" aria-hidden="true" tabindex="-1"></a><span class="in">#segments(3.6, 8, 3.7, 19, col = "red", lwd=3)</span></span>
<span id="cb10-860"><a href="#cb10-860" aria-hidden="true" tabindex="-1"></a><span class="in">segments(3.4, 8, 3.4, 19, col = "red", lwd = 3)</span></span>
<span id="cb10-861"><a href="#cb10-861" aria-hidden="true" tabindex="-1"></a><span class="in">text(43, 13.5, "time", srt = 90, col = "black")</span></span>
<span id="cb10-862"><a href="#cb10-862" aria-hidden="true" tabindex="-1"></a><span class="in">text(83, 13.5, "time", srt = 90, col = "black")</span></span>
<span id="cb10-863"><a href="#cb10-863" aria-hidden="true" tabindex="-1"></a><span class="in">text(20, 30, "bands", col = "black")</span></span>
<span id="cb10-864"><a href="#cb10-864" aria-hidden="true" tabindex="-1"></a><span class="in">text(60, 30, "bands", col = "black")</span></span>
<span id="cb10-865"><a href="#cb10-865" aria-hidden="true" tabindex="-1"></a><span class="in">segments(53,29.8, 67,29.8, col = "red", lwd = 3)</span></span>
<span id="cb10-866"><a href="#cb10-866" aria-hidden="true" tabindex="-1"></a><span class="in">text(100, 30, "bands", col = "black")</span></span>
<span id="cb10-867"><a href="#cb10-867" aria-hidden="true" tabindex="-1"></a><span class="in">text(30, 7, "x", col = "black")</span></span>
<span id="cb10-868"><a href="#cb10-868" aria-hidden="true" tabindex="-1"></a><span class="in">text(36, 13, "y", col = "black")</span></span>
<span id="cb10-869"><a href="#cb10-869" aria-hidden="true" tabindex="-1"></a><span class="in">text(60, -3, "x", col = "black")</span></span>
<span id="cb10-870"><a href="#cb10-870" aria-hidden="true" tabindex="-1"></a><span class="in">text(66, 3, "y", col = "black")</span></span>
<span id="cb10-871"><a href="#cb10-871" aria-hidden="true" tabindex="-1"></a><span class="in">text(110, -3, "x", col = "black")</span></span>
<span id="cb10-872"><a href="#cb10-872" aria-hidden="true" tabindex="-1"></a><span class="in">text(116, 3, "y", col = "black")</span></span>
<span id="cb10-873"><a href="#cb10-873" aria-hidden="true" tabindex="-1"></a><span class="in">segments(108,-2.4, 112,-3.2, col = "red", lwd = 3)</span></span>
<span id="cb10-874"><a href="#cb10-874" aria-hidden="true" tabindex="-1"></a><span class="in">segments(114,3.2, 118,2.4, col = "red", lwd = 3)</span></span>
<span id="cb10-875"><a href="#cb10-875" aria-hidden="true" tabindex="-1"></a><span class="in">text(60, y+4, "bands", col = "black") # dim names on main</span></span>
<span id="cb10-876"><a href="#cb10-876" aria-hidden="true" tabindex="-1"></a><span class="in">text(43, y-14, "time", srt = 90, col = "black")</span></span>
<span id="cb10-877"><a href="#cb10-877" aria-hidden="true" tabindex="-1"></a><span class="in">text(x/2-28/2 + 24, y-30, "x", col = "black")</span></span>
<span id="cb10-878"><a href="#cb10-878" aria-hidden="true" tabindex="-1"></a><span class="in">text(x/2-28/2 + 30, y-24, "y", col = "black")</span></span>
<span id="cb10-879"><a href="#cb10-879" aria-hidden="true" tabindex="-1"></a><span class="in">arrows(x/2-28/2,y-30, x/6,32, angle = 20, lwd = 2)</span></span>
<span id="cb10-880"><a href="#cb10-880" aria-hidden="true" tabindex="-1"></a><span class="in">arrows(x/2,y-30, x/2,32, angle = 20, lwd = 2)</span></span>
<span id="cb10-881"><a href="#cb10-881" aria-hidden="true" tabindex="-1"></a><span class="in">arrows(x/2+28/2,y-30, 100, 32, angle = 20, lwd = 2)</span></span>
<span id="cb10-882"><a href="#cb10-882" aria-hidden="true" tabindex="-1"></a><span class="in"># points(seq(1,120,10), seq(1,120,10))</span></span>
<span id="cb10-883"><a href="#cb10-883" aria-hidden="true" tabindex="-1"></a><span class="in">text(28.5,49, "reduce temporally", srt = 55.5, col = "black", cex = 0.8)</span></span>
<span id="cb10-884"><a href="#cb10-884" aria-hidden="true" tabindex="-1"></a><span class="in">text(57,49, "reduce bands", srt = 90, col = "black", cex = 0.8)</span></span>
<span id="cb10-885"><a href="#cb10-885" aria-hidden="true" tabindex="-1"></a><span class="in">text(91.5,49, "reduce spatially", srt = -55.5, col = "black", cex = 0.8)</span></span>
<span id="cb10-886"><a href="#cb10-886" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-887"><a href="#cb10-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-888"><a href="#cb10-888" aria-hidden="true" tabindex="-1"></a><span class="fu">## Aggregating raster to vector cubes {#sec-vectordatacubes}</span></span>
<span id="cb10-889"><a href="#cb10-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-890"><a href="#cb10-890" aria-hidden="true" tabindex="-1"></a>\index{data cube!aggregate to vector cube}</span>
<span id="cb10-891"><a href="#cb10-891" aria-hidden="true" tabindex="-1"></a>\index{aggregate!data cube}</span>
<span id="cb10-892"><a href="#cb10-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-893"><a href="#cb10-893" aria-hidden="true" tabindex="-1"></a>@fig-cube4agg  illustrates how a four-dimensional raster</span>
<span id="cb10-894"><a href="#cb10-894" aria-hidden="true" tabindex="-1"></a>data cube can be aggregated to a three-dimensional _vector data</span>
<span id="cb10-895"><a href="#cb10-895" aria-hidden="true" tabindex="-1"></a>cube_. Pixels in the raster are grouped by spatial intersection</span>
<span id="cb10-896"><a href="#cb10-896" aria-hidden="true" tabindex="-1"></a>with a set of vector geometries, and each group is then reduced</span>
<span id="cb10-897"><a href="#cb10-897" aria-hidden="true" tabindex="-1"></a>to a single value by an aggregation function such as <span class="in">`mean`</span> or</span>
<span id="cb10-898"><a href="#cb10-898" aria-hidden="true" tabindex="-1"></a><span class="in">`max`</span>.  In the example, the _two_ spatial dimensions $x$ and $y$</span>
<span id="cb10-899"><a href="#cb10-899" aria-hidden="true" tabindex="-1"></a>reduce to a single dimension, the one-dimensional sequence of feature</span>
<span id="cb10-900"><a href="#cb10-900" aria-hidden="true" tabindex="-1"></a>geometries, with geometries that are defined in the space of $x$</span>
<span id="cb10-901"><a href="#cb10-901" aria-hidden="true" tabindex="-1"></a>and $y$.  Grouping geometries can also be <span class="in">`POINT`</span> geometries, in</span>
<span id="cb10-902"><a href="#cb10-902" aria-hidden="true" tabindex="-1"></a>which case the aggregation function is obsolete as single values</span>
<span id="cb10-903"><a href="#cb10-903" aria-hidden="true" tabindex="-1"></a>at the <span class="in">`POINT`</span> locations are _extracted_ by querying a pixel</span>
<span id="cb10-904"><a href="#cb10-904" aria-hidden="true" tabindex="-1"></a>value or by interpolating from the nearest pixels.</span>
<span id="cb10-905"><a href="#cb10-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-906"><a href="#cb10-906" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-cube4agg, echo=!knitr::is_latex_output()}</span></span>
<span id="cb10-907"><a href="#cb10-907" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Aggregating a raster data cube to a vector data cube"</span></span>
<span id="cb10-908"><a href="#cb10-908" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.width: 10</span></span>
<span id="cb10-909"><a href="#cb10-909" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.height: 8</span></span>
<span id="cb10-910"><a href="#cb10-910" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb10-911"><a href="#cb10-911" aria-hidden="true" tabindex="-1"></a><span class="in"># aggregate ----</span></span>
<span id="cb10-912"><a href="#cb10-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-913"><a href="#cb10-913" aria-hidden="true" tabindex="-1"></a><span class="in">mask_agg &lt;- matrix(c(NA,NA,NA,NA,NA,NA,</span></span>
<span id="cb10-914"><a href="#cb10-914" aria-hidden="true" tabindex="-1"></a><span class="in">                 NA, 1, 1,NA,NA,NA,</span></span>
<span id="cb10-915"><a href="#cb10-915" aria-hidden="true" tabindex="-1"></a><span class="in">                  1, 1,NA,NA, 1,NA,</span></span>
<span id="cb10-916"><a href="#cb10-916" aria-hidden="true" tabindex="-1"></a><span class="in">                  1,NA,NA, 1, 1,NA,</span></span>
<span id="cb10-917"><a href="#cb10-917" aria-hidden="true" tabindex="-1"></a><span class="in">                  1,NA,NA, 1, 1,NA,</span></span>
<span id="cb10-918"><a href="#cb10-918" aria-hidden="true" tabindex="-1"></a><span class="in">                  1,NA,NA,NA, 1,NA,</span></span>
<span id="cb10-919"><a href="#cb10-919" aria-hidden="true" tabindex="-1"></a><span class="in">                 NA,NA,NA,NA,NA,NA), ncol = 7)</span></span>
<span id="cb10-920"><a href="#cb10-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-921"><a href="#cb10-921" aria-hidden="true" tabindex="-1"></a><span class="in">pl_stack_agg &lt;- function(s, x, y, add = TRUE, nrM, imgY = 7, inner = 1) {</span></span>
<span id="cb10-922"><a href="#cb10-922" aria-hidden="true" tabindex="-1"></a><span class="in">  # pl_stack that masks the added matrices</span></span>
<span id="cb10-923"><a href="#cb10-923" aria-hidden="true" tabindex="-1"></a><span class="in">  # nrM is the timestep {1, 2, 3}, cause this function</span></span>
<span id="cb10-924"><a href="#cb10-924" aria-hidden="true" tabindex="-1"></a><span class="in">  # prints all 4 bands at once</span></span>
<span id="cb10-925"><a href="#cb10-925" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[1]]$offset = x</span></span>
<span id="cb10-926"><a href="#cb10-926" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[2]]$offset = y</span></span>
<span id="cb10-927"><a href="#cb10-927" aria-hidden="true" tabindex="-1"></a><span class="in">  # m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span id="cb10-928"><a href="#cb10-928" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- eval(parse(text=paste0("n", nrM)))</span></span>
<span id="cb10-929"><a href="#cb10-929" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- matrix(m[mask_agg == TRUE], ncol = 7)</span></span>
<span id="cb10-930"><a href="#cb10-930" aria-hidden="true" tabindex="-1"></a><span class="in">  s[[1]] = m[,c(imgY:1)] # turn around to have same orientation as flat plot</span></span>
<span id="cb10-931"><a href="#cb10-931" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 0, TRUE,  pal = purples)</span></span>
<span id="cb10-932"><a href="#cb10-932" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- eval(parse(text=paste0("r", nrM)))</span></span>
<span id="cb10-933"><a href="#cb10-933" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- matrix(m[mask_agg == TRUE], ncol = 7)</span></span>
<span id="cb10-934"><a href="#cb10-934" aria-hidden="true" tabindex="-1"></a><span class="in">  s[[1]] = m[,c(imgY:1)]</span></span>
<span id="cb10-935"><a href="#cb10-935" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 1*inner, TRUE,  pal = reds)</span></span>
<span id="cb10-936"><a href="#cb10-936" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- eval(parse(text=paste0("g", nrM)))</span></span>
<span id="cb10-937"><a href="#cb10-937" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- matrix(m[mask_agg == TRUE], ncol = 7)</span></span>
<span id="cb10-938"><a href="#cb10-938" aria-hidden="true" tabindex="-1"></a><span class="in">  s[[1]] = m[,c(imgY:1)]</span></span>
<span id="cb10-939"><a href="#cb10-939" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 2*inner, TRUE,  pal = greens)</span></span>
<span id="cb10-940"><a href="#cb10-940" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- eval(parse(text=paste0("b", nrM)))</span></span>
<span id="cb10-941"><a href="#cb10-941" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- matrix(m[mask_agg == TRUE], ncol = 7)</span></span>
<span id="cb10-942"><a href="#cb10-942" aria-hidden="true" tabindex="-1"></a><span class="in">  s[[1]] = m[,c(imgY:1)]</span></span>
<span id="cb10-943"><a href="#cb10-943" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 3*inner, TRUE, pal = blues) # li FALSE</span></span>
<span id="cb10-944"><a href="#cb10-944" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-945"><a href="#cb10-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-946"><a href="#cb10-946" aria-hidden="true" tabindex="-1"></a><span class="in">polygon_1 &lt;- matrix(c(c(0.0, 5.1, 4.9,-2.3), c(0.0, 2.4, 3.1, 1.8),</span></span>
<span id="cb10-947"><a href="#cb10-947" aria-hidden="true" tabindex="-1"></a><span class="in">                      c(5.1, 4.9,-2.3, 0.0), c(2.4, 3.1, 1.8, 0.0)), ncol = 4)</span></span>
<span id="cb10-948"><a href="#cb10-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-949"><a href="#cb10-949" aria-hidden="true" tabindex="-1"></a><span class="in">a &lt;- make_dummy_stars(6, 7, 5, -1.14, -2.28)</span></span>
<span id="cb10-950"><a href="#cb10-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-951"><a href="#cb10-951" aria-hidden="true" tabindex="-1"></a><span class="in">print_vector_content &lt;- function(x, y, cex = 0.8) {</span></span>
<span id="cb10-952"><a href="#cb10-952" aria-hidden="true" tabindex="-1"></a><span class="in">  vec &lt;- floor(rnorm(8, 250, 100))</span></span>
<span id="cb10-953"><a href="#cb10-953" aria-hidden="true" tabindex="-1"></a><span class="in">  text( 0 + x,12 + y, vec[1], cex = cex)</span></span>
<span id="cb10-954"><a href="#cb10-954" aria-hidden="true" tabindex="-1"></a><span class="in">  text( 0 + x, 8 + y, vec[2], cex = cex)</span></span>
<span id="cb10-955"><a href="#cb10-955" aria-hidden="true" tabindex="-1"></a><span class="in">  text( 0 + x, 4 + y, vec[3], cex = cex)</span></span>
<span id="cb10-956"><a href="#cb10-956" aria-hidden="true" tabindex="-1"></a><span class="in">  text( 0 + x, 0 + y, vec[4], cex = cex)</span></span>
<span id="cb10-957"><a href="#cb10-957" aria-hidden="true" tabindex="-1"></a><span class="in">  text( 12 + x,12 + y, vec[5], cex = cex)</span></span>
<span id="cb10-958"><a href="#cb10-958" aria-hidden="true" tabindex="-1"></a><span class="in">  text( 12 + x, 8 + y, vec[6], cex = cex)</span></span>
<span id="cb10-959"><a href="#cb10-959" aria-hidden="true" tabindex="-1"></a><span class="in">  text( 12 + x, 4 + y, vec[7], cex = cex)</span></span>
<span id="cb10-960"><a href="#cb10-960" aria-hidden="true" tabindex="-1"></a><span class="in">  text( 12 + x, 0 + y, vec[8], cex = cex)</span></span>
<span id="cb10-961"><a href="#cb10-961" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-962"><a href="#cb10-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-963"><a href="#cb10-963" aria-hidden="true" tabindex="-1"></a><span class="in">print_ts &lt;- function(off2, yoff2) {</span></span>
<span id="cb10-964"><a href="#cb10-964" aria-hidden="true" tabindex="-1"></a><span class="in">  pl_stack(s, 0 + off2, yoff2, nrM = 3) # input 2</span></span>
<span id="cb10-965"><a href="#cb10-965" aria-hidden="true" tabindex="-1"></a><span class="in">  pl_stack(s, off + off2, yoff2, nrM = 2)</span></span>
<span id="cb10-966"><a href="#cb10-966" aria-hidden="true" tabindex="-1"></a><span class="in">  pl_stack(s, 2 * off + off2, yoff2, nrM = 1)</span></span>
<span id="cb10-967"><a href="#cb10-967" aria-hidden="true" tabindex="-1"></a><span class="in">  arrows(-13 + off2, 14 + yoff2, 72 + off2, 14 + yoff2, angle = 20, lwd = 2)  # timeline</span></span>
<span id="cb10-968"><a href="#cb10-968" aria-hidden="true" tabindex="-1"></a><span class="in">  heads &lt;- matrix(c(3.5+off2, 3.5 + off + off2, 3.5 + 2*off + off2, 14+yoff2,14+yoff2,14+yoff2), ncol = 2)</span></span>
<span id="cb10-969"><a href="#cb10-969" aria-hidden="true" tabindex="-1"></a><span class="in">  points(heads, pch = 16) # 4 or 16</span></span>
<span id="cb10-970"><a href="#cb10-970" aria-hidden="true" tabindex="-1"></a><span class="in">  segments(c(-8, 7, 0, 15)+off2, c(-1,-1,3,3)+yoff2, 3.5+off2, 14+yoff2) # first stack pyramid</span></span>
<span id="cb10-971"><a href="#cb10-971" aria-hidden="true" tabindex="-1"></a><span class="in">  segments(c(-8, 7, 0, 15) + off + off2, c(-1,-1,3,3)+yoff2, 3.5 + off + off2, 14+yoff2) # second stack pyramid</span></span>
<span id="cb10-972"><a href="#cb10-972" aria-hidden="true" tabindex="-1"></a><span class="in">  segments(c(-8, 7, 0, 15) + 2*off + off2, c(-1,-1,3,3)+yoff2, 3.5 + 2*off + off2, 14+yoff2) # third stack pyramid</span></span>
<span id="cb10-973"><a href="#cb10-973" aria-hidden="true" tabindex="-1"></a><span class="in">  text(7.5+off2, 4.3+yoff2, "x", col = "black", cex = secText)</span></span>
<span id="cb10-974"><a href="#cb10-974" aria-hidden="true" tabindex="-1"></a><span class="in">  text(-9.5+off2, -2.5+yoff2, "bands", srt = 90, col = "black", cex = secText)</span></span>
<span id="cb10-975"><a href="#cb10-975" aria-hidden="true" tabindex="-1"></a><span class="in">  text(-4.5+off2, 2+yoff2, "y", srt = 27.5, col = "black", cex = secText)</span></span>
<span id="cb10-976"><a href="#cb10-976" aria-hidden="true" tabindex="-1"></a><span class="in">  text(69+off2, 15.5+yoff2+1, "time", col = "black")</span></span>
<span id="cb10-977"><a href="#cb10-977" aria-hidden="true" tabindex="-1"></a><span class="in">  text(3.5+off2, 15.5+yoff2, "2020-10-01", col = "black")</span></span>
<span id="cb10-978"><a href="#cb10-978" aria-hidden="true" tabindex="-1"></a><span class="in">  text(3.5 + off + off2, 15.5+yoff2, "2020-10-13", col = "black")</span></span>
<span id="cb10-979"><a href="#cb10-979" aria-hidden="true" tabindex="-1"></a><span class="in">  text(3.5 + 2*off + off2, 15.5+yoff2, "2020-10-25", col = "black")</span></span>
<span id="cb10-980"><a href="#cb10-980" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-981"><a href="#cb10-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-982"><a href="#cb10-982" aria-hidden="true" tabindex="-1"></a><span class="in">secText &lt;- 0.8 # secondary text size (dimension naming)</span></span>
<span id="cb10-983"><a href="#cb10-983" aria-hidden="true" tabindex="-1"></a><span class="in">off &lt;- 26 # image stacks are always 26 apart</span></span>
<span id="cb10-984"><a href="#cb10-984" aria-hidden="true" tabindex="-1"></a><span class="in">x &lt;- 72 # png X</span></span>
<span id="cb10-985"><a href="#cb10-985" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- 48 # png Y</span></span>
<span id="cb10-986"><a href="#cb10-986" aria-hidden="true" tabindex="-1"></a><span class="in">yoff &lt;- 30</span></span>
<span id="cb10-987"><a href="#cb10-987" aria-hidden="true" tabindex="-1"></a><span class="in">plot.new()</span></span>
<span id="cb10-988"><a href="#cb10-988" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = c(5,3,3,3))</span></span>
<span id="cb10-989"><a href="#cb10-989" aria-hidden="true" tabindex="-1"></a><span class="in">plot.window(xlim = c(-5, x+4), ylim = c(-1, y), asp = 1)</span></span>
<span id="cb10-990"><a href="#cb10-990" aria-hidden="true" tabindex="-1"></a><span class="in">print_ts(5, yoff)</span></span>
<span id="cb10-991"><a href="#cb10-991" aria-hidden="true" tabindex="-1"></a><span class="in">col &lt;- '#ff5555'</span></span>
<span id="cb10-992"><a href="#cb10-992" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments(10.57, yoff-.43, seg = polygon_1, col = col)</span></span>
<span id="cb10-993"><a href="#cb10-993" aria-hidden="true" tabindex="-1"></a><span class="in">x = 3</span></span>
<span id="cb10-994"><a href="#cb10-994" aria-hidden="true" tabindex="-1"></a><span class="in">segments(c(2, 0, -1.3)+x, c(-.2, 0, 1)+yoff, c(0, -1.3, 1)+x, c(0, 1, 2)+yoff, lwd = 4, col = col)</span></span>
<span id="cb10-995"><a href="#cb10-995" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments(10.57+off, yoff-.43, seg = polygon_1, col = col)</span></span>
<span id="cb10-996"><a href="#cb10-996" aria-hidden="true" tabindex="-1"></a><span class="in">x = 3 + off</span></span>
<span id="cb10-997"><a href="#cb10-997" aria-hidden="true" tabindex="-1"></a><span class="in">segments(c(2, 0, -1.3)+x, c(-.2, 0, 1)+yoff, c(0, -1.3, 1)+x, c(0, 1, 2)+yoff, lwd = 4, col = col)</span></span>
<span id="cb10-998"><a href="#cb10-998" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments(10.57+2*off, yoff-.43, seg = polygon_1, col = col)</span></span>
<span id="cb10-999"><a href="#cb10-999" aria-hidden="true" tabindex="-1"></a><span class="in">x = 3 + 2 * off</span></span>
<span id="cb10-1000"><a href="#cb10-1000" aria-hidden="true" tabindex="-1"></a><span class="in">segments(c(2, 0, -1.3)+x, c(-.2, 0, 1)+yoff, c(0, -1.3, 1)+x, c(0, 1, 2)+yoff, lwd = 4, col = col)</span></span>
<span id="cb10-1001"><a href="#cb10-1001" aria-hidden="true" tabindex="-1"></a><span class="in"># old 75 28 poly 86.25, 27.15</span></span>
<span id="cb10-1002"><a href="#cb10-1002" aria-hidden="true" tabindex="-1"></a><span class="in">pl_stack_agg(a, 5, 5, nrM = 1, inner = 3) # print masked enlargement</span></span>
<span id="cb10-1003"><a href="#cb10-1003" aria-hidden="true" tabindex="-1"></a><span class="in">print_segments(16.25, 7.15, seg = polygon_1, by = 2, col = col)</span></span>
<span id="cb10-1004"><a href="#cb10-1004" aria-hidden="true" tabindex="-1"></a><span class="in">x &lt;- 1</span></span>
<span id="cb10-1005"><a href="#cb10-1005" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- 8</span></span>
<span id="cb10-1006"><a href="#cb10-1006" aria-hidden="true" tabindex="-1"></a><span class="in">segments(c(4, 0, -2.6)+x, c(-.4, 0, 2)+y, c(0, -2.6, 2)+x, c(0, 2, 4)+y, lwd = 4, col = col) # line in large</span></span>
<span id="cb10-1007"><a href="#cb10-1007" aria-hidden="true" tabindex="-1"></a><span class="in">segments(-3, 25, -7, 9, lwd = 3, col = 'grey')</span></span>
<span id="cb10-1008"><a href="#cb10-1008" aria-hidden="true" tabindex="-1"></a><span class="in">segments(21, 29, 27.5, 14, lwd = 3, col = 'grey')</span></span>
<span id="cb10-1009"><a href="#cb10-1009" aria-hidden="true" tabindex="-1"></a><span class="in">text(10, 20, "1. Group by geometry", cex = 1.3)</span></span>
<span id="cb10-1010"><a href="#cb10-1010" aria-hidden="true" tabindex="-1"></a><span class="in">vecM &lt;- matrix(rep(1,8), ncol = 2)</span></span>
<span id="cb10-1011"><a href="#cb10-1011" aria-hidden="true" tabindex="-1"></a><span class="in">text(57, 21, "2. Reduce to vector cube", cex = 1.3)</span></span>
<span id="cb10-1012"><a href="#cb10-1012" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- make_dummy_stars(2, 4, 12, 4, 0)</span></span>
<span id="cb10-1013"><a href="#cb10-1013" aria-hidden="true" tabindex="-1"></a><span class="in">pl(b, 48, -5, m = vecM, pal = alpha("white", 0.9), border = 0)</span></span>
<span id="cb10-1014"><a href="#cb10-1014" aria-hidden="true" tabindex="-1"></a><span class="in">print_vector_content(54, -3)</span></span>
<span id="cb10-1015"><a href="#cb10-1015" aria-hidden="true" tabindex="-1"></a><span class="in">pl(b, 46.5, -3.5, m = vecM, pal = alpha("white", 0.9), border = 0)</span></span>
<span id="cb10-1016"><a href="#cb10-1016" aria-hidden="true" tabindex="-1"></a><span class="in">print_vector_content(52.5, -1.5)</span></span>
<span id="cb10-1017"><a href="#cb10-1017" aria-hidden="true" tabindex="-1"></a><span class="in">pl(b, 45, -2, m = vecM, pal = alpha("white", 0.9), border = 0)</span></span>
<span id="cb10-1018"><a href="#cb10-1018" aria-hidden="true" tabindex="-1"></a><span class="in">print_vector_content(51, 0)</span></span>
<span id="cb10-1019"><a href="#cb10-1019" aria-hidden="true" tabindex="-1"></a><span class="in">text(51.5, 15, "Line_1", col = col)</span></span>
<span id="cb10-1020"><a href="#cb10-1020" aria-hidden="true" tabindex="-1"></a><span class="in">text(63, 15, "Polygon_1", col = col)</span></span>
<span id="cb10-1021"><a href="#cb10-1021" aria-hidden="true" tabindex="-1"></a><span class="in">text(57, 17.5, "Geometries", cex = 1.1)</span></span>
<span id="cb10-1022"><a href="#cb10-1022" aria-hidden="true" tabindex="-1"></a><span class="in">text(42, 12, "blue")</span></span>
<span id="cb10-1023"><a href="#cb10-1023" aria-hidden="true" tabindex="-1"></a><span class="in">text(42,  8, "green")</span></span>
<span id="cb10-1024"><a href="#cb10-1024" aria-hidden="true" tabindex="-1"></a><span class="in">text(42,  4, "red")</span></span>
<span id="cb10-1025"><a href="#cb10-1025" aria-hidden="true" tabindex="-1"></a><span class="in">text(42,  0, "nir")</span></span>
<span id="cb10-1026"><a href="#cb10-1026" aria-hidden="true" tabindex="-1"></a><span class="in">text(38, 6, "Bands", srt = 90, cex = 1.1)</span></span>
<span id="cb10-1027"><a href="#cb10-1027" aria-hidden="true" tabindex="-1"></a><span class="in"># arrows(13.5, -2, 13.5, -6, angle = 20, lwd = 3)</span></span>
<span id="cb10-1028"><a href="#cb10-1028" aria-hidden="true" tabindex="-1"></a><span class="in">text(72, 15.5, "time", srt = 315, cex = 1.1)</span></span>
<span id="cb10-1029"><a href="#cb10-1029" aria-hidden="true" tabindex="-1"></a><span class="in">arrows(69.5, 15, 72.5, 12, angle = 20, lwd = 2)</span></span>
<span id="cb10-1030"><a href="#cb10-1030" aria-hidden="true" tabindex="-1"></a><span class="in"># print_segments(30, 35, seg = arrow_seg)</span></span>
<span id="cb10-1031"><a href="#cb10-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1032"><a href="#cb10-1032" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-1033"><a href="#cb10-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1034"><a href="#cb10-1034" aria-hidden="true" tabindex="-1"></a>Further examples of vector data cubes include air quality data,</span>
<span id="cb10-1035"><a href="#cb10-1035" aria-hidden="true" tabindex="-1"></a>where we could have $PM_{10}$ measurements over two dimensions,</span>
<span id="cb10-1036"><a href="#cb10-1036" aria-hidden="true" tabindex="-1"></a>as a sequence of</span>
<span id="cb10-1037"><a href="#cb10-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1038"><a href="#cb10-1038" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>monitoring stations, and</span>
<span id="cb10-1039"><a href="#cb10-1039" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>time intervals</span>
<span id="cb10-1040"><a href="#cb10-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1041"><a href="#cb10-1041" aria-hidden="true" tabindex="-1"></a>or where we consider time series of demographic or epidemiological</span>
<span id="cb10-1042"><a href="#cb10-1042" aria-hidden="true" tabindex="-1"></a>data, consisting of (population, disease) counts, with number</span>
<span id="cb10-1043"><a href="#cb10-1043" aria-hidden="true" tabindex="-1"></a>of persons by</span>
<span id="cb10-1044"><a href="#cb10-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1045"><a href="#cb10-1045" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>region, for a sequence of $n$ regions</span>
<span id="cb10-1046"><a href="#cb10-1046" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>age class, for $m$ age classes, and</span>
<span id="cb10-1047"><a href="#cb10-1047" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>year, for $p$ years</span>
<span id="cb10-1048"><a href="#cb10-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1049"><a href="#cb10-1049" aria-hidden="true" tabindex="-1"></a>which forms an array with $n m p$ elements. </span>
<span id="cb10-1050"><a href="#cb10-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1051"><a href="#cb10-1051" aria-hidden="true" tabindex="-1"></a>For spatial data science, handling vector and raster data cubes</span>
<span id="cb10-1052"><a href="#cb10-1052" aria-hidden="true" tabindex="-1"></a>is extremely useful, because many variables are both spatially</span>
<span id="cb10-1053"><a href="#cb10-1053" aria-hidden="true" tabindex="-1"></a>and temporaly varying, and because we often want to either change</span>
<span id="cb10-1054"><a href="#cb10-1054" aria-hidden="true" tabindex="-1"></a>dimensions or aggregate them out, but in a fully flexible manner</span>
<span id="cb10-1055"><a href="#cb10-1055" aria-hidden="true" tabindex="-1"></a>and order. Examples of changing dimensions are:</span>
<span id="cb10-1056"><a href="#cb10-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1057"><a href="#cb10-1057" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>interpolating air quality measurements to values on a regular grid (raster; @sec-interpolation)</span>
<span id="cb10-1058"><a href="#cb10-1058" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>estimating density maps from points or lines, for instance estimating the number of flights passing by per week within a range of 1 km (@sec-pointpatterns)</span>
<span id="cb10-1059"><a href="#cb10-1059" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>aggregating climate model predictions to summary indicators for administrative regions</span>
<span id="cb10-1060"><a href="#cb10-1060" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>combining Earth observation data from different sensors, such as MODIS (250~m pixels, every 16 days) with Sentinel-2 (10~m pixels, every 5 days)</span>
<span id="cb10-1061"><a href="#cb10-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1062"><a href="#cb10-1062" aria-hidden="true" tabindex="-1"></a>Examples of aggregating one or more full dimensions are assessments of:</span>
<span id="cb10-1063"><a href="#cb10-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1064"><a href="#cb10-1064" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>which air quality monitoring stations indicate unhealthy conditions (time)</span>
<span id="cb10-1065"><a href="#cb10-1065" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>which region has the highest increase in disease incidence (space, time)</span>
<span id="cb10-1066"><a href="#cb10-1066" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>global warming (global change in degrees Celcius per decade)</span>
<span id="cb10-1067"><a href="#cb10-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1068"><a href="#cb10-1068" aria-hidden="true" tabindex="-1"></a><span class="fu">## Switching dimension with attributes {#sec-switching}</span></span>
<span id="cb10-1069"><a href="#cb10-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1070"><a href="#cb10-1070" aria-hidden="true" tabindex="-1"></a>\index{data cube!switch dimension attribute}</span>
<span id="cb10-1071"><a href="#cb10-1071" aria-hidden="true" tabindex="-1"></a>\index{dimension!switch with attribute}</span>
<span id="cb10-1072"><a href="#cb10-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1073"><a href="#cb10-1073" aria-hidden="true" tabindex="-1"></a>When we accept that a dimension can also reflect an unordered,</span>
<span id="cb10-1074"><a href="#cb10-1074" aria-hidden="true" tabindex="-1"></a>categorical variable, then one can easily swap a set of attributes</span>
<span id="cb10-1075"><a href="#cb10-1075" aria-hidden="true" tabindex="-1"></a>for a single dimension, by replacing</span>
<span id="cb10-1076"><a href="#cb10-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1077"><a href="#cb10-1077" aria-hidden="true" tabindex="-1"></a>$$<span class="sc">\{</span>Z_1,Z_2,...,Z_p<span class="sc">\}</span> = f(D_1,D_2,...,D_n)$$</span>
<span id="cb10-1078"><a href="#cb10-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1079"><a href="#cb10-1079" aria-hidden="true" tabindex="-1"></a>with </span>
<span id="cb10-1080"><a href="#cb10-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1081"><a href="#cb10-1081" aria-hidden="true" tabindex="-1"></a>$$Z = f(D_1,D_2,...,D_n, D_{n+1})$$</span>
<span id="cb10-1082"><a href="#cb10-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1083"><a href="#cb10-1083" aria-hidden="true" tabindex="-1"></a>where $D_{n+1}$ has cardinality $p$ and has as labels (the names</span>
<span id="cb10-1084"><a href="#cb10-1084" aria-hidden="true" tabindex="-1"></a>of) $Z_1,Z_2,...,Z_p$.  @fig-aqdc  shows a vector data</span>
<span id="cb10-1085"><a href="#cb10-1085" aria-hidden="true" tabindex="-1"></a>cube for air quality stations where one cube dimension reflects</span>
<span id="cb10-1086"><a href="#cb10-1086" aria-hidden="true" tabindex="-1"></a>air quality parameters. When the $Z_i$ have incompatible measurement</span>
<span id="cb10-1087"><a href="#cb10-1087" aria-hidden="true" tabindex="-1"></a>units, as in @fig-aqdc, one would have to take care</span>
<span id="cb10-1088"><a href="#cb10-1088" aria-hidden="true" tabindex="-1"></a>when reducing the "parameter" dimension $D_{n+1}$: numeric functions</span>
<span id="cb10-1089"><a href="#cb10-1089" aria-hidden="true" tabindex="-1"></a>like <span class="in">`mean`</span> or <span class="in">`max`</span> would be meaningless. Counting the number of</span>
<span id="cb10-1090"><a href="#cb10-1090" aria-hidden="true" tabindex="-1"></a>variables that exceed their respective threshold values may however</span>
<span id="cb10-1091"><a href="#cb10-1091" aria-hidden="true" tabindex="-1"></a>be meaningful.</span>
<span id="cb10-1092"><a href="#cb10-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1093"><a href="#cb10-1093" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-aqdc, echo=!knitr::is_latex_output()}</span></span>
<span id="cb10-1094"><a href="#cb10-1094" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Vector data cube with air quality time series"</span></span>
<span id="cb10-1095"><a href="#cb10-1095" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.height: 7</span></span>
<span id="cb10-1096"><a href="#cb10-1096" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb10-1097"><a href="#cb10-1097" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1331)</span></span>
<span id="cb10-1098"><a href="#cb10-1098" aria-hidden="true" tabindex="-1"></a><span class="in">library(stars)</span></span>
<span id="cb10-1099"><a href="#cb10-1099" aria-hidden="true" tabindex="-1"></a><span class="in">library(colorspace)</span></span>
<span id="cb10-1100"><a href="#cb10-1100" aria-hidden="true" tabindex="-1"></a><span class="in">tif &lt;- system.file("tif/L7_ETMs.tif", package = "stars")</span></span>
<span id="cb10-1101"><a href="#cb10-1101" aria-hidden="true" tabindex="-1"></a><span class="in">r &lt;- read_stars(tif)</span></span>
<span id="cb10-1102"><a href="#cb10-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1103"><a href="#cb10-1103" aria-hidden="true" tabindex="-1"></a><span class="in">nrow &lt;- 5</span></span>
<span id="cb10-1104"><a href="#cb10-1104" aria-hidden="true" tabindex="-1"></a><span class="in">ncol &lt;- 8</span></span>
<span id="cb10-1105"><a href="#cb10-1105" aria-hidden="true" tabindex="-1"></a><span class="in">#m = matrix(runif(nrow * ncol), nrow = nrow, ncol = ncol)</span></span>
<span id="cb10-1106"><a href="#cb10-1106" aria-hidden="true" tabindex="-1"></a><span class="in">m &lt;- r[[1]][1:nrow,1:ncol,1]</span></span>
<span id="cb10-1107"><a href="#cb10-1107" aria-hidden="true" tabindex="-1"></a><span class="in">dim(m) &lt;- c(x = nrow, y = ncol) # named dim</span></span>
<span id="cb10-1108"><a href="#cb10-1108" aria-hidden="true" tabindex="-1"></a><span class="in">s &lt;- st_as_stars(m)</span></span>
<span id="cb10-1109"><a href="#cb10-1109" aria-hidden="true" tabindex="-1"></a><span class="in"># s</span></span>
<span id="cb10-1110"><a href="#cb10-1110" aria-hidden="true" tabindex="-1"></a><span class="in">attr(s, "dimensions")[[1]]$delta = 3 </span></span>
<span id="cb10-1111"><a href="#cb10-1111" aria-hidden="true" tabindex="-1"></a><span class="in">attr(s, "dimensions")[[2]]$delta = -.5</span></span>
<span id="cb10-1112"><a href="#cb10-1112" aria-hidden="true" tabindex="-1"></a><span class="in">attr(attr(s, "dimensions"), "raster")$affine = c(-1.2, 0.0)</span></span>
<span id="cb10-1113"><a href="#cb10-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1114"><a href="#cb10-1114" aria-hidden="true" tabindex="-1"></a><span class="in">plt &lt;- function(x, yoffset = 0, add, li = TRUE) {</span></span>
<span id="cb10-1115"><a href="#cb10-1115" aria-hidden="true" tabindex="-1"></a><span class="in">    attr(x, "dimensions")[[2]]$offset = attr(x, "dimensions")[[2]]$offset + yoffset </span></span>
<span id="cb10-1116"><a href="#cb10-1116" aria-hidden="true" tabindex="-1"></a><span class="in">    l = st_as_sf(x, as_points = FALSE)</span></span>
<span id="cb10-1117"><a href="#cb10-1117" aria-hidden="true" tabindex="-1"></a><span class="in">    pal = sf.colors(10)</span></span>
<span id="cb10-1118"><a href="#cb10-1118" aria-hidden="true" tabindex="-1"></a><span class="in">    if (li)</span></span>
<span id="cb10-1119"><a href="#cb10-1119" aria-hidden="true" tabindex="-1"></a><span class="in">        pal = lighten(pal, 0.3 + rnorm(1, 0, 0.1))</span></span>
<span id="cb10-1120"><a href="#cb10-1120" aria-hidden="true" tabindex="-1"></a><span class="in">    if (! add)</span></span>
<span id="cb10-1121"><a href="#cb10-1121" aria-hidden="true" tabindex="-1"></a><span class="in">        plot(l, axes = FALSE, breaks = "equal", pal = pal, reset = FALSE, border = grey(.75), key.pos = NULL, main = NULL, xlab = "time")</span></span>
<span id="cb10-1122"><a href="#cb10-1122" aria-hidden="true" tabindex="-1"></a><span class="in">    else</span></span>
<span id="cb10-1123"><a href="#cb10-1123" aria-hidden="true" tabindex="-1"></a><span class="in">        plot(l, axes = TRUE, breaks = "equal", pal = pal, add = TRUE, border = grey(.75))</span></span>
<span id="cb10-1124"><a href="#cb10-1124" aria-hidden="true" tabindex="-1"></a><span class="in">    u = st_union(l)</span></span>
<span id="cb10-1125"><a href="#cb10-1125" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(st_geometry(u), add = TRUE, col = NA, border = 'black', lwd = 2.5)</span></span>
<span id="cb10-1126"><a href="#cb10-1126" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-1127"><a href="#cb10-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1128"><a href="#cb10-1128" aria-hidden="true" tabindex="-1"></a><span class="in">pl &lt;- function(s, x, y, add = TRUE, randomize = FALSE) {</span></span>
<span id="cb10-1129"><a href="#cb10-1129" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[1]]$offset = x</span></span>
<span id="cb10-1130"><a href="#cb10-1130" aria-hidden="true" tabindex="-1"></a><span class="in">  attr(s, "dimensions")[[2]]$offset = y</span></span>
<span id="cb10-1131"><a href="#cb10-1131" aria-hidden="true" tabindex="-1"></a><span class="in">  m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span id="cb10-1132"><a href="#cb10-1132" aria-hidden="true" tabindex="-1"></a><span class="in">  if (randomize)</span></span>
<span id="cb10-1133"><a href="#cb10-1133" aria-hidden="true" tabindex="-1"></a><span class="in">    m = m[sample(y + 1:nrow),x + 1:ncol]</span></span>
<span id="cb10-1134"><a href="#cb10-1134" aria-hidden="true" tabindex="-1"></a><span class="in">  dim(m) = c(x = nrow, y = ncol) # named dim</span></span>
<span id="cb10-1135"><a href="#cb10-1135" aria-hidden="true" tabindex="-1"></a><span class="in">  s[[1]] = m</span></span>
<span id="cb10-1136"><a href="#cb10-1136" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 0, add)</span></span>
<span id="cb10-1137"><a href="#cb10-1137" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 1, TRUE)</span></span>
<span id="cb10-1138"><a href="#cb10-1138" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 2, TRUE)</span></span>
<span id="cb10-1139"><a href="#cb10-1139" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 3, TRUE)</span></span>
<span id="cb10-1140"><a href="#cb10-1140" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 4, TRUE)</span></span>
<span id="cb10-1141"><a href="#cb10-1141" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 5, TRUE)</span></span>
<span id="cb10-1142"><a href="#cb10-1142" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 6, TRUE)</span></span>
<span id="cb10-1143"><a href="#cb10-1143" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 7, TRUE)</span></span>
<span id="cb10-1144"><a href="#cb10-1144" aria-hidden="true" tabindex="-1"></a><span class="in">  plt(s, 8, TRUE, FALSE)</span></span>
<span id="cb10-1145"><a href="#cb10-1145" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb10-1146"><a href="#cb10-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1147"><a href="#cb10-1147" aria-hidden="true" tabindex="-1"></a><span class="in"># point vector data cube:</span></span>
<span id="cb10-1148"><a href="#cb10-1148" aria-hidden="true" tabindex="-1"></a><span class="in">plot.new()</span></span>
<span id="cb10-1149"><a href="#cb10-1149" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = c(5, 0, 5, 0))</span></span>
<span id="cb10-1150"><a href="#cb10-1150" aria-hidden="true" tabindex="-1"></a><span class="in">plot.window(xlim = c(-10, 16), ylim = c(-2,12), asp = 1)</span></span>
<span id="cb10-1151"><a href="#cb10-1151" aria-hidden="true" tabindex="-1"></a><span class="in">library(spacetime)</span></span>
<span id="cb10-1152"><a href="#cb10-1152" aria-hidden="true" tabindex="-1"></a><span class="in">data(air)</span></span>
<span id="cb10-1153"><a href="#cb10-1153" aria-hidden="true" tabindex="-1"></a><span class="in">de = st_geometry(st_normalize(st_as_sf(DE)))</span></span>
<span id="cb10-1154"><a href="#cb10-1154" aria-hidden="true" tabindex="-1"></a><span class="in"># </span></span>
<span id="cb10-1155"><a href="#cb10-1155" aria-hidden="true" tabindex="-1"></a><span class="in">pl(s, 0, 0, TRUE, randomize = TRUE)</span></span>
<span id="cb10-1156"><a href="#cb10-1156" aria-hidden="true" tabindex="-1"></a><span class="in">de = de * 6 + c(-7, 9)</span></span>
<span id="cb10-1157"><a href="#cb10-1157" aria-hidden="true" tabindex="-1"></a><span class="in">plot(de, add = TRUE, border = grey(.5))</span></span>
<span id="cb10-1158"><a href="#cb10-1158" aria-hidden="true" tabindex="-1"></a><span class="in">text(-10, 0, "time", srt = -90, col = 'black')</span></span>
<span id="cb10-1159"><a href="#cb10-1159" aria-hidden="true" tabindex="-1"></a><span class="in">text(-5,  7.5, "sensor location", srt = 25, col = 'black')</span></span>
<span id="cb10-1160"><a href="#cb10-1160" aria-hidden="true" tabindex="-1"></a><span class="in">text( 7,  10.5, "air quality parameter", srt = 0, col = 'black')</span></span>
<span id="cb10-1161"><a href="#cb10-1161" aria-hidden="true" tabindex="-1"></a><span class="in">text( 1.5,  8.5, expression(PM[10]), col = 'black', cex = .75)</span></span>
<span id="cb10-1162"><a href="#cb10-1162" aria-hidden="true" tabindex="-1"></a><span class="in">text( 4.5,  8.5, expression(NO[x]), col = 'black', cex = .75)</span></span>
<span id="cb10-1163"><a href="#cb10-1163" aria-hidden="true" tabindex="-1"></a><span class="in">text( 8,  8.5, expression(SO[4]), col = 'black', cex = .75)</span></span>
<span id="cb10-1164"><a href="#cb10-1164" aria-hidden="true" tabindex="-1"></a><span class="in">text( 11,  8.5, expression(O[3]), col = 'black', cex = .75)</span></span>
<span id="cb10-1165"><a href="#cb10-1165" aria-hidden="true" tabindex="-1"></a><span class="in">text( 14,  8.5, expression(CO), col = 'black', cex = .75)</span></span>
<span id="cb10-1166"><a href="#cb10-1166" aria-hidden="true" tabindex="-1"></a><span class="in"># location points:</span></span>
<span id="cb10-1167"><a href="#cb10-1167" aria-hidden="true" tabindex="-1"></a><span class="in">p &lt;- st_coordinates(s[,1])</span></span>
<span id="cb10-1168"><a href="#cb10-1168" aria-hidden="true" tabindex="-1"></a><span class="in">p[,1] &lt;- p[,1]-1.4</span></span>
<span id="cb10-1169"><a href="#cb10-1169" aria-hidden="true" tabindex="-1"></a><span class="in">p[,2] &lt;- p[,2] + 8.2</span></span>
<span id="cb10-1170"><a href="#cb10-1170" aria-hidden="true" tabindex="-1"></a><span class="in">points(p, col = grey(.7), pch = 16)</span></span>
<span id="cb10-1171"><a href="#cb10-1171" aria-hidden="true" tabindex="-1"></a><span class="in"># centroids:</span></span>
<span id="cb10-1172"><a href="#cb10-1172" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(131)</span></span>
<span id="cb10-1173"><a href="#cb10-1173" aria-hidden="true" tabindex="-1"></a><span class="in">cent &lt;- st_coordinates(st_sample(de, 8))</span></span>
<span id="cb10-1174"><a href="#cb10-1174" aria-hidden="true" tabindex="-1"></a><span class="in">points(cent, col = grey(.7), pch = 16)</span></span>
<span id="cb10-1175"><a href="#cb10-1175" aria-hidden="true" tabindex="-1"></a><span class="in">cent &lt;- cent[rev(order(cent[,1])),]</span></span>
<span id="cb10-1176"><a href="#cb10-1176" aria-hidden="true" tabindex="-1"></a><span class="in">seg &lt;- cbind(p, cent[1:8,])</span></span>
<span id="cb10-1177"><a href="#cb10-1177" aria-hidden="true" tabindex="-1"></a><span class="in">segments(seg[,1], seg[,2], seg[,3], seg[,4], col = 'grey')</span></span>
<span id="cb10-1178"><a href="#cb10-1178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-1179"><a href="#cb10-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1180"><a href="#cb10-1180" aria-hidden="true" tabindex="-1"></a>Being able to swap dimensions to attributes flexibly and vice versa</span>
<span id="cb10-1181"><a href="#cb10-1181" aria-hidden="true" tabindex="-1"></a>leads to highly flexible analysis possibilities <span class="co">[</span><span class="ot">@brown2010overview</span><span class="co">]</span>.</span>
<span id="cb10-1182"><a href="#cb10-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1183"><a href="#cb10-1183" aria-hidden="true" tabindex="-1"></a><span class="fu">## Other dynamic spatial data {#sec-otherdynamic}</span></span>
<span id="cb10-1184"><a href="#cb10-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1185"><a href="#cb10-1185" aria-hidden="true" tabindex="-1"></a>\index{trajectories}</span>
<span id="cb10-1186"><a href="#cb10-1186" aria-hidden="true" tabindex="-1"></a>\index{dynamic spatial data}</span>
<span id="cb10-1187"><a href="#cb10-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1188"><a href="#cb10-1188" aria-hidden="true" tabindex="-1"></a>We have seen several dynamic raster and vector data examples</span>
<span id="cb10-1189"><a href="#cb10-1189" aria-hidden="true" tabindex="-1"></a>that match the data cube structure well. Other data examples</span>
<span id="cb10-1190"><a href="#cb10-1190" aria-hidden="true" tabindex="-1"></a>do less so: in particular spatiotemporal point patterns</span>
<span id="cb10-1191"><a href="#cb10-1191" aria-hidden="true" tabindex="-1"></a>(@sec-pointpatterns) and trajectories [movement data; for a recent</span>
<span id="cb10-1192"><a href="#cb10-1192" aria-hidden="true" tabindex="-1"></a>review, see @https://doi.org/10.1111/1365-2656.13116] are often more</span>
<span id="cb10-1193"><a href="#cb10-1193" aria-hidden="true" tabindex="-1"></a>straightforward to not handle as a data cube. Spatiotemporal point</span>
<span id="cb10-1194"><a href="#cb10-1194" aria-hidden="true" tabindex="-1"></a>patterns are the sets of spatiotemporal coordinates of events or</span>
<span id="cb10-1195"><a href="#cb10-1195" aria-hidden="true" tabindex="-1"></a>objects: accidents, disease cases, traffic jams, lightning strikes,</span>
<span id="cb10-1196"><a href="#cb10-1196" aria-hidden="true" tabindex="-1"></a>and so on. Trajectory data are time sequences of spatial locations of</span>
<span id="cb10-1197"><a href="#cb10-1197" aria-hidden="true" tabindex="-1"></a>moving objects (persons, cars, satellites, animals).  For such data,</span>
<span id="cb10-1198"><a href="#cb10-1198" aria-hidden="true" tabindex="-1"></a>the primary information is in the coordinates, and shifting these</span>
<span id="cb10-1199"><a href="#cb10-1199" aria-hidden="true" tabindex="-1"></a>to a limited set of regularly discretised grid cells covering the</span>
<span id="cb10-1200"><a href="#cb10-1200" aria-hidden="true" tabindex="-1"></a>space may help some analysis, for instance to quickly explore patterns in</span>
<span id="cb10-1201"><a href="#cb10-1201" aria-hidden="true" tabindex="-1"></a>areas of higher densities, but the loss of the exact coordinates</span>
<span id="cb10-1202"><a href="#cb10-1202" aria-hidden="true" tabindex="-1"></a>also hinders a number of analysis approaches involving distance,</span>
<span id="cb10-1203"><a href="#cb10-1203" aria-hidden="true" tabindex="-1"></a>direction, or speed calculations. Nevertheless, for such data often</span>
<span id="cb10-1204"><a href="#cb10-1204" aria-hidden="true" tabindex="-1"></a>the first computational steps involves generation of data cube</span>
<span id="cb10-1205"><a href="#cb10-1205" aria-hidden="true" tabindex="-1"></a>representations by aggregating to a time-fixed spatial and/or</span>
<span id="cb10-1206"><a href="#cb10-1206" aria-hidden="true" tabindex="-1"></a>space-fixed temporal discretisation.</span>
<span id="cb10-1207"><a href="#cb10-1207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1208"><a href="#cb10-1208" aria-hidden="true" tabindex="-1"></a>Using sparse array representations of data cubes to represent</span>
<span id="cb10-1209"><a href="#cb10-1209" aria-hidden="true" tabindex="-1"></a>point pattern or trajectory data, which is possible for instance with SciDB</span>
<span id="cb10-1210"><a href="#cb10-1210" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@brown2010overview</span><span class="co">]</span> or TileDB <span class="co">[</span><span class="ot">@tiledb</span><span class="co">]</span>, may strongly limit the</span>
<span id="cb10-1211"><a href="#cb10-1211" aria-hidden="true" tabindex="-1"></a>loss of coordinate accuracy by choosing dimensions that represent</span>
<span id="cb10-1212"><a href="#cb10-1212" aria-hidden="true" tabindex="-1"></a>an extremely dense grid, and storing only those grid cells that</span>
<span id="cb10-1213"><a href="#cb10-1213" aria-hidden="true" tabindex="-1"></a>contain data points. For trajectory data, such representations</span>
<span id="cb10-1214"><a href="#cb10-1214" aria-hidden="true" tabindex="-1"></a>would need to add a grouping dimension to identify individuals,</span>
<span id="cb10-1215"><a href="#cb10-1215" aria-hidden="true" tabindex="-1"></a>or individual sequences of consecutive movement observations.</span>
<span id="cb10-1216"><a href="#cb10-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1217"><a href="#cb10-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1218"><a href="#cb10-1218" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises </span></span>
<span id="cb10-1219"><a href="#cb10-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1220"><a href="#cb10-1220" aria-hidden="true" tabindex="-1"></a>Use words to solve the following exercises. If needed or relevant</span>
<span id="cb10-1221"><a href="#cb10-1221" aria-hidden="true" tabindex="-1"></a>use R code to illustrate the argument(s).</span>
<span id="cb10-1222"><a href="#cb10-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1223"><a href="#cb10-1223" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Why is it difficult to represent trajectories, sequences of</span>
<span id="cb10-1224"><a href="#cb10-1224" aria-hidden="true" tabindex="-1"></a>$(x,y,t)$ obtained by tracking moving objects, by data cubes as</span>
<span id="cb10-1225"><a href="#cb10-1225" aria-hidden="true" tabindex="-1"></a>described in this chapter?</span>
<span id="cb10-1226"><a href="#cb10-1226" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>In a socio-economic vector data cube with variables population,</span>
<span id="cb10-1227"><a href="#cb10-1227" aria-hidden="true" tabindex="-1"></a>life expectancy, and gross domestic product ordered by dimensions country and</span>
<span id="cb10-1228"><a href="#cb10-1228" aria-hidden="true" tabindex="-1"></a>year, which variables have block support for the spatial dimension,</span>
<span id="cb10-1229"><a href="#cb10-1229" aria-hidden="true" tabindex="-1"></a>and which have block support for the temporal dimension?</span>
<span id="cb10-1230"><a href="#cb10-1230" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>The Sentinel-2 satellites collect images in 12 spectral bands;</span>
<span id="cb10-1231"><a href="#cb10-1231" aria-hidden="true" tabindex="-1"></a>list advantages and disadvantages to represent them as (i) different</span>
<span id="cb10-1232"><a href="#cb10-1232" aria-hidden="true" tabindex="-1"></a>data cubes, (ii) a data cube with 12 attributes, one for each band,</span>
<span id="cb10-1233"><a href="#cb10-1233" aria-hidden="true" tabindex="-1"></a>and (iii) a single attribute data cube with a spectral dimension.</span>
<span id="cb10-1234"><a href="#cb10-1234" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Explain why a curvilinear raster as shown in </span>
<span id="cb10-1235"><a href="#cb10-1235" aria-hidden="true" tabindex="-1"></a>@fig-rastertypes01 can be considered a special case of a</span>
<span id="cb10-1236"><a href="#cb10-1236" aria-hidden="true" tabindex="-1"></a>data cube.</span>
<span id="cb10-1237"><a href="#cb10-1237" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Explain how the following problems can be solved with data cube</span>
<span id="cb10-1238"><a href="#cb10-1238" aria-hidden="true" tabindex="-1"></a>operations <span class="in">`filter`</span>, <span class="in">`apply`</span>, <span class="in">`reduce`</span> and/or <span class="in">`aggregate`</span>, and</span>
<span id="cb10-1239"><a href="#cb10-1239" aria-hidden="true" tabindex="-1"></a>in which order. Also mention for each which function is applied,</span>
<span id="cb10-1240"><a href="#cb10-1240" aria-hidden="true" tabindex="-1"></a>and what the dimensionality of the resulting data cube is (if any):</span>
<span id="cb10-1241"><a href="#cb10-1241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1242"><a href="#cb10-1242" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>from hourly $PM_{10}$ measurements for a set of air quality</span>
<span id="cb10-1243"><a href="#cb10-1243" aria-hidden="true" tabindex="-1"></a>    monitoring stations, compute per station the amount of days</span>
<span id="cb10-1244"><a href="#cb10-1244" aria-hidden="true" tabindex="-1"></a>    per year that the average daily $PM_{10}$ value exceeds</span>
<span id="cb10-1245"><a href="#cb10-1245" aria-hidden="true" tabindex="-1"></a>    50 $\mu g/m^3$</span>
<span id="cb10-1246"><a href="#cb10-1246" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>for a sequence of aerial images of an oil spill, find the</span>
<span id="cb10-1247"><a href="#cb10-1247" aria-hidden="true" tabindex="-1"></a>    time at which the oil spill had its largest extent, and the</span>
<span id="cb10-1248"><a href="#cb10-1248" aria-hidden="true" tabindex="-1"></a>    corresponding extent</span>
<span id="cb10-1249"><a href="#cb10-1249" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>from a 10-year period with global daily sea surface temperature</span>
<span id="cb10-1250"><a href="#cb10-1250" aria-hidden="true" tabindex="-1"></a>    (SST) raster maps, find the area with the 10% largest and 10%</span>
<span id="cb10-1251"><a href="#cb10-1251" aria-hidden="true" tabindex="-1"></a>    smallest temporal trends in SST values.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/06-Cubes.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>