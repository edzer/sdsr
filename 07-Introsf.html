<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>7&nbsp; Introduction to sf and stars – Spatial Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./08-Plotting.html" rel="next">
<link href="./part-2.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-2ce9fc9ac8b614e7ffef13962cc12eaf.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-04YTZNEH1K"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
 
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'analytics_storage': 'denied'
  });
gtag('config', 'G-04YTZNEH1K', { 'anonymize_ip': true});
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-2.html">R for Spatial Data Science</a></li><li class="breadcrumb-item"><a href="./07-Introsf.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/edzer/sdsr/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-hello.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting Started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-Spaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Coordinates</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-Geometries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Spherical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spherical Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-Attributes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Attributes and Support</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-Cubes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R for Spatial Data Science</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-Introsf.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-Plotting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-Large.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Models for Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Statistical modelling of spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-PointPattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Point Pattern Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-Interpolation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-Geostatistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-Areal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-Measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of Spatial Autocorrelation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-SpatialRegression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-Econometrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Spatial Econometrics Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sp-raster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Older R Spatial Packages</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rbasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">R Basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ERRATA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Errata to the printed ed.</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#sec-sfintro" id="toc-sec-sfintro" class="nav-link active" data-scroll-target="#sec-sfintro"><span class="header-section-number">7.1</span> Package <strong>sf</strong></a>
  <ul class="collapse">
<li><a href="#creation" id="toc-creation" class="nav-link" data-scroll-target="#creation">Creation</a></li>
  <li><a href="#reading-and-writing" id="toc-reading-and-writing" class="nav-link" data-scroll-target="#reading-and-writing">Reading and writing</a></li>
  <li><a href="#subsetting" id="toc-subsetting" class="nav-link" data-scroll-target="#subsetting">Subsetting</a></li>
  <li><a href="#binary-predicates" id="toc-binary-predicates" class="nav-link" data-scroll-target="#binary-predicates">Binary predicates</a></li>
  <li><a href="#tidyverse" id="toc-tidyverse" class="nav-link" data-scroll-target="#tidyverse">tidyverse</a></li>
  </ul>
</li>
  <li>
<a href="#spatial-joins" id="toc-spatial-joins" class="nav-link" data-scroll-target="#spatial-joins"><span class="header-section-number">7.2</span> Spatial joins</a>
  <ul class="collapse">
<li><a href="#sampling-gridding-interpolating" id="toc-sampling-gridding-interpolating" class="nav-link" data-scroll-target="#sampling-gridding-interpolating">Sampling, gridding, interpolating</a></li>
  </ul>
</li>
  <li><a href="#sec-ccw" id="toc-sec-ccw" class="nav-link" data-scroll-target="#sec-ccw"><span class="header-section-number">7.3</span> Ellipsoidal coordinates</a></li>
  <li>
<a href="#package-stars" id="toc-package-stars" class="nav-link" data-scroll-target="#package-stars"><span class="header-section-number">7.4</span> Package <strong>stars</strong></a>
  <ul class="collapse">
<li><a href="#reading-and-writing-raster-data" id="toc-reading-and-writing-raster-data" class="nav-link" data-scroll-target="#reading-and-writing-raster-data">Reading and writing raster data</a></li>
  <li><a href="#subsetting-stars-data-cubes" id="toc-subsetting-stars-data-cubes" class="nav-link" data-scroll-target="#subsetting-stars-data-cubes">Subsetting <code>stars</code> data cubes</a></li>
  <li><a href="#cropping" id="toc-cropping" class="nav-link" data-scroll-target="#cropping">Cropping</a></li>
  <li><a href="#redimensioning-and-combining-stars-objects" id="toc-redimensioning-and-combining-stars-objects" class="nav-link" data-scroll-target="#redimensioning-and-combining-stars-objects">Redimensioning and combining <code>stars</code> objects</a></li>
  <li><a href="#extracting-point-samples-aggregating" id="toc-extracting-point-samples-aggregating" class="nav-link" data-scroll-target="#extracting-point-samples-aggregating">Extracting point samples, aggregating</a></li>
  <li><a href="#sec-starspredict" id="toc-sec-starspredict" class="nav-link" data-scroll-target="#sec-starspredict">Predictive models</a></li>
  <li><a href="#plotting-raster-data" id="toc-plotting-raster-data" class="nav-link" data-scroll-target="#plotting-raster-data">Plotting raster data</a></li>
  <li><a href="#analysing-raster-data" id="toc-analysing-raster-data" class="nav-link" data-scroll-target="#analysing-raster-data">Analysing raster data</a></li>
  <li><a href="#curvilinear-rasters" id="toc-curvilinear-rasters" class="nav-link" data-scroll-target="#curvilinear-rasters">Curvilinear rasters</a></li>
  <li><a href="#gdal-utils" id="toc-gdal-utils" class="nav-link" data-scroll-target="#gdal-utils">GDAL utils</a></li>
  </ul>
</li>
  <li>
<a href="#vector-data-cube-examples" id="toc-vector-data-cube-examples" class="nav-link" data-scroll-target="#vector-data-cube-examples"><span class="header-section-number">7.5</span> Vector data cube examples</a>
  <ul class="collapse">
<li><a href="#example-aggregating-air-quality-time-series" id="toc-example-aggregating-air-quality-time-series" class="nav-link" data-scroll-target="#example-aggregating-air-quality-time-series">Example: aggregating air quality time series</a></li>
  <li><a href="#sec-oddc" id="toc-sec-oddc" class="nav-link" data-scroll-target="#sec-oddc">Example: Bristol origin-destination data cube</a></li>
  <li><a href="#tidy-array-data" id="toc-tidy-array-data" class="nav-link" data-scroll-target="#tidy-array-data">Tidy array data</a></li>
  <li><a href="#file-formats-for-vector-data-cubes" id="toc-file-formats-for-vector-data-cubes" class="nav-link" data-scroll-target="#file-formats-for-vector-data-cubes">File formats for vector data cubes</a></li>
  </ul>
</li>
  <li>
<a href="#sec-raster-to-vector" id="toc-sec-raster-to-vector" class="nav-link" data-scroll-target="#sec-raster-to-vector"><span class="header-section-number">7.6</span> Raster-to-vector, vector-to-raster</a>
  <ul class="collapse">
<li><a href="#vector-to-raster" id="toc-vector-to-raster" class="nav-link" data-scroll-target="#vector-to-raster">Vector-to-raster</a></li>
  </ul>
</li>
  <li>
<a href="#sec-projsf" id="toc-sec-projsf" class="nav-link" data-scroll-target="#sec-projsf"><span class="header-section-number">7.7</span> Coordinate transformations and conversions</a>
  <ul class="collapse">
<li><a href="#st_crs" id="toc-st_crs" class="nav-link" data-scroll-target="#st_crs"><code>st_crs</code></a></li>
  <li><a href="#st_transform-sf_project" id="toc-st_transform-sf_project" class="nav-link" data-scroll-target="#st_transform-sf_project"><code>st_transform</code>, <code>sf_project</code></a></li>
  <li><a href="#sf_proj_info" id="toc-sf_proj_info" class="nav-link" data-scroll-target="#sf_proj_info"><code>sf_proj_info</code></a></li>
  <li><a href="#datum-grids-proj.db-cdn.proj.org-local-cache" id="toc-datum-grids-proj.db-cdn.proj.org-local-cache" class="nav-link" data-scroll-target="#datum-grids-proj.db-cdn.proj.org-local-cache">Datum grids, proj.db, cdn.proj.org, local cache</a></li>
  <li><a href="#sec-pipelines" id="toc-sec-pipelines" class="nav-link" data-scroll-target="#sec-pipelines">Transformation pipelines</a></li>
  <li><a href="#sec-axisorder" id="toc-sec-axisorder" class="nav-link" data-scroll-target="#sec-axisorder">Axis order and direction</a></li>
  </ul>
</li>
  <li><a href="#sec-warp" id="toc-sec-warp" class="nav-link" data-scroll-target="#sec-warp"><span class="header-section-number">7.8</span> Transforming and warping rasters</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">7.9</span> Exercises</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/07-Introsf.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-2.html">R for Spatial Data Science</a></li><li class="breadcrumb-item"><a href="./07-Introsf.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-sf" class="quarto-section-identifier"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p></p>
<p>This chapter introduces R packages <strong>sf</strong> and <strong>stars</strong>. <strong>sf</strong> provides a table format for simple features, where feature geometries are stored in a list-column. R package <strong>stars</strong> was written to support raster and vector data cubes (<a href="06-Cubes.html" class="quarto-xref"><span>Chapter 6</span></a>), supporting raster layers, raster stacks and feature time series as special cases. <strong>sf</strong> first appeared on CRAN in 2016, <strong>stars</strong> in 2018. Development of both packages received support from the R Consortium as well as strong community engagement. The packages were designed to work together. Functions or methods operating on <strong>sf</strong> or <strong>stars</strong> objects start with <code>st_</code>, making it easy to recognise them or to search for them when using command line completion.</p>
<section id="sec-sfintro" class="level2" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="sec-sfintro">
<span class="header-section-number">7.1</span> Package <strong>sf</strong>
</h2>
<p> </p>
<p>Intended to succeed and replace R packages <strong>sp</strong>, <strong>rgeos</strong> and the vector parts of <strong>rgdal</strong>, R package <strong>sf</strong> <span class="citation" data-cites="rjsf">(<a href="references.html#ref-rjsf" role="doc-biblioref">Pebesma 2018</a>)</span> was developed to move spatial data analysis in R closer to standards-based approaches seen in the industry and open source projects, to build upon more modern versions of the open source geospatial software stack (<a href="01-hello.html#fig-gdal-fig-nodetails" class="quarto-xref">Figure&nbsp;<span>1.7</span></a>), and to allow for integration of R spatial software with the tidyverse <span class="citation" data-cites="welcome">(<a href="references.html#ref-welcome" role="doc-biblioref">Wickham et al. 2019</a>)</span>, if desired.</p>
<p></p>
<p>To do so, R package <strong>sf</strong> provides simple features access <span class="citation" data-cites="herring2011opengis">(<a href="references.html#ref-herring2011opengis" role="doc-biblioref">Herring et al. 2011</a>)</span>, natively, to R. It provides an interface to several <strong>tidyverse</strong> packages, in particular to <strong>ggplot2</strong>, <strong>dplyr</strong>, and <strong>tidyr</strong>. It can read and write data through GDAL, execute geometrical operations using GEOS (for projected coordinates) or s2geometry (for ellipsoidal coordinates), and carry out coordinate transformations or conversions using PROJ. External C++ libraries are interfaced using R package <strong>Rcpp</strong> <span class="citation" data-cites="eddelbuettel2013seamless">(<a href="references.html#ref-eddelbuettel2013seamless" role="doc-biblioref">Eddelbuettel 2013</a>)</span>.</p>
<p> </p>
<p>Package <strong>sf</strong> represents sets of simple features in <code>sf</code> objects, a sub-class of a <code>data.frame</code> or tibble. <code>sf</code> objects contain at least one <em>geometry list-column</em> of class <code>sfc</code>, which for each element contains the geometry as an R object of class <code>sfg</code>. A geometry list-column acts as a variable in a <code>data.frame</code> or tibble, but has a more complex structure than basic vectors such as numeric or character variables <a href="rbasics.html#sec-dissecting" class="quarto-xref"><span>Section B.3</span></a>.</p>
<p> </p>
<p>An <code>sf</code> object has the following metadata:</p>
<ul>
<li>the name of the (active) geometry column, held in attribute <code>sf_column</code>
</li>
<li>for each non-geometry variable, the attribute-geometry relationship (<a href="05-Attributes.html#sec-agr" class="quarto-xref"><span>Section 5.1</span></a>), held in attribute <code>agr</code>
</li>
</ul>
<p> </p>
<p></p>
<p>An <code>sfc</code> geometry list-column is extracted from an <code>sf</code> object with <code>st_geometry</code> and has the following metadata:</p>
<ul>
<li>coordinate reference system held in attribute <code>crs</code>
</li>
<li>bounding box held in attribute <code>bbox</code>
</li>
<li>precision held in attribute <code>precision</code>
</li>
<li>number of empty geometries held in attribute <code>n_empty</code>
</li>
</ul>
<p> </p>
<p>These attributes may best be accessed or set by using functions like <code>st_bbox</code>, <code>st_crs</code>, <code>st_set_crs</code>, <code>st_agr</code>, <code>st_set_agr</code>, <code>st_precision</code>, and <code>st_set_precision</code>.</p>
<p>Geometry columns in <code>sf</code> objects can be set or replaced using <code>st_geometry&lt;-</code> or <code>st_set_geometry</code>.</p>
<section id="creation" class="level3"><h3 class="anchored" data-anchor-id="creation">Creation</h3>
<p> An <code>sf</code> object can be created from scratch by</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="co"># Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7.35</span>, <span class="fl">52.42</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7.22</span>, <span class="fl">52.18</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7.44</span>, <span class="fl">52.19</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sfc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span><span class="op">)</span>, crs <span class="op">=</span> <span class="st">'OGC:CRS84'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html">st_sf</a></span><span class="op">(</span>elev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">33.2</span>, <span class="fl">52.1</span>, <span class="fl">81.2</span><span class="op">)</span>, </span>
<span>      marker <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Id01"</span>, <span class="st">"Id02"</span>, <span class="st">"Id03"</span><span class="op">)</span>, geom <span class="op">=</span> <span class="va">sfc</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 3 features and 2 fields</span></span>
<span><span class="co"># Geometry type: POINT</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: 7.22 ymin: 52.2 xmax: 7.44 ymax: 52.4</span></span>
<span><span class="co"># Geodetic CRS:  WGS 84 (CRS84)</span></span>
<span><span class="co">#   elev marker              geom</span></span>
<span><span class="co"># 1 33.2   Id01 POINT (7.35 52.4)</span></span>
<span><span class="co"># 2 52.1   Id02 POINT (7.22 52.2)</span></span>
<span><span class="co"># 3 81.2   Id03 POINT (7.44 52.2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-sfobj" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-sfobj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/sf_obj.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sfobj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.1: components of an <code>sf</code> object
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-sfobj" class="quarto-xref">Figure&nbsp;<span>7.1</span></a> gives an explanation of the components printed. Rather than creating objects from scratch, spatial data in R are typically read from an external source, which can be:</p>
<p></p>
<ul>
<li>external file</li>
<li>table (or set of tables) in a database</li>
<li>request to a web service</li>
<li>dataset held in some form in another R package</li>
</ul>
<p>The next section introduces reading from files. <a href="09-Large.html#sec-largesf" class="quarto-xref"><span>Section 9.1</span></a> discusses handling of datasets too large to fit into working memory.</p>
</section><section id="reading-and-writing" class="level3"><h3 class="anchored" data-anchor-id="reading-and-writing">Reading and writing</h3>
<p>Reading datasets from an external “data source” (file, web service, or even string) is done using <code>st_read</code>:</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"gpkg/nc.gpkg"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] "/home/runner/work/_temp/Library/sf/gpkg/nc.gpkg"</span></span>
<span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span>
<span><span class="co"># Reading layer `nc.gpkg' from data source </span></span>
<span><span class="co">#   `/home/runner/work/_temp/Library/sf/gpkg/nc.gpkg' </span></span>
<span><span class="co">#   using driver `GPKG'</span></span>
<span><span class="co"># Simple feature collection with 100 features and 14 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.3 ymin: 33.9 xmax: -75.5 ymax: 36.6</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, the file name and path <code>file</code> is read from the <strong>sf</strong> package, which has a different path on every machine, and hence is guaranteed to be present on every <strong>sf</strong> installation.</p>
<p></p>
<p>Command <code>st_read</code> has two arguments: the <em>data source name</em> (<code>dsn</code>) and the <em>layer</em>. In the example above, the <em>geopackage</em> (GPKG) file contains only a single layer that is being read. If it had contained multiple layers, then the first layer would have been read and a warning would have been emitted. The available layers of a dataset can be queried by</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_layers.html">st_layers</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span>
<span><span class="co"># Driver: GPKG </span></span>
<span><span class="co"># Available layers:</span></span>
<span><span class="co">#   layer_name geometry_type features fields crs_name</span></span>
<span><span class="co"># 1    nc.gpkg Multi Polygon      100     14    NAD27</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Simple feature objects can be written with <code>st_write</code>, as in</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".gpkg"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] "/tmp/Rtmprf5Ri2/file33855538d150.gpkg"</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html">st_write</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">file</span>, layer <span class="op">=</span> <span class="st">"layer_nc"</span><span class="op">)</span></span>
<span><span class="co"># Writing layer `layer_nc' to data source </span></span>
<span><span class="co">#   `/tmp/Rtmprf5Ri2/file33855538d150.gpkg' using driver `GPKG'</span></span>
<span><span class="co"># Writing 100 features with 14 fields and geometry type Multi Polygon.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where the file format (GPKG) is derived from the file name extension. Using argument <code>append</code>, <code>st_write</code> can either append records to an existing layer or replace it; if unset, it will err if a layer already exists. The tidyverse-style <code>write_sf</code> will replace silently if <code>append</code> has not been set. Layers can also be deleted using <code>st_delete</code>, which is convenient in particular when they are associated with tables in a database.</p>
<p>For file formats supporting a WKT-2 coordinate reference system, <code>sf_read</code> and <code>sf_write</code> will read and write it. For simple formats such as <code>csv</code> this will not work. The shapefile format supports only a very limited encoding of the CRS.</p>
<p> </p>
</section><section id="subsetting" class="level3"><h3 class="anchored" data-anchor-id="subsetting">Subsetting</h3>
<p> </p>
<p>A very common operation is to subset objects; base R can use <code>[</code> for this. The rules that apply to <code>data.frame</code> objects also apply to <code>sf</code> objects: records 2-5 and columns 3-7 are selected by</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nc</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>but with a few additional features, in particular:</p>
<ul>
<li>the <code>drop</code> argument is by default <code>FALSE</code> meaning that the geometry column is <em>always</em> selected, and an <code>sf</code> object is returned; when it is set to <code>TRUE</code> and the geometry column is <em>not</em> selected, it is dropped and a <code>data.frame</code> is returned</li>
<li>selection with a spatial (<code>sf</code>, <code>sfc</code> or <code>sfg</code>) object as first argument leads to selection of the features that spatially <em>intersect</em> with that object (see next section); other predicates than <em>intersects</em> can be chosen by setting parameter <code>op</code> to a function such as <code>st_covers</code> or any other binary predicate function listed in <a href="03-Geometries.html#sec-de9im" class="quarto-xref"><span>Section 3.2.2</span></a>.</li>
</ul></section><section id="binary-predicates" class="level3"><h3 class="anchored" data-anchor-id="binary-predicates">Binary predicates</h3>
<p></p>
<p>Binary predicates like <code>st_intersects</code>, <code>st_covers</code> and such (<a href="03-Geometries.html#sec-de9im" class="quarto-xref"><span>Section 3.2.2</span></a>) take two sets of features or feature geometries and return for all pairs whether the predicate is <code>TRUE</code> or <code>FALSE</code>. For large sets this would potentially result in a huge matrix, typically filled mostly with <code>FALSE</code> values and for that reason a sparse representation is returned by default:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nc5</span> <span class="op">&lt;-</span> <span class="va">nc</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span></span>
<span><span class="va">nc7</span> <span class="op">&lt;-</span> <span class="va">nc</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>, <span class="op">]</span></span>
<span><span class="op">(</span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">nc5</span>, <span class="va">nc7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Sparse geometry binary predicate list of length 5, where the</span></span>
<span><span class="co"># predicate was `intersects'</span></span>
<span><span class="co">#  1: 1, 2</span></span>
<span><span class="co">#  2: 1, 2, 3</span></span>
<span><span class="co">#  3: 2, 3</span></span>
<span><span class="co">#  4: 4, 7</span></span>
<span><span class="co">#  5: 5, 6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">nc7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">nc5</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">"brown"</span><span class="op">)</span></span>
<span><span class="va">cc</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">nc7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">cc</span>, labels <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">nc7</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-fig57" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-fig57-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-fig57-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fig57-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.2: First seven North Carolina counties
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-fig57" class="quarto-xref">Figure&nbsp;<span>7.2</span></a> shows how the intersections of the first five with the first seven counties can be understood. We can transform the sparse logical matrix into a dense matrix by</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="co">#       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]</span></span>
<span><span class="co"># [1,]  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co"># [2,]  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co"># [3,] FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co"># [4,] FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE</span></span>
<span><span class="co"># [5,] FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The number of counties that each of <code>nc5</code> intersects with is</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html">lengths</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="co"># [1] 2 3 2 2 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and the other way around, the number of counties in <code>nc5</code> that intersect with each of the counties in <code>nc7</code> is</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html">lengths</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] 2 3 2 1 1 1 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The object <code>i</code> is of class <code>sgbp</code> (sparse geometrical binary predicate), and is a list of integer vectors, with each element representing a row in the logical predicate matrix holding the column indices of the <code>TRUE</code> values for that row. It further holds some metadata like the predicate used, and the total number of columns. Methods available for <code>sgbp</code> objects include</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"sgbp"</span><span class="op">)</span></span>
<span><span class="co">#  [1] as.data.frame as.matrix     coerce        dim          </span></span>
<span><span class="co">#  [5] initialize    Ops           print         show         </span></span>
<span><span class="co">#  [9] slotsFromS3   t            </span></span>
<span><span class="co"># see '?methods' for accessing help and source code</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where the only <code>Ops</code> method available is <code>!</code>, the negation operation.</p>
</section><section id="tidyverse" class="level3"><h3 class="anchored" data-anchor-id="tidyverse">tidyverse</h3>
<p> </p>
<p>The <strong>tidyverse</strong> package loads a collection of data science packages that work well together <span class="citation" data-cites="r4ds welcome">(<a href="references.html#ref-r4ds" role="doc-biblioref">Wickham and Grolemund 2017</a>; <a href="references.html#ref-welcome" role="doc-biblioref">Wickham et al. 2019</a>)</span>. Package <strong>sf</strong> has <strong>tidyverse</strong>-style read and write functions, <code>read_sf</code> and <code>write_sf</code> that</p>
<ul>
<li>return a tibble rather than a <code>data.frame</code>,</li>
<li>do not print any output, and</li>
<li>overwrite existing data by default.</li>
</ul>
<p>Further <strong>tidyverse</strong> generics with methods for <code>sf</code> objects include <code>filter</code>, <code>select</code>, <code>group_by</code>, <code>ungroup</code>, <code>mutate</code>, <code>transmute</code>, <code>rowwise</code>, <code>rename</code>, <code>slice</code>, <code>summarise</code>, <code>distinct</code>, <code>gather</code>, <code>pivot_longer</code>, <code>spread</code>, <code>nest</code>, <code>unnest</code>, <code>unite</code>, <code>separate</code>, <code>separate_rows</code>, <code>sample_n</code>, and <code>sample_frac</code>. Most of these methods simply manage the metadata of <code>sf</code> objects and make sure the geometry remains present. In case a user wants the geometry to be removed, one can use <code>st_drop_geometry</code> or simply coerce to a <code>tibble</code> or <code>data.frame</code> before selecting:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">nc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">BIR74</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 3 × 1</span></span>
<span><span class="co">#   BIR74</span></span>
<span><span class="co">#   &lt;dbl&gt;</span></span>
<span><span class="co"># 1  1091</span></span>
<span><span class="co"># 2   487</span></span>
<span><span class="co"># 3  3188</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The <code>summarise</code> method for <code>sf</code> objects has two special arguments:</p>
<ul>
<li>
<code>do_union</code> (default <code>TRUE</code>) determines whether grouped geometries are unioned on return, so that they form a valid geometry</li>
<li>
<code>is_coverage</code> (default <code>FALSE</code>) in case the geometries grouped form a coverage (do not have overlaps), setting this to <code>TRUE</code> speeds up the unioning</li>
</ul>
<p>The <code>distinct</code> method selects distinct records, where <code>st_equals</code> is used to evaluate distinctness of geometries.</p>
<p><code>filter</code> can be used with the usual predicates; when one wants to use it with a spatial predicate, for instance to select all counties less than 50 km away from Orange County, one could use</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">orange</span> <span class="op">&lt;-</span> <span class="va">nc</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op">==</span> <span class="st">"Orange"</span><span class="op">)</span></span>
<span><span class="va">wd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_is_within_distance</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">orange</span>, </span>
<span>                            <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="fl">50</span>, <span class="va">km</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">o50</span> <span class="op">&lt;-</span> <span class="va">nc</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html">lengths</a></span><span class="op">(</span><span class="va">wd</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">o50</span><span class="op">)</span></span>
<span><span class="co"># [1] 17</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(where we use <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter</a></code> rather than <code>filter</code> to avoid confusion with <code>filter</code> from base R.)</p>
<p><a href="#fig-orangebuffer" class="quarto-xref">Figure&nbsp;<span>7.3</span></a> shows the results of this analysis, and in addition a buffer around the county borders. Note that this buffer serves for illustration: it was <em>not</em> used to select the counties.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">og</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">orange</span><span class="op">)</span></span>
<span><span class="va">buf50</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">og</span>, <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="fl">50</span>, <span class="va">km</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">buf50</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">o50</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">o50</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, extent <span class="op">=</span> <span class="va">all</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">og</span>, col <span class="op">=</span> <span class="st">'orange'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">buf50</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">'brown'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">'grey'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-orangebuffer" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-orangebuffer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-orangebuffer-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-orangebuffer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.3: Orange County (orange), counties within a 50 km radius (black), a 50~km buffer around Orange County (brown), and remaining counties (grey)
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="spatial-joins" class="level2" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="spatial-joins">
<span class="header-section-number">7.2</span> Spatial joins</h2>
<p> </p>
<p>In regular (left, right, or inner) joins, <em>joined</em> records from a pair of tables are reported when one or more selected attributes match (are identical) in both tables. A spatial join is similar, but the criterion to join records is not equality of attributes but a spatial predicate. This leaves a wide variety of options in order to define <em>spatially</em> matching records, using binary predicates listed in <a href="03-Geometries.html#sec-de9im" class="quarto-xref"><span>Section 3.2.2</span></a>. The concepts of “left”, “right”, “inner”, or “full” joins remain identical to the non-spatial join as the options for handling records that have no spatial match.</p>
<p>When using spatial joins, each record may have several matched records, yielding a large result table. A way to reduce this complexity may be to select from the matching records the one with the largest overlap with the target geometry. An example of this is shown (visually) in <a href="#fig-largest" class="quarto-xref">Figure&nbsp;<span>7.4</span></a>; this is done using <code>st_join</code> with argument <code>largest = TRUE</code>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># example of largest = TRUE:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"gpkg/nc.gpkg"</span>, package<span class="op">=</span><span class="st">"sf"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="st">'EPSG:2264'</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nc</span></span>
<span><span class="va">gr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html">st_sf</a></span><span class="op">(</span></span>
<span>         label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="va">LETTERS</span><span class="op">[</span><span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">paste0</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>         geom <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">st_make_grid</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="va">col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">sf.colors</a></span><span class="op">(</span><span class="fl">10</span>, categorical <span class="op">=</span> <span class="cn">TRUE</span>, alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span></span>
<span><span class="co"># cut, to verify that NA's work out:</span></span>
<span><span class="va">gr</span> <span class="op">&lt;-</span> <span class="va">gr</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="va">nc_j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">gr</span>, largest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">nc_j</span><span class="op">)</span>, border <span class="op">=</span> <span class="st">'grey'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="va">col</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, labels <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="va">label</span>, cex <span class="op">=</span> <span class="fl">.85</span><span class="op">)</span></span>
<span><span class="co"># the joined dataset:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">nc_j</span><span class="op">)</span>, border <span class="op">=</span> <span class="st">'grey'</span>, col <span class="op">=</span> <span class="va">nc_j</span><span class="op">$</span><span class="va">col</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">nc_j</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, labels <span class="op">=</span> <span class="va">nc_j</span><span class="op">$</span><span class="va">label</span>, cex <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span>, border <span class="op">=</span> <span class="st">'#88ff88aa'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-largest" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-largest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-largest-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-largest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.4: Example of <code>st_join</code> with <code>largest = TRUE</code>: the label of the polygon in the top figure with the largest intersection with polygons in the bottom figure is assigned to the polygons of the bottom figure.
</figcaption></figure>
</div>
</div>
</div>
<p> </p>
<p>Another way to reduce the result set is to use <code>aggregate</code> after a join, to merge all matching records, and union their geometries; see <a href="05-Attributes.html#sec-updownscaling" class="quarto-xref"><span>Section 5.4</span></a>.</p>
<section id="sampling-gridding-interpolating" class="level3"><h3 class="anchored" data-anchor-id="sampling-gridding-interpolating">Sampling, gridding, interpolating</h3>
<p>Several convenience functions are available in package <strong>sf</strong>, some of which will be discussed here. Function <code>st_sample</code> generates a sample of points randomly sampled from target geometries, where target geometries can be point, line, or polygon geometries. Sampling strategies can be (completely) random, regular, or (with polygons) triangular. <a href="11-PointPattern.html" class="quarto-xref"><span>Chapter 11</span></a> explains how spatial sampling (or point pattern simulation) methods available in package <strong>spatstat</strong> are interfaced through <code>st_sample</code>.</p>
<p>Function <code>st_make_grid</code> creates a square, rectangular, or hexagonal grid over a region, or points with the grid centres or corners. It was used to create the rectangular grid in <a href="#fig-largest" class="quarto-xref">Figure&nbsp;<span>7.4</span></a>.</p>
<p></p>
<p>Function <code>st_interpolate_aw</code> “interpolates” area values to new areas, as explained in <a href="05-Attributes.html#sec-area-weighted" class="quarto-xref"><span>Section 5.3</span></a>, both for intensive and extensive variables.</p>
<p> </p>
</section></section><section id="sec-ccw" class="level2" data-number="7.3"><h2 data-number="7.3" class="anchored" data-anchor-id="sec-ccw">
<span class="header-section-number">7.3</span> Ellipsoidal coordinates</h2>
<p>Unprojected data have ellipsoidal coordinates, expressed in degrees east and north. As explained in <a href="04-Spherical.html#sec-straight" class="quarto-xref"><span>Section 4.1</span></a>, “straight” lines between points are the curved shortest paths (“geodesic”). By default, <strong>sf</strong> uses geometrical operations from the <code>s2geometry</code> library, interfaced through the <strong>s2</strong> package <span class="citation" data-cites="R-s2">(<a href="references.html#ref-R-s2" role="doc-biblioref">Dunnington, Pebesma, and Rubak 2023</a>)</span>, and we see for instance that the point</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="st">"POINT(50 50.1)"</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="st">"OGC:CRS84"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pt</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>falls <em>inside</em> the polygon:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="st">"POLYGON((40 40, 60 40, 60 50, 40 50, 40 40))"</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="st">"OGC:CRS84"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">pt</span>, <span class="va">pol</span><span class="op">)</span></span>
<span><span class="co"># Sparse geometry binary predicate list of length 1, where the</span></span>
<span><span class="co"># predicate was `intersects'</span></span>
<span><span class="co">#  1: 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>as illustrated by <a href="#fig-figs2" class="quarto-xref">Figure&nbsp;<span>7.5</span></a> (left: straight lines on an orthographic projection centred at the plot area).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">1.2</span>, <span class="fl">.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ortho</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">"+proj=ortho +lon_0=50 +lat_0=45"</span><span class="op">)</span></span>
<span><span class="va">pol</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">ortho</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>axes <span class="op">=</span> <span class="cn">TRUE</span>, graticule <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                   main <span class="op">=</span> <span class="st">'s2geometry'</span><span class="op">)</span></span>
<span><span class="va">pt</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">ortho</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>add <span class="op">=</span> <span class="cn">TRUE</span>, pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="co"># second plot:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pol</span>, axes <span class="op">=</span> <span class="cn">TRUE</span>, graticule <span class="op">=</span> <span class="cn">TRUE</span>, main <span class="op">=</span> <span class="st">'GEOS'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pt</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-figs2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-figs2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-figs2-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-figs2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.5: Intersection depends on whether we use geodesics/great circle arcs (left: s2) or Cartesian coordinates (right)
</figcaption></figure>
</div>
</div>
</div>
<p>If one wants <strong>sf</strong> to use ellipsoidal coordinates as if they are Cartesian coordinates, the use of <strong>s2</strong> can be switched off:</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">old</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># Spherical geometry (s2) switched off</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">pol</span>, <span class="va">pt</span><span class="op">)</span></span>
<span><span class="co"># although coordinates are longitude/latitude, st_intersects assumes</span></span>
<span><span class="co"># that they are planar</span></span>
<span><span class="co"># Sparse geometry binary predicate list of length 1, where the</span></span>
<span><span class="co"># predicate was `intersects'</span></span>
<span><span class="co">#  1: (empty)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html">sf_use_s2</a></span><span class="op">(</span><span class="va">old</span><span class="op">)</span> <span class="co"># restore</span></span>
<span><span class="co"># Spherical geometry (s2) switched on</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and the intersection is empty, as illustrated by <a href="#fig-figs2" class="quarto-xref">Figure&nbsp;<span>7.5</span></a> (right: straight lines on an equidistant cylindrical projection). The warning indicates the planar assumption for ellipsoidal coordinates.</p>
<p>Use of <strong>s2</strong> can be switched off for reasons of performance or compatibility with legacy implementations. The underlying libraries, <strong>GEOS</strong> for Cartesian and <strong>s2geometry</strong> for spherical geometry (<a href="01-hello.html#fig-gdal-fig-nodetails" class="quarto-xref">Figure&nbsp;<span>1.7</span></a>) were developed with different motivations, and their use through <strong>sf</strong> differs in some respects:</p>
<ul>
<li>certain operations may be much faster in one compared to the other,</li>
<li>certain functions may be available in only one of them (like <code>st_relate</code> being only present in GEOS),</li>
<li>when using transformers, <strong>GEOS</strong> returns exterior polygon rings noded clockwise (<code>st_sfc(..., check_ring_dir = TRUE)</code> can be used to revert to counter-clockwise), <strong>s2geometry</strong> returns them counter-clockwise</li>
</ul></section><section id="package-stars" class="level2" data-number="7.4"><h2 data-number="7.4" class="anchored" data-anchor-id="package-stars">
<span class="header-section-number">7.4</span> Package <strong>stars</strong>
</h2>
<p> </p>
<p>Although package <strong>sp</strong> has always had limited support for raster data, over the last decade R package <strong>raster</strong> <span class="citation" data-cites="R-raster">(<a href="references.html#ref-R-raster" role="doc-biblioref">Hijmans 2023a</a>)</span> has clearly been dominant as the prime package for powerful, flexible, and scalable raster analysis. The raster data model of package <strong>raster</strong> (and its successor, <strong>terra</strong> <span class="citation" data-cites="R-terra">(<a href="references.html#ref-R-terra" role="doc-biblioref">Hijmans 2023b</a>)</span>) is that of a 2D regular raster, or a set of raster layers (“raster stack”). This aligns with the classical static “GIS view”, where the world is modelled as a set of layers, each representing a different theme. A lot of data available today however is dynamic, and comes as time series of rasters or raster stacks. A raster stack does not meaningfully reflect this, requiring the user to keep a register of which layer represents what.</p>
<p>Also, the <strong>raster</strong> package and its successor <strong>terra</strong> do an excellent job in scaling computations up to data sizes no larger than the local storage (the computer’s hard drives), and doing this fast. Recent datasets, however, including satellite imagery, climate model or weather forecasting data, often no longer fit in local storage (<a href="09-Large.html" class="quarto-xref"><span>Chapter 9</span></a>). Package <strong>spacetime</strong> <span class="citation" data-cites="spacetime2012 R-spacetime">(<a href="references.html#ref-spacetime2012" role="doc-biblioref">Pebesma 2012</a>, <a href="references.html#ref-R-spacetime" role="doc-biblioref">2022</a>)</span> did address the analysis of time series of vector geometries or raster grid cells, but did not extend to higher-dimensional arrays or datasets too large to fit in main memory.</p>
<p> </p>
<p>Here, we introduce package <strong>stars</strong> for analysing raster and vector data cubes. The package:</p>
<ul>
<li>allows for representing dynamic (time varying) raster stacks</li>
<li>aims at being scalable, also beyond local disk size</li>
<li>provides a strong integration of raster functions in the GDAL library</li>
<li>handles, in addition to regular grids, rotated, sheared, rectilinear, and curvilinear rasters (<a href="01-hello.html#fig-rastertypes01" class="quarto-xref">Figure&nbsp;<span>1.6</span></a>)</li>
<li>provides a tight integration with package <strong>sf</strong>
</li>
<li>handles array data with non-raster spatial dimensions, the <em>vector data cubes</em>
</li>
<li>follows the tidyverse design principles</li>
</ul>
<p>Vector data cubes include for instance time series for simple features, or spatial graph data such as potentially dynamic origin-destination matrices. The concept of spatial vector and raster data cubes was explained in <a href="06-Cubes.html" class="quarto-xref"><span>Chapter 6</span></a>. Irregular spacetime observations can be represented by <code>sftime</code> objects provided by package <strong>sftime</strong> <span class="citation" data-cites="R-sftime">(<a href="references.html#ref-R-sftime" role="doc-biblioref">Teickner, Pebesma, and Graeler 2022</a>)</span>, which extend <code>sf</code> objects with a time column (<a href="13-Geostatistics.html#sec-stgeos" class="quarto-xref"><span>Section 13.3</span></a>).</p>
<section id="reading-and-writing-raster-data" class="level3"><h3 class="anchored" data-anchor-id="reading-and-writing-raster-data">Reading and writing raster data</h3>
<p> </p>
<p>Raster data typically are read from a file. We use a dataset containing a section of Landsat 7 scene, with the six 30~m-resolution bands (bands 1-5 and 7) for a region covering the city of Olinda, Brazil. We can read the example GeoTIFF file holding a regular, non-rotated grid from the package <strong>stars</strong>:</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span></span>
<span><span class="co"># Loading required package: abind</span></span>
<span><span class="op">(</span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif     1      54     69 68.9      86  255</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="co"># band    1   6      NA    NA                NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where we see the offset, cell size, coordinate reference system, and dimensions. The dimension table contains the following fields for each dimension:</p>
<ul>
<li>
<code>from</code>: starting index</li>
<li>
<code>to</code>: ending index</li>
<li>
<code>offset</code>: dimension value at the start (edge) of the first pixel</li>
<li>
<code>delta</code>: cell size; negative <code>delta</code> values indicate that pixel index increases with decreasing dimension values</li>
<li>
<code>refsys</code>: reference system</li>
<li>
<code>point</code>: logical, indicates whether cell values have point support or cell support</li>
<li>
<code>x/y</code>: indicates whether a dimension is associated with a spatial raster x- or y-axis</li>
</ul>
<p>One further field, <code>values</code>, is hidden here as it is not used. For regular, rotated, or sheared grids or other regularly discretised dimensions (such as time), <code>offset</code> and <code>delta</code> are not <code>NA</code>; for irregular cases, <code>offset</code> and <code>delta</code> are <code>NA</code> and the <code>values</code> property contains one of:</p>
<ul>
<li>in case of a rectilinear spatial raster or irregular time dimension, the sequence of values or intervals</li>
<li>in case of a vector data cube, geometries associated with the spatial dimension</li>
<li>in case of a curvilinear raster, the matrix with coordinate values for each raster cell</li>
<li>in case of a discrete dimension, the band names or labels associated with the dimension values</li>
</ul>
<p>The object <code>r</code> is of class <code>stars</code> and is a simple list of length one, holding a three-dimensional array:</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co"># [1] 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">r</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># [1] "array"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">r</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#    x    y band </span></span>
<span><span class="co">#  349  352    6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and in addition holds an attribute with a dimensions table with all the metadata required to know what the array dimensions refer to, obtained by</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_dimensions</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can get the spatial extent of the array by</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#    xmin    ymin    xmax    ymax </span></span>
<span><span class="co">#  288776 9110729  298723 9120761</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Raster data can be written to the local disk using <code>write_stars</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".tif"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/write_stars.html">write_stars</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">tf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where again the data format (in this case, GeoTIFF) is derived from the file extension. As for simple features, reading and writing uses the GDAL library; the list of available drivers for raster data is obtained by</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_drivers.html">st_drivers</a></span><span class="op">(</span><span class="st">"raster"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="subsetting-stars-data-cubes" class="level3"><h3 class="anchored" data-anchor-id="subsetting-stars-data-cubes">Subsetting <code>stars</code> data cubes</h3>
<p> </p>
<p>Data cubes can be subsetted using the <code>[</code> operator, or using tidyverse verbs. The first option uses <code>[</code> with the following comma-separated arguments:</p>
<ul>
<li>attributes first (by name, index, or logical vector)</li>
<li>followed by each dimension.</li>
</ul>
<p>This means that <code>r[1:2, 101:200, , 5:10]</code> selects from <code>r</code> attributes 1-2, index 101-200 for dimension 1, and index 5-10 for dimension 3; omitting dimension 2 means that no subsetting takes place. For attributes, attribute name, index or logical vectors can be used. For dimensions, logical vectors are not supported. Selecting discontinuous ranges is supported only when it is a regular sequence. By default, <code>drop</code> is FALSE, when set to <code>TRUE</code> dimensions with a single value are dropped:</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">r</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">250</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#    x    y band </span></span>
<span><span class="co">#  100   50    1</span></span>
<span><span class="va">r</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">250</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fl">4</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#   x   y </span></span>
<span><span class="co"># 100  50</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For selecting particular ranges of dimension <em>values</em>, one can use <code>filter</code> (after loading <code>dplyr</code>):</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">x</span> <span class="op">&gt;</span> <span class="fl">289000</span>, <span class="va">x</span> <span class="op">&lt;</span> <span class="fl">290000</span><span class="op">)</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif     5      51     63 64.3      75  242</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x       1  35  289004  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="co"># band    1   6       1     1                NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which changes the offset of the <span class="math inline">\(x\)</span> dimension. Particular cube slices can also be obtained with <code>slice</code>, as in</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">band</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif    21      49     63 64.4      77  255</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#   from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x    1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y    1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which drops the singular dimension <code>band</code>. <code>mutate</code> can be used on <code>stars</code> objects to add new arrays as functions of existing ones, <code>transmute</code> drops existing ones.</p>
</section><section id="cropping" class="level3"><h3 class="anchored" data-anchor-id="cropping">Cropping</h3>
<p> </p>
<p>Further subsetting can be done using spatial objects of class <code>sf</code>, <code>sfc</code> or <code>bbox</code>, for instance</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="fl">500</span>, <span class="va">m</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r</span><span class="op">[</span><span class="va">b</span><span class="op">]</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max. NA's</span></span>
<span><span class="co"># L7_ETMs.tif    22      54     66 67.7    78.2  174 2184</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x     157 193  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y     159 194 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="co"># band    1   6      NA    NA                NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>selects the circular centre region with a diameter of 500 metre, which for the first band is shown in <a href="#fig-circr" class="quarto-xref">Figure&nbsp;<span>7.6</span></a>,</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">[</span><span class="va">b</span><span class="op">]</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">b</span>, border <span class="op">=</span> <span class="st">'brown'</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-circr" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-circr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-circr-1.png" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-circr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.6: Circular centre region of the Landsat 7 scene (band 1)
</figcaption></figure>
</div>
</div>
</div>
<p>where we see that pixels outside the spatial object are assigned <code>NA</code> values. This object still has dimension indexes relative to the <code>offset</code> and <code>delta</code> values of <code>r</code>; we can reset these to a new <code>offset</code> with</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">r</span><span class="op">[</span><span class="va">b</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_normalize.html">st_normalize</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_dimensions</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#      from to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x       1 37  293222  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y       1 36 9116258 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="co"># band    1  6      NA    NA                NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By default, the resulting raster is cropped to the extent of the selection object; an object with the same dimensions as the input object is obtained with</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">r</span><span class="op">[</span><span class="va">b</span>, crop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.   NA's</span></span>
<span><span class="co"># L7_ETMs.tif    22      54     66 67.7    78.2  174 731280</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="co"># band    1   6      NA    NA                NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cropping a <code>stars</code> object can alternatively be done directly with <code>st_crop</code>, as in</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">b</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="redimensioning-and-combining-stars-objects" class="level3"><h3 class="anchored" data-anchor-id="redimensioning-and-combining-stars-objects">Redimensioning and combining <code>stars</code> objects</h3>
<p> </p>
<p>Package <strong>stars</strong> uses package <strong>abind</strong> <span class="citation" data-cites="R-abind">(<a href="references.html#ref-R-abind" role="doc-biblioref">Plate and Heiberger 2016</a>)</span> for a number of array manipulations. One of them is <code>aperm</code> which transposes an array by permuting it. A method for <code>stars</code> objects is provided, and</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/aperm.html">aperm</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif     1      54     69 68.9      86  255</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># band    1   6      NA    NA                NA    NA    </span></span>
<span><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>permutes the order of dimensions of the resulting object.</p>
<p>Attributes and dimensions can be swapped, using <code>split</code> and <code>merge</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 6 attributes</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#     Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># X1    47      67     78 79.1      89  255</span></span>
<span><span class="co"># X2    32      55     66 67.6      79  255</span></span>
<span><span class="co"># X3    21      49     63 64.4      77  255</span></span>
<span><span class="co"># X4     9      52     63 59.2      75  255</span></span>
<span><span class="co"># X5     1      63     89 83.2     112  255</span></span>
<span><span class="co"># X6     1      32     60 60.0      88  255</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#   from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x    1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y    1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">rs</span>, name <span class="op">=</span> <span class="st">"band"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"L7_ETMs"</span><span class="op">)</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#          Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs     1      54     69 68.9      86  255</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to  offset delta            refsys point    values x/y</span></span>
<span><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE      NULL [x]</span></span>
<span><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE      NULL [y]</span></span>
<span><span class="co"># band    1   6      NA    NA                NA    NA X1,...,X6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>split</code> distributes the <code>band</code> dimension over six attributes of a two-dimensional array, <code>merge</code> reverses this operation. <code>st_redimension</code> can be used for more generic operations, such as splitting a single array dimension over two new dimensions:</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/redimension.html">st_redimension</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">349</span>, y <span class="op">=</span> <span class="fl">352</span>, b1 <span class="op">=</span> <span class="fl">3</span>, b2 <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars object with 4 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif     1      54     69 68.9      86  255</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#    from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x     1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y     1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="co"># b1    1   3      NA    NA                NA    NA    </span></span>
<span><span class="co"># b2    1   2      NA    NA                NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Multiple <code>stars</code> object with identical dimensions can be combined using <code>c</code>. By default, the arrays are combined as additional attributes, but by specifying an <code>along</code> argument, the arrays are merged along a new dimension:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">r</span>, along <span class="op">=</span> <span class="st">"new_dim"</span><span class="op">)</span></span>
<span><span class="co"># stars object with 4 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s), summary of first 1e+05 cells:</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif    47      65     76 77.3      87  255</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#         from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x          1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y          1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="co"># band       1   6      NA    NA                NA    NA    </span></span>
<span><span class="co"># new_dim    1   2      NA    NA                NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>the use of this is illustrated in <a href="#sec-oddc" class="quarto-xref"><span>Section 7.5.2</span></a>.</p>
</section><section id="extracting-point-samples-aggregating" class="level3"><h3 class="anchored" data-anchor-id="extracting-point-samples-aggregating">Extracting point samples, aggregating</h3>
<p> </p>
<p>A very common use case for raster data cube analysis is the extraction of values at certain locations, or computing aggregations over certain geometries. <code>st_extract</code> extracts point values. We will do this for a few randomly sampled points over the bounding box of <code>r</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">115517</span><span class="op">)</span></span>
<span><span class="va">pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html">st_sample</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">pts</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif    12    41.8     63   61    80.5  145</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#          from to            refsys point</span></span>
<span><span class="co"># geometry    1 20 SIRGAS 2000 / ...  TRUE</span></span>
<span><span class="co"># band        1  6                NA    NA</span></span>
<span><span class="co">#                                           values</span></span>
<span><span class="co"># geometry POINT (293002 ...,...,POINT (290941 ...</span></span>
<span><span class="co"># band                                        NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which results in a vector data cube with 20 points and 6 bands. (Setting the seed guarantees an identical sample when reproducing, it should not be set to generate further randomly generated points.)</p>
<p>Another way of extracting information from data cubes is by aggregating it. One way of doing this is by spatially aggregating values over spatial polygons or lines (<a href="06-Cubes.html#sec-vectordatacubes" class="quarto-xref"><span>Section 6.4</span></a>). We can for instance compute the maximum pixel value for each of the six bands and for each of the three circles shown in <a href="01-hello.html#fig-ras" class="quarto-xref">Figure&nbsp;<span>1.4</span></a> (d) by</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">circles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html">st_sample</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">circles</span>, <span class="va">max</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif    73    94.2    117  121     142  205</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#          from to            refsys point</span></span>
<span><span class="co"># geometry    1  3 SIRGAS 2000 / ... FALSE</span></span>
<span><span class="co"># band        1  6                NA    NA</span></span>
<span><span class="co">#                                           values</span></span>
<span><span class="co"># geometry POLYGON ((2913...,...,POLYGON ((2921...</span></span>
<span><span class="co"># band                                        NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which gives a (vector) data cube with three geometries and six bands. Aggregation over a temporal dimension is done by passing a time variable as the second argument to <code>aggregate</code>, as a</p>
<ul>
<li>set of time stamps indicating the start of time intervals,</li>
<li>set of time intervals defined by <code>make_intervals</code>, or</li>
<li>time period like <code>"weeks"</code>, <code>"5 days"</code>, or <code>"years"</code>.</li>
</ul></section><section id="sec-starspredict" class="level3"><h3 class="anchored" data-anchor-id="sec-starspredict">Predictive models</h3>
<p> </p>
<p>The typical model prediction workflow in R is as follows:</p>
<ul>
<li>use a <code>data.frame</code> with response and predictor variables (covariates)</li>
<li>create a model object based on this <code>data.frame</code>
</li>
<li>call <code>predict</code> with this model object and the <code>data.frame</code> with target predictor variable values</li>
</ul>
<p>Package <strong>stars</strong> provides a <code>predict</code> method for <code>stars</code> objects that essentially wraps the last step, by creating the <code>data.frame</code>, calling the <code>predict</code> method for that, and reconstructing a <code>stars</code> object with the predicted values.</p>
<p>We will illustrate this with a trivial two-class example mapping land from sea in the example Landsat dataset, using the sample points extracted above, shown in <a href="#fig-rsample" class="quarto-xref">Figure&nbsp;<span>7.7</span></a>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"yellow"</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">col</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">14</span>, <span class="fl">15</span>, <span class="fl">18</span>, <span class="fl">19</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="st">"red"</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rsample" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rsample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-rsample-1.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rsample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.7: Randomly chosen sample locations for training data; red: water, yellow: land
</figcaption></figure>
</div>
</div>
</div>
<p>From this figure, we read “by eye” that the points 8, 14, 15, 18, and 19 are on water, the others on land. Using a linear discriminant (“maximum likelihood”) classifier, we find model predictions as shown in <a href="#fig-lda" class="quarto-xref">Figure&nbsp;<span>7.8</span></a> by</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="va">trn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op">(</span><span class="va">rs</span>, <span class="va">pts</span><span class="op">)</span></span>
<span><span class="va">trn</span><span class="op">$</span><span class="va">cls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"land"</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">trn</span><span class="op">$</span><span class="va">cls</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">14</span>, <span class="fl">15</span>, <span class="fl">18</span>, <span class="fl">19</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"water"</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lda.html">lda</a></span><span class="op">(</span><span class="va">cls</span> <span class="op">~</span> <span class="va">.</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="va">trn</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rs</span>, <span class="va">model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, we used the <code>MASS::</code> prefix to avoid loading <strong>MASS</strong>, as that would mask <code>select</code> from <strong>dplyr</strong>. The <code>split</code> step is needed to convert the band dimension into attributes, so that they are offered as a set of predictors.</p>
<p></p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pr</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, key.pos <span class="op">=</span> <span class="fl">4</span>, key.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">lcm</a></span><span class="op">(</span><span class="fl">3.5</span><span class="op">)</span>, key.length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">lcm</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-lda" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-lda-1.png" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.8: Linear discriminant classifier for land/water, based on training data of <a href="#fig-rsample" class="quarto-xref">Figure&nbsp;<span>7.7</span></a>
</figcaption></figure>
</div>
</div>
</div>
<p>We also see that the layer plotted in <a href="#fig-lda" class="quarto-xref">Figure&nbsp;<span>7.8</span></a> is a <code>factor</code> variable, with class labels.</p>
</section><section id="plotting-raster-data" class="level3"><h3 class="anchored" data-anchor-id="plotting-raster-data">Plotting raster data</h3>
<p> </p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-firststars" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-firststars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-firststars-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-firststars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.9: Six 30 m Landsat bands downsampled to 90m for Olinda, Br.
</figcaption></figure>
</div>
</div>
</div>
<p>We can use the base <code>plot</code> method for <code>stars</code> objects, where the plot created with <code>plot(r)</code> is shown in <a href="#fig-firststars" class="quarto-xref">Figure&nbsp;<span>7.9</span></a>. The default colour scale uses grey tones and stretches them such that colour breaks correspond to data quantiles over all bands (“histogram equalization”). Setting <code>breaks = "equal"</code> gives equal width colour breaks; alternatively a sequence of numeric break values can be given. A more familiar view may be the RGB or false colour composite shown in <a href="#fig-starsrgb" class="quarto-xref">Figure&nbsp;<span>7.10</span></a>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span>, rgb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, main <span class="op">=</span> <span class="st">"RGB"</span><span class="op">)</span>    <span class="co"># rgb</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span>, rgb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"False colour (NIR-R-G)"</span><span class="op">)</span> <span class="co"># false colour</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-starsrgb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-starsrgb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-starsrgb-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-starsrgb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.10: Two colour composites
</figcaption></figure>
</div>
</div>
</div>
<p>Further details and options are given in <a href="08-Plotting.html" class="quarto-xref"><span>Chapter 8</span></a>.</p>
</section><section id="analysing-raster-data" class="level3"><h3 class="anchored" data-anchor-id="analysing-raster-data">Analysing raster data</h3>
<p> </p>
<p>Element-wise mathematical functions (<a href="06-Cubes.html#sec-applydimension" class="quarto-xref"><span>Section 6.3.2</span></a>) on <code>stars</code> objects are just passed on to the arrays. This means that we can call functions and create expressions:</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif     0    3.99   4.23 4.12    4.45 5.54</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="co"># band    1   6      NA    NA                NA    NA</span></span>
<span><span class="va">r</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif     1      62   77.5 77.1    94.9  266</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="co"># band    1   6      NA    NA                NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or even mask out certain values:</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="va">r</span></span>
<span><span class="va">r2</span><span class="op">[</span><span class="va">r</span> <span class="op">&lt;</span> <span class="fl">50</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">r2</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.   NA's</span></span>
<span><span class="co"># L7_ETMs.tif    50      64     75   79      90  255 149170</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="co"># band    1   6      NA    NA                NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or unmask areas:</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">r2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">r2</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif     0      54     69   63      86  255</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span>
<span><span class="co"># band    1   6      NA    NA                NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p> </p>
<p>Dimension-wise, we can apply functions to selected array dimensions (<a href="06-Cubes.html#sec-reducedimension" class="quarto-xref"><span>Section 6.3.3</span></a>) of stars objects similar to how <code>apply</code> does this to arrays. For instance, we can compute for each pixel the mean of the six band values by</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#       Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># mean  25.5    53.3   68.3 68.9      82  255</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#   from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x    1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y    1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A more meaningful function would for instance compute the NDVI (normalised differenced vegetation index):</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ndvi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">b1</span>, <span class="va">b2</span>, <span class="va">b3</span>, <span class="va">b4</span>, <span class="va">b5</span>, <span class="va">b6</span><span class="op">)</span> <span class="op">(</span><span class="va">b4</span> <span class="op">-</span> <span class="va">b3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">b4</span> <span class="op">+</span> <span class="va">b3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">ndvi</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#         Min. 1st Qu.  Median    Mean 3rd Qu.  Max.</span></span>
<span><span class="co"># ndvi  -0.753  -0.203 -0.0687 -0.0643   0.187 0.587</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#   from  to  offset delta            refsys point x/y</span></span>
<span><span class="co"># x    1 349  288776  28.5 SIRGAS 2000 / ... FALSE [x]</span></span>
<span><span class="co"># y    1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, one could have defined</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ndvi2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">-</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">+</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which is more convenient if the number of bands is large, but also much slower than <code>ndvi</code> as it needs to be called for every pixel whereas <code>ndvi</code> can be called once for all pixels, or for large chunks of pixels. The mean for each band over the whole image is computed by</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"band"</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#   band mean</span></span>
<span><span class="co"># 1    1 79.1</span></span>
<span><span class="co"># 2    2 67.6</span></span>
<span><span class="co"># 3    3 64.4</span></span>
<span><span class="co"># 4    4 59.2</span></span>
<span><span class="co"># 5    5 83.2</span></span>
<span><span class="co"># 6    6 60.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>the result of which is small enough to be printed here as a <code>data.frame</code>. In these two examples, entire dimensions disappear. Sometimes, this does not happen (<a href="06-Cubes.html#sec-applydimension" class="quarto-xref"><span>Section 6.3.2</span></a>); we can for instance compute the three quartiles for each band</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"band"</span><span class="op">)</span>, <span class="va">quantile</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.25</span>, <span class="fl">.5</span>, <span class="fl">.75</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif    32    60.8   66.5 69.8    78.8  112</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#          from to        values</span></span>
<span><span class="co"># quantile    1  3 25%, 50%, 75%</span></span>
<span><span class="co"># band        1  6          NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and see that this <em>creates</em> a new dimension, <code>quantile</code>, with three values. Alternatively, the three quantiles over the six bands for each pixel are obtained by</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">quantile</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.25</span>, <span class="fl">.5</span>, <span class="fl">.75</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif     4      55   69.2 67.2    81.2  255</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#          from  to  offset delta            refsys point</span></span>
<span><span class="co"># quantile    1   3      NA    NA                NA    NA</span></span>
<span><span class="co"># x           1 349  288776  28.5 SIRGAS 2000 / ... FALSE</span></span>
<span><span class="co"># y           1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE</span></span>
<span><span class="co">#                 values x/y</span></span>
<span><span class="co"># quantile 25%, 50%, 75%    </span></span>
<span><span class="co"># x                 NULL [x]</span></span>
<span><span class="co"># y                 NULL [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="curvilinear-rasters" class="level3"><h3 class="anchored" data-anchor-id="curvilinear-rasters">Curvilinear rasters</h3>
<p></p>
<p>There are several reasons why non-regular rasters occur (<a href="01-hello.html#fig-rastertypes01" class="quarto-xref">Figure&nbsp;<span>1.6</span></a>). For one, when the data is Earth-bound, a regular raster does not fit the Earth’s surface, which is curved. Other reasons are:</p>
<ul>
<li>when we convert or transform a regular raster data into another coordinate reference system, it will become curvilinear unless we resample (warp; <a href="#sec-warp" class="quarto-xref"><span>Section 7.8</span></a>); warping always comes at the cost of some loss of data and is not reversible</li>
<li>observation may lead to irregular rasters: for lower-level satellite products, we may have a regular raster in the direction of the satellite (not aligned with <span class="math inline">\(x\)</span> or <span class="math inline">\(y\)</span>), and rectilinear in the direction perpendicular to that (e.g., when the sensor discretises the viewing <em>angle</em> in equal parts)</li>
</ul></section><section id="gdal-utils" class="level3"><h3 class="anchored" data-anchor-id="gdal-utils">GDAL utils</h3>
<p> </p>
<p>The GDAL library typically ships with a number of executable binaries, the GDAL command line utilities for data translation and processing. Several of these utilities (all except for those written in Python) are also available as C functions in the GDAL library, through the “GDAL Algorithms C API”. If an R package like <code>sf</code> that links to the GDAL library uses these C API algorithms, it means that the user no longer needs to install any GDAL binary command line utilities in addition to the R package.</p>
<p>Package <strong>sf</strong> allows calling these C API algorithms through function <code>gdal_utils</code>, where the first argument is the name of the utility (stripped from the <code>gdal</code> prefix):</p>
<ul>
<li>
<code>info</code> prints information on GDAL (raster) datasets</li>
<li>
<code>warp</code> warps a raster to a new raster, possibly in another CRS</li>
<li>
<code>rasterize</code> rasterises a vector dataset</li>
<li>
<code>translate</code> translates a raster file to another format</li>
<li>
<code>vectortranslate</code> (for ogr2ogr) translates a vector file to another format</li>
<li>
<code>buildvrt</code> creates a virtual raster tile (a raster created from several files)</li>
<li>
<code>demprocessing</code> does various processing steps of digital elevation models (dems)</li>
<li>
<code>nearblack</code> converts nearly black/white borders to black</li>
<li>
<code>grid</code> creates a regular grid from scattered data</li>
<li>
<code>mdiminfo</code> prints information on a multi-dimensional array</li>
<li>
<code>mdimtranslate</code> translates a multi-dimensional array into another format</li>
</ul>
<p>These utilities work on files, and not directly on <code>sf</code> or <code>stars</code> objects. However, <code>stars_proxy</code> objects are essentially pointers to files, and other objects can be written to file. Several of these utilities are (always or optionally) used, for example by <code>st_mosaic</code>, <code>st_warp</code>, or <code>st_write</code>. R package <strong>gdalUtilities</strong> <span class="citation" data-cites="R-gdalUtilities">(<a href="references.html#ref-R-gdalUtilities" role="doc-biblioref">O’Brien 2022</a>)</span> provides further wrapper functions around <code><a href="https://r-spatial.github.io/sf/reference/gdal_utils.html">sf::gdal_utils</a></code> with function argument names matching the command line arguments of the binary utils.</p>
</section></section><section id="vector-data-cube-examples" class="level2" data-number="7.5"><h2 data-number="7.5" class="anchored" data-anchor-id="vector-data-cube-examples">
<span class="header-section-number">7.5</span> Vector data cube examples</h2>
<p> </p>
<section id="example-aggregating-air-quality-time-series" class="level3"><h3 class="anchored" data-anchor-id="example-aggregating-air-quality-time-series">Example: aggregating air quality time series</h3>
<p></p>
<p>We use a small excert from the <a href="https://www.eea.europa.eu/data-and-maps/data/aqereporting-9">European air quality data base</a> to illustrate aggregation operations on vector data cubes. The same data source was used by <span class="citation" data-cites="RJ-2016-014">Gräler, Pebesma, and Heuvelink (<a href="references.html#ref-RJ-2016-014" role="doc-biblioref">2016</a>)</span>, and will be used in <a href="12-Interpolation.html" class="quarto-xref"><span>Chapter 12</span></a> and <a href="13-Geostatistics.html" class="quarto-xref"><span>Chapter 13</span></a>. Daily average PM<span class="math inline">\(_{10}\)</span> values were computed for rural background stations in Germany, over the period 1998-2009.</p>
<p>We can create a <code>stars</code> object from the <code>air</code> matrix, the <code>dates</code> Date vector and the <code>stations</code> <code>SpatialPoints</code> objects by</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/air.rda"</span><span class="op">)</span> <span class="co"># this loads several datasets in .GlobalEnv</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">air</span><span class="op">)</span></span>
<span><span class="co"># space  time </span></span>
<span><span class="co">#    70  4383</span></span>
<span><span class="va">stations</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">st</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_dimensions</a></span><span class="op">(</span>station <span class="op">=</span> <span class="va">st</span>, time <span class="op">=</span> <span class="va">dates</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">aq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>PM10 <span class="op">=</span> <span class="va">air</span><span class="op">)</span>, dimensions <span class="op">=</span> <span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#       Min. 1st Qu. Median Mean 3rd Qu. Max.   NA's</span></span>
<span><span class="co"># PM10     0    9.92   14.8 17.7      22  274 157659</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#         from   to     offset  delta refsys point</span></span>
<span><span class="co"># station    1   70         NA     NA WGS 84  TRUE</span></span>
<span><span class="co"># time       1 4383 1998-01-01 1 days   Date FALSE</span></span>
<span><span class="co">#                                          values</span></span>
<span><span class="co"># station POINT (9.59 53.7),...,POINT (9.45 49.2)</span></span>
<span><span class="co"># time                                       NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see from <a href="#fig-airst" class="quarto-xref">Figure&nbsp;<span>7.11</span></a> that the time series are quite long, but also have large missing value gaps. <a href="#fig-airmap" class="quarto-xref">Figure&nbsp;<span>7.12</span></a> shows the spatial distribution of measurement stations along with mean PM<span class="math inline">\(_{10}\)</span> values.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5.1</span>, <span class="fl">4.1</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/aperm.html">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">aq</span><span class="op">)</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, main <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-airst" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-airst-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-airst-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-airst-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.11: Space time diagram of PM<span class="math inline">\(_{10}\)</span> measurements by time and station
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">de_nuts1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"data/de_nuts1.gpkg"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">aq</span>, <span class="fl">1</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>reset <span class="op">=</span> <span class="cn">FALSE</span>, pch <span class="op">=</span> <span class="fl">16</span>, extent <span class="op">=</span> <span class="va">de_nuts1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="va">de_nuts1</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-airmap" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-airmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-airmap-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-airmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.12: Locations of PM<span class="math inline">\(_{10}\)</span> measurement stations, showing mean values
</figcaption></figure>
</div>
</div>
</div>
<p>We can aggregate these station time series to area means, mostly as a simple exercise. For this, we use the <code>aggregate</code> method for <code>stars</code> objects</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">aq</span>, <span class="va">de_nuts1</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#       Min. 1st Qu. Median Mean 3rd Qu. Max.  NA's</span></span>
<span><span class="co"># PM10  1.08    10.9   15.3 17.9    21.8  172 25679</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from   to     offset  delta refsys point</span></span>
<span><span class="co"># geom    1   16         NA     NA WGS 84 FALSE</span></span>
<span><span class="co"># time    1 4383 1998-01-01 1 days   Date FALSE</span></span>
<span><span class="co">#                                       values</span></span>
<span><span class="co"># geom MULTIPOLYGON (...,...,MULTIPOLYGON (...</span></span>
<span><span class="co"># time                                    NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and we can now show the maps for six arbitrarily chosen days (<a href="#fig-airagg" class="quarto-xref">Figure&nbsp;<span>7.13</span></a>), using</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="va">a</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;=</span> <span class="st">"2008-01-01"</span>, <span class="va">time</span> <span class="op">&lt;</span> <span class="st">"2008-01-07"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>key.pos <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-airagg" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-airagg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-airagg-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-airagg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.13: Areal mean PM<span class="math inline">\(_{10}\)</span> values, for six days
</figcaption></figure>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
<p>or create a time series plot of mean values for a single state (<a href="#fig-airts" class="quarto-xref">Figure&nbsp;<span>7.14</span></a>) by</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://joshuaulrich.github.io/xts/">xts</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/xts/man/as.xts.html">as.xts</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>, main <span class="op">=</span> <span class="va">de_nuts1</span><span class="op">$</span><span class="va">NAME_1</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-airts" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-airts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-airts-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-airts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.14: Areal mean PM<span class="math inline">\(_{10}\)</span> time series for a single state
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-oddc" class="level3"><h3 class="anchored" data-anchor-id="sec-oddc">Example: Bristol origin-destination data cube</h3>
<p> </p>
<p>The data used for this example come from <span class="citation" data-cites="geocomp">Lovelace, Nowosad, and Muenchow (<a href="references.html#ref-geocomp" role="doc-biblioref">2019</a>)</span>, and concern origin-destination (OD) counts: the number of persons going from zone A to zone B, by transportation mode. We have feature geometries in <code>sf</code> object <code>bristol_zones</code> for the 102 origin and destination regions, shown in <a href="#fig-bristol1" class="quarto-xref">Figure&nbsp;<span>7.15</span></a>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Nowosad/spData">spDataLarge</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">bristol_zones</span><span class="op">)</span>, axes <span class="op">=</span> <span class="cn">TRUE</span>, graticule <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">bristol_zones</span><span class="op">)</span><span class="op">[</span><span class="fl">33</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'red'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-bristol1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-bristol1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-bristol1-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bristol1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.15: Origin destination data zones for Bristol, UK, with zone 33 (E02003043) coloured red
</figcaption></figure>
</div>
</div>
</div>
<p>OD counts come in a table <code>bristol_od</code> with non-zero OD pairs as records, and transportation mode as variables:</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">bristol_od</span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 6 × 7</span></span>
<span><span class="co">#   o         d           all bicycle  foot car_driver train</span></span>
<span><span class="co">#   &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co"># 1 E02002985 E02002985   209       5   127         59     0</span></span>
<span><span class="co"># 2 E02002985 E02002987   121       7    35         62     0</span></span>
<span><span class="co"># 3 E02002985 E02003036    32       2     1         10     1</span></span>
<span><span class="co"># 4 E02002985 E02003043   141       1     2         56    17</span></span>
<span><span class="co"># 5 E02002985 E02003049    56       2     4         36     0</span></span>
<span><span class="co"># 6 E02002985 E02003054    42       4     0         21     0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The number of zero OD values is found by subtracting the number of non-zero records from the total number of OD combinations:</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">bristol_zones</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">bristol_od</span><span class="op">)</span> </span>
<span><span class="co"># [1] 7494</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will form a three-dimensional vector data cube with origin, destination, and transportation mode as dimensions. For this, we first “tidy” the <code>bristol_od</code> table to have origin (o), destination (d), transportation mode (mode), and count (n) as variables, using <code>pivot_longer</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create O-D-mode array:</span></span>
<span><span class="va">bristol_tidy</span> <span class="op">&lt;-</span> <span class="va">bristol_od</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">all</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">6</span>, names_to <span class="op">=</span> <span class="st">"mode"</span>, values_to <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">bristol_tidy</span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 6 × 4</span></span>
<span><span class="co">#   o         d         mode           n</span></span>
<span><span class="co">#   &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;      &lt;dbl&gt;</span></span>
<span><span class="co"># 1 E02002985 E02002985 bicycle        5</span></span>
<span><span class="co"># 2 E02002985 E02002985 foot         127</span></span>
<span><span class="co"># 3 E02002985 E02002985 car_driver    59</span></span>
<span><span class="co"># 4 E02002985 E02002985 train          0</span></span>
<span><span class="co"># 5 E02002985 E02002987 bicycle        7</span></span>
<span><span class="co"># 6 E02002985 E02002987 foot          35</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we form the three-dimensional array <code>a</code>, filled with zeroes:</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">od</span> <span class="op">&lt;-</span> <span class="va">bristol_tidy</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="st">"o"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">nod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span></span>
<span><span class="va">mode</span> <span class="op">&lt;-</span> <span class="va">bristol_tidy</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="st">"mode"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">nmode</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">mode</span><span class="op">)</span></span>
<span><span class="va">a</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">0L</span>,  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nod</span>, <span class="va">nod</span>, <span class="va">nmode</span><span class="op">)</span>, </span>
<span>    dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>o <span class="op">=</span> <span class="va">od</span>, d <span class="op">=</span> <span class="va">od</span>, mode <span class="op">=</span> <span class="va">mode</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span><span class="co"># [1] 102 102   4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that the dimensions are named with the zone names (o, d) and the transportation mode name (mode). Every row of <code>bristol_tidy</code> denotes a single array entry, and we can use this to fill the non-zero entries of <code>a</code> using the <code>bristol_tidy</code> table to provide index (<code>o</code>, <code>d</code> and <code>mode</code>) and value (<code>n</code>):</p>
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">a</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">bristol_tidy</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"o"</span>, <span class="st">"d"</span>, <span class="st">"mode"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> </span>
<span>        <span class="va">bristol_tidy</span><span class="op">$</span><span class="va">n</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To be sure that there is not an order mismatch between the zones in <code>bristol_zones</code> and the zone names in <code>bristol_tidy</code>, we can get the right set of zones by:</p>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">od</span>, <span class="va">bristol_zones</span><span class="op">$</span><span class="va">geo_code</span><span class="op">)</span></span>
<span><span class="va">zones</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">bristol_zones</span><span class="op">)</span><span class="op">[</span><span class="va">order</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(It happens that the order is already correct, but it is good practice to not assume this.)</p>
<p>Next, with zones and modes we can create a stars dimensions object:</p>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_dimensions</a></span><span class="op">(</span>o <span class="op">=</span> <span class="va">zones</span>, d <span class="op">=</span> <span class="va">zones</span>, mode <span class="op">=</span> <span class="va">mode</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#      from  to refsys point                                  values</span></span>
<span><span class="co"># o       1 102 WGS 84 FALSE MULTIPOLYGON (...,...,MULTIPOLYGON (...</span></span>
<span><span class="co"># d       1 102 WGS 84 FALSE MULTIPOLYGON (...,...,MULTIPOLYGON (...</span></span>
<span><span class="co"># mode    1   4     NA FALSE                       bicycle,...,train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and finally build a stars object from <code>a</code> and <code>d</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">odm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="va">a</span><span class="op">)</span>, dimensions <span class="op">=</span> <span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#    Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># N     0       0      0  4.8       0 1296</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to refsys point                                  values</span></span>
<span><span class="co"># o       1 102 WGS 84 FALSE MULTIPOLYGON (...,...,MULTIPOLYGON (...</span></span>
<span><span class="co"># d       1 102 WGS 84 FALSE MULTIPOLYGON (...,...,MULTIPOLYGON (...</span></span>
<span><span class="co"># mode    1   4     NA FALSE                       bicycle,...,train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can take a single slice through this three-dimensional array, for instance for zone 33 (<a href="#fig-bristol1" class="quarto-xref">Figure&nbsp;<span>7.15</span></a>), by <code>odm[ , , 33]</code>, and plot it with</p>
<div class="cell">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/abind/man/adrop.html">adrop</a></span><span class="op">(</span><span class="va">odm</span><span class="op">[</span>,,<span class="fl">33</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, logz <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-odm33" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-odm33-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-odm33-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-odm33-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.16: OD matrix sliced for destination zone 33, by transportation mode
</figcaption></figure>
</div>
</div>
</div>
<p>the result of which is shown in <a href="#fig-odm33" class="quarto-xref">Figure&nbsp;<span>7.16</span></a>. Subsetting this way, we take all attributes (there is only one: N) since the first argument is empty, we take all origin regions (second argument empty), we take destination zone 33 (third argument), and all transportation modes (fourth argument empty, or missing).</p>
<p>We plotted this particular zone because it has the largest number of travellers as its destination. We can find this out by summing all origins and travel modes by destination:</p>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">odm</span>, <span class="fl">2</span>, <span class="va">sum</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="va">d</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># [1] 33</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Other aggregations we can carry out include:</p>
<p>Total transportation by OD (102 x 102):</p>
<div class="cell">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">odm</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">sum</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#      Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># sum     0       0      0 19.2      19 1434</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#   from  to refsys point                                  values</span></span>
<span><span class="co"># o    1 102 WGS 84 FALSE MULTIPOLYGON (...,...,MULTIPOLYGON (...</span></span>
<span><span class="co"># d    1 102 WGS 84 FALSE MULTIPOLYGON (...,...,MULTIPOLYGON (...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Origin totals, by mode:</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">odm</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#      Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># sum     1    57.5    214  490     771 2903</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to refsys point                                  values</span></span>
<span><span class="co"># o       1 102 WGS 84 FALSE MULTIPOLYGON (...,...,MULTIPOLYGON (...</span></span>
<span><span class="co"># mode    1   4     NA FALSE                       bicycle,...,train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Destination totals, by mode:</p>
<div class="cell">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">odm</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#      Min. 1st Qu. Median Mean 3rd Qu.  Max.</span></span>
<span><span class="co"># sum     0      13    104  490     408 12948</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to refsys point                                  values</span></span>
<span><span class="co"># d       1 102 WGS 84 FALSE MULTIPOLYGON (...,...,MULTIPOLYGON (...</span></span>
<span><span class="co"># mode    1   4     NA FALSE                       bicycle,...,train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Origin totals, summed over modes:</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">odm</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Destination totals, summed over modes (we had this):</p>
<div class="cell">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">odm</span>, <span class="fl">2</span>, <span class="va">sum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We plot <code>o</code> and <code>d</code> together after joining them by</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">o</span>, <span class="va">d</span>, along <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>od <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"origin"</span>, <span class="st">"destination"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x</span>, logz <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-odjoined" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-odjoined-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-odjoined-1.png" style="width:100.0%;height:90.0%" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-odjoined-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.17: Total commutes, summed by origin (left) or destination (right)
</figcaption></figure>
</div>
</div>
</div>
<p>the result of which is shown in <a href="#fig-odjoined" class="quarto-xref">Figure&nbsp;<span>7.17</span></a>.</p>
<p>There is something to say for the argument that such maps give the wrong message, as both amount (colour) and polygon size give an impression of amount. To take out the amount in the count, we can compute densities (count / km<span class="math inline">\(^2\)</span>), by</p>
<div class="cell">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-quantities.github.io/units/">units</a></span><span class="op">)</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">o</span><span class="op">)</span><span class="op">)</span>, <span class="va">km</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">o</span><span class="op">$</span><span class="va">sum_km</span> <span class="op">&lt;-</span> <span class="va">o</span><span class="op">$</span><span class="va">sum</span> <span class="op">/</span> <span class="va">a</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">sum_km</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">sum</span> <span class="op">/</span> <span class="va">a</span></span>
<span><span class="va">od</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">o</span><span class="op">[</span><span class="st">"sum_km"</span><span class="op">]</span>, <span class="va">d</span><span class="op">[</span><span class="st">"sum_km"</span><span class="op">]</span>, along <span class="op">=</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>od <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"origin"</span>, <span class="st">"destination"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">od</span>, logz <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-odbykm" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-odbykm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-odbykm-1.png" style="width:100.0%;height:90.0%" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-odbykm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.18: Total commutes per square km, by area of origin (left) or destination (right)
</figcaption></figure>
</div>
</div>
</div>
<p>shown in <a href="#fig-odbykm" class="quarto-xref">Figure&nbsp;<span>7.18</span></a>. Another way to normalize these totals would be to divide them by population size.</p>
</section><section id="tidy-array-data" class="level3"><h3 class="anchored" data-anchor-id="tidy-array-data">Tidy array data</h3>
<p></p>
<p>The <em>tidy data</em> paper <span class="citation" data-cites="tidy">(<a href="references.html#ref-tidy" role="doc-biblioref">Wickham 2014</a>)</span> may suggest that such array data should be processed not as an array, but in a long (unnormalised) table form where each row holds (region, class, year, value), and it is always good to be able to do this. For primary handling and storage, however, this is often not an option, because:</p>
<ul>
<li>a lot of array data are collected or generated as array data, for instance by imagery or other sensory devices, or by climate models</li>
<li>it is easier to derive the long table form from the array than vice versa</li>
<li>the long table form requires much more memory, since the space occupied by dimension values is <span class="math inline">\(O(\Pi n_i)\)</span>, rather than <span class="math inline">\(O(\Sigma n_i)\)</span>, with <span class="math inline">\(n_i\)</span> the cardinality (size) of dimension <span class="math inline">\(i\)</span>
</li>
<li>when missing-valued cells are dropped, the long table form loses the implicit indexing of the array form</li>
</ul>
<p>To put this argument to the extreme, consider for instance that all image, video and sound data are stored in array form; few people would make a real case for storing them in a long table form instead. Nevertheless, R packages like <strong>tsibble</strong> <span class="citation" data-cites="R-tsibble">(<a href="references.html#ref-R-tsibble" role="doc-biblioref">Wang et al. 2022</a>)</span> take this approach, and have to deal with ambiguous ordering of multiple records with identical time steps for different spatial features and index them, which is solved for both <em>automatically</em> by using the array form – at the cost of using dense arrays, in package <strong>stars</strong>.</p>
<p>Package <strong>stars</strong> tries to follow the <a href="https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html">tidy manifesto</a> to handle array sets and has particularly developed support for the case where one or more of the dimensions refer to space and/or time.</p>
</section><section id="file-formats-for-vector-data-cubes" class="level3"><h3 class="anchored" data-anchor-id="file-formats-for-vector-data-cubes">File formats for vector data cubes</h3>
<p>Regular table forms, including the long table form, are possible but clumsy to use: the origin-destination data example above and <a href="13-Geostatistics.html" class="quarto-xref"><span>Chapter 13</span></a> illustrate the complexity of recreating a vector data cube from table forms. Array formats like NetCDF or Zarr are designed for storing array data. They can however be used for <em>any</em> data structure, and carry the risk that files once written are hard to reuse. For vector cubes that have a <em>single</em> geometry dimension that consists of either points, (multi)linestrings or (multi)polygons, the CF conventions <span class="citation" data-cites="cf">(<a href="references.html#ref-cf" role="doc-biblioref">Eaton et al. 2022</a>)</span> describe a way to encode such geometries. <code><a href="https://r-spatial.github.io/stars/reference/mdim.html">stars::read_mdim</a></code> and <code><a href="https://r-spatial.github.io/stars/reference/mdim.html">stars::write_mdim</a></code> can read and write vector data cubes following these conventions.</p>
<p> </p>
</section></section><section id="sec-raster-to-vector" class="level2" data-number="7.6"><h2 data-number="7.6" class="anchored" data-anchor-id="sec-raster-to-vector">
<span class="header-section-number">7.6</span> Raster-to-vector, vector-to-raster</h2>
<p><a href="01-hello.html#sec-rasterize" class="quarto-xref"><span>Section 1.3</span></a> already showed some examples of raster-to-vector and vector-to-raster conversions. This section will add some code details and examples.</p>
<section id="vector-to-raster" class="level3"><h3 class="anchored" data-anchor-id="vector-to-raster">Vector-to-raster</h3>
<p> </p>
<p><code>st_as_stars</code> is meant as a method to transform objects into <code>stars</code> objects. However, not all stars objects are <code>raster</code> objects, and the method for <code>sf</code> objects creates a vector data cube with the geometry as its spatial (vector) dimension, and attributes as attributes. When given a feature <em>geometry</em> (<code>sfc</code>) object, <code>st_as_stars</code> will rasterise it, as shown in <a href="#sec-warp" class="quarto-xref"><span>Section 7.8</span></a> and in <a href="#fig-asstars" class="quarto-xref">Figure&nbsp;<span>7.19</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"gpkg/nc.gpkg"</span>, package<span class="op">=</span><span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>key.pos <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-asstars" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-asstars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-asstars-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-asstars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.19: Rasterising vector geometry using <code>st_as_stars</code>
</figcaption></figure>
</div>
</div>
</div>
<p>Here, <code>st_as_stars</code> can be parameterised to control cell size, number of cells, and/or extent. The cell values returned are 0 for cells with centre point outside the geometry and 1 for cell with centre point inside or on the border of the geometry. Rasterising existing features is done using <code>st_rasterize</code>, as also shown in <a href="01-hello.html#fig-vectoras" class="quarto-xref">Figure&nbsp;<span>1.5</span></a>:</p>
<div class="cell">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">NAME</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">SID74</span>, <span class="va">SID79</span>, <span class="va">name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_rasterize.html">st_rasterize</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># stars object with 2 dimensions and 3 attributes</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#      SID74           SID79            name       </span></span>
<span><span class="co">#  Min.   : 0      Min.   : 0      Sampson :  655  </span></span>
<span><span class="co">#  1st Qu.: 3      1st Qu.: 3      Columbus:  648  </span></span>
<span><span class="co">#  Median : 5      Median : 6      Robeson :  648  </span></span>
<span><span class="co">#  Mean   : 8      Mean   :10      Bladen  :  604  </span></span>
<span><span class="co">#  3rd Qu.:10      3rd Qu.:13      Wake    :  590  </span></span>
<span><span class="co">#  Max.   :44      Max.   :57      (Other) :30952  </span></span>
<span><span class="co">#  NA's   :30904   NA's   :30904   NA's    :30904  </span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#   from  to offset   delta refsys point x/y</span></span>
<span><span class="co"># x    1 461  -84.3  0.0192  NAD27 FALSE [x]</span></span>
<span><span class="co"># y    1 141   36.6 -0.0192  NAD27 FALSE [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similarly, line and point geometries can be rasterised, as shown in <a href="#fig-lineras" class="quarto-xref">Figure&nbsp;<span>7.20</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="st">"MULTILINESTRING"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">CNTY_ID</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_rasterize.html">st_rasterize</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>key.pos <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-lineras" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lineras-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="07-Introsf_files/figure-html/fig-lineras-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lineras-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.20: Rasterising the North Carolina county boundaries
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="sec-projsf" class="level2" data-number="7.7"><h2 data-number="7.7" class="anchored" data-anchor-id="sec-projsf">
<span class="header-section-number">7.7</span> Coordinate transformations and conversions</h2>
<p> </p>
<section id="st_crs" class="level3"><h3 class="anchored" data-anchor-id="st_crs"><code>st_crs</code></h3>
<p></p>
<p>Spatial objects of class <code>sf</code> or <code>stars</code> contain a coordinate reference system that can be retrieved or replaced with <code>st_crs</code>, or can be set or replaced in a pipe with <code>st_set_crs</code>. Coordinate reference systems can be set with an EPSG code, like <code>st_crs(4326)</code> which will be converted to <code>st_crs('EPSG:4326')</code>, or with a PROJ.4 string like <code>"+proj=utm +zone=25 +south"</code>, a name like “WGS84”, or a name preceded by an authority like “OGC:CRS84”. Alternatives include a coordinate reference system definition in WKT, WKT-2 (<a href="02-Spaces.html#sec-wkt2" class="quarto-xref"><span>Section 2.5</span></a>) or <a href="https://proj.org/specifications/projjson.html">PROJJSON</a>. The object returned by <code>st_crs</code> contains two fields:</p>
<ul>
<li>
<code>wkt</code> with the WKT-2 representation</li>
<li>
<code>input</code> with the user input, if any, or a human readable description of the coordinate reference system, if available</li>
</ul>
<p>Note that PROJ.4 strings can be used to <em>define</em> some coordinate reference systems, but they cannot be used to <em>represent</em> coordinate reference systems. Conversion of a WKT-2 in a <code>crs</code> object to a proj4string using the <code>$proj4string</code> method, as in</p>
<div class="cell">
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">"OGC:CRS84"</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">proj4string</span></span>
<span><span class="co"># [1] "+proj=longlat +datum=WGS84 +no_defs"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>may succeed but is not in general lossless or invertible. Using PROJ.4 strings, for instance to <em>define</em> a parameterised, projected coordinate reference system is fine as long as it is associated with the WGS84 datum.</p>
</section><section id="st_transform-sf_project" class="level3"><h3 class="anchored" data-anchor-id="st_transform-sf_project">
<code>st_transform</code>, <code>sf_project</code>
</h3>
<p> </p>
<p>Coordinate transformations or conversions (<a href="02-Spaces.html#sec-projlib" class="quarto-xref"><span>Section 2.4</span></a>) for <code>sf</code> or <code>stars</code> objects are carried out with <code>st_transform</code>, which takes as its first argument a spatial object of class <code>sf</code> or <code>stars</code> that has a coordinate reference system set, and as a second argument with an <code>crs</code> object (or something that can be converted to it with <code>st_crs</code>). When PROJ finds more than one possibility to transform or convert from the source <code>crs</code> to the target <code>crs</code>, it chooses the one with the highest declared accuracy. More fine-grained control over the options is explained in <a href="#sec-pipelines" class="quarto-xref"><span>Section 7.7.5</span></a>. For <code>stars</code> objects with regular raster dimensions, <code>st_transform</code> will <em>only</em> transform coordinates and always result in a curvilinear grid. <code>st_warp</code> can be used to create a regular raster in a new coordinate reference system, using regridding (<a href="#sec-warp" class="quarto-xref"><span>Section 7.8</span></a>).</p>
<p>A lower-level function to transform or convert coordinates <em>not</em> in <code>sf</code> or <code>stars</code> objects is <code>sf_project</code>: it takes a matrix with coordinates and a source and target <code>crs</code>, and it returns transformed or converted coordinates.</p>
</section><section id="sf_proj_info" class="level3"><h3 class="anchored" data-anchor-id="sf_proj_info"><code>sf_proj_info</code></h3>
<p></p>
<p>Function <code>sf_proj_info</code> can be used to query the available projections, ellipsoids, units and prime meridians available in the PROJ software. It takes a single parameter, <code>type</code>, which can have the following values:</p>
<ul>
<li>
<code>type = "proj"</code> lists the short and long names of available projections; short names can be used in a “+proj=name” string</li>
<li>
<code>type = "ellps"</code> lists the available ellipses, with name, long name, and ellipsoidal parameters</li>
<li>
<code>type = "units"</code> lists the available length units, with conversion constant to meters</li>
<li>
<code>type = "prime_meridians"</code> lists the prime meridians with their position with respect to the Greenwich meridian</li>
</ul></section><section id="datum-grids-proj.db-cdn.proj.org-local-cache" class="level3"><h3 class="anchored" data-anchor-id="datum-grids-proj.db-cdn.proj.org-local-cache">Datum grids, proj.db, cdn.proj.org, local cache</h3>
<p> </p>
<p>Datum grids (<a href="02-Spaces.html#sec-projlib" class="quarto-xref"><span>Section 2.4</span></a>) can be installed locally, or be read from the PROJ datum grid CDN at <a href="https://cdn.proj.org/" class="uri">https://cdn.proj.org/</a>. If installed locally, they are read from the PROJ search path, which is shown by</p>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/proj_tools.html">sf_proj_search_paths</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># [1] "/home/runner/.local/share/proj"</span></span>
<span><span class="co"># [2] "/usr/share/proj"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The main PROJ database is <code>proj.db</code>, an sqlite3 database typically found at</p>
<div class="cell">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/proj_tools.html">sf_proj_search_paths</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">.Platform</span><span class="op">$</span><span class="va">file.sep</span>, </span>
<span>       <span class="st">"proj.db"</span><span class="op">)</span></span>
<span><span class="co"># [1] "/usr/share/proj/proj.db"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which can be read. The version of the snapshot of the EPSG database included in each PROJ release is stated in the <code>"metadata"</code> table of <code>proj.db</code>; the version of the PROJ runtime used by <strong>sf</strong> is shown by</p>
<div class="cell">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf_extSoftVersion.html">sf_extSoftVersion</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="st">"PROJ"</span><span class="op">]</span></span>
<span><span class="co">#    PROJ </span></span>
<span><span class="co"># "9.4.0"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If for a particular coordinate transformation datum grids are not locally found, PROJ will search for online datum grids in the PROJ CDN when</p>
<div class="cell">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/proj_tools.html">sf_proj_network</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># [1] FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>returns <code>TRUE</code>. By default it is set to <code>FALSE</code>, but</p>
<div class="cell">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/proj_tools.html">sf_proj_network</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># [1] "https://cdn.proj.org"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>sets it to <code>TRUE</code> and returns the URL of the network resource used. This resource can also be set to another resource, that may be faster or less limited.</p>
<p>After querying a datum grid on the CDN, PROJ writes the <em>portion</em> of the grid queried (not, by default, the entire grid) to a local cache, which is another sqlite3 database found locally in a user directory that is listed by</p>
<div class="cell">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/proj_tools.html">sf_proj_search_paths</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># character(0)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and that will be searched first in subsequent datum grid queries.</p>
</section><section id="sec-pipelines" class="level3"><h3 class="anchored" data-anchor-id="sec-pipelines">Transformation pipelines</h3>
<p></p>
<p>Internally, PROJ uses a so-called <em>coordinate operation pipeline</em>, to represent the sequence of operations to get from a source CRS to a target CRS. Given multiple options to go from source to target, <code>st_transform</code> chooses the one with highest accuracy. We can query the options available by <code>sf_proj_pipelines</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/proj_tools.html">sf_proj_pipelines</a></span><span class="op">(</span><span class="st">"OGC:CRS84"</span>, <span class="st">"EPSG:22525"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Candidate coordinate operations found:  5 </span></span>
<span><span class="co"># Strict containment:     FALSE </span></span>
<span><span class="co"># Axis order auth compl:  FALSE </span></span>
<span><span class="co"># Source:  OGC:CRS84 </span></span>
<span><span class="co"># Target:  EPSG:22525 </span></span>
<span><span class="co"># Best instantiable operation has accuracy: 2 m</span></span>
<span><span class="co"># Description: axis order change (2D) + Inverse of Corrego Alegre</span></span>
<span><span class="co">#              1970-72 to WGS 84 (2) + UTM zone 25S</span></span>
<span><span class="co"># Definition:  +proj=pipeline +step +proj=unitconvert +xy_in=deg</span></span>
<span><span class="co">#              +xy_out=rad +step +inv +proj=hgridshift</span></span>
<span><span class="co">#              +grids=br_ibge_CA7072_003.tif +step</span></span>
<span><span class="co">#              +proj=utm +zone=25 +south +ellps=intl</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and see that pipeline with the highest accuracy is summarised; we can see that it specifies use of a datum grid. Had we not switched on the network search, we would have obtained a different result:</p>
<div class="cell">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/proj_tools.html">sf_proj_network</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># character(0)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/proj_tools.html">sf_proj_pipelines</a></span><span class="op">(</span><span class="st">"OGC:CRS84"</span>, <span class="st">"EPSG:22525"</span><span class="op">)</span></span>
<span><span class="co"># Candidate coordinate operations found:  5 </span></span>
<span><span class="co"># Strict containment:     FALSE </span></span>
<span><span class="co"># Axis order auth compl:  FALSE </span></span>
<span><span class="co"># Source:  OGC:CRS84 </span></span>
<span><span class="co"># Target:  EPSG:22525 </span></span>
<span><span class="co"># Best instantiable operation has accuracy: 5 m</span></span>
<span><span class="co"># Description: axis order change (2D) + Inverse of Corrego Alegre</span></span>
<span><span class="co">#              1970-72 to WGS 84 (4) + UTM zone 25S</span></span>
<span><span class="co"># Definition:  +proj=pipeline +step +proj=unitconvert +xy_in=deg</span></span>
<span><span class="co">#              +xy_out=rad +step +proj=push +v_3 +step</span></span>
<span><span class="co">#              +proj=cart +ellps=WGS84 +step</span></span>
<span><span class="co">#              +proj=helmert +x=206.05 +y=-168.28</span></span>
<span><span class="co">#              +z=3.82 +step +inv +proj=cart</span></span>
<span><span class="co">#              +ellps=intl +step +proj=pop +v_3 +step</span></span>
<span><span class="co">#              +proj=utm +zone=25 +south +ellps=intl</span></span>
<span><span class="co"># Operation 4 is lacking 1 grid with accuracy 2 m</span></span>
<span><span class="co"># Missing grid: br_ibge_CA7072_003.tif </span></span>
<span><span class="co"># URL: https://cdn.proj.org/br_ibge_CA7072_003.tif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and a report that a datum grid is missing. The object returned by <code>sf_proj_pipelines</code> is a sub-classed <code>data.frame</code>, with columns</p>
<div class="cell">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co"># [1] "id"           "description"  "definition"   "has_inverse" </span></span>
<span><span class="co"># [5] "accuracy"     "axis_order"   "grid_count"   "instantiable"</span></span>
<span><span class="co"># [9] "containment"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and we can list for instance the accuracies by</p>
<div class="cell">
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">accuracy</span><span class="op">)</span></span>
<span><span class="co"># [1]  2  5  5  8 NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, <code>NA</code> refers to “ballpark accuracy”, which may be anything in the 30-120 m range:</p>
<div class="cell">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">accuracy</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Candidate coordinate operations found:  1 </span></span>
<span><span class="co"># Strict containment:     FALSE </span></span>
<span><span class="co"># Axis order auth compl:  FALSE </span></span>
<span><span class="co"># Source:  OGC:CRS84 </span></span>
<span><span class="co"># Target:  EPSG:22525 </span></span>
<span><span class="co"># Best instantiable operation has only ballpark accuracy </span></span>
<span><span class="co"># Description: Ballpark geographic offset from WGS 84 (CRS84) to</span></span>
<span><span class="co">#              Corrego Alegre 1970-72 + UTM zone 25S</span></span>
<span><span class="co"># Definition:  +proj=pipeline +step +proj=unitconvert +xy_in=deg</span></span>
<span><span class="co">#              +xy_out=rad +step +proj=utm +zone=25</span></span>
<span><span class="co">#              +south +ellps=intl</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The default, most accurate pipeline chosen by <code>st_transform</code> can be overridden by specifying <code>pipeline</code> argument, as selected from the set of options in <code>p$definition</code>.</p>
</section><section id="sec-axisorder" class="level3"><h3 class="anchored" data-anchor-id="sec-axisorder">Axis order and direction</h3>
<p> </p>
<p>As mentioned in <a href="02-Spaces.html#sec-wkt2" class="quarto-xref"><span>Section 2.5</span></a>, <code>EPSG:4326</code> defines the first axis to be associated with latitude and the second with longitude; this is also the case for a number of other ellipsoidal coordinate reference systems. Although this is how the authority (EPSG) prescribes this, it is not how most datasets are currently stored. As most other software, package <strong>sf</strong> by default ignores this and interprets ellipsoidal coordinate pairs as (longitude, latitude) by default. If however data needs to be read from a data source that is compliant to the authority, for instance from a WFS service, one can set</p>
<div class="cell">
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_axis_order</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>to globally instruct <strong>sf</strong>, when calling GDAL and PROJ routines, that authority compliance (latitude, longitude order) is assumed. It is anticipated that problems may happen in case of authority compliance, for instance when with plotting data. The <code>plot</code> method for <code>sf</code> objects respects the axis order flag and will swap coordinates using the transformation pipeline <code>"+proj=pipeline +step +proj=axisswap +order=2,1"</code> before plotting them, but <code>geom_sf</code> in <code>ggplot2</code> has not been modified to do this. As mentioned earlier, the axis order ambiguity of <code>EPSG:4326</code> is resolved by replacing it with <code>OGC:CRS84</code>.</p>
<p>Independent from the axis order, not all coordinate reference systems have an axis direction that is positive in North and East directions. Most plotting functions in R will not work with data that have axes defined in opposite directions. Information on axes directions and units can be retrieved by</p>
<div class="cell">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span><span class="op">$</span><span class="va">axes</span></span>
<span><span class="co">#                 name orientation</span></span>
<span><span class="co"># 1  Geodetic latitude           1</span></span>
<span><span class="co"># 2 Geodetic longitude           3</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span><span class="op">$</span><span class="va">ud_unit</span></span>
<span><span class="co"># 1 [°]</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">"EPSG:2053"</span><span class="op">)</span><span class="op">$</span><span class="va">axes</span></span>
<span><span class="co">#       name orientation</span></span>
<span><span class="co"># 1  Westing           4</span></span>
<span><span class="co"># 2 Southing           2</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">"EPSG:2053"</span><span class="op">)</span><span class="op">$</span><span class="va">ud_unit</span></span>
<span><span class="co"># 1 [m]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="sec-warp" class="level2" data-number="7.8"><h2 data-number="7.8" class="anchored" data-anchor-id="sec-warp">
<span class="header-section-number">7.8</span> Transforming and warping rasters</h2>
<p> </p>
<p>When using <code>st_transform</code> on a raster dataset, as in</p>
<div class="cell">
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="st">'OGC:CRS84'</span><span class="op">)</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># L7_ETMs.tif     1      54     69 68.9      86  255</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to         refsys point                    values x/y</span></span>
<span><span class="co"># x       1 349 WGS 84 (CRS84) FALSE [349x352] -34.9,...,-34.8 [x]</span></span>
<span><span class="co"># y       1 352 WGS 84 (CRS84) FALSE [349x352] -8.04,...,-7.95 [y]</span></span>
<span><span class="co"># band    1   6             NA    NA                      NULL    </span></span>
<span><span class="co"># curvilinear grid</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>we see that a <em>curvilinear</em> is created, which means that for every grid cell the coordinates are computed in the new CRS, which no longer form a <em>regular</em> grid. Plotting such data is extremely slow, as small polygons are computed for every grid cell and then plotted. The advantage of this is that no information is lost: grid cell values remain identical after the projection.</p>
<p>When we start with a raster on a regular grid and want to obtain a <em>regular</em> grid in a new coordinate reference system, we need to <em>warp</em> the grid: we need to recreate a grid at new locations and use some rule to assign values to new grid cells. Rules can involve using the nearest value or using some form of interpolation. This operation is not lossless and not invertible.</p>
<p>The best approach for warping is to specify the target grid as a <code>stars</code> object. When only a target CRS is specified, default options for the target grid are picked that may be completely inappropriate for the problem at hand. An example workflow that uses only a target CRS is</p>
<div class="cell">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_warp.html">st_warp</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">'OGC:CRS84'</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_dimensions</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#      from  to offset     delta         refsys x/y</span></span>
<span><span class="co"># x       1 350  -34.9  0.000259 WGS 84 (CRS84) [x]</span></span>
<span><span class="co"># y       1 352  -7.95 -0.000259 WGS 84 (CRS84) [y]</span></span>
<span><span class="co"># band    1   6     NA        NA             NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which creates a pretty close raster, but then the transformation is also relatively modest. For a workflow that creates a target raster first, here with exactly the same number of rows and columns as the original raster, one could use:</p>
<div class="cell">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span></span>
<span><span class="va">grd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="st">'OGC:CRS84'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span>nx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">[</span><span class="st">"x"</span><span class="op">]</span>, ny <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">[</span><span class="st">"y"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_warp.html">st_warp</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">grd</span><span class="op">)</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max. NA's</span></span>
<span><span class="co"># L7_ETMs.tif     1      54     69 68.9      86  255 6180</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from  to offset     delta         refsys x/y</span></span>
<span><span class="co"># x       1 349  -34.9   0.00026 WGS 84 (CRS84) [x]</span></span>
<span><span class="co"># y       1 352  -7.95 -0.000259 WGS 84 (CRS84) [y]</span></span>
<span><span class="co"># band    1   6     NA        NA             NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where we see that grid resolution in <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> directions slightly varies.</p>
</section><section id="exercises" class="level2" data-number="7.9"><h2 data-number="7.9" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">7.9</span> Exercises</h2>
<p>Use R to solve the following exercises.</p>
<ol type="1">
<li>Find the names of the <code>nc</code> counties that intersect <code>LINESTRING(-84 35,-78 35)</code>; use <code>[</code> for this, and as an alternative use <code>st_join</code> for this.</li>
<li>Repeat this after setting <code>sf_use_s2(FALSE)</code>, and <em>compute</em> the difference (hint: use <code>setdiff</code>), and colour the counties of the difference using colour ‘#88000088’.</li>
<li>Plot the two different lines in a single plot; note that R will plot a straight line always straight in the projection currently used; <code>st_segmentize</code> can be used to add points on a straight line, or on a great circle for ellipsoidal coordinates.</li>
<li>NDVI, normalised differenced vegetation index, is computed as <code>(NIR-R)/(NIR+R)</code>, with NIR the near infrared and R the red band. Read the <code>L7_ETMs.tif</code> file into object <code>x</code>, and distribute the band dimensions over attributes by <code>split(x, "band")</code>. Then, add attribute NDVI to this object by using an expression that uses the NIR (band 4) and R (band 3) attributes directly.</li>
<li>Compute NDVI for the <code>L7_ETMs.tif</code> image by reducing the band dimension, using <code>st_apply</code> and a function <code>ndvi = function(x) { (x[4]-x[3])/(x[4]+x[3]) }</code>. Plot the result, and write the result to a GeoTIFF.</li>
<li>Use <code>st_transform</code> to transform the <code>stars</code> object read from <code>L7_ETMs.tif</code> to <code>OGC:CRS84</code>. Print the object. Is this a regular grid? Plot the first band using arguments <code>axes=TRUE</code> and <code>border=NA</code>, and explain why this takes such a long time.</li>
<li>Use <code>st_warp</code> to warp the <code>L7_ETMs.tif</code> object to <code>OGC:CRS84</code>, and plot the resulting object with <code>axes=TRUE</code>. Why is the plot created much faster than after <code>st_transform</code>?</li>
<li>Using a vector representation of the raster <code>L7_ETMs</code>, plot the intersection with a circular area around <code>POINT(293716 9113692)</code> with radius 75 m, and compute the area-weighted mean pixel values for this circle. Compare the area-weighted values with those obtained by <code>aggregate</code> using the vector data, and by <code>aggregate</code> using the raster data, using <code>exact=FALSE</code> (default) and <code>exact=TRUE</code>. Explain the differences.</li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-R-s2" class="csl-entry" role="listitem">
Dunnington, Dewey, Edzer Pebesma, and Ege Rubak. 2023. <em>S2: Spherical Geometry Operators Using the S2 Geometry Library</em>. <a href="https://CRAN.R-project.org/package=s2">https://CRAN.R-project.org/package=s2</a>.
</div>
<div id="ref-cf" class="csl-entry" role="listitem">
Eaton, Brian, Jonathan Gregory, Bob Drach, Karl Taylor, Steve Hankin, Jon Blower, John Caron, et al. 2022. <em>NetCDF Climate and Forecast (CF) Metadata Conventions, Version 1.10</em>. <a href="https://cfconventions.org/">https://cfconventions.org/</a>.
</div>
<div id="ref-eddelbuettel2013seamless" class="csl-entry" role="listitem">
Eddelbuettel, Dirk. 2013. <em>Seamless <span>R</span> and <span>C++</span> Integration with <span>Rcpp</span></em>. Springer.
</div>
<div id="ref-RJ-2016-014" class="csl-entry" role="listitem">
Gräler, Benedikt, Edzer Pebesma, and Gerard Heuvelink. 2016. <span>“<span class="nocase">Spatio-Temporal Interpolation using gstat</span>.”</span> <em><span>The R Journal</span></em> 8 (1): 204–18. <a href="https://doi.org/10.32614/RJ-2016-014">https://doi.org/10.32614/RJ-2016-014</a>.
</div>
<div id="ref-herring2011opengis" class="csl-entry" role="listitem">
Herring, J. R. et al. 2011. <span>“Opengis<span></span> Implementation Standard for Geographic Information-Simple Feature Access-Part 1: Common Architecture [Corrigendum].”</span>
</div>
<div id="ref-R-raster" class="csl-entry" role="listitem">
Hijmans, Robert J. 2023a. <em>Raster: Geographic Data Analysis and Modeling</em>. <a href="https://rspatial.org/raster">https://rspatial.org/raster</a>.
</div>
<div id="ref-R-terra" class="csl-entry" role="listitem">
———. 2023b. <em>Terra: Spatial Data Analysis</em>. <a href="https://rspatial.org/terra/">https://rspatial.org/terra/</a>.
</div>
<div id="ref-geocomp" class="csl-entry" role="listitem">
Lovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2019. <em>Geocomputation with <span>R</span></em>. Chapman &amp; Hall/CRC.<a href="https://geocompr.robinlovelace.net/%20">https://geocompr.robinlovelace.net/ </a>.
</div>
<div id="ref-R-gdalUtilities" class="csl-entry" role="listitem">
O’Brien, Joshua. 2022. <em>gdalUtilities: Wrappers for GDAL Utilities Executables</em>. <a href="https://github.com/JoshOBrien/gdalUtilities/">https://github.com/JoshOBrien/gdalUtilities/</a>.
</div>
<div id="ref-spacetime2012" class="csl-entry" role="listitem">
Pebesma, Edzer. 2012. <span>“<span class="nocase">spacetime</span>: Spatio-Temporal Data in <span>R</span>.”</span> <em>Journal of Statistical Software</em> 51 (7): 1–30. <a href="https://www.jstatsoft.org/v51/i07/">https://www.jstatsoft.org/v51/i07/</a>.
</div>
<div id="ref-rjsf" class="csl-entry" role="listitem">
———. 2018. <span>“<span class="nocase">Simple Features for R: Standardized Support for Spatial Vector Data</span>.”</span> <em><span>The R Journal</span></em> 10 (1): 439–46. <a href="https://doi.org/10.32614/RJ-2018-009">https://doi.org/10.32614/RJ-2018-009</a>.
</div>
<div id="ref-R-spacetime" class="csl-entry" role="listitem">
———. 2022. <em>Spacetime: Classes and Methods for Spatio-Temporal Data</em>. <a href="https://github.com/edzer/spacetime">https://github.com/edzer/spacetime</a>.
</div>
<div id="ref-R-abind" class="csl-entry" role="listitem">
Plate, Tony, and Richard Heiberger. 2016. <em>Abind: Combine Multidimensional Arrays</em>. <a href="https://CRAN.R-project.org/package=abind">https://CRAN.R-project.org/package=abind</a>.
</div>
<div id="ref-R-sftime" class="csl-entry" role="listitem">
Teickner, Henning, Edzer Pebesma, and Benedikt Graeler. 2022. <em>Sftime: Classes and Methods for Simple Feature Objects That Have a Time Column</em>. <a href="https://CRAN.R-project.org/package=sftime">https://CRAN.R-project.org/package=sftime</a>.
</div>
<div id="ref-R-tsibble" class="csl-entry" role="listitem">
Wang, Earo, Di Cook, Rob Hyndman, and Mitchell O’Hara-Wild. 2022. <em>Tsibble: Tidy Temporal Data Frames and Tools</em>. <a href="https://tsibble.tidyverts.org">https://tsibble.tidyverts.org</a>.
</div>
<div id="ref-tidy" class="csl-entry" role="listitem">
Wickham, Hadley. 2014. <span>“Tidy Data.”</span> <em>Journal of Statistical Software</em> 59 (1).<a href="https://www.jstatsoft.org/article/view/v059i10%20">https://www.jstatsoft.org/article/view/v059i10 </a>.
</div>
<div id="ref-welcome" class="csl-entry" role="listitem">
Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. <span>“Welcome to the Tidyverse.”</span> <em>Journal of Open Source Software</em> 4 (43): 1686. <a href="https://joss.theoj.org/papers/10.21105/joss.01686">https://joss.theoj.org/papers/10.21105/joss.01686</a>.
</div>
<div id="ref-r4ds" class="csl-entry" role="listitem">
Wickham, Hadley, and Garret Grolemund. 2017. <em>R for Data Science</em>. O’Reilly. <a href="http://r4ds.had.co.nz/">http://r4ds.had.co.nz/</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/r-spatial\.org\/book\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./part-2.html" class="pagination-link" aria-label="R for Spatial Data Science">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">R for Spatial Data Science</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./08-Plotting.html" class="pagination-link" aria-label="Plotting spatial data">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb98" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction to sf and stars {#sec-sf}</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>\index{sf}</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>This chapter introduces R packages **sf** and **stars**.  **sf** provides</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>a table format for simple features, where feature geometries are</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>stored in a list-column.  R package **stars** was written to support</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>raster and vector data cubes (@sec-datacube), supporting</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>raster layers, raster stacks and feature time series as special cases.  **sf**</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>first appeared on CRAN in 2016, **stars** in 2018.  Development of both</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>packages received support from the R Consortium as well as strong</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>community engagement. The packages were designed to work together.</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>Functions or methods operating on **sf** or **stars** objects start</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>with <span class="in">`st_`</span>, making it easy to recognise them or to search for them</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>when using command line completion.</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a><span class="fu">## Package **sf** {#sec-sfintro}</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>\index{sf!introduction}</span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>\index{sp}</span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>\index{rgeos}</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>\index{rgdal}</span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>Intended to succeed and replace R packages **sp**, **rgeos** and the</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>vector parts of **rgdal**, R package **sf** <span class="co">[</span><span class="ot">@rjsf</span><span class="co">]</span> was developed to</span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a>move spatial data analysis in R closer to standards-based approaches</span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>seen in the industry and open source projects, to build upon more</span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>modern versions of the open source geospatial software stack</span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>(@fig-gdal-fig-nodetails), and to allow for integration of R spatial</span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>software with the tidyverse <span class="co">[</span><span class="ot">@welcome</span><span class="co">]</span>, if desired.</span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>\index{tidyverse}</span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a>To do so, R package **sf** provides simple features access</span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@herring2011opengis</span><span class="co">]</span>, natively, to R. It provides an interface</span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a>to several **tidyverse** packages, in particular to **ggplot2**,</span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a>**dplyr**, and **tidyr**. It can read and write data through GDAL, execute</span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a>geometrical operations using GEOS (for projected coordinates)</span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a>or s2geometry (for ellipsoidal coordinates), and carry out</span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a>coordinate transformations or conversions using PROJ. External C++</span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a>libraries are interfaced using R package **Rcpp** <span class="co">[</span><span class="ot">@eddelbuettel2013seamless</span><span class="co">]</span>.</span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a>\index{tidyr}</span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a>\index{dplyr}</span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a>\index{Rcpp}</span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a>Package **sf** represents sets of simple features in <span class="in">`sf`</span> objects,</span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a>a sub-class of a <span class="in">`data.frame`</span> or tibble. <span class="in">`sf`</span> objects contain at</span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>least one _geometry list-column_ of class <span class="in">`sfc`</span>, which for each</span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a>element contains the geometry as an R object of class <span class="in">`sfg`</span>.</span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a>A geometry list-column acts as a variable in a <span class="in">`data.frame`</span></span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a>or tibble, but has a more complex structure than basic vectors</span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a>such as numeric or character variables <span class="co">[</span><span class="ot">@sec-dissecting</span><span class="co">]</span>.</span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a>\index{sfc, class}</span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a>\index{sfg, class}</span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a>An <span class="in">`sf`</span> object has the following metadata:</span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>the name of the (active) geometry column, held in attribute <span class="in">`sf_column`</span></span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>for each non-geometry variable, the attribute-geometry</span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a>relationship (@sec-agr), held in attribute <span class="in">`agr`</span></span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{sf<span class="sc">\_</span>column}</span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a>\index{agr, attribute-geometry relationship}</span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>geometry}</span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a>An <span class="in">`sfc`</span> geometry list-column is extracted from an <span class="in">`sf`</span> object with</span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a><span class="in">`st_geometry`</span> and has the following metadata:</span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>coordinate reference system held in attribute <span class="in">`crs`</span></span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>bounding box held in attribute <span class="in">`bbox`</span></span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>precision held in attribute <span class="in">`precision`</span></span>
<span id="cb98-75"><a href="#cb98-75" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>number of empty geometries held in attribute <span class="in">`n_empty`</span></span>
<span id="cb98-76"><a href="#cb98-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-77"><a href="#cb98-77" aria-hidden="true" tabindex="-1"></a>\index{crs!attribute}</span>
<span id="cb98-78"><a href="#cb98-78" aria-hidden="true" tabindex="-1"></a>\index{bbox!attribute}</span>
<span id="cb98-79"><a href="#cb98-79" aria-hidden="true" tabindex="-1"></a>\index{precision!attribute}</span>
<span id="cb98-80"><a href="#cb98-80" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>bbox}</span>
<span id="cb98-81"><a href="#cb98-81" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>precision}</span>
<span id="cb98-82"><a href="#cb98-82" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>agr}</span>
<span id="cb98-83"><a href="#cb98-83" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>set<span class="sc">\_</span>bbox}</span>
<span id="cb98-84"><a href="#cb98-84" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>set<span class="sc">\_</span>precision}</span>
<span id="cb98-85"><a href="#cb98-85" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>set<span class="sc">\_</span>agr}</span>
<span id="cb98-86"><a href="#cb98-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-87"><a href="#cb98-87" aria-hidden="true" tabindex="-1"></a>These attributes may best be accessed or set by using</span>
<span id="cb98-88"><a href="#cb98-88" aria-hidden="true" tabindex="-1"></a>functions like <span class="in">`st_bbox`</span>, <span class="in">`st_crs`</span>, <span class="in">`st_set_crs`</span>, <span class="in">`st_agr`</span>,</span>
<span id="cb98-89"><a href="#cb98-89" aria-hidden="true" tabindex="-1"></a><span class="in">`st_set_agr`</span>, <span class="in">`st_precision`</span>, and <span class="in">`st_set_precision`</span>.</span>
<span id="cb98-90"><a href="#cb98-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-91"><a href="#cb98-91" aria-hidden="true" tabindex="-1"></a>Geometry columns in <span class="in">`sf`</span> objects can be set or replaced using</span>
<span id="cb98-92"><a href="#cb98-92" aria-hidden="true" tabindex="-1"></a><span class="in">`st_geometry&lt;-`</span> or <span class="in">`st_set_geometry`</span>.</span>
<span id="cb98-93"><a href="#cb98-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-94"><a href="#cb98-94" aria-hidden="true" tabindex="-1"></a><span class="fu">### Creation</span></span>
<span id="cb98-95"><a href="#cb98-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-96"><a href="#cb98-96" aria-hidden="true" tabindex="-1"></a>\index{sf!create from scratch}</span>
<span id="cb98-97"><a href="#cb98-97" aria-hidden="true" tabindex="-1"></a>An <span class="in">`sf`</span> object can be created from scratch by</span>
<span id="cb98-98"><a href="#cb98-98" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE}</span></span>
<span id="cb98-99"><a href="#cb98-99" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb98-100"><a href="#cb98-100" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- st_point(c(7.35, 52.42))</span></span>
<span id="cb98-101"><a href="#cb98-101" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- st_point(c(7.22, 52.18))</span></span>
<span id="cb98-102"><a href="#cb98-102" aria-hidden="true" tabindex="-1"></a><span class="in">p3 &lt;- st_point(c(7.44, 52.19))</span></span>
<span id="cb98-103"><a href="#cb98-103" aria-hidden="true" tabindex="-1"></a><span class="in">sfc &lt;- st_sfc(list(p1, p2, p3), crs = 'OGC:CRS84')</span></span>
<span id="cb98-104"><a href="#cb98-104" aria-hidden="true" tabindex="-1"></a><span class="in">st_sf(elev = c(33.2, 52.1, 81.2), </span></span>
<span id="cb98-105"><a href="#cb98-105" aria-hidden="true" tabindex="-1"></a><span class="in">      marker = c("Id01", "Id02", "Id03"), geom = sfc)</span></span>
<span id="cb98-106"><a href="#cb98-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-107"><a href="#cb98-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-108"><a href="#cb98-108" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-sfobj, echo = FALSE}</span></span>
<span id="cb98-109"><a href="#cb98-109" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: components of an `sf` object</span></span>
<span id="cb98-110"><a href="#cb98-110" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 100%</span></span>
<span id="cb98-111"><a href="#cb98-111" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/sf_obj.png")</span></span>
<span id="cb98-112"><a href="#cb98-112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-113"><a href="#cb98-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-114"><a href="#cb98-114" aria-hidden="true" tabindex="-1"></a>@fig-sfobj gives an explanation of the components</span>
<span id="cb98-115"><a href="#cb98-115" aria-hidden="true" tabindex="-1"></a>printed. Rather than creating objects from scratch, spatial data</span>
<span id="cb98-116"><a href="#cb98-116" aria-hidden="true" tabindex="-1"></a>in R are typically read from an external source, which can be:</span>
<span id="cb98-117"><a href="#cb98-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-118"><a href="#cb98-118" aria-hidden="true" tabindex="-1"></a>\index{sf!components figure}</span>
<span id="cb98-119"><a href="#cb98-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-120"><a href="#cb98-120" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>external file</span>
<span id="cb98-121"><a href="#cb98-121" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>table (or set of tables) in a database</span>
<span id="cb98-122"><a href="#cb98-122" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>request to a web service</span>
<span id="cb98-123"><a href="#cb98-123" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>dataset held in some form in another R package</span>
<span id="cb98-124"><a href="#cb98-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-125"><a href="#cb98-125" aria-hidden="true" tabindex="-1"></a>The next section introduces reading from files. </span>
<span id="cb98-126"><a href="#cb98-126" aria-hidden="true" tabindex="-1"></a>@sec-largesf discusses handling of datasets too large to fit into</span>
<span id="cb98-127"><a href="#cb98-127" aria-hidden="true" tabindex="-1"></a>working memory.</span>
<span id="cb98-128"><a href="#cb98-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-129"><a href="#cb98-129" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reading and writing</span></span>
<span id="cb98-130"><a href="#cb98-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-131"><a href="#cb98-131" aria-hidden="true" tabindex="-1"></a>Reading datasets from an external "data source" (file, web service,</span>
<span id="cb98-132"><a href="#cb98-132" aria-hidden="true" tabindex="-1"></a>or even string) is done using <span class="in">`st_read`</span>:</span>
<span id="cb98-133"><a href="#cb98-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-134"><a href="#cb98-134" aria-hidden="true" tabindex="-1"></a>\index{sf!read from file}</span>
<span id="cb98-135"><a href="#cb98-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-136"><a href="#cb98-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r stread}</span></span>
<span id="cb98-137"><a href="#cb98-137" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb98-138"><a href="#cb98-138" aria-hidden="true" tabindex="-1"></a><span class="in">(file &lt;- system.file("gpkg/nc.gpkg", package = "sf"))</span></span>
<span id="cb98-139"><a href="#cb98-139" aria-hidden="true" tabindex="-1"></a><span class="in">nc &lt;- st_read(file)</span></span>
<span id="cb98-140"><a href="#cb98-140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-141"><a href="#cb98-141" aria-hidden="true" tabindex="-1"></a>Here, the file name and path <span class="in">`file`</span> is read from the **sf** package,</span>
<span id="cb98-142"><a href="#cb98-142" aria-hidden="true" tabindex="-1"></a>which has a different path on every machine, and hence is guaranteed</span>
<span id="cb98-143"><a href="#cb98-143" aria-hidden="true" tabindex="-1"></a>to be present on every **sf** installation.</span>
<span id="cb98-144"><a href="#cb98-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-145"><a href="#cb98-145" aria-hidden="true" tabindex="-1"></a>\index{geopackage}</span>
<span id="cb98-146"><a href="#cb98-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-147"><a href="#cb98-147" aria-hidden="true" tabindex="-1"></a>Command <span class="in">`st_read`</span> has two arguments: the _data source name_ (<span class="in">`dsn`</span>)</span>
<span id="cb98-148"><a href="#cb98-148" aria-hidden="true" tabindex="-1"></a>and the _layer_.  In the example above, the _geopackage_  (GPKG) file</span>
<span id="cb98-149"><a href="#cb98-149" aria-hidden="true" tabindex="-1"></a>contains only a single layer that is being read. If it had contained</span>
<span id="cb98-150"><a href="#cb98-150" aria-hidden="true" tabindex="-1"></a>multiple layers, then the first layer would have been read and a </span>
<span id="cb98-151"><a href="#cb98-151" aria-hidden="true" tabindex="-1"></a>warning would have been emitted. The available layers of a dataset </span>
<span id="cb98-152"><a href="#cb98-152" aria-hidden="true" tabindex="-1"></a>can be queried by</span>
<span id="cb98-155"><a href="#cb98-155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-156"><a href="#cb98-156" aria-hidden="true" tabindex="-1"></a><span class="fu">st_layers</span>(file)</span>
<span id="cb98-157"><a href="#cb98-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-158"><a href="#cb98-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-159"><a href="#cb98-159" aria-hidden="true" tabindex="-1"></a>Simple feature objects can be written with <span class="in">`st_write`</span>, as in</span>
<span id="cb98-162"><a href="#cb98-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-163"><a href="#cb98-163" aria-hidden="true" tabindex="-1"></a>(<span class="at">file =</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".gpkg"</span>))</span>
<span id="cb98-164"><a href="#cb98-164" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(nc, file, <span class="at">layer =</span> <span class="st">"layer_nc"</span>)</span>
<span id="cb98-165"><a href="#cb98-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-166"><a href="#cb98-166" aria-hidden="true" tabindex="-1"></a>where the file format (GPKG) is derived from the file name extension.</span>
<span id="cb98-167"><a href="#cb98-167" aria-hidden="true" tabindex="-1"></a>Using argument <span class="in">`append`</span>, <span class="in">`st_write`</span> can either append records</span>
<span id="cb98-168"><a href="#cb98-168" aria-hidden="true" tabindex="-1"></a>to an existing layer or replace it; if unset, it will err if a</span>
<span id="cb98-169"><a href="#cb98-169" aria-hidden="true" tabindex="-1"></a>layer already exists. The tidyverse-style <span class="in">`write_sf`</span> will replace</span>
<span id="cb98-170"><a href="#cb98-170" aria-hidden="true" tabindex="-1"></a>silently if <span class="in">`append`</span> has not been set.  Layers can also be deleted</span>
<span id="cb98-171"><a href="#cb98-171" aria-hidden="true" tabindex="-1"></a>using <span class="in">`st_delete`</span>, which is convenient in particular when they are associated</span>
<span id="cb98-172"><a href="#cb98-172" aria-hidden="true" tabindex="-1"></a>with tables in a database.</span>
<span id="cb98-173"><a href="#cb98-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-174"><a href="#cb98-174" aria-hidden="true" tabindex="-1"></a>For file formats supporting a WKT-2 coordinate reference system,</span>
<span id="cb98-175"><a href="#cb98-175" aria-hidden="true" tabindex="-1"></a><span class="in">`sf_read`</span> and <span class="in">`sf_write`</span> will read and write it. For simple formats</span>
<span id="cb98-176"><a href="#cb98-176" aria-hidden="true" tabindex="-1"></a>such as <span class="in">`csv`</span> this will not work. The shapefile format supports</span>
<span id="cb98-177"><a href="#cb98-177" aria-hidden="true" tabindex="-1"></a>only a very limited encoding of the CRS.</span>
<span id="cb98-178"><a href="#cb98-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-179"><a href="#cb98-179" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">functions</span><span class="co">]</span>{st<span class="sc">\_</span>write}</span>
<span id="cb98-180"><a href="#cb98-180" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">functions</span><span class="co">]</span>{write<span class="sc">\_</span>sf}</span>
<span id="cb98-181"><a href="#cb98-181" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">functions</span><span class="co">]</span>{st<span class="sc">\_</span>delete}</span>
<span id="cb98-182"><a href="#cb98-182" aria-hidden="true" tabindex="-1"></a>\index{sf!update, append to a layer}</span>
<span id="cb98-183"><a href="#cb98-183" aria-hidden="true" tabindex="-1"></a>\index{sf!delete a layer}</span>
<span id="cb98-184"><a href="#cb98-184" aria-hidden="true" tabindex="-1"></a>\index{sf!write to file}</span>
<span id="cb98-185"><a href="#cb98-185" aria-hidden="true" tabindex="-1"></a>\index{sf!coordinate reference system}</span>
<span id="cb98-186"><a href="#cb98-186" aria-hidden="true" tabindex="-1"></a>\index{WKT-2}</span>
<span id="cb98-187"><a href="#cb98-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-188"><a href="#cb98-188" aria-hidden="true" tabindex="-1"></a><span class="fu">### Subsetting</span></span>
<span id="cb98-189"><a href="#cb98-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-190"><a href="#cb98-190" aria-hidden="true" tabindex="-1"></a>\index{sf!subsetting}</span>
<span id="cb98-191"><a href="#cb98-191" aria-hidden="true" tabindex="-1"></a>\index{sf!filter}</span>
<span id="cb98-192"><a href="#cb98-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-193"><a href="#cb98-193" aria-hidden="true" tabindex="-1"></a>A very common operation is to subset objects; base R can use <span class="in">`[`</span></span>
<span id="cb98-194"><a href="#cb98-194" aria-hidden="true" tabindex="-1"></a>for this. The rules that apply to <span class="in">`data.frame`</span> objects also apply to</span>
<span id="cb98-195"><a href="#cb98-195" aria-hidden="true" tabindex="-1"></a><span class="in">`sf`</span> objects: records 2-5 and columns 3-7 are selected by</span>
<span id="cb98-196"><a href="#cb98-196" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb98-197"><a href="#cb98-197" aria-hidden="true" tabindex="-1"></a><span class="in">nc[2:5, 3:7]</span></span>
<span id="cb98-198"><a href="#cb98-198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-199"><a href="#cb98-199" aria-hidden="true" tabindex="-1"></a>but with a few additional features, in particular:</span>
<span id="cb98-200"><a href="#cb98-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-201"><a href="#cb98-201" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>the <span class="in">`drop`</span> argument is by default <span class="in">`FALSE`</span> meaning that the</span>
<span id="cb98-202"><a href="#cb98-202" aria-hidden="true" tabindex="-1"></a>  geometry column is _always_ selected, and an <span class="in">`sf`</span> object is</span>
<span id="cb98-203"><a href="#cb98-203" aria-hidden="true" tabindex="-1"></a>  returned; when it is set to <span class="in">`TRUE`</span> and the geometry column is _not_ selected,</span>
<span id="cb98-204"><a href="#cb98-204" aria-hidden="true" tabindex="-1"></a>  it is dropped and a <span class="in">`data.frame`</span> is returned</span>
<span id="cb98-205"><a href="#cb98-205" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>selection with a spatial (<span class="in">`sf`</span>, <span class="in">`sfc`</span> or <span class="in">`sfg`</span>) object as first argument leads to</span>
<span id="cb98-206"><a href="#cb98-206" aria-hidden="true" tabindex="-1"></a>  selection of the features that spatially _intersect_ with that</span>
<span id="cb98-207"><a href="#cb98-207" aria-hidden="true" tabindex="-1"></a>  object (see next section); other predicates than _intersects_ can be chosen by setting</span>
<span id="cb98-208"><a href="#cb98-208" aria-hidden="true" tabindex="-1"></a>  parameter <span class="in">`op`</span> to a function such as <span class="in">`st_covers`</span> or any other</span>
<span id="cb98-209"><a href="#cb98-209" aria-hidden="true" tabindex="-1"></a>  binary predicate function listed in @sec-de9im.</span>
<span id="cb98-210"><a href="#cb98-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-211"><a href="#cb98-211" aria-hidden="true" tabindex="-1"></a><span class="fu">### Binary predicates</span></span>
<span id="cb98-212"><a href="#cb98-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-213"><a href="#cb98-213" aria-hidden="true" tabindex="-1"></a>\index{sf!select using predicates}</span>
<span id="cb98-214"><a href="#cb98-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-215"><a href="#cb98-215" aria-hidden="true" tabindex="-1"></a>Binary predicates like <span class="in">`st_intersects`</span>, <span class="in">`st_covers`</span> and such (@sec-de9im)</span>
<span id="cb98-216"><a href="#cb98-216" aria-hidden="true" tabindex="-1"></a>take two sets of features or feature geometries and return for</span>
<span id="cb98-217"><a href="#cb98-217" aria-hidden="true" tabindex="-1"></a>all pairs whether the predicate is <span class="in">`TRUE`</span> or <span class="in">`FALSE`</span>. For large</span>
<span id="cb98-218"><a href="#cb98-218" aria-hidden="true" tabindex="-1"></a>sets this would potentially result in a huge matrix, typically filled </span>
<span id="cb98-219"><a href="#cb98-219" aria-hidden="true" tabindex="-1"></a>mostly with <span class="in">`FALSE`</span> values and for that reason a sparse representation </span>
<span id="cb98-220"><a href="#cb98-220" aria-hidden="true" tabindex="-1"></a>is returned by default:</span>
<span id="cb98-223"><a href="#cb98-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-224"><a href="#cb98-224" aria-hidden="true" tabindex="-1"></a>nc5 <span class="ot">&lt;-</span> nc[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, ]</span>
<span id="cb98-225"><a href="#cb98-225" aria-hidden="true" tabindex="-1"></a>nc7 <span class="ot">&lt;-</span> nc[<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, ]</span>
<span id="cb98-226"><a href="#cb98-226" aria-hidden="true" tabindex="-1"></a>(i <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(nc5, nc7))</span>
<span id="cb98-227"><a href="#cb98-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-228"><a href="#cb98-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-229"><a href="#cb98-229" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-fig57, echo=!knitr::is_latex_output()}</span></span>
<span id="cb98-230"><a href="#cb98-230" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "First seven North Carolina counties"</span></span>
<span id="cb98-231"><a href="#cb98-231" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-232"><a href="#cb98-232" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.height: 2.5</span></span>
<span id="cb98-233"><a href="#cb98-233" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(nc7))</span></span>
<span id="cb98-234"><a href="#cb98-234" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(nc5), add = TRUE, border = "brown")</span></span>
<span id="cb98-235"><a href="#cb98-235" aria-hidden="true" tabindex="-1"></a><span class="in">cc = st_coordinates(st_centroid(st_geometry(nc7)))</span></span>
<span id="cb98-236"><a href="#cb98-236" aria-hidden="true" tabindex="-1"></a><span class="in">text(cc, labels = 1:nrow(nc7), col = "blue")</span></span>
<span id="cb98-237"><a href="#cb98-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-238"><a href="#cb98-238" aria-hidden="true" tabindex="-1"></a>@fig-fig57  shows how the intersections of the first</span>
<span id="cb98-239"><a href="#cb98-239" aria-hidden="true" tabindex="-1"></a>five with the first seven counties can be understood.</span>
<span id="cb98-240"><a href="#cb98-240" aria-hidden="true" tabindex="-1"></a>We can transform the sparse logical matrix into a dense matrix by</span>
<span id="cb98-243"><a href="#cb98-243" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-244"><a href="#cb98-244" aria-hidden="true" tabindex="-1"></a><span class="fu">as.matrix</span>(i)</span>
<span id="cb98-245"><a href="#cb98-245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-246"><a href="#cb98-246" aria-hidden="true" tabindex="-1"></a>The number of counties that each of <span class="in">`nc5`</span> intersects with is</span>
<span id="cb98-249"><a href="#cb98-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-250"><a href="#cb98-250" aria-hidden="true" tabindex="-1"></a><span class="fu">lengths</span>(i)</span>
<span id="cb98-251"><a href="#cb98-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-252"><a href="#cb98-252" aria-hidden="true" tabindex="-1"></a>and the other way around, the number of counties in <span class="in">`nc5`</span> that</span>
<span id="cb98-253"><a href="#cb98-253" aria-hidden="true" tabindex="-1"></a>intersect with each of the counties in <span class="in">`nc7`</span>  is</span>
<span id="cb98-256"><a href="#cb98-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-257"><a href="#cb98-257" aria-hidden="true" tabindex="-1"></a><span class="fu">lengths</span>(<span class="fu">t</span>(i))</span>
<span id="cb98-258"><a href="#cb98-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-259"><a href="#cb98-259" aria-hidden="true" tabindex="-1"></a>The object <span class="in">`i`</span> is of class <span class="in">`sgbp`</span> (sparse geometrical binary</span>
<span id="cb98-260"><a href="#cb98-260" aria-hidden="true" tabindex="-1"></a>predicate), and is a list of integer vectors, with each element</span>
<span id="cb98-261"><a href="#cb98-261" aria-hidden="true" tabindex="-1"></a>representing a row in the logical predicate matrix holding the column</span>
<span id="cb98-262"><a href="#cb98-262" aria-hidden="true" tabindex="-1"></a>indices of the <span class="in">`TRUE`</span> values for that row. It further holds some</span>
<span id="cb98-263"><a href="#cb98-263" aria-hidden="true" tabindex="-1"></a>metadata like the predicate used, and the total number of columns.</span>
<span id="cb98-264"><a href="#cb98-264" aria-hidden="true" tabindex="-1"></a>Methods available for <span class="in">`sgbp`</span> objects include</span>
<span id="cb98-267"><a href="#cb98-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-268"><a href="#cb98-268" aria-hidden="true" tabindex="-1"></a><span class="fu">methods</span>(<span class="at">class =</span> <span class="st">"sgbp"</span>)</span>
<span id="cb98-269"><a href="#cb98-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-270"><a href="#cb98-270" aria-hidden="true" tabindex="-1"></a>where the only <span class="in">`Ops`</span> method available is <span class="in">`!`</span>, the negation operation.</span>
<span id="cb98-271"><a href="#cb98-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-272"><a href="#cb98-272" aria-hidden="true" tabindex="-1"></a><span class="fu">### tidyverse </span></span>
<span id="cb98-273"><a href="#cb98-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-274"><a href="#cb98-274" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{read<span class="sc">\_</span>sf}</span>
<span id="cb98-275"><a href="#cb98-275" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{write<span class="sc">\_</span>sf}</span>
<span id="cb98-276"><a href="#cb98-276" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{filter}</span>
<span id="cb98-277"><a href="#cb98-277" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{select}</span>
<span id="cb98-278"><a href="#cb98-278" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{group<span class="sc">\_</span>by}</span>
<span id="cb98-279"><a href="#cb98-279" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{ungroup}</span>
<span id="cb98-280"><a href="#cb98-280" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{mutate}</span>
<span id="cb98-281"><a href="#cb98-281" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{transmute}</span>
<span id="cb98-282"><a href="#cb98-282" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{rowwise}</span>
<span id="cb98-283"><a href="#cb98-283" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{rename}</span>
<span id="cb98-284"><a href="#cb98-284" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{slice}</span>
<span id="cb98-285"><a href="#cb98-285" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{summarise}</span>
<span id="cb98-286"><a href="#cb98-286" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{distinct}</span>
<span id="cb98-287"><a href="#cb98-287" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{gather}</span>
<span id="cb98-288"><a href="#cb98-288" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{pivot<span class="sc">\_</span>longer}</span>
<span id="cb98-289"><a href="#cb98-289" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{spread}</span>
<span id="cb98-290"><a href="#cb98-290" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{nest}</span>
<span id="cb98-291"><a href="#cb98-291" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{unnest}</span>
<span id="cb98-292"><a href="#cb98-292" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{unite}</span>
<span id="cb98-293"><a href="#cb98-293" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{separate}</span>
<span id="cb98-294"><a href="#cb98-294" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{separate<span class="sc">\_</span>rows}</span>
<span id="cb98-295"><a href="#cb98-295" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{sample<span class="sc">\_</span>n}</span>
<span id="cb98-296"><a href="#cb98-296" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{sample<span class="sc">\_</span>frac}</span>
<span id="cb98-297"><a href="#cb98-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-298"><a href="#cb98-298" aria-hidden="true" tabindex="-1"></a>The **tidyverse** package loads a collection of data science packages that work</span>
<span id="cb98-299"><a href="#cb98-299" aria-hidden="true" tabindex="-1"></a>well together <span class="co">[</span><span class="ot">@r4ds; @welcome</span><span class="co">]</span>. Package **sf** has</span>
<span id="cb98-300"><a href="#cb98-300" aria-hidden="true" tabindex="-1"></a>**tidyverse**-style read and write functions, <span class="in">`read_sf`</span> and <span class="in">`write_sf`</span></span>
<span id="cb98-301"><a href="#cb98-301" aria-hidden="true" tabindex="-1"></a>that </span>
<span id="cb98-302"><a href="#cb98-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-303"><a href="#cb98-303" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>return a tibble rather than a <span class="in">`data.frame`</span>, </span>
<span id="cb98-304"><a href="#cb98-304" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>do not print any output, and</span>
<span id="cb98-305"><a href="#cb98-305" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>overwrite existing data by default.</span>
<span id="cb98-306"><a href="#cb98-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-307"><a href="#cb98-307" aria-hidden="true" tabindex="-1"></a>Further **tidyverse** generics with methods for <span class="in">`sf`</span> objects include</span>
<span id="cb98-308"><a href="#cb98-308" aria-hidden="true" tabindex="-1"></a><span class="in">`filter`</span>, <span class="in">`select`</span>, <span class="in">`group_by`</span>, <span class="in">`ungroup`</span>, <span class="in">`mutate`</span>, <span class="in">`transmute`</span>,</span>
<span id="cb98-309"><a href="#cb98-309" aria-hidden="true" tabindex="-1"></a><span class="in">`rowwise`</span>, <span class="in">`rename`</span>, <span class="in">`slice`</span>, <span class="in">`summarise`</span>, <span class="in">`distinct`</span>, <span class="in">`gather`</span>, <span class="in">`pivot_longer`</span>,</span>
<span id="cb98-310"><a href="#cb98-310" aria-hidden="true" tabindex="-1"></a><span class="in">`spread`</span>, <span class="in">`nest`</span>, <span class="in">`unnest`</span>, <span class="in">`unite`</span>, <span class="in">`separate`</span>, <span class="in">`separate_rows`</span>,</span>
<span id="cb98-311"><a href="#cb98-311" aria-hidden="true" tabindex="-1"></a><span class="in">`sample_n`</span>, and <span class="in">`sample_frac`</span>. Most of these methods simply manage</span>
<span id="cb98-312"><a href="#cb98-312" aria-hidden="true" tabindex="-1"></a>the metadata of <span class="in">`sf`</span> objects and make sure the geometry remains</span>
<span id="cb98-313"><a href="#cb98-313" aria-hidden="true" tabindex="-1"></a>present. In case a user wants the geometry to be removed, one can</span>
<span id="cb98-314"><a href="#cb98-314" aria-hidden="true" tabindex="-1"></a>use <span class="in">`st_drop_geometry`</span> or simply coerce to a <span class="in">`tibble`</span> or </span>
<span id="cb98-315"><a href="#cb98-315" aria-hidden="true" tabindex="-1"></a><span class="in">`data.frame`</span> before selecting:</span>
<span id="cb98-318"><a href="#cb98-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-319"><a href="#cb98-319" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="sc">|&gt;</span> <span class="fu">suppressPackageStartupMessages</span>()</span>
<span id="cb98-320"><a href="#cb98-320" aria-hidden="true" tabindex="-1"></a>nc <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(BIR74) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>)</span>
<span id="cb98-321"><a href="#cb98-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-322"><a href="#cb98-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-323"><a href="#cb98-323" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{summarise}</span>
<span id="cb98-324"><a href="#cb98-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-325"><a href="#cb98-325" aria-hidden="true" tabindex="-1"></a>The <span class="in">`summarise`</span> method for <span class="in">`sf`</span> objects has two special arguments:</span>
<span id="cb98-326"><a href="#cb98-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-327"><a href="#cb98-327" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`do_union`</span> (default <span class="in">`TRUE`</span>) determines whether grouped geometries are unioned on return, so that they form a valid geometry</span>
<span id="cb98-328"><a href="#cb98-328" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`is_coverage`</span> (default <span class="in">`FALSE`</span>) in case the geometries grouped form a coverage (do not have overlaps), setting this to <span class="in">`TRUE`</span> speeds up the unioning</span>
<span id="cb98-329"><a href="#cb98-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-330"><a href="#cb98-330" aria-hidden="true" tabindex="-1"></a>The <span class="in">`distinct`</span> method selects distinct records, where <span class="in">`st_equals`</span></span>
<span id="cb98-331"><a href="#cb98-331" aria-hidden="true" tabindex="-1"></a>is used to evaluate distinctness of geometries.</span>
<span id="cb98-332"><a href="#cb98-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-333"><a href="#cb98-333" aria-hidden="true" tabindex="-1"></a><span class="in">`filter`</span> can be used with the usual predicates; when one wants to</span>
<span id="cb98-334"><a href="#cb98-334" aria-hidden="true" tabindex="-1"></a>use it with a spatial predicate, for instance to select all counties less</span>
<span id="cb98-335"><a href="#cb98-335" aria-hidden="true" tabindex="-1"></a>than 50 km away from Orange County, one could use</span>
<span id="cb98-338"><a href="#cb98-338" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-339"><a href="#cb98-339" aria-hidden="true" tabindex="-1"></a>orange <span class="ot">&lt;-</span> nc <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Orange"</span>)</span>
<span id="cb98-340"><a href="#cb98-340" aria-hidden="true" tabindex="-1"></a>wd <span class="ot">&lt;-</span> <span class="fu">st_is_within_distance</span>(nc, orange, </span>
<span id="cb98-341"><a href="#cb98-341" aria-hidden="true" tabindex="-1"></a>                            units<span class="sc">::</span><span class="fu">set_units</span>(<span class="dv">50</span>, km))</span>
<span id="cb98-342"><a href="#cb98-342" aria-hidden="true" tabindex="-1"></a>o50 <span class="ot">&lt;-</span> nc <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">lengths</span>(wd) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb98-343"><a href="#cb98-343" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(o50)</span>
<span id="cb98-344"><a href="#cb98-344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-345"><a href="#cb98-345" aria-hidden="true" tabindex="-1"></a>(where we use <span class="in">`dplyr::filter`</span> rather than <span class="in">`filter`</span> to avoid confusion</span>
<span id="cb98-346"><a href="#cb98-346" aria-hidden="true" tabindex="-1"></a>with <span class="in">`filter`</span> from base R.)</span>
<span id="cb98-347"><a href="#cb98-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-348"><a href="#cb98-348" aria-hidden="true" tabindex="-1"></a>@fig-orangebuffer  shows the results of this analysis,</span>
<span id="cb98-349"><a href="#cb98-349" aria-hidden="true" tabindex="-1"></a>and in addition a buffer around the county borders. Note that this buffer</span>
<span id="cb98-350"><a href="#cb98-350" aria-hidden="true" tabindex="-1"></a>serves for illustration: it was _not_ used to select the counties. </span>
<span id="cb98-351"><a href="#cb98-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-352"><a href="#cb98-352" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-orangebuffer, echo=!knitr::is_latex_output()}</span></span>
<span id="cb98-353"><a href="#cb98-353" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Orange County (orange), counties within a 50 km radius (black), a 50~km buffer around Orange County (brown), and remaining counties (grey)"</span></span>
<span id="cb98-354"><a href="#cb98-354" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-355"><a href="#cb98-355" aria-hidden="true" tabindex="-1"></a><span class="in">og &lt;- st_geometry(orange)</span></span>
<span id="cb98-356"><a href="#cb98-356" aria-hidden="true" tabindex="-1"></a><span class="in">buf50 &lt;- st_buffer(og, units::set_units(50, km))</span></span>
<span id="cb98-357"><a href="#cb98-357" aria-hidden="true" tabindex="-1"></a><span class="in">all &lt;- c(buf50, st_geometry(o50))</span></span>
<span id="cb98-358"><a href="#cb98-358" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(o50), lwd = 2, extent = all)</span></span>
<span id="cb98-359"><a href="#cb98-359" aria-hidden="true" tabindex="-1"></a><span class="in">plot(og, col = 'orange', add = TRUE)</span></span>
<span id="cb98-360"><a href="#cb98-360" aria-hidden="true" tabindex="-1"></a><span class="in">plot(buf50, add = TRUE, col = NA, border = 'brown')</span></span>
<span id="cb98-361"><a href="#cb98-361" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(nc), add = TRUE, border = 'grey')</span></span>
<span id="cb98-362"><a href="#cb98-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-363"><a href="#cb98-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-364"><a href="#cb98-364" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial joins</span></span>
<span id="cb98-365"><a href="#cb98-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-366"><a href="#cb98-366" aria-hidden="true" tabindex="-1"></a>\index{sf!spatial join}</span>
<span id="cb98-367"><a href="#cb98-367" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>join}</span>
<span id="cb98-368"><a href="#cb98-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-369"><a href="#cb98-369" aria-hidden="true" tabindex="-1"></a>In regular (left, right, or inner) joins, _joined_ records from a</span>
<span id="cb98-370"><a href="#cb98-370" aria-hidden="true" tabindex="-1"></a>pair of tables are reported when one or more selected attributes</span>
<span id="cb98-371"><a href="#cb98-371" aria-hidden="true" tabindex="-1"></a>match (are identical) in both tables. A spatial join is similar,</span>
<span id="cb98-372"><a href="#cb98-372" aria-hidden="true" tabindex="-1"></a>but the criterion to join records is not equality of attributes but</span>
<span id="cb98-373"><a href="#cb98-373" aria-hidden="true" tabindex="-1"></a>a spatial predicate. This leaves a wide variety of options in order</span>
<span id="cb98-374"><a href="#cb98-374" aria-hidden="true" tabindex="-1"></a>to define _spatially_ matching records, using binary predicates</span>
<span id="cb98-375"><a href="#cb98-375" aria-hidden="true" tabindex="-1"></a>listed in @sec-de9im. The concepts of "left", "right",</span>
<span id="cb98-376"><a href="#cb98-376" aria-hidden="true" tabindex="-1"></a>"inner", or "full" joins remain identical to the non-spatial join</span>
<span id="cb98-377"><a href="#cb98-377" aria-hidden="true" tabindex="-1"></a>as the options for handling records that have no spatial match.</span>
<span id="cb98-378"><a href="#cb98-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-379"><a href="#cb98-379" aria-hidden="true" tabindex="-1"></a>When using spatial joins, each record may have several matched</span>
<span id="cb98-380"><a href="#cb98-380" aria-hidden="true" tabindex="-1"></a>records, yielding a large result table. A way to reduce this</span>
<span id="cb98-381"><a href="#cb98-381" aria-hidden="true" tabindex="-1"></a>complexity may be to select from the matching records the one with</span>
<span id="cb98-382"><a href="#cb98-382" aria-hidden="true" tabindex="-1"></a>the largest overlap with the target geometry.  An example of this</span>
<span id="cb98-383"><a href="#cb98-383" aria-hidden="true" tabindex="-1"></a>is shown (visually) in @fig-largest; this is done using</span>
<span id="cb98-384"><a href="#cb98-384" aria-hidden="true" tabindex="-1"></a><span class="in">`st_join`</span> with argument <span class="in">`largest = TRUE`</span>.</span>
<span id="cb98-385"><a href="#cb98-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-386"><a href="#cb98-386" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-largest, echo=!knitr::is_latex_output()}</span></span>
<span id="cb98-387"><a href="#cb98-387" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Example of `st_join` with `largest = TRUE`: the label of the polygon in the top figure with the largest intersection with polygons in the bottom figure is assigned to the polygons of the bottom figure."</span></span>
<span id="cb98-388"><a href="#cb98-388" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-389"><a href="#cb98-389" aria-hidden="true" tabindex="-1"></a><span class="in"># example of largest = TRUE:</span></span>
<span id="cb98-390"><a href="#cb98-390" aria-hidden="true" tabindex="-1"></a><span class="in">system.file("gpkg/nc.gpkg", package="sf") |&gt; </span></span>
<span id="cb98-391"><a href="#cb98-391" aria-hidden="true" tabindex="-1"></a><span class="in">    read_sf() |&gt;</span></span>
<span id="cb98-392"><a href="#cb98-392" aria-hidden="true" tabindex="-1"></a><span class="in">    st_transform('EPSG:2264') -&gt; nc</span></span>
<span id="cb98-393"><a href="#cb98-393" aria-hidden="true" tabindex="-1"></a><span class="in">gr &lt;- st_sf(</span></span>
<span id="cb98-394"><a href="#cb98-394" aria-hidden="true" tabindex="-1"></a><span class="in">         label = apply(expand.grid(1:10, LETTERS[10:1])[,2:1], 1, paste0, collapse = ""),</span></span>
<span id="cb98-395"><a href="#cb98-395" aria-hidden="true" tabindex="-1"></a><span class="in">         geom = st_make_grid(nc))</span></span>
<span id="cb98-396"><a href="#cb98-396" aria-hidden="true" tabindex="-1"></a><span class="in">gr$col &lt;- sf.colors(10, categorical = TRUE, alpha = .3)</span></span>
<span id="cb98-397"><a href="#cb98-397" aria-hidden="true" tabindex="-1"></a><span class="in"># cut, to verify that NA's work out:</span></span>
<span id="cb98-398"><a href="#cb98-398" aria-hidden="true" tabindex="-1"></a><span class="in">gr &lt;- gr[-(1:30),]</span></span>
<span id="cb98-399"><a href="#cb98-399" aria-hidden="true" tabindex="-1"></a><span class="in">suppressWarnings(nc_j &lt;- st_join(nc, gr, largest = TRUE))</span></span>
<span id="cb98-400"><a href="#cb98-400" aria-hidden="true" tabindex="-1"></a><span class="in">par(mfrow = c(2,1), mar = rep(0,4))</span></span>
<span id="cb98-401"><a href="#cb98-401" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(nc_j), border = 'grey')</span></span>
<span id="cb98-402"><a href="#cb98-402" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(gr), add = TRUE, col = gr$col)</span></span>
<span id="cb98-403"><a href="#cb98-403" aria-hidden="true" tabindex="-1"></a><span class="in">text(st_coordinates(st_centroid(st_geometry(gr))), labels = gr$label, cex = .85)</span></span>
<span id="cb98-404"><a href="#cb98-404" aria-hidden="true" tabindex="-1"></a><span class="in"># the joined dataset:</span></span>
<span id="cb98-405"><a href="#cb98-405" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(nc_j), border = 'grey', col = nc_j$col)</span></span>
<span id="cb98-406"><a href="#cb98-406" aria-hidden="true" tabindex="-1"></a><span class="in">text(st_coordinates(st_centroid(st_geometry(nc_j))), labels = nc_j$label, cex = .7)</span></span>
<span id="cb98-407"><a href="#cb98-407" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(gr), border = '#88ff88aa', add = TRUE)</span></span>
<span id="cb98-408"><a href="#cb98-408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-409"><a href="#cb98-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-410"><a href="#cb98-410" aria-hidden="true" tabindex="-1"></a>\index{aggregate!sf}</span>
<span id="cb98-411"><a href="#cb98-411" aria-hidden="true" tabindex="-1"></a>\index{sf!aggregate}</span>
<span id="cb98-412"><a href="#cb98-412" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{aggregate}</span>
<span id="cb98-413"><a href="#cb98-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-414"><a href="#cb98-414" aria-hidden="true" tabindex="-1"></a>Another way to reduce the result set is to use <span class="in">`aggregate`</span> after</span>
<span id="cb98-415"><a href="#cb98-415" aria-hidden="true" tabindex="-1"></a>a join, to merge all matching records, and union their geometries;</span>
<span id="cb98-416"><a href="#cb98-416" aria-hidden="true" tabindex="-1"></a>see @sec-updownscaling.</span>
<span id="cb98-417"><a href="#cb98-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-418"><a href="#cb98-418" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sampling, gridding, interpolating</span></span>
<span id="cb98-419"><a href="#cb98-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-420"><a href="#cb98-420" aria-hidden="true" tabindex="-1"></a>Several convenience functions are available in package **sf**, some</span>
<span id="cb98-421"><a href="#cb98-421" aria-hidden="true" tabindex="-1"></a>of which will be discussed here. Function <span class="in">`st_sample`</span> generates</span>
<span id="cb98-422"><a href="#cb98-422" aria-hidden="true" tabindex="-1"></a>a sample of points randomly sampled from target geometries, where</span>
<span id="cb98-423"><a href="#cb98-423" aria-hidden="true" tabindex="-1"></a>target geometries can be point, line, or polygon geometries. Sampling</span>
<span id="cb98-424"><a href="#cb98-424" aria-hidden="true" tabindex="-1"></a>strategies can be (completely) random, regular, or (with polygons)</span>
<span id="cb98-425"><a href="#cb98-425" aria-hidden="true" tabindex="-1"></a>triangular.  @sec-pointpatterns explains how spatial sampling</span>
<span id="cb98-426"><a href="#cb98-426" aria-hidden="true" tabindex="-1"></a>(or point pattern simulation) methods available in package **spatstat**</span>
<span id="cb98-427"><a href="#cb98-427" aria-hidden="true" tabindex="-1"></a>are interfaced through <span class="in">`st_sample`</span>.</span>
<span id="cb98-428"><a href="#cb98-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-429"><a href="#cb98-429" aria-hidden="true" tabindex="-1"></a>Function <span class="in">`st_make_grid`</span> creates a square, rectangular, or hexagonal</span>
<span id="cb98-430"><a href="#cb98-430" aria-hidden="true" tabindex="-1"></a>grid over a region, or points with the grid centres or corners. It</span>
<span id="cb98-431"><a href="#cb98-431" aria-hidden="true" tabindex="-1"></a>was used to create the rectangular grid in @fig-largest.</span>
<span id="cb98-432"><a href="#cb98-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-433"><a href="#cb98-433" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>make<span class="sc">\_</span>grid}</span>
<span id="cb98-434"><a href="#cb98-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-435"><a href="#cb98-435" aria-hidden="true" tabindex="-1"></a>Function <span class="in">`st_interpolate_aw`</span> "interpolates" area values to new areas,</span>
<span id="cb98-436"><a href="#cb98-436" aria-hidden="true" tabindex="-1"></a>as explained in @sec-area-weighted, both for intensive</span>
<span id="cb98-437"><a href="#cb98-437" aria-hidden="true" tabindex="-1"></a>and extensive variables.</span>
<span id="cb98-438"><a href="#cb98-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-439"><a href="#cb98-439" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>interpolate<span class="sc">\_</span>aw}</span>
<span id="cb98-440"><a href="#cb98-440" aria-hidden="true" tabindex="-1"></a>\index{interpolation!area-weighted}</span>
<span id="cb98-441"><a href="#cb98-441" aria-hidden="true" tabindex="-1"></a>\index{area-weighted interpolation}</span>
<span id="cb98-442"><a href="#cb98-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-443"><a href="#cb98-443" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ellipsoidal coordinates {#sec-ccw}</span></span>
<span id="cb98-444"><a href="#cb98-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-445"><a href="#cb98-445" aria-hidden="true" tabindex="-1"></a>Unprojected data have ellipsoidal coordinates, expressed in degrees</span>
<span id="cb98-446"><a href="#cb98-446" aria-hidden="true" tabindex="-1"></a>east and north. As explained in @sec-straight, "straight" lines</span>
<span id="cb98-447"><a href="#cb98-447" aria-hidden="true" tabindex="-1"></a>between points are the curved shortest paths ("geodesic"). By</span>
<span id="cb98-448"><a href="#cb98-448" aria-hidden="true" tabindex="-1"></a>default, **sf** uses geometrical operations from the <span class="in">`s2geometry`</span></span>
<span id="cb98-449"><a href="#cb98-449" aria-hidden="true" tabindex="-1"></a>library, interfaced through the **s2** package <span class="co">[</span><span class="ot">@R-s2</span><span class="co">]</span>, and we see</span>
<span id="cb98-450"><a href="#cb98-450" aria-hidden="true" tabindex="-1"></a>for instance that the point</span>
<span id="cb98-451"><a href="#cb98-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-454"><a href="#cb98-454" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-455"><a href="#cb98-455" aria-hidden="true" tabindex="-1"></a><span class="st">"POINT(50 50.1)"</span> <span class="sc">|&gt;</span> <span class="fu">st_as_sfc</span>(<span class="at">crs =</span> <span class="st">"OGC:CRS84"</span>) <span class="ot">-&gt;</span> pt</span>
<span id="cb98-456"><a href="#cb98-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-457"><a href="#cb98-457" aria-hidden="true" tabindex="-1"></a>falls _inside_ the polygon:</span>
<span id="cb98-460"><a href="#cb98-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-461"><a href="#cb98-461" aria-hidden="true" tabindex="-1"></a><span class="st">"POLYGON((40 40, 60 40, 60 50, 40 50, 40 40))"</span> <span class="sc">|&gt;</span></span>
<span id="cb98-462"><a href="#cb98-462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sfc</span>(<span class="at">crs =</span> <span class="st">"OGC:CRS84"</span>) <span class="ot">-&gt;</span> pol</span>
<span id="cb98-463"><a href="#cb98-463" aria-hidden="true" tabindex="-1"></a><span class="fu">st_intersects</span>(pt, pol)</span>
<span id="cb98-464"><a href="#cb98-464" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-465"><a href="#cb98-465" aria-hidden="true" tabindex="-1"></a>as illustrated by @fig-figs2 (left: straight lines on an orthographic projection centred at the plot area).</span>
<span id="cb98-466"><a href="#cb98-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-467"><a href="#cb98-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-figs2, echo=!knitr::is_latex_output()}</span></span>
<span id="cb98-468"><a href="#cb98-468" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Intersection depends on whether we use geodesics/great circle arcs (left: s2) or Cartesian coordinates (right)"</span></span>
<span id="cb98-469"><a href="#cb98-469" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-470"><a href="#cb98-470" aria-hidden="true" tabindex="-1"></a><span class="in">par(mfrow = c(1, 2))</span></span>
<span id="cb98-471"><a href="#cb98-471" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = c(2.1, 2.1, 1.2, .5))</span></span>
<span id="cb98-472"><a href="#cb98-472" aria-hidden="true" tabindex="-1"></a><span class="in">ortho &lt;- st_crs("+proj=ortho +lon_0=50 +lat_0=45")</span></span>
<span id="cb98-473"><a href="#cb98-473" aria-hidden="true" tabindex="-1"></a><span class="in">pol |&gt; st_transform(ortho) |&gt; plot(axes = TRUE, graticule = TRUE, </span></span>
<span id="cb98-474"><a href="#cb98-474" aria-hidden="true" tabindex="-1"></a><span class="in">                                   main = 's2geometry')</span></span>
<span id="cb98-475"><a href="#cb98-475" aria-hidden="true" tabindex="-1"></a><span class="in">pt |&gt; st_transform(ortho) |&gt; plot(add = TRUE, pch = 16, col = 'red')</span></span>
<span id="cb98-476"><a href="#cb98-476" aria-hidden="true" tabindex="-1"></a><span class="in"># second plot:</span></span>
<span id="cb98-477"><a href="#cb98-477" aria-hidden="true" tabindex="-1"></a><span class="in">plot(pol, axes = TRUE, graticule = TRUE, main = 'GEOS')</span></span>
<span id="cb98-478"><a href="#cb98-478" aria-hidden="true" tabindex="-1"></a><span class="in">plot(pt, add = TRUE, pch = 16, col = 'red')</span></span>
<span id="cb98-479"><a href="#cb98-479" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-480"><a href="#cb98-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-481"><a href="#cb98-481" aria-hidden="true" tabindex="-1"></a>If one wants **sf** to use ellipsoidal coordinates as if they are Cartesian coordinates, the use of **s2** can be switched off:</span>
<span id="cb98-484"><a href="#cb98-484" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-485"><a href="#cb98-485" aria-hidden="true" tabindex="-1"></a>old <span class="ot">&lt;-</span> <span class="fu">sf_use_s2</span>(<span class="cn">FALSE</span>)</span>
<span id="cb98-486"><a href="#cb98-486" aria-hidden="true" tabindex="-1"></a><span class="fu">st_intersects</span>(pol, pt)</span>
<span id="cb98-487"><a href="#cb98-487" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_use_s2</span>(old) <span class="co"># restore</span></span>
<span id="cb98-488"><a href="#cb98-488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-489"><a href="#cb98-489" aria-hidden="true" tabindex="-1"></a>and the intersection is empty, as illustrated by @fig-figs2 (right:</span>
<span id="cb98-490"><a href="#cb98-490" aria-hidden="true" tabindex="-1"></a>straight lines on an equidistant cylindrical projection). The</span>
<span id="cb98-491"><a href="#cb98-491" aria-hidden="true" tabindex="-1"></a>warning indicates the planar assumption for ellipsoidal coordinates.</span>
<span id="cb98-492"><a href="#cb98-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-493"><a href="#cb98-493" aria-hidden="true" tabindex="-1"></a>Use of **s2** can be switched off for reasons of performance</span>
<span id="cb98-494"><a href="#cb98-494" aria-hidden="true" tabindex="-1"></a>or compatibility with legacy implementations.  The underlying</span>
<span id="cb98-495"><a href="#cb98-495" aria-hidden="true" tabindex="-1"></a>libraries, **GEOS** for Cartesian and **s2geometry** for spherical</span>
<span id="cb98-496"><a href="#cb98-496" aria-hidden="true" tabindex="-1"></a>geometry (@fig-gdal-fig-nodetails) were developed with different</span>
<span id="cb98-497"><a href="#cb98-497" aria-hidden="true" tabindex="-1"></a>motivations, and their use through **sf** differs in some respects:</span>
<span id="cb98-498"><a href="#cb98-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-499"><a href="#cb98-499" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>certain operations may be much faster in one compared to the other,</span>
<span id="cb98-500"><a href="#cb98-500" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>certain functions may be available in only one of them (like <span class="in">`st_relate`</span> being only present in GEOS),</span>
<span id="cb98-501"><a href="#cb98-501" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>when using transformers, **GEOS** returns exterior polygon rings</span>
<span id="cb98-502"><a href="#cb98-502" aria-hidden="true" tabindex="-1"></a>  noded clockwise (<span class="in">`st_sfc(..., check_ring_dir = TRUE)`</span> can be used</span>
<span id="cb98-503"><a href="#cb98-503" aria-hidden="true" tabindex="-1"></a>  to revert to counter-clockwise), **s2geometry** returns them</span>
<span id="cb98-504"><a href="#cb98-504" aria-hidden="true" tabindex="-1"></a>  counter-clockwise</span>
<span id="cb98-505"><a href="#cb98-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-506"><a href="#cb98-506" aria-hidden="true" tabindex="-1"></a><span class="fu">## Package **stars**</span></span>
<span id="cb98-507"><a href="#cb98-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-508"><a href="#cb98-508" aria-hidden="true" tabindex="-1"></a>\index{stars}</span>
<span id="cb98-509"><a href="#cb98-509" aria-hidden="true" tabindex="-1"></a>\index{raster}</span>
<span id="cb98-510"><a href="#cb98-510" aria-hidden="true" tabindex="-1"></a>\index{terra}</span>
<span id="cb98-511"><a href="#cb98-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-512"><a href="#cb98-512" aria-hidden="true" tabindex="-1"></a>Although package **sp** has always had limited support for raster data,</span>
<span id="cb98-513"><a href="#cb98-513" aria-hidden="true" tabindex="-1"></a>over the last decade R package **raster** <span class="co">[</span><span class="ot">@R-raster</span><span class="co">]</span> has clearly been</span>
<span id="cb98-514"><a href="#cb98-514" aria-hidden="true" tabindex="-1"></a>dominant as the prime package for powerful, flexible, and scalable</span>
<span id="cb98-515"><a href="#cb98-515" aria-hidden="true" tabindex="-1"></a>raster analysis.  The raster data model of package **raster** (and</span>
<span id="cb98-516"><a href="#cb98-516" aria-hidden="true" tabindex="-1"></a>its successor, **terra** <span class="co">[</span><span class="ot">@R-terra</span><span class="co">]</span>) is that of a 2D regular raster,</span>
<span id="cb98-517"><a href="#cb98-517" aria-hidden="true" tabindex="-1"></a>or a set of raster layers ("raster stack"). This aligns with</span>
<span id="cb98-518"><a href="#cb98-518" aria-hidden="true" tabindex="-1"></a>the classical static "GIS view", where the world is modelled</span>
<span id="cb98-519"><a href="#cb98-519" aria-hidden="true" tabindex="-1"></a>as a set of layers, each representing a different theme. A lot of</span>
<span id="cb98-520"><a href="#cb98-520" aria-hidden="true" tabindex="-1"></a>data available today however is dynamic, and comes as time series</span>
<span id="cb98-521"><a href="#cb98-521" aria-hidden="true" tabindex="-1"></a>of rasters or raster stacks. A raster stack does not meaningfully</span>
<span id="cb98-522"><a href="#cb98-522" aria-hidden="true" tabindex="-1"></a>reflect this, requiring the user to keep a register of which layer</span>
<span id="cb98-523"><a href="#cb98-523" aria-hidden="true" tabindex="-1"></a>represents what.</span>
<span id="cb98-524"><a href="#cb98-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-525"><a href="#cb98-525" aria-hidden="true" tabindex="-1"></a>Also, the **raster** package and its successor **terra** do an excellent</span>
<span id="cb98-526"><a href="#cb98-526" aria-hidden="true" tabindex="-1"></a>job in scaling computations up to data sizes no larger than the local</span>
<span id="cb98-527"><a href="#cb98-527" aria-hidden="true" tabindex="-1"></a>storage (the computer's hard drives), and doing this fast. Recent</span>
<span id="cb98-528"><a href="#cb98-528" aria-hidden="true" tabindex="-1"></a>datasets, however, including satellite imagery, climate model or</span>
<span id="cb98-529"><a href="#cb98-529" aria-hidden="true" tabindex="-1"></a>weather forecasting data, often no longer fit in local storage</span>
<span id="cb98-530"><a href="#cb98-530" aria-hidden="true" tabindex="-1"></a>(@sec-large).  Package **spacetime** <span class="co">[</span><span class="ot">@spacetime2012; @R-spacetime</span><span class="co">]</span></span>
<span id="cb98-531"><a href="#cb98-531" aria-hidden="true" tabindex="-1"></a>did address the analysis of time series of vector geometries or</span>
<span id="cb98-532"><a href="#cb98-532" aria-hidden="true" tabindex="-1"></a>raster grid cells, but did not extend to higher-dimensional arrays</span>
<span id="cb98-533"><a href="#cb98-533" aria-hidden="true" tabindex="-1"></a>or datasets too large to fit in main memory.</span>
<span id="cb98-534"><a href="#cb98-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-535"><a href="#cb98-535" aria-hidden="true" tabindex="-1"></a>\index{spacetime}</span>
<span id="cb98-536"><a href="#cb98-536" aria-hidden="true" tabindex="-1"></a>\index{stars!data cube}</span>
<span id="cb98-537"><a href="#cb98-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-538"><a href="#cb98-538" aria-hidden="true" tabindex="-1"></a>Here, we introduce package **stars** for analysing raster and vector</span>
<span id="cb98-539"><a href="#cb98-539" aria-hidden="true" tabindex="-1"></a>data cubes. The package:</span>
<span id="cb98-540"><a href="#cb98-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-541"><a href="#cb98-541" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>allows for representing dynamic (time varying) raster stacks</span>
<span id="cb98-542"><a href="#cb98-542" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>aims at being scalable, also beyond local disk size</span>
<span id="cb98-543"><a href="#cb98-543" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>provides a strong integration of raster functions in the GDAL</span>
<span id="cb98-544"><a href="#cb98-544" aria-hidden="true" tabindex="-1"></a>library</span>
<span id="cb98-545"><a href="#cb98-545" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>handles, in addition to regular grids, rotated, sheared, rectilinear, and curvilinear rasters (@fig-rastertypes01) </span>
<span id="cb98-546"><a href="#cb98-546" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>provides a tight integration with package **sf**</span>
<span id="cb98-547"><a href="#cb98-547" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>handles array data with non-raster spatial dimensions, the _vector data cubes_</span>
<span id="cb98-548"><a href="#cb98-548" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>follows the tidyverse design principles</span>
<span id="cb98-549"><a href="#cb98-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-550"><a href="#cb98-550" aria-hidden="true" tabindex="-1"></a>Vector data cubes include for instance time series for simple</span>
<span id="cb98-551"><a href="#cb98-551" aria-hidden="true" tabindex="-1"></a>features, or spatial graph data such as potentially dynamic</span>
<span id="cb98-552"><a href="#cb98-552" aria-hidden="true" tabindex="-1"></a>origin-destination matrices. The concept of spatial vector and</span>
<span id="cb98-553"><a href="#cb98-553" aria-hidden="true" tabindex="-1"></a>raster data cubes was explained in @sec-datacube. Irregular</span>
<span id="cb98-554"><a href="#cb98-554" aria-hidden="true" tabindex="-1"></a>spacetime observations can be represented by <span class="in">`sftime`</span> objects</span>
<span id="cb98-555"><a href="#cb98-555" aria-hidden="true" tabindex="-1"></a>provided by package **sftime** <span class="co">[</span><span class="ot">@R-sftime</span><span class="co">]</span>, which extend <span class="in">`sf`</span></span>
<span id="cb98-556"><a href="#cb98-556" aria-hidden="true" tabindex="-1"></a>objects with a time column (@sec-stgeos).</span>
<span id="cb98-557"><a href="#cb98-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-558"><a href="#cb98-558" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reading and writing raster data</span></span>
<span id="cb98-559"><a href="#cb98-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-560"><a href="#cb98-560" aria-hidden="true" tabindex="-1"></a>\index{stars!reading data cube}</span>
<span id="cb98-561"><a href="#cb98-561" aria-hidden="true" tabindex="-1"></a>\index{data cube!read with stars}</span>
<span id="cb98-562"><a href="#cb98-562" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{read<span class="sc">\_</span>stars}</span>
<span id="cb98-563"><a href="#cb98-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-564"><a href="#cb98-564" aria-hidden="true" tabindex="-1"></a>Raster data typically are read from a file. We use a dataset</span>
<span id="cb98-565"><a href="#cb98-565" aria-hidden="true" tabindex="-1"></a>containing a section of Landsat 7 scene, with the six 30~m-resolution</span>
<span id="cb98-566"><a href="#cb98-566" aria-hidden="true" tabindex="-1"></a>bands (bands 1-5 and 7) for a region covering the city of Olinda,</span>
<span id="cb98-567"><a href="#cb98-567" aria-hidden="true" tabindex="-1"></a>Brazil. We can read the example GeoTIFF file holding a regular,</span>
<span id="cb98-568"><a href="#cb98-568" aria-hidden="true" tabindex="-1"></a>non-rotated grid from the package **stars**:</span>
<span id="cb98-571"><a href="#cb98-571" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-572"><a href="#cb98-572" aria-hidden="true" tabindex="-1"></a>tif <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"tif/L7_ETMs.tif"</span>, <span class="at">package =</span> <span class="st">"stars"</span>)</span>
<span id="cb98-573"><a href="#cb98-573" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span>
<span id="cb98-574"><a href="#cb98-574" aria-hidden="true" tabindex="-1"></a>(r <span class="ot">&lt;-</span> <span class="fu">read_stars</span>(tif))</span>
<span id="cb98-575"><a href="#cb98-575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-576"><a href="#cb98-576" aria-hidden="true" tabindex="-1"></a>where we see the offset, cell size, coordinate reference system,</span>
<span id="cb98-577"><a href="#cb98-577" aria-hidden="true" tabindex="-1"></a>and dimensions. The dimension table contains the following fields</span>
<span id="cb98-578"><a href="#cb98-578" aria-hidden="true" tabindex="-1"></a>for each dimension:</span>
<span id="cb98-579"><a href="#cb98-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-580"><a href="#cb98-580" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`from`</span>: starting index</span>
<span id="cb98-581"><a href="#cb98-581" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`to`</span>: ending index</span>
<span id="cb98-582"><a href="#cb98-582" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`offset`</span>: dimension value at the start (edge) of the first pixel</span>
<span id="cb98-583"><a href="#cb98-583" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`delta`</span>: cell size; negative <span class="in">`delta`</span> values indicate that pixel index increases with decreasing dimension values</span>
<span id="cb98-584"><a href="#cb98-584" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`refsys`</span>: reference system</span>
<span id="cb98-585"><a href="#cb98-585" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`point`</span>: logical, indicates whether cell values have point support or cell support</span>
<span id="cb98-586"><a href="#cb98-586" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`x/y`</span>: indicates whether a dimension is associated with a spatial raster x- or y-axis</span>
<span id="cb98-587"><a href="#cb98-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-588"><a href="#cb98-588" aria-hidden="true" tabindex="-1"></a>One further field, <span class="in">`values`</span>, is hidden here as it is not used.  For</span>
<span id="cb98-589"><a href="#cb98-589" aria-hidden="true" tabindex="-1"></a>regular, rotated, or sheared grids or other regularly discretised</span>
<span id="cb98-590"><a href="#cb98-590" aria-hidden="true" tabindex="-1"></a>dimensions (such as time), <span class="in">`offset`</span> and <span class="in">`delta`</span> are not <span class="in">`NA`</span>; for</span>
<span id="cb98-591"><a href="#cb98-591" aria-hidden="true" tabindex="-1"></a>irregular cases, <span class="in">`offset`</span> and <span class="in">`delta`</span> are <span class="in">`NA`</span> and the <span class="in">`values`</span></span>
<span id="cb98-592"><a href="#cb98-592" aria-hidden="true" tabindex="-1"></a>property contains one of:</span>
<span id="cb98-593"><a href="#cb98-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-594"><a href="#cb98-594" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>in case of a rectilinear spatial raster or irregular time dimension, the sequence of values or intervals</span>
<span id="cb98-595"><a href="#cb98-595" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>in case of a vector data cube, geometries associated with the spatial dimension</span>
<span id="cb98-596"><a href="#cb98-596" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>in case of a curvilinear raster, the matrix with coordinate values for each raster cell</span>
<span id="cb98-597"><a href="#cb98-597" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>in case of a discrete dimension, the band names or labels associated with the dimension values</span>
<span id="cb98-598"><a href="#cb98-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-599"><a href="#cb98-599" aria-hidden="true" tabindex="-1"></a>The object <span class="in">`r`</span> is of class <span class="in">`stars`</span> and is a simple list of length</span>
<span id="cb98-600"><a href="#cb98-600" aria-hidden="true" tabindex="-1"></a>one, holding a three-dimensional array:</span>
<span id="cb98-603"><a href="#cb98-603" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-604"><a href="#cb98-604" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(r)</span>
<span id="cb98-605"><a href="#cb98-605" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(r[[<span class="dv">1</span>]])</span>
<span id="cb98-606"><a href="#cb98-606" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(r[[<span class="dv">1</span>]])</span>
<span id="cb98-607"><a href="#cb98-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-608"><a href="#cb98-608" aria-hidden="true" tabindex="-1"></a>and in addition holds an attribute with a dimensions table with all the metadata</span>
<span id="cb98-609"><a href="#cb98-609" aria-hidden="true" tabindex="-1"></a>required to know what the array dimensions refer to, obtained by</span>
<span id="cb98-610"><a href="#cb98-610" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb98-611"><a href="#cb98-611" aria-hidden="true" tabindex="-1"></a><span class="in">st_dimensions(r)</span></span>
<span id="cb98-612"><a href="#cb98-612" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-613"><a href="#cb98-613" aria-hidden="true" tabindex="-1"></a>We can get the spatial extent of the array by</span>
<span id="cb98-616"><a href="#cb98-616" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-617"><a href="#cb98-617" aria-hidden="true" tabindex="-1"></a><span class="fu">st_bbox</span>(r)</span>
<span id="cb98-618"><a href="#cb98-618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-619"><a href="#cb98-619" aria-hidden="true" tabindex="-1"></a>Raster data can be written to the local disk using <span class="in">`write_stars`</span>:</span>
<span id="cb98-622"><a href="#cb98-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-623"><a href="#cb98-623" aria-hidden="true" tabindex="-1"></a>tf <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".tif"</span>)</span>
<span id="cb98-624"><a href="#cb98-624" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stars</span>(r, tf)</span>
<span id="cb98-625"><a href="#cb98-625" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-626"><a href="#cb98-626" aria-hidden="true" tabindex="-1"></a>where again the data format (in this case, GeoTIFF) is derived from the file</span>
<span id="cb98-627"><a href="#cb98-627" aria-hidden="true" tabindex="-1"></a>extension. As for simple features, reading and writing uses the GDAL</span>
<span id="cb98-628"><a href="#cb98-628" aria-hidden="true" tabindex="-1"></a>library; the list of available drivers for raster data is obtained</span>
<span id="cb98-629"><a href="#cb98-629" aria-hidden="true" tabindex="-1"></a>by </span>
<span id="cb98-630"><a href="#cb98-630" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb98-631"><a href="#cb98-631" aria-hidden="true" tabindex="-1"></a><span class="in">st_drivers("raster")</span></span>
<span id="cb98-632"><a href="#cb98-632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-633"><a href="#cb98-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-634"><a href="#cb98-634" aria-hidden="true" tabindex="-1"></a><span class="fu">### Subsetting `stars` data cubes</span></span>
<span id="cb98-635"><a href="#cb98-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-636"><a href="#cb98-636" aria-hidden="true" tabindex="-1"></a>\index{stars!subset}</span>
<span id="cb98-637"><a href="#cb98-637" aria-hidden="true" tabindex="-1"></a>\index{stars!filter}</span>
<span id="cb98-638"><a href="#cb98-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-639"><a href="#cb98-639" aria-hidden="true" tabindex="-1"></a>Data cubes can be subsetted using the <span class="in">`[`</span> operator, or using tidyverse verbs. The</span>
<span id="cb98-640"><a href="#cb98-640" aria-hidden="true" tabindex="-1"></a>first option uses <span class="in">`[`</span> with the following comma-separated arguments:</span>
<span id="cb98-641"><a href="#cb98-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-642"><a href="#cb98-642" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>attributes first (by name, index, or logical vector)</span>
<span id="cb98-643"><a href="#cb98-643" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>followed by each dimension. </span>
<span id="cb98-644"><a href="#cb98-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-645"><a href="#cb98-645" aria-hidden="true" tabindex="-1"></a>This means that <span class="in">`r[1:2, 101:200, , 5:10]`</span></span>
<span id="cb98-646"><a href="#cb98-646" aria-hidden="true" tabindex="-1"></a>selects from <span class="in">`r`</span> attributes 1-2, index 101-200 for dimension 1, and index</span>
<span id="cb98-647"><a href="#cb98-647" aria-hidden="true" tabindex="-1"></a>5-10 for dimension 3; omitting dimension 2 means that no subsetting</span>
<span id="cb98-648"><a href="#cb98-648" aria-hidden="true" tabindex="-1"></a>takes place. For attributes, attribute name, index or logical vectors</span>
<span id="cb98-649"><a href="#cb98-649" aria-hidden="true" tabindex="-1"></a>can be used. For dimensions, logical vectors are not supported.</span>
<span id="cb98-650"><a href="#cb98-650" aria-hidden="true" tabindex="-1"></a>Selecting discontinuous ranges is supported only when it is a regular</span>
<span id="cb98-651"><a href="#cb98-651" aria-hidden="true" tabindex="-1"></a>sequence. By default, <span class="in">`drop`</span> is FALSE, when set to <span class="in">`TRUE`</span> dimensions</span>
<span id="cb98-652"><a href="#cb98-652" aria-hidden="true" tabindex="-1"></a>with a single value are dropped:</span>
<span id="cb98-655"><a href="#cb98-655" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-656"><a href="#cb98-656" aria-hidden="true" tabindex="-1"></a>r[,<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="dv">5</span>), <span class="dv">4</span>] <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span>
<span id="cb98-657"><a href="#cb98-657" aria-hidden="true" tabindex="-1"></a>r[,<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="dv">5</span>), <span class="dv">4</span>, drop <span class="ot">=</span> <span class="cn">TRUE</span>] <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span>
<span id="cb98-658"><a href="#cb98-658" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-659"><a href="#cb98-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-660"><a href="#cb98-660" aria-hidden="true" tabindex="-1"></a>For selecting particular ranges of dimension _values_, one can use</span>
<span id="cb98-661"><a href="#cb98-661" aria-hidden="true" tabindex="-1"></a><span class="in">`filter`</span> (after loading <span class="in">`dplyr`</span>):</span>
<span id="cb98-664"><a href="#cb98-664" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-665"><a href="#cb98-665" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb98-666"><a href="#cb98-666" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(r, x <span class="sc">&gt;</span> <span class="dv">289000</span>, x <span class="sc">&lt;</span> <span class="dv">290000</span>)</span>
<span id="cb98-667"><a href="#cb98-667" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-668"><a href="#cb98-668" aria-hidden="true" tabindex="-1"></a>which changes the offset of the $x$ dimension. Particular cube slices</span>
<span id="cb98-669"><a href="#cb98-669" aria-hidden="true" tabindex="-1"></a>can also be obtained with <span class="in">`slice`</span>, as in</span>
<span id="cb98-672"><a href="#cb98-672" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-673"><a href="#cb98-673" aria-hidden="true" tabindex="-1"></a><span class="fu">slice</span>(r, band, <span class="dv">3</span>)</span>
<span id="cb98-674"><a href="#cb98-674" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-675"><a href="#cb98-675" aria-hidden="true" tabindex="-1"></a>which drops the singular dimension <span class="in">`band`</span>. <span class="in">`mutate`</span> can be used on <span class="in">`stars`</span></span>
<span id="cb98-676"><a href="#cb98-676" aria-hidden="true" tabindex="-1"></a>objects to add new arrays as functions of existing ones, <span class="in">`transmute`</span></span>
<span id="cb98-677"><a href="#cb98-677" aria-hidden="true" tabindex="-1"></a>drops existing ones.</span>
<span id="cb98-678"><a href="#cb98-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-679"><a href="#cb98-679" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cropping </span></span>
<span id="cb98-680"><a href="#cb98-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-681"><a href="#cb98-681" aria-hidden="true" tabindex="-1"></a>\index{crop raster dimensions}</span>
<span id="cb98-682"><a href="#cb98-682" aria-hidden="true" tabindex="-1"></a>\index{stars!crop}</span>
<span id="cb98-683"><a href="#cb98-683" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>crop}</span>
<span id="cb98-684"><a href="#cb98-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-685"><a href="#cb98-685" aria-hidden="true" tabindex="-1"></a>Further subsetting can be done using spatial objects of class <span class="in">`sf`</span>, <span class="in">`sfc`</span></span>
<span id="cb98-686"><a href="#cb98-686" aria-hidden="true" tabindex="-1"></a>or <span class="in">`bbox`</span>, for instance</span>
<span id="cb98-689"><a href="#cb98-689" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-690"><a href="#cb98-690" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(r) <span class="sc">|&gt;</span></span>
<span id="cb98-691"><a href="#cb98-691" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span></span>
<span id="cb98-692"><a href="#cb98-692" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_centroid</span>() <span class="sc">|&gt;</span></span>
<span id="cb98-693"><a href="#cb98-693" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_buffer</span>(units<span class="sc">::</span><span class="fu">set_units</span>(<span class="dv">500</span>, m))</span>
<span id="cb98-694"><a href="#cb98-694" aria-hidden="true" tabindex="-1"></a>r[b]</span>
<span id="cb98-695"><a href="#cb98-695" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-696"><a href="#cb98-696" aria-hidden="true" tabindex="-1"></a>selects the circular centre region with a diameter of 500 metre, which for</span>
<span id="cb98-697"><a href="#cb98-697" aria-hidden="true" tabindex="-1"></a>the first band is shown in @fig-circr,</span>
<span id="cb98-698"><a href="#cb98-698" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-circr, echo=!knitr::is_latex_output()}</span></span>
<span id="cb98-699"><a href="#cb98-699" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Circular centre region of the Landsat 7 scene (band 1)"</span></span>
<span id="cb98-700"><a href="#cb98-700" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-701"><a href="#cb98-701" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 70%</span></span>
<span id="cb98-702"><a href="#cb98-702" aria-hidden="true" tabindex="-1"></a><span class="in">plot(r[b][,,,1], reset = FALSE)</span></span>
<span id="cb98-703"><a href="#cb98-703" aria-hidden="true" tabindex="-1"></a><span class="in">plot(b, border = 'brown', lwd = 2, col = NA, add = TRUE)</span></span>
<span id="cb98-704"><a href="#cb98-704" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-705"><a href="#cb98-705" aria-hidden="true" tabindex="-1"></a>where we see that pixels outside the spatial object are assigned <span class="in">`NA`</span> values.</span>
<span id="cb98-706"><a href="#cb98-706" aria-hidden="true" tabindex="-1"></a>This object still has dimension indexes relative to the <span class="in">`offset`</span> and <span class="in">`delta`</span></span>
<span id="cb98-707"><a href="#cb98-707" aria-hidden="true" tabindex="-1"></a>values of <span class="in">`r`</span>; we can reset these to a new <span class="in">`offset`</span> with</span>
<span id="cb98-710"><a href="#cb98-710" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-711"><a href="#cb98-711" aria-hidden="true" tabindex="-1"></a>r[b] <span class="sc">|&gt;</span> <span class="fu">st_normalize</span>() <span class="sc">|&gt;</span> <span class="fu">st_dimensions</span>()</span>
<span id="cb98-712"><a href="#cb98-712" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-713"><a href="#cb98-713" aria-hidden="true" tabindex="-1"></a>By default, the resulting raster is cropped to the extent of the</span>
<span id="cb98-714"><a href="#cb98-714" aria-hidden="true" tabindex="-1"></a>selection object; an object with the same dimensions as the input</span>
<span id="cb98-715"><a href="#cb98-715" aria-hidden="true" tabindex="-1"></a>object is obtained with</span>
<span id="cb98-718"><a href="#cb98-718" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-719"><a href="#cb98-719" aria-hidden="true" tabindex="-1"></a>r[b, crop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb98-720"><a href="#cb98-720" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-721"><a href="#cb98-721" aria-hidden="true" tabindex="-1"></a>Cropping a <span class="in">`stars`</span> object can alternatively be done directly with <span class="in">`st_crop`</span>, as in</span>
<span id="cb98-722"><a href="#cb98-722" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb98-723"><a href="#cb98-723" aria-hidden="true" tabindex="-1"></a><span class="in">st_crop(r, b)</span></span>
<span id="cb98-724"><a href="#cb98-724" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-725"><a href="#cb98-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-726"><a href="#cb98-726" aria-hidden="true" tabindex="-1"></a><span class="fu">### Redimensioning and combining `stars` objects</span></span>
<span id="cb98-727"><a href="#cb98-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-728"><a href="#cb98-728" aria-hidden="true" tabindex="-1"></a>\index{stars!redimension}</span>
<span id="cb98-729"><a href="#cb98-729" aria-hidden="true" tabindex="-1"></a>\index{dimension!change order}</span>
<span id="cb98-730"><a href="#cb98-730" aria-hidden="true" tabindex="-1"></a>\index{dimension!permutation}</span>
<span id="cb98-731"><a href="#cb98-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-732"><a href="#cb98-732" aria-hidden="true" tabindex="-1"></a>Package **stars** uses package **abind** <span class="co">[</span><span class="ot">@R-abind</span><span class="co">]</span> for a number of</span>
<span id="cb98-733"><a href="#cb98-733" aria-hidden="true" tabindex="-1"></a>array manipulations. One of them is <span class="in">`aperm`</span> which transposes an</span>
<span id="cb98-734"><a href="#cb98-734" aria-hidden="true" tabindex="-1"></a>array by permuting it. A method for <span class="in">`stars`</span> objects is provided, and</span>
<span id="cb98-737"><a href="#cb98-737" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-738"><a href="#cb98-738" aria-hidden="true" tabindex="-1"></a><span class="fu">aperm</span>(r, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb98-739"><a href="#cb98-739" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-740"><a href="#cb98-740" aria-hidden="true" tabindex="-1"></a>permutes the order of dimensions of the resulting object.</span>
<span id="cb98-741"><a href="#cb98-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-742"><a href="#cb98-742" aria-hidden="true" tabindex="-1"></a>Attributes and dimensions can be swapped, using <span class="in">`split`</span> and <span class="in">`merge`</span>:</span>
<span id="cb98-745"><a href="#cb98-745" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-746"><a href="#cb98-746" aria-hidden="true" tabindex="-1"></a>(rs <span class="ot">&lt;-</span> <span class="fu">split</span>(r))</span>
<span id="cb98-747"><a href="#cb98-747" aria-hidden="true" tabindex="-1"></a><span class="fu">merge</span>(rs, <span class="at">name =</span> <span class="st">"band"</span>) <span class="sc">|&gt;</span> <span class="fu">setNames</span>(<span class="st">"L7_ETMs"</span>)</span>
<span id="cb98-748"><a href="#cb98-748" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-749"><a href="#cb98-749" aria-hidden="true" tabindex="-1"></a><span class="in">`split`</span> distributes the <span class="in">`band`</span> dimension over six attributes of a</span>
<span id="cb98-750"><a href="#cb98-750" aria-hidden="true" tabindex="-1"></a>two-dimensional array, <span class="in">`merge`</span> reverses this operation. <span class="in">`st_redimension`</span></span>
<span id="cb98-751"><a href="#cb98-751" aria-hidden="true" tabindex="-1"></a>can be used for more generic operations, such as splitting a single array</span>
<span id="cb98-752"><a href="#cb98-752" aria-hidden="true" tabindex="-1"></a>dimension over two new dimensions:</span>
<span id="cb98-755"><a href="#cb98-755" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-756"><a href="#cb98-756" aria-hidden="true" tabindex="-1"></a><span class="fu">st_redimension</span>(r, <span class="fu">c</span>(<span class="at">x =</span> <span class="dv">349</span>, <span class="at">y =</span> <span class="dv">352</span>, <span class="at">b1 =</span> <span class="dv">3</span>, <span class="at">b2 =</span> <span class="dv">2</span>))</span>
<span id="cb98-757"><a href="#cb98-757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-758"><a href="#cb98-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-759"><a href="#cb98-759" aria-hidden="true" tabindex="-1"></a>Multiple <span class="in">`stars`</span> object with identical dimensions can be combined</span>
<span id="cb98-760"><a href="#cb98-760" aria-hidden="true" tabindex="-1"></a>using <span class="in">`c`</span>. By default, the arrays are combined as additional</span>
<span id="cb98-761"><a href="#cb98-761" aria-hidden="true" tabindex="-1"></a>attributes, but by specifying an <span class="in">`along`</span> argument, the arrays are</span>
<span id="cb98-762"><a href="#cb98-762" aria-hidden="true" tabindex="-1"></a>merged along a new dimension:</span>
<span id="cb98-765"><a href="#cb98-765" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-766"><a href="#cb98-766" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(r, r, <span class="at">along =</span> <span class="st">"new_dim"</span>)</span>
<span id="cb98-767"><a href="#cb98-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-768"><a href="#cb98-768" aria-hidden="true" tabindex="-1"></a>the use of this is illustrated in @sec-oddc.</span>
<span id="cb98-769"><a href="#cb98-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-770"><a href="#cb98-770" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extracting point samples, aggregating</span></span>
<span id="cb98-771"><a href="#cb98-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-772"><a href="#cb98-772" aria-hidden="true" tabindex="-1"></a>\index{extract}</span>
<span id="cb98-773"><a href="#cb98-773" aria-hidden="true" tabindex="-1"></a>\index{data cube!extract}</span>
<span id="cb98-774"><a href="#cb98-774" aria-hidden="true" tabindex="-1"></a>\index{data cube!aggregate}</span>
<span id="cb98-775"><a href="#cb98-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-776"><a href="#cb98-776" aria-hidden="true" tabindex="-1"></a>A very common use case for raster data cube analysis is the extraction</span>
<span id="cb98-777"><a href="#cb98-777" aria-hidden="true" tabindex="-1"></a>of values at certain locations, or computing aggregations over certain </span>
<span id="cb98-778"><a href="#cb98-778" aria-hidden="true" tabindex="-1"></a>geometries. <span class="in">`st_extract`</span> extracts point values. We will do this</span>
<span id="cb98-779"><a href="#cb98-779" aria-hidden="true" tabindex="-1"></a>for a few randomly sampled points over the bounding  box of <span class="in">`r`</span>:</span>
<span id="cb98-782"><a href="#cb98-782" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-783"><a href="#cb98-783" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">115517</span>)</span>
<span id="cb98-784"><a href="#cb98-784" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(r) <span class="sc">|&gt;</span> <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> <span class="fu">st_sample</span>(<span class="dv">20</span>)</span>
<span id="cb98-785"><a href="#cb98-785" aria-hidden="true" tabindex="-1"></a>(e <span class="ot">&lt;-</span> <span class="fu">st_extract</span>(r, pts))</span>
<span id="cb98-786"><a href="#cb98-786" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-787"><a href="#cb98-787" aria-hidden="true" tabindex="-1"></a>which results in a vector data cube with 20 points and 6</span>
<span id="cb98-788"><a href="#cb98-788" aria-hidden="true" tabindex="-1"></a>bands. (Setting the seed guarantees an identical sample when</span>
<span id="cb98-789"><a href="#cb98-789" aria-hidden="true" tabindex="-1"></a>reproducing, it should not be set to generate further randomly</span>
<span id="cb98-790"><a href="#cb98-790" aria-hidden="true" tabindex="-1"></a>generated points.)</span>
<span id="cb98-791"><a href="#cb98-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-792"><a href="#cb98-792" aria-hidden="true" tabindex="-1"></a>Another way of extracting information from data cubes is by</span>
<span id="cb98-793"><a href="#cb98-793" aria-hidden="true" tabindex="-1"></a>aggregating it. One way of doing this is by spatially aggregating</span>
<span id="cb98-794"><a href="#cb98-794" aria-hidden="true" tabindex="-1"></a>values over spatial polygons or lines (@sec-vectordatacubes).</span>
<span id="cb98-795"><a href="#cb98-795" aria-hidden="true" tabindex="-1"></a>We can for instance compute the maximum pixel value for each of the</span>
<span id="cb98-796"><a href="#cb98-796" aria-hidden="true" tabindex="-1"></a>six bands and for each of the three circles shown in @fig-ras (d) by</span>
<span id="cb98-797"><a href="#cb98-797" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb98-798"><a href="#cb98-798" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(131)</span></span>
<span id="cb98-799"><a href="#cb98-799" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-802"><a href="#cb98-802" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-803"><a href="#cb98-803" aria-hidden="true" tabindex="-1"></a>circles <span class="ot">&lt;-</span> <span class="fu">st_sample</span>(<span class="fu">st_as_sfc</span>(<span class="fu">st_bbox</span>(r)), <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb98-804"><a href="#cb98-804" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_buffer</span>(<span class="dv">500</span>)</span>
<span id="cb98-805"><a href="#cb98-805" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(r, circles, max)</span>
<span id="cb98-806"><a href="#cb98-806" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-807"><a href="#cb98-807" aria-hidden="true" tabindex="-1"></a>which gives a (vector) data cube with three geometries and six bands. Aggregation</span>
<span id="cb98-808"><a href="#cb98-808" aria-hidden="true" tabindex="-1"></a>over a temporal dimension is done by passing a time variable as the</span>
<span id="cb98-809"><a href="#cb98-809" aria-hidden="true" tabindex="-1"></a>second argument to <span class="in">`aggregate`</span>, as a</span>
<span id="cb98-810"><a href="#cb98-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-811"><a href="#cb98-811" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>set of time stamps indicating the start of time intervals,</span>
<span id="cb98-812"><a href="#cb98-812" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>set of time intervals defined by <span class="in">`make_intervals`</span>, or</span>
<span id="cb98-813"><a href="#cb98-813" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>time period like <span class="in">`"weeks"`</span>, <span class="in">`"5 days"`</span>, or <span class="in">`"years"`</span>.</span>
<span id="cb98-814"><a href="#cb98-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-815"><a href="#cb98-815" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictive models {#sec-starspredict}</span></span>
<span id="cb98-816"><a href="#cb98-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-817"><a href="#cb98-817" aria-hidden="true" tabindex="-1"></a>\index{data cube!predictive models}</span>
<span id="cb98-818"><a href="#cb98-818" aria-hidden="true" tabindex="-1"></a>\index{data cube!machine learning with}</span>
<span id="cb98-819"><a href="#cb98-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-820"><a href="#cb98-820" aria-hidden="true" tabindex="-1"></a>The typical model prediction workflow in R is as follows:</span>
<span id="cb98-821"><a href="#cb98-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-822"><a href="#cb98-822" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>use a <span class="in">`data.frame`</span> with response and predictor variables (covariates)</span>
<span id="cb98-823"><a href="#cb98-823" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>create a model object based on this <span class="in">`data.frame`</span> </span>
<span id="cb98-824"><a href="#cb98-824" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>call <span class="in">`predict`</span> with this model object and the <span class="in">`data.frame`</span> with target predictor variable values</span>
<span id="cb98-825"><a href="#cb98-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-826"><a href="#cb98-826" aria-hidden="true" tabindex="-1"></a>Package **stars** provides a <span class="in">`predict`</span> method for <span class="in">`stars`</span> objects</span>
<span id="cb98-827"><a href="#cb98-827" aria-hidden="true" tabindex="-1"></a>that essentially wraps the last step, by creating the <span class="in">`data.frame`</span>,</span>
<span id="cb98-828"><a href="#cb98-828" aria-hidden="true" tabindex="-1"></a>calling the <span class="in">`predict`</span> method for that, and reconstructing a <span class="in">`stars`</span></span>
<span id="cb98-829"><a href="#cb98-829" aria-hidden="true" tabindex="-1"></a>object with the predicted values.</span>
<span id="cb98-830"><a href="#cb98-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-831"><a href="#cb98-831" aria-hidden="true" tabindex="-1"></a>We will illustrate this with a trivial two-class example mapping</span>
<span id="cb98-832"><a href="#cb98-832" aria-hidden="true" tabindex="-1"></a>land from sea in the example Landsat dataset, using the sample</span>
<span id="cb98-833"><a href="#cb98-833" aria-hidden="true" tabindex="-1"></a>points extracted above, shown in @fig-rsample.</span>
<span id="cb98-834"><a href="#cb98-834" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-rsample, echo=!knitr::is_latex_output()}</span></span>
<span id="cb98-835"><a href="#cb98-835" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Randomly chosen sample locations for training data; red: water, yellow: land"</span></span>
<span id="cb98-836"><a href="#cb98-836" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 80%</span></span>
<span id="cb98-837"><a href="#cb98-837" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-838"><a href="#cb98-838" aria-hidden="true" tabindex="-1"></a><span class="in">plot(r[,,,1], reset = FALSE)</span></span>
<span id="cb98-839"><a href="#cb98-839" aria-hidden="true" tabindex="-1"></a><span class="in">col &lt;- rep("yellow", 20)</span></span>
<span id="cb98-840"><a href="#cb98-840" aria-hidden="true" tabindex="-1"></a><span class="in">col[c(8, 14, 15, 18, 19)] = "red"</span></span>
<span id="cb98-841"><a href="#cb98-841" aria-hidden="true" tabindex="-1"></a><span class="in">st_as_sf(e) |&gt; st_coordinates() |&gt; text(labels = 1:20, col = col)</span></span>
<span id="cb98-842"><a href="#cb98-842" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-843"><a href="#cb98-843" aria-hidden="true" tabindex="-1"></a>From this figure, we read "by eye" that the points 8, 14, 15, 18, and</span>
<span id="cb98-844"><a href="#cb98-844" aria-hidden="true" tabindex="-1"></a>19 are on water, the others on land. Using a linear discriminant</span>
<span id="cb98-845"><a href="#cb98-845" aria-hidden="true" tabindex="-1"></a>("maximum likelihood") classifier, we find model predictions as</span>
<span id="cb98-846"><a href="#cb98-846" aria-hidden="true" tabindex="-1"></a>shown in @fig-lda by</span>
<span id="cb98-847"><a href="#cb98-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-848"><a href="#cb98-848" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ldapr}</span></span>
<span id="cb98-849"><a href="#cb98-849" aria-hidden="true" tabindex="-1"></a><span class="in">rs &lt;- split(r)</span></span>
<span id="cb98-850"><a href="#cb98-850" aria-hidden="true" tabindex="-1"></a><span class="in">trn &lt;- st_extract(rs, pts)</span></span>
<span id="cb98-851"><a href="#cb98-851" aria-hidden="true" tabindex="-1"></a><span class="in">trn$cls &lt;- rep("land", 20)</span></span>
<span id="cb98-852"><a href="#cb98-852" aria-hidden="true" tabindex="-1"></a><span class="in">trn$cls[c(8, 14, 15, 18, 19)] &lt;- "water"</span></span>
<span id="cb98-853"><a href="#cb98-853" aria-hidden="true" tabindex="-1"></a><span class="in">model &lt;- MASS::lda(cls ~ ., st_drop_geometry(trn))</span></span>
<span id="cb98-854"><a href="#cb98-854" aria-hidden="true" tabindex="-1"></a><span class="in">pr &lt;- predict(rs, model)</span></span>
<span id="cb98-855"><a href="#cb98-855" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-856"><a href="#cb98-856" aria-hidden="true" tabindex="-1"></a>Here, we used the <span class="in">`MASS::`</span> prefix to avoid loading **MASS**, as that</span>
<span id="cb98-857"><a href="#cb98-857" aria-hidden="true" tabindex="-1"></a>would mask <span class="in">`select`</span> from **dplyr**.  The <span class="in">`split`</span> step is needed to</span>
<span id="cb98-858"><a href="#cb98-858" aria-hidden="true" tabindex="-1"></a>convert the band dimension into attributes, so that they are offered</span>
<span id="cb98-859"><a href="#cb98-859" aria-hidden="true" tabindex="-1"></a>as a set of predictors.</span>
<span id="cb98-860"><a href="#cb98-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-861"><a href="#cb98-861" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{predict.stars}</span>
<span id="cb98-862"><a href="#cb98-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-863"><a href="#cb98-863" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-lda, echo=!knitr::is_latex_output()}</span></span>
<span id="cb98-864"><a href="#cb98-864" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Linear discriminant classifier for land/water, based on training data of @fig-rsample"</span></span>
<span id="cb98-865"><a href="#cb98-865" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 70%</span></span>
<span id="cb98-866"><a href="#cb98-866" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-867"><a href="#cb98-867" aria-hidden="true" tabindex="-1"></a><span class="in">plot(pr[1], key.pos = 4, key.width = lcm(3.5), key.length = lcm(2))</span></span>
<span id="cb98-868"><a href="#cb98-868" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-869"><a href="#cb98-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-870"><a href="#cb98-870" aria-hidden="true" tabindex="-1"></a>We also see that the layer plotted in @fig-lda is a <span class="in">`factor`</span> variable, with class labels.</span>
<span id="cb98-871"><a href="#cb98-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-872"><a href="#cb98-872" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plotting raster data</span></span>
<span id="cb98-873"><a href="#cb98-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-874"><a href="#cb98-874" aria-hidden="true" tabindex="-1"></a>\index{stars!plot}</span>
<span id="cb98-875"><a href="#cb98-875" aria-hidden="true" tabindex="-1"></a>\index{plot!star}</span>
<span id="cb98-876"><a href="#cb98-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-877"><a href="#cb98-877" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-firststars, echo=!knitr::is_latex_output(), message=FALSE}</span></span>
<span id="cb98-878"><a href="#cb98-878" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Six 30 m Landsat bands downsampled to 90m for Olinda, Br."</span></span>
<span id="cb98-879"><a href="#cb98-879" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-880"><a href="#cb98-880" aria-hidden="true" tabindex="-1"></a><span class="in">plot(r)</span></span>
<span id="cb98-881"><a href="#cb98-881" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-882"><a href="#cb98-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-883"><a href="#cb98-883" aria-hidden="true" tabindex="-1"></a>We can use the base <span class="in">`plot`</span> method for <span class="in">`stars`</span> objects, where</span>
<span id="cb98-884"><a href="#cb98-884" aria-hidden="true" tabindex="-1"></a>the plot created with <span class="in">`plot(r)`</span> is shown in @fig-firststars.</span>
<span id="cb98-885"><a href="#cb98-885" aria-hidden="true" tabindex="-1"></a>The default colour scale uses grey tones and stretches them such</span>
<span id="cb98-886"><a href="#cb98-886" aria-hidden="true" tabindex="-1"></a>that colour breaks correspond to data quantiles over all bands</span>
<span id="cb98-887"><a href="#cb98-887" aria-hidden="true" tabindex="-1"></a>("histogram equalization"). Setting <span class="in">`breaks = "equal"`</span> gives equal</span>
<span id="cb98-888"><a href="#cb98-888" aria-hidden="true" tabindex="-1"></a>width colour breaks; alternatively a sequence of numeric break values can be</span>
<span id="cb98-889"><a href="#cb98-889" aria-hidden="true" tabindex="-1"></a>given.  A more familiar view may be the RGB or false colour composite</span>
<span id="cb98-890"><a href="#cb98-890" aria-hidden="true" tabindex="-1"></a>shown in @fig-starsrgb.</span>
<span id="cb98-891"><a href="#cb98-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-892"><a href="#cb98-892" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-starsrgb, echo=!knitr::is_latex_output(), message=FALSE}</span></span>
<span id="cb98-893"><a href="#cb98-893" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Two colour composites"</span></span>
<span id="cb98-894"><a href="#cb98-894" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-895"><a href="#cb98-895" aria-hidden="true" tabindex="-1"></a><span class="in">par(mfrow = c(1, 2))</span></span>
<span id="cb98-896"><a href="#cb98-896" aria-hidden="true" tabindex="-1"></a><span class="in">plot(r, rgb = c(3,2,1), reset = FALSE, main = "RGB")    # rgb</span></span>
<span id="cb98-897"><a href="#cb98-897" aria-hidden="true" tabindex="-1"></a><span class="in">plot(r, rgb = c(4,3,2), main = "False colour (NIR-R-G)") # false colour</span></span>
<span id="cb98-898"><a href="#cb98-898" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-899"><a href="#cb98-899" aria-hidden="true" tabindex="-1"></a>Further details and options are given in @sec-plotting.</span>
<span id="cb98-900"><a href="#cb98-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-901"><a href="#cb98-901" aria-hidden="true" tabindex="-1"></a><span class="fu">### Analysing raster data</span></span>
<span id="cb98-902"><a href="#cb98-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-903"><a href="#cb98-903" aria-hidden="true" tabindex="-1"></a>\index{map algebra}</span>
<span id="cb98-904"><a href="#cb98-904" aria-hidden="true" tabindex="-1"></a>\index{stars!map algebra}</span>
<span id="cb98-905"><a href="#cb98-905" aria-hidden="true" tabindex="-1"></a>\index{stars!arithmetic ops}</span>
<span id="cb98-906"><a href="#cb98-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-907"><a href="#cb98-907" aria-hidden="true" tabindex="-1"></a>Element-wise mathematical functions (@sec-applydimension)</span>
<span id="cb98-908"><a href="#cb98-908" aria-hidden="true" tabindex="-1"></a>on <span class="in">`stars`</span> objects are just passed on to the arrays. This means</span>
<span id="cb98-909"><a href="#cb98-909" aria-hidden="true" tabindex="-1"></a>that we can call functions and create expressions:</span>
<span id="cb98-912"><a href="#cb98-912" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-913"><a href="#cb98-913" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(r)</span>
<span id="cb98-914"><a href="#cb98-914" aria-hidden="true" tabindex="-1"></a>r <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">log</span>(r)</span>
<span id="cb98-915"><a href="#cb98-915" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-916"><a href="#cb98-916" aria-hidden="true" tabindex="-1"></a>or even mask out certain values:</span>
<span id="cb98-919"><a href="#cb98-919" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-920"><a href="#cb98-920" aria-hidden="true" tabindex="-1"></a>r2 <span class="ot">&lt;-</span> r</span>
<span id="cb98-921"><a href="#cb98-921" aria-hidden="true" tabindex="-1"></a>r2[r <span class="sc">&lt;</span> <span class="dv">50</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb98-922"><a href="#cb98-922" aria-hidden="true" tabindex="-1"></a>r2</span>
<span id="cb98-923"><a href="#cb98-923" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-924"><a href="#cb98-924" aria-hidden="true" tabindex="-1"></a>or unmask areas:</span>
<span id="cb98-927"><a href="#cb98-927" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-928"><a href="#cb98-928" aria-hidden="true" tabindex="-1"></a>r2[<span class="fu">is.na</span>(r2)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb98-929"><a href="#cb98-929" aria-hidden="true" tabindex="-1"></a>r2</span>
<span id="cb98-930"><a href="#cb98-930" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-931"><a href="#cb98-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-932"><a href="#cb98-932" aria-hidden="true" tabindex="-1"></a>\index{stars!apply}</span>
<span id="cb98-933"><a href="#cb98-933" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>apply}</span>
<span id="cb98-934"><a href="#cb98-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-935"><a href="#cb98-935" aria-hidden="true" tabindex="-1"></a>Dimension-wise, we can apply functions to selected array dimensions</span>
<span id="cb98-936"><a href="#cb98-936" aria-hidden="true" tabindex="-1"></a>(@sec-reducedimension)</span>
<span id="cb98-937"><a href="#cb98-937" aria-hidden="true" tabindex="-1"></a>of stars objects similar to how <span class="in">`apply`</span> does this to arrays. For</span>
<span id="cb98-938"><a href="#cb98-938" aria-hidden="true" tabindex="-1"></a>instance, we can compute for each pixel the mean of the six band values by</span>
<span id="cb98-941"><a href="#cb98-941" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-942"><a href="#cb98-942" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(r, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), mean)</span>
<span id="cb98-943"><a href="#cb98-943" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-944"><a href="#cb98-944" aria-hidden="true" tabindex="-1"></a>A more meaningful function would for instance compute the NDVI (normalised</span>
<span id="cb98-945"><a href="#cb98-945" aria-hidden="true" tabindex="-1"></a>differenced vegetation index):</span>
<span id="cb98-948"><a href="#cb98-948" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-949"><a href="#cb98-949" aria-hidden="true" tabindex="-1"></a>ndvi <span class="ot">&lt;-</span> <span class="cf">function</span>(b1, b2, b3, b4, b5, b6) (b4 <span class="sc">-</span> b3)<span class="sc">/</span>(b4 <span class="sc">+</span> b3)</span>
<span id="cb98-950"><a href="#cb98-950" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(r, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), ndvi)</span>
<span id="cb98-951"><a href="#cb98-951" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-952"><a href="#cb98-952" aria-hidden="true" tabindex="-1"></a>Alternatively, one could have defined</span>
<span id="cb98-955"><a href="#cb98-955" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-956"><a href="#cb98-956" aria-hidden="true" tabindex="-1"></a>ndvi2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) (x[<span class="dv">4</span>]<span class="sc">-</span>x[<span class="dv">3</span>])<span class="sc">/</span>(x[<span class="dv">4</span>]<span class="sc">+</span>x[<span class="dv">3</span>])</span>
<span id="cb98-957"><a href="#cb98-957" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-958"><a href="#cb98-958" aria-hidden="true" tabindex="-1"></a>which is more convenient if the number of bands is large,</span>
<span id="cb98-959"><a href="#cb98-959" aria-hidden="true" tabindex="-1"></a>but also much slower than <span class="in">`ndvi`</span> as it</span>
<span id="cb98-960"><a href="#cb98-960" aria-hidden="true" tabindex="-1"></a>needs to be called for every pixel whereas <span class="in">`ndvi`</span> can be called</span>
<span id="cb98-961"><a href="#cb98-961" aria-hidden="true" tabindex="-1"></a>once for all pixels, or for large chunks of pixels.</span>
<span id="cb98-962"><a href="#cb98-962" aria-hidden="true" tabindex="-1"></a>The mean for each band over the whole image is computed by</span>
<span id="cb98-965"><a href="#cb98-965" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-966"><a href="#cb98-966" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(r, <span class="fu">c</span>(<span class="st">"band"</span>), mean) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb98-967"><a href="#cb98-967" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-968"><a href="#cb98-968" aria-hidden="true" tabindex="-1"></a>the result of which is small enough to be printed here as a <span class="in">`data.frame`</span>. In these</span>
<span id="cb98-969"><a href="#cb98-969" aria-hidden="true" tabindex="-1"></a>two examples, entire dimensions disappear. Sometimes, this does not</span>
<span id="cb98-970"><a href="#cb98-970" aria-hidden="true" tabindex="-1"></a>happen (@sec-applydimension); we can for instance compute the three quartiles for each band</span>
<span id="cb98-973"><a href="#cb98-973" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-974"><a href="#cb98-974" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(r, <span class="fu">c</span>(<span class="st">"band"</span>), quantile, <span class="fu">c</span>(.<span class="dv">25</span>, .<span class="dv">5</span>, .<span class="dv">75</span>))</span>
<span id="cb98-975"><a href="#cb98-975" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-976"><a href="#cb98-976" aria-hidden="true" tabindex="-1"></a>and see that this _creates_ a new dimension, <span class="in">`quantile`</span>, with three values.</span>
<span id="cb98-977"><a href="#cb98-977" aria-hidden="true" tabindex="-1"></a>Alternatively, the three quantiles over the six bands for each pixel are</span>
<span id="cb98-978"><a href="#cb98-978" aria-hidden="true" tabindex="-1"></a>obtained by</span>
<span id="cb98-981"><a href="#cb98-981" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-982"><a href="#cb98-982" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(r, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), quantile, <span class="fu">c</span>(.<span class="dv">25</span>, .<span class="dv">5</span>, .<span class="dv">75</span>))</span>
<span id="cb98-983"><a href="#cb98-983" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-984"><a href="#cb98-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-985"><a href="#cb98-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-986"><a href="#cb98-986" aria-hidden="true" tabindex="-1"></a><span class="fu">### Curvilinear rasters</span></span>
<span id="cb98-987"><a href="#cb98-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-988"><a href="#cb98-988" aria-hidden="true" tabindex="-1"></a>\index{curvilinear raster}</span>
<span id="cb98-989"><a href="#cb98-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-990"><a href="#cb98-990" aria-hidden="true" tabindex="-1"></a>There are several reasons why non-regular rasters occur</span>
<span id="cb98-991"><a href="#cb98-991" aria-hidden="true" tabindex="-1"></a>(@fig-rastertypes01).  For one, when the data is Earth-bound,</span>
<span id="cb98-992"><a href="#cb98-992" aria-hidden="true" tabindex="-1"></a>a regular raster does not fit the Earth's surface, which is</span>
<span id="cb98-993"><a href="#cb98-993" aria-hidden="true" tabindex="-1"></a>curved. Other reasons are:</span>
<span id="cb98-994"><a href="#cb98-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-995"><a href="#cb98-995" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>when we convert or transform a regular raster data into another</span>
<span id="cb98-996"><a href="#cb98-996" aria-hidden="true" tabindex="-1"></a>coordinate reference system, it will become curvilinear unless we</span>
<span id="cb98-997"><a href="#cb98-997" aria-hidden="true" tabindex="-1"></a>resample (warp; @sec-warp); warping always comes at the </span>
<span id="cb98-998"><a href="#cb98-998" aria-hidden="true" tabindex="-1"></a>cost of some loss of data and is not reversible</span>
<span id="cb98-999"><a href="#cb98-999" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>observation may lead to irregular rasters: for lower-level satellite products, we</span>
<span id="cb98-1000"><a href="#cb98-1000" aria-hidden="true" tabindex="-1"></a>may have a regular raster in the direction of the satellite (not</span>
<span id="cb98-1001"><a href="#cb98-1001" aria-hidden="true" tabindex="-1"></a>aligned with $x$ or $y$), and rectilinear in the direction perpendicular to that</span>
<span id="cb98-1002"><a href="#cb98-1002" aria-hidden="true" tabindex="-1"></a>(e.g., when the sensor discretises the viewing _angle_ in equal parts)</span>
<span id="cb98-1003"><a href="#cb98-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1004"><a href="#cb98-1004" aria-hidden="true" tabindex="-1"></a><span class="fu">### GDAL utils</span></span>
<span id="cb98-1005"><a href="#cb98-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1006"><a href="#cb98-1006" aria-hidden="true" tabindex="-1"></a>\index{GDAL!utils C API}</span>
<span id="cb98-1007"><a href="#cb98-1007" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{gdal<span class="sc">\_</span>utils}</span>
<span id="cb98-1008"><a href="#cb98-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1009"><a href="#cb98-1009" aria-hidden="true" tabindex="-1"></a>The GDAL library typically ships with a number of executable</span>
<span id="cb98-1010"><a href="#cb98-1010" aria-hidden="true" tabindex="-1"></a>binaries, the GDAL command line utilities for data translation and</span>
<span id="cb98-1011"><a href="#cb98-1011" aria-hidden="true" tabindex="-1"></a>processing.  Several of these utilities (all except for those</span>
<span id="cb98-1012"><a href="#cb98-1012" aria-hidden="true" tabindex="-1"></a>written in Python) are also available as C functions in the GDAL</span>
<span id="cb98-1013"><a href="#cb98-1013" aria-hidden="true" tabindex="-1"></a>library, through the "GDAL Algorithms C API".  If an R package like</span>
<span id="cb98-1014"><a href="#cb98-1014" aria-hidden="true" tabindex="-1"></a><span class="in">`sf`</span> that links to the GDAL library uses these C API algorithms,</span>
<span id="cb98-1015"><a href="#cb98-1015" aria-hidden="true" tabindex="-1"></a>it means that the user no longer needs to install any GDAL binary</span>
<span id="cb98-1016"><a href="#cb98-1016" aria-hidden="true" tabindex="-1"></a>command line utilities in addition to the R package.</span>
<span id="cb98-1017"><a href="#cb98-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1018"><a href="#cb98-1018" aria-hidden="true" tabindex="-1"></a>Package **sf** allows calling these C API algorithms through function</span>
<span id="cb98-1019"><a href="#cb98-1019" aria-hidden="true" tabindex="-1"></a><span class="in">`gdal_utils`</span>, where the first argument is the name of the utility</span>
<span id="cb98-1020"><a href="#cb98-1020" aria-hidden="true" tabindex="-1"></a>(stripped from the <span class="in">`gdal`</span> prefix):</span>
<span id="cb98-1021"><a href="#cb98-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1022"><a href="#cb98-1022" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`info`</span> prints information on GDAL (raster) datasets</span>
<span id="cb98-1023"><a href="#cb98-1023" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`warp`</span> warps a raster to a new raster, possibly in another CRS</span>
<span id="cb98-1024"><a href="#cb98-1024" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`rasterize`</span> rasterises a vector dataset</span>
<span id="cb98-1025"><a href="#cb98-1025" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`translate`</span> translates a raster file to another format</span>
<span id="cb98-1026"><a href="#cb98-1026" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`vectortranslate`</span> (for ogr2ogr) translates a vector file to another format</span>
<span id="cb98-1027"><a href="#cb98-1027" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`buildvrt`</span> creates a virtual raster tile (a raster created from several files)</span>
<span id="cb98-1028"><a href="#cb98-1028" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`demprocessing`</span> does various processing steps of digital elevation models (dems)</span>
<span id="cb98-1029"><a href="#cb98-1029" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`nearblack`</span> converts nearly black/white borders to black</span>
<span id="cb98-1030"><a href="#cb98-1030" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`grid`</span> creates a regular grid from scattered data</span>
<span id="cb98-1031"><a href="#cb98-1031" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`mdiminfo`</span> prints information on a multi-dimensional array</span>
<span id="cb98-1032"><a href="#cb98-1032" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`mdimtranslate`</span> translates a multi-dimensional array into another format</span>
<span id="cb98-1033"><a href="#cb98-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1034"><a href="#cb98-1034" aria-hidden="true" tabindex="-1"></a>These utilities work on files, and not directly on <span class="in">`sf`</span> or</span>
<span id="cb98-1035"><a href="#cb98-1035" aria-hidden="true" tabindex="-1"></a><span class="in">`stars`</span> objects.  However, <span class="in">`stars_proxy`</span> objects are essentially</span>
<span id="cb98-1036"><a href="#cb98-1036" aria-hidden="true" tabindex="-1"></a>pointers to files, and other objects can be written to file. Several</span>
<span id="cb98-1037"><a href="#cb98-1037" aria-hidden="true" tabindex="-1"></a>of these utilities are (always or optionally) used, for example by</span>
<span id="cb98-1038"><a href="#cb98-1038" aria-hidden="true" tabindex="-1"></a><span class="in">`st_mosaic`</span>, <span class="in">`st_warp`</span>, or <span class="in">`st_write`</span>. R package **gdalUtilities**</span>
<span id="cb98-1039"><a href="#cb98-1039" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@R-gdalUtilities</span><span class="co">]</span> provides further wrapper functions around</span>
<span id="cb98-1040"><a href="#cb98-1040" aria-hidden="true" tabindex="-1"></a><span class="in">`sf::gdal_utils`</span> with function argument names matching the</span>
<span id="cb98-1041"><a href="#cb98-1041" aria-hidden="true" tabindex="-1"></a>command line arguments of the binary utils.</span>
<span id="cb98-1042"><a href="#cb98-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1043"><a href="#cb98-1043" aria-hidden="true" tabindex="-1"></a><span class="fu">## Vector data cube examples</span></span>
<span id="cb98-1044"><a href="#cb98-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1045"><a href="#cb98-1045" aria-hidden="true" tabindex="-1"></a>\index{data cube!vector}</span>
<span id="cb98-1046"><a href="#cb98-1046" aria-hidden="true" tabindex="-1"></a>\index{vector data cube!examples}</span>
<span id="cb98-1047"><a href="#cb98-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1048"><a href="#cb98-1048" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example: aggregating air quality time series</span></span>
<span id="cb98-1049"><a href="#cb98-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1050"><a href="#cb98-1050" aria-hidden="true" tabindex="-1"></a>\index{air quality aggregation}</span>
<span id="cb98-1051"><a href="#cb98-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1052"><a href="#cb98-1052" aria-hidden="true" tabindex="-1"></a>We use a small excert from the</span>
<span id="cb98-1053"><a href="#cb98-1053" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">European air quality data base</span><span class="co">](https://www.eea.europa.eu/data-and-maps/data/aqereporting-9)</span> </span>
<span id="cb98-1054"><a href="#cb98-1054" aria-hidden="true" tabindex="-1"></a>to illustrate aggregation operations on vector data cubes. The same</span>
<span id="cb98-1055"><a href="#cb98-1055" aria-hidden="true" tabindex="-1"></a>data source was used by @RJ-2016-014, and will be used</span>
<span id="cb98-1056"><a href="#cb98-1056" aria-hidden="true" tabindex="-1"></a>in @sec-interpolation and @sec-stgeostatistics.  Daily average</span>
<span id="cb98-1057"><a href="#cb98-1057" aria-hidden="true" tabindex="-1"></a>PM$_{10}$ values were computed for rural background stations in</span>
<span id="cb98-1058"><a href="#cb98-1058" aria-hidden="true" tabindex="-1"></a>Germany, over the period 1998-2009.</span>
<span id="cb98-1059"><a href="#cb98-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1060"><a href="#cb98-1060" aria-hidden="true" tabindex="-1"></a>We can create a <span class="in">`stars`</span> object from the <span class="in">`air`</span> matrix, the <span class="in">`dates`</span></span>
<span id="cb98-1061"><a href="#cb98-1061" aria-hidden="true" tabindex="-1"></a>Date vector and the <span class="in">`stations`</span> <span class="in">`SpatialPoints`</span> objects by</span>
<span id="cb98-1062"><a href="#cb98-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1063"><a href="#cb98-1063" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE}</span></span>
<span id="cb98-1064"><a href="#cb98-1064" aria-hidden="true" tabindex="-1"></a><span class="in">options("rgdal_show_exportToProj4_warnings"="none") # led to:</span></span>
<span id="cb98-1065"><a href="#cb98-1065" aria-hidden="true" tabindex="-1"></a><span class="in"># Warning in sp::proj4string(obj): CRS object has comment, which is</span></span>
<span id="cb98-1066"><a href="#cb98-1066" aria-hidden="true" tabindex="-1"></a><span class="in"># lost in output</span></span>
<span id="cb98-1067"><a href="#cb98-1067" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1068"><a href="#cb98-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1071"><a href="#cb98-1071" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1072"><a href="#cb98-1072" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/air.rda"</span>) <span class="co"># this loads several datasets in .GlobalEnv</span></span>
<span id="cb98-1073"><a href="#cb98-1073" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(air)</span>
<span id="cb98-1074"><a href="#cb98-1074" aria-hidden="true" tabindex="-1"></a>stations <span class="sc">|&gt;</span></span>
<span id="cb98-1075"><a href="#cb98-1075" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb98-1076"><a href="#cb98-1076" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_geometry</span>() <span class="ot">-&gt;</span> st</span>
<span id="cb98-1077"><a href="#cb98-1077" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">st_dimensions</span>(<span class="at">station =</span> st, <span class="at">time =</span> dates)</span>
<span id="cb98-1078"><a href="#cb98-1078" aria-hidden="true" tabindex="-1"></a>(aq <span class="ot">&lt;-</span> <span class="fu">st_as_stars</span>(<span class="fu">list</span>(<span class="at">PM10 =</span> air), <span class="at">dimensions =</span> d))</span>
<span id="cb98-1079"><a href="#cb98-1079" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1080"><a href="#cb98-1080" aria-hidden="true" tabindex="-1"></a>We can see from @fig-airst  that the time series are</span>
<span id="cb98-1081"><a href="#cb98-1081" aria-hidden="true" tabindex="-1"></a>quite long, but also have large missing value gaps.</span>
<span id="cb98-1082"><a href="#cb98-1082" aria-hidden="true" tabindex="-1"></a>@fig-airmap  shows the spatial distribution of measurement stations</span>
<span id="cb98-1083"><a href="#cb98-1083" aria-hidden="true" tabindex="-1"></a>along with mean PM$_{10}$ values.</span>
<span id="cb98-1084"><a href="#cb98-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1085"><a href="#cb98-1085" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-airst, echo=!knitr::is_latex_output()}</span></span>
<span id="cb98-1086"><a href="#cb98-1086" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Space time diagram of PM$_{10}$ measurements by time and station"</span></span>
<span id="cb98-1087"><a href="#cb98-1087" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-1088"><a href="#cb98-1088" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = c(5.1, 4.1, 0.3, 0.1))</span></span>
<span id="cb98-1089"><a href="#cb98-1089" aria-hidden="true" tabindex="-1"></a><span class="in">image(aperm(log(aq), 2:1), main = NULL)</span></span>
<span id="cb98-1090"><a href="#cb98-1090" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1091"><a href="#cb98-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1092"><a href="#cb98-1092" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-airmap, echo=!knitr::is_latex_output()}</span></span>
<span id="cb98-1093"><a href="#cb98-1093" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Locations of PM$_{10}$ measurement stations, showing mean values"</span></span>
<span id="cb98-1094"><a href="#cb98-1094" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-1095"><a href="#cb98-1095" aria-hidden="true" tabindex="-1"></a><span class="in">de_nuts1 &lt;- read_sf("data/de_nuts1.gpkg")</span></span>
<span id="cb98-1096"><a href="#cb98-1096" aria-hidden="true" tabindex="-1"></a><span class="in">st_as_sf(st_apply(aq, 1, mean, na.rm = TRUE)) |&gt;</span></span>
<span id="cb98-1097"><a href="#cb98-1097" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(reset = FALSE, pch = 16, extent = de_nuts1)</span></span>
<span id="cb98-1098"><a href="#cb98-1098" aria-hidden="true" tabindex="-1"></a><span class="in">st_union(de_nuts1) |&gt; plot(add = TRUE)</span></span>
<span id="cb98-1099"><a href="#cb98-1099" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1100"><a href="#cb98-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1101"><a href="#cb98-1101" aria-hidden="true" tabindex="-1"></a>We can aggregate these station time series to area means, mostly</span>
<span id="cb98-1102"><a href="#cb98-1102" aria-hidden="true" tabindex="-1"></a>as a simple exercise.  For this, we use the <span class="in">`aggregate`</span> method for</span>
<span id="cb98-1103"><a href="#cb98-1103" aria-hidden="true" tabindex="-1"></a><span class="in">`stars`</span> objects</span>
<span id="cb98-1104"><a href="#cb98-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1107"><a href="#cb98-1107" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1108"><a href="#cb98-1108" aria-hidden="true" tabindex="-1"></a>(a <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(aq, de_nuts1, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb98-1109"><a href="#cb98-1109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1110"><a href="#cb98-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1111"><a href="#cb98-1111" aria-hidden="true" tabindex="-1"></a>and we can now show the maps for six arbitrarily chosen days</span>
<span id="cb98-1112"><a href="#cb98-1112" aria-hidden="true" tabindex="-1"></a>(@fig-airagg), using</span>
<span id="cb98-1113"><a href="#cb98-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1114"><a href="#cb98-1114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-airagg}</span></span>
<span id="cb98-1115"><a href="#cb98-1115" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Areal mean PM$_{10}$ values, for six days"</span></span>
<span id="cb98-1116"><a href="#cb98-1116" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb98-1117"><a href="#cb98-1117" aria-hidden="true" tabindex="-1"></a><span class="in">a |&gt; filter(time &gt;= "2008-01-01", time &lt; "2008-01-07") |&gt; </span></span>
<span id="cb98-1118"><a href="#cb98-1118" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(key.pos = 4)</span></span>
<span id="cb98-1119"><a href="#cb98-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1120"><a href="#cb98-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1121"><a href="#cb98-1121" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb98-1122"><a href="#cb98-1122" aria-hidden="true" tabindex="-1"></a>or create a time series plot of mean values for a single state </span>
<span id="cb98-1123"><a href="#cb98-1123" aria-hidden="true" tabindex="-1"></a>(@fig-airts)  by</span>
<span id="cb98-1124"><a href="#cb98-1124" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-airts}</span></span>
<span id="cb98-1125"><a href="#cb98-1125" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Areal mean PM$_{10}$ time series for a single state"</span></span>
<span id="cb98-1126"><a href="#cb98-1126" aria-hidden="true" tabindex="-1"></a><span class="in">library(xts) |&gt; suppressPackageStartupMessages()</span></span>
<span id="cb98-1127"><a href="#cb98-1127" aria-hidden="true" tabindex="-1"></a><span class="in">plot(as.xts(a)[,4], main = de_nuts1$NAME_1[4])</span></span>
<span id="cb98-1128"><a href="#cb98-1128" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1129"><a href="#cb98-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1130"><a href="#cb98-1130" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example: Bristol origin-destination data cube {#sec-oddc}</span></span>
<span id="cb98-1131"><a href="#cb98-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1132"><a href="#cb98-1132" aria-hidden="true" tabindex="-1"></a>\index{origin-destination matrix}</span>
<span id="cb98-1133"><a href="#cb98-1133" aria-hidden="true" tabindex="-1"></a>\index{data cube!origin-destination matrix}</span>
<span id="cb98-1134"><a href="#cb98-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1135"><a href="#cb98-1135" aria-hidden="true" tabindex="-1"></a>The data used for this example come from @geocomp, and concern</span>
<span id="cb98-1136"><a href="#cb98-1136" aria-hidden="true" tabindex="-1"></a>origin-destination (OD) counts: the number of persons going from zone</span>
<span id="cb98-1137"><a href="#cb98-1137" aria-hidden="true" tabindex="-1"></a>A to zone B, by transportation mode.  We have feature geometries</span>
<span id="cb98-1138"><a href="#cb98-1138" aria-hidden="true" tabindex="-1"></a>in <span class="in">`sf`</span> object <span class="in">`bristol_zones`</span> for the 102 origin and destination</span>
<span id="cb98-1139"><a href="#cb98-1139" aria-hidden="true" tabindex="-1"></a>regions, shown in @fig-bristol1.</span>
<span id="cb98-1140"><a href="#cb98-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1141"><a href="#cb98-1141" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-bristol1, echo=!knitr::is_latex_output()}</span></span>
<span id="cb98-1142"><a href="#cb98-1142" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.height: 5</span></span>
<span id="cb98-1143"><a href="#cb98-1143" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Origin destination data zones for Bristol, UK, with zone 33 (E02003043) coloured red"</span></span>
<span id="cb98-1144"><a href="#cb98-1144" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb98-1145"><a href="#cb98-1145" aria-hidden="true" tabindex="-1"></a><span class="in">library(spDataLarge)</span></span>
<span id="cb98-1146"><a href="#cb98-1146" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(bristol_zones), axes = TRUE, graticule = TRUE)</span></span>
<span id="cb98-1147"><a href="#cb98-1147" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(bristol_zones)[33], col = 'red', add = TRUE)</span></span>
<span id="cb98-1148"><a href="#cb98-1148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1149"><a href="#cb98-1149" aria-hidden="true" tabindex="-1"></a>OD counts come in a table <span class="in">`bristol_od`</span></span>
<span id="cb98-1150"><a href="#cb98-1150" aria-hidden="true" tabindex="-1"></a>with non-zero OD pairs as records, and transportation mode as variables:</span>
<span id="cb98-1153"><a href="#cb98-1153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1154"><a href="#cb98-1154" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(bristol_od)</span>
<span id="cb98-1155"><a href="#cb98-1155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1156"><a href="#cb98-1156" aria-hidden="true" tabindex="-1"></a>The number of zero OD values is found by subtracting the number of</span>
<span id="cb98-1157"><a href="#cb98-1157" aria-hidden="true" tabindex="-1"></a>non-zero records from the total number of OD combinations:</span>
<span id="cb98-1160"><a href="#cb98-1160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1161"><a href="#cb98-1161" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(bristol_zones)<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> <span class="fu">nrow</span>(bristol_od) </span>
<span id="cb98-1162"><a href="#cb98-1162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1163"><a href="#cb98-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1164"><a href="#cb98-1164" aria-hidden="true" tabindex="-1"></a>We will form a three-dimensional vector data cube with origin,</span>
<span id="cb98-1165"><a href="#cb98-1165" aria-hidden="true" tabindex="-1"></a>destination, and transportation mode as dimensions. For this, we</span>
<span id="cb98-1166"><a href="#cb98-1166" aria-hidden="true" tabindex="-1"></a>first "tidy" the <span class="in">`bristol_od`</span> table to have origin (o), destination (d),</span>
<span id="cb98-1167"><a href="#cb98-1167" aria-hidden="true" tabindex="-1"></a>transportation mode (mode), and count (n) as variables, using </span>
<span id="cb98-1168"><a href="#cb98-1168" aria-hidden="true" tabindex="-1"></a><span class="in">`pivot_longer`</span>:</span>
<span id="cb98-1169"><a href="#cb98-1169" aria-hidden="true" tabindex="-1"></a><span class="in">```{r bristol_tidy}</span></span>
<span id="cb98-1170"><a href="#cb98-1170" aria-hidden="true" tabindex="-1"></a><span class="in"># create O-D-mode array:</span></span>
<span id="cb98-1171"><a href="#cb98-1171" aria-hidden="true" tabindex="-1"></a><span class="in">bristol_tidy &lt;- bristol_od |&gt; </span></span>
<span id="cb98-1172"><a href="#cb98-1172" aria-hidden="true" tabindex="-1"></a><span class="in">    select(-all) |&gt; </span></span>
<span id="cb98-1173"><a href="#cb98-1173" aria-hidden="true" tabindex="-1"></a><span class="in">    pivot_longer(3:6, names_to = "mode", values_to = "n")</span></span>
<span id="cb98-1174"><a href="#cb98-1174" aria-hidden="true" tabindex="-1"></a><span class="in">head(bristol_tidy)</span></span>
<span id="cb98-1175"><a href="#cb98-1175" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1176"><a href="#cb98-1176" aria-hidden="true" tabindex="-1"></a>Next, we form the three-dimensional array <span class="in">`a`</span>, filled with zeroes:</span>
<span id="cb98-1179"><a href="#cb98-1179" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1180"><a href="#cb98-1180" aria-hidden="true" tabindex="-1"></a>od <span class="ot">&lt;-</span> bristol_tidy <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"o"</span>) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span>
<span id="cb98-1181"><a href="#cb98-1181" aria-hidden="true" tabindex="-1"></a>nod <span class="ot">&lt;-</span> <span class="fu">length</span>(od)</span>
<span id="cb98-1182"><a href="#cb98-1182" aria-hidden="true" tabindex="-1"></a>mode <span class="ot">&lt;-</span> bristol_tidy <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"mode"</span>) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span>
<span id="cb98-1183"><a href="#cb98-1183" aria-hidden="true" tabindex="-1"></a>nmode <span class="ot">=</span> <span class="fu">length</span>(mode)</span>
<span id="cb98-1184"><a href="#cb98-1184" aria-hidden="true" tabindex="-1"></a>a <span class="ot">=</span> <span class="fu">array</span>(<span class="dv">0</span>L,  <span class="fu">c</span>(nod, nod, nmode), </span>
<span id="cb98-1185"><a href="#cb98-1185" aria-hidden="true" tabindex="-1"></a>    <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="at">o =</span> od, <span class="at">d =</span> od, <span class="at">mode =</span> mode))</span>
<span id="cb98-1186"><a href="#cb98-1186" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(a)</span>
<span id="cb98-1187"><a href="#cb98-1187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1188"><a href="#cb98-1188" aria-hidden="true" tabindex="-1"></a>We see that the dimensions are named with the zone names (o, d)</span>
<span id="cb98-1189"><a href="#cb98-1189" aria-hidden="true" tabindex="-1"></a>and the transportation mode name (mode). </span>
<span id="cb98-1190"><a href="#cb98-1190" aria-hidden="true" tabindex="-1"></a>Every row of <span class="in">`bristol_tidy`</span> denotes a single array entry, and we can</span>
<span id="cb98-1191"><a href="#cb98-1191" aria-hidden="true" tabindex="-1"></a>use this to fill the non-zero entries of <span class="in">`a`</span> using the <span class="in">`bristol_tidy`</span> </span>
<span id="cb98-1192"><a href="#cb98-1192" aria-hidden="true" tabindex="-1"></a>table to provide index (<span class="in">`o`</span>, <span class="in">`d`</span> and <span class="in">`mode`</span>)  and value (<span class="in">`n`</span>):</span>
<span id="cb98-1195"><a href="#cb98-1195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1196"><a href="#cb98-1196" aria-hidden="true" tabindex="-1"></a>a[<span class="fu">as.matrix</span>(bristol_tidy[<span class="fu">c</span>(<span class="st">"o"</span>, <span class="st">"d"</span>, <span class="st">"mode"</span>)])] <span class="ot">&lt;-</span> </span>
<span id="cb98-1197"><a href="#cb98-1197" aria-hidden="true" tabindex="-1"></a>        bristol_tidy<span class="sc">$</span>n</span>
<span id="cb98-1198"><a href="#cb98-1198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1199"><a href="#cb98-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1200"><a href="#cb98-1200" aria-hidden="true" tabindex="-1"></a>To be sure that there is not an order mismatch between the zones</span>
<span id="cb98-1201"><a href="#cb98-1201" aria-hidden="true" tabindex="-1"></a>in <span class="in">`bristol_zones`</span> and the zone names in <span class="in">`bristol_tidy`</span>, we can</span>
<span id="cb98-1202"><a href="#cb98-1202" aria-hidden="true" tabindex="-1"></a>get the right set of zones by:</span>
<span id="cb98-1205"><a href="#cb98-1205" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1206"><a href="#cb98-1206" aria-hidden="true" tabindex="-1"></a>order <span class="ot">&lt;-</span> <span class="fu">match</span>(od, bristol_zones<span class="sc">$</span>geo_code)</span>
<span id="cb98-1207"><a href="#cb98-1207" aria-hidden="true" tabindex="-1"></a>zones <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(bristol_zones)[order]</span>
<span id="cb98-1208"><a href="#cb98-1208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1209"><a href="#cb98-1209" aria-hidden="true" tabindex="-1"></a>(It happens that the order is already correct, but it is good</span>
<span id="cb98-1210"><a href="#cb98-1210" aria-hidden="true" tabindex="-1"></a>practice to not assume this.)</span>
<span id="cb98-1211"><a href="#cb98-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1212"><a href="#cb98-1212" aria-hidden="true" tabindex="-1"></a>Next, with zones and modes we can create a stars dimensions object:</span>
<span id="cb98-1215"><a href="#cb98-1215" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1216"><a href="#cb98-1216" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span>
<span id="cb98-1217"><a href="#cb98-1217" aria-hidden="true" tabindex="-1"></a>(d <span class="ot">&lt;-</span> <span class="fu">st_dimensions</span>(<span class="at">o =</span> zones, <span class="at">d =</span> zones, <span class="at">mode =</span> mode))</span>
<span id="cb98-1218"><a href="#cb98-1218" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1219"><a href="#cb98-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1220"><a href="#cb98-1220" aria-hidden="true" tabindex="-1"></a>and finally build a stars object from <span class="in">`a`</span> and <span class="in">`d`</span>:</span>
<span id="cb98-1223"><a href="#cb98-1223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1224"><a href="#cb98-1224" aria-hidden="true" tabindex="-1"></a>(odm <span class="ot">&lt;-</span> <span class="fu">st_as_stars</span>(<span class="fu">list</span>(<span class="at">N =</span> a), <span class="at">dimensions =</span> d))</span>
<span id="cb98-1225"><a href="#cb98-1225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1226"><a href="#cb98-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1227"><a href="#cb98-1227" aria-hidden="true" tabindex="-1"></a>We can take a single slice through this three-dimensional</span>
<span id="cb98-1228"><a href="#cb98-1228" aria-hidden="true" tabindex="-1"></a>array, for instance for zone 33 (@fig-bristol1), by <span class="in">`odm[ , , 33]`</span>, </span>
<span id="cb98-1229"><a href="#cb98-1229" aria-hidden="true" tabindex="-1"></a>and plot it with</span>
<span id="cb98-1230"><a href="#cb98-1230" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-odm33, fig.cap = "OD matrix sliced for destination zone 33, by transportation mode"}</span></span>
<span id="cb98-1231"><a href="#cb98-1231" aria-hidden="true" tabindex="-1"></a><span class="in">plot(adrop(odm[,,33]) + 1, logz = TRUE)</span></span>
<span id="cb98-1232"><a href="#cb98-1232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1233"><a href="#cb98-1233" aria-hidden="true" tabindex="-1"></a>the result of which is shown in @fig-odm33.</span>
<span id="cb98-1234"><a href="#cb98-1234" aria-hidden="true" tabindex="-1"></a>Subsetting this way, we take all attributes (there is only one: N)</span>
<span id="cb98-1235"><a href="#cb98-1235" aria-hidden="true" tabindex="-1"></a>since the first argument is empty, we take all origin regions (second</span>
<span id="cb98-1236"><a href="#cb98-1236" aria-hidden="true" tabindex="-1"></a>argument empty), we take destination zone 33 (third argument),</span>
<span id="cb98-1237"><a href="#cb98-1237" aria-hidden="true" tabindex="-1"></a>and all transportation modes (fourth argument empty, or missing).</span>
<span id="cb98-1238"><a href="#cb98-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1239"><a href="#cb98-1239" aria-hidden="true" tabindex="-1"></a>We plotted this particular zone because it has the largest number of travellers</span>
<span id="cb98-1240"><a href="#cb98-1240" aria-hidden="true" tabindex="-1"></a>as its destination. We can find this out by summing all origins and</span>
<span id="cb98-1241"><a href="#cb98-1241" aria-hidden="true" tabindex="-1"></a>travel modes by destination:</span>
<span id="cb98-1244"><a href="#cb98-1244" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1245"><a href="#cb98-1245" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">st_apply</span>(odm, <span class="dv">2</span>, sum)</span>
<span id="cb98-1246"><a href="#cb98-1246" aria-hidden="true" tabindex="-1"></a><span class="fu">which.max</span>(d[[<span class="dv">1</span>]])</span>
<span id="cb98-1247"><a href="#cb98-1247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1248"><a href="#cb98-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1249"><a href="#cb98-1249" aria-hidden="true" tabindex="-1"></a>Other aggregations we can carry out include: </span>
<span id="cb98-1250"><a href="#cb98-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1251"><a href="#cb98-1251" aria-hidden="true" tabindex="-1"></a>Total transportation by OD (102 x 102):</span>
<span id="cb98-1254"><a href="#cb98-1254" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1255"><a href="#cb98-1255" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(odm, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, sum)</span>
<span id="cb98-1256"><a href="#cb98-1256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1257"><a href="#cb98-1257" aria-hidden="true" tabindex="-1"></a>Origin totals, by mode:</span>
<span id="cb98-1260"><a href="#cb98-1260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1261"><a href="#cb98-1261" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(odm, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), sum)</span>
<span id="cb98-1262"><a href="#cb98-1262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1263"><a href="#cb98-1263" aria-hidden="true" tabindex="-1"></a>Destination totals, by mode:</span>
<span id="cb98-1266"><a href="#cb98-1266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1267"><a href="#cb98-1267" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(odm, <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), sum)</span>
<span id="cb98-1268"><a href="#cb98-1268" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1269"><a href="#cb98-1269" aria-hidden="true" tabindex="-1"></a>Origin totals, summed over modes:</span>
<span id="cb98-1272"><a href="#cb98-1272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1273"><a href="#cb98-1273" aria-hidden="true" tabindex="-1"></a>o <span class="ot">&lt;-</span> <span class="fu">st_apply</span>(odm, <span class="dv">1</span>, sum)</span>
<span id="cb98-1274"><a href="#cb98-1274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1275"><a href="#cb98-1275" aria-hidden="true" tabindex="-1"></a>Destination totals, summed over modes (we had this):</span>
<span id="cb98-1278"><a href="#cb98-1278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1279"><a href="#cb98-1279" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">st_apply</span>(odm, <span class="dv">2</span>, sum)</span>
<span id="cb98-1280"><a href="#cb98-1280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1281"><a href="#cb98-1281" aria-hidden="true" tabindex="-1"></a>We plot <span class="in">`o`</span> and <span class="in">`d`</span> together after joining them by</span>
<span id="cb98-1282"><a href="#cb98-1282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-odjoined, out.height = '90%', fig.cap = "Total commutes, summed by origin (left) or destination (right)"}</span></span>
<span id="cb98-1283"><a href="#cb98-1283" aria-hidden="true" tabindex="-1"></a><span class="in">x &lt;- (c(o, d, along = list(od = c("origin", "destination"))))</span></span>
<span id="cb98-1284"><a href="#cb98-1284" aria-hidden="true" tabindex="-1"></a><span class="in">plot(x, logz = TRUE)</span></span>
<span id="cb98-1285"><a href="#cb98-1285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1286"><a href="#cb98-1286" aria-hidden="true" tabindex="-1"></a>the result of which is shown in @fig-odjoined.</span>
<span id="cb98-1287"><a href="#cb98-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1288"><a href="#cb98-1288" aria-hidden="true" tabindex="-1"></a>There is something to say for the argument that such maps</span>
<span id="cb98-1289"><a href="#cb98-1289" aria-hidden="true" tabindex="-1"></a>give the wrong message, as both amount (colour) and polygon</span>
<span id="cb98-1290"><a href="#cb98-1290" aria-hidden="true" tabindex="-1"></a>size give an impression of amount. To take out the amount</span>
<span id="cb98-1291"><a href="#cb98-1291" aria-hidden="true" tabindex="-1"></a>in the count, we can compute densities (count / km$^2$), by</span>
<span id="cb98-1292"><a href="#cb98-1292" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-odbykm, out.height = '90%', fig.cap = "Total commutes per square km, by area of origin (left) or destination (right)", message=FALSE}</span></span>
<span id="cb98-1293"><a href="#cb98-1293" aria-hidden="true" tabindex="-1"></a><span class="in">library(units)</span></span>
<span id="cb98-1294"><a href="#cb98-1294" aria-hidden="true" tabindex="-1"></a><span class="in">a &lt;- set_units(st_area(st_as_sf(o)), km^2)</span></span>
<span id="cb98-1295"><a href="#cb98-1295" aria-hidden="true" tabindex="-1"></a><span class="in">o$sum_km &lt;- o$sum / a</span></span>
<span id="cb98-1296"><a href="#cb98-1296" aria-hidden="true" tabindex="-1"></a><span class="in">d$sum_km &lt;- d$sum / a</span></span>
<span id="cb98-1297"><a href="#cb98-1297" aria-hidden="true" tabindex="-1"></a><span class="in">od &lt;- c(o["sum_km"], d["sum_km"], along = </span></span>
<span id="cb98-1298"><a href="#cb98-1298" aria-hidden="true" tabindex="-1"></a><span class="in">        list(od = c("origin", "destination")))</span></span>
<span id="cb98-1299"><a href="#cb98-1299" aria-hidden="true" tabindex="-1"></a><span class="in">plot(od, logz = TRUE)</span></span>
<span id="cb98-1300"><a href="#cb98-1300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1301"><a href="#cb98-1301" aria-hidden="true" tabindex="-1"></a>shown in @fig-odbykm. Another way to normalize these</span>
<span id="cb98-1302"><a href="#cb98-1302" aria-hidden="true" tabindex="-1"></a>totals would be to divide them by population size.</span>
<span id="cb98-1303"><a href="#cb98-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1304"><a href="#cb98-1304" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tidy array data</span></span>
<span id="cb98-1305"><a href="#cb98-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1306"><a href="#cb98-1306" aria-hidden="true" tabindex="-1"></a>\index{data cube!tidy}</span>
<span id="cb98-1307"><a href="#cb98-1307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1308"><a href="#cb98-1308" aria-hidden="true" tabindex="-1"></a>The _tidy data_ paper <span class="co">[</span><span class="ot">@tidy</span><span class="co">]</span> may suggest that such array data should be processed not as an array, but in a long (unnormalised) table form where each row holds (region, class, year, value), and it is always good to be able to do this. For primary handling and storage, however,</span>
<span id="cb98-1309"><a href="#cb98-1309" aria-hidden="true" tabindex="-1"></a>this is often not an option, because:</span>
<span id="cb98-1310"><a href="#cb98-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1311"><a href="#cb98-1311" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>a lot of array data are collected or generated as array data, for instance</span>
<span id="cb98-1312"><a href="#cb98-1312" aria-hidden="true" tabindex="-1"></a>by imagery or other sensory devices, or by climate models</span>
<span id="cb98-1313"><a href="#cb98-1313" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>it is easier to derive the long table form from the array than</span>
<span id="cb98-1314"><a href="#cb98-1314" aria-hidden="true" tabindex="-1"></a>vice versa</span>
<span id="cb98-1315"><a href="#cb98-1315" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>the long table form requires much more memory, since the space</span>
<span id="cb98-1316"><a href="#cb98-1316" aria-hidden="true" tabindex="-1"></a>occupied by dimension values is $O(\Pi n_i)$, rather than $O(\Sigma n_i)$, with $n_i$ the cardinality (size) of dimension $i$</span>
<span id="cb98-1317"><a href="#cb98-1317" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>when missing-valued cells are dropped, the long table form loses</span>
<span id="cb98-1318"><a href="#cb98-1318" aria-hidden="true" tabindex="-1"></a>the implicit indexing of the array form</span>
<span id="cb98-1319"><a href="#cb98-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1320"><a href="#cb98-1320" aria-hidden="true" tabindex="-1"></a>To put this argument to the extreme, consider for instance that</span>
<span id="cb98-1321"><a href="#cb98-1321" aria-hidden="true" tabindex="-1"></a>all image, video and sound data are stored in array form; few</span>
<span id="cb98-1322"><a href="#cb98-1322" aria-hidden="true" tabindex="-1"></a>people would make a real case for storing them in a long table</span>
<span id="cb98-1323"><a href="#cb98-1323" aria-hidden="true" tabindex="-1"></a>form instead.  Nevertheless, R packages like **tsibble** <span class="co">[</span><span class="ot">@R-tsibble</span><span class="co">]</span> take this</span>
<span id="cb98-1324"><a href="#cb98-1324" aria-hidden="true" tabindex="-1"></a>approach, and have to deal with ambiguous ordering of multiple records</span>
<span id="cb98-1325"><a href="#cb98-1325" aria-hidden="true" tabindex="-1"></a>with identical time steps for different spatial features and index</span>
<span id="cb98-1326"><a href="#cb98-1326" aria-hidden="true" tabindex="-1"></a>them, which is solved for both _automatically_ by using the array</span>
<span id="cb98-1327"><a href="#cb98-1327" aria-hidden="true" tabindex="-1"></a>form -- at the cost of using dense arrays, in package **stars**.</span>
<span id="cb98-1328"><a href="#cb98-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1329"><a href="#cb98-1329" aria-hidden="true" tabindex="-1"></a>Package **stars** tries to follow the [tidy</span>
<span id="cb98-1330"><a href="#cb98-1330" aria-hidden="true" tabindex="-1"></a>manifesto](https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html)</span>
<span id="cb98-1331"><a href="#cb98-1331" aria-hidden="true" tabindex="-1"></a>to handle array sets and has particularly developed support for the</span>
<span id="cb98-1332"><a href="#cb98-1332" aria-hidden="true" tabindex="-1"></a>case where one or more of the dimensions refer to space and/or time.</span>
<span id="cb98-1333"><a href="#cb98-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1334"><a href="#cb98-1334" aria-hidden="true" tabindex="-1"></a><span class="fu">### File formats for vector data cubes</span></span>
<span id="cb98-1335"><a href="#cb98-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1336"><a href="#cb98-1336" aria-hidden="true" tabindex="-1"></a>Regular table forms, including the long table form, are</span>
<span id="cb98-1337"><a href="#cb98-1337" aria-hidden="true" tabindex="-1"></a>possible but clumsy to use: the origin-destination data example above</span>
<span id="cb98-1338"><a href="#cb98-1338" aria-hidden="true" tabindex="-1"></a>and @sec-stgeostatistics illustrate the complexity of recreating</span>
<span id="cb98-1339"><a href="#cb98-1339" aria-hidden="true" tabindex="-1"></a>a vector data cube from table forms. Array formats like NetCDF or</span>
<span id="cb98-1340"><a href="#cb98-1340" aria-hidden="true" tabindex="-1"></a>Zarr are designed for storing array data. They can however be used</span>
<span id="cb98-1341"><a href="#cb98-1341" aria-hidden="true" tabindex="-1"></a>for _any_ data structure, and carry the risk that files once written</span>
<span id="cb98-1342"><a href="#cb98-1342" aria-hidden="true" tabindex="-1"></a>are hard to reuse. For vector cubes that have a _single_ geometry</span>
<span id="cb98-1343"><a href="#cb98-1343" aria-hidden="true" tabindex="-1"></a>dimension that consists of either points, (multi)linestrings or</span>
<span id="cb98-1344"><a href="#cb98-1344" aria-hidden="true" tabindex="-1"></a>(multi)polygons, the CF conventions <span class="co">[</span><span class="ot">@cf</span><span class="co">]</span> describe a way to encode</span>
<span id="cb98-1345"><a href="#cb98-1345" aria-hidden="true" tabindex="-1"></a>such geometries. <span class="in">`stars::read_mdim`</span> and <span class="in">`stars::write_mdim`</span> can</span>
<span id="cb98-1346"><a href="#cb98-1346" aria-hidden="true" tabindex="-1"></a>read and write vector data cubes following these conventions.</span>
<span id="cb98-1347"><a href="#cb98-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1348"><a href="#cb98-1348" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{read<span class="sc">\_</span>mdim}</span>
<span id="cb98-1349"><a href="#cb98-1349" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{write<span class="sc">\_</span>mdim}</span>
<span id="cb98-1350"><a href="#cb98-1350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1351"><a href="#cb98-1351" aria-hidden="true" tabindex="-1"></a><span class="fu">## Raster-to-vector, vector-to-raster {#sec-raster-to-vector}</span></span>
<span id="cb98-1352"><a href="#cb98-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1353"><a href="#cb98-1353" aria-hidden="true" tabindex="-1"></a>@sec-rasterize already showed some examples of raster-to-vector</span>
<span id="cb98-1354"><a href="#cb98-1354" aria-hidden="true" tabindex="-1"></a>and vector-to-raster conversions. This section will add some code</span>
<span id="cb98-1355"><a href="#cb98-1355" aria-hidden="true" tabindex="-1"></a>details and examples.</span>
<span id="cb98-1356"><a href="#cb98-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1357"><a href="#cb98-1357" aria-hidden="true" tabindex="-1"></a><span class="fu">### Vector-to-raster</span></span>
<span id="cb98-1358"><a href="#cb98-1358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1359"><a href="#cb98-1359" aria-hidden="true" tabindex="-1"></a>\index{vector to raster}</span>
<span id="cb98-1360"><a href="#cb98-1360" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>as<span class="sc">\_</span>stars}</span>
<span id="cb98-1361"><a href="#cb98-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1362"><a href="#cb98-1362" aria-hidden="true" tabindex="-1"></a><span class="in">`st_as_stars`</span> is meant as a method to transform objects into <span class="in">`stars`</span></span>
<span id="cb98-1363"><a href="#cb98-1363" aria-hidden="true" tabindex="-1"></a>objects. However, not all stars objects are <span class="in">`raster`</span> objects,</span>
<span id="cb98-1364"><a href="#cb98-1364" aria-hidden="true" tabindex="-1"></a>and the method for <span class="in">`sf`</span> objects creates a vector data cube with</span>
<span id="cb98-1365"><a href="#cb98-1365" aria-hidden="true" tabindex="-1"></a>the geometry as its spatial (vector) dimension, and attributes</span>
<span id="cb98-1366"><a href="#cb98-1366" aria-hidden="true" tabindex="-1"></a>as attributes.  When given a feature _geometry_ (<span class="in">`sfc`</span>) object,</span>
<span id="cb98-1367"><a href="#cb98-1367" aria-hidden="true" tabindex="-1"></a><span class="in">`st_as_stars`</span> will rasterise it, as shown in @sec-warp</span>
<span id="cb98-1368"><a href="#cb98-1368" aria-hidden="true" tabindex="-1"></a>and in @fig-asstars.</span>
<span id="cb98-1369"><a href="#cb98-1369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1370"><a href="#cb98-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1371"><a href="#cb98-1371" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-asstars}</span></span>
<span id="cb98-1372"><a href="#cb98-1372" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Rasterising vector geometry using `st_as_stars`"</span></span>
<span id="cb98-1373"><a href="#cb98-1373" aria-hidden="true" tabindex="-1"></a><span class="in">file &lt;- system.file("gpkg/nc.gpkg", package="sf")</span></span>
<span id="cb98-1374"><a href="#cb98-1374" aria-hidden="true" tabindex="-1"></a><span class="in">read_sf(file) |&gt; </span></span>
<span id="cb98-1375"><a href="#cb98-1375" aria-hidden="true" tabindex="-1"></a><span class="in">    st_geometry() |&gt;</span></span>
<span id="cb98-1376"><a href="#cb98-1376" aria-hidden="true" tabindex="-1"></a><span class="in">    st_as_stars() |&gt;</span></span>
<span id="cb98-1377"><a href="#cb98-1377" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(key.pos = 4)</span></span>
<span id="cb98-1378"><a href="#cb98-1378" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1379"><a href="#cb98-1379" aria-hidden="true" tabindex="-1"></a>Here, <span class="in">`st_as_stars`</span> can be parameterised to control cell size,</span>
<span id="cb98-1380"><a href="#cb98-1380" aria-hidden="true" tabindex="-1"></a>number of cells, and/or extent. The cell values returned are 0 for</span>
<span id="cb98-1381"><a href="#cb98-1381" aria-hidden="true" tabindex="-1"></a>cells with centre point outside the geometry and 1 for cell with</span>
<span id="cb98-1382"><a href="#cb98-1382" aria-hidden="true" tabindex="-1"></a>centre point inside or on the border of the geometry.  Rasterising</span>
<span id="cb98-1383"><a href="#cb98-1383" aria-hidden="true" tabindex="-1"></a>existing features is done using <span class="in">`st_rasterize`</span>, as also shown in</span>
<span id="cb98-1384"><a href="#cb98-1384" aria-hidden="true" tabindex="-1"></a>@fig-vectoras:</span>
<span id="cb98-1385"><a href="#cb98-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1388"><a href="#cb98-1388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1389"><a href="#cb98-1389" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb98-1390"><a href="#cb98-1390" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(file) <span class="sc">|&gt;</span></span>
<span id="cb98-1391"><a href="#cb98-1391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">as.factor</span>(NAME)) <span class="sc">|&gt;</span></span>
<span id="cb98-1392"><a href="#cb98-1392" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(SID74, SID79, name) <span class="sc">|&gt;</span></span>
<span id="cb98-1393"><a href="#cb98-1393" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_rasterize</span>()</span>
<span id="cb98-1394"><a href="#cb98-1394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1395"><a href="#cb98-1395" aria-hidden="true" tabindex="-1"></a>Similarly, line and point geometries can be rasterised, as shown</span>
<span id="cb98-1396"><a href="#cb98-1396" aria-hidden="true" tabindex="-1"></a>in @fig-lineras.</span>
<span id="cb98-1397"><a href="#cb98-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1398"><a href="#cb98-1398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-lineras}</span></span>
<span id="cb98-1399"><a href="#cb98-1399" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Rasterising the North Carolina county boundaries"</span></span>
<span id="cb98-1400"><a href="#cb98-1400" aria-hidden="true" tabindex="-1"></a><span class="in">read_sf(file) |&gt;</span></span>
<span id="cb98-1401"><a href="#cb98-1401" aria-hidden="true" tabindex="-1"></a><span class="in">    st_cast("MULTILINESTRING") |&gt;</span></span>
<span id="cb98-1402"><a href="#cb98-1402" aria-hidden="true" tabindex="-1"></a><span class="in">    select(CNTY_ID) |&gt;</span></span>
<span id="cb98-1403"><a href="#cb98-1403" aria-hidden="true" tabindex="-1"></a><span class="in">    st_rasterize() |&gt;</span></span>
<span id="cb98-1404"><a href="#cb98-1404" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(key.pos = 4)</span></span>
<span id="cb98-1405"><a href="#cb98-1405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1406"><a href="#cb98-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1407"><a href="#cb98-1407" aria-hidden="true" tabindex="-1"></a><span class="fu">## Coordinate transformations and conversions {#sec-projsf}</span></span>
<span id="cb98-1408"><a href="#cb98-1408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1409"><a href="#cb98-1409" aria-hidden="true" tabindex="-1"></a>\index{sf!projection}</span>
<span id="cb98-1410"><a href="#cb98-1410" aria-hidden="true" tabindex="-1"></a>\index{stars!projection}</span>
<span id="cb98-1411"><a href="#cb98-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1412"><a href="#cb98-1412" aria-hidden="true" tabindex="-1"></a><span class="fu">### `st_crs`</span></span>
<span id="cb98-1413"><a href="#cb98-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1414"><a href="#cb98-1414" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>crs}</span>
<span id="cb98-1415"><a href="#cb98-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1416"><a href="#cb98-1416" aria-hidden="true" tabindex="-1"></a>Spatial objects of class <span class="in">`sf`</span> or <span class="in">`stars`</span> contain a coordinate</span>
<span id="cb98-1417"><a href="#cb98-1417" aria-hidden="true" tabindex="-1"></a>reference system that can be retrieved or replaced with <span class="in">`st_crs`</span>, or can be</span>
<span id="cb98-1418"><a href="#cb98-1418" aria-hidden="true" tabindex="-1"></a>set or replaced in a pipe with <span class="in">`st_set_crs`</span>. Coordinate reference</span>
<span id="cb98-1419"><a href="#cb98-1419" aria-hidden="true" tabindex="-1"></a>systems can be set with an EPSG code, like <span class="in">`st_crs(4326)`</span> which</span>
<span id="cb98-1420"><a href="#cb98-1420" aria-hidden="true" tabindex="-1"></a>will be converted to <span class="in">`st_crs('EPSG:4326')`</span>, or with a PROJ.4 string</span>
<span id="cb98-1421"><a href="#cb98-1421" aria-hidden="true" tabindex="-1"></a>like <span class="in">`"+proj=utm +zone=25 +south"`</span>, a name like "WGS84", or a name</span>
<span id="cb98-1422"><a href="#cb98-1422" aria-hidden="true" tabindex="-1"></a>preceded by an authority like "OGC:CRS84". Alternatives include</span>
<span id="cb98-1423"><a href="#cb98-1423" aria-hidden="true" tabindex="-1"></a>a coordinate reference system definition in WKT, WKT-2 (@sec-wkt2)</span>
<span id="cb98-1424"><a href="#cb98-1424" aria-hidden="true" tabindex="-1"></a>or <span class="co">[</span><span class="ot">PROJJSON</span><span class="co">](https://proj.org/specifications/projjson.html)</span>.</span>
<span id="cb98-1425"><a href="#cb98-1425" aria-hidden="true" tabindex="-1"></a>The object returned by <span class="in">`st_crs`</span> contains two fields: </span>
<span id="cb98-1426"><a href="#cb98-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1427"><a href="#cb98-1427" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`wkt`</span> with the WKT-2 representation </span>
<span id="cb98-1428"><a href="#cb98-1428" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`input`</span> with the user input, if any, or a human readable</span>
<span id="cb98-1429"><a href="#cb98-1429" aria-hidden="true" tabindex="-1"></a>description of the coordinate reference system, if available</span>
<span id="cb98-1430"><a href="#cb98-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1431"><a href="#cb98-1431" aria-hidden="true" tabindex="-1"></a>Note that PROJ.4 strings can be used to</span>
<span id="cb98-1432"><a href="#cb98-1432" aria-hidden="true" tabindex="-1"></a>_define_ some coordinate reference systems, but they cannot be used</span>
<span id="cb98-1433"><a href="#cb98-1433" aria-hidden="true" tabindex="-1"></a>to _represent_ coordinate reference systems. Conversion of a</span>
<span id="cb98-1434"><a href="#cb98-1434" aria-hidden="true" tabindex="-1"></a>WKT-2 in a <span class="in">`crs`</span> object to a proj4string using the <span class="in">`$proj4string`</span></span>
<span id="cb98-1435"><a href="#cb98-1435" aria-hidden="true" tabindex="-1"></a>method, as in</span>
<span id="cb98-1438"><a href="#cb98-1438" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1439"><a href="#cb98-1439" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(<span class="st">"OGC:CRS84"</span>)</span>
<span id="cb98-1440"><a href="#cb98-1440" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>proj4string</span>
<span id="cb98-1441"><a href="#cb98-1441" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1442"><a href="#cb98-1442" aria-hidden="true" tabindex="-1"></a>may succeed but is not in general lossless or invertible. Using</span>
<span id="cb98-1443"><a href="#cb98-1443" aria-hidden="true" tabindex="-1"></a>PROJ.4 strings, for instance to _define_ a parameterised, projected</span>
<span id="cb98-1444"><a href="#cb98-1444" aria-hidden="true" tabindex="-1"></a>coordinate reference system is fine as long as it is associated</span>
<span id="cb98-1445"><a href="#cb98-1445" aria-hidden="true" tabindex="-1"></a>with the WGS84 datum.</span>
<span id="cb98-1446"><a href="#cb98-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1447"><a href="#cb98-1447" aria-hidden="true" tabindex="-1"></a><span class="fu">### `st_transform`, `sf_project`</span></span>
<span id="cb98-1448"><a href="#cb98-1448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1449"><a href="#cb98-1449" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>transform}</span>
<span id="cb98-1450"><a href="#cb98-1450" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{sf<span class="sc">\_</span>project}</span>
<span id="cb98-1451"><a href="#cb98-1451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1452"><a href="#cb98-1452" aria-hidden="true" tabindex="-1"></a>Coordinate transformations or conversions (@sec-projlib)</span>
<span id="cb98-1453"><a href="#cb98-1453" aria-hidden="true" tabindex="-1"></a>for <span class="in">`sf`</span> or <span class="in">`stars`</span> objects are carried out with <span class="in">`st_transform`</span>,</span>
<span id="cb98-1454"><a href="#cb98-1454" aria-hidden="true" tabindex="-1"></a>which takes as its first argument a spatial object of class <span class="in">`sf`</span> or</span>
<span id="cb98-1455"><a href="#cb98-1455" aria-hidden="true" tabindex="-1"></a><span class="in">`stars`</span> that has a coordinate reference system set, and as a second</span>
<span id="cb98-1456"><a href="#cb98-1456" aria-hidden="true" tabindex="-1"></a>argument with an <span class="in">`crs`</span> object (or something that can be converted</span>
<span id="cb98-1457"><a href="#cb98-1457" aria-hidden="true" tabindex="-1"></a>to it with <span class="in">`st_crs`</span>). When PROJ finds more than one possibility</span>
<span id="cb98-1458"><a href="#cb98-1458" aria-hidden="true" tabindex="-1"></a>to transform or convert from the source <span class="in">`crs`</span> to the target <span class="in">`crs`</span>,</span>
<span id="cb98-1459"><a href="#cb98-1459" aria-hidden="true" tabindex="-1"></a>it chooses the one with the highest declared accuracy. More fine-grained</span>
<span id="cb98-1460"><a href="#cb98-1460" aria-hidden="true" tabindex="-1"></a>control over the options is explained in @sec-pipelines.</span>
<span id="cb98-1461"><a href="#cb98-1461" aria-hidden="true" tabindex="-1"></a>For <span class="in">`stars`</span> objects with regular raster dimensions, <span class="in">`st_transform`</span></span>
<span id="cb98-1462"><a href="#cb98-1462" aria-hidden="true" tabindex="-1"></a>will _only_ transform coordinates and always result in a curvilinear</span>
<span id="cb98-1463"><a href="#cb98-1463" aria-hidden="true" tabindex="-1"></a>grid. <span class="in">`st_warp`</span> can be used to create a regular raster in a new</span>
<span id="cb98-1464"><a href="#cb98-1464" aria-hidden="true" tabindex="-1"></a>coordinate reference system, using regridding (@sec-warp).</span>
<span id="cb98-1465"><a href="#cb98-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1466"><a href="#cb98-1466" aria-hidden="true" tabindex="-1"></a>A lower-level function to transform or convert coordinates _not_</span>
<span id="cb98-1467"><a href="#cb98-1467" aria-hidden="true" tabindex="-1"></a>in <span class="in">`sf`</span> or <span class="in">`stars`</span> objects is <span class="in">`sf_project`</span>: it takes a matrix with</span>
<span id="cb98-1468"><a href="#cb98-1468" aria-hidden="true" tabindex="-1"></a>coordinates and a source and target <span class="in">`crs`</span>, and it returns transformed</span>
<span id="cb98-1469"><a href="#cb98-1469" aria-hidden="true" tabindex="-1"></a>or converted coordinates.</span>
<span id="cb98-1470"><a href="#cb98-1470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1471"><a href="#cb98-1471" aria-hidden="true" tabindex="-1"></a><span class="fu">### `sf_proj_info`</span></span>
<span id="cb98-1472"><a href="#cb98-1472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1473"><a href="#cb98-1473" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{sf<span class="sc">\_</span>proj<span class="sc">\_</span>info}</span>
<span id="cb98-1474"><a href="#cb98-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1475"><a href="#cb98-1475" aria-hidden="true" tabindex="-1"></a>Function <span class="in">`sf_proj_info`</span> can be used to query the available projections,</span>
<span id="cb98-1476"><a href="#cb98-1476" aria-hidden="true" tabindex="-1"></a>ellipsoids, units and prime meridians available in the PROJ</span>
<span id="cb98-1477"><a href="#cb98-1477" aria-hidden="true" tabindex="-1"></a>software. It takes a single parameter, <span class="in">`type`</span>, which can have the</span>
<span id="cb98-1478"><a href="#cb98-1478" aria-hidden="true" tabindex="-1"></a>following values:</span>
<span id="cb98-1479"><a href="#cb98-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1480"><a href="#cb98-1480" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`type = "proj"`</span> lists the short and long names of available</span>
<span id="cb98-1481"><a href="#cb98-1481" aria-hidden="true" tabindex="-1"></a>projections; short names can be used in a "+proj=name" string</span>
<span id="cb98-1482"><a href="#cb98-1482" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`type = "ellps"`</span> lists the available ellipses, with name, long name,</span>
<span id="cb98-1483"><a href="#cb98-1483" aria-hidden="true" tabindex="-1"></a>and ellipsoidal parameters</span>
<span id="cb98-1484"><a href="#cb98-1484" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`type = "units"`</span> lists the available length units, with conversion</span>
<span id="cb98-1485"><a href="#cb98-1485" aria-hidden="true" tabindex="-1"></a>constant to meters</span>
<span id="cb98-1486"><a href="#cb98-1486" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`type = "prime_meridians"`</span> lists the prime meridians with their</span>
<span id="cb98-1487"><a href="#cb98-1487" aria-hidden="true" tabindex="-1"></a>position with respect to the Greenwich meridian</span>
<span id="cb98-1488"><a href="#cb98-1488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1489"><a href="#cb98-1489" aria-hidden="true" tabindex="-1"></a><span class="fu">### Datum grids, proj.db, cdn.proj.org, local cache</span></span>
<span id="cb98-1490"><a href="#cb98-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1491"><a href="#cb98-1491" aria-hidden="true" tabindex="-1"></a>\index{proj.db}</span>
<span id="cb98-1492"><a href="#cb98-1492" aria-hidden="true" tabindex="-1"></a>\index{datum!grids}</span>
<span id="cb98-1493"><a href="#cb98-1493" aria-hidden="true" tabindex="-1"></a>\index{cdn.proj.org}</span>
<span id="cb98-1494"><a href="#cb98-1494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1495"><a href="#cb98-1495" aria-hidden="true" tabindex="-1"></a>Datum grids (@sec-projlib) can be installed locally, or</span>
<span id="cb98-1496"><a href="#cb98-1496" aria-hidden="true" tabindex="-1"></a>be read from the PROJ datum grid CDN at <span class="ot">&lt;https://cdn.proj.org/&gt;</span>. If</span>
<span id="cb98-1497"><a href="#cb98-1497" aria-hidden="true" tabindex="-1"></a>installed locally, they are read from the PROJ search path, which</span>
<span id="cb98-1498"><a href="#cb98-1498" aria-hidden="true" tabindex="-1"></a>is shown by</span>
<span id="cb98-1501"><a href="#cb98-1501" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1502"><a href="#cb98-1502" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_proj_search_paths</span>()</span>
<span id="cb98-1503"><a href="#cb98-1503" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1504"><a href="#cb98-1504" aria-hidden="true" tabindex="-1"></a>The main PROJ database is <span class="in">`proj.db`</span>, an sqlite3 database typically</span>
<span id="cb98-1505"><a href="#cb98-1505" aria-hidden="true" tabindex="-1"></a>found at</span>
<span id="cb98-1508"><a href="#cb98-1508" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1509"><a href="#cb98-1509" aria-hidden="true" tabindex="-1"></a><span class="fu">paste0</span>(<span class="fu">tail</span>(<span class="fu">sf_proj_search_paths</span>(), <span class="dv">1</span>), .Platform<span class="sc">$</span>file.sep, </span>
<span id="cb98-1510"><a href="#cb98-1510" aria-hidden="true" tabindex="-1"></a>       <span class="st">"proj.db"</span>)</span>
<span id="cb98-1511"><a href="#cb98-1511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1512"><a href="#cb98-1512" aria-hidden="true" tabindex="-1"></a>which can be read. The version of the snapshot of the EPSG database </span>
<span id="cb98-1513"><a href="#cb98-1513" aria-hidden="true" tabindex="-1"></a>included in each PROJ release is stated in the <span class="in">`"metadata"`</span> table of </span>
<span id="cb98-1514"><a href="#cb98-1514" aria-hidden="true" tabindex="-1"></a><span class="in">`proj.db`</span>; the version of the PROJ runtime used by **sf** is shown by</span>
<span id="cb98-1517"><a href="#cb98-1517" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1518"><a href="#cb98-1518" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_extSoftVersion</span>()[<span class="st">"PROJ"</span>]</span>
<span id="cb98-1519"><a href="#cb98-1519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1520"><a href="#cb98-1520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1521"><a href="#cb98-1521" aria-hidden="true" tabindex="-1"></a>If for a particular coordinate transformation datum grids are not</span>
<span id="cb98-1522"><a href="#cb98-1522" aria-hidden="true" tabindex="-1"></a>locally found, PROJ will search for online datum grids in the PROJ</span>
<span id="cb98-1523"><a href="#cb98-1523" aria-hidden="true" tabindex="-1"></a>CDN when</span>
<span id="cb98-1524"><a href="#cb98-1524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1527"><a href="#cb98-1527" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1528"><a href="#cb98-1528" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_proj_network</span>()</span>
<span id="cb98-1529"><a href="#cb98-1529" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1530"><a href="#cb98-1530" aria-hidden="true" tabindex="-1"></a>returns <span class="in">`TRUE`</span>. By default it is set to <span class="in">`FALSE`</span>, but</span>
<span id="cb98-1533"><a href="#cb98-1533" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1534"><a href="#cb98-1534" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_proj_network</span>(<span class="cn">TRUE</span>)</span>
<span id="cb98-1535"><a href="#cb98-1535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1536"><a href="#cb98-1536" aria-hidden="true" tabindex="-1"></a>sets it to <span class="in">`TRUE`</span> and returns the URL of the network resource used.</span>
<span id="cb98-1537"><a href="#cb98-1537" aria-hidden="true" tabindex="-1"></a>This resource can also be set to another resource, that may be</span>
<span id="cb98-1538"><a href="#cb98-1538" aria-hidden="true" tabindex="-1"></a>faster or less limited.</span>
<span id="cb98-1539"><a href="#cb98-1539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1540"><a href="#cb98-1540" aria-hidden="true" tabindex="-1"></a>After querying a datum grid on the CDN, PROJ writes the _portion_ of</span>
<span id="cb98-1541"><a href="#cb98-1541" aria-hidden="true" tabindex="-1"></a>the grid queried (not, by default, the entire grid) to a local cache,</span>
<span id="cb98-1542"><a href="#cb98-1542" aria-hidden="true" tabindex="-1"></a>which is another sqlite3 database found locally in a user directory</span>
<span id="cb98-1543"><a href="#cb98-1543" aria-hidden="true" tabindex="-1"></a>that is listed by</span>
<span id="cb98-1546"><a href="#cb98-1546" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1547"><a href="#cb98-1547" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="fu">sf_proj_search_paths</span>()[<span class="dv">1</span>], <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb98-1548"><a href="#cb98-1548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1549"><a href="#cb98-1549" aria-hidden="true" tabindex="-1"></a>and that will be searched first in subsequent datum grid queries.</span>
<span id="cb98-1550"><a href="#cb98-1550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1551"><a href="#cb98-1551" aria-hidden="true" tabindex="-1"></a><span class="fu">### Transformation pipelines {#sec-pipelines}</span></span>
<span id="cb98-1552"><a href="#cb98-1552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1553"><a href="#cb98-1553" aria-hidden="true" tabindex="-1"></a>\index{PROJ!pipelines}</span>
<span id="cb98-1554"><a href="#cb98-1554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1555"><a href="#cb98-1555" aria-hidden="true" tabindex="-1"></a>Internally, PROJ uses a so-called _coordinate operation pipeline_,</span>
<span id="cb98-1556"><a href="#cb98-1556" aria-hidden="true" tabindex="-1"></a>to represent the sequence of operations to get from a source CRS to</span>
<span id="cb98-1557"><a href="#cb98-1557" aria-hidden="true" tabindex="-1"></a>a target CRS.  Given multiple options to go from source to target,</span>
<span id="cb98-1558"><a href="#cb98-1558" aria-hidden="true" tabindex="-1"></a><span class="in">`st_transform`</span> chooses the one with highest accuracy. We can query</span>
<span id="cb98-1559"><a href="#cb98-1559" aria-hidden="true" tabindex="-1"></a>the options available by <span class="in">`sf_proj_pipelines`</span>:</span>
<span id="cb98-1562"><a href="#cb98-1562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1563"><a href="#cb98-1563" aria-hidden="true" tabindex="-1"></a>(p <span class="ot">&lt;-</span> <span class="fu">sf_proj_pipelines</span>(<span class="st">"OGC:CRS84"</span>, <span class="st">"EPSG:22525"</span>))</span>
<span id="cb98-1564"><a href="#cb98-1564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1565"><a href="#cb98-1565" aria-hidden="true" tabindex="-1"></a>and see that pipeline with the highest accuracy is summarised; we</span>
<span id="cb98-1566"><a href="#cb98-1566" aria-hidden="true" tabindex="-1"></a>can see that it specifies use of a datum grid.  Had we not switched</span>
<span id="cb98-1567"><a href="#cb98-1567" aria-hidden="true" tabindex="-1"></a>on the network search, we would have obtained a different result:</span>
<span id="cb98-1570"><a href="#cb98-1570" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1571"><a href="#cb98-1571" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_proj_network</span>(<span class="cn">FALSE</span>)</span>
<span id="cb98-1572"><a href="#cb98-1572" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_proj_pipelines</span>(<span class="st">"OGC:CRS84"</span>, <span class="st">"EPSG:22525"</span>)</span>
<span id="cb98-1573"><a href="#cb98-1573" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1574"><a href="#cb98-1574" aria-hidden="true" tabindex="-1"></a>and a report that a datum grid is missing. </span>
<span id="cb98-1575"><a href="#cb98-1575" aria-hidden="true" tabindex="-1"></a>The object returned by <span class="in">`sf_proj_pipelines`</span> is a sub-classed <span class="in">`data.frame`</span>, with columns</span>
<span id="cb98-1578"><a href="#cb98-1578" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1579"><a href="#cb98-1579" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(p)</span>
<span id="cb98-1580"><a href="#cb98-1580" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1581"><a href="#cb98-1581" aria-hidden="true" tabindex="-1"></a>and we can list for instance the accuracies by</span>
<span id="cb98-1584"><a href="#cb98-1584" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1585"><a href="#cb98-1585" aria-hidden="true" tabindex="-1"></a>p <span class="sc">|&gt;</span> <span class="fu">pull</span>(accuracy)</span>
<span id="cb98-1586"><a href="#cb98-1586" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1587"><a href="#cb98-1587" aria-hidden="true" tabindex="-1"></a>Here, <span class="in">`NA`</span> refers to "ballpark accuracy", which may be anything in the</span>
<span id="cb98-1588"><a href="#cb98-1588" aria-hidden="true" tabindex="-1"></a>30-120 m range:</span>
<span id="cb98-1591"><a href="#cb98-1591" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1592"><a href="#cb98-1592" aria-hidden="true" tabindex="-1"></a>p <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(accuracy))</span>
<span id="cb98-1593"><a href="#cb98-1593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1594"><a href="#cb98-1594" aria-hidden="true" tabindex="-1"></a>The default, most accurate pipeline chosen by <span class="in">`st_transform`</span> can</span>
<span id="cb98-1595"><a href="#cb98-1595" aria-hidden="true" tabindex="-1"></a>be overridden by specifying <span class="in">`pipeline`</span> argument, as selected from</span>
<span id="cb98-1596"><a href="#cb98-1596" aria-hidden="true" tabindex="-1"></a>the set of options in <span class="in">`p$definition`</span>.</span>
<span id="cb98-1597"><a href="#cb98-1597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1598"><a href="#cb98-1598" aria-hidden="true" tabindex="-1"></a><span class="fu">### Axis order and direction {#sec-axisorder}</span></span>
<span id="cb98-1599"><a href="#cb98-1599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1600"><a href="#cb98-1600" aria-hidden="true" tabindex="-1"></a>\index{axis order}</span>
<span id="cb98-1601"><a href="#cb98-1601" aria-hidden="true" tabindex="-1"></a>\index{coordinates!axis order}</span>
<span id="cb98-1602"><a href="#cb98-1602" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>axis<span class="sc">\_</span>order}</span>
<span id="cb98-1603"><a href="#cb98-1603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1604"><a href="#cb98-1604" aria-hidden="true" tabindex="-1"></a>As mentioned in @sec-wkt2, <span class="in">`EPSG:4326`</span></span>
<span id="cb98-1605"><a href="#cb98-1605" aria-hidden="true" tabindex="-1"></a>defines the first axis to be associated with latitude and the</span>
<span id="cb98-1606"><a href="#cb98-1606" aria-hidden="true" tabindex="-1"></a>second with longitude; this is also the case for a number of other</span>
<span id="cb98-1607"><a href="#cb98-1607" aria-hidden="true" tabindex="-1"></a>ellipsoidal coordinate reference systems. Although this is how</span>
<span id="cb98-1608"><a href="#cb98-1608" aria-hidden="true" tabindex="-1"></a>the authority (EPSG) prescribes this, it is not how most datasets</span>
<span id="cb98-1609"><a href="#cb98-1609" aria-hidden="true" tabindex="-1"></a>are currently stored. As most other software, package **sf** by default</span>
<span id="cb98-1610"><a href="#cb98-1610" aria-hidden="true" tabindex="-1"></a>ignores this and interprets ellipsoidal coordinate pairs as (longitude,</span>
<span id="cb98-1611"><a href="#cb98-1611" aria-hidden="true" tabindex="-1"></a>latitude) by default. If however data needs to be read from a data source</span>
<span id="cb98-1612"><a href="#cb98-1612" aria-hidden="true" tabindex="-1"></a>that is compliant to the authority, for instance from a WFS service,</span>
<span id="cb98-1613"><a href="#cb98-1613" aria-hidden="true" tabindex="-1"></a>one can set</span>
<span id="cb98-1614"><a href="#cb98-1614" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb98-1615"><a href="#cb98-1615" aria-hidden="true" tabindex="-1"></a><span class="in">st_axis_order(TRUE)</span></span>
<span id="cb98-1616"><a href="#cb98-1616" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1617"><a href="#cb98-1617" aria-hidden="true" tabindex="-1"></a>to globally instruct **sf**, when calling GDAL and PROJ routines, that</span>
<span id="cb98-1618"><a href="#cb98-1618" aria-hidden="true" tabindex="-1"></a>authority compliance (latitude, longitude order) is assumed. It is</span>
<span id="cb98-1619"><a href="#cb98-1619" aria-hidden="true" tabindex="-1"></a>anticipated that problems may happen in case of authority compliance,</span>
<span id="cb98-1620"><a href="#cb98-1620" aria-hidden="true" tabindex="-1"></a>for instance when with plotting data.  The <span class="in">`plot`</span> method for <span class="in">`sf`</span> objects</span>
<span id="cb98-1621"><a href="#cb98-1621" aria-hidden="true" tabindex="-1"></a>respects the axis order flag and will swap coordinates using the</span>
<span id="cb98-1622"><a href="#cb98-1622" aria-hidden="true" tabindex="-1"></a>transformation pipeline `"+proj=pipeline +step +proj=axisswap</span>
<span id="cb98-1623"><a href="#cb98-1623" aria-hidden="true" tabindex="-1"></a>+order=2,1"<span class="in">` before plotting them, but `</span>geom_sf` in</span>
<span id="cb98-1624"><a href="#cb98-1624" aria-hidden="true" tabindex="-1"></a><span class="in">`ggplot2`</span> has not been modified to do this.  As mentioned earlier,</span>
<span id="cb98-1625"><a href="#cb98-1625" aria-hidden="true" tabindex="-1"></a>the axis order ambiguity of <span class="in">`EPSG:4326`</span> is resolved by replacing</span>
<span id="cb98-1626"><a href="#cb98-1626" aria-hidden="true" tabindex="-1"></a>it with <span class="in">`OGC:CRS84`</span>.</span>
<span id="cb98-1627"><a href="#cb98-1627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1628"><a href="#cb98-1628" aria-hidden="true" tabindex="-1"></a>Independent from the axis order, not all coordinate reference systems</span>
<span id="cb98-1629"><a href="#cb98-1629" aria-hidden="true" tabindex="-1"></a>have an axis direction that is positive in North and East directions.</span>
<span id="cb98-1630"><a href="#cb98-1630" aria-hidden="true" tabindex="-1"></a>Most plotting functions in R will not work with data that have axes</span>
<span id="cb98-1631"><a href="#cb98-1631" aria-hidden="true" tabindex="-1"></a>defined in opposite directions.  Information on axes directions</span>
<span id="cb98-1632"><a href="#cb98-1632" aria-hidden="true" tabindex="-1"></a>and units can be retrieved by </span>
<span id="cb98-1635"><a href="#cb98-1635" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1636"><a href="#cb98-1636" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(<span class="dv">4326</span>)<span class="sc">$</span>axes</span>
<span id="cb98-1637"><a href="#cb98-1637" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(<span class="dv">4326</span>)<span class="sc">$</span>ud_unit</span>
<span id="cb98-1638"><a href="#cb98-1638" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(<span class="st">"EPSG:2053"</span>)<span class="sc">$</span>axes</span>
<span id="cb98-1639"><a href="#cb98-1639" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(<span class="st">"EPSG:2053"</span>)<span class="sc">$</span>ud_unit</span>
<span id="cb98-1640"><a href="#cb98-1640" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1641"><a href="#cb98-1641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1642"><a href="#cb98-1642" aria-hidden="true" tabindex="-1"></a><span class="fu">## Transforming and warping rasters {#sec-warp}</span></span>
<span id="cb98-1643"><a href="#cb98-1643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1644"><a href="#cb98-1644" aria-hidden="true" tabindex="-1"></a>\index{projection!rasters}</span>
<span id="cb98-1645"><a href="#cb98-1645" aria-hidden="true" tabindex="-1"></a>\index{warp!rasters}</span>
<span id="cb98-1646"><a href="#cb98-1646" aria-hidden="true" tabindex="-1"></a>\index{rasters!warp}</span>
<span id="cb98-1647"><a href="#cb98-1647" aria-hidden="true" tabindex="-1"></a>\index{stars!warp}</span>
<span id="cb98-1648"><a href="#cb98-1648" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{st<span class="sc">\_</span>warp}</span>
<span id="cb98-1649"><a href="#cb98-1649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1650"><a href="#cb98-1650" aria-hidden="true" tabindex="-1"></a>When using <span class="in">`st_transform`</span> on a raster dataset, as in</span>
<span id="cb98-1653"><a href="#cb98-1653" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1654"><a href="#cb98-1654" aria-hidden="true" tabindex="-1"></a>tif <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"tif/L7_ETMs.tif"</span>, <span class="at">package =</span> <span class="st">"stars"</span>)</span>
<span id="cb98-1655"><a href="#cb98-1655" aria-hidden="true" tabindex="-1"></a><span class="fu">read_stars</span>(tif) <span class="sc">|&gt;</span></span>
<span id="cb98-1656"><a href="#cb98-1656" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="st">'OGC:CRS84'</span>)</span>
<span id="cb98-1657"><a href="#cb98-1657" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1658"><a href="#cb98-1658" aria-hidden="true" tabindex="-1"></a>we see that a _curvilinear_ is created, which means that for every</span>
<span id="cb98-1659"><a href="#cb98-1659" aria-hidden="true" tabindex="-1"></a>grid cell the coordinates are computed in the new CRS, which no</span>
<span id="cb98-1660"><a href="#cb98-1660" aria-hidden="true" tabindex="-1"></a>longer form a _regular_ grid. Plotting such data is extremely slow,</span>
<span id="cb98-1661"><a href="#cb98-1661" aria-hidden="true" tabindex="-1"></a>as small polygons are computed for every grid cell and then plotted.</span>
<span id="cb98-1662"><a href="#cb98-1662" aria-hidden="true" tabindex="-1"></a>The advantage of this is that no information is lost: grid cell</span>
<span id="cb98-1663"><a href="#cb98-1663" aria-hidden="true" tabindex="-1"></a>values remain identical after the projection.</span>
<span id="cb98-1664"><a href="#cb98-1664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1665"><a href="#cb98-1665" aria-hidden="true" tabindex="-1"></a>When we start with a raster on a regular grid and want to obtain</span>
<span id="cb98-1666"><a href="#cb98-1666" aria-hidden="true" tabindex="-1"></a>a _regular_ grid in a new coordinate reference system, we need</span>
<span id="cb98-1667"><a href="#cb98-1667" aria-hidden="true" tabindex="-1"></a>to _warp_ the grid: we need to recreate a grid at new locations</span>
<span id="cb98-1668"><a href="#cb98-1668" aria-hidden="true" tabindex="-1"></a>and use some rule to assign values to new grid cells. Rules can</span>
<span id="cb98-1669"><a href="#cb98-1669" aria-hidden="true" tabindex="-1"></a>involve using the nearest value or using some form of interpolation.</span>
<span id="cb98-1670"><a href="#cb98-1670" aria-hidden="true" tabindex="-1"></a>This operation is not lossless and not invertible. </span>
<span id="cb98-1671"><a href="#cb98-1671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1672"><a href="#cb98-1672" aria-hidden="true" tabindex="-1"></a>The best approach for warping is to specify the target grid as a</span>
<span id="cb98-1673"><a href="#cb98-1673" aria-hidden="true" tabindex="-1"></a><span class="in">`stars`</span> object. When only a target CRS is specified, default options</span>
<span id="cb98-1674"><a href="#cb98-1674" aria-hidden="true" tabindex="-1"></a>for the target grid are picked that may be completely inappropriate</span>
<span id="cb98-1675"><a href="#cb98-1675" aria-hidden="true" tabindex="-1"></a>for the problem at hand. An example workflow that uses only a</span>
<span id="cb98-1676"><a href="#cb98-1676" aria-hidden="true" tabindex="-1"></a>target CRS is</span>
<span id="cb98-1679"><a href="#cb98-1679" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1680"><a href="#cb98-1680" aria-hidden="true" tabindex="-1"></a><span class="fu">read_stars</span>(tif) <span class="sc">|&gt;</span></span>
<span id="cb98-1681"><a href="#cb98-1681" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_warp</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="st">'OGC:CRS84'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb98-1682"><a href="#cb98-1682" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_dimensions</span>()</span>
<span id="cb98-1683"><a href="#cb98-1683" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1684"><a href="#cb98-1684" aria-hidden="true" tabindex="-1"></a>which creates a pretty close raster, but then the transformation</span>
<span id="cb98-1685"><a href="#cb98-1685" aria-hidden="true" tabindex="-1"></a>is also relatively modest.  For a workflow that creates a target </span>
<span id="cb98-1686"><a href="#cb98-1686" aria-hidden="true" tabindex="-1"></a>raster first, here with exactly the same number of rows and columns</span>
<span id="cb98-1687"><a href="#cb98-1687" aria-hidden="true" tabindex="-1"></a>as the original raster, one could use:</span>
<span id="cb98-1690"><a href="#cb98-1690" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb98-1691"><a href="#cb98-1691" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">read_stars</span>(tif)</span>
<span id="cb98-1692"><a href="#cb98-1692" aria-hidden="true" tabindex="-1"></a>grd <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(r) <span class="sc">|&gt;</span></span>
<span id="cb98-1693"><a href="#cb98-1693" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span></span>
<span id="cb98-1694"><a href="#cb98-1694" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_transform</span>(<span class="st">'OGC:CRS84'</span>) <span class="sc">|&gt;</span></span>
<span id="cb98-1695"><a href="#cb98-1695" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span></span>
<span id="cb98-1696"><a href="#cb98-1696" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_as_stars</span>(<span class="at">nx =</span> <span class="fu">dim</span>(r)[<span class="st">"x"</span>], <span class="at">ny =</span> <span class="fu">dim</span>(r)[<span class="st">"y"</span>])</span>
<span id="cb98-1697"><a href="#cb98-1697" aria-hidden="true" tabindex="-1"></a><span class="fu">st_warp</span>(r, grd)</span>
<span id="cb98-1698"><a href="#cb98-1698" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb98-1699"><a href="#cb98-1699" aria-hidden="true" tabindex="-1"></a>where we see that grid resolution in $x$ and $y$ directions slightly</span>
<span id="cb98-1700"><a href="#cb98-1700" aria-hidden="true" tabindex="-1"></a>varies.</span>
<span id="cb98-1701"><a href="#cb98-1701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1702"><a href="#cb98-1702" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises </span></span>
<span id="cb98-1703"><a href="#cb98-1703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1704"><a href="#cb98-1704" aria-hidden="true" tabindex="-1"></a>Use R to solve the following exercises.</span>
<span id="cb98-1705"><a href="#cb98-1705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-1706"><a href="#cb98-1706" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Find the names of the <span class="in">`nc`</span> counties that intersect <span class="in">`LINESTRING(-84 35,-78 35)`</span>; use <span class="in">`[`</span> for this, and as an alternative use <span class="in">`st_join`</span> for this.</span>
<span id="cb98-1707"><a href="#cb98-1707" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Repeat this after setting <span class="in">`sf_use_s2(FALSE)`</span>, and _compute_ the difference (hint: use <span class="in">`setdiff`</span>), and colour the counties of the difference using colour '#88000088'.</span>
<span id="cb98-1708"><a href="#cb98-1708" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Plot the two different lines in a single plot; note that R will plot a straight line always straight in the projection currently used; <span class="in">`st_segmentize`</span> can be used to add points on a straight line, or on a great circle for ellipsoidal coordinates.</span>
<span id="cb98-1709"><a href="#cb98-1709" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>NDVI, normalised differenced vegetation index, is computed as <span class="in">`(NIR-R)/(NIR+R)`</span>, with NIR the near infrared and R the red band.  Read the <span class="in">`L7_ETMs.tif`</span> file into object <span class="in">`x`</span>, and distribute the band dimensions over attributes by <span class="in">`split(x, "band")`</span>. Then, add attribute NDVI to this object by using an expression that uses the NIR (band 4) and R (band 3) attributes directly.</span>
<span id="cb98-1710"><a href="#cb98-1710" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Compute NDVI for the <span class="in">`L7_ETMs.tif`</span> image by reducing the band dimension, using <span class="in">`st_apply`</span> and a function <span class="in">`ndvi = function(x) { (x[4]-x[3])/(x[4]+x[3]) }`</span>. Plot the result, and write the result to a GeoTIFF. </span>
<span id="cb98-1711"><a href="#cb98-1711" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Use <span class="in">`st_transform`</span> to transform the <span class="in">`stars`</span> object read from <span class="in">`L7_ETMs.tif`</span> to <span class="in">`OGC:CRS84`</span>. Print the object. Is this a regular grid? Plot the first band using arguments <span class="in">`axes=TRUE`</span> and <span class="in">`border=NA`</span>, and explain why this takes such a long time.</span>
<span id="cb98-1712"><a href="#cb98-1712" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Use <span class="in">`st_warp`</span> to warp the <span class="in">`L7_ETMs.tif`</span> object to <span class="in">`OGC:CRS84`</span>, and plot the resulting object with <span class="in">`axes=TRUE`</span>. Why is the plot created much faster than after <span class="in">`st_transform`</span>?</span>
<span id="cb98-1713"><a href="#cb98-1713" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Using a vector representation of the raster <span class="in">`L7_ETMs`</span>, plot the</span>
<span id="cb98-1714"><a href="#cb98-1714" aria-hidden="true" tabindex="-1"></a>intersection with a circular area around <span class="in">`POINT(293716 9113692)`</span> with</span>
<span id="cb98-1715"><a href="#cb98-1715" aria-hidden="true" tabindex="-1"></a>radius 75 m,  and compute the area-weighted mean pixel values for</span>
<span id="cb98-1716"><a href="#cb98-1716" aria-hidden="true" tabindex="-1"></a>this circle.  Compare the area-weighted values with those obtained</span>
<span id="cb98-1717"><a href="#cb98-1717" aria-hidden="true" tabindex="-1"></a>by <span class="in">`aggregate`</span> using the vector data, and by <span class="in">`aggregate`</span> using</span>
<span id="cb98-1718"><a href="#cb98-1718" aria-hidden="true" tabindex="-1"></a>the raster data, using <span class="in">`exact=FALSE`</span> (default) and <span class="in">`exact=TRUE`</span>.</span>
<span id="cb98-1719"><a href="#cb98-1719" aria-hidden="true" tabindex="-1"></a>Explain the differences.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/07-Introsf.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>