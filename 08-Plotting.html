<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Spatial Data Science - 8&nbsp; Plotting spatial data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./09-Large.html" rel="next">
<link href="./07-Introsf.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-04YTZNEH1K"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
 
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'analytics_storage': 'denied'
  });
gtag('config', 'G-04YTZNEH1K', { 'anonymize_ip': true});
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-2.html">R for Spatial Data Science</a></li><li class="breadcrumb-item"><a href="./08-Plotting.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/edzer/sdsr/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-hello.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting Started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-Spaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Coordinates</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-Geometries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Spherical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spherical Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-Attributes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Attributes and Support</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-Cubes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R for Spatial Data Science</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-Introsf.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-Plotting.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-Large.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Models for Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Statistical modelling of spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-PointPattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Point Pattern Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-Interpolation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-Geostatistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-Areal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-Measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of Spatial Autocorrelation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-SpatialRegression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-Econometrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Spatial Econometrics Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sp-raster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Older R Spatial Packages</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rbasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">R Basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ERRATA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Errata to the printed ed.</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#sec-transform" id="toc-sec-transform" class="nav-link active" data-scroll-target="#sec-transform"><span class="header-section-number">8.1</span> Every plot is a projection</a>
  <ul class="collapse">
<li><a href="#what-is-a-good-projection-for-my-data" id="toc-what-is-a-good-projection-for-my-data" class="nav-link" data-scroll-target="#what-is-a-good-projection-for-my-data">What is a good projection for my data?</a></li>
  </ul>
</li>
  <li>
<a href="#plotting-points-lines-polygons-grid-cells" id="toc-plotting-points-lines-polygons-grid-cells" class="nav-link" data-scroll-target="#plotting-points-lines-polygons-grid-cells"><span class="header-section-number">8.2</span> Plotting points, lines, polygons, grid cells</a>
  <ul class="collapse">
<li><a href="#colours" id="toc-colours" class="nav-link" data-scroll-target="#colours">Colours</a></li>
  <li><a href="#sec-classintervals" id="toc-sec-classintervals" class="nav-link" data-scroll-target="#sec-classintervals">Colour breaks: <code>classInt</code></a></li>
  <li><a href="#sec-graticule" id="toc-sec-graticule" class="nav-link" data-scroll-target="#sec-graticule">Graticule and other navigation aids</a></li>
  </ul>
</li>
  <li>
<a href="#base-plot" id="toc-base-plot" class="nav-link" data-scroll-target="#base-plot"><span class="header-section-number">8.3</span> Base <code>plot</code></a>
  <ul class="collapse">
<li><a href="#adding-to-plots-with-legends" id="toc-adding-to-plots-with-legends" class="nav-link" data-scroll-target="#adding-to-plots-with-legends">Adding to plots with legends</a></li>
  <li><a href="#projections-in-base-plots" id="toc-projections-in-base-plots" class="nav-link" data-scroll-target="#projections-in-base-plots">Projections in base plots</a></li>
  <li><a href="#colours-and-colour-breaks" id="toc-colours-and-colour-breaks" class="nav-link" data-scroll-target="#colours-and-colour-breaks">Colours and colour breaks</a></li>
  </ul>
</li>
  <li><a href="#sec-geomsf" id="toc-sec-geomsf" class="nav-link" data-scroll-target="#sec-geomsf"><span class="header-section-number">8.4</span> Maps with <code>ggplot2</code></a></li>
  <li><a href="#sec-tmap" id="toc-sec-tmap" class="nav-link" data-scroll-target="#sec-tmap"><span class="header-section-number">8.5</span> Maps with <code>tmap</code></a></li>
  <li><a href="#interactive-maps-leaflet-mapview-tmap" id="toc-interactive-maps-leaflet-mapview-tmap" class="nav-link" data-scroll-target="#interactive-maps-leaflet-mapview-tmap"><span class="header-section-number">8.6</span> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code></a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">8.7</span> Exercises</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/08-Plotting.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-2.html">R for Spatial Data Science</a></li><li class="breadcrumb-item"><a href="./08-Plotting.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-plotting" class="quarto-section-identifier"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p></p>
<p>Together with timelines, maps belong to the most powerful graphs, perhaps because we can immediately relate to where we are, or once have been, on the space of the plot. Two recent books on visualisation <span class="citation" data-cites="Healy Wilke">(<a href="references.html#ref-Healy" role="doc-biblioref">Healy 2018</a>; <a href="references.html#ref-Wilke" role="doc-biblioref">Wilke 2019</a>)</span> contain chapters on visualising geospatial data or maps. Here, we will not try to point out which maps are good and which are bad, but rather a number of possibilities for creating them, challenges along the way, and possible ways to mitigate them.</p>
<section id="sec-transform" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="sec-transform">
<span class="header-section-number">8.1</span> Every plot is a projection</h2>
<p></p>
<p>The world is round, but plotting devices are flat. As mentioned in <a href="02-Spaces.html#sec-projections" class="quarto-xref"><span>Section 2.2.2</span></a>, any time we visualise, in any way, the world on a flat device, we project: we convert ellipsoidal coordinates into Cartesian coordinates. This includes the cases where we think we “do nothing” as in <a href="#fig-world" class="quarto-xref">Figure&nbsp;<span>8.1</span></a> (left), or where we show the world “as it is”, as one would see it from space (<a href="#fig-world" class="quarto-xref">Figure&nbsp;<span>8.1</span></a>, right).</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearth/">rnaturalearth</a></span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="st">"medium"</span>, returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">'OGC:CRS84'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">layout</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># sphere:</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/s2/">s2</a></span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/s2/reference/as_s2_geography.html">as_s2_geography</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Earth</span></span>
<span><span class="va">co</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_data_tbl_countries.html">s2_data_countries</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">oc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_boundary.html">s2_difference</a></span><span class="op">(</span><span class="va">g</span>, <span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_boundary.html">s2_union_agg</a></span><span class="op">(</span><span class="va">co</span><span class="op">)</span><span class="op">)</span> <span class="co"># oceans</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_boundary.html">s2_buffer_cells</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/s2/reference/as_s2_geography.html">as_s2_geography</a></span><span class="op">(</span><span class="st">"POINT(-30 -10)"</span><span class="op">)</span>, <span class="fl">9800000</span><span class="op">)</span> <span class="co"># visible half</span></span>
<span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_boundary.html">s2_intersection</a></span><span class="op">(</span><span class="va">b</span>, <span class="va">oc</span><span class="op">)</span> <span class="co"># visible ocean</span></span>
<span><span class="va">co</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_boundary.html">s2_intersection</a></span><span class="op">(</span><span class="va">b</span>, <span class="va">co</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, <span class="st">"+proj=ortho +lat_0=-10 +lon_0=-30"</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'lightblue'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="va">co</span><span class="op">)</span>, <span class="st">"+proj=ortho +lat_0=-10 +lon_0=-30"</span><span class="op">)</span>, col <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-world" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-world-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-Plotting_files/figure-html/fig-world-1.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-world-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.1: Earth country boundaries; left: mapping long/lat linearly to <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> (plate carrée); right: as seen from an infinite distance (orthographic)
</figcaption></figure>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
<p>The left plot of <a href="#fig-world" class="quarto-xref">Figure&nbsp;<span>8.1</span></a> was obtained by</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearth/">rnaturalearth</a></span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="st">"medium"</span>, returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>indicating that this is the default projection for global data with ellipsoidal coordinates:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_is_longlat.html">st_is_longlat</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The projection taken in <a href="#fig-world" class="quarto-xref">Figure&nbsp;<span>8.1</span></a> (left) is the equirectangular (or equidistant cylindrical) projection, which maps longitude and latitude linearly to the <span class="math inline">\(x\)</span>- and <span class="math inline">\(y\)</span>-axis, keeping an aspect ratio of 1. If we would do this for smaller areas not on the equator, then it would make sense to choose a plot ratio such that one distance unit E-W equals one distance unit N-S at the centre of the plotted area, and this is the default behaviour of the <code>plot</code> method for unprojected <code>sf</code> or <code>stars</code> datasets, as well as the default for <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">ggplot2::geom_sf</a></code> (<a href="#sec-geomsf" class="quarto-xref"><span>Section 8.4</span></a>).</p>
<p>We can also carry out this projection before plotting. Say we want to plot Germany, then after loading the (rough) country outline, we use <code>st_transform</code> to project:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">DE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html">ne_countries</a></span><span class="op">(</span>country <span class="op">=</span> <span class="st">"germany"</span>,</span>
<span>                              returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">DE</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="st">"+proj=eqc +lat_ts=51.14 +lon_0=90w"</span><span class="op">)</span> <span class="op">-&gt;</span></span>
<span>    <span class="va">DE.eqc</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, <code>eqc</code> refers to the “equidistant cylindrical” projection of PROJ. The projection parameter here is <code>lat_ts</code>, the latitude of <em>true scale</em>, where one length unit N-S equals one length unit E-W. This was chosen at the middle of the bounding box latitudes</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">DE</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ymin"</span>, <span class="st">"ymax"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co"># [1] 51.14</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We plot both maps in <a href="#fig-eqc" class="quarto-xref">Figure&nbsp;<span>8.2</span></a>, and they look identical up to the values along the axes: degrees for ellipsoidal (left) and metres for projected (Cartesian, right) coordinates.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.2</span>, <span class="fl">2.2</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">DE</span>, axes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">DE.eqc</span>, axes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-eqc" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-eqc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-Plotting_files/figure-html/fig-eqc-1.png" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-eqc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.2: Germany in equirectangular projection: with axis units degrees (left) and metres in the equidistant cylindrical projection (right)
</figcaption></figure>
</div>
</div>
</div>
<section id="what-is-a-good-projection-for-my-data" class="level3"><h3 class="anchored" data-anchor-id="what-is-a-good-projection-for-my-data">What is a good projection for my data?</h3>
<p></p>
<p>There is unfortunately no silver bullet here. Projections that maintain all distances do not exist; only globes do. The most used projections try to preserve:</p>
<ul>
<li>areas (equal area)</li>
<li>directions (conformal, such as <em>Mercator</em>)</li>
<li>some properties of distances (<em>equirectangular</em> preserves distances along meridians, <em>azimuthal equidistant</em> preserves distances to a central point)</li>
</ul>
<p>or some compromise of these. Parameters of projections decide what is shown in the centre of a map and what is shown on the fringes, which areas are up and which are down, and which areas are most enlarged. All these choices are in the end political decisions.</p>
<p>It is often entertaining and at times educational to play around with the different projections and understand their consequences. When the primary purpose of the map however is not to entertain or educate projection varieties, it may be preferable to choose a well-known or less surprising projection and move the discussion which projection to use to a decision process of its own. For global maps however, in almost all cases, equal area projections are preferred over plate carrée or web Mercator projections.</p>
</section></section><section id="plotting-points-lines-polygons-grid-cells" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="plotting-points-lines-polygons-grid-cells">
<span class="header-section-number">8.2</span> Plotting points, lines, polygons, grid cells</h2>
<p></p>
<p>Since maps are just a special form of plots of statistical data, the usual rules hold. Frequently occurring challenges include:</p>
<ul>
<li>polygons may be very small, and vanish when plotted</li>
<li>depending on the data, polygons for different features may well overlap, and be visible only partially; using transparent fill colours may help identify them</li>
<li>when points are plotted with symbols, they may easily overlap and be hidden; density maps (<a href="11-PointPattern.html" class="quarto-xref"><span>Chapter 11</span></a>) may be more helpful</li>
<li>lines may be hard to read when coloured and may overlap regardless the line width</li>
</ul>
<section id="colours" class="level3"><h3 class="anchored" data-anchor-id="colours">Colours</h3>
<p></p>
<p>When plotting polygons filled with colours, one has the choice to plot polygon boundaries or to suppress these. If polygon boundaries draw too much attention, an alternative is to colour them in a grey tone, or another colour that does not interfere with the fill colours. When suppressing boundaries entirely, polygons with (nearly) identical colours will no longer be visually distinguishable. If the property indicating the fill colour is constant over the region, such as land cover type, then this is not a problem, but if the property is an aggregation then the region over which it was aggregated gets lost, and by that the proper interpretation. Especially for extensive variables, such as the amount of people living in a polygon, this strongly misleads. But even with polygon boundaries, using filled polygons for extensive variables may not be a good idea because the map colours conflate amount and area size.</p>
<p>The use of continuous colour scales that have no noticeable colour breaks for continuously varying variables may look attractive, but is often more fancy than useful:</p>
<ul>
<li>it is impracticable to match a colour on the map with a legend value</li>
<li>colour ramps often stretch non-linearly over the value range, making it hard to convey magnitude</li>
</ul>
<p>Only for cases where the identification of values is less important than the continuity of the map, such as the colouring of a high resolution digital terrain model, it does serve its goal. Good colours scales and palettes are found in functions <code>hcl.colors</code> or <code>palette.colors</code>, and in packages <strong>RColorBrewer</strong> <span class="citation" data-cites="R-RColorBrewer">(<a href="references.html#ref-R-RColorBrewer" role="doc-biblioref">Neuwirth 2022</a>)</span>, <strong>viridis</strong> <span class="citation" data-cites="R-viridis">(<a href="references.html#ref-R-viridis" role="doc-biblioref">Garnier 2021</a>)</span>, or <strong>colorspace</strong> <span class="citation" data-cites="R-colorspace colorspace">(<a href="references.html#ref-R-colorspace" role="doc-biblioref">Ihaka et al. 2023</a>; <a href="references.html#ref-colorspace" role="doc-biblioref">Zeileis et al. 2020</a>)</span>.</p>
</section><section id="sec-classintervals" class="level3"><h3 class="anchored" data-anchor-id="sec-classintervals">Colour breaks: <code>classInt</code>
</h3>
<p> </p>
<p>When plotting continuous geometry attributes using a limited set of colours (or symbols), classes need to be made from the data. R package <strong>classInt</strong> <span class="citation" data-cites="R-classInt">(<a href="references.html#ref-R-classInt" role="doc-biblioref">Bivand 2022</a>)</span> provides a number of methods to do so. The default method is “quantile”:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/classInt/">classInt</a></span><span class="op">)</span></span>
<span><span class="co"># set.seed(1) if needed ?</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">cI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/classInt/reference/classIntervals.html">classIntervals</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># style: quantile</span></span>
<span><span class="co">#   one of 1.49e+10 possible partitions of this variable into 8 classes</span></span>
<span><span class="co">#   [-2.57,-1.28)  [-1.28,-0.827) [-0.827,-0.375) [-0.375,-0.126) </span></span>
<span><span class="co">#              13              12              13              12 </span></span>
<span><span class="co">#  [-0.126,0.277)   [0.277,0.644)    [0.644,1.34)     [1.34,1.98] </span></span>
<span><span class="co">#              12              13              12              13</span></span>
<span><span class="va">cI</span><span class="op">$</span><span class="va">brks</span></span>
<span><span class="co"># [1] -2.573 -1.280 -0.827 -0.375 -0.126  0.277  0.644  1.337  1.978</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>it takes argument <code>n</code> for the number of intervals, and a <code>style</code> that can be one of “fixed”, “sd”, “equal”, “pretty”, “quantile”, “kmeans”, “hclust”, “bclust”, “fisher” or “jenks”. Style “pretty” may not obey <code>n</code>; if <code>n</code> is missing, <code>nclass.Sturges</code> is used; two other methods are available for choosing <code>n</code> automatically. If the number of observations is greater than 3000, a 10% sample is used to create the breaks for “fisher” and “jenks”.</p>
</section><section id="sec-graticule" class="level3"><h3 class="anchored" data-anchor-id="sec-graticule">Graticule and other navigation aids</h3>
<p> </p>
<p>A graticule is a network of lines on a map that follow constant latitude or longitude. <a href="01-hello.html#fig-first-map" class="quarto-xref">Figure&nbsp;<span>1.1</span></a> shows a graticule drawn in grey, on <a href="01-hello.html#fig-firstgather" class="quarto-xref">Figure&nbsp;<span>1.2</span></a> it is white. Graticules are often drawn in maps to give place reference. In our first map in <a href="01-hello.html#fig-first-map" class="quarto-xref">Figure&nbsp;<span>1.1</span></a> we can read that the area plotted is near 35<span class="math inline">\(^o\)</span> North and 80<span class="math inline">\(^o\)</span> West. Had we plotted the lines in the projected coordinate system, they would have been straight and their actual numbers would not have been very informative, apart from giving an interpretation of size or distances when the unit is known, and familiar to the map reader. Graticules also shed light on which projection was used: equirectangular or Mercator projections have straight vertical and horizontal lines, conic projections have straight but diverging meridians, and equal area projections may have curved meridians.</p>
<div style="page-break-after: always;"></div>
<p>On <a href="#fig-world" class="quarto-xref">Figure&nbsp;<span>8.1</span></a> and most other maps the real navigation aid comes from geographical features like the state outline, country outlines, coast lines, rivers, roads, railways and so on. If these are added sparsely and sufficiently, a graticule can as well be omitted. In such cases, maps look good without axes, tics, and labels, leaving up a lot of plotting space to be filled with actual map data.</p>
</section></section><section id="base-plot" class="level2" data-number="8.3"><h2 data-number="8.3" class="anchored" data-anchor-id="base-plot">
<span class="header-section-number">8.3</span> Base <code>plot</code>
</h2>
<p></p>
<p>The <code>plot</code> method for <code>sf</code> and <code>stars</code> objects try to make quick, useful, exploratory plots; for higher quality plots and more configurability, alternatives with more control and/or better defaults are offered for instance by packages <strong>ggplot2</strong> <span class="citation" data-cites="R-ggplot2">(<a href="references.html#ref-R-ggplot2" role="doc-biblioref">Wickham et al. 2022</a>)</span>, <strong>tmap</strong> <span class="citation" data-cites="R-tmap tmap">(<a href="references.html#ref-R-tmap" role="doc-biblioref">Tennekes 2022</a>, <a href="references.html#ref-tmap" role="doc-biblioref">2018</a>)</span>, or <strong>mapsf</strong> <span class="citation" data-cites="R-mapsf">(<a href="references.html#ref-R-mapsf" role="doc-biblioref">Giraud 2022</a>)</span>.</p>
<p>By default, the plot method tries to plot “all” it is given. This means that:</p>
<ul>
<li>given a geometry only (<code>sfc</code>), the geometry is plotted, without colours</li>
<li>given a geometry and an attribute, the geometry is coloured according to the values of the attribute, using a qualitative colour scale for <code>factor</code> or <code>logical</code> attributes and a continuous scale otherwise, and a colour key is added</li>
<li>given multiple attributes, multiple maps are plotted, each with a colour scale but a key is by default omitted, as colour assignment is done on a per sub-map basis</li>
<li>for <code>stars</code> objects with multiple attributes, only the first attribute is plotted; for three-dimensional raster cubes, all slices over the third dimension are plotted as sub-plots</li>
</ul>
<section id="adding-to-plots-with-legends" class="level3"><h3 class="anchored" data-anchor-id="adding-to-plots-with-legends">Adding to plots with legends</h3>
<p></p>
<p>The <code>plot</code> methods for <code>stars</code> and <code>sf</code> objects may show a colour key on one of the sides (<a href="01-hello.html#fig-first-map" class="quarto-xref">Figure&nbsp;<span>1.1</span></a>). To do this with <code><a href="https://rdrr.io/r/base/plot.html">base::plot</a></code>, the plot region is split in two and two plots are created: one with the map, and one with the legend. By default, the <code>plot</code> function resets the graphics device (using <code>layout(matrix(1))</code> so that subsequent plots are not hindered by the device being split in two, but this prevents adding graphic elements subsequently. To <em>add</em> to an existing plot with a colour legend, the device reset needs to be prevented by using <code>reset = FALSE</code> in the <code>plot</code> command, and using <code>add = TRUE</code> in subsequent calls to <code>plot</code>. An example is</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"gpkg/nc.gpkg"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">nc</span><span class="op">[</span><span class="st">"BIR74"</span><span class="op">]</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, key.pos <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">nc</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="fl">10</span>, <span class="va">km</span><span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'NA'</span>, </span>
<span>     border <span class="op">=</span> <span class="st">'red'</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-figreset" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-figreset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-Plotting_files/figure-html/fig-figreset-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-figreset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.3: Annotating base plots with a legend
</figcaption></figure>
</div>
</div>
</div>
<p>which is shown in <a href="#fig-figreset" class="quarto-xref">Figure&nbsp;<span>8.3</span></a>. Annotating <code>stars</code> plots can be done in the same way when a <em>single</em> stars layer is shown. Annotating <code>stars</code> facet plots with multiple cube slices can be done by adding a “hook” function that will be called on every slice shown, as in</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span></span>
<span><span class="co"># Loading required package: abind</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">r</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html">st_sample</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="fl">300</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">circ</span></span>
<span><span class="va">hook</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">circ</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">'yellow'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span>, hook <span class="op">=</span> <span class="va">hook</span>, key.pos <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-starshook" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-starshook-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-Plotting_files/figure-html/fig-starshook-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-starshook-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.4: Annotated multi-slice stars plot
</figcaption></figure>
</div>
</div>
</div>
<p>and as shown in <a href="#fig-starshook" class="quarto-xref">Figure&nbsp;<span>8.4</span></a>. Hook functions have access to facet parameters, facet label and bounding box.</p>
<p>Base plot methods have access to the resolution of the screen device, and hence the base plot method for <code>stars</code> and <code>stars_proxy</code> object will downsample dense rasters and only plot pixels at a density that makes sense for the device available.</p>
</section><section id="projections-in-base-plots" class="level3"><h3 class="anchored" data-anchor-id="projections-in-base-plots">Projections in base plots</h3>
<p>The base <code>plot</code> method plots data with ellipsoidal coordinates using the equirectangular projection, using a latitude parameter equal to the middle latitude of the data bounding box (<a href="#fig-eqc" class="quarto-xref">Figure&nbsp;<span>8.2</span></a>). To control this parameter, either a projection to another equirectangular can be applied before plotting, or the parameter <code>asp</code> can be set to override: <code>asp=1</code> would lead to plate carrée (<a href="#fig-world" class="quarto-xref">Figure&nbsp;<span>8.1</span></a>) left. Subsequent plots need to be in the same coordinate reference system in order to make sense with over-plotting; this is not being checked.</p>
</section><section id="colours-and-colour-breaks" class="level3"><h3 class="anchored" data-anchor-id="colours-and-colour-breaks">Colours and colour breaks</h3>
<p>In base plots, argument <code>nbreaks</code> can be used to set the number of colour breaks and argument <code>breaks</code> either to the numeric vector with actual breaks, or to a style value for the <code>style</code> argument in <code><a href="https://r-spatial.github.io/classInt/reference/classIntervals.html">classInt::classIntervals</a></code>.</p>
</section></section><section id="sec-geomsf" class="level2" data-number="8.4"><h2 data-number="8.4" class="anchored" data-anchor-id="sec-geomsf">
<span class="header-section-number">8.4</span> Maps with <code>ggplot2</code>
</h2>
<p> </p>
<p>Package <strong>ggplot2</strong> <span class="citation" data-cites="R-ggplot2 ggplot2">(<a href="references.html#ref-R-ggplot2" role="doc-biblioref">Wickham et al. 2022</a>; <a href="references.html#ref-ggplot2" role="doc-biblioref">Wickham 2016</a>)</span> can create more complex and nicer looking graphs; it has a geometry <code>geom_sf</code> that was developed in conjunction with the development of <code>sf</code> and helps creating beautiful maps. An introduction to this is found in <span class="citation" data-cites="moreno">Moreno and Basille (<a href="references.html#ref-moreno" role="doc-biblioref">2018</a>)</span>. A first example is shown in <a href="01-hello.html#fig-firstgather" class="quarto-xref">Figure&nbsp;<span>1.2</span></a>. The code used for this plot is:</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">nc.32119</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">nc</span>, <span class="fl">32119</span><span class="op">)</span> </span>
<span><span class="va">year_labels</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SID74"</span> <span class="op">=</span> <span class="st">"1974 - 1978"</span>, <span class="st">"SID79"</span> <span class="op">=</span> <span class="st">"1979 - 1984"</span><span class="op">)</span></span>
<span><span class="va">nc.32119</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">SID74</span>, <span class="va">SID79</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"SID"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nc_longer</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nc_longer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">name</span>, ncol <span class="op">=</span> <span class="fl">1</span>, </span>
<span>             labeller <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labeller.html">labeller</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">year_labels</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">34</span><span class="op">:</span><span class="fl">36</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span>colours <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">sf.colors</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where we see that two attributes had to be stacked (<code>pivot_longer</code>) before plotting them as facets: this is the idea behind “tidy” data, and the <code>pivot_longer</code> method for <code>sf</code> objects automatically stacks the geometry column too.</p>
<p>Because <code>ggplot2</code> creates graphics <em>objects</em> before plotting them, it can control the coordinate reference system of all elements involved, and will transform or convert all subsequent objects to the coordinate reference system of the first. It will also draw a graticule for the (default) thin white lines on a grey background, and uses a datum (by default: WGS84) for this. <code>geom_sf</code> can be combined with other geoms, for instance to allow for annotating plots.</p>
<p></p>
<p>For package <strong>stars</strong>, a <code>geom_stars</code> has, at the moment of writing this, rather limited scope: it uses <code>geom_sf</code> for map layout and vector data cubes, and adds <code>geom_raster</code> for regular rasters and <code>geom_rect</code> for rectilinear rasters. It downsamples if the user specifies a downsampling rate, but has no access to the screen dimensions to automatically choose a downsampling rate. This may be just enough, for instance <a href="#fig-ggplotstars" class="quarto-xref">Figure&nbsp;<span>8.5</span></a> is created by the following commands:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">r</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">band</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ggplotstars" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ggplotstars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-Plotting_files/figure-html/fig-ggplotstars-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ggplotstars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.5: Simple facet raster plot with <code>ggplot2</code> and <code>geom_stars</code>
</figcaption></figure>
</div>
</div>
</div>
<p>More elaborate <code>ggplot2</code>-based plots with <code>stars</code> objects may be obtained using package <strong>ggspatial</strong> <span class="citation" data-cites="R-ggspatial">(<a href="references.html#ref-R-ggspatial" role="doc-biblioref">Dunnington 2022</a>)</span>. Non-compatible but nevertheless <code>ggplot2</code>-style plots can be created with <code>tmap</code>, a package dedicated to creating high quality maps (<a href="#sec-tmap" class="quarto-xref"><span>Section 8.5</span></a>).</p>
<p></p>
<p>When combining several feature sets with varying coordinate reference systems, using <code>geom_sf</code>, all sets are transformed to the reference system of the first set. To further control the “base” coordinate reference system, <code>coord_sf</code> can be used. This allows for instance working in a projected system, while combining graphics elements that are <em>not</em> <code>sf</code> objects but regular <code>data.frame</code>s with ellipsoidal coordinates associated to WGS84.</p>
<p>A twitter thread by Claus Wilke illustrating this is found <a href="https://twitter.com/ClausWilke/status/1275938314055561216">here</a>.</p>
<!---
FIXME: markup visible in PDF and HTML rendering
--->
</section><section id="sec-tmap" class="level2" data-number="8.5"><h2 data-number="8.5" class="anchored" data-anchor-id="sec-tmap">
<span class="header-section-number">8.5</span> Maps with <code>tmap</code>
</h2>
<p></p>
<p>Package <strong>tmap</strong> <span class="citation" data-cites="R-tmap tmap">(<a href="references.html#ref-R-tmap" role="doc-biblioref">Tennekes 2022</a>, <a href="references.html#ref-tmap" role="doc-biblioref">2018</a>)</span> takes a fresh look at plotting spatial data in R. It resembles <code>ggplot2</code> in the sense that it composes graphics objects before printing by building on the <code>grid</code> package, and by concatenating map elements with a <code>+</code> between them, but otherwise it is entirely independent from, and incompatible with, <code>ggplot2</code>. It has a number of options that allow for highly professional looking maps, and many defaults have been carefully chosen. Creating a map with two similar attributes can be done using <code>tm_polygons</code> with two attributes, we can use</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-tmap.github.io/tmap/">tmap</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"gpkg/nc.gpkg"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="st">'EPSG:32119'</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nc.32119</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">nc.32119</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_polygons</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SID74"</span>, <span class="st">"SID79"</span><span class="op">)</span>, title <span class="op">=</span> <span class="st">"SIDS"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>legend.outside <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>              panel.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1974-78"</span>, <span class="st">"1979-84"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_facets.html">tm_facets</a></span><span class="op">(</span>free.scales<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>to create <a href="#fig-tmapnc" class="quarto-xref">Figure&nbsp;<span>8.6</span></a>:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-tmap.github.io/tmap/">tmap</a></span><span class="op">)</span></span>
<span><span class="co"># Breaking News: tmap 3.x is retiring. Please test v4, e.g. with</span></span>
<span><span class="co"># remotes::install_github('r-tmap/tmap')</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"gpkg/nc.gpkg"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="st">'EPSG:32119'</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nc.32119</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">nc.32119</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_polygons</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SID74"</span>, <span class="st">"SID79"</span><span class="op">)</span>, title<span class="op">=</span><span class="st">"SIDS"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>legend.outside<span class="op">=</span><span class="cn">TRUE</span>, panel.labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1974-78"</span>, <span class="st">"1979-84"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_facets.html">tm_facets</a></span><span class="op">(</span>free.scales<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-tmapnc" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-tmapnc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-Plotting_files/figure-html/fig-tmapnc-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tmapnc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.6: <strong>tmap</strong>: using <code><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_polygons()</a></code> with two attribute names
</figcaption></figure>
</div>
</div>
</div>
<!---

::: {.cell}

```{.r .cell-code}
nc_longer <- nc.32119 |> select(SID74, SID79) |> 
    pivot_longer(starts_with("SID"), values_to = "SID")
tm_shape(nc_longer) + tm_polygons("SID") + 
    tm_facets(by = "name")
```
:::

::: {.cell}
::: {.cell-output-display}
![**tmap**: Using `tm_facets()` on a long table](08-Plotting_files/figure-html/fig-tmapnc2-1.png){#fig-tmapnc2 width=100%}
:::
:::

to create @fig-tmapnc2.
-->
<p>Alternatively, from the long table form obtained by <code>pivot_longer</code> one could use <code>+ tm_polygons("SID") + tm_facets(by = "name")</code>.</p>
<p>Package <strong>tmap</strong> also has support for <code>stars</code> objects, an example created with</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_raster.html">tm_raster</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-tmapstars" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-tmapstars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-Plotting_files/figure-html/fig-tmapstars-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tmapstars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.7: Simple raster plot with tmap
</figcaption></figure>
</div>
</div>
</div>
<p>is shown in <a href="#fig-tmapstars" class="quarto-xref">Figure&nbsp;<span>8.7</span></a>. More examples of the use of <strong>tmap</strong> are given in Chapters <a href="14-Areal.html" class="quarto-xref"><span>14</span></a>-<a href="16-SpatialRegression.html" class="quarto-xref"><span>16</span></a>.</p>
</section><section id="interactive-maps-leaflet-mapview-tmap" class="level2" data-number="8.6"><h2 data-number="8.6" class="anchored" data-anchor-id="interactive-maps-leaflet-mapview-tmap">
<span class="header-section-number">8.6</span> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code>
</h2>
<p> </p>
<p>Interactive maps as shown in <a href="01-hello.html#fig-mapviewfigure" class="quarto-xref">Figure&nbsp;<span>1.3</span></a> can be created with R packages <strong>leaflet</strong>, <strong>mapview</strong>, or <strong>tmap</strong>. Package <strong>mapview</strong> adds a number of capabilities to <strong>leaflet</strong> including a map legend, configurable pop-up windows when clicking features, support for raster data, and scalable maps with very large feature sets using the FlatGeobuf file format, as well as facet maps that react synchronously to zoom and pan actions. Package <strong>tmap</strong> has the option that after giving</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tmap_mode.html">tmap_mode</a></span><span class="op">(</span><span class="st">"view"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>all usual <code>tmap</code> commands are applied to an interactive html/leaflet widget, whereas after</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tmap_mode.html">tmap_mode</a></span><span class="op">(</span><span class="st">"plot"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>again all output is sent to R’s own (static) graphics device.</p>
</section><section id="exercises" class="level2" data-number="8.7"><h2 data-number="8.7" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">8.7</span> Exercises</h2>
<ol type="1">
<li>For the countries Indonesia and Canada, create individual plots using equirectangular, orthographic, and Lambert equal area projections, while choosing projection parameters sensible for the area.</li>
<li>Recreate the plot in <a href="#fig-figreset" class="quarto-xref">Figure&nbsp;<span>8.3</span></a> with <strong>ggplot2</strong> and with <strong>tmap</strong>.</li>
<li>Recreate the plot in <a href="#fig-tmapstars" class="quarto-xref">Figure&nbsp;<span>8.7</span></a> using the <code>viridis</code> colour ramp.</li>
<li>View the interactive plot in <a href="#fig-tmapstars" class="quarto-xref">Figure&nbsp;<span>8.7</span></a> using the “view” (interactive) mode of <code>tmap</code>, and explore which interactions are possible; also explore adding <code>+ tm_facets(as.layers=TRUE)</code> and try switching layers on and off. Try also setting a transparency value to 0.5.</li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-R-classInt" class="csl-entry" role="listitem">
Bivand, Roger. 2022. <em>classInt: Choose Univariate Class Intervals</em>. <a href="https://CRAN.R-project.org/package=classInt">https://CRAN.R-project.org/package=classInt</a>.
</div>
<div id="ref-R-ggspatial" class="csl-entry" role="listitem">
Dunnington, Dewey. 2022. <em>Ggspatial: Spatial Data Framework for Ggplot2</em>. <a href="https://CRAN.R-project.org/package=ggspatial">https://CRAN.R-project.org/package=ggspatial</a>.
</div>
<div id="ref-R-viridis" class="csl-entry" role="listitem">
Garnier, Simon. 2021. <em>Viridis: Colorblind-Friendly Color Maps for r</em>. <a href="https://CRAN.R-project.org/package=viridis">https://CRAN.R-project.org/package=viridis</a>.
</div>
<div id="ref-R-mapsf" class="csl-entry" role="listitem">
Giraud, Timothée. 2022. <em>Mapsf: Thematic Cartography</em>. <a href="https://riatelab.github.io/mapsf/">https://riatelab.github.io/mapsf/</a>.
</div>
<div id="ref-Healy" class="csl-entry" role="listitem">
Healy, Kieran. 2018. <em>Data Visualization, a Practical Introduction</em>. Princeton University Press. <a href="http://socviz.co/index.html">http://socviz.co/index.html</a>.
</div>
<div id="ref-R-colorspace" class="csl-entry" role="listitem">
Ihaka, Ross, Paul Murrell, Kurt Hornik, Jason C. Fisher, Reto Stauffer, Claus O. Wilke, Claire D. McWhite, and Achim Zeileis. 2023. <em>Colorspace: A Toolbox for Manipulating and Assessing Colors and Palettes</em>. <a href="https://CRAN.R-project.org/package=colorspace">https://CRAN.R-project.org/package=colorspace</a>.
</div>
<div id="ref-moreno" class="csl-entry" role="listitem">
Moreno, Mel, and Mathieu Basille. 2018. <em>Drawing Beautiful Maps Programmatically with r, Sf and Ggplot2 — Part 1: Basics</em>. <a href="https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html">https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html</a>.
</div>
<div id="ref-R-RColorBrewer" class="csl-entry" role="listitem">
Neuwirth, Erich. 2022. <em>RColorBrewer: ColorBrewer Palettes</em>. <a href="https://CRAN.R-project.org/package=RColorBrewer">https://CRAN.R-project.org/package=RColorBrewer</a>.
</div>
<div id="ref-tmap" class="csl-entry" role="listitem">
Tennekes, Martijn. 2018. <span>“<span class="nocase">tmap</span>: Thematic Maps in <span>R</span>.”</span> <em>Journal of Statistical Software</em> 84 (6): 1–39. <a href="https://doi.org/10.18637/jss.v084.i06">https://doi.org/10.18637/jss.v084.i06</a>.
</div>
<div id="ref-R-tmap" class="csl-entry" role="listitem">
———. 2022. <em>Tmap: Thematic Maps</em>. <a href="https://github.com/r-tmap/tmap">https://github.com/r-tmap/tmap</a>.
</div>
<div id="ref-ggplot2" class="csl-entry" role="listitem">
Wickham, Hadley. 2016. <em>Ggplot2: Elegant Graphics for Data Analysis</em>. Springer.
</div>
<div id="ref-R-ggplot2" class="csl-entry" role="listitem">
Wickham, Hadley, Winston Chang, Lionel Henry, Thomas Lin Pedersen, Kohske Takahashi, Claus Wilke, Kara Woo, Hiroaki Yutani, and Dewey Dunnington. 2022. <em>Ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics</em>. <a href="https://CRAN.R-project.org/package=ggplot2">https://CRAN.R-project.org/package=ggplot2</a>.
</div>
<div id="ref-Wilke" class="csl-entry" role="listitem">
Wilke, Claus O. 2019. <em>Fundamentals of Data Visualization</em>. O’Reilly Media, Inc. <a href="https://serialmentor.com/dataviz/">https://serialmentor.com/dataviz/</a>.
</div>
<div id="ref-colorspace" class="csl-entry" role="listitem">
Zeileis, Achim, Jason C. Fisher, Kurt Hornik, Ross Ihaka, Claire D. McWhite, Paul Murrell, Reto Stauffer, and Claus O. Wilke. 2020. <span>“<span class="nocase">colorspace</span>: A Toolbox for Manipulating and Assessing Colors and Palettes.”</span> <em>Journal of Statistical Software</em> 96 (1): 1–49. <a href="https://doi.org/10.18637/jss.v096.i01">https://doi.org/10.18637/jss.v096.i01</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/r-spatial\.org\/book\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./07-Introsf.html" class="pagination-link" aria-label="Introduction to sf and stars">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./09-Large.html" class="pagination-link" aria-label="Large data and cloud native">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb18" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Plotting spatial data {#sec-plotting}</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>\index{maps!plotting}</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>Together with timelines, maps belong to the most powerful graphs,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>perhaps because we can immediately relate to where we are, or</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>once have been, on the space of the plot. Two recent books on</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>visualisation <span class="co">[</span><span class="ot">@Healy; @Wilke</span><span class="co">]</span> contain chapters on visualising</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>geospatial data or maps. Here, we will not try to point out which</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>maps are good and which are bad, but rather a number of</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>possibilities for creating them, challenges along</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>the way, and possible ways to mitigate them.</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## Every plot is a projection {#sec-transform}</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>\index{maps!projections}</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>The world is round, but plotting devices are flat.  As mentioned</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>in @sec-projections, any time we visualise, in any</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>way, the world on a flat device, we project: we convert ellipsoidal</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>coordinates into Cartesian coordinates. This includes the cases where</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>we think we "do nothing" as in @fig-world (left), or where we show</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>the world "as it is", as one would see it from space (@fig-world, right).</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-world, echo = !knitr::is_latex_output(), message = FALSE}</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Earth country boundaries; left: mapping long/lat linearly to $x$ and $y$ (plate carrée); right: as seen from an infinite distance (orthographic)"</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 90%</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="in">library(rnaturalearth)</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="in">w &lt;- ne_countries(scale = "medium", returnclass = "sf")</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="in">suppressWarnings(st_crs(w) &lt;- st_crs('OGC:CRS84'))</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="in">layout(matrix(1:2, 1, 2), c(2,1))</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="in">par(mar = rep(0, 4))</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(w))</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="in"># sphere:</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="in">library(s2)</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="in">g &lt;- as_s2_geography(TRUE) # Earth</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="in">co &lt;- s2_data_countries()</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="in">oc &lt;- s2_difference(g, s2_union_agg(co)) # oceans</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- s2_buffer_cells(as_s2_geography("POINT(-30 -10)"), 9800000) # visible half</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="in">i &lt;- s2_intersection(b, oc) # visible ocean</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="in">co &lt;- s2_intersection(b, co)</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_transform(st_as_sfc(i), "+proj=ortho +lat_0=-10 +lon_0=-30"), col = 'lightblue')</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_transform(st_as_sfc(co), "+proj=ortho +lat_0=-10 +lon_0=-30"), col = NA, add = TRUE)</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>The left plot of @fig-world  was obtained by</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="in">library(rnaturalearth)</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="in">w &lt;- ne_countries(scale = "medium", returnclass = "sf")</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(w))</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>indicating that this is the default projection for global data with ellipsoidal coordinates:</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a><span class="fu">st_is_longlat</span>(w)</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>The projection taken in @fig-world (left) is the equirectangular</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>(or equidistant cylindrical) projection, which maps longitude and</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>latitude linearly to the $x$- and $y$-axis, keeping an aspect ratio of 1. </span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>If we would do this for smaller areas not on the equator, then it</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>would make sense to choose a plot ratio such that one distance unit E-W</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>equals one distance unit N-S at the centre of the plotted area,</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>and this is the default behaviour of the <span class="in">`plot`</span> method for</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>unprojected <span class="in">`sf`</span> or <span class="in">`stars`</span> datasets, as well as the default for</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a><span class="in">`ggplot2::geom_sf`</span> (@sec-geomsf).</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>We can also carry out this projection before plotting. Say we want to</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>plot Germany, then after loading the (rough) country outline,</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>we use <span class="in">`st_transform`</span> to project:</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>DE <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(<span class="fu">ne_countries</span>(<span class="at">country =</span> <span class="st">"germany"</span>,</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>                              <span class="at">returnclass =</span> <span class="st">"sf"</span>))</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>DE <span class="sc">|&gt;</span> <span class="fu">st_transform</span>(<span class="st">"+proj=eqc +lat_ts=51.14 +lon_0=90w"</span>) <span class="ot">-&gt;</span></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>    DE.eqc</span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>Here, <span class="in">`eqc`</span> refers to the "equidistant cylindrical" projection of PROJ.</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>The projection parameter here is <span class="in">`lat_ts`</span>, the latitude of _true</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>scale_, where one length unit N-S equals one length unit E-W.</span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>This was chosen at the middle of the bounding box latitudes</span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=!knitr::is_latex_output()}</span></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a><span class="in">print(mean(st_bbox(DE)[c("ymin", "ymax")]), digits = 4)</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>We plot both maps in @fig-eqc, and they look identical up to the values</span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>along the axes: degrees for ellipsoidal (left) and metres for</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>projected (Cartesian, right) coordinates.</span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-eqc, echo=!knitr::is_latex_output()}</span></span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.height: 4.5</span></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 70%</span></span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Germany in equirectangular projection: with axis units degrees (left) and metres in the equidistant cylindrical projection (right)"</span></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a><span class="in">par(mfrow = c(1, 2), mar = c(2.2, 2.2, 0.3, 0.5))</span></span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a><span class="in">plot(DE, axes = TRUE)</span></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a><span class="in">plot(DE.eqc, axes = TRUE)</span></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a><span class="fu">### What is a good projection for my data?</span></span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a>\index{projection!properties}</span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a>There is unfortunately no silver bullet here. Projections that</span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a>maintain all distances do not exist; only globes do. The most</span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a>used projections try to preserve:</span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>areas (equal area)</span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>directions (conformal, such as _Mercator_)</span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>some properties of distances (_equirectangular_ preserves distances along meridians, _azimuthal equidistant_ preserves distances to a central point)</span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a>or some compromise of these. Parameters of projections decide what</span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a>is shown in the centre of a map and what is shown on the fringes, which</span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a>areas are up and which are down, and which areas are most enlarged.</span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a>All these choices are in the end political decisions.</span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a>It is often entertaining and at times educational to play around with</span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a>the different projections and understand their consequences. When</span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a>the primary purpose of the map however is not to entertain or educate</span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a>projection varieties, it may be preferable to choose a well-known or</span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a>less surprising projection and move the discussion which projection</span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a>to use to a decision process of its own.  For global</span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a>maps however, in almost all cases, equal area projections are</span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a>preferred over plate carrée or web Mercator projections.</span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a><span class="fu">## Plotting points, lines, polygons, grid cells</span></span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a>\index{maps!plotting detail}</span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a>Since maps are just a special form of plots of statistical data,</span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a>the usual rules hold. Frequently occurring challenges include:</span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>polygons may be very small, and vanish when plotted</span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>depending on the data, polygons for different features may well</span>
<span id="cb18-141"><a href="#cb18-141" aria-hidden="true" tabindex="-1"></a>overlap, and be visible only partially; using transparent fill</span>
<span id="cb18-142"><a href="#cb18-142" aria-hidden="true" tabindex="-1"></a>colours may help identify them</span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>when points are plotted with symbols, they may easily overlap and be hidden; density maps (@sec-pointpatterns) may be more helpful</span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>lines may be hard to read when coloured and may overlap regardless the line width</span>
<span id="cb18-145"><a href="#cb18-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-146"><a href="#cb18-146" aria-hidden="true" tabindex="-1"></a><span class="fu">### Colours</span></span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a>\index{maps!colours}</span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a>When plotting polygons filled with colours, one has the choice to plot</span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a>polygon boundaries or to suppress these. If polygon boundaries draw</span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a>too much attention, an alternative is to colour them in a grey tone,</span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a>or another colour that does not interfere with the fill colours. When</span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a>suppressing boundaries entirely, polygons with (nearly) identical</span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a>colours will no longer be visually distinguishable. If the property</span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a>indicating the fill colour is constant over the region, such as land</span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a>cover type, then this is not a problem, but if the property is an</span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a>aggregation then the region over which it was aggregated gets lost,</span>
<span id="cb18-159"><a href="#cb18-159" aria-hidden="true" tabindex="-1"></a>and by that the proper interpretation. Especially for extensive</span>
<span id="cb18-160"><a href="#cb18-160" aria-hidden="true" tabindex="-1"></a>variables, such as the amount of people living in a polygon, this</span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a>strongly misleads. But even with polygon boundaries, using filled</span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a>polygons for extensive variables may not be a good idea because</span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a>the map colours conflate amount and area size.</span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a>The use of continuous colour scales that have no noticeable colour</span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a>breaks for continuously varying variables may look attractive,</span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a>but is often more fancy than useful:</span>
<span id="cb18-168"><a href="#cb18-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-169"><a href="#cb18-169" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>it is impracticable to match a colour on the map with a legend value</span>
<span id="cb18-170"><a href="#cb18-170" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>colour ramps often stretch non-linearly over the value range,</span>
<span id="cb18-171"><a href="#cb18-171" aria-hidden="true" tabindex="-1"></a>making it hard to convey magnitude</span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a>Only for cases where the identification of values is less</span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a>important than the continuity of the map, such as the colouring of</span>
<span id="cb18-175"><a href="#cb18-175" aria-hidden="true" tabindex="-1"></a>a high resolution digital terrain model, it does serve its goal.</span>
<span id="cb18-176"><a href="#cb18-176" aria-hidden="true" tabindex="-1"></a>Good colours scales and palettes are found in functions</span>
<span id="cb18-177"><a href="#cb18-177" aria-hidden="true" tabindex="-1"></a><span class="in">`hcl.colors`</span> or <span class="in">`palette.colors`</span>, and in packages **RColorBrewer**</span>
<span id="cb18-178"><a href="#cb18-178" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@R-RColorBrewer</span><span class="co">]</span>, **viridis** [@R-viridis], or **colorspace**</span>
<span id="cb18-179"><a href="#cb18-179" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@R-colorspace; @colorspace</span><span class="co">]</span>.</span>
<span id="cb18-180"><a href="#cb18-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-181"><a href="#cb18-181" aria-hidden="true" tabindex="-1"></a><span class="fu">### Colour breaks: `classInt` {#sec-classintervals}</span></span>
<span id="cb18-182"><a href="#cb18-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-183"><a href="#cb18-183" aria-hidden="true" tabindex="-1"></a>\index{maps!colour breaks}</span>
<span id="cb18-184"><a href="#cb18-184" aria-hidden="true" tabindex="-1"></a>\index{colour breaks}</span>
<span id="cb18-185"><a href="#cb18-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-186"><a href="#cb18-186" aria-hidden="true" tabindex="-1"></a>When plotting continuous geometry attributes using a limited set</span>
<span id="cb18-187"><a href="#cb18-187" aria-hidden="true" tabindex="-1"></a>of colours (or symbols), classes need to be made from the data.</span>
<span id="cb18-188"><a href="#cb18-188" aria-hidden="true" tabindex="-1"></a>R package **classInt** <span class="co">[</span><span class="ot">@R-classInt</span><span class="co">]</span> provides a number of methods to</span>
<span id="cb18-189"><a href="#cb18-189" aria-hidden="true" tabindex="-1"></a>do so. The default method is "quantile":</span>
<span id="cb18-192"><a href="#cb18-192" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-193"><a href="#cb18-193" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(classInt)</span>
<span id="cb18-194"><a href="#cb18-194" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(1) if needed ?</span></span>
<span id="cb18-195"><a href="#cb18-195" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">100</span>)</span>
<span id="cb18-196"><a href="#cb18-196" aria-hidden="true" tabindex="-1"></a>(cI <span class="ot">&lt;-</span> <span class="fu">classIntervals</span>(r))</span>
<span id="cb18-197"><a href="#cb18-197" aria-hidden="true" tabindex="-1"></a>cI<span class="sc">$</span>brks</span>
<span id="cb18-198"><a href="#cb18-198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-199"><a href="#cb18-199" aria-hidden="true" tabindex="-1"></a>it takes argument <span class="in">`n`</span> for the number of intervals, and a <span class="in">`style`</span></span>
<span id="cb18-200"><a href="#cb18-200" aria-hidden="true" tabindex="-1"></a>that can be one of "fixed", "sd", "equal", "pretty", "quantile",</span>
<span id="cb18-201"><a href="#cb18-201" aria-hidden="true" tabindex="-1"></a>"kmeans", "hclust", "bclust", "fisher" or "jenks".  Style "pretty"</span>
<span id="cb18-202"><a href="#cb18-202" aria-hidden="true" tabindex="-1"></a>may not obey <span class="in">`n`</span>; if <span class="in">`n`</span> is missing, <span class="in">`nclass.Sturges`</span> is used;</span>
<span id="cb18-203"><a href="#cb18-203" aria-hidden="true" tabindex="-1"></a>two other methods are available for choosing <span class="in">`n`</span> automatically. If </span>
<span id="cb18-204"><a href="#cb18-204" aria-hidden="true" tabindex="-1"></a>the number of observations is greater than 3000, a 10\% sample is used</span>
<span id="cb18-205"><a href="#cb18-205" aria-hidden="true" tabindex="-1"></a>to create the breaks for "fisher" and "jenks".</span>
<span id="cb18-206"><a href="#cb18-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-207"><a href="#cb18-207" aria-hidden="true" tabindex="-1"></a><span class="fu">### Graticule and other navigation aids {#sec-graticule}</span></span>
<span id="cb18-208"><a href="#cb18-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-209"><a href="#cb18-209" aria-hidden="true" tabindex="-1"></a>\index{maps!graticule}</span>
<span id="cb18-210"><a href="#cb18-210" aria-hidden="true" tabindex="-1"></a>\index{graticule}</span>
<span id="cb18-211"><a href="#cb18-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-212"><a href="#cb18-212" aria-hidden="true" tabindex="-1"></a>A graticule is a network of lines on a map that follow constant</span>
<span id="cb18-213"><a href="#cb18-213" aria-hidden="true" tabindex="-1"></a>latitude or longitude. @fig-first-map shows a graticule drawn in</span>
<span id="cb18-214"><a href="#cb18-214" aria-hidden="true" tabindex="-1"></a>grey, on @fig-firstgather it is white.  Graticules are often drawn in</span>
<span id="cb18-215"><a href="#cb18-215" aria-hidden="true" tabindex="-1"></a>maps to give place reference.  In our first map in @fig-first-map  we</span>
<span id="cb18-216"><a href="#cb18-216" aria-hidden="true" tabindex="-1"></a>can read that the area plotted is near 35$^o$ North and 80$^o$ West.</span>
<span id="cb18-217"><a href="#cb18-217" aria-hidden="true" tabindex="-1"></a>Had we plotted the lines in the projected coordinate system, they</span>
<span id="cb18-218"><a href="#cb18-218" aria-hidden="true" tabindex="-1"></a>would have been straight and their actual numbers would not have</span>
<span id="cb18-219"><a href="#cb18-219" aria-hidden="true" tabindex="-1"></a>been very informative, apart from giving an interpretation of size</span>
<span id="cb18-220"><a href="#cb18-220" aria-hidden="true" tabindex="-1"></a>or distances when the unit is known, and familiar to the map reader.</span>
<span id="cb18-221"><a href="#cb18-221" aria-hidden="true" tabindex="-1"></a>Graticules also shed light on which projection was used:</span>
<span id="cb18-222"><a href="#cb18-222" aria-hidden="true" tabindex="-1"></a>equirectangular or Mercator projections have straight vertical and</span>
<span id="cb18-223"><a href="#cb18-223" aria-hidden="true" tabindex="-1"></a>horizontal lines, conic projections have straight but diverging</span>
<span id="cb18-224"><a href="#cb18-224" aria-hidden="true" tabindex="-1"></a>meridians, and equal area projections may have curved meridians.</span>
<span id="cb18-225"><a href="#cb18-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-226"><a href="#cb18-226" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb18-227"><a href="#cb18-227" aria-hidden="true" tabindex="-1"></a>On @fig-world and most other maps the real navigation aid comes from</span>
<span id="cb18-228"><a href="#cb18-228" aria-hidden="true" tabindex="-1"></a>geographical features like the state outline, country outlines,</span>
<span id="cb18-229"><a href="#cb18-229" aria-hidden="true" tabindex="-1"></a>coast lines, rivers, roads, railways and so on. If these are added</span>
<span id="cb18-230"><a href="#cb18-230" aria-hidden="true" tabindex="-1"></a>sparsely and sufficiently, a graticule can as well be omitted. In</span>
<span id="cb18-231"><a href="#cb18-231" aria-hidden="true" tabindex="-1"></a>such cases, maps look good without axes, tics, and labels, leaving</span>
<span id="cb18-232"><a href="#cb18-232" aria-hidden="true" tabindex="-1"></a>up a lot of plotting space to be filled with actual map data.</span>
<span id="cb18-233"><a href="#cb18-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-234"><a href="#cb18-234" aria-hidden="true" tabindex="-1"></a><span class="fu">## Base `plot`</span></span>
<span id="cb18-235"><a href="#cb18-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-236"><a href="#cb18-236" aria-hidden="true" tabindex="-1"></a>\index{sf!plot method}</span>
<span id="cb18-237"><a href="#cb18-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-238"><a href="#cb18-238" aria-hidden="true" tabindex="-1"></a>The <span class="in">`plot`</span> method for <span class="in">`sf`</span> and <span class="in">`stars`</span> objects try to make quick,</span>
<span id="cb18-239"><a href="#cb18-239" aria-hidden="true" tabindex="-1"></a>useful, exploratory plots; for higher quality plots and more</span>
<span id="cb18-240"><a href="#cb18-240" aria-hidden="true" tabindex="-1"></a>configurability, alternatives with more control and/or better</span>
<span id="cb18-241"><a href="#cb18-241" aria-hidden="true" tabindex="-1"></a>defaults are offered for instance by packages **ggplot2** <span class="co">[</span><span class="ot">@R-ggplot2</span><span class="co">]</span>,</span>
<span id="cb18-242"><a href="#cb18-242" aria-hidden="true" tabindex="-1"></a>**tmap** [@R-tmap; @tmap], or **mapsf** <span class="co">[</span><span class="ot">@R-mapsf</span><span class="co">]</span>.</span>
<span id="cb18-243"><a href="#cb18-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-244"><a href="#cb18-244" aria-hidden="true" tabindex="-1"></a>By default, the plot method tries to plot "all" it is given.</span>
<span id="cb18-245"><a href="#cb18-245" aria-hidden="true" tabindex="-1"></a>This means that:</span>
<span id="cb18-246"><a href="#cb18-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-247"><a href="#cb18-247" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>given a geometry only (<span class="in">`sfc`</span>), the geometry is plotted, without colours</span>
<span id="cb18-248"><a href="#cb18-248" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>given a geometry and an attribute, the geometry is coloured according to</span>
<span id="cb18-249"><a href="#cb18-249" aria-hidden="true" tabindex="-1"></a>  the values of the attribute, using a qualitative colour scale for <span class="in">`factor`</span></span>
<span id="cb18-250"><a href="#cb18-250" aria-hidden="true" tabindex="-1"></a>  or <span class="in">`logical`</span> attributes and a continuous scale otherwise, and a colour key</span>
<span id="cb18-251"><a href="#cb18-251" aria-hidden="true" tabindex="-1"></a>  is added</span>
<span id="cb18-252"><a href="#cb18-252" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>given multiple attributes, multiple maps are plotted, each with a colour</span>
<span id="cb18-253"><a href="#cb18-253" aria-hidden="true" tabindex="-1"></a>  scale but a key is by default omitted, as colour assignment is</span>
<span id="cb18-254"><a href="#cb18-254" aria-hidden="true" tabindex="-1"></a>  done on a per sub-map basis</span>
<span id="cb18-255"><a href="#cb18-255" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>for <span class="in">`stars`</span> objects with multiple attributes, only the first</span>
<span id="cb18-256"><a href="#cb18-256" aria-hidden="true" tabindex="-1"></a>  attribute is plotted; for three-dimensional raster cubes, all</span>
<span id="cb18-257"><a href="#cb18-257" aria-hidden="true" tabindex="-1"></a>  slices over the third dimension are plotted as sub-plots</span>
<span id="cb18-258"><a href="#cb18-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-259"><a href="#cb18-259" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adding to plots with legends</span></span>
<span id="cb18-260"><a href="#cb18-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-261"><a href="#cb18-261" aria-hidden="true" tabindex="-1"></a>\index{sf!plot!legend}</span>
<span id="cb18-262"><a href="#cb18-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-263"><a href="#cb18-263" aria-hidden="true" tabindex="-1"></a>The <span class="in">`plot`</span> methods for <span class="in">`stars`</span> and <span class="in">`sf`</span> objects may show a colour key</span>
<span id="cb18-264"><a href="#cb18-264" aria-hidden="true" tabindex="-1"></a>on one of the sides (@fig-first-map). To do this</span>
<span id="cb18-265"><a href="#cb18-265" aria-hidden="true" tabindex="-1"></a>with <span class="in">`base::plot`</span>, the plot region is split in two and two plots are</span>
<span id="cb18-266"><a href="#cb18-266" aria-hidden="true" tabindex="-1"></a>created: one with the map, and one with the legend.  By default, the</span>
<span id="cb18-267"><a href="#cb18-267" aria-hidden="true" tabindex="-1"></a><span class="in">`plot`</span> function resets the graphics device (using <span class="in">`layout(matrix(1))`</span></span>
<span id="cb18-268"><a href="#cb18-268" aria-hidden="true" tabindex="-1"></a>so that subsequent plots are not hindered by the device being split</span>
<span id="cb18-269"><a href="#cb18-269" aria-hidden="true" tabindex="-1"></a>in two, but this prevents adding graphic elements subsequently.</span>
<span id="cb18-270"><a href="#cb18-270" aria-hidden="true" tabindex="-1"></a>To _add_ to an existing plot with a colour legend, the device reset</span>
<span id="cb18-271"><a href="#cb18-271" aria-hidden="true" tabindex="-1"></a>needs to be prevented by using <span class="in">`reset = FALSE`</span> in the <span class="in">`plot`</span></span>
<span id="cb18-272"><a href="#cb18-272" aria-hidden="true" tabindex="-1"></a>command, and using <span class="in">`add = TRUE`</span> in subsequent calls to <span class="in">`plot`</span>.</span>
<span id="cb18-273"><a href="#cb18-273" aria-hidden="true" tabindex="-1"></a>An example is</span>
<span id="cb18-274"><a href="#cb18-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-275"><a href="#cb18-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-figreset}</span></span>
<span id="cb18-276"><a href="#cb18-276" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Annotating base plots with a legend"</span></span>
<span id="cb18-277"><a href="#cb18-277" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb18-278"><a href="#cb18-278" aria-hidden="true" tabindex="-1"></a><span class="in">nc &lt;- read_sf(system.file("gpkg/nc.gpkg", package = "sf"))</span></span>
<span id="cb18-279"><a href="#cb18-279" aria-hidden="true" tabindex="-1"></a><span class="in">plot(nc["BIR74"], reset = FALSE, key.pos = 4)</span></span>
<span id="cb18-280"><a href="#cb18-280" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_buffer(nc[1,1], units::set_units(10, km)), col = 'NA', </span></span>
<span id="cb18-281"><a href="#cb18-281" aria-hidden="true" tabindex="-1"></a><span class="in">     border = 'red', lwd = 2, add = TRUE)</span></span>
<span id="cb18-282"><a href="#cb18-282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-283"><a href="#cb18-283" aria-hidden="true" tabindex="-1"></a>which is shown in @fig-figreset. Annotating <span class="in">`stars`</span></span>
<span id="cb18-284"><a href="#cb18-284" aria-hidden="true" tabindex="-1"></a>plots can be done in the same way when a _single_ stars layer is</span>
<span id="cb18-285"><a href="#cb18-285" aria-hidden="true" tabindex="-1"></a>shown. Annotating <span class="in">`stars`</span> facet plots with multiple cube slices can be</span>
<span id="cb18-286"><a href="#cb18-286" aria-hidden="true" tabindex="-1"></a>done by adding a "hook" function that will be called on every slice</span>
<span id="cb18-287"><a href="#cb18-287" aria-hidden="true" tabindex="-1"></a>shown, as in</span>
<span id="cb18-288"><a href="#cb18-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-starshook}</span></span>
<span id="cb18-289"><a href="#cb18-289" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Annotated multi-slice stars plot"</span></span>
<span id="cb18-290"><a href="#cb18-290" aria-hidden="true" tabindex="-1"></a><span class="in">library(stars)</span></span>
<span id="cb18-291"><a href="#cb18-291" aria-hidden="true" tabindex="-1"></a><span class="in">system.file("tif/L7_ETMs.tif", package = "stars") |&gt;</span></span>
<span id="cb18-292"><a href="#cb18-292" aria-hidden="true" tabindex="-1"></a><span class="in">    read_stars() -&gt; r</span></span>
<span id="cb18-293"><a href="#cb18-293" aria-hidden="true" tabindex="-1"></a><span class="in">st_bbox(r) |&gt; st_as_sfc() |&gt; st_sample(5) |&gt; </span></span>
<span id="cb18-294"><a href="#cb18-294" aria-hidden="true" tabindex="-1"></a><span class="in">    st_buffer(300) -&gt; circ</span></span>
<span id="cb18-295"><a href="#cb18-295" aria-hidden="true" tabindex="-1"></a><span class="in">hook &lt;- function() { </span></span>
<span id="cb18-296"><a href="#cb18-296" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(circ, col = NA, border = 'yellow', add = TRUE)</span></span>
<span id="cb18-297"><a href="#cb18-297" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb18-298"><a href="#cb18-298" aria-hidden="true" tabindex="-1"></a><span class="in">plot(r, hook = hook, key.pos = 4)</span></span>
<span id="cb18-299"><a href="#cb18-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-300"><a href="#cb18-300" aria-hidden="true" tabindex="-1"></a>and as shown in @fig-starshook. Hook functions have access to facet</span>
<span id="cb18-301"><a href="#cb18-301" aria-hidden="true" tabindex="-1"></a>parameters, facet label and bounding box.</span>
<span id="cb18-302"><a href="#cb18-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-303"><a href="#cb18-303" aria-hidden="true" tabindex="-1"></a>Base plot methods have access to the resolution of the screen device,</span>
<span id="cb18-304"><a href="#cb18-304" aria-hidden="true" tabindex="-1"></a>and hence the base plot method for <span class="in">`stars`</span> and <span class="in">`stars_proxy`</span> object</span>
<span id="cb18-305"><a href="#cb18-305" aria-hidden="true" tabindex="-1"></a>will downsample dense rasters and only plot pixels at a density</span>
<span id="cb18-306"><a href="#cb18-306" aria-hidden="true" tabindex="-1"></a>that makes sense for the device available.</span>
<span id="cb18-307"><a href="#cb18-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-308"><a href="#cb18-308" aria-hidden="true" tabindex="-1"></a><span class="fu">### Projections in base plots</span></span>
<span id="cb18-309"><a href="#cb18-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-310"><a href="#cb18-310" aria-hidden="true" tabindex="-1"></a>The base <span class="in">`plot`</span> method plots data with ellipsoidal coordinates</span>
<span id="cb18-311"><a href="#cb18-311" aria-hidden="true" tabindex="-1"></a>using the equirectangular projection, using a latitude parameter</span>
<span id="cb18-312"><a href="#cb18-312" aria-hidden="true" tabindex="-1"></a>equal to the middle latitude of the data bounding box</span>
<span id="cb18-313"><a href="#cb18-313" aria-hidden="true" tabindex="-1"></a>(@fig-eqc). To control this parameter, either a projection to</span>
<span id="cb18-314"><a href="#cb18-314" aria-hidden="true" tabindex="-1"></a>another equirectangular can be applied before plotting, or the</span>
<span id="cb18-315"><a href="#cb18-315" aria-hidden="true" tabindex="-1"></a>parameter <span class="in">`asp`</span> can be set to override: <span class="in">`asp=1`</span> would lead to</span>
<span id="cb18-316"><a href="#cb18-316" aria-hidden="true" tabindex="-1"></a>plate carrée (@fig-world) left. Subsequent plots need to be in</span>
<span id="cb18-317"><a href="#cb18-317" aria-hidden="true" tabindex="-1"></a>the same coordinate reference system in order to make sense with</span>
<span id="cb18-318"><a href="#cb18-318" aria-hidden="true" tabindex="-1"></a>over-plotting; this is not being checked.</span>
<span id="cb18-319"><a href="#cb18-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-320"><a href="#cb18-320" aria-hidden="true" tabindex="-1"></a><span class="fu">### Colours and colour breaks</span></span>
<span id="cb18-321"><a href="#cb18-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-322"><a href="#cb18-322" aria-hidden="true" tabindex="-1"></a>In base plots, argument <span class="in">`nbreaks`</span> can be used to set the number of</span>
<span id="cb18-323"><a href="#cb18-323" aria-hidden="true" tabindex="-1"></a>colour breaks and argument <span class="in">`breaks`</span> either to the numeric vector</span>
<span id="cb18-324"><a href="#cb18-324" aria-hidden="true" tabindex="-1"></a>with actual breaks, or to a style value for the <span class="in">`style`</span> argument in</span>
<span id="cb18-325"><a href="#cb18-325" aria-hidden="true" tabindex="-1"></a><span class="in">`classInt::classIntervals`</span>.</span>
<span id="cb18-326"><a href="#cb18-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-327"><a href="#cb18-327" aria-hidden="true" tabindex="-1"></a><span class="fu">## Maps with `ggplot2` {#sec-geomsf}</span></span>
<span id="cb18-328"><a href="#cb18-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-329"><a href="#cb18-329" aria-hidden="true" tabindex="-1"></a>\index{ggplot2}</span>
<span id="cb18-330"><a href="#cb18-330" aria-hidden="true" tabindex="-1"></a>\index{geom<span class="sc">\_</span>sf}</span>
<span id="cb18-331"><a href="#cb18-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-332"><a href="#cb18-332" aria-hidden="true" tabindex="-1"></a>Package **ggplot2** <span class="co">[</span><span class="ot">@R-ggplot2; @ggplot2</span><span class="co">]</span> can create</span>
<span id="cb18-333"><a href="#cb18-333" aria-hidden="true" tabindex="-1"></a>more complex and nicer looking graphs; it has a geometry <span class="in">`geom_sf`</span></span>
<span id="cb18-334"><a href="#cb18-334" aria-hidden="true" tabindex="-1"></a>that was developed in conjunction with the development of <span class="in">`sf`</span> and</span>
<span id="cb18-335"><a href="#cb18-335" aria-hidden="true" tabindex="-1"></a>helps creating beautiful maps. An introduction to this is found in</span>
<span id="cb18-336"><a href="#cb18-336" aria-hidden="true" tabindex="-1"></a>@moreno. A first example is shown in @fig-firstgather.</span>
<span id="cb18-337"><a href="#cb18-337" aria-hidden="true" tabindex="-1"></a>The code used for this plot is:</span>
<span id="cb18-340"><a href="#cb18-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-341"><a href="#cb18-341" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="sc">|&gt;</span> <span class="fu">suppressPackageStartupMessages</span>()</span>
<span id="cb18-342"><a href="#cb18-342" aria-hidden="true" tabindex="-1"></a>nc<span class="fl">.32119</span> <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(nc, <span class="dv">32119</span>) </span>
<span id="cb18-343"><a href="#cb18-343" aria-hidden="true" tabindex="-1"></a>year_labels <span class="ot">&lt;-</span> </span>
<span id="cb18-344"><a href="#cb18-344" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"SID74"</span> <span class="ot">=</span> <span class="st">"1974 - 1978"</span>, <span class="st">"SID79"</span> <span class="ot">=</span> <span class="st">"1979 - 1984"</span>)</span>
<span id="cb18-345"><a href="#cb18-345" aria-hidden="true" tabindex="-1"></a>nc<span class="fl">.32119</span> <span class="sc">|&gt;</span> <span class="fu">select</span>(SID74, SID79) <span class="sc">|&gt;</span> </span>
<span id="cb18-346"><a href="#cb18-346" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"SID"</span>)) <span class="ot">-&gt;</span> nc_longer</span>
<span id="cb18-347"><a href="#cb18-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-348"><a href="#cb18-348" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = FALSE}</span></span>
<span id="cb18-349"><a href="#cb18-349" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() + geom_sf(data = nc_longer, aes(fill = value), linewidth = 0.4) + </span></span>
<span id="cb18-350"><a href="#cb18-350" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~ name, ncol = 1, </span></span>
<span id="cb18-351"><a href="#cb18-351" aria-hidden="true" tabindex="-1"></a><span class="in">             labeller = labeller(name = year_labels)) +</span></span>
<span id="cb18-352"><a href="#cb18-352" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(breaks = 34:36) +</span></span>
<span id="cb18-353"><a href="#cb18-353" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_gradientn(colours = sf.colors(20)) +</span></span>
<span id="cb18-354"><a href="#cb18-354" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major = element_line(colour = "white"))</span></span>
<span id="cb18-355"><a href="#cb18-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-356"><a href="#cb18-356" aria-hidden="true" tabindex="-1"></a>where we see that two attributes had to be stacked (<span class="in">`pivot_longer`</span>)</span>
<span id="cb18-357"><a href="#cb18-357" aria-hidden="true" tabindex="-1"></a>before plotting them as facets: this is the idea behind "tidy" data,</span>
<span id="cb18-358"><a href="#cb18-358" aria-hidden="true" tabindex="-1"></a>and the <span class="in">`pivot_longer`</span> method for <span class="in">`sf`</span> objects automatically stacks</span>
<span id="cb18-359"><a href="#cb18-359" aria-hidden="true" tabindex="-1"></a>the geometry column too.</span>
<span id="cb18-360"><a href="#cb18-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-361"><a href="#cb18-361" aria-hidden="true" tabindex="-1"></a>Because <span class="in">`ggplot2`</span> creates graphics _objects_ before plotting them,</span>
<span id="cb18-362"><a href="#cb18-362" aria-hidden="true" tabindex="-1"></a>it can control the coordinate reference system of all elements</span>
<span id="cb18-363"><a href="#cb18-363" aria-hidden="true" tabindex="-1"></a>involved, and will transform or convert all subsequent objects to</span>
<span id="cb18-364"><a href="#cb18-364" aria-hidden="true" tabindex="-1"></a>the coordinate reference system of the first. It will also draw a</span>
<span id="cb18-365"><a href="#cb18-365" aria-hidden="true" tabindex="-1"></a>graticule for the (default) thin white lines on a grey background,</span>
<span id="cb18-366"><a href="#cb18-366" aria-hidden="true" tabindex="-1"></a>and uses a datum (by default: WGS84) for this. <span class="in">`geom_sf`</span> can be</span>
<span id="cb18-367"><a href="#cb18-367" aria-hidden="true" tabindex="-1"></a>combined with other geoms, for instance to allow for annotating</span>
<span id="cb18-368"><a href="#cb18-368" aria-hidden="true" tabindex="-1"></a>plots.</span>
<span id="cb18-369"><a href="#cb18-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-370"><a href="#cb18-370" aria-hidden="true" tabindex="-1"></a>\index{geom<span class="sc">\_</span>stars}</span>
<span id="cb18-371"><a href="#cb18-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-372"><a href="#cb18-372" aria-hidden="true" tabindex="-1"></a>For package **stars**, a <span class="in">`geom_stars`</span> has, at the moment of writing</span>
<span id="cb18-373"><a href="#cb18-373" aria-hidden="true" tabindex="-1"></a>this, rather limited scope: it uses <span class="in">`geom_sf`</span> for map layout and vector data</span>
<span id="cb18-374"><a href="#cb18-374" aria-hidden="true" tabindex="-1"></a>cubes, and adds <span class="in">`geom_raster`</span> for regular rasters and <span class="in">`geom_rect`</span></span>
<span id="cb18-375"><a href="#cb18-375" aria-hidden="true" tabindex="-1"></a>for rectilinear rasters. It downsamples if the user specifies a</span>
<span id="cb18-376"><a href="#cb18-376" aria-hidden="true" tabindex="-1"></a>downsampling rate, but has no access to the screen dimensions to</span>
<span id="cb18-377"><a href="#cb18-377" aria-hidden="true" tabindex="-1"></a>automatically choose a downsampling rate. This may be just enough, </span>
<span id="cb18-378"><a href="#cb18-378" aria-hidden="true" tabindex="-1"></a>for instance @fig-ggplotstars is created by the following commands:</span>
<span id="cb18-379"><a href="#cb18-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-ggplotstars}</span></span>
<span id="cb18-380"><a href="#cb18-380" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Simple facet raster plot with `ggplot2` and `geom_stars`"</span></span>
<span id="cb18-381"><a href="#cb18-381" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb18-382"><a href="#cb18-382" aria-hidden="true" tabindex="-1"></a><span class="in">library(stars)</span></span>
<span id="cb18-383"><a href="#cb18-383" aria-hidden="true" tabindex="-1"></a><span class="in">r &lt;- read_stars(system.file("tif/L7_ETMs.tif", package = "stars"))</span></span>
<span id="cb18-384"><a href="#cb18-384" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() + geom_stars(data = r) +</span></span>
<span id="cb18-385"><a href="#cb18-385" aria-hidden="true" tabindex="-1"></a><span class="in">        facet_wrap(~band) + coord_equal() +</span></span>
<span id="cb18-386"><a href="#cb18-386" aria-hidden="true" tabindex="-1"></a><span class="in">        theme_void() +</span></span>
<span id="cb18-387"><a href="#cb18-387" aria-hidden="true" tabindex="-1"></a><span class="in">        scale_x_discrete(expand = c(0,0)) + </span></span>
<span id="cb18-388"><a href="#cb18-388" aria-hidden="true" tabindex="-1"></a><span class="in">        scale_y_discrete(expand = c(0,0)) +</span></span>
<span id="cb18-389"><a href="#cb18-389" aria-hidden="true" tabindex="-1"></a><span class="in">        scale_fill_viridis_c()</span></span>
<span id="cb18-390"><a href="#cb18-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-391"><a href="#cb18-391" aria-hidden="true" tabindex="-1"></a>More elaborate <span class="in">`ggplot2`</span>-based plots with <span class="in">`stars`</span> objects may be</span>
<span id="cb18-392"><a href="#cb18-392" aria-hidden="true" tabindex="-1"></a>obtained using package **ggspatial** <span class="co">[</span><span class="ot">@R-ggspatial</span><span class="co">]</span>. Non-compatible</span>
<span id="cb18-393"><a href="#cb18-393" aria-hidden="true" tabindex="-1"></a>but nevertheless <span class="in">`ggplot2`</span>-style plots can be created with <span class="in">`tmap`</span>,</span>
<span id="cb18-394"><a href="#cb18-394" aria-hidden="true" tabindex="-1"></a>a package dedicated to creating high quality maps (@sec-tmap).</span>
<span id="cb18-395"><a href="#cb18-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-396"><a href="#cb18-396" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{coord<span class="sc">\_</span>sf}</span>
<span id="cb18-397"><a href="#cb18-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-398"><a href="#cb18-398" aria-hidden="true" tabindex="-1"></a>When combining several feature sets with varying coordinate reference</span>
<span id="cb18-399"><a href="#cb18-399" aria-hidden="true" tabindex="-1"></a>systems, using <span class="in">`geom_sf`</span>, all sets are transformed to the reference</span>
<span id="cb18-400"><a href="#cb18-400" aria-hidden="true" tabindex="-1"></a>system of the first set. To further control the "base"</span>
<span id="cb18-401"><a href="#cb18-401" aria-hidden="true" tabindex="-1"></a>coordinate reference system, <span class="in">`coord_sf`</span> can be used. This allows</span>
<span id="cb18-402"><a href="#cb18-402" aria-hidden="true" tabindex="-1"></a>for instance working in a projected system, while combining graphics</span>
<span id="cb18-403"><a href="#cb18-403" aria-hidden="true" tabindex="-1"></a>elements that are _not_ <span class="in">`sf`</span> objects but regular <span class="in">`data.frame`</span>s</span>
<span id="cb18-404"><a href="#cb18-404" aria-hidden="true" tabindex="-1"></a>with ellipsoidal coordinates associated to WGS84. </span>
<span id="cb18-405"><a href="#cb18-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-406"><a href="#cb18-406" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-format="html"}</span>
<span id="cb18-407"><a href="#cb18-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-408"><a href="#cb18-408" aria-hidden="true" tabindex="-1"></a>A twitter thread by Claus Wilke illustrating this is found</span>
<span id="cb18-409"><a href="#cb18-409" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">here</span><span class="co">](https://twitter.com/ClausWilke/status/1275938314055561216)</span>.</span>
<span id="cb18-410"><a href="#cb18-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-411"><a href="#cb18-411" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb18-412"><a href="#cb18-412" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!---</span></span>
<span id="cb18-413"><a href="#cb18-413" aria-hidden="true" tabindex="-1"></a><span class="al">FIXME</span><span class="co">: markup visible in PDF and HTML rendering</span></span>
<span id="cb18-414"><a href="#cb18-414" aria-hidden="true" tabindex="-1"></a><span class="co">---&gt;</span></span>
<span id="cb18-415"><a href="#cb18-415" aria-hidden="true" tabindex="-1"></a><span class="fu">## Maps with `tmap` {#sec-tmap}</span></span>
<span id="cb18-416"><a href="#cb18-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-417"><a href="#cb18-417" aria-hidden="true" tabindex="-1"></a>\index{tmap}</span>
<span id="cb18-418"><a href="#cb18-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-419"><a href="#cb18-419" aria-hidden="true" tabindex="-1"></a>Package **tmap** <span class="co">[</span><span class="ot">@R-tmap; @tmap</span><span class="co">]</span> takes a fresh look at plotting</span>
<span id="cb18-420"><a href="#cb18-420" aria-hidden="true" tabindex="-1"></a>spatial data in R. It resembles <span class="in">`ggplot2`</span> in the sense that it</span>
<span id="cb18-421"><a href="#cb18-421" aria-hidden="true" tabindex="-1"></a>composes graphics objects before printing by building on the <span class="in">`grid`</span></span>
<span id="cb18-422"><a href="#cb18-422" aria-hidden="true" tabindex="-1"></a>package, and by concatenating map elements with a <span class="in">`+`</span> between them,</span>
<span id="cb18-423"><a href="#cb18-423" aria-hidden="true" tabindex="-1"></a>but otherwise it is entirely independent from, and incompatible</span>
<span id="cb18-424"><a href="#cb18-424" aria-hidden="true" tabindex="-1"></a>with, <span class="in">`ggplot2`</span>. It has a number of options that allow for highly</span>
<span id="cb18-425"><a href="#cb18-425" aria-hidden="true" tabindex="-1"></a>professional looking maps, and many defaults have been carefully</span>
<span id="cb18-426"><a href="#cb18-426" aria-hidden="true" tabindex="-1"></a>chosen.  Creating a map with two similar attributes can be done</span>
<span id="cb18-427"><a href="#cb18-427" aria-hidden="true" tabindex="-1"></a>using <span class="in">`tm_polygons`</span> with two attributes, we can use </span>
<span id="cb18-428"><a href="#cb18-428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, eval=FALSE}</span></span>
<span id="cb18-429"><a href="#cb18-429" aria-hidden="true" tabindex="-1"></a><span class="in">library(tmap)</span></span>
<span id="cb18-430"><a href="#cb18-430" aria-hidden="true" tabindex="-1"></a><span class="in">system.file("gpkg/nc.gpkg", package = "sf") |&gt;</span></span>
<span id="cb18-431"><a href="#cb18-431" aria-hidden="true" tabindex="-1"></a><span class="in">    read_sf() |&gt; st_transform('EPSG:32119') -&gt; nc.32119</span></span>
<span id="cb18-432"><a href="#cb18-432" aria-hidden="true" tabindex="-1"></a><span class="in">tm_shape(nc.32119) + </span></span>
<span id="cb18-433"><a href="#cb18-433" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_polygons(c("SID74", "SID79"), title = "SIDS") +</span></span>
<span id="cb18-434"><a href="#cb18-434" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_layout(legend.outside = TRUE, </span></span>
<span id="cb18-435"><a href="#cb18-435" aria-hidden="true" tabindex="-1"></a><span class="in">              panel.labels = c("1974-78", "1979-84")) +</span></span>
<span id="cb18-436"><a href="#cb18-436" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_facets(free.scales=FALSE)</span></span>
<span id="cb18-437"><a href="#cb18-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-438"><a href="#cb18-438" aria-hidden="true" tabindex="-1"></a>to create @fig-tmapnc:</span>
<span id="cb18-439"><a href="#cb18-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-440"><a href="#cb18-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-tmapnc, echo =!knitr::is_latex_output()}</span></span>
<span id="cb18-441"><a href="#cb18-441" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "**tmap**: using `tm_polygons()` with two attribute names"</span></span>
<span id="cb18-442"><a href="#cb18-442" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb18-443"><a href="#cb18-443" aria-hidden="true" tabindex="-1"></a><span class="in">library(tmap)</span></span>
<span id="cb18-444"><a href="#cb18-444" aria-hidden="true" tabindex="-1"></a><span class="in">system.file("gpkg/nc.gpkg", package = "sf") |&gt;</span></span>
<span id="cb18-445"><a href="#cb18-445" aria-hidden="true" tabindex="-1"></a><span class="in">    read_sf() |&gt;</span></span>
<span id="cb18-446"><a href="#cb18-446" aria-hidden="true" tabindex="-1"></a><span class="in">    st_transform('EPSG:32119') -&gt; nc.32119</span></span>
<span id="cb18-447"><a href="#cb18-447" aria-hidden="true" tabindex="-1"></a><span class="in">tm_shape(nc.32119) + tm_polygons(c("SID74", "SID79"), title="SIDS") + </span></span>
<span id="cb18-448"><a href="#cb18-448" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_layout(legend.outside=TRUE, panel.labels=c("1974-78", "1979-84")) + </span></span>
<span id="cb18-449"><a href="#cb18-449" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_facets(free.scales=FALSE)</span></span>
<span id="cb18-450"><a href="#cb18-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-451"><a href="#cb18-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-452"><a href="#cb18-452" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!---</span></span>
<span id="cb18-453"><a href="#cb18-453" aria-hidden="true" tabindex="-1"></a><span class="co">```{r eval=FALSE}</span></span>
<span id="cb18-454"><a href="#cb18-454" aria-hidden="true" tabindex="-1"></a><span class="co">nc_longer &lt;- nc.32119 |&gt; select(SID74, SID79) |&gt; </span></span>
<span id="cb18-455"><a href="#cb18-455" aria-hidden="true" tabindex="-1"></a><span class="co">    pivot_longer(starts_with("SID"), values_to = "SID")</span></span>
<span id="cb18-456"><a href="#cb18-456" aria-hidden="true" tabindex="-1"></a><span class="co">tm_shape(nc_longer) + tm_polygons("SID") + </span></span>
<span id="cb18-457"><a href="#cb18-457" aria-hidden="true" tabindex="-1"></a><span class="co">    tm_facets(by = "name")</span></span>
<span id="cb18-458"><a href="#cb18-458" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb18-459"><a href="#cb18-459" aria-hidden="true" tabindex="-1"></a><span class="co">```{r fig-tmapnc2, echo = FALSE}</span></span>
<span id="cb18-460"><a href="#cb18-460" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "**tmap**: Using `tm_facets()` on a long table"</span></span>
<span id="cb18-461"><a href="#cb18-461" aria-hidden="true" tabindex="-1"></a><span class="co">nc.32119 |&gt; select(SID74, SID79) |&gt; </span></span>
<span id="cb18-462"><a href="#cb18-462" aria-hidden="true" tabindex="-1"></a><span class="co">    pivot_longer(starts_with("SID"), values_to = "SID") -&gt; nc_longer</span></span>
<span id="cb18-463"><a href="#cb18-463" aria-hidden="true" tabindex="-1"></a><span class="co">tm_shape(nc_longer) + tm_polygons("SID") + tm_facets(by = "name")</span></span>
<span id="cb18-464"><a href="#cb18-464" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb18-465"><a href="#cb18-465" aria-hidden="true" tabindex="-1"></a><span class="co">to create @fig-tmapnc2.</span></span>
<span id="cb18-466"><a href="#cb18-466" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb18-467"><a href="#cb18-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-468"><a href="#cb18-468" aria-hidden="true" tabindex="-1"></a>Alternatively, from the long table form obtained by <span class="in">`pivot_longer`</span></span>
<span id="cb18-469"><a href="#cb18-469" aria-hidden="true" tabindex="-1"></a>one could use <span class="in">`+ tm_polygons("SID") + tm_facets(by = "name")`</span>.</span>
<span id="cb18-470"><a href="#cb18-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-471"><a href="#cb18-471" aria-hidden="true" tabindex="-1"></a>Package **tmap** also has support for <span class="in">`stars`</span> objects, an example created with</span>
<span id="cb18-472"><a href="#cb18-472" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb18-473"><a href="#cb18-473" aria-hidden="true" tabindex="-1"></a><span class="in">tm_shape(r) + tm_raster()</span></span>
<span id="cb18-474"><a href="#cb18-474" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-475"><a href="#cb18-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-476"><a href="#cb18-476" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-tmapstars, echo = FALSE}</span></span>
<span id="cb18-477"><a href="#cb18-477" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Simple raster plot with tmap"</span></span>
<span id="cb18-478"><a href="#cb18-478" aria-hidden="true" tabindex="-1"></a><span class="in">tm_shape(r) + tm_raster()</span></span>
<span id="cb18-479"><a href="#cb18-479" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-480"><a href="#cb18-480" aria-hidden="true" tabindex="-1"></a>is shown in @fig-tmapstars. More examples of the use of **tmap**</span>
<span id="cb18-481"><a href="#cb18-481" aria-hidden="true" tabindex="-1"></a>are given in Chapters <span class="co">[</span><span class="ot">-@sec-area</span><span class="co">]</span>-<span class="co">[</span><span class="ot">-@sec-spatglmm</span><span class="co">]</span>.</span>
<span id="cb18-482"><a href="#cb18-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-483"><a href="#cb18-483" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interactive maps: `leaflet`, `mapview`, `tmap`</span></span>
<span id="cb18-484"><a href="#cb18-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-485"><a href="#cb18-485" aria-hidden="true" tabindex="-1"></a>\index{leaflet}</span>
<span id="cb18-486"><a href="#cb18-486" aria-hidden="true" tabindex="-1"></a>\index{leaflet!tmap}</span>
<span id="cb18-487"><a href="#cb18-487" aria-hidden="true" tabindex="-1"></a>\index{leaflet!mapview}</span>
<span id="cb18-488"><a href="#cb18-488" aria-hidden="true" tabindex="-1"></a>\index{mapview}</span>
<span id="cb18-489"><a href="#cb18-489" aria-hidden="true" tabindex="-1"></a>\index{tmap!interactive views}</span>
<span id="cb18-490"><a href="#cb18-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-491"><a href="#cb18-491" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-format="html"}</span>
<span id="cb18-492"><a href="#cb18-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-493"><a href="#cb18-493" aria-hidden="true" tabindex="-1"></a>Interactive maps as shown in @fig-mapviewfigure  can be</span>
<span id="cb18-494"><a href="#cb18-494" aria-hidden="true" tabindex="-1"></a>created with R packages **leaflet**, **mapview**, or **tmap**. Package **mapview**</span>
<span id="cb18-495"><a href="#cb18-495" aria-hidden="true" tabindex="-1"></a>adds a number of capabilities to **leaflet** including a map legend,</span>
<span id="cb18-496"><a href="#cb18-496" aria-hidden="true" tabindex="-1"></a>configurable pop-up windows when clicking features, support for</span>
<span id="cb18-497"><a href="#cb18-497" aria-hidden="true" tabindex="-1"></a>raster data, and scalable maps with very large feature sets using</span>
<span id="cb18-498"><a href="#cb18-498" aria-hidden="true" tabindex="-1"></a>the FlatGeobuf file format, as well as facet maps that react</span>
<span id="cb18-499"><a href="#cb18-499" aria-hidden="true" tabindex="-1"></a>synchronously to zoom and pan actions.  Package **tmap** has the</span>
<span id="cb18-500"><a href="#cb18-500" aria-hidden="true" tabindex="-1"></a>option that after giving</span>
<span id="cb18-501"><a href="#cb18-501" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb18-502"><a href="#cb18-502" aria-hidden="true" tabindex="-1"></a><span class="in">tmap_mode("view")</span></span>
<span id="cb18-503"><a href="#cb18-503" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-504"><a href="#cb18-504" aria-hidden="true" tabindex="-1"></a>all usual <span class="in">`tmap`</span> commands are applied to an interactive html/leaflet widget, </span>
<span id="cb18-505"><a href="#cb18-505" aria-hidden="true" tabindex="-1"></a>whereas after</span>
<span id="cb18-506"><a href="#cb18-506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb18-507"><a href="#cb18-507" aria-hidden="true" tabindex="-1"></a><span class="in">tmap_mode("plot")</span></span>
<span id="cb18-508"><a href="#cb18-508" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-509"><a href="#cb18-509" aria-hidden="true" tabindex="-1"></a>again all output is sent to R's own (static) graphics device.</span>
<span id="cb18-510"><a href="#cb18-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-511"><a href="#cb18-511" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb18-512"><a href="#cb18-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-513"><a href="#cb18-513" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-format="pdf"}</span>
<span id="cb18-514"><a href="#cb18-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-515"><a href="#cb18-515" aria-hidden="true" tabindex="-1"></a>Interactive maps as shown in @fig-mapviewfigurepdf can be</span>
<span id="cb18-516"><a href="#cb18-516" aria-hidden="true" tabindex="-1"></a>created with R packages **leaflet**, **mapview** or **tmap**. **mapview**</span>
<span id="cb18-517"><a href="#cb18-517" aria-hidden="true" tabindex="-1"></a>adds a number of capabilities to **leaflet** including a map legend,</span>
<span id="cb18-518"><a href="#cb18-518" aria-hidden="true" tabindex="-1"></a>configurable pop-up windows when clicking features, support for</span>
<span id="cb18-519"><a href="#cb18-519" aria-hidden="true" tabindex="-1"></a>raster data, and scalable maps with very large feature sets using</span>
<span id="cb18-520"><a href="#cb18-520" aria-hidden="true" tabindex="-1"></a>the FlatGeobuf file format, as well as facet maps that react</span>
<span id="cb18-521"><a href="#cb18-521" aria-hidden="true" tabindex="-1"></a>synchronously to zoom and pan actions.  Package **tmap** has the</span>
<span id="cb18-522"><a href="#cb18-522" aria-hidden="true" tabindex="-1"></a>option that after giving</span>
<span id="cb18-523"><a href="#cb18-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb18-524"><a href="#cb18-524" aria-hidden="true" tabindex="-1"></a><span class="in">tmap_mode("view")</span></span>
<span id="cb18-525"><a href="#cb18-525" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-526"><a href="#cb18-526" aria-hidden="true" tabindex="-1"></a>all usual <span class="in">`tmap`</span> commands are applied to an interactive html/leaflet widget, </span>
<span id="cb18-527"><a href="#cb18-527" aria-hidden="true" tabindex="-1"></a>whereas after</span>
<span id="cb18-528"><a href="#cb18-528" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb18-529"><a href="#cb18-529" aria-hidden="true" tabindex="-1"></a><span class="in">tmap_mode("plot")</span></span>
<span id="cb18-530"><a href="#cb18-530" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-531"><a href="#cb18-531" aria-hidden="true" tabindex="-1"></a>again all output is sent to R's own (static) graphics device.</span>
<span id="cb18-532"><a href="#cb18-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-533"><a href="#cb18-533" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb18-534"><a href="#cb18-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-535"><a href="#cb18-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-536"><a href="#cb18-536" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb18-537"><a href="#cb18-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-538"><a href="#cb18-538" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>For the countries Indonesia and Canada, create individual plots using</span>
<span id="cb18-539"><a href="#cb18-539" aria-hidden="true" tabindex="-1"></a>equirectangular, orthographic, and Lambert equal area projections, while</span>
<span id="cb18-540"><a href="#cb18-540" aria-hidden="true" tabindex="-1"></a>choosing projection parameters sensible for the area.</span>
<span id="cb18-541"><a href="#cb18-541" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Recreate the plot in @fig-figreset with **ggplot2** and with **tmap**.</span>
<span id="cb18-542"><a href="#cb18-542" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Recreate the plot in @fig-tmapstars  using the <span class="in">`viridis`</span> colour ramp.</span>
<span id="cb18-543"><a href="#cb18-543" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>View the interactive plot in @fig-tmapstars  using the "view"</span>
<span id="cb18-544"><a href="#cb18-544" aria-hidden="true" tabindex="-1"></a>(interactive) mode of <span class="in">`tmap`</span>, and explore which interactions are possible; also</span>
<span id="cb18-545"><a href="#cb18-545" aria-hidden="true" tabindex="-1"></a>explore adding <span class="in">`+ tm_facets(as.layers=TRUE)`</span> and try switching layers on and off.</span>
<span id="cb18-546"><a href="#cb18-546" aria-hidden="true" tabindex="-1"></a>Try also setting a transparency value to 0.5.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/08-Plotting.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>