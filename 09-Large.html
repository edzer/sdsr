<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Spatial Data Science - 9&nbsp; Large data and cloud native</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./part-3.html" rel="next">
<link href="./08-Plotting.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-04YTZNEH1K"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
 
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'analytics_storage': 'denied'
  });
gtag('config', 'G-04YTZNEH1K', { 'anonymize_ip': true});
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-2.html">R for Spatial Data Science</a></li><li class="breadcrumb-item"><a href="./09-Large.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/edzer/sdsr/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-hello.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting Started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-Spaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Coordinates</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-Geometries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Spherical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spherical Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-Attributes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Attributes and Support</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-Cubes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R for Spatial Data Science</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-Introsf.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-Plotting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-Large.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Models for Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Statistical modelling of spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-PointPattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Point Pattern Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-Interpolation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-Geostatistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-Areal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-Measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of Spatial Autocorrelation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-SpatialRegression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-Econometrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Spatial Econometrics Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sp-raster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Older R Spatial Packages</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rbasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">R Basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ERRATA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Errata to the printed ed.</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#sec-largesf" id="toc-sec-largesf" class="nav-link active" data-scroll-target="#sec-largesf"><span class="header-section-number">9.1</span> Vector data: <code>sf</code></a>
  <ul class="collapse">
<li><a href="#reading-from-local-disk" id="toc-reading-from-local-disk" class="nav-link" data-scroll-target="#reading-from-local-disk">Reading from local disk</a></li>
  <li><a href="#reading-from-databases-dbplyr" id="toc-reading-from-databases-dbplyr" class="nav-link" data-scroll-target="#reading-from-databases-dbplyr">Reading from databases, <strong>dbplyr</strong></a></li>
  <li><a href="#sec-vsi" id="toc-sec-vsi" class="nav-link" data-scroll-target="#sec-vsi">Reading from online resources or web services</a></li>
  <li><a href="#apis-openstreetmap" id="toc-apis-openstreetmap" class="nav-link" data-scroll-target="#apis-openstreetmap">APIs, OpenStreetMap</a></li>
  <li><a href="#geoparquet-and-geoarrow" id="toc-geoparquet-and-geoarrow" class="nav-link" data-scroll-target="#geoparquet-and-geoarrow">GeoParquet and GeoArrow</a></li>
  </ul>
</li>
  <li>
<a href="#raster-data-stars" id="toc-raster-data-stars" class="nav-link" data-scroll-target="#raster-data-stars"><span class="header-section-number">9.2</span> Raster data: <strong>stars</strong></a>
  <ul class="collapse">
<li><a href="#stars-proxy-objects" id="toc-stars-proxy-objects" class="nav-link" data-scroll-target="#stars-proxy-objects"><code>stars</code> proxy objects</a></li>
  <li><a href="#operations-on-proxy-objects" id="toc-operations-on-proxy-objects" class="nav-link" data-scroll-target="#operations-on-proxy-objects">Operations on proxy objects</a></li>
  <li><a href="#remote-raster-resources" id="toc-remote-raster-resources" class="nav-link" data-scroll-target="#remote-raster-resources">Remote raster resources</a></li>
  </ul>
</li>
  <li>
<a href="#very-large-data-cubes" id="toc-very-large-data-cubes" class="nav-link" data-scroll-target="#very-large-data-cubes"><span class="header-section-number">9.3</span> Very large data cubes</a>
  <ul class="collapse">
<li><a href="#finding-and-processing-assets" id="toc-finding-and-processing-assets" class="nav-link" data-scroll-target="#finding-and-processing-assets">Finding and processing assets</a></li>
  <li><a href="#sec-zarr" id="toc-sec-zarr" class="nav-link" data-scroll-target="#sec-zarr">Cloud native storage: Zarr</a></li>
  <li><a href="#apis-for-data-gee-openeo" id="toc-apis-for-data-gee-openeo" class="nav-link" data-scroll-target="#apis-for-data-gee-openeo">APIs for data: GEE, openEO</a></li>
  </ul>
</li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">9.4</span> Exercises</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/09-Large.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-2.html">R for Spatial Data Science</a></li><li class="breadcrumb-item"><a href="./09-Large.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-large" class="quarto-section-identifier"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p> </p>
<p>This chapter describes how large spatial and spatiotemporal datasets can be handled with R, with a focus on packages <strong>sf</strong> and <strong>stars</strong>. For practical use, we classify large datasets as too large</p>
<ul>
<li>to fit in working memory,</li>
<li>to fit on the local hard drive, or</li>
<li>to download to locally managed infrastructure (such as network attached storage)</li>
</ul>
<p></p>
<p>These three categories may (today) correspond very roughly to Gigabyte-, Terabyte- and Petabyte-sized datasets. Besides size considerations, access and processing speed also play a role, in particular for larger datasets or interactive applications. Cloud native geospatial formats are formats optimised with processing on cloud infrastructure in mind, where costs of computing and storage need to be considered and optimised. Such costs can be reduced by</p>
<ul>
<li>using compression, such as the LERC (Limited Error Raster Compression) algorithm used for cloud-optimised GeoTIFF, or the BLOSC compressor used for ZARR array data</li>
<li>fast access to spatial sub-regions, such as by ways of HTTP range request enabled for cloud-optimised geotiffs, or column-oriented data access in the GeoParquet and GeoArrow formats</li>
<li>accessing/viewing data at incremental resolution (low-resolution images are available before or without the full resolution being read), implemented natively by progressive JPEG formats or by using image pyramids (or overviews) in other raster formats</li>
<li>optimising data access with particular cloud storage or object storage protocols in mind.</li>
</ul>
<p>It should be noted that there are no silver bullets in this area: optimising storage for one particular access pattern will lead to slow access for other ways. If raster data is for instance stored for optimal access of spatial regions at different spatial resolutions, reading the data as pixel time series may be very slow. Compression leads to low storage and bandwidth costs but to higher processing costs when reading, because of the decompression involved.</p>
<section id="sec-largesf" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="sec-largesf">
<span class="header-section-number">9.1</span> Vector data: <code>sf</code>
</h2>
<p> </p>
<section id="reading-from-local-disk" class="level3"><h3 class="anchored" data-anchor-id="reading-from-local-disk">Reading from local disk</h3>
<p>Function <code>st_read</code> reads vector data from disk, using GDAL, and then keeps the data read in working memory. In case the file is too large to be read in working memory, several options exist to read parts of the file. The first is to set argument <code>wkt_filter</code> with a WKT text string containing a geometry; only geometries from the target file that intersect with this geometry will be returned. An example is</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="co"># Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"gpkg/nc.gpkg"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="op">-</span><span class="fl">82</span>,ymin <span class="op">=</span> <span class="fl">36</span>, xmax <span class="op">=</span> <span class="op">-</span><span class="fl">80</span>, ymax <span class="op">=</span> <span class="fl">37</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_text.html">st_as_text</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">bb</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="va">file</span>, wkt_filter <span class="op">=</span> <span class="va">bb</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># out of 100</span></span>
<span><span class="co"># Re-reading with feature count reset from 17 to 16</span></span>
<span><span class="co"># [1] 16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, <code>read_sf</code> is used as an alternative to <code>st_read</code> to suppress output.</p>
<p></p>
<p>The second option is to use the <code>query</code> argument to <code>st_read</code>, which can be any query in “OGR SQL” dialect. This can for instance be used to select features from a layer, or limit fields. An example is:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="st">"select BIR74,SID74,geom from 'nc.gpkg' where BIR74 &gt; 1500"</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="va">file</span>, query <span class="op">=</span> <span class="va">q</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># [1] 61</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that <code>nc.gpkg</code> is the <em>layer name</em>, which can be obtained from <code>file</code> using <code>st_layers</code>. Sequences of records can be read using <code>LIMIT</code> and <code>OFFSET</code>, to read records 51-60 use</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="st">"select BIR74,SID74,geom from 'nc.gpkg' LIMIT 10 OFFSET 50"</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="va">file</span>, query <span class="op">=</span> <span class="va">q</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># [1] 10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Further query options include selection on geometry type or polygon area. When the dataset queried is a spatial database, then the query is passed on to the database and not interpreted by GDAL; this means that more powerful features will be available. Further information is found in the GDAL documentation under “OGR SQL dialect”.</p>
<p></p>
<p>Very large files or directories that are zipped can be read without the need to unzip them, using the <code>/vsizip</code> (for zip), <code>/vsigzip</code> (for gzip), or <code>/vsitar</code> (for tar files) prefix to files. This is followed by the path to the zip file, and then followed by the file inside this zip file. Reading files this way may come at some computational cost.</p>
</section><section id="reading-from-databases-dbplyr" class="level3"><h3 class="anchored" data-anchor-id="reading-from-databases-dbplyr">Reading from databases, <strong>dbplyr</strong>
</h3>
<p></p>
<p>Although GDAL has support for several spatial databases, and as mentioned above it passes on SQL in the <code>query</code> argument to the database, it is sometimes beneficial to directly read from and write to a spatial database using the DBI R database drivers for this. An example of this is:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pg</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span></span>
<span>    <span class="fu">RPostgres</span><span class="fu">::</span><span class="fu"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html">Postgres</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    host <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"DB_HOST"</span><span class="op">)</span>,</span>
<span>    user <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"DB_USERNAME"</span><span class="op">)</span>,</span>
<span>    dbname <span class="op">=</span> <span class="st">"postgis"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="va">pg</span>, query <span class="op">=</span> </span>
<span>        <span class="st">"select BIR74,wkb_geometry from nc limit 3"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># [1] 3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where the database host and user name are obtained from environment variables, and the database name is <code>postgis</code>.</p>
<p>A spatial query might look like</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="st">"SELECT BIR74,wkb_geometry FROM nc WHERE \</span></span>
<span><span class="st">ST_Intersects(wkb_geometry, 'SRID=4267;POINT (-81.50 36.43)');"</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="va">pg</span>, query <span class="op">=</span> <span class="va">q</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># [1] 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, the intersection is carried out inside the database, and uses a spatial index when present. The same mechanism works when using <code>dplyr</code> with a database backend:</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">nc_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">pg</span>, <span class="st">"nc"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Spatial queries can be formulated and are passed on to the database:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nc_db</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">ST_Intersects</span><span class="op">(</span><span class="va">wkb_geometry</span>, </span>
<span>                        <span class="st">'SRID=4267;POINT (-81.50 36.43)'</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 1 × 16</span></span>
<span><span class="co">#   ogc_fid  area perimeter cnty_ cnty_id name  fips  fipsno cress_id</span></span>
<span><span class="co">#     &lt;int&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt;    &lt;int&gt;</span></span>
<span><span class="co"># 1       1 0.114      1.44  1825    1825 Ashe  37009  37009        5</span></span>
<span><span class="co"># # ℹ 7 more variables: bir74 &lt;dbl&gt;, sid74 &lt;dbl&gt;, nwbir74 &lt;dbl&gt;,</span></span>
<span><span class="co"># #   bir79 &lt;dbl&gt;, sid79 &lt;dbl&gt;, nwbir79 &lt;dbl&gt;,</span></span>
<span><span class="co"># #   wkb_geometry &lt;pq_gmtry&gt;</span></span>
<span><span class="va">nc_db</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">ST_Area</span><span class="op">(</span><span class="va">wkb_geometry</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co"># # Source:   SQL [3 x 16]</span></span>
<span><span class="co"># # Database: postgres  [postgres@localhost:5432/postgis]</span></span>
<span><span class="co">#   ogc_fid  area perimeter cnty_ cnty_id name   fips  fipsno cress_id</span></span>
<span><span class="co">#     &lt;int&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt;    &lt;int&gt;</span></span>
<span><span class="co"># 1       1 0.114      1.44  1825    1825 Ashe   37009  37009        5</span></span>
<span><span class="co"># 2       3 0.143      1.63  1828    1828 Surry  37171  37171       86</span></span>
<span><span class="co"># 3       5 0.153      2.21  1832    1832 North… 37131  37131       66</span></span>
<span><span class="co"># # ℹ 7 more variables: bir74 &lt;dbl&gt;, sid74 &lt;dbl&gt;, nwbir74 &lt;dbl&gt;,</span></span>
<span><span class="co"># #   bir79 &lt;dbl&gt;, sid79 &lt;dbl&gt;, nwbir79 &lt;dbl&gt;,</span></span>
<span><span class="co"># #   wkb_geometry &lt;pq_gmtry&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(Note that PostGIS’ <code>ST_Area</code> computes the same area as the <code>AREA</code> field in <code>nc</code>, which is the meaningless value obtained by interpreting the coordinates as projected, where they are ellipsoidal.)</p>
</section><section id="sec-vsi" class="level3"><h3 class="anchored" data-anchor-id="sec-vsi">Reading from online resources or web services</h3>
<p></p>
<p>GDAL drivers support reading from online resources, by prepending the URL starting with <code>https://</code> with <code>/vsicurl/</code>. A number of similar drivers specialised for particular clouds include <code>/vsis3/</code> for Amazon S3, <code>/vsigs/</code> for Google Cloud Storage, <code>/vsiaz/</code> for Azure, <code>/vsioss/</code> for Alibaba Cloud, or <code>/vsiswift/</code> for OpenStack Swift Object Storage. <a href="#sec-zarr" class="quarto-xref"><span>Section 9.3.2</span></a> has an example of using <code>/vsicurl/</code>.</p>
<p>These prepositions can be combined with <code>/vsizip/</code> to read a file from a zipped online resource. Depending on the file format used, reading information this way may require reading the entire file, or reading it multiple times, and may not always be the most efficient way of handling resources. Cloud native formats are optimised to work efficiently using <code>HTTP</code> requests.</p>
<p> </p>
</section><section id="apis-openstreetmap" class="level3"><h3 class="anchored" data-anchor-id="apis-openstreetmap">APIs, OpenStreetMap</h3>
<p> </p>
<p>Typical web services for geospatial data create data on the fly and give access to this through an API. As an example, data from <a href="https://openstreetmap.org/">OpenStreetMap</a> can be bulk downloaded and read locally, for instance using the GDAL vector driver, but more typical a user wants to obtain a small subset of the data or use the data for a small query. Several R packages exist that query OpenStreetMap data:</p>
<ul>
<li>Package <strong>OpenStreetMap</strong> <span class="citation" data-cites="R-OpenStreetMap">(<a href="references.html#ref-R-OpenStreetMap" role="doc-biblioref">Fellows and JMapViewer library by Jan Peter Stotz 2019</a>)</span> downloads data as raster tiles, typically used as backdrop or reference for plotting other features</li>
<li>Package <strong>osmdata</strong> <span class="citation" data-cites="osmdata">(<a href="references.html#ref-osmdata" role="doc-biblioref">Mark Padgham et al. 2017</a>)</span> downloads vector data as points, lines, or polygons in <strong>sf</strong> or <strong>sp</strong> format</li>
<li>Package <strong>osmar</strong> (from CRAN <a href="https://cran.r-project.org/web/packages/osmar/index.html">archive</a>) returns vector data, but in addition the network topology (as an <code>igraph</code> object) that contains how road elements are connected, and has functions for computing the shortest route</li>
</ul>
<p>When provided with a correctly formulated API call in the URL the highly configurable GDAL OSM driver (in <code>st_read</code>) can read an “.osm” file (xml) and return a dataset with five layers: <code>points</code> that have significant tags, <code>lines</code> with non-area “way” features, <code>multilinestrings</code> with “relation” features, <code>multipolygons</code> with “relation” features , and <code>other_relations</code>. A simple and very small bounding box query to OpenStreetMap could look like</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://openstreetmap.org/api/0.6/map?"</span>,</span>
<span>       <span class="st">"bbox=7.595,51.969,7.598,51.970"</span><span class="op">)</span>,</span>
<span>    <span class="st">"data/ms.osm"</span>, method <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and from this file we can read the layer <code>lines</code>, and plot its first attribute by</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"data/ms.osm"</span>, <span class="st">"lines"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"data/ms.osm"</span>, <span class="st">"multipolygons"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">7.595</span>, ymin <span class="op">=</span> <span class="fl">51.969</span>, </span>
<span>          xmax <span class="op">=</span> <span class="fl">7.598</span>, ymax <span class="op">=</span> <span class="fl">51.970</span><span class="op">)</span>, crs <span class="op">=</span> <span class="st">'OGC:CRS84'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>axes <span class="op">=</span> <span class="cn">TRUE</span>, lwd <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">2</span>, cex.axis <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">o</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>, border <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">'#88888888'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-overpass" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-overpass-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09-Large_files/figure-html/fig-overpass-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-overpass-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.1: OpenStreetMap vector data
</figcaption></figure>
</div>
</div>
</div>
<p>the result of which is shown in <a href="#fig-overpass" class="quarto-xref">Figure&nbsp;<span>9.1</span></a>. The overpass API provides a more generic and powerful query functionality to OpenStreetMap data.</p>
</section><section id="geoparquet-and-geoarrow" class="level3"><h3 class="anchored" data-anchor-id="geoparquet-and-geoarrow">GeoParquet and GeoArrow</h3>
<p> </p>
<p>Two formats dedicated to cloud native analysis are derived from the Apache projects Parquet and Arrow. Both provide column oriented storage of tabular data, meaning that the reading of a single field for many records is fast, compared to record oriented storage of most other databases. The Geo- extensions of both involve</p>
<ul>
<li>a way of storing a geometry column, either in a well-known binary or text form, or in a more efficient form where sub-geometries are indexed up front</li>
<li>storage of a coordinate reference system.</li>
</ul>
<p>At the time of writing this book, both formats are under active development, but drivers for reading or creating them are available in GDAL starting from version 3.5. Both formats allow for compressed storage. The difference is that (Geo)Parquet is more oriented towards persistent storage, where, (Geo)Arrow is more oriented to fast access and fast computation. Arrow can for instance be both an in-memory and an on-disk format.</p>
</section></section><section id="raster-data-stars" class="level2" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="raster-data-stars">
<span class="header-section-number">9.2</span> Raster data: <strong>stars</strong>
</h2>
<p>A common challenge with raster datasets is not only that they come in large files (single Sentinel-2 tiles are around 1 GB), but that many of these files, potentially thousands or millions, are needed to address the area and time period of interest. In 2022, Copernicus, the program that runs all Sentinel satellites, published 160 TB of images per day. This means that a classic pattern in using R consisting of downloading data to local disc, loading the data in memory, and analysing it is not going to work.</p>
<p> </p>
<p>Cloud-based Earth Observation processing platforms like Google Earth Engine <span class="citation" data-cites="gorelick">(<a href="references.html#ref-gorelick" role="doc-biblioref">Gorelick et al. 2017</a>)</span>, <a href="https://www.sentinel-hub.com/">Sentinel Hub</a> or <a href="https://openeo.cloud">openEO.cloud</a> recognise this and let users work with datasets up to the petabyte range rather easily and with a great deal of interactivity. They share the following properties:</p>
<ul>
<li>computations are postponed as long as possible (lazy evaluation)</li>
<li>only the data asked for by the user is being computed and returned, and nothing more</li>
<li>storing intermediate results is avoided in favour of on-the-fly computations</li>
<li>maps with useful results are generated and shown quickly to allow for interactive model development</li>
</ul>
<p>This is similar to the <strong>dbplyr</strong> interface to databases and cloud-based analytics environments, but differs in the aspect of <em>what</em> we want to see quickly: rather than the first <span class="math inline">\(n\)</span> records of a <strong>dbplyr</strong> lazy table, we want a quick <em>overview</em> of the results, in the form of a map covering the whole area, or part of it, but at screen resolution rather than native (observation) resolution.</p>
<p> </p>
<p>If for instance we want to “see” results for the United States on a screen with 1000 <span class="math inline">\(\times\)</span> 1000 pixels, we only need to compute results for this many pixels, which corresponds roughly to data on a grid with 3000 m <span class="math inline">\(\times\)</span> 3000 m grid cells. For Sentinel-2 data with 10 m resolution, this means we can downsample with a factor 300, giving 3 km <span class="math inline">\(\times\)</span> 3 km resolution. Processing, storage, and network requirements then drop a factor <span class="math inline">\(300^2 \approx 10^5\)</span>, compared to working on the native 10 m <span class="math inline">\(\times\)</span> 10 m resolution. On the platforms mentioned, zooming in the map triggers further computations on a finer resolution and smaller extent.</p>
<p>A simple optimisation that follows these lines is how the plot method for <code>stars</code> objects works. In the case of plotting large rasters, it downsamples the array before it plots, drastically saving time. The degree of downsampling is derived from the plotting region size and the plotting resolution (pixel density). For vector devices, such as pdf, R sets plot resolution to 75 dpi, corresponding to 0.3 mm per pixel. Enlarging plots may reveal this, but replotting to an enlarged devices will create a plot at target density. For <code>geom_stars</code> the user has to specify the <code>downsample</code> rate, because the <strong>ggplot2</strong> does not make the device size available to that function.</p>
<section id="stars-proxy-objects" class="level3"><h3 class="anchored" data-anchor-id="stars-proxy-objects">
<code>stars</code> proxy objects</h3>
<p> </p>
<p>To handle datasets that are too large to fit in memory, <strong>stars</strong> provides <code>stars_proxy</code> objects. To demonstrate its use, we will use the <strong>starsdata</strong> package, an R data package with larger datasets (around 1 GB total). It can be installed by</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>timeout <span class="op">=</span> <span class="fl">600</span><span class="op">)</span> <span class="co"># or larger in case of slow network</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"starsdata"</span>, </span>
<span>  repos <span class="op">=</span> <span class="st">"http://cran.uni-muenster.de/pebesma/"</span>, type <span class="op">=</span> <span class="st">"source"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can “load” a Sentinel-2 image from it by</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sentinel/S2A_MSIL1C_20180220T105051_N0206"</span>,</span>
<span>           <span class="st">"_R051_T32ULE_20180221T134037.zip"</span><span class="op">)</span></span>
<span><span class="va">granule</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">f</span>, package <span class="op">=</span> <span class="st">"starsdata"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/file.info.html">file.size</a></span><span class="op">(</span><span class="va">granule</span><span class="op">)</span></span>
<span><span class="co"># [1] 7.69e+08</span></span>
<span><span class="va">base_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">granule</span><span class="op">)</span>, <span class="st">".zip"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"SENTINEL2_L1C:/vsizip/"</span>, <span class="va">granule</span>, <span class="st">"/"</span>, <span class="va">base_name</span>, </span>
<span>    <span class="st">".SAFE/MTD_MSIL1C.xml:10m:EPSG_32632"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">s2</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars_proxy object with 1 attribute in 1 file(s):</span></span>
<span><span class="co"># $EPSG_32632</span></span>
<span><span class="co"># [1] "[...]/MTD_MSIL1C.xml:10m:EPSG_32632"</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#      from    to offset delta            refsys    values x/y</span></span>
<span><span class="co"># x       1 10980  3e+05    10 WGS 84 / UTM z...      NULL [x]</span></span>
<span><span class="co"># y       1 10980  6e+06   -10 WGS 84 / UTM z...      NULL [y]</span></span>
<span><span class="co"># band    1     4     NA    NA                NA B4,...,B8</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co"># 12568 bytes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and we see that this does not actually load <em>any</em> of the pixel values but keeps the reference to the dataset and fills the dimensions table. (The convoluted <code>s2</code> name is needed to point GDAL to the right file inside the <code>.zip</code> file containing 115 files in total).</p>
<p> </p>
<div style="page-break-after: always;"></div>
<p>The idea of a proxy object is that we can build expressions like</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="fl">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>but that the computations for this are postponed. Only when we really need the data, is <code>p * 2</code> evaluated. We need data when we:</p>
<ul>
<li>
<code>plot</code> data,</li>
<li>write an object to disk, with <code>write_stars</code>, or</li>
<li>explicitly load an object in memory, with <code>st_as_stars</code>
</li>
</ul>
<p>In case the entire object does not fit in memory, <code>plot</code> and <code>write_stars</code> choose different strategies to deal with this:</p>
<ul>
<li>
<code>plot</code> fetches only the pixels that can be seen by downsampling, rather than reading all pixels available</li>
<li>
<code>write_stars</code> reads, processes, and writes data chunk-by-chunk</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co"># downsample set to 18</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-plotp" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plotp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09-Large_files/figure-html/fig-plotp-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plotp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.2: Downsampled 10 m bands of a Sentinel-2 scene
</figcaption></figure>
</div>
</div>
</div>
<p>Downsampling and chunking is implemented for spatially dense images, but not for dense time series or other dense dimensions. As an example, the output of <code>plot(p)</code>, shown in <a href="#fig-plotp" class="quarto-xref">Figure&nbsp;<span>9.2</span></a> only fetches the pixels that can be seen on the plot device, rather than the 10980 <span class="math inline">\(\times\)</span> 10980 pixels available in each band. The downsampling ratio taken is</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/prod.html">prod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html">prod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.size.html">dev.size</a></span><span class="op">(</span><span class="st">"px"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] 19</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>meaning that for every 19 <span class="math inline">\(\times\)</span> 19 sub-image in the original image, only one pixel is read and plotted.</p>
</section><section id="operations-on-proxy-objects" class="level3"><h3 class="anchored" data-anchor-id="operations-on-proxy-objects">Operations on proxy objects</h3>
<p> Several dedicated methods are available for <code>stars_proxy</code> objects:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"stars_proxy"</span><span class="op">)</span></span>
<span><span class="co">#  [1] [               [[&lt;-            [&lt;-             adrop          </span></span>
<span><span class="co">#  [5] aggregate       aperm           as.data.frame   c              </span></span>
<span><span class="co">#  [9] coerce          dim             droplevels      filter         </span></span>
<span><span class="co"># [13] hist            initialize      is.na           Math           </span></span>
<span><span class="co"># [17] merge           mutate          Ops             plot           </span></span>
<span><span class="co"># [21] predict         print           pull            rename         </span></span>
<span><span class="co"># [25] select          show            slice           slotsFromS3    </span></span>
<span><span class="co"># [29] split           st_apply        st_as_sf        st_as_stars    </span></span>
<span><span class="co"># [33] st_crop         st_dimensions&lt;- st_downsample   st_mosaic      </span></span>
<span><span class="co"># [37] st_normalize    st_redimension  st_sample       st_set_bbox    </span></span>
<span><span class="co"># [41] transmute       write_stars    </span></span>
<span><span class="co"># see '?methods' for accessing help and source code</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have seen <code>plot</code> and <code>print</code> in action; <code>dim</code> reads out the dimension from the dimensions metadata table.</p>
<p> </p>
<p>The three methods that actually fetch data are <code>st_as_stars</code>, <code>plot</code> and <code>write_stars</code>. <code>st_as_stars</code> reads the actual data into a <code>stars</code> object, its argument <code>downsample</code> controls the downsampling rate. <code>plot</code> does this too, choosing an appropriate <code>downsample</code> value from the device resolution, and plots the object. <code>write_stars</code> writes a <code>stars_proxy</code> object to disk.</p>
<p>All other methods for <code>stars_proxy</code> objects do not actually operate on the raster data but add the operations to a <em>to do</em> list attached to the object. Only when actual raster data are fetched, for instance when <code>plot</code> or <code>st_as_stars</code> are called, the commands in this list are executed.</p>
<p> <code>st_crop</code> limits the extent (area) of the raster that will be read. <code>c</code> combines <code>stars_proxy</code> objects, but still doesn’t read any data. <code>adrop</code> drops empty dimensions and <code>aperm</code> can change dimension order.</p>
<p><code>write_stars</code> reads and processes its input chunk-wise; it has an argument <code>chunk_size</code> that lets users control the size of spatial chunks.</p>
</section><section id="remote-raster-resources" class="level3"><h3 class="anchored" data-anchor-id="remote-raster-resources">Remote raster resources</h3>
<p> </p>
<p>A format like “cloud-optimised GeoTIFF” (COG) has been specially designed to be efficient and resource-friendly in many cases, e.g., for only reading the metadata, or for only reading overviews (low-resolution versions of the full imagery) or spatial regions using the <code>/vsixxx/</code> mechanisms (<a href="#sec-vsi" class="quarto-xref"><span>Section 9.1.3</span></a>). COGs can also be created using the GeoTIFF driver of GDAL, and setting the right dataset creation options in a <code>write_stars</code> call.</p>
</section></section><section id="very-large-data-cubes" class="level2" data-number="9.3"><h2 data-number="9.3" class="anchored" data-anchor-id="very-large-data-cubes">
<span class="header-section-number">9.3</span> Very large data cubes</h2>
<p> </p>
<p>At some stage, datasets need to be analysed that are so large that downloading them is no longer feasible; even when local storage would be sufficient, network bandwidth may become limiting. Examples are satellite image archives such as those from Landsat and Copernicus (Sentinel-x), or model computations such as the ERA5 <span class="citation" data-cites="era5">(<a href="references.html#ref-era5" role="doc-biblioref">Hersbach et al. 2020</a>)</span>, a model reanalysis of the global atmosphere, land surface, and ocean waves from 1950 onwards. In such cases it may be most helpful to gain access to virtual machines in a cloud that have these data available, or to use a system that lets the user carry out computations without having to worry about virtual machines and storage. Both options will be discussed.</p>
<section id="finding-and-processing-assets" class="level3"><h3 class="anchored" data-anchor-id="finding-and-processing-assets">Finding and processing assets</h3>
<p>When working on a virtual machine on a cloud, a first task is usually to find the assets (files) to work on. It looks attractive to obtain a file listing, and then parse file names such as</p>
<pre><code>S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.zip</code></pre>
<p>for their metadata including the date of acquisition and the code of the spatial tile covered. Obtaining such a file listing however is usually computationally very demanding, as is the processing of the result, when the number of tiles runs in the many millions.</p>
<p>A solution to this is to use a catalogue. The recently developed and increasingly deployed STAC, short for <em>spatiotemporal asset catalogue</em>, provides an API that can be used to query image collections by properties like bounding box, date, band, and cloud coverage. The R package <strong>rstac</strong> <span class="citation" data-cites="R-rstac">(<a href="references.html#ref-R-rstac" role="doc-biblioref">Simoes, Carvalho, and Brazil Data Cube Team 2023</a>)</span> provides an R interface to create queries and manage the information returned.</p>
<p>Processing the resulting files may involve creating a data cube at a lower spatial and/or temporal resolution, from images that may span a range of coordinate reference systems (e.g., several UTM zones). An R package that creates a regular data cube from such a collection of images is <strong>gdalcubes</strong> <span class="citation" data-cites="R-gdalcubes appel2019demand">(<a href="references.html#ref-R-gdalcubes" role="doc-biblioref">Appel 2023</a>; <a href="references.html#ref-appel2019demand" role="doc-biblioref">Appel and Pebesma 2019</a>)</span>, which can also directly use a STAC <span class="citation" data-cites="appelblog">(<a href="references.html#ref-appelblog" role="doc-biblioref">Appel, Pebesma, and Mohr 2021</a>)</span> to identify images.</p>
</section><section id="sec-zarr" class="level3"><h3 class="anchored" data-anchor-id="sec-zarr">Cloud native storage: Zarr</h3>
<p> </p>
<p>Where COG provides cloud native storage for raster imagery, Zarr is a format for cloud native storage of large multi-dimensional arrays. It can be seen as a successor of NetCDF and seems to follow similar conventions, being used by the climate and forecast communities <span class="citation" data-cites="cf">(<a href="references.html#ref-cf" role="doc-biblioref">Eaton et al. 2022</a>)</span>. Zarr “files” are really directories with sub-directories containing compressed chunks of the data. The compression algorithm and the chunking strategy will have an effect on how fast particular sub-cubes can be read or written.</p>
<p>Function <code><a href="https://r-spatial.github.io/stars/reference/mdim.html">stars::read_mdim</a></code> can read entire data cubes but has options for reading sub-cubes by specifying for each dimension offset, number of pixels, and the step size to read a dimension at a lower resolution <span class="citation" data-cites="zarrblog">(<a href="references.html#ref-zarrblog" role="doc-biblioref">Pebesma 2022</a>)</span>. Similarly, <code><a href="https://r-spatial.github.io/stars/reference/mdim.html">stars::write_mdim</a></code> can write multi-dimensional arrays to Zarr or NetCDF files, or other formats that support the GDAL C++ multi-dimensional array API.</p>
<p> </p>
<p>To read a remote (cloud-based) Zarr file, one needs to prepend the URL with indicators about the format and the access protocol:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dsn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'ZARR:"/vsicurl/https://ncsa.osn.xsede.org'</span>,</span>
<span>       <span class="st">'/Pangeo/pangeo-forge/gpcp-feedstock/gpcp.zarr"'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>after which we can read the first 10 time steps using</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span></span>
<span><span class="va">bounds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>longitude <span class="op">=</span> <span class="st">"lon_bounds"</span>, latitude <span class="op">=</span> <span class="st">"lat_bounds"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/mdim.html">read_mdim</a></span><span class="op">(</span><span class="va">dsn</span>, bounds <span class="op">=</span> <span class="va">bounds</span>, count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#               Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span><span class="co"># precip [mm/d]    0       0      0 2.25     1.6  109</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#           from  to     offset  delta refsys x/y</span></span>
<span><span class="co"># longitude    1 360          0      1     NA [x]</span></span>
<span><span class="co"># latitude     1 180        -90      1     NA [y]</span></span>
<span><span class="co"># time         1  10 1996-10-01 1 days   Date</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co"># xmin ymin xmax ymax </span></span>
<span><span class="co">#    0  -90  360   90</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this example,</p>
<ul>
<li>
<code>NA</code> values for <code>count</code> indicate to get all values available for that dimension</li>
<li>here, <code>bounds</code> variables needed explicit specification because the data source did not follow the more recent CF (1.10) conventions; and ignoring bounds would lead to a raster with a bounding box having latitude values outside <span class="math inline">\([-90,90]\)</span>.</li>
</ul></section><section id="apis-for-data-gee-openeo" class="level3"><h3 class="anchored" data-anchor-id="apis-for-data-gee-openeo">APIs for data: GEE, openEO</h3>
<p> </p>
<p>Platforms that do not require the management and programming of virtual machines <em>in</em> the cloud but provide direct access to the imagery managed include GEE, openEO, and the climate data store.</p>
<p>Google Earth Engine (GEE) is a cloud platform that allows users to compute on large amounts of Earth Observation data as well as modelling products <span class="citation" data-cites="gorelick">(<a href="references.html#ref-gorelick" role="doc-biblioref">Gorelick et al. 2017</a>)</span>. It has powerful analysis capabilities, including most of the data cube operations explained in <a href="06-Cubes.html#sec-dcoperations" class="quarto-xref"><span>Section 6.3</span></a>. It has an interface where scripts can be written in JavaScript, and a Python interface to the same functionality. The code of GEE is not open-source, and cannot be extended by arbitrary user-defined functions in languages like Python or R. R package <strong>rgee</strong> <span class="citation" data-cites="R-rgee">(<a href="references.html#ref-R-rgee" role="doc-biblioref">Aybar 2022</a>)</span> provides an R client interface to GEE.</p>
<p>Cloud-based data cube processing platforms built entirely around open source software are emerging, several of which using the openEO API <span class="citation" data-cites="openEO">(<a href="references.html#ref-openEO" role="doc-biblioref">Schramm et al. 2021</a>)</span>. This API allows for user-defined functions (UDFs) written in Python or R that are being passed on through the API and executed at the pixel level, for instance to aggregate or reduce dimensions using custom reducers. UDFs in R represent the data chunk to be processed as a <code>stars</code> object; in Python <code>xarray</code> objects are used.</p>
<p>Other platforms include the Copernicus climate data store <span class="citation" data-cites="cds">(<a href="references.html#ref-cds" role="doc-biblioref">Raoult et al. 2017</a>)</span> or atmosphere data store, which allow processing of atmospheric or climate data from ECMWF, including ERA5. An R package with an interface to both data stores is <strong>ecmwfr</strong> <span class="citation" data-cites="R-ecmwfr">(<a href="references.html#ref-R-ecmwfr" role="doc-biblioref">Hufkens 2023</a>)</span>.</p>
<p></p>
</section></section><section id="exercises" class="level2" data-number="9.4"><h2 data-number="9.4" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">9.4</span> Exercises</h2>
<p>Use R to solve the following exercises.</p>
<ol type="1">
<li>For the S2 image (above), find out in which order the bands are by using <code><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_get_dimension_values()</a></code>, and try to find out which spectral bands / colours they correspond to.</li>
<li>Compute NDVI for the S2 image, using <code>st_apply</code> and an appropriate <code>ndvi</code> function. Plot the result to screen, and then write the result to a GeoTIFF. Explain the difference in runtime between plotting and writing.</li>
<li>Plot an RGB composite of the S2 image, using the <code>rgb</code> argument to <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code>, and then by using <code><a href="https://r-spatial.github.io/stars/reference/st_rgb.html">st_rgb()</a></code> first.</li>
<li>Select five random points from the bounding box of <code>S2</code>, and extract the band values at these points; convert the object returned to an <code>sf</code> object.</li>
<li>For the 10-km radius circle around <code>POINT(390000  5940000)</code>, use <code>aggregate</code> to compute the mean pixel values of the S2 image when downsampling the images with factor 30, and on the original resolution. Compute the relative difference between the results.</li>
<li>Use <code>hist</code> to compute the histogram on the downsampled S2 image. Also do this for each of the bands. Use <code>ggplot2</code> to compute a single plot with all four histograms.</li>
<li>Use <code>st_crop</code> to crop the S2 image to the area covered by the 10-km circle. Plot the results. Explore the effect of setting argument <code>crop = FALSE</code>
</li>
<li>With the downsampled image, compute the logical layer where all four bands have pixel values higher than 1000. Use a raster algebra expression on the four bands (use <code>split</code> first), or use <code>st_apply</code> for this.</li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-R-gdalcubes" class="csl-entry" role="listitem">
Appel, Marius. 2023. <em>Gdalcubes: Earth Observation Data Cubes from Satellite Image Collections</em>. <a href="https://github.com/appelmar/gdalcubes_R">https://github.com/appelmar/gdalcubes_R</a>.
</div>
<div id="ref-appel2019demand" class="csl-entry" role="listitem">
Appel, Marius, and Edzer Pebesma. 2019. <span>“On-Demand Processing of Data Cubes from Satellite Image Collections with the Gdalcubes Library.”</span> <em>Data</em> 4 (3): 92. <a href="https://www.mdpi.com/2306-5729/4/3/92">https://www.mdpi.com/2306-5729/4/3/92</a>.
</div>
<div id="ref-appelblog" class="csl-entry" role="listitem">
Appel, Marius, Edzer Pebesma, and Matthias Mohr. 2021. <em>Cloud-Based Processing of Satellite Image Collections in <span>R</span> Using <span>STAC</span>, <span>COGs</span>, and on-Demand Data Cubes</em>. <a href="https://r-spatial.org/r/2021/04/23/cloud-based-cubes.html">https://r-spatial.org/r/2021/04/23/cloud-based-cubes.html</a>.
</div>
<div id="ref-R-rgee" class="csl-entry" role="listitem">
Aybar, Cesar. 2022. <em>Rgee: R Bindings for Calling the Earth Engine API</em>. <a href="https://CRAN.R-project.org/package=rgee">https://CRAN.R-project.org/package=rgee</a>.
</div>
<div id="ref-cf" class="csl-entry" role="listitem">
Eaton, Brian, Jonathan Gregory, Bob Drach, Karl Taylor, Steve Hankin, Jon Blower, John Caron, et al. 2022. <em>NetCDF Climate and Forecast (CF) Metadata Conventions, Version 1.10</em>. <a href="https://cfconventions.org/">https://cfconventions.org/</a>.
</div>
<div id="ref-R-OpenStreetMap" class="csl-entry" role="listitem">
Fellows, Ian, and using the JMapViewer library by Jan Peter Stotz. 2019. <em>OpenStreetMap: Access to Open Street Map Raster Images</em>. <a href="https://CRAN.R-project.org/package=OpenStreetMap">https://CRAN.R-project.org/package=OpenStreetMap</a>.
</div>
<div id="ref-gorelick" class="csl-entry" role="listitem">
Gorelick, Noel, Matt Hancher, Mike Dixon, Simon Ilyushchenko, David Thau, and Rebecca Moore. 2017. <span>“Google Earth Engine: Planetary-Scale Geospatial Analysis for Everyone.”</span> <em>Remote Sensing of Environment</em> 202: 18–27. <a href="https://doi.org/10.1016/j.rse.2017.06.031">https://doi.org/10.1016/j.rse.2017.06.031</a>.
</div>
<div id="ref-era5" class="csl-entry" role="listitem">
Hersbach, Hans, Bill Bell, Paul Berrisford, Shoji Hirahara, András Horányi, Joaquín Muñoz-Sabater, Julien Nicolas, et al. 2020. <span>“The ERA5 Global Reanalysis.”</span> <em>Quarterly Journal of the Royal Meteorological Society</em> 146 (730): 1999–2049. <a href="https://doi.org/10.1002/qj.3803">https://doi.org/10.1002/qj.3803</a>.
</div>
<div id="ref-R-ecmwfr" class="csl-entry" role="listitem">
Hufkens, Koen. 2023. <em>Ecmwfr: Interface to ECMWF and CDS Data Web Services</em>. <a href="https://github.com/bluegreen-labs/ecmwfr">https://github.com/bluegreen-labs/ecmwfr</a>.
</div>
<div id="ref-osmdata" class="csl-entry" role="listitem">
Mark Padgham, Bob Rudis, Robin Lovelace, and Maëlle Salmon. 2017. <em>Osmdata</em>. <em>The Journal of Open Source Software</em>. Vol. 2. The Open Journal. <a href="https://doi.org/10.21105/joss.00305">https://doi.org/10.21105/joss.00305</a>.
</div>
<div id="ref-zarrblog" class="csl-entry" role="listitem">
Pebesma, Edzer. 2022. <em>Reading Zarr Files with r Package Stars</em>. <a href="https://r-spatial.org/r/2022/09/13/zarr.html">https://r-spatial.org/r/2022/09/13/zarr.html</a>.
</div>
<div id="ref-cds" class="csl-entry" role="listitem">
Raoult, Baudouin, Cedric Bergeron, Angel López Alós, Jean-Noël Thépaut, and Dick Dee. 2017. <span>“Climate Service Develops User-Friendly Data Store.”</span> <em>ECMWF Newsletter</em> 151: 22–27.
</div>
<div id="ref-openEO" class="csl-entry" role="listitem">
Schramm, Matthias, Edzer Pebesma, Milutin Milenković, Luca Foresta, Jeroen Dries, Alexander Jacob, Wolfgang Wagner, et al. 2021. <span>“The <span class="nocase">openEO</span> <span>API</span>–Harmonising the Use of Earth Observation Cloud Services Using Virtual Data Cube Functionalities.”</span> <em>Remote Sensing</em> 13 (6). <a href="https://doi.org/10.3390/rs13061125">https://doi.org/10.3390/rs13061125</a>.
</div>
<div id="ref-R-rstac" class="csl-entry" role="listitem">
Simoes, Rolf, Felipe Carvalho, and Brazil Data Cube Team. 2023. <em>Rstac: Client Library for SpatioTemporal Asset Catalog</em>. <a href="https://brazil-data-cube.github.io/rstac/">https://brazil-data-cube.github.io/rstac/</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/r-spatial\.org\/book\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./08-Plotting.html" class="pagination-link" aria-label="Plotting spatial data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./part-3.html" class="pagination-link" aria-label="Models for Spatial Data">
        <span class="nav-page-text">Models for Spatial Data</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb19" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Large data and cloud native {#sec-large}</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>\index{cloud native}</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>\index{large datasets}</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>This chapter describes how large spatial and spatiotemporal datasets</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>can be handled with R, with a focus on packages **sf** and **stars**.</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>For practical use, we classify large datasets as too large</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>to fit in working memory,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>to fit on the local hard drive, or</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>to download to locally managed infrastructure (such as network attached storage)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>\index{out-of-core}</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>These three categories may (today) correspond very roughly to Gigabyte-,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>Terabyte- and Petabyte-sized datasets.  Besides size considerations,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>access and processing speed also play a role,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>in particular for larger datasets or interactive applications.</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>Cloud native geospatial formats are formats optimised with processing</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>on cloud infrastructure in mind, where costs of computing and</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>storage need to be considered and optimised. Such costs can be</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>reduced by</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>using compression, such as the LERC (Limited Error Raster</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  Compression) algorithm used for cloud-optimised GeoTIFF, or the </span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  BLOSC compressor used for ZARR array data</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>fast access to spatial sub-regions, such as by ways of HTTP range</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  request enabled for cloud-optimised geotiffs, or column-oriented</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  data access in the GeoParquet and GeoArrow formats</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>accessing/viewing data at incremental resolution (low-resolution images are</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  available before or without the full resolution being read), implemented natively</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>  by progressive JPEG formats or by using image pyramids (or overviews)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  in other raster formats</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>optimising data access with particular cloud storage or object</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>  storage protocols in mind.</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>It should be noted that there are no silver bullets in this area:</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>optimising storage for one particular access pattern will lead to slow</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>access for other ways. If raster data is for instance stored for</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>optimal access of spatial regions at different spatial resolutions,</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>reading the data as pixel time series may be very slow. Compression</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>leads to low storage and bandwidth costs but to higher processing</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>costs when reading, because of the decompression involved.</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="fu">## Vector data: `sf` {#sec-largesf}</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>\index{sf!large datasets}</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>\index{st<span class="sc">\_</span>read!inside bounding box}</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reading from local disk</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>Function <span class="in">`st_read`</span> reads vector data from disk, using GDAL, and</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>then keeps the data read in working memory. In case the file is</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>too large to be read in working memory, several options exist to</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>read parts of the file. The first is to set argument <span class="in">`wkt_filter`</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>with a WKT text string containing a geometry; only geometries from</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>the target file that intersect with this geometry will be returned.</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>An example is</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"gpkg/nc.gpkg"</span>, <span class="at">package =</span> <span class="st">"sf"</span>)</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="dv">82</span>,<span class="at">ymin =</span> <span class="dv">36</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="dv">80</span>, <span class="at">ymax =</span> <span class="dv">37</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> <span class="fu">st_as_text</span>() <span class="ot">-&gt;</span> bb</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(file, <span class="at">wkt_filter =</span> bb) <span class="sc">|&gt;</span> <span class="fu">nrow</span>() <span class="co"># out of 100</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>Here, <span class="in">`read_sf`</span> is used as an alternative to <span class="in">`st_read`</span> to suppress</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>output.</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>\index{st<span class="sc">\_</span>read!query argument}</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>The second option is to use the <span class="in">`query`</span> argument to <span class="in">`st_read`</span>,</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>which can be any query in "OGR SQL" dialect. This can for instance be used to</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>select features from a layer, or limit fields. An example is:</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="st">"select BIR74,SID74,geom from 'nc.gpkg' where BIR74 &gt; 1500"</span></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(file, <span class="at">query =</span> q) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>Note that <span class="in">`nc.gpkg`</span> is the _layer name_, which can be obtained from <span class="in">`file`</span> using <span class="in">`st_layers`</span>.</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>Sequences of records can be read using <span class="in">`LIMIT`</span> and <span class="in">`OFFSET`</span>, to read records 51-60 use</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="st">"select BIR74,SID74,geom from 'nc.gpkg' LIMIT 10 OFFSET 50"</span></span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(file, <span class="at">query =</span> q) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>Further query options include selection on geometry type or polygon</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>area. When the dataset queried is a spatial database, then the query</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>is passed on to the database and not interpreted by GDAL; this means</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>that more powerful features will be available.  Further information</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>is found in the GDAL documentation under "OGR SQL dialect".</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>\index{st<span class="sc">\_</span>read!vsizip}</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>Very large files or directories that are zipped can be read</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>without the need to unzip them, using the <span class="in">`/vsizip`</span> (for zip),</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a><span class="in">`/vsigzip`</span> (for gzip), or <span class="in">`/vsitar`</span> (for tar files) prefix to files.</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>This is followed by the path to the zip file, and then followed by</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>the file inside this zip file. Reading files this way may come at</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>some computational cost.</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reading from databases, **dbplyr**</span></span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>\index{sf<span class="sc">\_</span>read!from database connection}</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE}</span></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a><span class="in">has_PG &lt;- Sys.getenv("DB_USERNAME") != "" &amp;&amp; Sys.getenv("DB_HOST") != "" &amp;&amp;</span></span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a><span class="in">    "PostgreSQL" %in% st_drivers()$name &amp;&amp;</span></span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a><span class="in">    !inherits(try(DBI::dbConnect( </span></span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a><span class="in">        RPostgres::Postgres(),</span></span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a><span class="in">        host = Sys.getenv("DB_HOST"),</span></span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a><span class="in">        user = Sys.getenv("DB_USERNAME"),</span></span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a><span class="in">        dbname = "postgis"), silent = TRUE), "try-error")</span></span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, eval=has_PG}</span></span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a><span class="in">nc &lt;- read_sf(file)</span></span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a><span class="in"># write nc to postgis:</span></span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a><span class="in">write_sf(nc, paste0("PG:dbname=postgis user=", Sys.getenv("DB_USERNAME"), " host=", Sys.getenv("DB_HOST")), "nc")</span></span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>Although GDAL has support for several spatial databases, and as</span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a>mentioned above it passes on SQL in the <span class="in">`query`</span> argument to the</span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>database, it is sometimes beneficial to directly read from and </span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>write to a spatial database using the DBI R database drivers for this. </span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a>An example of this is:</span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=has_PG}</span></span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a><span class="in">pg &lt;- DBI::dbConnect(</span></span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a><span class="in">    RPostgres::Postgres(),</span></span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a><span class="in">    host = Sys.getenv("DB_HOST"),</span></span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a><span class="in">    user = Sys.getenv("DB_USERNAME"),</span></span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a><span class="in">    dbname = "postgis")</span></span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a><span class="in">read_sf(pg, query = </span></span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a><span class="in">        "select BIR74,wkb_geometry from nc limit 3") |&gt; nrow()</span></span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a>where the database host and user name are obtained from environment</span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a>variables, and the database name is <span class="in">`postgis`</span>.</span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a>A spatial query might look like</span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=has_PG}</span></span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a><span class="in">q &lt;- "SELECT BIR74,wkb_geometry FROM nc WHERE \</span></span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a><span class="in">ST_Intersects(wkb_geometry, 'SRID=4267;POINT (-81.50 36.43)');"</span></span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a><span class="in">read_sf(pg, query = q) |&gt; nrow()</span></span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a>Here, the intersection is carried out inside the database, and uses a spatial</span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a>index when present.  The same mechanism works when using <span class="in">`dplyr`</span></span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a>with a database backend:</span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a>\index{sf!dbplyr proxy}</span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=has_PG}</span></span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr, warn.conflicts = FALSE)</span></span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a><span class="in">nc_db &lt;- tbl(pg, "nc")</span></span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a>Spatial queries can be formulated and are passed on to the database:</span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=has_PG}</span></span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a><span class="in">nc_db |&gt; </span></span>
<span id="cb19-167"><a href="#cb19-167" aria-hidden="true" tabindex="-1"></a><span class="in">     filter(ST_Intersects(wkb_geometry, </span></span>
<span id="cb19-168"><a href="#cb19-168" aria-hidden="true" tabindex="-1"></a><span class="in">                        'SRID=4267;POINT (-81.50 36.43)')) |&gt;</span></span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a><span class="in">     collect()</span></span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a><span class="in">nc_db |&gt; filter(ST_Area(wkb_geometry) &gt; 0.1) |&gt; head(3)</span></span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a>(Note that PostGIS' <span class="in">`ST_Area`</span> computes the same area as</span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a>the <span class="in">`AREA`</span> field in <span class="in">`nc`</span>, which is the meaningless value obtained by</span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a>interpreting the coordinates as projected, where they are ellipsoidal.)</span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-176"><a href="#cb19-176" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reading from online resources or web services {#sec-vsi}</span></span>
<span id="cb19-177"><a href="#cb19-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a>\index{st<span class="sc">\_</span>read!online resources}</span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a>GDAL drivers support reading from online resources, by prepending</span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a>the URL starting with <span class="in">`https://`</span> with <span class="in">`/vsicurl/`</span>.  A number of</span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a>similar drivers specialised for particular clouds include <span class="in">`/vsis3/`</span></span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a>for Amazon S3, <span class="in">`/vsigs/`</span>  for Google Cloud Storage, <span class="in">`/vsiaz/`</span> for</span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a>Azure, <span class="in">`/vsioss/`</span> for Alibaba Cloud, or <span class="in">`/vsiswift/`</span> for OpenStack</span>
<span id="cb19-185"><a href="#cb19-185" aria-hidden="true" tabindex="-1"></a>Swift Object Storage.  @sec-zarr has an example of using <span class="in">`/vsicurl/`</span>.</span>
<span id="cb19-186"><a href="#cb19-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-187"><a href="#cb19-187" aria-hidden="true" tabindex="-1"></a>These prepositions can be combined with <span class="in">`/vsizip/`</span> to read a file from a</span>
<span id="cb19-188"><a href="#cb19-188" aria-hidden="true" tabindex="-1"></a>zipped online resource. Depending on the file format used, reading</span>
<span id="cb19-189"><a href="#cb19-189" aria-hidden="true" tabindex="-1"></a>information this way may require reading the entire file, or reading</span>
<span id="cb19-190"><a href="#cb19-190" aria-hidden="true" tabindex="-1"></a>it multiple times, and may not always be the most efficient way of</span>
<span id="cb19-191"><a href="#cb19-191" aria-hidden="true" tabindex="-1"></a>handling resources. Cloud native formats are optimised to work</span>
<span id="cb19-192"><a href="#cb19-192" aria-hidden="true" tabindex="-1"></a>efficiently using <span class="in">`HTTP`</span> requests.</span>
<span id="cb19-193"><a href="#cb19-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-194"><a href="#cb19-194" aria-hidden="true" tabindex="-1"></a>\index{cloud native}</span>
<span id="cb19-195"><a href="#cb19-195" aria-hidden="true" tabindex="-1"></a>\index{cloud optimised}</span>
<span id="cb19-196"><a href="#cb19-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-197"><a href="#cb19-197" aria-hidden="true" tabindex="-1"></a><span class="fu">### APIs, OpenStreetMap</span></span>
<span id="cb19-198"><a href="#cb19-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-199"><a href="#cb19-199" aria-hidden="true" tabindex="-1"></a>\index{st<span class="sc">\_</span>read!OpenStreetMap}</span>
<span id="cb19-200"><a href="#cb19-200" aria-hidden="true" tabindex="-1"></a>\index{OpenStreetMap, reading}</span>
<span id="cb19-201"><a href="#cb19-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-202"><a href="#cb19-202" aria-hidden="true" tabindex="-1"></a>Typical web services for geospatial</span>
<span id="cb19-203"><a href="#cb19-203" aria-hidden="true" tabindex="-1"></a>data create data on the fly and give access to this through an API.</span>
<span id="cb19-204"><a href="#cb19-204" aria-hidden="true" tabindex="-1"></a>As an example, data from <span class="co">[</span><span class="ot">OpenStreetMap</span><span class="co">](https://openstreetmap.org/)</span></span>
<span id="cb19-205"><a href="#cb19-205" aria-hidden="true" tabindex="-1"></a>can be bulk downloaded and read locally, for instance using the GDAL vector</span>
<span id="cb19-206"><a href="#cb19-206" aria-hidden="true" tabindex="-1"></a>driver, but more typical a user wants to obtain a small subset of</span>
<span id="cb19-207"><a href="#cb19-207" aria-hidden="true" tabindex="-1"></a>the data or use the data for a small query. Several R packages exist</span>
<span id="cb19-208"><a href="#cb19-208" aria-hidden="true" tabindex="-1"></a>that query OpenStreetMap data: </span>
<span id="cb19-209"><a href="#cb19-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-210"><a href="#cb19-210" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Package **OpenStreetMap** <span class="co">[</span><span class="ot">@R-OpenStreetMap</span><span class="co">]</span> downloads data as raster tiles, typically</span>
<span id="cb19-211"><a href="#cb19-211" aria-hidden="true" tabindex="-1"></a>  used as backdrop or reference for plotting other features</span>
<span id="cb19-212"><a href="#cb19-212" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Package **osmdata** <span class="co">[</span><span class="ot">@osmdata</span><span class="co">]</span> downloads vector data as points, lines, or polygons</span>
<span id="cb19-213"><a href="#cb19-213" aria-hidden="true" tabindex="-1"></a>  in **sf** or **sp** format</span>
<span id="cb19-214"><a href="#cb19-214" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Package **osmar** (from CRAN <span class="co">[</span><span class="ot">archive</span><span class="co">](https://cran.r-project.org/web/packages/osmar/index.html)</span>) returns vector data, but in addition the network</span>
<span id="cb19-215"><a href="#cb19-215" aria-hidden="true" tabindex="-1"></a>  topology (as an <span class="in">`igraph`</span> object) that contains how road elements</span>
<span id="cb19-216"><a href="#cb19-216" aria-hidden="true" tabindex="-1"></a>  are connected, and has functions for computing the shortest route</span>
<span id="cb19-217"><a href="#cb19-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-218"><a href="#cb19-218" aria-hidden="true" tabindex="-1"></a>When provided with a correctly formulated API call in the URL the</span>
<span id="cb19-219"><a href="#cb19-219" aria-hidden="true" tabindex="-1"></a>highly configurable GDAL OSM driver (in <span class="in">`st_read`</span>) can read an</span>
<span id="cb19-220"><a href="#cb19-220" aria-hidden="true" tabindex="-1"></a>".osm" file (xml) and return a dataset with five layers: <span class="in">`points`</span></span>
<span id="cb19-221"><a href="#cb19-221" aria-hidden="true" tabindex="-1"></a>that have significant tags, <span class="in">`lines`</span> with non-area "way" features,</span>
<span id="cb19-222"><a href="#cb19-222" aria-hidden="true" tabindex="-1"></a><span class="in">`multilinestrings`</span> with "relation" features, <span class="in">`multipolygons`</span> with</span>
<span id="cb19-223"><a href="#cb19-223" aria-hidden="true" tabindex="-1"></a>"relation" features , and <span class="in">`other_relations`</span>. A simple and very small</span>
<span id="cb19-224"><a href="#cb19-224" aria-hidden="true" tabindex="-1"></a>bounding box query to OpenStreetMap could look like</span>
<span id="cb19-225"><a href="#cb19-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-226"><a href="#cb19-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb19-227"><a href="#cb19-227" aria-hidden="true" tabindex="-1"></a><span class="in">download.file(paste0("https://openstreetmap.org/api/0.6/map?",</span></span>
<span id="cb19-228"><a href="#cb19-228" aria-hidden="true" tabindex="-1"></a><span class="in">       "bbox=7.595,51.969,7.598,51.970"),</span></span>
<span id="cb19-229"><a href="#cb19-229" aria-hidden="true" tabindex="-1"></a><span class="in">    "data/ms.osm", method = "auto")</span></span>
<span id="cb19-230"><a href="#cb19-230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-231"><a href="#cb19-231" aria-hidden="true" tabindex="-1"></a>and from this file we can read the layer <span class="in">`lines`</span>, and plot its</span>
<span id="cb19-232"><a href="#cb19-232" aria-hidden="true" tabindex="-1"></a>first attribute by</span>
<span id="cb19-233"><a href="#cb19-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-overpass}</span></span>
<span id="cb19-234"><a href="#cb19-234" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "OpenStreetMap vector data"</span></span>
<span id="cb19-235"><a href="#cb19-235" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.height: 5</span></span>
<span id="cb19-236"><a href="#cb19-236" aria-hidden="true" tabindex="-1"></a><span class="in">o &lt;- read_sf("data/ms.osm", "lines")</span></span>
<span id="cb19-237"><a href="#cb19-237" aria-hidden="true" tabindex="-1"></a><span class="in">p &lt;- read_sf("data/ms.osm", "multipolygons")</span></span>
<span id="cb19-238"><a href="#cb19-238" aria-hidden="true" tabindex="-1"></a><span class="in">st_bbox(c(xmin = 7.595, ymin = 51.969, </span></span>
<span id="cb19-239"><a href="#cb19-239" aria-hidden="true" tabindex="-1"></a><span class="in">          xmax = 7.598, ymax = 51.970), crs = 'OGC:CRS84') |&gt;</span></span>
<span id="cb19-240"><a href="#cb19-240" aria-hidden="true" tabindex="-1"></a><span class="in">    st_as_sfc() |&gt;</span></span>
<span id="cb19-241"><a href="#cb19-241" aria-hidden="true" tabindex="-1"></a><span class="in">    plot(axes = TRUE, lwd = 2, lty = 2, cex.axis = .5)</span></span>
<span id="cb19-242"><a href="#cb19-242" aria-hidden="true" tabindex="-1"></a><span class="in">plot(o[,1], lwd = 2, add = TRUE)</span></span>
<span id="cb19-243"><a href="#cb19-243" aria-hidden="true" tabindex="-1"></a><span class="in">plot(st_geometry(p), border = NA, col = '#88888888', add = TRUE)</span></span>
<span id="cb19-244"><a href="#cb19-244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-245"><a href="#cb19-245" aria-hidden="true" tabindex="-1"></a>the result of which is shown in @fig-overpass.</span>
<span id="cb19-246"><a href="#cb19-246" aria-hidden="true" tabindex="-1"></a>The overpass API provides a more generic and powerful query</span>
<span id="cb19-247"><a href="#cb19-247" aria-hidden="true" tabindex="-1"></a>functionality to OpenStreetMap data.</span>
<span id="cb19-248"><a href="#cb19-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-249"><a href="#cb19-249" aria-hidden="true" tabindex="-1"></a><span class="fu">### GeoParquet and GeoArrow</span></span>
<span id="cb19-250"><a href="#cb19-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-251"><a href="#cb19-251" aria-hidden="true" tabindex="-1"></a>\index{geoparquet}</span>
<span id="cb19-252"><a href="#cb19-252" aria-hidden="true" tabindex="-1"></a>\index{parquet}</span>
<span id="cb19-253"><a href="#cb19-253" aria-hidden="true" tabindex="-1"></a>\index{geoarrow}</span>
<span id="cb19-254"><a href="#cb19-254" aria-hidden="true" tabindex="-1"></a>\index{arrow}</span>
<span id="cb19-255"><a href="#cb19-255" aria-hidden="true" tabindex="-1"></a>\index{st<span class="sc">\_</span>read!geoparquet}</span>
<span id="cb19-256"><a href="#cb19-256" aria-hidden="true" tabindex="-1"></a>\index{st<span class="sc">\_</span>read~geoarrow}</span>
<span id="cb19-257"><a href="#cb19-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-258"><a href="#cb19-258" aria-hidden="true" tabindex="-1"></a>Two formats dedicated to cloud native analysis are derived from</span>
<span id="cb19-259"><a href="#cb19-259" aria-hidden="true" tabindex="-1"></a>the Apache projects Parquet and Arrow. Both provide column oriented</span>
<span id="cb19-260"><a href="#cb19-260" aria-hidden="true" tabindex="-1"></a>storage of tabular data, meaning that the reading of a single field</span>
<span id="cb19-261"><a href="#cb19-261" aria-hidden="true" tabindex="-1"></a>for many records is fast, compared to record oriented storage of</span>
<span id="cb19-262"><a href="#cb19-262" aria-hidden="true" tabindex="-1"></a>most other databases.  The Geo- extensions of both involve </span>
<span id="cb19-263"><a href="#cb19-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-264"><a href="#cb19-264" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>a way of storing a geometry column, either in a well-known binary</span>
<span id="cb19-265"><a href="#cb19-265" aria-hidden="true" tabindex="-1"></a>  or text form, or in a more efficient form where sub-geometries</span>
<span id="cb19-266"><a href="#cb19-266" aria-hidden="true" tabindex="-1"></a>  are indexed up front</span>
<span id="cb19-267"><a href="#cb19-267" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>storage of a coordinate reference system.</span>
<span id="cb19-268"><a href="#cb19-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-269"><a href="#cb19-269" aria-hidden="true" tabindex="-1"></a>At the time of writing this book, both formats are under active</span>
<span id="cb19-270"><a href="#cb19-270" aria-hidden="true" tabindex="-1"></a>development, but drivers for reading or creating them are available in</span>
<span id="cb19-271"><a href="#cb19-271" aria-hidden="true" tabindex="-1"></a>GDAL starting from version 3.5. Both formats allow for compressed</span>
<span id="cb19-272"><a href="#cb19-272" aria-hidden="true" tabindex="-1"></a>storage. The difference is that (Geo)Parquet is more oriented</span>
<span id="cb19-273"><a href="#cb19-273" aria-hidden="true" tabindex="-1"></a>towards persistent storage, where, (Geo)Arrow is more oriented to</span>
<span id="cb19-274"><a href="#cb19-274" aria-hidden="true" tabindex="-1"></a>fast access and fast computation. Arrow can for instance be both</span>
<span id="cb19-275"><a href="#cb19-275" aria-hidden="true" tabindex="-1"></a>an in-memory and an on-disk format.</span>
<span id="cb19-276"><a href="#cb19-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-277"><a href="#cb19-277" aria-hidden="true" tabindex="-1"></a><span class="fu">## Raster data: **stars**</span></span>
<span id="cb19-278"><a href="#cb19-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-279"><a href="#cb19-279" aria-hidden="true" tabindex="-1"></a>A common challenge with raster datasets is not only that they come</span>
<span id="cb19-280"><a href="#cb19-280" aria-hidden="true" tabindex="-1"></a>in large files (single Sentinel-2 tiles are around 1 GB), but that</span>
<span id="cb19-281"><a href="#cb19-281" aria-hidden="true" tabindex="-1"></a>many of these files, potentially thousands or millions, are needed to address</span>
<span id="cb19-282"><a href="#cb19-282" aria-hidden="true" tabindex="-1"></a>the area and time period of interest. In 2022, </span>
<span id="cb19-283"><a href="#cb19-283" aria-hidden="true" tabindex="-1"></a>Copernicus, the program that runs all Sentinel satellites, published 160</span>
<span id="cb19-284"><a href="#cb19-284" aria-hidden="true" tabindex="-1"></a>TB of images per day.  This means that a classic pattern in using R</span>
<span id="cb19-285"><a href="#cb19-285" aria-hidden="true" tabindex="-1"></a>consisting of downloading data to local disc, loading the data in</span>
<span id="cb19-286"><a href="#cb19-286" aria-hidden="true" tabindex="-1"></a>memory, and analysing it is not going to work.</span>
<span id="cb19-287"><a href="#cb19-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-288"><a href="#cb19-288" aria-hidden="true" tabindex="-1"></a>\index{Google Earth Engine}</span>
<span id="cb19-289"><a href="#cb19-289" aria-hidden="true" tabindex="-1"></a>\index{Sentinel Hub}</span>
<span id="cb19-290"><a href="#cb19-290" aria-hidden="true" tabindex="-1"></a>\index{openEO cloud}</span>
<span id="cb19-291"><a href="#cb19-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-292"><a href="#cb19-292" aria-hidden="true" tabindex="-1"></a>Cloud-based Earth Observation processing platforms like Google Earth</span>
<span id="cb19-293"><a href="#cb19-293" aria-hidden="true" tabindex="-1"></a>Engine <span class="co">[</span><span class="ot">@gorelick</span><span class="co">]</span>, <span class="co">[</span><span class="ot">Sentinel Hub</span><span class="co">](https://www.sentinel-hub.com/)</span> or</span>
<span id="cb19-294"><a href="#cb19-294" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">openEO.cloud</span><span class="co">](https://openeo.cloud)</span> recognise this and let users</span>
<span id="cb19-295"><a href="#cb19-295" aria-hidden="true" tabindex="-1"></a>work with datasets up to the petabyte range rather easily and with</span>
<span id="cb19-296"><a href="#cb19-296" aria-hidden="true" tabindex="-1"></a>a great deal of interactivity. They share the following properties:</span>
<span id="cb19-297"><a href="#cb19-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-298"><a href="#cb19-298" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>computations are postponed as long as possible (lazy evaluation)</span>
<span id="cb19-299"><a href="#cb19-299" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>only the data asked for by the user is being computed and returned, and nothing more</span>
<span id="cb19-300"><a href="#cb19-300" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>storing intermediate results is avoided in favour of on-the-fly computations</span>
<span id="cb19-301"><a href="#cb19-301" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>maps with useful results are generated and shown quickly to allow for interactive model development</span>
<span id="cb19-302"><a href="#cb19-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-303"><a href="#cb19-303" aria-hidden="true" tabindex="-1"></a>This is similar to the **dbplyr** interface to databases and</span>
<span id="cb19-304"><a href="#cb19-304" aria-hidden="true" tabindex="-1"></a>cloud-based analytics environments, but differs in the aspect of</span>
<span id="cb19-305"><a href="#cb19-305" aria-hidden="true" tabindex="-1"></a>_what_ we want to see quickly: rather than the first $n$ records of a</span>
<span id="cb19-306"><a href="#cb19-306" aria-hidden="true" tabindex="-1"></a>**dbplyr** lazy table, we want a quick _overview_ of the results,</span>
<span id="cb19-307"><a href="#cb19-307" aria-hidden="true" tabindex="-1"></a>in the form of a map covering the whole area, or part of it, but</span>
<span id="cb19-308"><a href="#cb19-308" aria-hidden="true" tabindex="-1"></a>at screen resolution rather than native (observation) resolution.</span>
<span id="cb19-309"><a href="#cb19-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-310"><a href="#cb19-310" aria-hidden="true" tabindex="-1"></a>\index{raster!resolution}</span>
<span id="cb19-311"><a href="#cb19-311" aria-hidden="true" tabindex="-1"></a>\index{resolution!low-resolution computation}</span>
<span id="cb19-312"><a href="#cb19-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-313"><a href="#cb19-313" aria-hidden="true" tabindex="-1"></a>If for instance we want to "see" results for the United States on</span>
<span id="cb19-314"><a href="#cb19-314" aria-hidden="true" tabindex="-1"></a>a screen with 1000 $\times$ 1000 pixels, we only need to compute results</span>
<span id="cb19-315"><a href="#cb19-315" aria-hidden="true" tabindex="-1"></a>for this many pixels, which corresponds roughly to data</span>
<span id="cb19-316"><a href="#cb19-316" aria-hidden="true" tabindex="-1"></a>on a grid with 3000 m $\times$ 3000 m grid cells.  For Sentinel-2</span>
<span id="cb19-317"><a href="#cb19-317" aria-hidden="true" tabindex="-1"></a>data with 10 m resolution, this means we can downsample with</span>
<span id="cb19-318"><a href="#cb19-318" aria-hidden="true" tabindex="-1"></a>a factor 300, giving 3 km $\times$ 3 km resolution.  Processing,</span>
<span id="cb19-319"><a href="#cb19-319" aria-hidden="true" tabindex="-1"></a>storage, and network requirements then drop a factor $300^2 \approx 10^5$, compared</span>
<span id="cb19-320"><a href="#cb19-320" aria-hidden="true" tabindex="-1"></a>to working on the native 10 m $\times$ 10 m resolution. On the platforms</span>
<span id="cb19-321"><a href="#cb19-321" aria-hidden="true" tabindex="-1"></a>mentioned, zooming in the map triggers further computations on a</span>
<span id="cb19-322"><a href="#cb19-322" aria-hidden="true" tabindex="-1"></a>finer resolution and smaller extent.</span>
<span id="cb19-323"><a href="#cb19-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-324"><a href="#cb19-324" aria-hidden="true" tabindex="-1"></a>A simple optimisation that follows these lines is how the plot method</span>
<span id="cb19-325"><a href="#cb19-325" aria-hidden="true" tabindex="-1"></a>for <span class="in">`stars`</span> objects works.  In the case of plotting large rasters,</span>
<span id="cb19-326"><a href="#cb19-326" aria-hidden="true" tabindex="-1"></a>it downsamples the array before it plots, drastically saving time.</span>
<span id="cb19-327"><a href="#cb19-327" aria-hidden="true" tabindex="-1"></a>The degree of downsampling is derived from the plotting region size</span>
<span id="cb19-328"><a href="#cb19-328" aria-hidden="true" tabindex="-1"></a>and the plotting resolution (pixel density). For vector devices,</span>
<span id="cb19-329"><a href="#cb19-329" aria-hidden="true" tabindex="-1"></a>such as pdf, R sets plot resolution to 75 dpi, corresponding to</span>
<span id="cb19-330"><a href="#cb19-330" aria-hidden="true" tabindex="-1"></a>0.3 mm per pixel. Enlarging plots may reveal this, but replotting</span>
<span id="cb19-331"><a href="#cb19-331" aria-hidden="true" tabindex="-1"></a>to an enlarged devices will create a plot at target density. For</span>
<span id="cb19-332"><a href="#cb19-332" aria-hidden="true" tabindex="-1"></a><span class="in">`geom_stars`</span> the user has to specify the <span class="in">`downsample`</span> rate, because</span>
<span id="cb19-333"><a href="#cb19-333" aria-hidden="true" tabindex="-1"></a>the **ggplot2** does not make the device size available to that</span>
<span id="cb19-334"><a href="#cb19-334" aria-hidden="true" tabindex="-1"></a>function.</span>
<span id="cb19-335"><a href="#cb19-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-336"><a href="#cb19-336" aria-hidden="true" tabindex="-1"></a><span class="fu">### `stars` proxy objects</span></span>
<span id="cb19-337"><a href="#cb19-337" aria-hidden="true" tabindex="-1"></a>\index{stars!proxy objects}</span>
<span id="cb19-338"><a href="#cb19-338" aria-hidden="true" tabindex="-1"></a>\index{read<span class="sc">\_</span>stars!proxy objects}</span>
<span id="cb19-339"><a href="#cb19-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-340"><a href="#cb19-340" aria-hidden="true" tabindex="-1"></a>To handle datasets that are too large to fit in memory, **stars**</span>
<span id="cb19-341"><a href="#cb19-341" aria-hidden="true" tabindex="-1"></a>provides <span class="in">`stars_proxy`</span> objects.  To demonstrate its use, we will</span>
<span id="cb19-342"><a href="#cb19-342" aria-hidden="true" tabindex="-1"></a>use the **starsdata** package, an R data package with larger datasets</span>
<span id="cb19-343"><a href="#cb19-343" aria-hidden="true" tabindex="-1"></a>(around 1 GB total). It can be installed by</span>
<span id="cb19-344"><a href="#cb19-344" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb19-345"><a href="#cb19-345" aria-hidden="true" tabindex="-1"></a><span class="in">options(timeout = 600) # or larger in case of slow network</span></span>
<span id="cb19-346"><a href="#cb19-346" aria-hidden="true" tabindex="-1"></a><span class="in">install.packages("starsdata", </span></span>
<span id="cb19-347"><a href="#cb19-347" aria-hidden="true" tabindex="-1"></a><span class="in">  repos = "http://cran.uni-muenster.de/pebesma/", type = "source")</span></span>
<span id="cb19-348"><a href="#cb19-348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-349"><a href="#cb19-349" aria-hidden="true" tabindex="-1"></a>We can "load" a Sentinel-2 image from it by</span>
<span id="cb19-352"><a href="#cb19-352" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-353"><a href="#cb19-353" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars) <span class="sc">|&gt;</span> <span class="fu">suppressPackageStartupMessages</span>()</span>
<span id="cb19-354"><a href="#cb19-354" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"sentinel/S2A_MSIL1C_20180220T105051_N0206"</span>,</span>
<span id="cb19-355"><a href="#cb19-355" aria-hidden="true" tabindex="-1"></a>           <span class="st">"_R051_T32ULE_20180221T134037.zip"</span>)</span>
<span id="cb19-356"><a href="#cb19-356" aria-hidden="true" tabindex="-1"></a>granule <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="at">file =</span> f, <span class="at">package =</span> <span class="st">"starsdata"</span>)</span>
<span id="cb19-357"><a href="#cb19-357" aria-hidden="true" tabindex="-1"></a><span class="fu">file.size</span>(granule)</span>
<span id="cb19-358"><a href="#cb19-358" aria-hidden="true" tabindex="-1"></a>base_name <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(<span class="fu">basename</span>(granule), <span class="st">".zip"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb19-359"><a href="#cb19-359" aria-hidden="true" tabindex="-1"></a>s2 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"SENTINEL2_L1C:/vsizip/"</span>, granule, <span class="st">"/"</span>, base_name, </span>
<span id="cb19-360"><a href="#cb19-360" aria-hidden="true" tabindex="-1"></a>    <span class="st">".SAFE/MTD_MSIL1C.xml:10m:EPSG_32632"</span>)</span>
<span id="cb19-361"><a href="#cb19-361" aria-hidden="true" tabindex="-1"></a>(p <span class="ot">&lt;-</span> <span class="fu">read_stars</span>(s2, <span class="at">proxy =</span> <span class="cn">TRUE</span>))</span>
<span id="cb19-362"><a href="#cb19-362" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(p)</span>
<span id="cb19-363"><a href="#cb19-363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-364"><a href="#cb19-364" aria-hidden="true" tabindex="-1"></a>and we see that this does not actually load _any_ of the pixel</span>
<span id="cb19-365"><a href="#cb19-365" aria-hidden="true" tabindex="-1"></a>values but keeps the reference to the dataset and fills the</span>
<span id="cb19-366"><a href="#cb19-366" aria-hidden="true" tabindex="-1"></a>dimensions table. (The convoluted <span class="in">`s2`</span> name is needed to point</span>
<span id="cb19-367"><a href="#cb19-367" aria-hidden="true" tabindex="-1"></a>GDAL to the right file inside the <span class="in">`.zip`</span> file containing 115 files</span>
<span id="cb19-368"><a href="#cb19-368" aria-hidden="true" tabindex="-1"></a>in total).</span>
<span id="cb19-369"><a href="#cb19-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-370"><a href="#cb19-370" aria-hidden="true" tabindex="-1"></a>\index{stars!lazy evaluation}</span>
<span id="cb19-371"><a href="#cb19-371" aria-hidden="true" tabindex="-1"></a>\index{lazy evaluation of computations}</span>
<span id="cb19-372"><a href="#cb19-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-373"><a href="#cb19-373" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb19-374"><a href="#cb19-374" aria-hidden="true" tabindex="-1"></a>The idea of a proxy object is that we can build expressions like</span>
<span id="cb19-377"><a href="#cb19-377" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-378"><a href="#cb19-378" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> p <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb19-379"><a href="#cb19-379" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-380"><a href="#cb19-380" aria-hidden="true" tabindex="-1"></a>but that the computations for this are postponed. Only when we</span>
<span id="cb19-381"><a href="#cb19-381" aria-hidden="true" tabindex="-1"></a>really need the data, is <span class="in">`p * 2`</span> evaluated.  We need data when we:</span>
<span id="cb19-382"><a href="#cb19-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-383"><a href="#cb19-383" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`plot`</span> data,</span>
<span id="cb19-384"><a href="#cb19-384" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>write an object to disk, with <span class="in">`write_stars`</span>, or</span>
<span id="cb19-385"><a href="#cb19-385" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>explicitly load an object in memory, with <span class="in">`st_as_stars`</span></span>
<span id="cb19-386"><a href="#cb19-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-387"><a href="#cb19-387" aria-hidden="true" tabindex="-1"></a>In case the entire object does not fit in memory, <span class="in">`plot`</span> and</span>
<span id="cb19-388"><a href="#cb19-388" aria-hidden="true" tabindex="-1"></a><span class="in">`write_stars`</span> choose different strategies to deal with this:</span>
<span id="cb19-389"><a href="#cb19-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-390"><a href="#cb19-390" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`plot`</span> fetches only the pixels that can be seen by downsampling, rather than reading all</span>
<span id="cb19-391"><a href="#cb19-391" aria-hidden="true" tabindex="-1"></a>pixels available</span>
<span id="cb19-392"><a href="#cb19-392" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`write_stars`</span> reads, processes, and writes data chunk-by-chunk</span>
<span id="cb19-393"><a href="#cb19-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-394"><a href="#cb19-394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-plotp, echo=!knitr::is_latex_output(), message=!knitr::is_latex_output()}</span></span>
<span id="cb19-395"><a href="#cb19-395" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Downsampled 10 m bands of a Sentinel-2 scene"</span></span>
<span id="cb19-396"><a href="#cb19-396" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb19-397"><a href="#cb19-397" aria-hidden="true" tabindex="-1"></a><span class="in">plot(p)</span></span>
<span id="cb19-398"><a href="#cb19-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-399"><a href="#cb19-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-400"><a href="#cb19-400" aria-hidden="true" tabindex="-1"></a>Downsampling and chunking is implemented for spatially dense images,</span>
<span id="cb19-401"><a href="#cb19-401" aria-hidden="true" tabindex="-1"></a>but not for dense time series or other dense dimensions. </span>
<span id="cb19-402"><a href="#cb19-402" aria-hidden="true" tabindex="-1"></a>As an example, the output of <span class="in">`plot(p)`</span>, shown in @fig-plotp </span>
<span id="cb19-403"><a href="#cb19-403" aria-hidden="true" tabindex="-1"></a>only fetches the pixels that can be seen on the plot device, rather</span>
<span id="cb19-404"><a href="#cb19-404" aria-hidden="true" tabindex="-1"></a>than the 10980 $\times$ 10980 pixels available in each band. The downsampling</span>
<span id="cb19-405"><a href="#cb19-405" aria-hidden="true" tabindex="-1"></a>ratio taken is</span>
<span id="cb19-406"><a href="#cb19-406" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=!knitr::is_latex_output()}</span></span>
<span id="cb19-407"><a href="#cb19-407" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb19-408"><a href="#cb19-408" aria-hidden="true" tabindex="-1"></a><span class="in">(ds &lt;- floor(sqrt(prod(dim(p)) / prod(dev.size("px")))))</span></span>
<span id="cb19-409"><a href="#cb19-409" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-410"><a href="#cb19-410" aria-hidden="true" tabindex="-1"></a>meaning that for every <span class="in">`r ds`</span> $\times$ <span class="in">`r ds`</span> sub-image in the</span>
<span id="cb19-411"><a href="#cb19-411" aria-hidden="true" tabindex="-1"></a>original image, only one pixel is read and plotted.</span>
<span id="cb19-412"><a href="#cb19-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-413"><a href="#cb19-413" aria-hidden="true" tabindex="-1"></a><span class="fu">### Operations on proxy objects</span></span>
<span id="cb19-414"><a href="#cb19-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-415"><a href="#cb19-415" aria-hidden="true" tabindex="-1"></a>\index{stars<span class="sc">\_</span>proxy!lazy operations}</span>
<span id="cb19-416"><a href="#cb19-416" aria-hidden="true" tabindex="-1"></a>Several dedicated methods are available for <span class="in">`stars_proxy`</span> objects:</span>
<span id="cb19-419"><a href="#cb19-419" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-420"><a href="#cb19-420" aria-hidden="true" tabindex="-1"></a><span class="fu">methods</span>(<span class="at">class =</span> <span class="st">"stars_proxy"</span>)</span>
<span id="cb19-421"><a href="#cb19-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-422"><a href="#cb19-422" aria-hidden="true" tabindex="-1"></a>We have seen <span class="in">`plot`</span> and <span class="in">`print`</span> in action; <span class="in">`dim`</span> reads out</span>
<span id="cb19-423"><a href="#cb19-423" aria-hidden="true" tabindex="-1"></a>the dimension from the dimensions metadata table. </span>
<span id="cb19-424"><a href="#cb19-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-425"><a href="#cb19-425" aria-hidden="true" tabindex="-1"></a>\index{stars<span class="sc">\_</span>proxy!st<span class="sc">\_</span>as<span class="sc">\_</span>stars}</span>
<span id="cb19-426"><a href="#cb19-426" aria-hidden="true" tabindex="-1"></a>\index{st<span class="sc">\_</span>as<span class="sc">\_</span>stars}</span>
<span id="cb19-427"><a href="#cb19-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-428"><a href="#cb19-428" aria-hidden="true" tabindex="-1"></a>The three methods that actually fetch data are <span class="in">`st_as_stars`</span>,</span>
<span id="cb19-429"><a href="#cb19-429" aria-hidden="true" tabindex="-1"></a><span class="in">`plot`</span> and <span class="in">`write_stars`</span>.  <span class="in">`st_as_stars`</span> reads the actual data into a</span>
<span id="cb19-430"><a href="#cb19-430" aria-hidden="true" tabindex="-1"></a><span class="in">`stars`</span> object, its argument <span class="in">`downsample`</span> controls the downsampling</span>
<span id="cb19-431"><a href="#cb19-431" aria-hidden="true" tabindex="-1"></a>rate. <span class="in">`plot`</span> does this too, choosing an appropriate <span class="in">`downsample`</span></span>
<span id="cb19-432"><a href="#cb19-432" aria-hidden="true" tabindex="-1"></a>value from the device resolution, and plots the object. <span class="in">`write_stars`</span></span>
<span id="cb19-433"><a href="#cb19-433" aria-hidden="true" tabindex="-1"></a>writes a <span class="in">`stars_proxy`</span> object to disk.</span>
<span id="cb19-434"><a href="#cb19-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-435"><a href="#cb19-435" aria-hidden="true" tabindex="-1"></a>All other methods for <span class="in">`stars_proxy`</span> objects do not actually operate</span>
<span id="cb19-436"><a href="#cb19-436" aria-hidden="true" tabindex="-1"></a>on the raster data but add the operations to a _to do_ list</span>
<span id="cb19-437"><a href="#cb19-437" aria-hidden="true" tabindex="-1"></a>attached to the object. Only when actual raster data are fetched,</span>
<span id="cb19-438"><a href="#cb19-438" aria-hidden="true" tabindex="-1"></a>for instance when <span class="in">`plot`</span> or <span class="in">`st_as_stars`</span> are called, the commands</span>
<span id="cb19-439"><a href="#cb19-439" aria-hidden="true" tabindex="-1"></a>in this list are executed.</span>
<span id="cb19-440"><a href="#cb19-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-441"><a href="#cb19-441" aria-hidden="true" tabindex="-1"></a>\index{st<span class="sc">\_</span>crop!stars<span class="sc">\_</span>proxy}</span>
<span id="cb19-442"><a href="#cb19-442" aria-hidden="true" tabindex="-1"></a><span class="in">`st_crop`</span> limits the extent (area) of the raster that will be</span>
<span id="cb19-443"><a href="#cb19-443" aria-hidden="true" tabindex="-1"></a>read. <span class="in">`c`</span> combines <span class="in">`stars_proxy`</span> objects, but still doesn't read</span>
<span id="cb19-444"><a href="#cb19-444" aria-hidden="true" tabindex="-1"></a>any data. <span class="in">`adrop`</span> drops empty dimensions and <span class="in">`aperm`</span> can change dimension</span>
<span id="cb19-445"><a href="#cb19-445" aria-hidden="true" tabindex="-1"></a>order.</span>
<span id="cb19-446"><a href="#cb19-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-447"><a href="#cb19-447" aria-hidden="true" tabindex="-1"></a><span class="in">`write_stars`</span> reads and processes its input chunk-wise; it has an</span>
<span id="cb19-448"><a href="#cb19-448" aria-hidden="true" tabindex="-1"></a>argument <span class="in">`chunk_size`</span> that lets users control the size of spatial</span>
<span id="cb19-449"><a href="#cb19-449" aria-hidden="true" tabindex="-1"></a>chunks.</span>
<span id="cb19-450"><a href="#cb19-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-451"><a href="#cb19-451" aria-hidden="true" tabindex="-1"></a><span class="fu">### Remote raster resources</span></span>
<span id="cb19-452"><a href="#cb19-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-453"><a href="#cb19-453" aria-hidden="true" tabindex="-1"></a>\index{cloud-optimised GeoTIFF}</span>
<span id="cb19-454"><a href="#cb19-454" aria-hidden="true" tabindex="-1"></a>\index{GeoTIFF!cloud-optimised}</span>
<span id="cb19-455"><a href="#cb19-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-456"><a href="#cb19-456" aria-hidden="true" tabindex="-1"></a>A format like "cloud-optimised GeoTIFF" (COG) has been specially</span>
<span id="cb19-457"><a href="#cb19-457" aria-hidden="true" tabindex="-1"></a>designed to be efficient and resource-friendly in many cases,</span>
<span id="cb19-458"><a href="#cb19-458" aria-hidden="true" tabindex="-1"></a>e.g., for only reading the metadata, or for only reading overviews</span>
<span id="cb19-459"><a href="#cb19-459" aria-hidden="true" tabindex="-1"></a>(low-resolution versions of the full imagery) or spatial regions</span>
<span id="cb19-460"><a href="#cb19-460" aria-hidden="true" tabindex="-1"></a>using the <span class="in">`/vsixxx/`</span> mechanisms (@sec-vsi). COGs can also</span>
<span id="cb19-461"><a href="#cb19-461" aria-hidden="true" tabindex="-1"></a>be created using the GeoTIFF driver of GDAL, and setting the right</span>
<span id="cb19-462"><a href="#cb19-462" aria-hidden="true" tabindex="-1"></a>dataset creation options in a <span class="in">`write_stars`</span> call.</span>
<span id="cb19-463"><a href="#cb19-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-464"><a href="#cb19-464" aria-hidden="true" tabindex="-1"></a><span class="fu">## Very large data cubes</span></span>
<span id="cb19-465"><a href="#cb19-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-466"><a href="#cb19-466" aria-hidden="true" tabindex="-1"></a>\index{ERA5}</span>
<span id="cb19-467"><a href="#cb19-467" aria-hidden="true" tabindex="-1"></a>\index{Copernicus}</span>
<span id="cb19-468"><a href="#cb19-468" aria-hidden="true" tabindex="-1"></a>\index{Landsat}</span>
<span id="cb19-469"><a href="#cb19-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-470"><a href="#cb19-470" aria-hidden="true" tabindex="-1"></a>At some stage, datasets need to be analysed that are so large that</span>
<span id="cb19-471"><a href="#cb19-471" aria-hidden="true" tabindex="-1"></a>downloading them is no longer feasible; even when local storage would</span>
<span id="cb19-472"><a href="#cb19-472" aria-hidden="true" tabindex="-1"></a>be sufficient, network bandwidth may become limiting. Examples are</span>
<span id="cb19-473"><a href="#cb19-473" aria-hidden="true" tabindex="-1"></a>satellite image archives such as those from Landsat and Copernicus</span>
<span id="cb19-474"><a href="#cb19-474" aria-hidden="true" tabindex="-1"></a>(Sentinel-x), or model computations such as the ERA5 <span class="co">[</span><span class="ot">@era5</span><span class="co">]</span>, a</span>
<span id="cb19-475"><a href="#cb19-475" aria-hidden="true" tabindex="-1"></a>model reanalysis of the global atmosphere, land surface, and ocean</span>
<span id="cb19-476"><a href="#cb19-476" aria-hidden="true" tabindex="-1"></a>waves from 1950 onwards. In such cases it may be most helpful to gain</span>
<span id="cb19-477"><a href="#cb19-477" aria-hidden="true" tabindex="-1"></a>access to virtual machines in a cloud that have these data available,</span>
<span id="cb19-478"><a href="#cb19-478" aria-hidden="true" tabindex="-1"></a>or to use a system that lets the user carry out computations without</span>
<span id="cb19-479"><a href="#cb19-479" aria-hidden="true" tabindex="-1"></a>having to worry about virtual machines and storage. Both options</span>
<span id="cb19-480"><a href="#cb19-480" aria-hidden="true" tabindex="-1"></a>will be discussed.</span>
<span id="cb19-481"><a href="#cb19-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-482"><a href="#cb19-482" aria-hidden="true" tabindex="-1"></a><span class="fu">### Finding and processing assets</span></span>
<span id="cb19-483"><a href="#cb19-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-484"><a href="#cb19-484" aria-hidden="true" tabindex="-1"></a>When working on a virtual machine on a cloud, a first task is usually</span>
<span id="cb19-485"><a href="#cb19-485" aria-hidden="true" tabindex="-1"></a>to find the assets (files) to work on. It looks attractive to obtain</span>
<span id="cb19-486"><a href="#cb19-486" aria-hidden="true" tabindex="-1"></a>a file listing, and then parse file names such as</span>
<span id="cb19-487"><a href="#cb19-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-488"><a href="#cb19-488" aria-hidden="true" tabindex="-1"></a><span class="in">S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.zip</span></span>
<span id="cb19-489"><a href="#cb19-489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-490"><a href="#cb19-490" aria-hidden="true" tabindex="-1"></a>for their metadata including the date of acquisition and the code</span>
<span id="cb19-491"><a href="#cb19-491" aria-hidden="true" tabindex="-1"></a>of the spatial tile covered. Obtaining such a file listing however</span>
<span id="cb19-492"><a href="#cb19-492" aria-hidden="true" tabindex="-1"></a>is usually computationally very demanding, as is the processing of</span>
<span id="cb19-493"><a href="#cb19-493" aria-hidden="true" tabindex="-1"></a>the result, when the number of tiles runs in the many millions.</span>
<span id="cb19-494"><a href="#cb19-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-495"><a href="#cb19-495" aria-hidden="true" tabindex="-1"></a>A solution to this is to use a catalogue. The recently developed</span>
<span id="cb19-496"><a href="#cb19-496" aria-hidden="true" tabindex="-1"></a>and increasingly deployed STAC, short for _spatiotemporal asset</span>
<span id="cb19-497"><a href="#cb19-497" aria-hidden="true" tabindex="-1"></a>catalogue_, provides an API that can be used to query image</span>
<span id="cb19-498"><a href="#cb19-498" aria-hidden="true" tabindex="-1"></a>collections by properties like bounding box, date, band, and cloud</span>
<span id="cb19-499"><a href="#cb19-499" aria-hidden="true" tabindex="-1"></a>coverage. The R package **rstac** <span class="co">[</span><span class="ot">@R-rstac</span><span class="co">]</span> provides an R interface</span>
<span id="cb19-500"><a href="#cb19-500" aria-hidden="true" tabindex="-1"></a>to create queries and manage the information returned.</span>
<span id="cb19-501"><a href="#cb19-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-502"><a href="#cb19-502" aria-hidden="true" tabindex="-1"></a>Processing the resulting files may involve creating a data cube at</span>
<span id="cb19-503"><a href="#cb19-503" aria-hidden="true" tabindex="-1"></a>a lower spatial and/or temporal resolution, from images that may</span>
<span id="cb19-504"><a href="#cb19-504" aria-hidden="true" tabindex="-1"></a>span a range of coordinate reference systems (e.g., several UTM</span>
<span id="cb19-505"><a href="#cb19-505" aria-hidden="true" tabindex="-1"></a>zones). An R package that creates a regular data cube from such a</span>
<span id="cb19-506"><a href="#cb19-506" aria-hidden="true" tabindex="-1"></a>collection of images is **gdalcubes** <span class="co">[</span><span class="ot">@R-gdalcubes; @appel2019demand</span><span class="co">]</span>,</span>
<span id="cb19-507"><a href="#cb19-507" aria-hidden="true" tabindex="-1"></a>which can also directly use a STAC <span class="co">[</span><span class="ot">@appelblog</span><span class="co">]</span> to identify images.</span>
<span id="cb19-508"><a href="#cb19-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-509"><a href="#cb19-509" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cloud native storage: Zarr {#sec-zarr}</span></span>
<span id="cb19-510"><a href="#cb19-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-511"><a href="#cb19-511" aria-hidden="true" tabindex="-1"></a>\index{Zarr}</span>
<span id="cb19-512"><a href="#cb19-512" aria-hidden="true" tabindex="-1"></a>\index{GDAL!multi-dimensional arrays}</span>
<span id="cb19-513"><a href="#cb19-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-514"><a href="#cb19-514" aria-hidden="true" tabindex="-1"></a>Where COG provides cloud native storage for raster imagery, Zarr is a</span>
<span id="cb19-515"><a href="#cb19-515" aria-hidden="true" tabindex="-1"></a>format for cloud native storage of large multi-dimensional arrays. It</span>
<span id="cb19-516"><a href="#cb19-516" aria-hidden="true" tabindex="-1"></a>can be seen as a successor of NetCDF and seems to follow similar</span>
<span id="cb19-517"><a href="#cb19-517" aria-hidden="true" tabindex="-1"></a>conventions, being used by the climate and forecast communities <span class="co">[</span><span class="ot">@cf</span><span class="co">]</span>.</span>
<span id="cb19-518"><a href="#cb19-518" aria-hidden="true" tabindex="-1"></a>Zarr "files" are really directories with sub-directories containing</span>
<span id="cb19-519"><a href="#cb19-519" aria-hidden="true" tabindex="-1"></a>compressed chunks of the data. The compression algorithm and</span>
<span id="cb19-520"><a href="#cb19-520" aria-hidden="true" tabindex="-1"></a>the chunking strategy will have an effect on how fast particular</span>
<span id="cb19-521"><a href="#cb19-521" aria-hidden="true" tabindex="-1"></a>sub-cubes can be read or written.</span>
<span id="cb19-522"><a href="#cb19-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-523"><a href="#cb19-523" aria-hidden="true" tabindex="-1"></a>Function <span class="in">`stars::read_mdim`</span> can read entire data cubes but has</span>
<span id="cb19-524"><a href="#cb19-524" aria-hidden="true" tabindex="-1"></a>options for reading sub-cubes by specifying for each dimension</span>
<span id="cb19-525"><a href="#cb19-525" aria-hidden="true" tabindex="-1"></a>offset, number of pixels, and the step size to read a dimension</span>
<span id="cb19-526"><a href="#cb19-526" aria-hidden="true" tabindex="-1"></a>at a lower resolution <span class="co">[</span><span class="ot">@zarrblog</span><span class="co">]</span>. Similarly, <span class="in">`stars::write_mdim`</span></span>
<span id="cb19-527"><a href="#cb19-527" aria-hidden="true" tabindex="-1"></a>can write multi-dimensional arrays to Zarr or NetCDF files, or other</span>
<span id="cb19-528"><a href="#cb19-528" aria-hidden="true" tabindex="-1"></a>formats that support the GDAL C++ multi-dimensional array API.</span>
<span id="cb19-529"><a href="#cb19-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-530"><a href="#cb19-530" aria-hidden="true" tabindex="-1"></a>\index{read<span class="sc">\_</span>mdim}</span>
<span id="cb19-531"><a href="#cb19-531" aria-hidden="true" tabindex="-1"></a>\index{write<span class="sc">\_</span>mdim}</span>
<span id="cb19-532"><a href="#cb19-532" aria-hidden="true" tabindex="-1"></a>\index{NetCDF}</span>
<span id="cb19-533"><a href="#cb19-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-534"><a href="#cb19-534" aria-hidden="true" tabindex="-1"></a>To read a remote (cloud-based) Zarr file, one needs to prepend the</span>
<span id="cb19-535"><a href="#cb19-535" aria-hidden="true" tabindex="-1"></a>URL with indicators about the format and the access protocol:</span>
<span id="cb19-538"><a href="#cb19-538" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-539"><a href="#cb19-539" aria-hidden="true" tabindex="-1"></a>dsn <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">'ZARR:"/vsicurl/https://ncsa.osn.xsede.org'</span>,</span>
<span id="cb19-540"><a href="#cb19-540" aria-hidden="true" tabindex="-1"></a>       <span class="st">'/Pangeo/pangeo-forge/gpcp-feedstock/gpcp.zarr"'</span>)</span>
<span id="cb19-541"><a href="#cb19-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-542"><a href="#cb19-542" aria-hidden="true" tabindex="-1"></a>after which we can read the first 10 time steps using</span>
<span id="cb19-545"><a href="#cb19-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-546"><a href="#cb19-546" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span>
<span id="cb19-547"><a href="#cb19-547" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">=</span> <span class="fu">c</span>(<span class="at">longitude =</span> <span class="st">"lon_bounds"</span>, <span class="at">latitude =</span> <span class="st">"lat_bounds"</span>)</span>
<span id="cb19-548"><a href="#cb19-548" aria-hidden="true" tabindex="-1"></a>(<span class="at">r =</span> <span class="fu">read_mdim</span>(dsn, <span class="at">bounds =</span> bounds, <span class="at">count =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="dv">10</span>)))</span>
<span id="cb19-549"><a href="#cb19-549" aria-hidden="true" tabindex="-1"></a><span class="fu">st_bbox</span>(r)</span>
<span id="cb19-550"><a href="#cb19-550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-551"><a href="#cb19-551" aria-hidden="true" tabindex="-1"></a>In this example, </span>
<span id="cb19-552"><a href="#cb19-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-553"><a href="#cb19-553" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`NA`</span> values for <span class="in">`count`</span> indicate to get all values available for that dimension</span>
<span id="cb19-554"><a href="#cb19-554" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>here, <span class="in">`bounds`</span> variables needed explicit specification because the data</span>
<span id="cb19-555"><a href="#cb19-555" aria-hidden="true" tabindex="-1"></a>  source did not follow the more recent CF (1.10) conventions; and</span>
<span id="cb19-556"><a href="#cb19-556" aria-hidden="true" tabindex="-1"></a>  ignoring bounds would lead to a raster with a bounding box having</span>
<span id="cb19-557"><a href="#cb19-557" aria-hidden="true" tabindex="-1"></a>  latitude values outside $<span class="co">[</span><span class="ot">-90,90</span><span class="co">]</span>$.</span>
<span id="cb19-558"><a href="#cb19-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-559"><a href="#cb19-559" aria-hidden="true" tabindex="-1"></a><span class="fu">### APIs for data: GEE, openEO</span></span>
<span id="cb19-560"><a href="#cb19-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-561"><a href="#cb19-561" aria-hidden="true" tabindex="-1"></a>\index{Google Earth Engine}</span>
<span id="cb19-562"><a href="#cb19-562" aria-hidden="true" tabindex="-1"></a>\index{openEO}</span>
<span id="cb19-563"><a href="#cb19-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-564"><a href="#cb19-564" aria-hidden="true" tabindex="-1"></a>Platforms that do not require the management and programming of</span>
<span id="cb19-565"><a href="#cb19-565" aria-hidden="true" tabindex="-1"></a>virtual machines _in_ the cloud but provide direct access to the</span>
<span id="cb19-566"><a href="#cb19-566" aria-hidden="true" tabindex="-1"></a>imagery managed include GEE, openEO, and the climate data store.</span>
<span id="cb19-567"><a href="#cb19-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-568"><a href="#cb19-568" aria-hidden="true" tabindex="-1"></a>Google Earth Engine (GEE) is a cloud platform that allows users</span>
<span id="cb19-569"><a href="#cb19-569" aria-hidden="true" tabindex="-1"></a>to compute on large amounts of Earth Observation data as well</span>
<span id="cb19-570"><a href="#cb19-570" aria-hidden="true" tabindex="-1"></a>as modelling products <span class="co">[</span><span class="ot">@gorelick</span><span class="co">]</span>. It has powerful analysis</span>
<span id="cb19-571"><a href="#cb19-571" aria-hidden="true" tabindex="-1"></a>capabilities, including most of the data cube operations explained</span>
<span id="cb19-572"><a href="#cb19-572" aria-hidden="true" tabindex="-1"></a>in @sec-dcoperations. It has an interface where scripts can</span>
<span id="cb19-573"><a href="#cb19-573" aria-hidden="true" tabindex="-1"></a>be written in JavaScript, and a Python interface to the same</span>
<span id="cb19-574"><a href="#cb19-574" aria-hidden="true" tabindex="-1"></a>functionality. The code of GEE is not open-source, and cannot be</span>
<span id="cb19-575"><a href="#cb19-575" aria-hidden="true" tabindex="-1"></a>extended by arbitrary user-defined functions in languages like</span>
<span id="cb19-576"><a href="#cb19-576" aria-hidden="true" tabindex="-1"></a>Python or R. R package **rgee** <span class="co">[</span><span class="ot">@R-rgee</span><span class="co">]</span> provides an R client</span>
<span id="cb19-577"><a href="#cb19-577" aria-hidden="true" tabindex="-1"></a>interface to GEE.</span>
<span id="cb19-578"><a href="#cb19-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-579"><a href="#cb19-579" aria-hidden="true" tabindex="-1"></a>Cloud-based data cube processing platforms built entirely around</span>
<span id="cb19-580"><a href="#cb19-580" aria-hidden="true" tabindex="-1"></a>open source software are emerging, several of which using the openEO</span>
<span id="cb19-581"><a href="#cb19-581" aria-hidden="true" tabindex="-1"></a>API <span class="co">[</span><span class="ot">@openEO</span><span class="co">]</span>. This API allows for user-defined functions (UDFs)</span>
<span id="cb19-582"><a href="#cb19-582" aria-hidden="true" tabindex="-1"></a>written in Python or R that are being passed on through the API</span>
<span id="cb19-583"><a href="#cb19-583" aria-hidden="true" tabindex="-1"></a>and executed at the pixel level, for instance to aggregate or</span>
<span id="cb19-584"><a href="#cb19-584" aria-hidden="true" tabindex="-1"></a>reduce dimensions using custom reducers.  UDFs in R represent the</span>
<span id="cb19-585"><a href="#cb19-585" aria-hidden="true" tabindex="-1"></a>data chunk to be processed as a <span class="in">`stars`</span> object; in Python <span class="in">`xarray`</span></span>
<span id="cb19-586"><a href="#cb19-586" aria-hidden="true" tabindex="-1"></a>objects are used.</span>
<span id="cb19-587"><a href="#cb19-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-588"><a href="#cb19-588" aria-hidden="true" tabindex="-1"></a>Other platforms include the Copernicus climate data store <span class="co">[</span><span class="ot">@cds</span><span class="co">]</span></span>
<span id="cb19-589"><a href="#cb19-589" aria-hidden="true" tabindex="-1"></a>or atmosphere data store, which allow processing of atmospheric</span>
<span id="cb19-590"><a href="#cb19-590" aria-hidden="true" tabindex="-1"></a>or climate data from ECMWF, including ERA5. An R package with an</span>
<span id="cb19-591"><a href="#cb19-591" aria-hidden="true" tabindex="-1"></a>interface to both data stores is **ecmwfr** <span class="co">[</span><span class="ot">@R-ecmwfr</span><span class="co">]</span>.</span>
<span id="cb19-592"><a href="#cb19-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-593"><a href="#cb19-593" aria-hidden="true" tabindex="-1"></a>\index{ERA5}</span>
<span id="cb19-594"><a href="#cb19-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-595"><a href="#cb19-595" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises </span></span>
<span id="cb19-596"><a href="#cb19-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-597"><a href="#cb19-597" aria-hidden="true" tabindex="-1"></a>Use R to solve the following exercises.</span>
<span id="cb19-598"><a href="#cb19-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-599"><a href="#cb19-599" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>For the S2 image (above), find out in which order the bands are by</span>
<span id="cb19-600"><a href="#cb19-600" aria-hidden="true" tabindex="-1"></a>using <span class="in">`st_get_dimension_values()`</span>, and try to find out which spectral bands / colours they correspond to.</span>
<span id="cb19-601"><a href="#cb19-601" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Compute NDVI for the S2 image, using <span class="in">`st_apply`</span> and an appropriate </span>
<span id="cb19-602"><a href="#cb19-602" aria-hidden="true" tabindex="-1"></a><span class="in">`ndvi`</span> function.  Plot the result to screen, and then write the</span>
<span id="cb19-603"><a href="#cb19-603" aria-hidden="true" tabindex="-1"></a>result to a GeoTIFF. Explain the difference in runtime between</span>
<span id="cb19-604"><a href="#cb19-604" aria-hidden="true" tabindex="-1"></a>plotting and writing.</span>
<span id="cb19-605"><a href="#cb19-605" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Plot an RGB composite of the S2 image, using the <span class="in">`rgb`</span> argument</span>
<span id="cb19-606"><a href="#cb19-606" aria-hidden="true" tabindex="-1"></a>to <span class="in">`plot()`</span>, and then by using <span class="in">`st_rgb()`</span> first.</span>
<span id="cb19-607"><a href="#cb19-607" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Select five random points from the bounding box of <span class="in">`S2`</span>, and extract</span>
<span id="cb19-608"><a href="#cb19-608" aria-hidden="true" tabindex="-1"></a>the band values at these points; convert the object returned to an <span class="in">`sf`</span></span>
<span id="cb19-609"><a href="#cb19-609" aria-hidden="true" tabindex="-1"></a>object.</span>
<span id="cb19-610"><a href="#cb19-610" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>For the 10-km radius circle around <span class="in">`POINT(390000  5940000)`</span>, use</span>
<span id="cb19-611"><a href="#cb19-611" aria-hidden="true" tabindex="-1"></a><span class="in">`aggregate`</span> to compute the mean pixel values of the S2 image</span>
<span id="cb19-612"><a href="#cb19-612" aria-hidden="true" tabindex="-1"></a>when downsampling the images with factor 30, and on the original</span>
<span id="cb19-613"><a href="#cb19-613" aria-hidden="true" tabindex="-1"></a>resolution. Compute the relative difference between the results.</span>
<span id="cb19-614"><a href="#cb19-614" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Use <span class="in">`hist`</span> to compute the histogram on the downsampled S2 image.</span>
<span id="cb19-615"><a href="#cb19-615" aria-hidden="true" tabindex="-1"></a>Also do this for each of the bands. Use <span class="in">`ggplot2`</span> to compute a</span>
<span id="cb19-616"><a href="#cb19-616" aria-hidden="true" tabindex="-1"></a>single plot with all four histograms.</span>
<span id="cb19-617"><a href="#cb19-617" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Use <span class="in">`st_crop`</span> to crop the S2 image to the area covered by the 10-km circle.</span>
<span id="cb19-618"><a href="#cb19-618" aria-hidden="true" tabindex="-1"></a>Plot the results. Explore the effect of setting argument <span class="in">`crop = FALSE`</span></span>
<span id="cb19-619"><a href="#cb19-619" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>With the downsampled image, compute the logical layer where all four</span>
<span id="cb19-620"><a href="#cb19-620" aria-hidden="true" tabindex="-1"></a>bands have pixel values higher than 1000. Use a raster algebra expression</span>
<span id="cb19-621"><a href="#cb19-621" aria-hidden="true" tabindex="-1"></a>on the four bands (use <span class="in">`split`</span> first), or use <span class="in">`st_apply`</span> for this.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/09-Large.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>