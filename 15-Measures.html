<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Spatial Data Science - 15&nbsp; Measures of Spatial Autocorrelation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./16-SpatialRegression.html" rel="next">
<link href="./14-Areal.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-04YTZNEH1K"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
 
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'analytics_storage': 'denied'
  });
gtag('config', 'G-04YTZNEH1K', { 'anonymize_ip': true});
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-3.html">Models for Spatial Data</a></li><li class="breadcrumb-item"><a href="./15-Measures.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of Spatial Autocorrelation</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/edzer/sdsr/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-hello.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting Started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-Spaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Coordinates</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-Geometries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Spherical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spherical Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-Attributes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Attributes and Support</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-Cubes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R for Spatial Data Science</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-Introsf.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-Plotting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-Large.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Models for Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Statistical modelling of spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-PointPattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Point Pattern Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-Interpolation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-Geostatistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-Areal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-Measures.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of Spatial Autocorrelation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-SpatialRegression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-Econometrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Spatial Econometrics Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sp-raster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Older R Spatial Packages</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rbasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">R Basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ERRATA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Errata to the printed ed.</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#sec-measprocmisspec" id="toc-sec-measprocmisspec" class="nav-link active" data-scroll-target="#sec-measprocmisspec"><span class="header-section-number">15.1</span> Measures and process misspecification</a></li>
  <li>
<a href="#global-measures" id="toc-global-measures" class="nav-link" data-scroll-target="#global-measures"><span class="header-section-number">15.2</span> Global measures</a>
  <ul class="collapse">
<li><a href="#join-count-tests-for-categorical-data" id="toc-join-count-tests-for-categorical-data" class="nav-link" data-scroll-target="#join-count-tests-for-categorical-data">Join-count tests for categorical data</a></li>
  <li><a href="#morans-i" id="toc-morans-i" class="nav-link" data-scroll-target="#morans-i">Moran’s <span class="math inline">\(I\)</span></a></li>
  </ul>
</li>
  <li>
<a href="#local-measures" id="toc-local-measures" class="nav-link" data-scroll-target="#local-measures"><span class="header-section-number">15.3</span> Local measures</a>
  <ul class="collapse">
<li><a href="#local-morans-i_i" id="toc-local-morans-i_i" class="nav-link" data-scroll-target="#local-morans-i_i">Local Moran’s <span class="math inline">\(I_i\)</span></a></li>
  <li><a href="#local-getis-ord-g_i" id="toc-local-getis-ord-g_i" class="nav-link" data-scroll-target="#local-getis-ord-g_i">Local Getis-Ord <span class="math inline">\(G_i\)</span></a></li>
  <li><a href="#local-gearys-c_i" id="toc-local-gearys-c_i" class="nav-link" data-scroll-target="#local-gearys-c_i">Local Geary’s <span class="math inline">\(C_i\)</span></a></li>
  <li><a href="#the-rgeoda-package" id="toc-the-rgeoda-package" class="nav-link" data-scroll-target="#the-rgeoda-package">The <strong>rgeoda</strong> package</a></li>
  </ul>
</li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">15.4</span> Exercises</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/15-Measures.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-3.html">Models for Spatial Data</a></li><li class="breadcrumb-item"><a href="./15-Measures.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of Spatial Autocorrelation</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-spatautocorr" class="quarto-section-identifier"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of Spatial Autocorrelation</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p></p>
<!---
might options("width") be set to a smaller value to prevent right margin 
overruns in cals to  arg(), etc.? Maybe in each chapter? in R 80, 
RStudio 82 for this session.
--->
<p>When analysing areal data, it has long been recognised that, if present, spatial autocorrelation changes how we may infer, relative to the default assumption of independent observations. In the presence of spatial autocorrelation, we can predict the values of observation <span class="math inline">\(i\)</span> from the values observed at <span class="math inline">\(j \in N_i\)</span>, the set of its proximate neighbours. Early results <span class="citation" data-cites="moran48 geary:54">(<a href="references.html#ref-moran48" role="doc-biblioref">Moran 1948</a>; <a href="references.html#ref-geary:54" role="doc-biblioref">Geary 1954</a>)</span> entered into research practice gradually, for example the social sciences <span class="citation" data-cites="duncanetal61">(<a href="references.html#ref-duncanetal61" role="doc-biblioref">Duncan, Cuzzort, and Duncan 1961</a>)</span>. These results were then collated and extended to yield a set of basic tools of analysis <span class="citation" data-cites="cliff+ord:73 cliff+ord:81">(<a href="references.html#ref-cliff+ord:73" role="doc-biblioref">Cliff and Ord 1973</a>, <a href="references.html#ref-cliff+ord:81" role="doc-biblioref">1981</a>)</span>.</p>
<p>Cliff and Ord <span class="citation" data-cites="cliff+ord:73">(<a href="references.html#ref-cliff+ord:73" role="doc-biblioref">1973</a>)</span> generalised and extended the expression of the spatial weights matrix representation as part of the framework for establishing the distribution theory for join-count, Moran’s <span class="math inline">\(I\)</span> and Geary’s <span class="math inline">\(C\)</span> statistics. This development of what have become known as global measures, returning a single value of autocorrelation for the total study area, has been supplemented by local measures returning values for each areal unit <span class="citation" data-cites="getis+ord:92 anselin:95">(<a href="references.html#ref-getis+ord:92" role="doc-biblioref">Getis and Ord 1992</a>; <a href="references.html#ref-anselin:95" role="doc-biblioref">Anselin 1995</a>)</span>.</p>
<p></p>
<p>The measures offered by the <strong>spdep</strong> package have been written partly to provide implementations, but also to permit the comparative investigation of these measures and their implementation. For this reason, the implementations are written in R rather than compiled code, and they are generally slower but more flexible than implementations in the newly released <strong>rgeoda</strong> package <span class="citation" data-cites="rgeoda-package https://doi.org/10.1111/gean.12311">(<a href="references.html#ref-rgeoda-package" role="doc-biblioref">Li and Anselin 2021</a>; <a href="references.html#ref-https://doi.org/10.1111/gean.12311" role="doc-biblioref">Anselin, Li, and Koschinsky 2021</a>)</span>.</p>
<p></p>
<section id="sec-measprocmisspec" class="level2" data-number="15.1"><h2 data-number="15.1" class="anchored" data-anchor-id="sec-measprocmisspec">
<span class="header-section-number">15.1</span> Measures and process misspecification</h2>
<p>It is not and has never been the case that Tobler’s first law of geography, “Everything is related to everything else, but near things are more related than distant things”, always holds absolutely. This is and has always been an oversimplification, disguising possible underlying entitation, support, and other misspecification problems. Are the units of observation appropriate for the scale of the underlying spatial process? Could the spatial patterning of the variable of interest for the chosen entitation be accounted for by another variable?</p>
<p><span class="citation" data-cites="10.2307/143141">Tobler (<a href="references.html#ref-10.2307/143141" role="doc-biblioref">1970</a>)</span> was published in the same special issue of <em>Economic Geography</em> as <span class="citation" data-cites="10.2307/143140">Olsson (<a href="references.html#ref-10.2307/143140" role="doc-biblioref">1970</a>)</span>, but Olsson does grasp the important point that spatial autocorrelation is not inherent in spatial phenomena, but often, is engendered by inappropriate entitation, by omitted variables and/or inappropriate functional form. The key quote from Olsson is on p.&nbsp;228:</p>
<blockquote class="blockquote">
<p>The existence of such autocorrelations makes it tempting to agree with Tobler (1970, 236 [the original refers to the pagination of a conference paper]) that ‘everything is related to everything else, but near things are more related than distant things.’ On the other hand, the fact that the autocorrelations seem to hide systematic specification errors suggests that the elevation of this statement to the status of ‘the first law of geography’ is at best premature. At worst, the statement may represent the spatial variant of the post hoc fallacy, which would mean that coincidence has been mistaken for a causal relation.</p>
</blockquote>
<p>The status of the “first law” is very similar to the belief that John Snow induced from a map the cause of cholera as water-borne. It may be a good way of selling GIS, but it is inaccurate: Snow had a strong working hypothesis prior to visiting Soho, and the map was prepared after the Broad Street pump was disabled as documentation that his hypothesis held <span class="citation" data-cites="BRODY200064">(<a href="references.html#ref-BRODY200064" role="doc-biblioref">Brody et al. 2000</a>)</span>.</p>
<p>Measures of spatial autocorrelation unfortunately pick up other misspecifications in the way that we model data <span class="citation" data-cites="schabenberger+gotway:2005 McMillen:2003">(<a href="references.html#ref-schabenberger+gotway:2005" role="doc-biblioref">Schabenberger and Gotway 2005</a>; <a href="references.html#ref-McMillen:2003" role="doc-biblioref">McMillen 2003</a>)</span>. For reference, Moran’s <span class="math inline">\(I\)</span> is given as <span class="citation" data-cites="cliff+ord:81">(<a href="references.html#ref-cliff+ord:81" role="doc-biblioref">Cliff and Ord 1981, 17</a>)</span>:</p>
<p></p>
<p><span class="math display">\[
I = \frac{n \sum_{(2)} w_{ij} z_i z_j}{S_0 \sum_{i=1}^{n} z_i^2}
\]</span> where <span class="math inline">\(x_i, i=1, \ldots, n\)</span> are <span class="math inline">\(n\)</span> observations on the numeric variable of interest, <span class="math inline">\(z_i = x_i - \bar{x}\)</span>, <span class="math inline">\(\bar{x} = \sum_{i=1}^{n} x_i / n\)</span>, <span class="math inline">\(\sum_{(2)} = \stackrel{\sum_{i=1}^{n} \sum_{j=1}^{n}}{i \neq j}\)</span>, <span class="math inline">\(w_{ij}\)</span> are the spatial weights, and <span class="math inline">\(S_0 = \sum_{(2)} w_{ij}\)</span>. First we test a random variable using the Moran test, here under the normality assumption (argument <code>randomisation=FALSE</code>, default <code>TRUE</code>). Inference is made on the statistic <span class="math inline">\(Z(I) = \frac{I - E(I)}{\sqrt{\mathrm{Var}(I)}}\)</span>, the z-value compared with the Normal distribution for <span class="math inline">\(E(I)\)</span> and <span class="math inline">\(\mathrm{Var}(I)\)</span> for the chosen assumptions; this <code>x</code> does not show spatial autocorrelation with these spatial weights:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/">spdep</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">glance_htest</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ht</span><span class="op">$</span><span class="va">estimate</span>, </span>
<span>    <span class="st">"Std deviate"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">ht</span><span class="op">$</span><span class="va">statistic</span><span class="op">)</span>, </span>
<span>    <span class="st">"p.value"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">ht</span><span class="op">$</span><span class="va">p.value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">pol_pres15</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">x</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.test.html">moran.test</a></span><span class="op">(</span><span class="va">lw_q_B</span>, randomisation <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>               alternative <span class="op">=</span> <span class="st">"two.sided"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">glance_htest</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Moran I statistic       Expectation          Variance </span></span>
<span><span class="co">#         -0.004772         -0.000401          0.000140 </span></span>
<span><span class="co">#       Std deviate           p.value </span></span>
<span><span class="co">#         -0.369320          0.711889</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The test however detects quite strong positive spatial autocorrelation when we insert a gentle trend into the data, but omit to include it in the mean model, thus creating a missing variable problem but finding spatial autocorrelation instead:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fl">0.0015</span></span>
<span><span class="va">coords</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="fl">1</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">t</span></span>
<span><span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">t</span> <span class="op">-&gt;</span> <span class="va">x_t</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.test.html">moran.test</a></span><span class="op">(</span><span class="va">lw_q_B</span>, randomisation <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>               alternative <span class="op">=</span> <span class="st">"two.sided"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">glance_htest</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Moran I statistic       Expectation          Variance </span></span>
<span><span class="co">#          0.043403         -0.000401          0.000140 </span></span>
<span><span class="co">#       Std deviate           p.value </span></span>
<span><span class="co">#          3.701491          0.000214</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we test the residuals of a linear model including the trend, the apparent spatial autocorrelation disappears:</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">x_t</span> <span class="op">~</span> <span class="va">t</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.morantest.html">lm.morantest</a></span><span class="op">(</span><span class="va">lw_q_B</span>, alternative <span class="op">=</span> <span class="st">"two.sided"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">glance_htest</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Observed Moran I      Expectation         Variance      Std deviate </span></span>
<span><span class="co">#        -0.004777        -0.000789         0.000140        -0.337306 </span></span>
<span><span class="co">#          p.value </span></span>
<span><span class="co">#         0.735886</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A comparison of implementations of measures of spatial autocorrelation shows that a wide range of measures is available in R in a number of packages, chiefly in the <strong>spdep</strong> package <span class="citation" data-cites="R-spdep">(<a href="references.html#ref-R-spdep" role="doc-biblioref">Bivand 2022b</a>)</span>, and that differences from other implementations can be attributed to design decisions <span class="citation" data-cites="Bivand2018">(<a href="references.html#ref-Bivand2018" role="doc-biblioref">Bivand and Wong 2018</a>)</span>. The <strong>spdep</strong> package also includes the only implementations of exact and saddlepoint approximations to global and local Moran’s I for regression residuals <span class="citation" data-cites="tiefelsdorf:02 bivandetal:09">(<a href="references.html#ref-tiefelsdorf:02" role="doc-biblioref">Tiefelsdorf 2002</a>; <a href="references.html#ref-bivandetal:09" role="doc-biblioref">Bivand, Müller, and Reder 2009</a>)</span>.</p>
<p> </p>
</section><section id="global-measures" class="level2" data-number="15.2"><h2 data-number="15.2" class="anchored" data-anchor-id="global-measures">
<span class="header-section-number">15.2</span> Global measures</h2>
<p>Global measures consider the average level of spatial autocorrelation across all observations; they can of course be biased (as most spatial statistics) by edge effects where important spatial process components fall outside the study area.</p>
<section id="join-count-tests-for-categorical-data" class="level3"><h3 class="anchored" data-anchor-id="join-count-tests-for-categorical-data">Join-count tests for categorical data</h3>
<p></p>
<p>We will begin by examining join-count statistics, where <code>joincount.test</code> takes a <code>"factor"</code> vector of values <code>fx</code> and a <code>listw</code> object, and returns a list of <code>htest</code> (hypothesis test) objects defined in the <strong>stats</strong> package, one <code>htest</code> object for each level of the <code>fx</code> argument. The observed counts are of neighbours with the same factor levels, known as same-colour joins.</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="va">joincount.test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>#  function (fx, listw, zero.policy = attr(listw, "zero.policy"),
#    alternative = "greater", sampling = "nonfree", spChk = NULL,
#    adjust.n = TRUE)</code></pre>
</div>
<p>The function takes an <code>alternative</code> argument for hypothesis testing, a <code>sampling</code> argument showing the basis for the construction of the variance of the measure, where the default <code>"nonfree"</code> choice corresponds to analytical permutation; the <code>spChk</code> argument is retained for backward compatibility. For reference, the counts of factor levels for the type of municipality or Warsaw borough are:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">pol_pres15</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="va">types</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">Types</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#          Rural          Urban    Urban/rural Warsaw Borough </span></span>
<span><span class="co">#           1563            303            611             18</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since there are four levels, we rearrange the list of <code>htest</code> objects to give a matrix of estimated results. The observed same-colour join-counts are tabulated with their expectations based on the counts of levels of the input factor, so that few joins would be expected between for example Warsaw boroughs, because there are very few of them. The variance calculation uses the underlying constants of the chosen <code>listw</code> object and the counts of levels of the input factor. The z-value is obtained in the usual way by dividing the difference between the observed and expected join-counts by the square root of the variance.</p>
<p>The join-count test was subsequently adapted for multi-colour join-counts <span class="citation" data-cites="upton+fingleton:85">(<a href="references.html#ref-upton+fingleton:85" role="doc-biblioref">Upton and Fingleton 1985</a>)</span>. The implementation as <code>joincount.multi</code> in <strong>spdep</strong> returns a table based on non-free sampling, and does not report p-values.</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Types</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/joincount.multi.html">joincount.multi</a></span><span class="op">(</span>listw <span class="op">=</span> <span class="va">lw_q_B</span><span class="op">)</span></span>
<span><span class="co">#                               Joincount Expected Variance z-value</span></span>
<span><span class="co"># Rural:Rural                    3087.000 2793.920 1126.534    8.73</span></span>
<span><span class="co"># Urban:Urban                     110.000  104.719   93.299    0.55</span></span>
<span><span class="co"># Urban/rural:Urban/rural         656.000  426.526  331.759   12.60</span></span>
<span><span class="co"># Warsaw Borough:Warsaw Borough    41.000    0.350    0.347   68.96</span></span>
<span><span class="co"># Urban:Rural                     668.000 1083.941  708.209  -15.63</span></span>
<span><span class="co"># Urban/rural:Rural              2359.000 2185.769 1267.131    4.87</span></span>
<span><span class="co"># Urban/rural:Urban               171.000  423.729  352.190  -13.47</span></span>
<span><span class="co"># Warsaw Borough:Rural             12.000   64.393   46.460   -7.69</span></span>
<span><span class="co"># Warsaw Borough:Urban              9.000   12.483   11.758   -1.02</span></span>
<span><span class="co"># Warsaw Borough:Urban/rural        8.000   25.172   22.354   -3.63</span></span>
<span><span class="co"># Jtot                           3227.000 3795.486 1496.398  -14.70</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So far, we have used binary weights, so the sum of join-counts multiplied by the weight on that join remains integer. If we change to row standardised weights, where the weights are almost always fractions of 1, the counts, expectations and variances change, but there are few major changes in the z-values.</p>
<p>Using an inverse distance based <code>listw</code> object does, however, change the z-values markedly, because closer centroids are up-weighted relatively strongly:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Types</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/joincount.multi.html">joincount.multi</a></span><span class="op">(</span>listw <span class="op">=</span> <span class="va">lw_d183_idw_B</span><span class="op">)</span></span>
<span><span class="co">#                               Joincount Expected Variance z-value</span></span>
<span><span class="co"># Rural:Rural                    3.46e+02 3.61e+02 4.93e+01   -2.10</span></span>
<span><span class="co"># Urban:Urban                    2.90e+01 1.35e+01 2.23e+00   10.39</span></span>
<span><span class="co"># Urban/rural:Urban/rural        4.65e+01 5.51e+01 9.61e+00   -2.79</span></span>
<span><span class="co"># Warsaw Borough:Warsaw Borough  1.68e+01 4.53e-02 6.61e-03  206.38</span></span>
<span><span class="co"># Urban:Rural                    2.02e+02 1.40e+02 2.36e+01   12.73</span></span>
<span><span class="co"># Urban/rural:Rural              2.25e+02 2.83e+02 3.59e+01   -9.59</span></span>
<span><span class="co"># Urban/rural:Urban              3.65e+01 5.48e+01 8.86e+00   -6.14</span></span>
<span><span class="co"># Warsaw Borough:Rural           5.65e+00 8.33e+00 1.73e+00   -2.04</span></span>
<span><span class="co"># Warsaw Borough:Urban           9.18e+00 1.61e+00 2.54e-01   15.01</span></span>
<span><span class="co"># Warsaw Borough:Urban/rural     3.27e+00 3.25e+00 5.52e-01    0.02</span></span>
<span><span class="co"># Jtot                           4.82e+02 4.91e+02 4.16e+01   -1.38</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="morans-i" class="level3"><h3 class="anchored" data-anchor-id="morans-i">Moran’s <span class="math inline">\(I\)</span>
</h3>
<p>The implementation of Moran’s <span class="math inline">\(I\)</span> in <strong>spdep</strong> in the <code>moran.test</code> function has similar arguments to those of <code>joincount.test</code>, but <code>sampling</code> is replaced by <code>randomisation</code> to indicate the underlying analytical approach used for calculating the variance of the measure. It is also possible to use ranks rather than numerical values <span class="citation" data-cites="cliff+ord:81">(<a href="references.html#ref-cliff+ord:81" role="doc-biblioref">Cliff and Ord 1981, 46</a>)</span>. The <code>drop.EI2</code> argument may be used to reproduce results where the final component of the variance term is omitted as found in some legacy software implementations.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="va">moran.test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>#  function (x, listw, randomisation = TRUE, zero.policy =
#    attr(listw, "zero.policy"), alternative = "greater", rank =
#    FALSE, na.action = na.fail, spChk = NULL, adjust.n = TRUE,
#    drop.EI2 = FALSE)</code></pre>
</div>
<p></p>
<p>The default for the <code>randomisation</code> argument is <code>TRUE</code>, but here we will simply show that the test under normality is the same as a test of least squares residuals with only the intercept used in the mean model. The analysed variable is first-round turnout proportion of registered voters in municipalities and Warsaw boroughs in the 2015 Polish presidential election. The spelling of randomisation is that of Cliff and Ord <span class="citation" data-cites="cliff+ord:73">(<a href="references.html#ref-cliff+ord:73" role="doc-biblioref">1973</a>)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pol_pres15</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="va">I_turnout</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">I_turnout</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">I_turnout</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.test.html">moran.test</a></span><span class="op">(</span>listw <span class="op">=</span> <span class="va">lw_q_B</span>, randomisation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">glance_htest</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Moran I statistic       Expectation          Variance </span></span>
<span><span class="co">#          0.691434         -0.000401          0.000140 </span></span>
<span><span class="co">#       Std deviate           p.value </span></span>
<span><span class="co">#         58.461349          0.000000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The <code>lm.morantest</code> function also takes a <code>resfun</code> argument to set the function used to extract the residuals used for testing, and clearly lets us model other salient features of the response variable <span class="citation" data-cites="cliff+ord:81">(<a href="references.html#ref-cliff+ord:81" role="doc-biblioref">Cliff and Ord 1981, 203</a>)</span>. To compare with the standard test, we are only using the intercept here and, as can be seen, the results are the same.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">I_turnout</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">pol_pres15</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.morantest.html">lm.morantest</a></span><span class="op">(</span>listw <span class="op">=</span> <span class="va">lw_q_B</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">glance_htest</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Observed Moran I      Expectation         Variance      Std deviate </span></span>
<span><span class="co">#         0.691434        -0.000401         0.000140        58.461349 </span></span>
<span><span class="co">#          p.value </span></span>
<span><span class="co">#         0.000000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The only difference between tests under normality and randomisation is that an extra term is added if the kurtosis of the variable of interest indicates a flatter or more peaked distribution, where the measure used is the classical measure of kurtosis. Under the default randomisation assumption of analytical randomisation, the results are largely unchanged.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">I_turnout</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.test.html">moran.test</a></span><span class="op">(</span>listw <span class="op">=</span> <span class="va">lw_q_B</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mtr</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">glance_htest</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Moran I statistic       Expectation          Variance </span></span>
<span><span class="co">#          0.691434         -0.000401          0.000140 </span></span>
<span><span class="co">#       Std deviate           p.value </span></span>
<span><span class="co">#         58.459835          0.000000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p> From the very beginning in the early 1970s, interest was shown in Monte Carlo tests, also known as Hope-type tests and as permutation bootstrap. By default, <code>moran.mc</code> returns a <code>"htest"</code> object, but may simply use <code><a href="https://rdrr.io/pkg/boot/man/boot.html">boot::boot</a></code> internally and return a <code>"boot"</code> object when <code>return_boot=TRUE</code>. In addition the number of simulations needs to be given as <code>nsim</code>; that is the number of times the values of the observations are shuffled at random.</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">I_turnout</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.mc.html">moran.mc</a></span><span class="op">(</span>listw <span class="op">=</span> <span class="va">lw_q_B</span>, nsim <span class="op">=</span> <span class="fl">999</span>, </span>
<span>             return_boot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mmc</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The bootstrap permutation retains the outcomes of each of the random permutations, reporting the observed value of the statistic, here Moran’s <span class="math inline">\(I\)</span>, the difference between this value and the mean of the simulations under randomisation (equivalent to <span class="math inline">\(E(I)\)</span>), and the standard deviation of the simulations under randomisation.</p>
<p>If we compare the Monte Carlo and analytical variances of <span class="math inline">\(I\)</span> under randomisation, we typically see few differences, arguably rendering Monte Carlo testing unnecessary.</p>
<p> </p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Permutation bootstrap"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">mmc</span><span class="op">$</span><span class="va">t</span><span class="op">)</span>, </span>
<span>  <span class="st">"Analytical randomisation"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">mtr</span><span class="op">$</span><span class="va">estimate</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#    Permutation bootstrap Analytical randomisation </span></span>
<span><span class="co">#                 0.000144                 0.000140</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Geary’s global <span class="math inline">\(C\)</span> is implemented in <code>geary.test</code> largely following the same argument structure as <code>moran.test</code>. The Getis-Ord <span class="math inline">\(G\)</span> test includes extra arguments to accommodate differences between implementations, as <span class="citation" data-cites="Bivand2018">Bivand and Wong (<a href="references.html#ref-Bivand2018" role="doc-biblioref">2018</a>)</span> found multiple divergences from the original definitions, often to omit no-neighbour observations generated when using distance band neighbours. It is given by <span class="citation" data-cites="getis+ord:92">Getis and Ord (<a href="references.html#ref-getis+ord:92" role="doc-biblioref">1992</a>)</span>, on page 194. For <span class="math inline">\(G^*\)</span>, the <span class="math inline">\(i \neq j\)</span> summation constraint is relaxed by including <span class="math inline">\(i\)</span> as a neighbour of itself (thereby also removing the no-neighbour problem, because all observations have at least one neighbour).</p>
<p>Finally, the empirical Bayes Moran’s <span class="math inline">\(I\)</span> takes account of the denominator in assessing spatial autocorrelation in rates data <span class="citation" data-cites="assuncao+reis:99">(<a href="references.html#ref-assuncao+reis:99" role="doc-biblioref">Assunção and Reis 1999</a>)</span>. Until now, we have considered the proportion of valid votes cast in relation to the numbers entitled to vote by spatial entity, but using <code>EBImoran.mc</code> we can try to accommodate uncertainty in extreme rates in entities with small numbers entitled to vote. There is, however, little impact on the outcome in this case.</p>
<p>Global measures of spatial autocorrelation using spatial weights objects based on graphs of neighbours are, as we have seen, rather blunt tools, which for interpretation depend critically on a reasoned mean model of the variable in question. If the mean model is just the intercept, the global measures will respond to all kinds of misspecification, not only spatial autocorrelation. The choice of entities for aggregation of data will typically be a key source of misspecification.</p>
</section></section><section id="local-measures" class="level2" data-number="15.3"><h2 data-number="15.3" class="anchored" data-anchor-id="local-measures">
<span class="header-section-number">15.3</span> Local measures</h2>
<p> Building on insights from the weaknesses of global measures, local indicators of spatial association began to appear in the first half of the 1990s <span class="citation" data-cites="anselin:95 getis+ord:92 getis+ord:96">(<a href="references.html#ref-anselin:95" role="doc-biblioref">Anselin 1995</a>; <a href="references.html#ref-getis+ord:92" role="doc-biblioref">Getis and Ord 1992</a>, <a href="references.html#ref-getis+ord:96" role="doc-biblioref">1996</a>)</span>.</p>
<p>In addition, the Moran plot was introduced, plotting the values of the variable of interest against their spatially lagged values, typically using row-standardised weights to make the axes more directly comparable <span class="citation" data-cites="anselin:96">(<a href="references.html#ref-anselin:96" role="doc-biblioref">Anselin 1996</a>)</span>. The <code>moran.plot</code> function also returns an influence measures object used to label observations exerting more than proportional influence on the slope of the line representing global Moran’s <span class="math inline">\(I\)</span>. In <a href="#fig-moranplot" class="quarto-xref">Figure&nbsp;<span>15.1</span></a>, we can see that there are many spatial entities exerting such influence. These pairs of observed and lagged observed values make up in aggregate the global measure, but can also be explored in detail. The quadrants of the Moran plot also show low-low pairs in the lower left quadrant, high-high in the upper right quadrant, and fewer low-high and high-low pairs in the upper left and lower right quadrants. In <code>moran.plot</code>, the quadrants are split on the means of the variable and its spatial lag; alternative splits are on zero for the centred variable and the spatial lag of the centred variable.</p>
<p></p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">I_turnout</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.plot.html">moran.plot</a></span><span class="op">(</span>listw <span class="op">=</span> <span class="va">lw_q_W</span>, labels <span class="op">=</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">TERYT</span>, </span>
<span>               cex <span class="op">=</span> <span class="fl">1</span>, pch <span class="op">=</span> <span class="st">"."</span>, xlab <span class="op">=</span> <span class="st">"I round turnout"</span>, </span>
<span>               ylab <span class="op">=</span> <span class="st">"lagged turnout"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">infl_W</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-moranplot" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-moranplot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="15-Measures_files/figure-html/fig-moranplot-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-moranplot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.1: Moran plot of I round turnout, row standardised weights
</figcaption></figure>
</div>
</div>
</div>
<p>If we extract the hat value influence measure from the returned object, <a href="#fig-moranhat" class="quarto-xref">Figure&nbsp;<span>15.2</span></a> suggests that some edge entities exert more than proportional influence (perhaps because of row standardisation), as do entities in or near larger urban areas.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-tmap.github.io/tmap/">tmap</a></span><span class="op">)</span></span>
<span><span class="co"># Breaking News: tmap 3.x is retiring. Please test v4, e.g. with</span></span>
<span><span class="co"># remotes::install_github('r-tmap/tmap')</span></span>
<span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hat_value</span> <span class="op">&lt;-</span> <span class="va">infl_W</span><span class="op">$</span><span class="va">hat</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"hat_value"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-moranhat" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-moranhat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="15-Measures_files/figure-html/fig-moranhat-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-moranhat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.2: Moran plot hat values, row standardised neighbours
</figcaption></figure>
</div>
</div>
</div>
<section id="local-morans-i_i" class="level3"><h3 class="anchored" data-anchor-id="local-morans-i_i">Local Moran’s <span class="math inline">\(I_i\)</span>
</h3>
<p></p>
<p><span class="citation" data-cites="Bivand2018">Bivand and Wong (<a href="references.html#ref-Bivand2018" role="doc-biblioref">2018</a>)</span> discuss issues impacting the use of local indicators, such as local Moran’s <span class="math inline">\(I_i\)</span> and local Getis-Ord <span class="math inline">\(G_i\)</span>. Some issues affect the calculation of the local indicators, others inference from their values. Because <span class="math inline">\(n\)</span> statistics may be calculated from the same number of observations, there are multiple comparison problems that need to be addressed. <span class="citation" data-cites="https://doi.org/10.1111/j.0016-7363.2006.00682.x">Caldas de Castro and Singer (<a href="references.html#ref-https://doi.org/10.1111/j.0016-7363.2006.00682.x" role="doc-biblioref">2006</a>)</span> conclude, based on a typical dataset and a simulation exercise, that the false discovery rate (FDR) adjustment of probability values will certainly give a better picture of interesting clusters than no adjustment. Following this up, <span class="citation" data-cites="https://doi.org/10.1111/gean.12164">Anselin (<a href="references.html#ref-https://doi.org/10.1111/gean.12164" role="doc-biblioref">2019</a>)</span> explores the combination of FDR adjustments with the use of redefined “significance” cutoffs <span class="citation" data-cites="benjaminetal:18">(<a href="references.html#ref-benjaminetal:18" role="doc-biblioref">Benjamin et al. 2018</a>)</span>, for example <span class="math inline">\(0.01\)</span>, <span class="math inline">\(0.005\)</span>, and <span class="math inline">\(0.001\)</span> instead of <span class="math inline">\(0.1\)</span>, <span class="math inline">\(0.05\)</span>, and <span class="math inline">\(0.01\)</span>; the use of the term <em>interesting</em> rather than <em>significant</em> is also preferred. This is discussed further in <span class="citation" data-cites="bivand:22">Bivand (<a href="references.html#ref-bivand:22" role="doc-biblioref">2022a</a>)</span>. As in the global case, misspecification remains a source of confusion, and, further, interpreting local spatial autocorrelation in the presence of global spatial autocorrelation is challenging <span class="citation" data-cites="ord+getis:01 tiefelsdorf:02 bivandetal:09">(<a href="references.html#ref-ord+getis:01" role="doc-biblioref">Ord and Getis 2001</a>; <a href="references.html#ref-tiefelsdorf:02" role="doc-biblioref">Tiefelsdorf 2002</a>; <a href="references.html#ref-bivandetal:09" role="doc-biblioref">Bivand, Müller, and Reder 2009</a>)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="va">localmoran</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>#  function (x, listw, zero.policy = attr(listw, "zero.policy"),
#    na.action = na.fail, conditional = TRUE, alternative =
#    "two.sided", mlvar = TRUE, spChk = NULL, adjust.x = FALSE)</code></pre>
</div>
<p></p>
<p>In an important clarification, <span class="citation" data-cites="sauer_oshan_rey_wolf_2021">Sauer et al. (<a href="references.html#ref-sauer_oshan_rey_wolf_2021" role="doc-biblioref">2021</a>)</span> show that the comparison of standard deviates for local Moran’s <span class="math inline">\(I_i\)</span> based on analytical formulae and conditional permutation in <span class="citation" data-cites="Bivand2018">Bivand and Wong (<a href="references.html#ref-Bivand2018" role="doc-biblioref">2018</a>)</span> was based on a misunderstanding. <span class="citation" data-cites="sokaletal:98">Sokal, Oden, and Thomson (<a href="references.html#ref-sokaletal:98" role="doc-biblioref">1998</a>)</span> provide alternative analytical formulae for standard deviates of local Moran’s <span class="math inline">\(I_i\)</span> based either on total or conditional permutation, but the analytical formulae used in <span class="citation" data-cites="Bivand2018">Bivand and Wong (<a href="references.html#ref-Bivand2018" role="doc-biblioref">2018</a>)</span>, based on earlier practice, only use total permutation, and consequently do not match the simulation conditional permutations. Thanks to a timely pull request, <code>localmoran</code> now has a <code>conditional</code> argument (default <code>TRUE</code>) using alternative formulae from the appendix of <span class="citation" data-cites="sokaletal:98">Sokal, Oden, and Thomson (<a href="references.html#ref-sokaletal:98" role="doc-biblioref">1998</a>)</span>. The <code>mlvar</code> and <code>adjust.x</code> arguments to <code>localmoran</code> are discussed in <span class="citation" data-cites="Bivand2018">Bivand and Wong (<a href="references.html#ref-Bivand2018" role="doc-biblioref">2018</a>)</span>, and permit matching with other implementations. Taking <code>"two.sided"</code> probability values (the default), we obtain:</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">I_turnout</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localmoran.html">localmoran</a></span><span class="op">(</span>listw <span class="op">=</span> <span class="va">lw_q_W</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">locm</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <span class="math inline">\(I_i\)</span> local indicators when summed and divided by the sum of the spatial weights equal global Moran’s <span class="math inline">\(I\)</span>, showing the possible presence of positive and negative local spatial autocorrelation:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">locm</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/spweights.constants.html">Szero</a></span><span class="op">(</span><span class="va">lw_q_W</span><span class="op">)</span>, </span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.test.html">moran.test</a></span><span class="op">(</span><span class="va">I_turnout</span>, <span class="va">lw_q_W</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using <code><a href="https://rdrr.io/r/stats/p.adjust.html">stats::p.adjust</a></code> to adjust for multiple comparisons, we see that over 15% of the 2495 local measures have p-values &lt; 0.005 if no adjustment is applied, but only 1.5% using Bonferroni adjustment to control the family-wise error rate, with two other choices shown: <code>"fdr"</code> is the <span class="citation" data-cites="fdr-BH">Benjamini and Hochberg (<a href="references.html#ref-fdr-BH" role="doc-biblioref">1995</a>)</span> false discovery rate (almost 6%) and <code>"BY"</code> <span class="citation" data-cites="10.1214/aos/1013699998">(<a href="references.html#ref-10.1214/aos/1013699998" role="doc-biblioref">Benjamini and Yekutieli 2001</a>)</span>, another false discovery rate adjustment (about 2.5%):</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pva</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pv</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="st">"none"</span> <span class="op">=</span> <span class="va">pv</span>, </span>
<span>    <span class="st">"FDR"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">pv</span>, <span class="st">"fdr"</span><span class="op">)</span>, <span class="st">"BY"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">pv</span>, <span class="st">"BY"</span><span class="op">)</span>,</span>
<span>    <span class="st">"Bonferroni"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">pv</span>, <span class="st">"bonferroni"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">locm</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="st">"Pr(z != E(Ii))"</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">pva</span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pvsp</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&lt;</span> <span class="fl">0.005</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">pvsp</span>, <span class="fl">2</span>, <span class="va">f</span><span class="op">)</span></span>
<span><span class="co">#       none        FDR         BY Bonferroni </span></span>
<span><span class="co">#        385        149         64         38</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the global measure case, bootstrap permutations may be used as an alternative to analytical methods for possible inference, where both the theoretical development of the analytical variance of the measure, and the permutation scheme, shuffle all of the observed values. In the local case, conditional permutation should be used, fixing the value at observation <span class="math inline">\(i\)</span> and randomly sampling from the remaining <span class="math inline">\(n-1\)</span> values to find randomised values at neighbours. Conditional permutation is provided as function <code>localmoran_perm</code>, which may use multiple compute nodes to sample in parallel if provided, and permits the setting of a seed for the random number generator across the compute nodes. The number of simulations <code>nsim</code> also controls the precision of the ranked estimates of the probability value based on the rank of observed <span class="math inline">\(I_i\)</span> among the simulated values:</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/set.mcOption.html">set.coresOption</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">I_turnout</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localmoran.html">localmoran_perm</a></span><span class="op">(</span>listw <span class="op">=</span> <span class="va">lw_q_W</span>, nsim <span class="op">=</span> <span class="fl">9999</span>, </span>
<span>                    iseed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">locm_p</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The outcome is that over 15% of observations have two sided p-values &lt; 0.005 without multiple comparison adjustment, and about 1.5% with Bonferroni adjustment, when the p-values are calculated using the standard deviate of the permutation samples and the normal distribution.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">locm_p</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="st">"Pr(z != E(Ii))"</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">pva</span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pvsp</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">pvsp</span>, <span class="fl">2</span>, <span class="va">f</span><span class="op">)</span></span>
<span><span class="co">#       none        FDR         BY Bonferroni </span></span>
<span><span class="co">#        382        147         64         38</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since the variable under analysis may not be normally distributed, the p-values can also be calculated by finding the rank of the observed <span class="math inline">\(I_i\)</span> among the rank-based simulated values, and looking up the probability value from the uniform distribution taking the <code>alternative</code> choice into account:</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">locm_p</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="st">"Pr(z != E(Ii)) Sim"</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">pva</span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pvsp</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">pvsp</span>, <span class="fl">2</span>, <span class="va">f</span><span class="op">)</span></span>
<span><span class="co">#       none        FDR         BY Bonferroni </span></span>
<span><span class="co">#        386        128          0          0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now the <code>"BY"</code> and Bonferroni counts of <em>interesting</em> locations are zero with 9999 samples, but may be recovered by increasing the sample count to 999999 if required; the FDR adjustment and <em>interesting</em> cutoff 0.005 yields about 5% locations.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_pv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">locm</span><span class="op">[</span>, <span class="st">"Pr(z != E(Ii))"</span><span class="op">]</span>, <span class="st">"fdr"</span><span class="op">)</span></span>
<span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_std_pv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">locm_p</span><span class="op">[</span>, <span class="st">"Pr(z != E(Ii))"</span><span class="op">]</span>, </span>
<span>                                   <span class="st">"fdr"</span><span class="op">)</span></span>
<span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_p_pv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">locm_p</span><span class="op">[</span>, <span class="st">"Pr(z != E(Ii)) Sim"</span><span class="op">]</span>,</span>
<span>                                 <span class="st">"fdr"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"locm_pv"</span>, <span class="st">"locm_std_pv"</span>, <span class="st">"locm_p_pv"</span><span class="op">)</span>, </span>
<span>                breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.0005</span>, <span class="fl">0.001</span>, <span class="fl">0.005</span>, <span class="fl">0.01</span>, </span>
<span>                         <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                title <span class="op">=</span> <span class="st">"Pseudo p-values\nLocal Moran's I"</span>,</span>
<span>                palette<span class="op">=</span><span class="st">"-YlOrBr"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_facets.html">tm_facets</a></span><span class="op">(</span>free.scales <span class="op">=</span> <span class="cn">FALSE</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>panel.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Analytical conditional"</span>,</span>
<span>                               <span class="st">"Permutation std. dev."</span>,</span>
<span>                               <span class="st">"Permutation rank"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-localmoranPr" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-localmoranPr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="15-Measures_files/figure-html/fig-localmoranPr-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-localmoranPr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.3: Local Moran’s I FDR probability values: left upper panel: analytical conditional p-values; right upper panel: permutation standard deviate conditional p-values; left lower panel: permutation rank conditional p-values, first-round turnout, row-standardised neighbours
</figcaption></figure>
</div>
</div>
</div>
<p>Proceeding using the FDR adjustment and an <em>interesting</em> location cutoff of <span class="math inline">\(0.005\)</span>, we can see from <a href="#fig-localmoranPr" class="quarto-xref">Figure&nbsp;<span>15.3</span></a> that the adjusted probability values for the analytical conditional approach, the approach using the moments of the sampled values from permutation sampling, and the approach using the ranks of observed values among permutation samples all yield similar maps, as the distribution of the input variable is quite close to normal.</p>
<p> In presenting local Moran’s <span class="math inline">\(I\)</span>, use is often made of “hotspot” maps. Because <span class="math inline">\(I_i\)</span> takes high values both for strong positive autocorrelation of low and high values of the input variable, it is hard to show where “clusters” of similar neighbours with low or high values of the input variable occur. The quadrants of the Moran plot are used, by creating a categorical quadrant variable interacting the input variable and its spatial lag split at their means. The quadrant categories are then set to NA if, for the chosen probability value and adjustment, <span class="math inline">\(I_i\)</span> would not be considered <em>interesting</em>. Here, for the FDR adjusted conditional analytical probability values (<a href="#fig-localmoranPr" class="quarto-xref">Figure&nbsp;<span>15.3</span></a>, upper left panel), 53 observations belong to <code>"Low-Low"</code> cluster cores, and 96 to <code>"High-High"</code> cluster cores, similarly for the standard deviate-based permutation p-values (<a href="#fig-localmoranPr" class="quarto-xref">Figure&nbsp;<span>15.3</span></a>, upper right panel), but the rank-based permutation p-values reduce the <code>"High-High"</code> count and increase the <code>"Low-Low"</code> count <a href="#fig-localmoranPr" class="quarto-xref">Figure&nbsp;<span>15.3</span></a> lower left panel:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">quadr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">locm</span>, <span class="st">"quadr"</span><span class="op">)</span><span class="op">$</span><span class="va">mean</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">quadr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">locm</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname<span class="op">=</span><span class="st">"Pr(z != E(Ii))"</span>, cutoff <span class="op">=</span> <span class="fl">0.005</span>, </span>
<span>                droplevels<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_an_q</span></span>
<span><span class="va">locm_p</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname<span class="op">=</span><span class="st">"Pr(z != E(Ii))"</span>, cutoff <span class="op">=</span> <span class="fl">0.005</span>, </span>
<span>                  droplevels<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_ac_q</span> </span>
<span><span class="va">locm_p</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname<span class="op">=</span><span class="st">"Pr(z != E(Ii)) Sim"</span>, cutoff <span class="op">=</span> <span class="fl">0.005</span>,</span>
<span>                  droplevels <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_cp_q</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_an_q</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_ac_q</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_cp_q</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="st">"Moran plot quadrants"</span> <span class="op">=</span> <span class="va">a</span>, <span class="st">"Analytical cond."</span> <span class="op">=</span> <span class="va">b</span>, </span>
<span>  <span class="st">"Permutation std. cond."</span> <span class="op">=</span> <span class="va">c</span>, <span class="st">"Permutation rank cond."</span> <span class="op">=</span> <span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#           Moran plot quadrants Analytical cond.</span></span>
<span><span class="co"># Low-Low                   1040               53</span></span>
<span><span class="co"># High-Low                   264                0</span></span>
<span><span class="co"># Low-High                   213                0</span></span>
<span><span class="co"># High-High                  978               96</span></span>
<span><span class="co"># &lt;NA&gt;                         0             2346</span></span>
<span><span class="co">#           Permutation std. cond. Permutation rank cond.</span></span>
<span><span class="co"># Low-Low                       54                     62</span></span>
<span><span class="co"># High-Low                       0                      0</span></span>
<span><span class="co"># Low-High                       0                      0</span></span>
<span><span class="co"># High-High                     93                     66</span></span>
<span><span class="co"># &lt;NA&gt;                        2348                   2367</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_an_q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_an_q</span><span class="op">)</span></span>
<span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_ac_q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_ac_q</span><span class="op">)</span></span>
<span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_cp_q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_cp_q</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hs_an_q"</span>, <span class="st">"hs_ac_q"</span>, <span class="st">"hs_cp_q"</span><span class="op">)</span>,</span>
<span>        colorNA <span class="op">=</span> <span class="st">"grey95"</span>, textNA<span class="op">=</span><span class="st">"Not \"interesting\""</span>,</span>
<span>        title <span class="op">=</span> <span class="st">"Turnout hotspot status \nLocal Moran's I"</span>,</span>
<span>        palette <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_facets.html">tm_facets</a></span><span class="op">(</span>free.scales <span class="op">=</span> <span class="cn">FALSE</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>panel.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Analytical conditional"</span>,</span>
<span>                               <span class="st">"Permutation std. cond."</span>,</span>
<span>                               <span class="st">"Permutation rank cond."</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-Iihotspots" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-Iihotspots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="15-Measures_files/figure-html/fig-Iihotspots-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Iihotspots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.4: Local Moran's I FDR hotspot cluster core maps <span class="math inline">\(\alpha = 0.005\)</span>: left upper panel: analytical conditional p-values; right upper panel: permutation standard deviate conditional p-values; left lower panel: permutation rank conditional p-values, first-round turnout, row-standardised neighbours
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-Iihotspots" class="quarto-xref">Figure&nbsp;<span>15.4</span></a> shows that there is very little difference between the FDR-adjusted <em>interesting</em> clusters with a choice of an <span class="math inline">\(\alpha=0.005\)</span> probability value cutoff for the three approaches of analytical conditional standard deviates, permutation-based standard deviates, and rank-based probability values; the <code>"High-High"</code> cluster cores are metropolitan areas.</p>
<p><span class="citation" data-cites="tiefelsdorf:02">Tiefelsdorf (<a href="references.html#ref-tiefelsdorf:02" role="doc-biblioref">2002</a>)</span> argues that standard approaches to the calculation of the standard deviates of local Moran’s <span class="math inline">\(I_i\)</span> should be supplemented by numerical estimates, and shows that saddlepoint approximations are a computationally efficient way of achieving this goal. The <code>localmoran.sad</code> function takes a fitted linear model as its first argument, so we first fit a null (intercept only) model, but use case weights because the numbers entitled to vote vary greatly between observations:</p>
<p> </p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">I_turnout</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">lm_null</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Saddlepoint approximation is as computationally intensive as conditional permutation, because, rather than computing a simple measure on many samples, a good deal of numerical calculation is needed for each local approximation:</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lm_null</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localmoran.sad.html">localmoran.sad</a></span><span class="op">(</span>nb <span class="op">=</span> <span class="va">nb_q</span>, style <span class="op">=</span> <span class="st">"W"</span>,</span>
<span>                                  alternative <span class="op">=</span> <span class="st">"two.sided"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">locm_sad_null</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The chief advantage of the saddlepoint approximation is that it takes a fitted linear model rather than simply a numerical variable, so the residuals are analysed. With an intercept-only model, the results are similar to local Moran’s <span class="math inline">\(I_i\)</span>, but we can weight the observations, here by the count of those entitled to vote, which should down-weight small units of observation:</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">I_turnout</span> <span class="op">~</span> <span class="fl">1</span>, weights <span class="op">=</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">I_entitled_to_vote</span><span class="op">)</span> <span class="op">-&gt;</span></span>
<span>        <span class="va">lm_null_weights</span></span>
<span><span class="va">lm_null_weights</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localmoran.sad.html">localmoran.sad</a></span><span class="op">(</span>nb <span class="op">=</span> <span class="va">nb_q</span>, style <span class="op">=</span> <span class="st">"W"</span>,</span>
<span>                           alternative <span class="op">=</span> <span class="st">"two.sided"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">locm_sad_null_weights</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we add the categorical variable distinguishing between rural, urban and other types of observational unit:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">I_turnout</span> <span class="op">~</span> <span class="va">Types</span>, weights<span class="op">=</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">I_entitled_to_vote</span><span class="op">)</span> <span class="op">-&gt;</span></span>
<span>        <span class="va">lm_types</span></span>
<span><span class="va">lm_types</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localmoran.sad.html">localmoran.sad</a></span><span class="op">(</span>nb <span class="op">=</span> <span class="va">nb_q</span>, style <span class="op">=</span> <span class="st">"W"</span>,</span>
<span>                                  alternative <span class="op">=</span> <span class="st">"two.sided"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">locm_sad_types</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">locm_sad_null</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname<span class="op">=</span><span class="st">"Pr. (Sad)"</span>,</span>
<span>                     cutoff<span class="op">=</span><span class="fl">0.005</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_sad0</span></span>
<span><span class="va">locm_sad_null_weights</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname<span class="op">=</span><span class="st">"Pr. (Sad)"</span>,</span>
<span>                     cutoff <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_sad1</span></span>
<span><span class="va">locm_sad_types</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname<span class="op">=</span><span class="st">"Pr. (Sad)"</span>,</span>
<span>                     cutoff <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_sad2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hs_cp_q"</span>, <span class="st">"locm_sad0"</span>, <span class="st">"locm_sad1"</span>,  <span class="st">"locm_sad2"</span><span class="op">)</span>,</span>
<span>    colorNA <span class="op">=</span> <span class="st">"grey95"</span>, textNA <span class="op">=</span> <span class="st">"Not \"interesting\""</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Turnout hotspot status \nLocal Moran's I"</span>,</span>
<span>    palette <span class="op">=</span><span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_facets.html">tm_facets</a></span><span class="op">(</span>free.scales <span class="op">=</span> <span class="cn">FALSE</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>panel.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Permutation rank"</span>, </span>
<span>     <span class="st">"saddlepoint null"</span>, <span class="st">"saddlepoint weighted null"</span>, </span>
<span>     <span class="st">"saddlepoint weighted types"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-localmoranHsad" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-localmoranHsad-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="15-Measures_files/figure-html/fig-localmoranHsad-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-localmoranHsad-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.5: Local Moran's I FDR hotspot cluster core maps, two-sided, <em>interesting</em> cutoff <span class="math inline">\(\alpha = 0.005\)</span>: left upper panel: permutation rank conditional p-values; right upper panel: null (intercept only) model saddlepoint p-values; left lower panel: weighted null (intercept only) model saddlepoint p-values; right lower panel: weighted types model saddlepoint p-values, for first-round turnout, row-standardised neighbours
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span>null <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/append.html">append</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_sad0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Low-High"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      weighted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/append.html">append</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_sad1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Low-High"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      type_weighted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/append.html">append</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_sad2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Low-High"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#               Low-Low Low-High High-High &lt;NA&gt;</span></span>
<span><span class="co"># null               19        0        55 2421</span></span>
<span><span class="co"># weighted            9        0        52 2434</span></span>
<span><span class="co"># type_weighted      13        0        81 2401</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div style="page-break-after: always;"></div>
<p><a href="#fig-localmoranHsad" class="quarto-xref">Figure&nbsp;<span>15.5</span></a> includes the permutation rank cluster cores for comparison (upper left panel). Because saddlepoint approximation permits richer mean models to be used, and possibly because the approximation approach is inherently local, relating regression residual values at <span class="math inline">\(i\)</span> to those of its neighbours, the remaining three panels diverge somewhat. The intercept-only (null) model is fairly similar to standard local Moran’s <span class="math inline">\(I_i\)</span>, but weighting by counts of eligible voters removes most of the <code>"Low-Low"</code> cluster cores. Adding the type categorical variable strengthens the urban <code>"High-High"</code> cluster cores but removes the Warsaw boroughs as <em>interesting</em> cluster cores. The central boroughs are surrounded by other boroughs, all with high turnout, not driven by autocorrelation but by being metropolitan boroughs. It is also possible to use saddlepoint approximation where the global spatial process has been incorporated, removing the conflation of global and local spatial autocorrelation in standard approaches.</p>
<p>The same can also be accomplished using exact methods, but may require more tuning as numerical integration may fail, returning <code>NaN</code> rather than the exact estimate of the standard deviate <span class="citation" data-cites="bivandetal:09">(<a href="references.html#ref-bivandetal:09" role="doc-biblioref">Bivand, Müller, and Reder 2009</a>)</span>:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lm_types</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localmoran.exact.html">localmoran.exact</a></span><span class="op">(</span>nb <span class="op">=</span> <span class="va">nb_q</span>, style <span class="op">=</span> <span class="st">"W"</span>, </span>
<span>    alternative <span class="op">=</span> <span class="st">"two.sided"</span>, useTP<span class="op">=</span><span class="cn">TRUE</span>, truncErr<span class="op">=</span><span class="fl">1e-8</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">locm_ex_types</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">locm_ex_types</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname <span class="op">=</span> <span class="st">"Pr. (exact)"</span>,</span>
<span>                         cutoff <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_ex</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"locm_sad2"</span>, <span class="st">"locm_ex"</span><span class="op">)</span>, colorNA <span class="op">=</span> <span class="st">"grey95"</span>,</span>
<span>        textNA <span class="op">=</span> <span class="st">"Not \"interesting\""</span>, </span>
<span>        title <span class="op">=</span> <span class="st">"Turnout hotspot status \nLocal Moran's I"</span>,</span>
<span>        palette <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_facets.html">tm_facets</a></span><span class="op">(</span>free.scales <span class="op">=</span> <span class="cn">FALSE</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>panel.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"saddlepoint weighted types"</span>,</span>
<span>                               <span class="st">"Exact weighted types"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-localmoranHsadex" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-localmoranHsadex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="15-Measures_files/figure-html/fig-localmoranHsadex-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-localmoranHsadex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.6: Local Moran’s I FDR hotspot cluster core maps, two-sided, <em>interesting</em> cutoff <span class="math inline">\(\alpha = 0.005\)</span>: left panel: weighted types model saddlepoint p-values; right panel: weighted types model exact p-values, for first-round turnout, row-standardised neighbours
</figcaption></figure>
</div>
</div>
</div>
<p>As <a href="#fig-localmoranHsadex" class="quarto-xref">Figure&nbsp;<span>15.6</span></a> shows, the exact and saddlepoint approximation methods yield almost identical cluster classifications from the same regression residuals, multiple comparison adjustment method, and cutoff level, with the exact method returning four more <em>interesting</em> observations:</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>Saddlepoint <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_sad2</span><span class="op">)</span>,</span>
<span>      exact <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">locm_ex</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#            exact</span></span>
<span><span class="co"># Saddlepoint Low-Low High-High &lt;NA&gt;</span></span>
<span><span class="co">#   Low-Low        13         0    0</span></span>
<span><span class="co">#   High-High       0        81    0</span></span>
<span><span class="co">#   &lt;NA&gt;            2         2 2397</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="local-getis-ord-g_i" class="level3"><h3 class="anchored" data-anchor-id="local-getis-ord-g_i">Local Getis-Ord <span class="math inline">\(G_i\)</span>
</h3>
<p> </p>
<p>The local Getis-Ord <span class="math inline">\(G_i\)</span> measure <span class="citation" data-cites="getis+ord:92 getis+ord:96">(<a href="references.html#ref-getis+ord:92" role="doc-biblioref">Getis and Ord 1992</a>, <a href="references.html#ref-getis+ord:96" role="doc-biblioref">1996</a>)</span> is reported as a standard deviate, and, may also take the <span class="math inline">\(G^*_i\)</span> form where self-neighbours are inserted into the neighbour object using <code>include.self</code>. The observed and expected values of local <span class="math inline">\(G\)</span> with their analytical variances may also be returned if <code>return_internals=TRUE</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">I_turnout</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localG.html">localG</a></span><span class="op">(</span><span class="va">lw_q_W</span>, return_internals <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">locG</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Permutation inference is also available for this measure:</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">I_turnout</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localG.html">localG_perm</a></span><span class="op">(</span><span class="va">lw_q_W</span>, nsim <span class="op">=</span> <span class="fl">9999</span>, iseed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">locG_p</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The correlation between the two-sided probability values for analytical and permutation-based standard deviates (first two columns and rows) and permutation rank-based probability values are very strong:</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>localG<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">locG</span>, <span class="st">"internals"</span><span class="op">)</span><span class="op">[</span>, <span class="st">"Pr(z != E(Gi))"</span><span class="op">]</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">locG_p</span>, <span class="st">"internals"</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Pr(z != E(Gi))"</span>, </span>
<span>                                  <span class="st">"Pr(z != E(Gi)) Sim"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                    localG Pr(z != E(Gi)) Pr(z != E(Gi)) Sim</span></span>
<span><span class="co"># localG                  1              1                  1</span></span>
<span><span class="co"># Pr(z != E(Gi))          1              1                  1</span></span>
<span><span class="co"># Pr(z != E(Gi)) Sim      1              1                  1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="local-gearys-c_i" class="level3"><h3 class="anchored" data-anchor-id="local-gearys-c_i">Local Geary’s <span class="math inline">\(C_i\)</span>
</h3>
<p> </p>
<p><span class="citation" data-cites="https://doi.org/10.1111/gean.12164">Anselin (<a href="references.html#ref-https://doi.org/10.1111/gean.12164" role="doc-biblioref">2019</a>)</span> extends <span class="citation" data-cites="anselin:95">Anselin (<a href="references.html#ref-anselin:95" role="doc-biblioref">1995</a>)</span> and has been recently added to <strong>spdep</strong> thanks to contributions by Josiah Parry (pull request https://github.com/r-spatial/spdep/pull/66). The conditional permutation framework used for <span class="math inline">\(I_i\)</span> and <span class="math inline">\(G_i\)</span> is also used for <span class="math inline">\(C_i\)</span>:</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">I_turnout</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localC.html">localC_perm</a></span><span class="op">(</span><span class="va">lw_q_W</span>, nsim<span class="op">=</span><span class="fl">9999</span>, iseed<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">locC_p</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The permutation standard deviate-based and rank-based probability values are not as highly correlated as for <span class="math inline">\(G_i\)</span>, in part reflecting the difference in view of autocorrelation in <span class="math inline">\(C_i\)</span> as represented by a function of the differences between values rather than the products of values:</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">locC_p</span>, <span class="st">"pseudo-p"</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Pr(z != E(Ci))"</span>,</span>
<span>                                 <span class="st">"Pr(z != E(Ci)) Sim"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#                    Pr(z != E(Ci)) Pr(z != E(Ci)) Sim</span></span>
<span><span class="co"># Pr(z != E(Ci))              1.000              0.966</span></span>
<span><span class="co"># Pr(z != E(Ci)) Sim          0.966              1.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">locC_p</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname <span class="op">=</span> <span class="st">"Pr(z != E(Ci)) Sim"</span>,</span>
<span>                  cutoff <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_C</span></span>
<span><span class="va">locG_p</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname <span class="op">=</span> <span class="st">"Pr(z != E(Gi)) Sim"</span>,</span>
<span>                  cutoff <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_G</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"hs_cp_q"</span>, </span>
<span>            palette <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span>,</span>
<span>            colorNA <span class="op">=</span> <span class="st">"grey95"</span>, textNA <span class="op">=</span> <span class="st">"Not \"interesting\""</span>,</span>
<span>            title <span class="op">=</span> <span class="st">"Turnout hotspot status\nLocal Moran I"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>legend.outside<span class="op">=</span><span class="cn">TRUE</span>, legend.outside.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"hs_G"</span>,</span>
<span>            palette <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span>,</span>
<span>            colorNA <span class="op">=</span> <span class="st">"grey95"</span>, textNA<span class="op">=</span><span class="st">"Not \"interesting\""</span>,</span>
<span>            title <span class="op">=</span> <span class="st">"Turnout hotspot status\nLocal Getis/Ord G"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>legend.outside<span class="op">=</span><span class="cn">TRUE</span>, legend.outside.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span>
<span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"hs_C"</span>,</span>
<span>            palette <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">]</span>,</span>
<span>            colorNA <span class="op">=</span> <span class="st">"grey95"</span>, textNA<span class="op">=</span><span class="st">"Not \"interesting\""</span>,</span>
<span>            title <span class="op">=</span> <span class="st">"Turnout hotspot status\nLocal Geary C"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>legend.outside<span class="op">=</span><span class="cn">TRUE</span>, legend.outside.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tmap_arrange.html">tmap_arrange</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span>, <span class="va">m3</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-localIGC" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-localIGC-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="15-Measures_files/figure-html/fig-localIGC-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-localIGC-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.7: FDR hotspot cluster core maps, two-sided, <em>interesting</em> cutoff <span class="math inline">\(\alpha = 0.005\)</span>: left panel: local Moran's <span class="math inline">\(I_i\)</span>; centre panel: local Getis-Ord <span class="math inline">\(G_i\)</span>; right panel: local Geary's <span class="math inline">\(C_i\)</span>; first-round turnout, row-standardised neighbours
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-localIGC" class="quarto-xref">Figure&nbsp;<span>15.7</span></a> shows that the cluster cores identified as <em>interesting</em> using <span class="math inline">\(I_i\)</span>, <span class="math inline">\(G_i\)</span> and <span class="math inline">\(C_i\)</span> for the same variable, first-round turnout, and the same spatial weights, for rank-based permutation FDR adjusted probability values and an <span class="math inline">\(\alpha = 0.005\)</span> cutoff, are very similar. In most cases, the <code>"High-High"</code> cluster cores are urban areas, and <code>"Low-Low"</code> cores are sparsely populated rural areas in the North, in addition to the German national minority areas close to the southern border. The three measures use slightly different strategies for naming cluster cores: <span class="math inline">\(I_i\)</span> uses quadrants of the Moran scatterplot, <span class="math inline">\(G_i\)</span> splits into <code>"Low"</code> and <code>"High"</code> on the mean of the input variable (which is the same as the first component in the <span class="math inline">\(I_i\)</span> tuple), and univariate <span class="math inline">\(C_i\)</span> on the mean of the input variable and zero for its lag. As before, cluster categories that do not occur are dropped.</p>
<p>For comparison, and before moving to multivariate <span class="math inline">\(C_i\)</span>, let us take the univariate <span class="math inline">\(C_i\)</span> for the second (final) round turnout. One would expect that the run-off between the two top candidates from the first-round might mobilise some voters who did not have a clear first-round preference, but that it discourages some of those with strong loyalty to a candidate eliminated after the first round:</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pol_pres15</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="va">II_turnout</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localC.html">localC_perm</a></span><span class="op">(</span><span class="va">lw_q_W</span>, nsim<span class="op">=</span><span class="fl">9999</span>, iseed<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">locC_p_II</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">locC_p_II</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname <span class="op">=</span> <span class="st">"Pr(z != E(Ci)) Sim"</span>,</span>
<span>                     cutoff <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_C_II</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Multivariate <span class="math inline">\(C_i\)</span> <span class="citation" data-cites="https://doi.org/10.1111/gean.12164">(<a href="references.html#ref-https://doi.org/10.1111/gean.12164" role="doc-biblioref">Anselin 2019</a>)</span> is taken as the sum of univariate <span class="math inline">\(C_i\)</span> divided by the number of variables, but permutation is fixed so that the correlation between the variables is unchanged:</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pol_pres15</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">I_turnout</span>, <span class="va">II_turnout</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localC.html">localC_perm</a></span><span class="op">(</span><span class="va">lw_q_W</span>, nsim<span class="op">=</span><span class="fl">9999</span>, iseed<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">locMvC_p</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us check that the multivariate <span class="math inline">\(C_i\)</span> is equal to the mean of the univariate <span class="math inline">\(C_i\)</span>:</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">locMvC_p</span>, <span class="op">(</span><span class="va">locC_p</span><span class="op">+</span><span class="va">locC_p_II</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span>,</span>
<span>          check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">locMvC_p</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname <span class="op">=</span> <span class="st">"Pr(z != E(Ci)) Sim"</span>,</span>
<span>                    cutoff <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_MvC</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"hs_C"</span>, </span>
<span>    palette <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    colorNA <span class="op">=</span> <span class="st">"grey95"</span>, textNA <span class="op">=</span> <span class="st">"Not \"interesting\""</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"First round turnout\nLocal Geary C"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>legend.outside<span class="op">=</span><span class="cn">TRUE</span>, legend.outside.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span>
<span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"hs_C_II"</span>, </span>
<span>    palette <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span>, </span>
<span>    colorNA <span class="op">=</span> <span class="st">"grey95"</span>, textNA <span class="op">=</span> <span class="st">"Not \"interesting\""</span>,</span>
<span>    title<span class="op">=</span><span class="st">"Second round turnout\nLocal Geary C"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>legend.outside<span class="op">=</span><span class="cn">TRUE</span>, legend.outside.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span>
<span><span class="va">m5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"hs_MvC"</span>, </span>
<span>    palette <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    colorNA <span class="op">=</span> <span class="st">"grey95"</span>, textNA <span class="op">=</span> <span class="st">"Not \"interesting\""</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Both rounds turnout\nLocal Multivariate Geary C"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>legend.outside<span class="op">=</span><span class="cn">TRUE</span>, legend.outside.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tmap_arrange.html">tmap_arrange</a></span><span class="op">(</span><span class="va">m3</span>, <span class="va">m4</span>, <span class="va">m5</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-localCmulti" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-localCmulti-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="15-Measures_files/figure-html/fig-localCmulti-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-localCmulti-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.8: FDR hotspot cluster core maps, two-sided, <em>interesting</em> cutoff <span class="math inline">\(\alpha = 0.005\)</span>: left panel: local <span class="math inline">\(C_i\)</span>, first-round turnout; centre panel: local <span class="math inline">\(C_i\)</span>, second-round turnout; right panel: local multivariate <span class="math inline">\(C_i\)</span>, both turnout rounds; row-standardised neighbours
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-localCmulti" class="quarto-xref">Figure&nbsp;<span>15.8</span></a> indicates that the multivariate measure picks up aggregated elements of observations found <em>interesting</em> in the two univariate measures. We can break this down by interacting the first- and second-round univariate measures, and tabulating against the multivariate measure.</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_C</span><span class="op">)</span>,</span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_C_II</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">":"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_MvC</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                      </span></span>
<span><span class="co">#                       Positive &lt;NA&gt;</span></span>
<span><span class="co">#   High-High:High-High       82    0</span></span>
<span><span class="co">#   NA:High-High              37   21</span></span>
<span><span class="co">#   Low-Low:Low-Low           24    0</span></span>
<span><span class="co">#   NA:Low-Low                41   14</span></span>
<span><span class="co">#   NA:Other Positive          1    0</span></span>
<span><span class="co">#   NA:Negative                0    1</span></span>
<span><span class="co">#   High-High:NA              17    3</span></span>
<span><span class="co">#   Low-Low:NA                 6    2</span></span>
<span><span class="co">#   NA:NA                     43 2203</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For these permutation outcomes, 47 observations in the multivariate case are found <em>interesting</em> where neither of the univariate <span class="math inline">\(C_i\)</span> were found <em>interesting</em> (FDR, cutoff <span class="math inline">\(0.005\)</span>). Almost all of the observations found <em>interesting</em> in both first and second round, are also interesting in the multivariate case, but outcomes are more mixed when observations were only found interesting in one of the two rounds.</p>
</section><section id="the-rgeoda-package" class="level3"><h3 class="anchored" data-anchor-id="the-rgeoda-package">The <strong>rgeoda</strong> package</h3>
<p></p>
<p>Geoda has been wrapped for R as <strong>rgeoda</strong> <span class="citation" data-cites="R-rgeoda">(<a href="references.html#ref-R-rgeoda" role="doc-biblioref">Li and Anselin 2022</a>)</span>, and provides very similar functionalities for the exploration of spatial autocorrelation in areal data as matching parts of <strong>spdep</strong>. The active objects are kept as pointers to a compiled code workspace; using compiled code for all operations (as in Geoda itself) makes <strong>rgeoda</strong> perform fast, but makes it less flexible when modifications or enhancements are desired.</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/geodacenter/rgeoda/">rgeoda</a></span><span class="op">)</span></span>
<span><span class="va">Geoda_w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://geodacenter.github.io/rgeoda/reference/queen_weights.html">queen_weights</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">Geoda_w</span><span class="op">)</span></span>
<span><span class="co">#                      name               value</span></span>
<span><span class="co"># 1 number of observations:                2495</span></span>
<span><span class="co"># 2          is symmetric:                 TRUE</span></span>
<span><span class="co"># 3               sparsity: 0.00228786229774178</span></span>
<span><span class="co"># 4        # min neighbors:                   1</span></span>
<span><span class="co"># 5        # max neighbors:                  13</span></span>
<span><span class="co"># 6       # mean neighbors:    5.70821643286573</span></span>
<span><span class="co"># 7     # median neighbors:                   6</span></span>
<span><span class="co"># 8           has isolates:               FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For comparison, let us take the multivariate <span class="math inline">\(C_i\)</span> measure of turnout in the two rounds of the 2015 Polish presidential election as above:</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lisa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://geodacenter.github.io/rgeoda/reference/local_multigeary.html">local_multigeary</a></span><span class="op">(</span><span class="va">Geoda_w</span>, </span>
<span>    <span class="va">pol_pres15</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"I_turnout"</span>, <span class="st">"II_turnout"</span><span class="op">)</span><span class="op">]</span>, </span>
<span>    cpu_threads <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    permutations <span class="op">=</span> <span class="fl">99999</span>, seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The contiguity neighbours are the same as those found by <code>poly2nb</code>:</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/card.html">card</a></span><span class="op">(</span><span class="va">nb_q</span><span class="op">)</span>, <span class="fu"><a href="https://geodacenter.github.io/rgeoda/reference/lisa_num_nbrs.html">lisa_num_nbrs</a></span><span class="op">(</span><span class="va">lisa</span><span class="op">)</span>, </span>
<span>          check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>as are the multivariate <span class="math inline">\(C_i\)</span> values the same as those found above:</p>
<p></p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://geodacenter.github.io/rgeoda/reference/lisa_values.html">lisa_values</a></span><span class="op">(</span><span class="va">lisa</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">locMvC_p</span><span class="op">)</span>,</span>
<span>          check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One difference is that the range of the folded two-sided rank-based permutation probability values used by <strong>rgeoda</strong> is <span class="math inline">\([0, 0.5]\)</span>, also reported in <strong>spdep</strong>:</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">locMvC_p</span>, <span class="st">"pseudo-p"</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Pr(z != E(Ci)) Sim"</span>, </span>
<span>                                <span class="st">"Pr(folded) Sim"</span><span class="op">)</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">range</span><span class="op">)</span></span>
<span><span class="co">#      Pr(z != E(Ci)) Sim Pr(folded) Sim</span></span>
<span><span class="co"># [1,]             0.0002         0.0001</span></span>
<span><span class="co"># [2,]             0.9974         0.4987</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This means that the cutoff corresponding to <span class="math inline">\(0.005\)</span> over <span class="math inline">\([0, 1]\)</span> is <span class="math inline">\(0.0025\)</span> over <span class="math inline">\([0, 0.5]\)</span>:</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">locMvC_p</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/hotspotmap.html">hotspot</a></span><span class="op">(</span>Prname <span class="op">=</span> <span class="st">"Pr(folded) Sim"</span>,</span>
<span>                    cutoff <span class="op">=</span> <span class="fl">0.0025</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_MvCa</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So although <code>local_multigeary</code> used the default cutoff of <span class="math inline">\(0.05\)</span> in setting cluster core classes, we can sharpen the cutoff and apply the FDR adjustment on output components of the <code>lisa</code> object in the compiled code workspace:</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mvc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://geodacenter.github.io/rgeoda/reference/lisa_clusters.html">lisa_clusters</a></span><span class="op">(</span><span class="va">lisa</span><span class="op">)</span>, levels<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">2</span>,</span>
<span>              labels <span class="op">=</span> <span class="fu"><a href="https://geodacenter.github.io/rgeoda/reference/lisa_labels.html">lisa_labels</a></span><span class="op">(</span><span class="va">lisa</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">mvc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="fu"><a href="https://geodacenter.github.io/rgeoda/reference/lisa_pvalues.html">lisa_pvalues</a></span><span class="op">(</span><span class="va">lisa</span><span class="op">)</span>, <span class="st">"fdr"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">0.0025</span></span>
<span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">geoda_mvc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span><span class="op">(</span><span class="va">mvc</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>About 80 more observations are found <em>interesting</em> in the <strong>rgeoda</strong> permutation, and further analysis of implementation details is still in progress:</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/addmargins.html">addmargins</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>spdep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">hs_MvCa</span><span class="op">)</span>,</span>
<span>                 rgeoda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">addNA</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">$</span><span class="va">geoda_mvc</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#           rgeoda</span></span>
<span><span class="co"># spdep      Positive &lt;NA&gt;  Sum</span></span>
<span><span class="co">#   Positive      245    6  251</span></span>
<span><span class="co">#   &lt;NA&gt;           77 2167 2244</span></span>
<span><span class="co">#   Sum           322 2173 2495</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"hs_MvCa"</span>, </span>
<span>        palette <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">]</span>,</span>
<span>        colorNA <span class="op">=</span> <span class="st">"grey95"</span>, textNA <span class="op">=</span> <span class="st">"Not \"interesting\""</span>,</span>
<span>  title <span class="op">=</span> <span class="st">"Both rounds turnout spdep\nLocal Multivariate Geary C"</span><span class="op">)</span></span>
<span><span class="va">m6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pol_pres15</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"geoda_mvc"</span>, </span>
<span>        palette <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">]</span>,</span>
<span>        colorNA <span class="op">=</span> <span class="st">"grey95"</span>, textNA <span class="op">=</span> <span class="st">"Not \"interesting\""</span>,</span>
<span>  title<span class="op">=</span><span class="st">"Both rounds turnout rgeoda\nLocal Multivariate Geary C"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tmap_arrange.html">tmap_arrange</a></span><span class="op">(</span><span class="va">m5</span>, <span class="va">m6</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-localCmultix" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-localCmultix-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="15-Measures_files/figure-html/fig-localCmultix-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-localCmultix-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.9: FDR local multivariate <span class="math inline">\(C_i\)</span> hotspot cluster core maps, two-sided, <em>interesting</em> cutoff <span class="math inline">\(\alpha = 0.0025\)</span> over <span class="math inline">\([0, 0.5]\)</span>: left panel: <strong>spdep</strong>, both turnout rounds; right panel: <strong>rgeoda</strong>, both turnout rounds; row-standardised neighbours
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-localCmultix" class="quarto-xref">Figure&nbsp;<span>15.9</span></a> shows that while almost all of the 242 observations found <em>interesting</em> in the <strong>spdep</strong> implementation were also <em>interesting</em> for <strong>rgeoda</strong>, the latter found a further 86 <em>interesting</em>. Of course, permutation outcomes are bound to vary, but it remains to establish whether either or both implementations require revision.</p>
</section></section><section id="exercises" class="level2" data-number="15.4"><h2 data-number="15.4" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">15.4</span> Exercises</h2>
<ol type="1">
<li>Why are join-count measures on a chessboard so different between <code>rook</code> and <code>queen</code> neighbours?</li>
<li>Please repeat the simulation shown in <a href="#sec-measprocmisspec" class="quarto-xref"><span>Section 15.1</span></a> using the chessboard polygons and the row-standardised <code>queen</code> contiguity neighbours. Why is it important to understand that spatial autocorrelation usually signals (unavoidable) misspecification in our data?</li>
<li>Why is false discovery rate adjustment recommended for local measures of spatial autocorrelation?</li>
<li>Compare the local Moran’s <span class="math inline">\(I_i\)</span> standard deviate values for the simulated data from exercise 2 (above) for the analytical conditional approach, and saddlepoint approximation. Consider the advantages and disadvantages of the saddlepoint approximation approach.</li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-anselin:95" class="csl-entry" role="listitem">
Anselin, Luc. 1995. <span>“<span class="nocase">Local indicators of spatial association - LISA</span>.”</span> <em><span>Geographical Analysis</span></em> <span>27</span> (<span>2</span>): 93–115.
</div>
<div id="ref-anselin:96" class="csl-entry" role="listitem">
———. 1996. <span>“The <span>Moran</span> Scatterplot as an <span>ESDA</span> Tool to Assess Local Instability in Spatial Association.”</span> In <em>Spatial Analytical Perspectives on <span>GIS</span></em>, edited by M. M. Fischer, H. J. Scholten, and D. Unwin, 111–25. London: Taylor &amp; Francis.
</div>
<div id="ref-https://doi.org/10.1111/gean.12164" class="csl-entry" role="listitem">
———. 2019. <span>“A Local Indicator of Multivariate Spatial Association: Extending <span>G</span>eary’s c.”</span> <em>Geographical Analysis</em> 51 (2): 133–50. <a href="https://doi.org/10.1111/gean.12164">https://doi.org/10.1111/gean.12164</a>.
</div>
<div id="ref-https://doi.org/10.1111/gean.12311" class="csl-entry" role="listitem">
Anselin, Luc, Xun Li, and Julia Koschinsky. 2021. <span>“<span>GeoDa</span>, from the Desktop to an Ecosystem for Exploring Spatial Data.”</span> <em>Geographical Analysis</em>. <a href="https://doi.org/10.1111/gean.12311">https://doi.org/10.1111/gean.12311</a>.
</div>
<div id="ref-assuncao+reis:99" class="csl-entry" role="listitem">
Assunção, R. M., and E. A. Reis. 1999. <span>“A New Proposal to Adjust <span>M</span>oran’s <span><span class="math inline">\(I\)</span></span> for Population Density.”</span> <em>Statistics in Medicine</em> 18: 2147–62.
</div>
<div id="ref-benjaminetal:18" class="csl-entry" role="listitem">
Benjamin, Daniel J., James O. Berger, Johannesson Magnus, Brian A. Nosek, Wagenmakers E-J, Richard Berk, Kenneth A. Bollen, et al. 2018. <span>“Redefine Statistical Significance.”</span> <em>Nature Human Behaviour</em> 2 (1): 6–10.
</div>
<div id="ref-fdr-BH" class="csl-entry" role="listitem">
Benjamini, Yoav, and Yosef Hochberg. 1995. <span>“Controlling the False Discovery Rate: A Practical and Powerful Approach to Multiple Testing.”</span> <em>Journal of the Royal Statistical Society. Series B (Methodological)</em> 57 (1): 289–300. <a href="https://doi.org/10.1111/j.2517-6161.1995.tb02031.x">https://doi.org/10.1111/j.2517-6161.1995.tb02031.x</a>.
</div>
<div id="ref-10.1214/aos/1013699998" class="csl-entry" role="listitem">
Benjamini, Yoav, and Daniel Yekutieli. 2001. <span>“<span class="nocase">The control of the false discovery rate in multiple testing under dependency</span>.”</span> <em>The Annals of Statistics</em> 29 (4): 1165–88. <a href="https://doi.org/10.1214/aos/1013699998">https://doi.org/10.1214/aos/1013699998</a>.
</div>
<div id="ref-bivand:22" class="csl-entry" role="listitem">
Bivand, Roger. 2022a. <span>“R Packages for Analyzing Spatial Data: A Comparative Case Study with Areal Data.”</span> <em>Geographical Analysis</em> 54 (3): 488–518. <a href="https://doi.org/10.1111/gean.12319">https://doi.org/10.1111/gean.12319</a>.
</div>
<div id="ref-R-spdep" class="csl-entry" role="listitem">
———. 2022b. <em>Spdep: Spatial Dependence: Weighting Schemes, Statistics</em>.
</div>
<div id="ref-bivandetal:09" class="csl-entry" role="listitem">
Bivand, Roger, W. Müller, and M. Reder. 2009. <span>“Power Calculations for Global and Local <span>M</span>oran’s <span><span class="math inline">\(I\)</span></span>.”</span> <em>Computational Statistics and Data Analysis</em> 53: 2859–72.
</div>
<div id="ref-Bivand2018" class="csl-entry" role="listitem">
Bivand, Roger, and David W. S. Wong. 2018. <span>“Comparing Implementations of Global and Local Indicators of Spatial Association.”</span> <em>TEST</em> 27 (3): 716–48. <a href="https://doi.org/10.1007/s11749-018-0599-x">https://doi.org/10.1007/s11749-018-0599-x</a>.
</div>
<div id="ref-BRODY200064" class="csl-entry" role="listitem">
Brody, Howard, Michael Russell Rip, Peter Vinten-Johansen, Nigel Paneth, and Stephen Rachman. 2000. <span>“Map-Making and Myth-Making in <span>B</span>road <span>S</span>treet: The <span>L</span>ondon Cholera Epidemic, 1854.”</span> <em>The Lancet</em> 356 (9223): 64–68. <a href="https://doi.org/10.1016/S0140-6736(00)02442-9">https://doi.org/10.1016/S0140-6736(00)02442-9</a>.
</div>
<div id="ref-https://doi.org/10.1111/j.0016-7363.2006.00682.x" class="csl-entry" role="listitem">
Caldas de Castro, Marcia, and Burton H. Singer. 2006. <span>“Controlling the False Discovery Rate: A New Application to Account for Multiple and Dependent Tests in Local Statistics of Spatial Association.”</span> <em>Geographical Analysis</em> 38 (2): 180–208. <a href="https://doi.org/10.1111/j.0016-7363.2006.00682.x">https://doi.org/10.1111/j.0016-7363.2006.00682.x</a>.
</div>
<div id="ref-cliff+ord:73" class="csl-entry" role="listitem">
Cliff, A. D., and J. K. Ord. 1973. <em>Spatial Autocorrelation</em>. London: Pion.
</div>
<div id="ref-cliff+ord:81" class="csl-entry" role="listitem">
———. 1981. <em>Spatial Processes</em>. London: Pion.
</div>
<div id="ref-duncanetal61" class="csl-entry" role="listitem">
Duncan, O. D., R. P. Cuzzort, and B. Duncan. 1961. <em>Statistical Geography: Problems in Analyzing Areal Data</em>. Glencoe, IL: Free Press.
</div>
<div id="ref-geary:54" class="csl-entry" role="listitem">
Geary, R. C. 1954. <span>“The Contiguity Ratio and Statistical Mapping.”</span> <em>The Incorporated Statistician</em> 5: 115–45.
</div>
<div id="ref-getis+ord:92" class="csl-entry" role="listitem">
Getis, A., and J. K. Ord. 1992. <span>“The Analysis of Spatial Association by the Use of Distance Statistics.”</span> <em>Geographical Analysis</em> 24 (2): 189–206.
</div>
<div id="ref-getis+ord:96" class="csl-entry" role="listitem">
———. 1996. <span>“Local Spatial Statistics: An Overview.”</span> In <em>Spatial Analysis: Modelling in a GIS Environment</em>, edited by P. Longley and M Batty, 261–77. Cambridge: GeoInformation International.
</div>
<div id="ref-rgeoda-package" class="csl-entry" role="listitem">
Li, Xun, and Luc Anselin. 2021. <em>Rgeoda: <span>R</span> Library for Spatial Data Analysis</em>. <a href="https://CRAN.R-project.org/package=rgeoda">https://CRAN.R-project.org/package=rgeoda</a>.
</div>
<div id="ref-R-rgeoda" class="csl-entry" role="listitem">
———. 2022. <em>Rgeoda: R Library for Spatial Data Analysis</em>. <a href="https://CRAN.R-project.org/package=rgeoda">https://CRAN.R-project.org/package=rgeoda</a>.
</div>
<div id="ref-McMillen:2003" class="csl-entry" role="listitem">
McMillen, Daniel P. 2003. <span>“Spatial Autocorrelation or Model Misspecification?”</span> <em>International Regional Science Review</em> 26: 208–17.
</div>
<div id="ref-moran48" class="csl-entry" role="listitem">
Moran, P. A. P. 1948. <span>“The Interpretation of Statistical Maps.”</span> <em>Journal of the Royal Statistical Society, Series B (Methodological)</em> 10 (2): 243–51.
</div>
<div id="ref-10.2307/143140" class="csl-entry" role="listitem">
Olsson, Gunnar. 1970. <span>“Explanation, Prediction, and Meaning Variance: An Assessment of Distance Interaction Models.”</span> <em>Economic Geography</em> 46: 223–33. <a href="https://doi.org/10.2307/143140">https://doi.org/10.2307/143140</a>.
</div>
<div id="ref-ord+getis:01" class="csl-entry" role="listitem">
Ord, J. K., and A. Getis. 2001. <span>“Testing for Local Spatial Autocorrelation in the Presence of Global Autocorrelation.”</span> <em>Journal of Regional Science</em> 41 (3): 411–32.
</div>
<div id="ref-sauer_oshan_rey_wolf_2021" class="csl-entry" role="listitem">
Sauer, Jeffery, Taylor Oshan, Sergio Rey, and Levi John Wolf. 2021. <span>“The Importance of Null Hypotheses: Understanding Differences in Local Moran’s <span class="math inline">\(I_i\)</span> Under Heteroskedasticity.”</span> <em>Geographical Analysis</em>. <a href="https://doi.org/10.1111/gean.12304">https://doi.org/10.1111/gean.12304</a>.
</div>
<div id="ref-schabenberger+gotway:2005" class="csl-entry" role="listitem">
Schabenberger, O., and C. A. Gotway. 2005. <em>Statistical Methods for Spatial Data Analysis</em>. Boca Raton/London: Chapman &amp; Hall/CRC.
</div>
<div id="ref-sokaletal:98" class="csl-entry" role="listitem">
Sokal, R. R, N. L. Oden, and B. A. Thomson. 1998. <span>“Local Spatial Autocorrelation in a Biological Model.”</span> <em>Geographical Analysis</em> 30: 331–54.
</div>
<div id="ref-tiefelsdorf:02" class="csl-entry" role="listitem">
Tiefelsdorf, M. 2002. <span>“The Saddlepoint Approximation of <span>Moran</span>’s <span>I</span> and Local <span>Moran</span>’s <span class="math inline">\({I}_i\)</span> Reference Distributions and Their Numerical Evaluation.”</span> <em>Geographical Analysis</em> 34: 187–206.
</div>
<div id="ref-10.2307/143141" class="csl-entry" role="listitem">
Tobler, W. R. 1970. <span>“A Computer Movie Simulating Urban Growth in the Detroit Region.”</span> <em>Economic Geography</em> 46: 234–40. <a href="https://doi.org/10.2307/143141">https://doi.org/10.2307/143141</a>.
</div>
<div id="ref-upton+fingleton:85" class="csl-entry" role="listitem">
Upton, G., and B. Fingleton. 1985. <em>Spatial Data Analysis by Example: Point Pattern and Qualitative Data</em>. New York: Wiley.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/r-spatial\.org\/book\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./14-Areal.html" class="pagination-link" aria-label="Proximity and Areal Data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./16-SpatialRegression.html" class="pagination-link" aria-label="Spatial Regression">
        <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Regression</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb66" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Measures of Spatial Autocorrelation {#sec-spatautocorr}</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>\index{spatial autocorrelation!measures of}</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup_sa1, include=FALSE}</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(echo = TRUE, paged.print = FALSE)</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="in">owidth &lt;- getOption("width")</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="in">xargs &lt;- function(x) {</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="in">    o &lt;- capture.output(args(x))</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="in">    oo &lt;- gsub("  *", " ", paste(o[-length(o)], collapse=""))</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="in">    ooo &lt;- strwrap(oo, width=getOption("width"), indent=1, exdent=3)</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(paste(ooo, collapse="\n"), "\n")</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="in">load("ch14.RData")</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!---</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="co">might options("width") be set to a smaller value to prevent right margin </span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="co">overruns in cals to  arg(), etc.? Maybe in each chapter? in R 80, </span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a><span class="co">RStudio 82 for this session.</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="co">---&gt;</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>When analysing areal data, it has long been recognised that, if present, spatial autocorrelation changes how we may infer, relative to the default assumption of independent observations. In the presence of spatial autocorrelation, we can predict the values of observation $i$ from the values observed at $j \in N_i$, the set of its proximate neighbours. Early results <span class="co">[</span><span class="ot">@moran48; @geary:54</span><span class="co">]</span> entered into research practice gradually, for example the social sciences <span class="co">[</span><span class="ot">@duncanetal61</span><span class="co">]</span>. These results were then collated and extended to yield a set of basic tools of analysis <span class="co">[</span><span class="ot">@cliff+ord:73; @cliff+ord:81</span><span class="co">]</span>. </span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>Cliff and Ord <span class="co">[</span><span class="ot">-@cliff+ord:73</span><span class="co">]</span> generalised and extended the expression of the spatial weights matrix representation as part of the framework for establishing the distribution theory for join-count, Moran's $I$ and Geary's $C$ statistics. This development of what have become known as global measures, returning a single value of autocorrelation for the total study area, has been supplemented by local measures returning values for each areal unit <span class="co">[</span><span class="ot">@getis+ord:92; @anselin:95</span><span class="co">]</span>.</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>\index{spatial weights matrix}</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>The measures offered by the **spdep** package have been written partly to provide implementations, but also to permit the comparative investigation of these measures and their implementation. For this reason, the implementations are written in R rather than compiled code, and they are generally slower but more flexible than implementations in the newly released **rgeoda** package <span class="co">[</span><span class="ot">@rgeoda-package; @https://doi.org/10.1111/gean.12311</span><span class="co">]</span>.</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>\index{rgeoda}</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a><span class="fu">## Measures and process misspecification {#sec-measprocmisspec}</span></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>It is not and has never been the case that Tobler's first law of geography, "Everything is related to everything else, but near things are more related than distant things", always holds absolutely. This is and has always been an oversimplification, disguising possible underlying entitation, support, and other misspecification problems. Are the units of observation appropriate for the scale of the underlying spatial process?  Could the spatial patterning of the variable of interest for the chosen entitation be accounted for by another variable? </span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>@10.2307/143141 was published in the same special issue of *Economic Geography* as @10.2307/143140, but Olsson does grasp the important point that spatial autocorrelation is not inherent in spatial phenomena, but often, is engendered by inappropriate entitation, by omitted variables and/or inappropriate functional form. The key quote from Olsson is on p. 228:</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The existence of such autocorrelations makes it tempting to agree with Tobler (1970, 236 </span><span class="co">[</span><span class="ot">the original refers to the pagination of a conference paper</span><span class="co">]</span><span class="at">) that 'everything is related to everything else, but near things are more related than distant things.' On the other hand, the fact that the autocorrelations seem to hide systematic specification errors suggests that the elevation of this statement to the status of 'the first law of geography' is at best premature. At worst, the statement may represent the spatial variant of the post hoc fallacy, which would mean that coincidence has been mistaken for a causal relation.</span></span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>The status of the "first law" is very similar to the belief that John Snow induced from a map the cause of cholera as water-borne. It may be a good way of selling GIS, but it is inaccurate: Snow had a strong working hypothesis prior to visiting Soho, and the map was prepared after the Broad Street pump was disabled as documentation that his hypothesis held <span class="co">[</span><span class="ot">@BRODY200064</span><span class="co">]</span>.</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>Measures of spatial autocorrelation unfortunately pick up other misspecifications in the way that we model data <span class="co">[</span><span class="ot">@schabenberger+gotway:2005; @McMillen:2003</span><span class="co">]</span>. For reference, Moran's $I$ is given as <span class="co">[</span><span class="ot">@cliff+ord:81, page 17</span><span class="co">]</span>:</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>\index{Moran's I}</span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a>I = \frac{n \sum_{(2)} w_{ij} z_i z_j}{S_0 \sum_{i=1}^{n} z_i^2}</span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a>where $x_i, i=1, \ldots, n$ are $n$ observations on the numeric variable of interest, $z_i = x_i - \bar{x}$, $\bar{x} = \sum_{i=1}^{n} x_i / n$, $\sum_{(2)} = \stackrel{\sum_{i=1}^{n} \sum_{j=1}^{n}}{i \neq j}$, $w_{ij}$ are the spatial weights, and $S_0 = \sum_{(2)} w_{ij}$. </span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a>First we test a random variable using the Moran test, here under the normality assumption (argument <span class="in">`randomisation=FALSE`</span>, default <span class="in">`TRUE`</span>). Inference is made on the statistic $Z(I) = \frac{I - E(I)}{\sqrt{\mathrm{Var}(I)}}$, the z-value compared with the Normal distribution for $E(I)$ and $\mathrm{Var}(I)$ for the chosen assumptions; this <span class="in">`x`</span> does not show spatial autocorrelation with these spatial weights:</span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep) <span class="sc">|&gt;</span> <span class="fu">suppressPackageStartupMessages</span>()</span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a>glance_htest <span class="ot">&lt;-</span> <span class="cf">function</span>(ht) <span class="fu">c</span>(ht<span class="sc">$</span>estimate, </span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Std deviate"</span> <span class="ot">=</span> <span class="fu">unname</span>(ht<span class="sc">$</span>statistic), </span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p.value"</span> <span class="ot">=</span> <span class="fu">unname</span>(ht<span class="sc">$</span>p.value))</span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a>(pol_pres15 <span class="sc">|&gt;</span> </span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>() <span class="ot">-&gt;</span> x) <span class="sc">|&gt;</span> </span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.test</span>(lw_q_B, <span class="at">randomisation =</span> <span class="cn">FALSE</span>,</span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a>               <span class="at">alternative =</span> <span class="st">"two.sided"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glance_htest</span>()</span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a>The test however detects quite strong positive spatial autocorrelation when we insert a gentle trend into the data, but omit to include it in the mean model, thus creating a missing variable problem but finding spatial autocorrelation instead:</span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fl">0.0015</span></span>
<span id="cb66-75"><a href="#cb66-75" aria-hidden="true" tabindex="-1"></a>coords <span class="sc">|&gt;</span> </span>
<span id="cb66-76"><a href="#cb66-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-77"><a href="#cb66-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">select =</span> <span class="dv">1</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-78"><a href="#cb66-78" aria-hidden="true" tabindex="-1"></a>    (<span class="cf">function</span>(x) x<span class="sc">/</span><span class="dv">1000</span>)() <span class="ot">-&gt;</span> t</span>
<span id="cb66-79"><a href="#cb66-79" aria-hidden="true" tabindex="-1"></a>(x <span class="sc">+</span> beta <span class="sc">*</span> t <span class="ot">-&gt;</span> x_t) <span class="sc">|&gt;</span> </span>
<span id="cb66-80"><a href="#cb66-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.test</span>(lw_q_B, <span class="at">randomisation =</span> <span class="cn">FALSE</span>,</span>
<span id="cb66-81"><a href="#cb66-81" aria-hidden="true" tabindex="-1"></a>               <span class="at">alternative =</span> <span class="st">"two.sided"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-82"><a href="#cb66-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glance_htest</span>()</span>
<span id="cb66-83"><a href="#cb66-83" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-84"><a href="#cb66-84" aria-hidden="true" tabindex="-1"></a>If we test the residuals of a linear model including the trend, the apparent spatial autocorrelation disappears:</span>
<span id="cb66-85"><a href="#cb66-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-86"><a href="#cb66-86" aria-hidden="true" tabindex="-1"></a>\index{spatial autocorrelation!of residuals}</span>
<span id="cb66-87"><a href="#cb66-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-90"><a href="#cb66-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-91"><a href="#cb66-91" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(x_t <span class="sc">~</span> t) <span class="sc">|&gt;</span> </span>
<span id="cb66-92"><a href="#cb66-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lm.morantest</span>(lw_q_B, <span class="at">alternative =</span> <span class="st">"two.sided"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-93"><a href="#cb66-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glance_htest</span>()</span>
<span id="cb66-94"><a href="#cb66-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-95"><a href="#cb66-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-96"><a href="#cb66-96" aria-hidden="true" tabindex="-1"></a>A comparison of implementations of measures of spatial autocorrelation shows that a wide range of measures is available in R in a number of packages, chiefly in the **spdep** package [@R-spdep], and that differences from other implementations can be attributed to design decisions [@Bivand2018]. The **spdep** package also includes the only implementations of exact and saddlepoint approximations to global and local Moran's I for regression residuals <span class="co">[</span><span class="ot">@tiefelsdorf:02; @bivandetal:09</span><span class="co">]</span>.</span>
<span id="cb66-97"><a href="#cb66-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-98"><a href="#cb66-98" aria-hidden="true" tabindex="-1"></a>\index{Moran's I!approximations}</span>
<span id="cb66-99"><a href="#cb66-99" aria-hidden="true" tabindex="-1"></a>\index{Moran's I!global or local}</span>
<span id="cb66-100"><a href="#cb66-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-101"><a href="#cb66-101" aria-hidden="true" tabindex="-1"></a><span class="fu">## Global measures</span></span>
<span id="cb66-102"><a href="#cb66-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-103"><a href="#cb66-103" aria-hidden="true" tabindex="-1"></a>Global measures consider the average level of spatial autocorrelation across all observations; they can of course be biased (as most spatial statistics) by edge effects where important spatial process components fall outside the study area.</span>
<span id="cb66-104"><a href="#cb66-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-105"><a href="#cb66-105" aria-hidden="true" tabindex="-1"></a><span class="fu">### Join-count tests for categorical data</span></span>
<span id="cb66-106"><a href="#cb66-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-107"><a href="#cb66-107" aria-hidden="true" tabindex="-1"></a>\index{joint-count test}</span>
<span id="cb66-108"><a href="#cb66-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-109"><a href="#cb66-109" aria-hidden="true" tabindex="-1"></a>We will begin by examining join-count statistics, where <span class="in">`joincount.test`</span> takes a <span class="in">`"factor"`</span> vector of values <span class="in">`fx`</span> and a <span class="in">`listw`</span> object, and returns a list of <span class="in">`htest`</span> (hypothesis test) objects defined in the **stats** package, one <span class="in">`htest`</span> object for each level of the <span class="in">`fx`</span> argument. The observed counts are of neighbours with the same factor levels, known as same-colour joins.</span>
<span id="cb66-110"><a href="#cb66-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-111"><a href="#cb66-111" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{joincount.test}</span>
<span id="cb66-112"><a href="#cb66-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-113"><a href="#cb66-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, eval=FALSE}</span></span>
<span id="cb66-114"><a href="#cb66-114" aria-hidden="true" tabindex="-1"></a><span class="in">args(joincount.test)</span></span>
<span id="cb66-115"><a href="#cb66-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-116"><a href="#cb66-116" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE, eval=TRUE}</span></span>
<span id="cb66-117"><a href="#cb66-117" aria-hidden="true" tabindex="-1"></a><span class="in">xargs(joincount.test)</span></span>
<span id="cb66-118"><a href="#cb66-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-119"><a href="#cb66-119" aria-hidden="true" tabindex="-1"></a>The function takes an <span class="in">`alternative`</span> argument for hypothesis testing, a <span class="in">`sampling`</span> argument showing the basis for the construction of the variance of the measure, where the default <span class="in">`"nonfree"`</span> choice corresponds to analytical permutation; the <span class="in">`spChk`</span> argument is retained for backward compatibility. For reference, the counts of factor levels for the type of municipality or Warsaw borough are:</span>
<span id="cb66-120"><a href="#cb66-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-123"><a href="#cb66-123" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-124"><a href="#cb66-124" aria-hidden="true" tabindex="-1"></a>(pol_pres15 <span class="sc">|&gt;</span> </span>
<span id="cb66-125"><a href="#cb66-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-126"><a href="#cb66-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">subset</span>(<span class="at">select =</span> types, <span class="at">drop =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> Types) <span class="sc">|&gt;</span> </span>
<span id="cb66-127"><a href="#cb66-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">table</span>()</span>
<span id="cb66-128"><a href="#cb66-128" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-129"><a href="#cb66-129" aria-hidden="true" tabindex="-1"></a>Since there are four levels, we rearrange the list of <span class="in">`htest`</span> objects to give a matrix of estimated results. The observed same-colour join-counts are tabulated with their expectations based on the counts of levels of the input factor, so that few joins would be expected between for example Warsaw boroughs, because there are very few of them. The variance calculation uses the underlying constants of the chosen <span class="in">`listw`</span> object and the counts of levels of the input factor. The z-value is obtained in the usual way by dividing the difference between the observed and expected join-counts by the square root of the variance.</span>
<span id="cb66-130"><a href="#cb66-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-131"><a href="#cb66-131" aria-hidden="true" tabindex="-1"></a>The join-count test was subsequently adapted for multi-colour join-counts <span class="co">[</span><span class="ot">@upton+fingleton:85</span><span class="co">]</span>. The implementation as <span class="in">`joincount.multi`</span> in **spdep** returns a table based on non-free sampling, and does not report p-values.</span>
<span id="cb66-132"><a href="#cb66-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-133"><a href="#cb66-133" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{joincount.multi}</span>
<span id="cb66-136"><a href="#cb66-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-137"><a href="#cb66-137" aria-hidden="true" tabindex="-1"></a>Types <span class="sc">|&gt;</span> <span class="fu">joincount.multi</span>(<span class="at">listw =</span> lw_q_B)</span>
<span id="cb66-138"><a href="#cb66-138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-139"><a href="#cb66-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-140"><a href="#cb66-140" aria-hidden="true" tabindex="-1"></a>So far, we have used binary weights, so the sum of join-counts multiplied by the weight on that join remains integer. If we change to row standardised weights, where the weights are almost always fractions of 1, the counts, expectations and variances change, but there are few major changes in the z-values.</span>
<span id="cb66-141"><a href="#cb66-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-142"><a href="#cb66-142" aria-hidden="true" tabindex="-1"></a>Using an inverse distance based <span class="in">`listw`</span> object does, however, change the z-values markedly, because closer centroids are up-weighted relatively strongly:</span>
<span id="cb66-143"><a href="#cb66-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-146"><a href="#cb66-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-147"><a href="#cb66-147" aria-hidden="true" tabindex="-1"></a>Types <span class="sc">|&gt;</span> <span class="fu">joincount.multi</span>(<span class="at">listw =</span> lw_d183_idw_B)</span>
<span id="cb66-148"><a href="#cb66-148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-149"><a href="#cb66-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-150"><a href="#cb66-150" aria-hidden="true" tabindex="-1"></a><span class="fu">### Moran's $I$</span></span>
<span id="cb66-151"><a href="#cb66-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-152"><a href="#cb66-152" aria-hidden="true" tabindex="-1"></a>The implementation of Moran's $I$ in **spdep** in the <span class="in">`moran.test`</span> function has similar arguments to those of <span class="in">`joincount.test`</span>, but <span class="in">`sampling`</span> is replaced by <span class="in">`randomisation`</span> to indicate the underlying analytical approach used for calculating the variance of the measure. It is also possible to use ranks rather than numerical values <span class="co">[</span><span class="ot">@cliff+ord:81, p. 46</span><span class="co">]</span>. The <span class="in">`drop.EI2`</span> argument may be used to reproduce results where the final component of the variance term is omitted as found in some legacy software implementations.</span>
<span id="cb66-153"><a href="#cb66-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-154"><a href="#cb66-154" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, eval=FALSE}</span></span>
<span id="cb66-155"><a href="#cb66-155" aria-hidden="true" tabindex="-1"></a><span class="in">args(moran.test)</span></span>
<span id="cb66-156"><a href="#cb66-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-157"><a href="#cb66-157" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE, eval=TRUE}</span></span>
<span id="cb66-158"><a href="#cb66-158" aria-hidden="true" tabindex="-1"></a><span class="in">xargs(moran.test)</span></span>
<span id="cb66-159"><a href="#cb66-159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-160"><a href="#cb66-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-161"><a href="#cb66-161" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{moran.test}</span>
<span id="cb66-162"><a href="#cb66-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-163"><a href="#cb66-163" aria-hidden="true" tabindex="-1"></a>The default for the <span class="in">`randomisation`</span> argument is <span class="in">`TRUE`</span>, but here we will simply show that the test under normality is the same as a test of least squares residuals with only the intercept used in the mean model. The analysed variable is first-round turnout proportion of registered voters in municipalities and Warsaw boroughs in the 2015 Polish presidential election. The spelling of randomisation is that of Cliff and Ord <span class="co">[</span><span class="ot">-@cliff+ord:73</span><span class="co">]</span>.</span>
<span id="cb66-164"><a href="#cb66-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-167"><a href="#cb66-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-168"><a href="#cb66-168" aria-hidden="true" tabindex="-1"></a>pol_pres15 <span class="sc">|&gt;</span> </span>
<span id="cb66-169"><a href="#cb66-169" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb66-170"><a href="#cb66-170" aria-hidden="true" tabindex="-1"></a>        <span class="fu">subset</span>(<span class="at">select =</span> I_turnout, <span class="at">drop =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> I_turnout</span>
<span id="cb66-171"><a href="#cb66-171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-172"><a href="#cb66-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-175"><a href="#cb66-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-176"><a href="#cb66-176" aria-hidden="true" tabindex="-1"></a>I_turnout <span class="sc">|&gt;</span> <span class="fu">moran.test</span>(<span class="at">listw =</span> lw_q_B, <span class="at">randomisation =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-177"><a href="#cb66-177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glance_htest</span>()</span>
<span id="cb66-178"><a href="#cb66-178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-179"><a href="#cb66-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-180"><a href="#cb66-180" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{lm.morantest}</span>
<span id="cb66-181"><a href="#cb66-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-182"><a href="#cb66-182" aria-hidden="true" tabindex="-1"></a>The <span class="in">`lm.morantest`</span> function also takes a <span class="in">`resfun`</span> argument to set the function used to extract the residuals used for testing, and clearly lets us model other salient features of the response variable <span class="co">[</span><span class="ot">@cliff+ord:81, p. 203</span><span class="co">]</span>. To compare with the standard test, we are only using the intercept here and, as can be seen, the results are the same.</span>
<span id="cb66-183"><a href="#cb66-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-186"><a href="#cb66-186" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-187"><a href="#cb66-187" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(I_turnout <span class="sc">~</span> <span class="dv">1</span>, pol_pres15) <span class="sc">|&gt;</span> </span>
<span id="cb66-188"><a href="#cb66-188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lm.morantest</span>(<span class="at">listw =</span> lw_q_B) <span class="sc">|&gt;</span> </span>
<span id="cb66-189"><a href="#cb66-189" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glance_htest</span>()</span>
<span id="cb66-190"><a href="#cb66-190" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-191"><a href="#cb66-191" aria-hidden="true" tabindex="-1"></a>The only difference between tests under normality and randomisation is that an extra term is added if the kurtosis of the variable of interest indicates a flatter or more peaked distribution, where the measure used is the classical measure of kurtosis. Under the default randomisation assumption of analytical randomisation, the results are largely unchanged.</span>
<span id="cb66-192"><a href="#cb66-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-195"><a href="#cb66-195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-196"><a href="#cb66-196" aria-hidden="true" tabindex="-1"></a>(I_turnout <span class="sc">|&gt;</span> </span>
<span id="cb66-197"><a href="#cb66-197" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.test</span>(<span class="at">listw =</span> lw_q_B) <span class="ot">-&gt;</span> mtr) <span class="sc">|&gt;</span> </span>
<span id="cb66-198"><a href="#cb66-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glance_htest</span>()</span>
<span id="cb66-199"><a href="#cb66-199" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-200"><a href="#cb66-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-201"><a href="#cb66-201" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{glance<span class="sc">\_</span>htest}</span>
<span id="cb66-202"><a href="#cb66-202" aria-hidden="true" tabindex="-1"></a>From the very beginning in the early 1970s, interest was shown in Monte Carlo tests, also known as Hope-type tests and as permutation bootstrap. By default, <span class="in">`moran.mc`</span> returns a <span class="in">`"htest"`</span> object, but may simply use <span class="in">`boot::boot`</span> internally and return a <span class="in">`"boot"`</span> object when <span class="in">`return_boot=TRUE`</span>. In addition the number of simulations needs to be given as <span class="in">`nsim`</span>; that is the number of times the values of the observations are shuffled at random.</span>
<span id="cb66-203"><a href="#cb66-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-204"><a href="#cb66-204" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{moran.mc}</span>
<span id="cb66-207"><a href="#cb66-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-208"><a href="#cb66-208" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb66-209"><a href="#cb66-209" aria-hidden="true" tabindex="-1"></a>I_turnout <span class="sc">|&gt;</span> </span>
<span id="cb66-210"><a href="#cb66-210" aria-hidden="true" tabindex="-1"></a>    <span class="fu">moran.mc</span>(<span class="at">listw =</span> lw_q_B, <span class="at">nsim =</span> <span class="dv">999</span>, </span>
<span id="cb66-211"><a href="#cb66-211" aria-hidden="true" tabindex="-1"></a>             <span class="at">return_boot =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> mmc</span>
<span id="cb66-212"><a href="#cb66-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-213"><a href="#cb66-213" aria-hidden="true" tabindex="-1"></a>The bootstrap permutation retains the outcomes of each of the random permutations, reporting the observed value of the statistic, here Moran's $I$, the difference between this value and the mean of the simulations under randomisation (equivalent to $E(I)$), and the standard deviation of the simulations under randomisation. </span>
<span id="cb66-214"><a href="#cb66-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-215"><a href="#cb66-215" aria-hidden="true" tabindex="-1"></a>If we compare the Monte Carlo and analytical variances of $I$ under randomisation, we typically see few differences, arguably rendering Monte Carlo testing unnecessary.</span>
<span id="cb66-216"><a href="#cb66-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-217"><a href="#cb66-217" aria-hidden="true" tabindex="-1"></a>\index{Geary's C}</span>
<span id="cb66-218"><a href="#cb66-218" aria-hidden="true" tabindex="-1"></a>\index{Moran's I!empirical Bayes}</span>
<span id="cb66-219"><a href="#cb66-219" aria-hidden="true" tabindex="-1"></a>\index{Getis-Org G}</span>
<span id="cb66-220"><a href="#cb66-220" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{geary.test}</span>
<span id="cb66-223"><a href="#cb66-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-224"><a href="#cb66-224" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="st">"Permutation bootstrap"</span> <span class="ot">=</span> <span class="fu">var</span>(mmc<span class="sc">$</span>t), </span>
<span id="cb66-225"><a href="#cb66-225" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Analytical randomisation"</span> <span class="ot">=</span> <span class="fu">unname</span>(mtr<span class="sc">$</span>estimate[<span class="dv">3</span>]))</span>
<span id="cb66-226"><a href="#cb66-226" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-227"><a href="#cb66-227" aria-hidden="true" tabindex="-1"></a>Geary's global $C$ is implemented in <span class="in">`geary.test`</span> largely following the same argument structure as <span class="in">`moran.test`</span>. The Getis-Ord $G$ test includes extra arguments to accommodate differences between implementations, as @Bivand2018 found multiple divergences from the original definitions, often to omit no-neighbour observations generated when using distance band neighbours. It is given by @getis+ord:92, on page 194. For $G^*$, the $i \neq j$ summation constraint is relaxed by including $i$ as a neighbour of itself (thereby also removing the no-neighbour problem, because all observations have at least one neighbour).</span>
<span id="cb66-228"><a href="#cb66-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-229"><a href="#cb66-229" aria-hidden="true" tabindex="-1"></a>Finally, the empirical Bayes Moran's $I$ takes account of the denominator in assessing spatial autocorrelation in rates data <span class="co">[</span><span class="ot">@assuncao+reis:99</span><span class="co">]</span>. Until now, we have considered the proportion of valid votes cast in relation to the numbers entitled to vote by spatial entity, but using <span class="in">`EBImoran.mc`</span> we can try to accommodate uncertainty in extreme rates in entities with small numbers entitled to vote. There is, however, little impact on the outcome in this case.</span>
<span id="cb66-230"><a href="#cb66-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-231"><a href="#cb66-231" aria-hidden="true" tabindex="-1"></a>Global measures of spatial autocorrelation using spatial weights objects based on graphs of neighbours are, as we have seen, rather blunt tools, which for interpretation depend critically on a reasoned mean model of the variable in question. If the mean model is just the intercept, the global measures will respond to all kinds of misspecification, not only spatial autocorrelation. The choice of entities for aggregation of data will typically be a key source of misspecification.</span>
<span id="cb66-232"><a href="#cb66-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-233"><a href="#cb66-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-234"><a href="#cb66-234" aria-hidden="true" tabindex="-1"></a><span class="fu">## Local measures</span></span>
<span id="cb66-235"><a href="#cb66-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-236"><a href="#cb66-236" aria-hidden="true" tabindex="-1"></a>\index{spatial autocorrelation!local measures of}</span>
<span id="cb66-237"><a href="#cb66-237" aria-hidden="true" tabindex="-1"></a>Building on insights from the weaknesses of global measures, local indicators of spatial association began to appear in the first half of the 1990s <span class="co">[</span><span class="ot">@anselin:95; @getis+ord:92; @getis+ord:96</span><span class="co">]</span>. </span>
<span id="cb66-238"><a href="#cb66-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-239"><a href="#cb66-239" aria-hidden="true" tabindex="-1"></a>In addition, the Moran plot was introduced, plotting the values of the variable of interest against their spatially lagged values, typically using row-standardised weights to make the axes more directly comparable <span class="co">[</span><span class="ot">@anselin:96</span><span class="co">]</span>. The <span class="in">`moran.plot`</span> function also returns an influence measures object used to label observations exerting more than proportional influence on the slope of the line representing global Moran's $I$. In @fig-moranplot, we can see that there are many spatial entities exerting such influence. These pairs of observed and lagged observed values make up in aggregate the global measure, but can also be explored in detail. The quadrants of the Moran plot also show low-low pairs in the lower left quadrant, high-high in the upper right quadrant, and fewer low-high and high-low pairs in the upper left and lower right quadrants. In <span class="in">`moran.plot`</span>, the quadrants are split on the means of the variable and its spatial lag; alternative splits are on zero for the centred variable and the spatial lag of the centred variable.</span>
<span id="cb66-240"><a href="#cb66-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-241"><a href="#cb66-241" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{moran.plot}</span>
<span id="cb66-242"><a href="#cb66-242" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-moranplot, echo=!knitr::is_latex_output()}</span></span>
<span id="cb66-243"><a href="#cb66-243" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Moran plot of I round turnout, row standardised weights"</span></span>
<span id="cb66-244"><a href="#cb66-244" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb66-245"><a href="#cb66-245" aria-hidden="true" tabindex="-1"></a><span class="in">I_turnout |&gt; </span></span>
<span id="cb66-246"><a href="#cb66-246" aria-hidden="true" tabindex="-1"></a><span class="in">    moran.plot(listw = lw_q_W, labels = pol_pres15$TERYT, </span></span>
<span id="cb66-247"><a href="#cb66-247" aria-hidden="true" tabindex="-1"></a><span class="in">               cex = 1, pch = ".", xlab = "I round turnout", </span></span>
<span id="cb66-248"><a href="#cb66-248" aria-hidden="true" tabindex="-1"></a><span class="in">               ylab = "lagged turnout") -&gt; infl_W</span></span>
<span id="cb66-249"><a href="#cb66-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-250"><a href="#cb66-250" aria-hidden="true" tabindex="-1"></a>If we extract the hat value influence measure from the returned object, @fig-moranhat suggests that some edge entities exert more than proportional influence (perhaps because of row standardisation), as do entities in or near larger urban areas.</span>
<span id="cb66-251"><a href="#cb66-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-252"><a href="#cb66-252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-moranhat, echo=!knitr::is_latex_output()}</span></span>
<span id="cb66-253"><a href="#cb66-253" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Moran plot hat values, row standardised neighbours"</span></span>
<span id="cb66-254"><a href="#cb66-254" aria-hidden="true" tabindex="-1"></a><span class="in">library(tmap)</span></span>
<span id="cb66-255"><a href="#cb66-255" aria-hidden="true" tabindex="-1"></a><span class="in">pol_pres15$hat_value &lt;- infl_W$hat</span></span>
<span id="cb66-256"><a href="#cb66-256" aria-hidden="true" tabindex="-1"></a><span class="in">tm_shape(pol_pres15) + tm_fill("hat_value")</span></span>
<span id="cb66-257"><a href="#cb66-257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-258"><a href="#cb66-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-259"><a href="#cb66-259" aria-hidden="true" tabindex="-1"></a><span class="fu">### Local Moran's $I_i$</span></span>
<span id="cb66-260"><a href="#cb66-260" aria-hidden="true" tabindex="-1"></a>\index{Moran's I!local}</span>
<span id="cb66-261"><a href="#cb66-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-262"><a href="#cb66-262" aria-hidden="true" tabindex="-1"></a>@Bivand2018 discuss issues impacting the use of local indicators, such as local Moran's $I_i$ and local Getis-Ord $G_i$. Some issues affect the calculation of the local indicators, others inference from their values. Because $n$ statistics may be calculated from the same number of observations, there are multiple comparison problems that need to be addressed. @https://doi.org/10.1111/j.0016-7363.2006.00682.x  conclude, based on a typical dataset and a simulation exercise, that the false discovery rate (FDR) adjustment of probability values will certainly give a better picture of interesting clusters than no adjustment. Following this up, @https://doi.org/10.1111/gean.12164 explores the combination of FDR adjustments with the use of redefined "significance" cutoffs <span class="co">[</span><span class="ot">@benjaminetal:18</span><span class="co">]</span>, for example $0.01$, $0.005$, and $0.001$ instead of $0.1$, $0.05$, and $0.01$; the use of the term *interesting* rather than *significant* is also preferred. This is discussed further in @bivand:22. As in the global case, misspecification remains a source of confusion, and, further, interpreting local spatial autocorrelation in the presence of global spatial autocorrelation is challenging <span class="co">[</span><span class="ot">@ord+getis:01; @tiefelsdorf:02; @bivandetal:09</span><span class="co">]</span>. </span>
<span id="cb66-263"><a href="#cb66-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-264"><a href="#cb66-264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, eval=FALSE}</span></span>
<span id="cb66-265"><a href="#cb66-265" aria-hidden="true" tabindex="-1"></a><span class="in">args(localmoran)</span></span>
<span id="cb66-266"><a href="#cb66-266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-267"><a href="#cb66-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE, eval=TRUE}</span></span>
<span id="cb66-268"><a href="#cb66-268" aria-hidden="true" tabindex="-1"></a><span class="in">xargs(localmoran)</span></span>
<span id="cb66-269"><a href="#cb66-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-270"><a href="#cb66-270" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{localmoran}</span>
<span id="cb66-271"><a href="#cb66-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-272"><a href="#cb66-272" aria-hidden="true" tabindex="-1"></a>In an important clarification, @sauer_oshan_rey_wolf_2021 show that the comparison of standard deviates for local Moran's $I_i$ based on analytical formulae and conditional permutation in @Bivand2018 was based on a misunderstanding. @sokaletal:98 provide alternative analytical formulae for standard deviates of local Moran's $I_i$ based either on total or conditional permutation, but the analytical formulae used in @Bivand2018, based on earlier practice, only use total permutation, and consequently do not match the simulation conditional permutations. Thanks to a timely pull request, <span class="in">`localmoran`</span> now has a <span class="in">`conditional`</span> argument (default <span class="in">`TRUE`</span>) using alternative formulae from the appendix of @sokaletal:98. The <span class="in">`mlvar`</span> and <span class="in">`adjust.x`</span> arguments to <span class="in">`localmoran`</span> are discussed in @Bivand2018, and permit matching with other implementations. Taking <span class="in">`"two.sided"`</span> probability values (the default), we obtain:</span>
<span id="cb66-273"><a href="#cb66-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-276"><a href="#cb66-276" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-277"><a href="#cb66-277" aria-hidden="true" tabindex="-1"></a>I_turnout <span class="sc">|&gt;</span> </span>
<span id="cb66-278"><a href="#cb66-278" aria-hidden="true" tabindex="-1"></a>    <span class="fu">localmoran</span>(<span class="at">listw =</span> lw_q_W) <span class="ot">-&gt;</span> locm</span>
<span id="cb66-279"><a href="#cb66-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-280"><a href="#cb66-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-281"><a href="#cb66-281" aria-hidden="true" tabindex="-1"></a>The $I_i$ local indicators when summed and divided by the sum of the spatial weights equal global Moran's $I$, showing the possible presence of positive and negative local spatial autocorrelation:</span>
<span id="cb66-284"><a href="#cb66-284" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-285"><a href="#cb66-285" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(<span class="fu">sum</span>(locm[,<span class="dv">1</span>])<span class="sc">/</span><span class="fu">Szero</span>(lw_q_W), </span>
<span id="cb66-286"><a href="#cb66-286" aria-hidden="true" tabindex="-1"></a>          <span class="fu">unname</span>(<span class="fu">moran.test</span>(I_turnout, lw_q_W)<span class="sc">$</span>estimate[<span class="dv">1</span>]))</span>
<span id="cb66-287"><a href="#cb66-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-288"><a href="#cb66-288" aria-hidden="true" tabindex="-1"></a>Using <span class="in">`stats::p.adjust`</span> to adjust for multiple comparisons, we see that over 15\% of the 2495 local measures have p-values &lt; 0.005 if no adjustment is applied, but only 1.5\% using Bonferroni adjustment to control the family-wise error rate, with two other choices shown: <span class="in">`"fdr"`</span> is the @fdr-BH false discovery rate (almost 6\%) and <span class="in">`"BY"`</span> <span class="co">[</span><span class="ot">@10.1214/aos/1013699998</span><span class="co">]</span>, another false discovery rate adjustment (about 2.5\%):</span>
<span id="cb66-289"><a href="#cb66-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-292"><a href="#cb66-292" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-293"><a href="#cb66-293" aria-hidden="true" tabindex="-1"></a>pva <span class="ot">&lt;-</span> <span class="cf">function</span>(pv) <span class="fu">cbind</span>(<span class="st">"none"</span> <span class="ot">=</span> pv, </span>
<span id="cb66-294"><a href="#cb66-294" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FDR"</span> <span class="ot">=</span> <span class="fu">p.adjust</span>(pv, <span class="st">"fdr"</span>), <span class="st">"BY"</span> <span class="ot">=</span> <span class="fu">p.adjust</span>(pv, <span class="st">"BY"</span>),</span>
<span id="cb66-295"><a href="#cb66-295" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bonferroni"</span> <span class="ot">=</span> <span class="fu">p.adjust</span>(pv, <span class="st">"bonferroni"</span>))</span>
<span id="cb66-296"><a href="#cb66-296" aria-hidden="true" tabindex="-1"></a>locm <span class="sc">|&gt;</span> </span>
<span id="cb66-297"><a href="#cb66-297" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">select =</span> <span class="st">"Pr(z != E(Ii))"</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-298"><a href="#cb66-298" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pva</span>() <span class="ot">-&gt;</span> pvsp</span>
<span id="cb66-299"><a href="#cb66-299" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x <span class="sc">&lt;</span> <span class="fl">0.005</span>)</span>
<span id="cb66-300"><a href="#cb66-300" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(pvsp, <span class="dv">2</span>, f)</span>
<span id="cb66-301"><a href="#cb66-301" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-302"><a href="#cb66-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-303"><a href="#cb66-303" aria-hidden="true" tabindex="-1"></a>In the global measure case, bootstrap permutations may be used as an alternative to analytical methods for possible inference, where both the theoretical development of the analytical variance of the measure, and the permutation scheme, shuffle all of the observed values.  In the local case, conditional permutation should be used, fixing the value at observation $i$ and randomly sampling from the remaining $n-1$ values to find randomised values at neighbours. Conditional permutation is provided as function <span class="in">`localmoran_perm`</span>, which may use multiple compute nodes to sample in parallel if provided, and permits the setting of a seed for the random number generator across the compute nodes. The number of simulations <span class="in">`nsim`</span> also controls the precision of the ranked estimates of the probability value based on the rank of observed $I_i$ among the simulated values:</span>
<span id="cb66-304"><a href="#cb66-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-305"><a href="#cb66-305" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{localmoran<span class="sc">\_</span>perm}</span>
<span id="cb66-306"><a href="#cb66-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-307"><a href="#cb66-307" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, cache=TRUE}</span></span>
<span id="cb66-308"><a href="#cb66-308" aria-hidden="true" tabindex="-1"></a><span class="in">library(parallel)</span></span>
<span id="cb66-309"><a href="#cb66-309" aria-hidden="true" tabindex="-1"></a><span class="in">invisible(spdep::set.coresOption(max(detectCores()-1L, 1L)))</span></span>
<span id="cb66-310"><a href="#cb66-310" aria-hidden="true" tabindex="-1"></a><span class="in">I_turnout |&gt; </span></span>
<span id="cb66-311"><a href="#cb66-311" aria-hidden="true" tabindex="-1"></a><span class="in">    localmoran_perm(listw = lw_q_W, nsim = 9999, </span></span>
<span id="cb66-312"><a href="#cb66-312" aria-hidden="true" tabindex="-1"></a><span class="in">                    iseed = 1) -&gt; locm_p</span></span>
<span id="cb66-313"><a href="#cb66-313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-314"><a href="#cb66-314" aria-hidden="true" tabindex="-1"></a>The outcome is that over 15\% of observations have two sided p-values &lt; 0.005 without multiple comparison adjustment, and about 1.5\% with Bonferroni adjustment, when the p-values are calculated using the standard deviate of the permutation samples and the normal distribution.</span>
<span id="cb66-315"><a href="#cb66-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-318"><a href="#cb66-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-319"><a href="#cb66-319" aria-hidden="true" tabindex="-1"></a>locm_p <span class="sc">|&gt;</span> </span>
<span id="cb66-320"><a href="#cb66-320" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">select =</span> <span class="st">"Pr(z != E(Ii))"</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-321"><a href="#cb66-321" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pva</span>() <span class="ot">-&gt;</span> pvsp</span>
<span id="cb66-322"><a href="#cb66-322" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(pvsp, <span class="dv">2</span>, f)</span>
<span id="cb66-323"><a href="#cb66-323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-324"><a href="#cb66-324" aria-hidden="true" tabindex="-1"></a>Since the variable under analysis may not be normally distributed, the p-values can also be calculated by finding the rank of the observed $I_i$ among the rank-based simulated values, and looking up the probability value from the uniform distribution taking the <span class="in">`alternative`</span> choice into account:</span>
<span id="cb66-325"><a href="#cb66-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-328"><a href="#cb66-328" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-329"><a href="#cb66-329" aria-hidden="true" tabindex="-1"></a>locm_p <span class="sc">|&gt;</span> </span>
<span id="cb66-330"><a href="#cb66-330" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">select =</span> <span class="st">"Pr(z != E(Ii)) Sim"</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-331"><a href="#cb66-331" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pva</span>() <span class="ot">-&gt;</span> pvsp</span>
<span id="cb66-332"><a href="#cb66-332" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(pvsp, <span class="dv">2</span>, f)</span>
<span id="cb66-333"><a href="#cb66-333" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-334"><a href="#cb66-334" aria-hidden="true" tabindex="-1"></a>Now the <span class="in">`"BY"`</span> and Bonferroni counts of *interesting* locations are zero with 9999 samples, but may be recovered by increasing the sample count to 999999 if required; the FDR adjustment and *interesting* cutoff 0.005 yields about 5\% locations. </span>
<span id="cb66-335"><a href="#cb66-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-338"><a href="#cb66-338" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-339"><a href="#cb66-339" aria-hidden="true" tabindex="-1"></a>pol_pres15<span class="sc">$</span>locm_pv <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(locm[, <span class="st">"Pr(z != E(Ii))"</span>], <span class="st">"fdr"</span>)</span>
<span id="cb66-340"><a href="#cb66-340" aria-hidden="true" tabindex="-1"></a>pol_pres15<span class="sc">$</span>locm_std_pv <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(locm_p[, <span class="st">"Pr(z != E(Ii))"</span>], </span>
<span id="cb66-341"><a href="#cb66-341" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"fdr"</span>)</span>
<span id="cb66-342"><a href="#cb66-342" aria-hidden="true" tabindex="-1"></a>pol_pres15<span class="sc">$</span>locm_p_pv <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(locm_p[, <span class="st">"Pr(z != E(Ii)) Sim"</span>],</span>
<span id="cb66-343"><a href="#cb66-343" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"fdr"</span>)</span>
<span id="cb66-344"><a href="#cb66-344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-345"><a href="#cb66-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-346"><a href="#cb66-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-347"><a href="#cb66-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-localmoranPr, echo=!knitr::is_latex_output()}</span></span>
<span id="cb66-348"><a href="#cb66-348" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb66-349"><a href="#cb66-349" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Local Moran's I FDR probability values: left upper panel: analytical conditional p-values; right upper panel: permutation standard deviate conditional p-values; left lower panel: permutation rank conditional p-values, first-round turnout, row-standardised neighbours"</span></span>
<span id="cb66-350"><a href="#cb66-350" aria-hidden="true" tabindex="-1"></a><span class="in">tm_shape(pol_pres15) +</span></span>
<span id="cb66-351"><a href="#cb66-351" aria-hidden="true" tabindex="-1"></a><span class="in">        tm_fill(c("locm_pv", "locm_std_pv", "locm_p_pv"), </span></span>
<span id="cb66-352"><a href="#cb66-352" aria-hidden="true" tabindex="-1"></a><span class="in">                breaks=c(0, 0.0005, 0.001, 0.005, 0.01, </span></span>
<span id="cb66-353"><a href="#cb66-353" aria-hidden="true" tabindex="-1"></a><span class="in">                         0.05, 0.1, 0.2, 0.5, 0.75, 1), </span></span>
<span id="cb66-354"><a href="#cb66-354" aria-hidden="true" tabindex="-1"></a><span class="in">                title = "Pseudo p-values\nLocal Moran's I",</span></span>
<span id="cb66-355"><a href="#cb66-355" aria-hidden="true" tabindex="-1"></a><span class="in">                palette="-YlOrBr") +</span></span>
<span id="cb66-356"><a href="#cb66-356" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_facets(free.scales = FALSE, ncol = 2) +</span></span>
<span id="cb66-357"><a href="#cb66-357" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_layout(panel.labels = c("Analytical conditional",</span></span>
<span id="cb66-358"><a href="#cb66-358" aria-hidden="true" tabindex="-1"></a><span class="in">                               "Permutation std. dev.",</span></span>
<span id="cb66-359"><a href="#cb66-359" aria-hidden="true" tabindex="-1"></a><span class="in">                               "Permutation rank"))</span></span>
<span id="cb66-360"><a href="#cb66-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-361"><a href="#cb66-361" aria-hidden="true" tabindex="-1"></a>Proceeding using the FDR adjustment and an *interesting* location cutoff of $0.005$, we can see from @fig-localmoranPr that the adjusted probability values for the analytical conditional approach, the approach using the moments of the sampled values from permutation sampling, and the approach using the ranks of observed values among permutation samples all yield similar maps, as the distribution of the input variable is quite close to normal.</span>
<span id="cb66-362"><a href="#cb66-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-363"><a href="#cb66-363" aria-hidden="true" tabindex="-1"></a>\index{hotspots}</span>
<span id="cb66-364"><a href="#cb66-364" aria-hidden="true" tabindex="-1"></a>\index{Moran's I!hotspots}</span>
<span id="cb66-365"><a href="#cb66-365" aria-hidden="true" tabindex="-1"></a>In presenting local Moran's $I$, use is often made of "hotspot" maps. Because $I_i$ takes high values both for strong positive autocorrelation of low and high values of the input variable, it is hard to show where "clusters" of similar neighbours with low or high values of the input variable occur. The quadrants of the Moran plot are used, by creating a categorical quadrant variable interacting the input variable and its spatial lag split at their means. The quadrant categories are then set to NA if, for the chosen probability value and adjustment, $I_i$ would not be considered *interesting*. Here, for the FDR adjusted conditional analytical probability values (@fig-localmoranPr, upper left panel), 53 observations belong to <span class="in">`"Low-Low"`</span> cluster cores, and 96 to <span class="in">`"High-High"`</span> cluster cores, similarly for the standard deviate-based permutation p-values (@fig-localmoranPr, upper right panel), but the rank-based permutation p-values reduce the <span class="in">`"High-High"`</span> count and increase the <span class="in">`"Low-Low"`</span> count @fig-localmoranPr lower left panel:</span>
<span id="cb66-366"><a href="#cb66-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-369"><a href="#cb66-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-370"><a href="#cb66-370" aria-hidden="true" tabindex="-1"></a>quadr <span class="ot">&lt;-</span> <span class="fu">attr</span>(locm, <span class="st">"quadr"</span>)<span class="sc">$</span>mean</span>
<span id="cb66-371"><a href="#cb66-371" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">addNA</span>(quadr))</span>
<span id="cb66-372"><a href="#cb66-372" aria-hidden="true" tabindex="-1"></a>locm <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname=</span><span class="st">"Pr(z != E(Ii))"</span>, <span class="at">cutoff =</span> <span class="fl">0.005</span>, </span>
<span id="cb66-373"><a href="#cb66-373" aria-hidden="true" tabindex="-1"></a>                <span class="at">droplevels=</span><span class="cn">FALSE</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>hs_an_q</span>
<span id="cb66-374"><a href="#cb66-374" aria-hidden="true" tabindex="-1"></a>locm_p <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname=</span><span class="st">"Pr(z != E(Ii))"</span>, <span class="at">cutoff =</span> <span class="fl">0.005</span>, </span>
<span id="cb66-375"><a href="#cb66-375" aria-hidden="true" tabindex="-1"></a>                  <span class="at">droplevels=</span><span class="cn">FALSE</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>hs_ac_q </span>
<span id="cb66-376"><a href="#cb66-376" aria-hidden="true" tabindex="-1"></a>locm_p <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname=</span><span class="st">"Pr(z != E(Ii)) Sim"</span>, <span class="at">cutoff =</span> <span class="fl">0.005</span>,</span>
<span id="cb66-377"><a href="#cb66-377" aria-hidden="true" tabindex="-1"></a>                  <span class="at">droplevels =</span> <span class="cn">FALSE</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>hs_cp_q</span>
<span id="cb66-378"><a href="#cb66-378" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>hs_an_q))</span>
<span id="cb66-379"><a href="#cb66-379" aria-hidden="true" tabindex="-1"></a>c <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>hs_ac_q))</span>
<span id="cb66-380"><a href="#cb66-380" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>hs_cp_q))</span>
<span id="cb66-381"><a href="#cb66-381" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">rbind</span>(<span class="st">"Moran plot quadrants"</span> <span class="ot">=</span> a, <span class="st">"Analytical cond."</span> <span class="ot">=</span> b, </span>
<span id="cb66-382"><a href="#cb66-382" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Permutation std. cond."</span> <span class="ot">=</span> c, <span class="st">"Permutation rank cond."</span> <span class="ot">=</span> d))</span>
<span id="cb66-383"><a href="#cb66-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-384"><a href="#cb66-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-387"><a href="#cb66-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-388"><a href="#cb66-388" aria-hidden="true" tabindex="-1"></a>pol_pres15<span class="sc">$</span>hs_an_q <span class="ot">&lt;-</span> <span class="fu">droplevels</span>(pol_pres15<span class="sc">$</span>hs_an_q)</span>
<span id="cb66-389"><a href="#cb66-389" aria-hidden="true" tabindex="-1"></a>pol_pres15<span class="sc">$</span>hs_ac_q <span class="ot">&lt;-</span> <span class="fu">droplevels</span>(pol_pres15<span class="sc">$</span>hs_ac_q)</span>
<span id="cb66-390"><a href="#cb66-390" aria-hidden="true" tabindex="-1"></a>pol_pres15<span class="sc">$</span>hs_cp_q <span class="ot">&lt;-</span> <span class="fu">droplevels</span>(pol_pres15<span class="sc">$</span>hs_cp_q)</span>
<span id="cb66-391"><a href="#cb66-391" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-392"><a href="#cb66-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-393"><a href="#cb66-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-Iihotspots, echo=!knitr::is_latex_output()}</span></span>
<span id="cb66-394"><a href="#cb66-394" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb66-395"><a href="#cb66-395" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Local Moran\\'s I FDR hotspot cluster core maps $\\alpha = 0.005$: left upper panel: analytical conditional p-values; right upper panel: permutation standard deviate conditional p-values; left lower panel: permutation rank conditional p-values, first-round turnout, row-standardised neighbours"</span></span>
<span id="cb66-396"><a href="#cb66-396" aria-hidden="true" tabindex="-1"></a><span class="in">tm_shape(pol_pres15) +</span></span>
<span id="cb66-397"><a href="#cb66-397" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_fill(c("hs_an_q", "hs_ac_q", "hs_cp_q"),</span></span>
<span id="cb66-398"><a href="#cb66-398" aria-hidden="true" tabindex="-1"></a><span class="in">        colorNA = "grey95", textNA="Not \"interesting\"",</span></span>
<span id="cb66-399"><a href="#cb66-399" aria-hidden="true" tabindex="-1"></a><span class="in">        title = "Turnout hotspot status \nLocal Moran's I",</span></span>
<span id="cb66-400"><a href="#cb66-400" aria-hidden="true" tabindex="-1"></a><span class="in">        palette = RColorBrewer::brewer.pal(4, "Set3")[-c(2,3)]) +</span></span>
<span id="cb66-401"><a href="#cb66-401" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_facets(free.scales = FALSE, ncol = 2) +</span></span>
<span id="cb66-402"><a href="#cb66-402" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_layout(panel.labels = c("Analytical conditional",</span></span>
<span id="cb66-403"><a href="#cb66-403" aria-hidden="true" tabindex="-1"></a><span class="in">                               "Permutation std. cond.",</span></span>
<span id="cb66-404"><a href="#cb66-404" aria-hidden="true" tabindex="-1"></a><span class="in">                               "Permutation rank cond."))</span></span>
<span id="cb66-405"><a href="#cb66-405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-406"><a href="#cb66-406" aria-hidden="true" tabindex="-1"></a>@fig-Iihotspots  shows that there is very little difference between the FDR-adjusted *interesting* clusters with a choice of an $\alpha=0.005$ probability value cutoff for the three approaches of analytical conditional standard deviates, permutation-based standard deviates, and rank-based probability values; the <span class="in">`"High-High"`</span> cluster cores are metropolitan areas.</span>
<span id="cb66-407"><a href="#cb66-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-408"><a href="#cb66-408" aria-hidden="true" tabindex="-1"></a>@tiefelsdorf:02 argues that standard approaches to the calculation of the standard deviates of local Moran's $I_i$ should be supplemented by numerical estimates, and shows that saddlepoint approximations are a computationally efficient way of achieving this goal. The <span class="in">`localmoran.sad`</span> function takes a fitted linear model as its first argument, so we first fit a null (intercept only) model, but use case weights because the numbers entitled to vote vary greatly between observations:</span>
<span id="cb66-409"><a href="#cb66-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-410"><a href="#cb66-410" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{localmoran.sad}</span>
<span id="cb66-411"><a href="#cb66-411" aria-hidden="true" tabindex="-1"></a>\index{Moran's I!saddlepoint approximation}</span>
<span id="cb66-412"><a href="#cb66-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-415"><a href="#cb66-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-416"><a href="#cb66-416" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(I_turnout <span class="sc">~</span> <span class="dv">1</span>) <span class="ot">-&gt;</span> lm_null</span>
<span id="cb66-417"><a href="#cb66-417" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-418"><a href="#cb66-418" aria-hidden="true" tabindex="-1"></a>Saddlepoint approximation is as computationally intensive as conditional permutation, because, rather than computing a simple measure on many samples, a good deal of numerical calculation is needed for each local approximation:</span>
<span id="cb66-419"><a href="#cb66-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-420"><a href="#cb66-420" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb66-421"><a href="#cb66-421" aria-hidden="true" tabindex="-1"></a><span class="in">lm_null |&gt; localmoran.sad(nb = nb_q, style = "W",</span></span>
<span id="cb66-422"><a href="#cb66-422" aria-hidden="true" tabindex="-1"></a><span class="in">                                  alternative = "two.sided") |&gt;</span></span>
<span id="cb66-423"><a href="#cb66-423" aria-hidden="true" tabindex="-1"></a><span class="in">        summary() -&gt; locm_sad_null</span></span>
<span id="cb66-424"><a href="#cb66-424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-425"><a href="#cb66-425" aria-hidden="true" tabindex="-1"></a>The chief advantage of the saddlepoint approximation is that it takes a fitted linear model rather than simply a numerical variable, so the residuals are analysed. With an intercept-only model, the results are similar to local Moran's $I_i$, but we can weight the observations, here by the count of those entitled to vote, which should down-weight small units of observation:</span>
<span id="cb66-426"><a href="#cb66-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-427"><a href="#cb66-427" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb66-428"><a href="#cb66-428" aria-hidden="true" tabindex="-1"></a><span class="in">lm(I_turnout ~ 1, weights = pol_pres15$I_entitled_to_vote) -&gt;</span></span>
<span id="cb66-429"><a href="#cb66-429" aria-hidden="true" tabindex="-1"></a><span class="in">        lm_null_weights</span></span>
<span id="cb66-430"><a href="#cb66-430" aria-hidden="true" tabindex="-1"></a><span class="in">lm_null_weights |&gt;</span></span>
<span id="cb66-431"><a href="#cb66-431" aria-hidden="true" tabindex="-1"></a><span class="in">            localmoran.sad(nb = nb_q, style = "W",</span></span>
<span id="cb66-432"><a href="#cb66-432" aria-hidden="true" tabindex="-1"></a><span class="in">                           alternative = "two.sided") |&gt;</span></span>
<span id="cb66-433"><a href="#cb66-433" aria-hidden="true" tabindex="-1"></a><span class="in">        summary() -&gt; locm_sad_null_weights</span></span>
<span id="cb66-434"><a href="#cb66-434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-435"><a href="#cb66-435" aria-hidden="true" tabindex="-1"></a>Next we add the categorical variable distinguishing between rural, urban and other types of observational unit:</span>
<span id="cb66-436"><a href="#cb66-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-437"><a href="#cb66-437" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb66-438"><a href="#cb66-438" aria-hidden="true" tabindex="-1"></a><span class="in">lm(I_turnout ~ Types, weights=pol_pres15$I_entitled_to_vote) -&gt;</span></span>
<span id="cb66-439"><a href="#cb66-439" aria-hidden="true" tabindex="-1"></a><span class="in">        lm_types</span></span>
<span id="cb66-440"><a href="#cb66-440" aria-hidden="true" tabindex="-1"></a><span class="in">lm_types |&gt; localmoran.sad(nb = nb_q, style = "W",</span></span>
<span id="cb66-441"><a href="#cb66-441" aria-hidden="true" tabindex="-1"></a><span class="in">                                  alternative = "two.sided") |&gt;</span></span>
<span id="cb66-442"><a href="#cb66-442" aria-hidden="true" tabindex="-1"></a><span class="in">        summary() -&gt; locm_sad_types</span></span>
<span id="cb66-443"><a href="#cb66-443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-444"><a href="#cb66-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-447"><a href="#cb66-447" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-448"><a href="#cb66-448" aria-hidden="true" tabindex="-1"></a>locm_sad_null <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname=</span><span class="st">"Pr. (Sad)"</span>,</span>
<span id="cb66-449"><a href="#cb66-449" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cutoff=</span><span class="fl">0.005</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>locm_sad0</span>
<span id="cb66-450"><a href="#cb66-450" aria-hidden="true" tabindex="-1"></a>locm_sad_null_weights <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname=</span><span class="st">"Pr. (Sad)"</span>,</span>
<span id="cb66-451"><a href="#cb66-451" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cutoff =</span> <span class="fl">0.005</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>locm_sad1</span>
<span id="cb66-452"><a href="#cb66-452" aria-hidden="true" tabindex="-1"></a>locm_sad_types <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname=</span><span class="st">"Pr. (Sad)"</span>,</span>
<span id="cb66-453"><a href="#cb66-453" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cutoff =</span> <span class="fl">0.005</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>locm_sad2</span>
<span id="cb66-454"><a href="#cb66-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-455"><a href="#cb66-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-456"><a href="#cb66-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-localmoranHsad, echo=!knitr::is_latex_output()}</span></span>
<span id="cb66-457"><a href="#cb66-457" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb66-458"><a href="#cb66-458" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Local Moran\\'s I FDR hotspot cluster core maps, two-sided, *interesting* cutoff $\\alpha = 0.005$: left upper panel: permutation rank conditional p-values; right upper panel:  null (intercept only) model saddlepoint p-values; left lower panel: weighted null (intercept only) model saddlepoint p-values; right lower panel: weighted types model saddlepoint p-values, for first-round turnout, row-standardised neighbours"</span></span>
<span id="cb66-459"><a href="#cb66-459" aria-hidden="true" tabindex="-1"></a><span class="in">tm_shape(pol_pres15) +</span></span>
<span id="cb66-460"><a href="#cb66-460" aria-hidden="true" tabindex="-1"></a><span class="in">  tm_fill(c("hs_cp_q", "locm_sad0", "locm_sad1",  "locm_sad2"),</span></span>
<span id="cb66-461"><a href="#cb66-461" aria-hidden="true" tabindex="-1"></a><span class="in">    colorNA = "grey95", textNA = "Not \"interesting\"",</span></span>
<span id="cb66-462"><a href="#cb66-462" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Turnout hotspot status \nLocal Moran's I",</span></span>
<span id="cb66-463"><a href="#cb66-463" aria-hidden="true" tabindex="-1"></a><span class="in">    palette =RColorBrewer::brewer.pal(4, "Set3")[c(1, 4, 2)]) +</span></span>
<span id="cb66-464"><a href="#cb66-464" aria-hidden="true" tabindex="-1"></a><span class="in">  tm_facets(free.scales = FALSE, ncol = 2) + </span></span>
<span id="cb66-465"><a href="#cb66-465" aria-hidden="true" tabindex="-1"></a><span class="in">  tm_layout(panel.labels = c("Permutation rank", </span></span>
<span id="cb66-466"><a href="#cb66-466" aria-hidden="true" tabindex="-1"></a><span class="in">     "saddlepoint null", "saddlepoint weighted null", </span></span>
<span id="cb66-467"><a href="#cb66-467" aria-hidden="true" tabindex="-1"></a><span class="in">     "saddlepoint weighted types"))</span></span>
<span id="cb66-468"><a href="#cb66-468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-471"><a href="#cb66-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-472"><a href="#cb66-472" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">null =</span> <span class="fu">append</span>(<span class="fu">table</span>(<span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>locm_sad0)),</span>
<span id="cb66-473"><a href="#cb66-473" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">c</span>(<span class="st">"Low-High"</span> <span class="ot">=</span> <span class="dv">0</span>), <span class="dv">1</span>),</span>
<span id="cb66-474"><a href="#cb66-474" aria-hidden="true" tabindex="-1"></a>      <span class="at">weighted =</span> <span class="fu">append</span>(<span class="fu">table</span>(<span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>locm_sad1)),</span>
<span id="cb66-475"><a href="#cb66-475" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">c</span>(<span class="st">"Low-High"</span> <span class="ot">=</span> <span class="dv">0</span>), <span class="dv">1</span>),</span>
<span id="cb66-476"><a href="#cb66-476" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_weighted =</span> <span class="fu">append</span>(<span class="fu">table</span>(<span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>locm_sad2)),</span>
<span id="cb66-477"><a href="#cb66-477" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">c</span>(<span class="st">"Low-High"</span> <span class="ot">=</span> <span class="dv">0</span>), <span class="dv">1</span>))</span>
<span id="cb66-478"><a href="#cb66-478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-479"><a href="#cb66-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-480"><a href="#cb66-480" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb66-481"><a href="#cb66-481" aria-hidden="true" tabindex="-1"></a>@fig-localmoranHsad includes the permutation rank cluster cores for comparison (upper left panel). Because saddlepoint approximation permits richer mean models to be used, and possibly because the approximation approach is inherently local, relating regression residual values at $i$ to those of its neighbours, the remaining three panels diverge somewhat. The intercept-only (null) model is fairly similar to standard local Moran's $I_i$, but weighting by counts of eligible voters removes most of the <span class="in">`"Low-Low"`</span> cluster cores. Adding the type categorical variable strengthens the urban <span class="in">`"High-High"`</span> cluster cores but removes the Warsaw boroughs as *interesting* cluster cores. The central boroughs are surrounded by other boroughs, all with high turnout, not driven by autocorrelation but by being metropolitan boroughs. It is also possible to use saddlepoint approximation where the global spatial process has been incorporated, removing the conflation of global and local spatial autocorrelation in standard approaches. </span>
<span id="cb66-482"><a href="#cb66-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-483"><a href="#cb66-483" aria-hidden="true" tabindex="-1"></a>The same can also be accomplished using exact methods, but may require more tuning as numerical integration may fail, returning <span class="in">`NaN`</span> rather than the exact estimate of the standard deviate <span class="co">[</span><span class="ot">@bivandetal:09</span><span class="co">]</span>:</span>
<span id="cb66-484"><a href="#cb66-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-485"><a href="#cb66-485" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb66-486"><a href="#cb66-486" aria-hidden="true" tabindex="-1"></a><span class="in">lm_types |&gt; localmoran.exact(nb = nb_q, style = "W", </span></span>
<span id="cb66-487"><a href="#cb66-487" aria-hidden="true" tabindex="-1"></a><span class="in">    alternative = "two.sided", useTP=TRUE, truncErr=1e-8) |&gt; </span></span>
<span id="cb66-488"><a href="#cb66-488" aria-hidden="true" tabindex="-1"></a><span class="in">    as.data.frame() -&gt; locm_ex_types</span></span>
<span id="cb66-489"><a href="#cb66-489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-490"><a href="#cb66-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-493"><a href="#cb66-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-494"><a href="#cb66-494" aria-hidden="true" tabindex="-1"></a>locm_ex_types <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname =</span> <span class="st">"Pr. (exact)"</span>,</span>
<span id="cb66-495"><a href="#cb66-495" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cutoff =</span> <span class="fl">0.005</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>locm_ex</span>
<span id="cb66-496"><a href="#cb66-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-497"><a href="#cb66-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-498"><a href="#cb66-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-499"><a href="#cb66-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-localmoranHsadex, echo=!knitr::is_latex_output()}</span></span>
<span id="cb66-500"><a href="#cb66-500" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb66-501"><a href="#cb66-501" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "Local Moran's I FDR hotspot cluster core maps, two-sided, *interesting* cutoff $\\alpha = 0.005$: left panel: weighted types model saddlepoint p-values; right panel: weighted types model exact p-values, for first-round turnout, row-standardised neighbours"</span></span>
<span id="cb66-502"><a href="#cb66-502" aria-hidden="true" tabindex="-1"></a><span class="in">tm_shape(pol_pres15) +</span></span>
<span id="cb66-503"><a href="#cb66-503" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_fill(c("locm_sad2", "locm_ex"), colorNA = "grey95",</span></span>
<span id="cb66-504"><a href="#cb66-504" aria-hidden="true" tabindex="-1"></a><span class="in">        textNA = "Not \"interesting\"", </span></span>
<span id="cb66-505"><a href="#cb66-505" aria-hidden="true" tabindex="-1"></a><span class="in">        title = "Turnout hotspot status \nLocal Moran's I",</span></span>
<span id="cb66-506"><a href="#cb66-506" aria-hidden="true" tabindex="-1"></a><span class="in">        palette = RColorBrewer::brewer.pal(4, "Set3")[c(1, 4, 2)]) +</span></span>
<span id="cb66-507"><a href="#cb66-507" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_facets(free.scales = FALSE, ncol = 2) +</span></span>
<span id="cb66-508"><a href="#cb66-508" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_layout(panel.labels = c("saddlepoint weighted types",</span></span>
<span id="cb66-509"><a href="#cb66-509" aria-hidden="true" tabindex="-1"></a><span class="in">                               "Exact weighted types"))</span></span>
<span id="cb66-510"><a href="#cb66-510" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-511"><a href="#cb66-511" aria-hidden="true" tabindex="-1"></a>As @fig-localmoranHsadex shows, the exact and saddlepoint approximation methods yield almost identical cluster classifications from the same regression residuals, multiple comparison adjustment method, and cutoff level, with the exact method returning four more *interesting* observations:</span>
<span id="cb66-512"><a href="#cb66-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-515"><a href="#cb66-515" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-516"><a href="#cb66-516" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="at">Saddlepoint =</span> <span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>locm_sad2),</span>
<span id="cb66-517"><a href="#cb66-517" aria-hidden="true" tabindex="-1"></a>      <span class="at">exact =</span> <span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>locm_ex))</span>
<span id="cb66-518"><a href="#cb66-518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-519"><a href="#cb66-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-520"><a href="#cb66-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-521"><a href="#cb66-521" aria-hidden="true" tabindex="-1"></a><span class="fu">### Local Getis-Ord $G_i$</span></span>
<span id="cb66-522"><a href="#cb66-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-523"><a href="#cb66-523" aria-hidden="true" tabindex="-1"></a>\index{Getis-Ord G!local}</span>
<span id="cb66-524"><a href="#cb66-524" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{localG}</span>
<span id="cb66-525"><a href="#cb66-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-526"><a href="#cb66-526" aria-hidden="true" tabindex="-1"></a>The local Getis-Ord $G_i$ measure <span class="co">[</span><span class="ot">@getis+ord:92; @getis+ord:96</span><span class="co">]</span> is reported as a standard deviate, and, may also take the $G^*_i$ form where self-neighbours are inserted into the neighbour object using <span class="in">`include.self`</span>. The observed and expected values of local $G$ with their analytical variances may also be returned if <span class="in">`return_internals=TRUE`</span>. </span>
<span id="cb66-527"><a href="#cb66-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-530"><a href="#cb66-530" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-531"><a href="#cb66-531" aria-hidden="true" tabindex="-1"></a>I_turnout <span class="sc">|&gt;</span> </span>
<span id="cb66-532"><a href="#cb66-532" aria-hidden="true" tabindex="-1"></a>        <span class="fu">localG</span>(lw_q_W, <span class="at">return_internals =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> locG</span>
<span id="cb66-533"><a href="#cb66-533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-534"><a href="#cb66-534" aria-hidden="true" tabindex="-1"></a>Permutation inference is also available for this measure:</span>
<span id="cb66-535"><a href="#cb66-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-536"><a href="#cb66-536" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE} </span></span>
<span id="cb66-537"><a href="#cb66-537" aria-hidden="true" tabindex="-1"></a><span class="in">I_turnout |&gt; </span></span>
<span id="cb66-538"><a href="#cb66-538" aria-hidden="true" tabindex="-1"></a><span class="in">        localG_perm(lw_q_W, nsim = 9999, iseed = 1) -&gt; locG_p</span></span>
<span id="cb66-539"><a href="#cb66-539" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-540"><a href="#cb66-540" aria-hidden="true" tabindex="-1"></a>The correlation between the two-sided probability values for analytical and permutation-based standard deviates (first two columns and rows) and permutation rank-based probability values are very strong:</span>
<span id="cb66-541"><a href="#cb66-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-544"><a href="#cb66-544" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-545"><a href="#cb66-545" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(<span class="fu">cbind</span>(<span class="at">localG=</span><span class="fu">attr</span>(locG, <span class="st">"internals"</span>)[, <span class="st">"Pr(z != E(Gi))"</span>], </span>
<span id="cb66-546"><a href="#cb66-546" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attr</span>(locG_p, <span class="st">"internals"</span>)[, <span class="fu">c</span>(<span class="st">"Pr(z != E(Gi))"</span>, </span>
<span id="cb66-547"><a href="#cb66-547" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Pr(z != E(Gi)) Sim"</span>)]))</span>
<span id="cb66-548"><a href="#cb66-548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-549"><a href="#cb66-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-550"><a href="#cb66-550" aria-hidden="true" tabindex="-1"></a><span class="fu">### Local Geary's $C_i$</span></span>
<span id="cb66-551"><a href="#cb66-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-552"><a href="#cb66-552" aria-hidden="true" tabindex="-1"></a>\index{Geary's C!local}</span>
<span id="cb66-553"><a href="#cb66-553" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{localC<span class="sc">\_</span>perm}</span>
<span id="cb66-554"><a href="#cb66-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-555"><a href="#cb66-555" aria-hidden="true" tabindex="-1"></a>@https://doi.org/10.1111/gean.12164 extends @anselin:95 and has been recently added to **spdep** thanks to contributions by Josiah Parry (pull request https://github.com/r-spatial/spdep/pull/66). The conditional permutation framework used for $I_i$ and $G_i$ is also used for $C_i$:</span>
<span id="cb66-556"><a href="#cb66-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-557"><a href="#cb66-557" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb66-558"><a href="#cb66-558" aria-hidden="true" tabindex="-1"></a><span class="in">I_turnout |&gt; </span></span>
<span id="cb66-559"><a href="#cb66-559" aria-hidden="true" tabindex="-1"></a><span class="in">        localC_perm(lw_q_W, nsim=9999, iseed=1) -&gt; locC_p</span></span>
<span id="cb66-560"><a href="#cb66-560" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-561"><a href="#cb66-561" aria-hidden="true" tabindex="-1"></a>The permutation standard deviate-based and rank-based probability values are not as highly correlated as for $G_i$, in part reflecting the difference in view of autocorrelation in $C_i$ as represented by a function of the differences between values rather than the products of values:</span>
<span id="cb66-562"><a href="#cb66-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-565"><a href="#cb66-565" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-566"><a href="#cb66-566" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(<span class="fu">attr</span>(locC_p, <span class="st">"pseudo-p"</span>)[, <span class="fu">c</span>(<span class="st">"Pr(z != E(Ci))"</span>,</span>
<span id="cb66-567"><a href="#cb66-567" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"Pr(z != E(Ci)) Sim"</span>)])</span>
<span id="cb66-568"><a href="#cb66-568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-569"><a href="#cb66-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-572"><a href="#cb66-572" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-573"><a href="#cb66-573" aria-hidden="true" tabindex="-1"></a>locC_p <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname =</span> <span class="st">"Pr(z != E(Ci)) Sim"</span>,</span>
<span id="cb66-574"><a href="#cb66-574" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cutoff =</span> <span class="fl">0.005</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>hs_C</span>
<span id="cb66-575"><a href="#cb66-575" aria-hidden="true" tabindex="-1"></a>locG_p <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname =</span> <span class="st">"Pr(z != E(Gi)) Sim"</span>,</span>
<span id="cb66-576"><a href="#cb66-576" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cutoff =</span> <span class="fl">0.005</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>hs_G</span>
<span id="cb66-577"><a href="#cb66-577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-578"><a href="#cb66-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-579"><a href="#cb66-579" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-localIGC, echo=!knitr::is_latex_output(), message=FALSE}</span></span>
<span id="cb66-580"><a href="#cb66-580" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb66-581"><a href="#cb66-581" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: "FDR hotspot cluster core maps, two-sided, *interesting* cutoff $\\alpha = 0.005$: left panel: local Moran\\'s $I_i$; centre panel: local Getis-Ord $G_i$; right panel: local Geary\\'s $C_i$; first-round turnout, row-standardised neighbours"</span></span>
<span id="cb66-582"><a href="#cb66-582" aria-hidden="true" tabindex="-1"></a><span class="in">m1 &lt;- tm_shape(pol_pres15) +</span></span>
<span id="cb66-583"><a href="#cb66-583" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_fill("hs_cp_q", </span></span>
<span id="cb66-584"><a href="#cb66-584" aria-hidden="true" tabindex="-1"></a><span class="in">            palette = RColorBrewer::brewer.pal(4, "Set3")[-c(2,3)],</span></span>
<span id="cb66-585"><a href="#cb66-585" aria-hidden="true" tabindex="-1"></a><span class="in">            colorNA = "grey95", textNA = "Not \"interesting\"",</span></span>
<span id="cb66-586"><a href="#cb66-586" aria-hidden="true" tabindex="-1"></a><span class="in">            title = "Turnout hotspot status\nLocal Moran I") + </span></span>
<span id="cb66-587"><a href="#cb66-587" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_layout(legend.outside=TRUE, legend.outside.position="bottom")</span></span>
<span id="cb66-588"><a href="#cb66-588" aria-hidden="true" tabindex="-1"></a><span class="in">m2 &lt;- tm_shape(pol_pres15) +</span></span>
<span id="cb66-589"><a href="#cb66-589" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_fill("hs_G",</span></span>
<span id="cb66-590"><a href="#cb66-590" aria-hidden="true" tabindex="-1"></a><span class="in">            palette = RColorBrewer::brewer.pal(4, "Set3")[-c(2,3)],</span></span>
<span id="cb66-591"><a href="#cb66-591" aria-hidden="true" tabindex="-1"></a><span class="in">            colorNA = "grey95", textNA="Not \"interesting\"",</span></span>
<span id="cb66-592"><a href="#cb66-592" aria-hidden="true" tabindex="-1"></a><span class="in">            title = "Turnout hotspot status\nLocal Getis/Ord G") +</span></span>
<span id="cb66-593"><a href="#cb66-593" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_layout(legend.outside=TRUE, legend.outside.position="bottom")</span></span>
<span id="cb66-594"><a href="#cb66-594" aria-hidden="true" tabindex="-1"></a><span class="in">m3 &lt;- tm_shape(pol_pres15) +</span></span>
<span id="cb66-595"><a href="#cb66-595" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_fill("hs_C",</span></span>
<span id="cb66-596"><a href="#cb66-596" aria-hidden="true" tabindex="-1"></a><span class="in">            palette = RColorBrewer::brewer.pal(4, "Set3")[c(4, 1, 3)],</span></span>
<span id="cb66-597"><a href="#cb66-597" aria-hidden="true" tabindex="-1"></a><span class="in">            colorNA = "grey95", textNA="Not \"interesting\"",</span></span>
<span id="cb66-598"><a href="#cb66-598" aria-hidden="true" tabindex="-1"></a><span class="in">            title = "Turnout hotspot status\nLocal Geary C") +</span></span>
<span id="cb66-599"><a href="#cb66-599" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_layout(legend.outside=TRUE, legend.outside.position="bottom")</span></span>
<span id="cb66-600"><a href="#cb66-600" aria-hidden="true" tabindex="-1"></a><span class="in">tmap_arrange(m1, m2, m3, nrow=1)</span></span>
<span id="cb66-601"><a href="#cb66-601" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-602"><a href="#cb66-602" aria-hidden="true" tabindex="-1"></a>@fig-localIGC shows that the cluster cores identified as *interesting* using $I_i$, $G_i$ and $C_i$ for the same variable, first-round turnout, and the same spatial weights, for rank-based permutation FDR adjusted probability values and an $\alpha = 0.005$ cutoff, are very similar. In most cases, the <span class="in">`"High-High"`</span> cluster cores are urban areas, and <span class="in">`"Low-Low"`</span> cores are sparsely populated rural areas in the North, in addition to the German national minority areas close to the southern border. The three measures use slightly different strategies for naming cluster cores: $I_i$ uses quadrants of the Moran scatterplot, $G_i$ splits into <span class="in">`"Low"`</span> and <span class="in">`"High"`</span> on the mean of the input variable (which is the same as the first component in the $I_i$ tuple), and univariate $C_i$ on the mean of the input variable and zero for its lag. As before, cluster categories that do not occur are dropped.</span>
<span id="cb66-603"><a href="#cb66-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-604"><a href="#cb66-604" aria-hidden="true" tabindex="-1"></a>For comparison, and before moving to multivariate $C_i$, let us take the univariate $C_i$ for the second (final) round turnout. One would expect that the run-off between the two top candidates from the first-round might mobilise some voters who did not have a clear first-round preference, but that it discourages some of those with strong loyalty to a candidate eliminated after the first round:</span>
<span id="cb66-605"><a href="#cb66-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-606"><a href="#cb66-606" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb66-607"><a href="#cb66-607" aria-hidden="true" tabindex="-1"></a><span class="in">pol_pres15 |&gt; </span></span>
<span id="cb66-608"><a href="#cb66-608" aria-hidden="true" tabindex="-1"></a><span class="in">        st_drop_geometry() |&gt; </span></span>
<span id="cb66-609"><a href="#cb66-609" aria-hidden="true" tabindex="-1"></a><span class="in">        subset(select = II_turnout) |&gt; </span></span>
<span id="cb66-610"><a href="#cb66-610" aria-hidden="true" tabindex="-1"></a><span class="in">        localC_perm(lw_q_W, nsim=9999, iseed=1) -&gt; locC_p_II</span></span>
<span id="cb66-611"><a href="#cb66-611" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-612"><a href="#cb66-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-615"><a href="#cb66-615" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-616"><a href="#cb66-616" aria-hidden="true" tabindex="-1"></a>locC_p_II <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname =</span> <span class="st">"Pr(z != E(Ci)) Sim"</span>,</span>
<span id="cb66-617"><a href="#cb66-617" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cutoff =</span> <span class="fl">0.005</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>hs_C_II</span>
<span id="cb66-618"><a href="#cb66-618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-619"><a href="#cb66-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-620"><a href="#cb66-620" aria-hidden="true" tabindex="-1"></a>Multivariate $C_i$ <span class="co">[</span><span class="ot">@https://doi.org/10.1111/gean.12164</span><span class="co">]</span> is taken as the sum of univariate $C_i$ divided by the number of variables, but permutation is fixed so that the correlation between the variables is unchanged:</span>
<span id="cb66-621"><a href="#cb66-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-622"><a href="#cb66-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb66-623"><a href="#cb66-623" aria-hidden="true" tabindex="-1"></a><span class="in">pol_pres15 |&gt; </span></span>
<span id="cb66-624"><a href="#cb66-624" aria-hidden="true" tabindex="-1"></a><span class="in">        st_drop_geometry() |&gt; </span></span>
<span id="cb66-625"><a href="#cb66-625" aria-hidden="true" tabindex="-1"></a><span class="in">        subset(select = c(I_turnout, II_turnout)) |&gt;</span></span>
<span id="cb66-626"><a href="#cb66-626" aria-hidden="true" tabindex="-1"></a><span class="in">        localC_perm(lw_q_W, nsim=9999, iseed=1) -&gt; locMvC_p</span></span>
<span id="cb66-627"><a href="#cb66-627" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-628"><a href="#cb66-628" aria-hidden="true" tabindex="-1"></a>Let us check that the multivariate $C_i$ is equal  to  the mean of the univariate $C_i$:</span>
<span id="cb66-629"><a href="#cb66-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-632"><a href="#cb66-632" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-633"><a href="#cb66-633" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(locMvC_p, (locC_p<span class="sc">+</span>locC_p_II)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb66-634"><a href="#cb66-634" aria-hidden="true" tabindex="-1"></a>          <span class="at">check.attributes =</span> <span class="cn">FALSE</span>)</span>
<span id="cb66-635"><a href="#cb66-635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-638"><a href="#cb66-638" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-639"><a href="#cb66-639" aria-hidden="true" tabindex="-1"></a>locMvC_p <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname =</span> <span class="st">"Pr(z != E(Ci)) Sim"</span>,</span>
<span id="cb66-640"><a href="#cb66-640" aria-hidden="true" tabindex="-1"></a>                    <span class="at">cutoff =</span> <span class="fl">0.005</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>hs_MvC</span>
<span id="cb66-641"><a href="#cb66-641" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-642"><a href="#cb66-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-643"><a href="#cb66-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-644"><a href="#cb66-644" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-localCmulti, echo=!knitr::is_latex_output(), message=FALSE}</span></span>
<span id="cb66-645"><a href="#cb66-645" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb66-646"><a href="#cb66-646" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: 'FDR hotspot cluster core maps, two-sided, *interesting* cutoff $\alpha = 0.005$: left panel: local $C_i$, first-round turnout; centre panel: local $C_i$, second-round turnout; right panel: local multivariate $C_i$, both turnout rounds; row-standardised neighbours'</span></span>
<span id="cb66-647"><a href="#cb66-647" aria-hidden="true" tabindex="-1"></a><span class="in">m3 &lt;- tm_shape(pol_pres15) +</span></span>
<span id="cb66-648"><a href="#cb66-648" aria-hidden="true" tabindex="-1"></a><span class="in">  tm_fill("hs_C", </span></span>
<span id="cb66-649"><a href="#cb66-649" aria-hidden="true" tabindex="-1"></a><span class="in">    palette = RColorBrewer::brewer.pal(4, "Set3")[c(4, 1, 3, 2)],</span></span>
<span id="cb66-650"><a href="#cb66-650" aria-hidden="true" tabindex="-1"></a><span class="in">    colorNA = "grey95", textNA = "Not \"interesting\"",</span></span>
<span id="cb66-651"><a href="#cb66-651" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "First round turnout\nLocal Geary C") +</span></span>
<span id="cb66-652"><a href="#cb66-652" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_layout(legend.outside=TRUE, legend.outside.position="bottom")</span></span>
<span id="cb66-653"><a href="#cb66-653" aria-hidden="true" tabindex="-1"></a><span class="in">m4 &lt;- tm_shape(pol_pres15) +</span></span>
<span id="cb66-654"><a href="#cb66-654" aria-hidden="true" tabindex="-1"></a><span class="in">  tm_fill("hs_C_II", </span></span>
<span id="cb66-655"><a href="#cb66-655" aria-hidden="true" tabindex="-1"></a><span class="in">    palette = RColorBrewer::brewer.pal(4, "Set3")[c(4, 1, 3, 2)], </span></span>
<span id="cb66-656"><a href="#cb66-656" aria-hidden="true" tabindex="-1"></a><span class="in">    colorNA = "grey95", textNA = "Not \"interesting\"",</span></span>
<span id="cb66-657"><a href="#cb66-657" aria-hidden="true" tabindex="-1"></a><span class="in">    title="Second round turnout\nLocal Geary C") +</span></span>
<span id="cb66-658"><a href="#cb66-658" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_layout(legend.outside=TRUE, legend.outside.position="bottom")</span></span>
<span id="cb66-659"><a href="#cb66-659" aria-hidden="true" tabindex="-1"></a><span class="in">m5 &lt;- tm_shape(pol_pres15) +</span></span>
<span id="cb66-660"><a href="#cb66-660" aria-hidden="true" tabindex="-1"></a><span class="in">  tm_fill("hs_MvC", </span></span>
<span id="cb66-661"><a href="#cb66-661" aria-hidden="true" tabindex="-1"></a><span class="in">    palette = RColorBrewer::brewer.pal(4, "Set3")[c(4, 1)],</span></span>
<span id="cb66-662"><a href="#cb66-662" aria-hidden="true" tabindex="-1"></a><span class="in">    colorNA = "grey95", textNA = "Not \"interesting\"",</span></span>
<span id="cb66-663"><a href="#cb66-663" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Both rounds turnout\nLocal Multivariate Geary C") +</span></span>
<span id="cb66-664"><a href="#cb66-664" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_layout(legend.outside=TRUE, legend.outside.position="bottom")</span></span>
<span id="cb66-665"><a href="#cb66-665" aria-hidden="true" tabindex="-1"></a><span class="in">tmap_arrange(m3, m4, m5, nrow=1)</span></span>
<span id="cb66-666"><a href="#cb66-666" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-667"><a href="#cb66-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-668"><a href="#cb66-668" aria-hidden="true" tabindex="-1"></a>@fig-localCmulti indicates that the multivariate measure picks up aggregated elements of observations found *interesting* in the two univariate measures. We can break this down by interacting the first- and second-round univariate measures, and tabulating against the multivariate measure. </span>
<span id="cb66-669"><a href="#cb66-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-672"><a href="#cb66-672" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-673"><a href="#cb66-673" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">droplevels</span>(<span class="fu">interaction</span>(<span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>hs_C),</span>
<span id="cb66-674"><a href="#cb66-674" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>hs_C_II), <span class="at">sep=</span><span class="st">":"</span>)), </span>
<span id="cb66-675"><a href="#cb66-675" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>hs_MvC))</span>
<span id="cb66-676"><a href="#cb66-676" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-677"><a href="#cb66-677" aria-hidden="true" tabindex="-1"></a>For these permutation outcomes, 47 observations in the multivariate case are found *interesting* where neither of the univariate $C_i$ were found *interesting* (FDR, cutoff $0.005$). Almost all of the observations found *interesting* in both first and second round, are also interesting in the multivariate case, but outcomes are more mixed when observations were only found interesting in one of the two rounds.</span>
<span id="cb66-678"><a href="#cb66-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-679"><a href="#cb66-679" aria-hidden="true" tabindex="-1"></a><span class="fu">### The **rgeoda** package</span></span>
<span id="cb66-680"><a href="#cb66-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-681"><a href="#cb66-681" aria-hidden="true" tabindex="-1"></a>\index{rgeoda}</span>
<span id="cb66-682"><a href="#cb66-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-683"><a href="#cb66-683" aria-hidden="true" tabindex="-1"></a>Geoda has been wrapped for R as **rgeoda** [@R-rgeoda], and provides very similar functionalities for the exploration of spatial autocorrelation in areal data as matching parts of **spdep**. The active objects are kept as pointers to a compiled code workspace; using compiled code for all operations (as in Geoda itself) makes **rgeoda** perform fast, but makes it less flexible when modifications or enhancements are desired.</span>
<span id="cb66-684"><a href="#cb66-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-685"><a href="#cb66-685" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{queen<span class="sc">\_</span>weights}</span>
<span id="cb66-686"><a href="#cb66-686" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb66-687"><a href="#cb66-687" aria-hidden="true" tabindex="-1"></a><span class="in">library(rgeoda)</span></span>
<span id="cb66-688"><a href="#cb66-688" aria-hidden="true" tabindex="-1"></a><span class="in">Geoda_w &lt;- queen_weights(pol_pres15)</span></span>
<span id="cb66-689"><a href="#cb66-689" aria-hidden="true" tabindex="-1"></a><span class="in">summary(Geoda_w)</span></span>
<span id="cb66-690"><a href="#cb66-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-691"><a href="#cb66-691" aria-hidden="true" tabindex="-1"></a>For comparison, let us take the multivariate $C_i$ measure of turnout in the two rounds of the 2015 Polish presidential election as above:</span>
<span id="cb66-692"><a href="#cb66-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-693"><a href="#cb66-693" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{local<span class="sc">\_</span>multigeary}</span>
<span id="cb66-694"><a href="#cb66-694" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb66-695"><a href="#cb66-695" aria-hidden="true" tabindex="-1"></a><span class="in">lisa &lt;- local_multigeary(Geoda_w, </span></span>
<span id="cb66-696"><a href="#cb66-696" aria-hidden="true" tabindex="-1"></a><span class="in">    pol_pres15[c("I_turnout", "II_turnout")], </span></span>
<span id="cb66-697"><a href="#cb66-697" aria-hidden="true" tabindex="-1"></a><span class="in">    cpu_threads = max(detectCores() - 1, 1),</span></span>
<span id="cb66-698"><a href="#cb66-698" aria-hidden="true" tabindex="-1"></a><span class="in">    permutations = 99999, seed = 1)</span></span>
<span id="cb66-699"><a href="#cb66-699" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-700"><a href="#cb66-700" aria-hidden="true" tabindex="-1"></a>The contiguity neighbours are the same as those found by <span class="in">`poly2nb`</span>:</span>
<span id="cb66-701"><a href="#cb66-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-702"><a href="#cb66-702" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{lisa<span class="sc">\_</span>num<span class="sc">\_</span>nbrs}</span>
<span id="cb66-703"><a href="#cb66-703" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb66-704"><a href="#cb66-704" aria-hidden="true" tabindex="-1"></a><span class="in">all.equal(card(nb_q), lisa_num_nbrs(lisa), </span></span>
<span id="cb66-705"><a href="#cb66-705" aria-hidden="true" tabindex="-1"></a><span class="in">          check.attributes = FALSE)</span></span>
<span id="cb66-706"><a href="#cb66-706" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-707"><a href="#cb66-707" aria-hidden="true" tabindex="-1"></a>as are the multivariate $C_i$ values the same as those found above:</span>
<span id="cb66-708"><a href="#cb66-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-709"><a href="#cb66-709" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{lisa<span class="sc">\_</span>values}</span>
<span id="cb66-710"><a href="#cb66-710" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb66-711"><a href="#cb66-711" aria-hidden="true" tabindex="-1"></a><span class="in">all.equal(lisa_values(lisa), c(locMvC_p),</span></span>
<span id="cb66-712"><a href="#cb66-712" aria-hidden="true" tabindex="-1"></a><span class="in">          check.attributes = FALSE)</span></span>
<span id="cb66-713"><a href="#cb66-713" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-714"><a href="#cb66-714" aria-hidden="true" tabindex="-1"></a>One difference is that the range of the folded two-sided rank-based permutation probability values used by **rgeoda** is $[0, 0.5]$, also reported in **spdep**:</span>
<span id="cb66-715"><a href="#cb66-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-718"><a href="#cb66-718" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-719"><a href="#cb66-719" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(<span class="fu">attr</span>(locMvC_p, <span class="st">"pseudo-p"</span>)[,<span class="fu">c</span>(<span class="st">"Pr(z != E(Ci)) Sim"</span>, </span>
<span id="cb66-720"><a href="#cb66-720" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Pr(folded) Sim"</span>)], <span class="dv">2</span>, range)</span>
<span id="cb66-721"><a href="#cb66-721" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-722"><a href="#cb66-722" aria-hidden="true" tabindex="-1"></a>This means that the cutoff corresponding to $0.005$ over $<span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>$ is $0.0025$ over $<span class="co">[</span><span class="ot">0, 0.5</span><span class="co">]</span>$:</span>
<span id="cb66-723"><a href="#cb66-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-726"><a href="#cb66-726" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-727"><a href="#cb66-727" aria-hidden="true" tabindex="-1"></a>locMvC_p <span class="sc">|&gt;</span> <span class="fu">hotspot</span>(<span class="at">Prname =</span> <span class="st">"Pr(folded) Sim"</span>,</span>
<span id="cb66-728"><a href="#cb66-728" aria-hidden="true" tabindex="-1"></a>                    <span class="at">cutoff =</span> <span class="fl">0.0025</span>) <span class="ot">-&gt;</span> pol_pres15<span class="sc">$</span>hs_MvCa</span>
<span id="cb66-729"><a href="#cb66-729" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-730"><a href="#cb66-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-731"><a href="#cb66-731" aria-hidden="true" tabindex="-1"></a>So although <span class="in">`local_multigeary`</span> used the default cutoff of $0.05$ in setting cluster core classes, we can sharpen the cutoff and apply the FDR adjustment on output components of the <span class="in">`lisa`</span> object in the compiled code workspace:</span>
<span id="cb66-732"><a href="#cb66-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-735"><a href="#cb66-735" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-736"><a href="#cb66-736" aria-hidden="true" tabindex="-1"></a>mvc <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">lisa_clusters</span>(lisa), <span class="at">levels=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>,</span>
<span id="cb66-737"><a href="#cb66-737" aria-hidden="true" tabindex="-1"></a>              <span class="at">labels =</span> <span class="fu">lisa_labels</span>(lisa)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb66-738"><a href="#cb66-738" aria-hidden="true" tabindex="-1"></a><span class="fu">is.na</span>(mvc) <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(<span class="fu">lisa_pvalues</span>(lisa), <span class="st">"fdr"</span>) <span class="sc">&gt;=</span> <span class="fl">0.0025</span></span>
<span id="cb66-739"><a href="#cb66-739" aria-hidden="true" tabindex="-1"></a>pol_pres15<span class="sc">$</span>geoda_mvc <span class="ot">&lt;-</span> <span class="fu">droplevels</span>(mvc)</span>
<span id="cb66-740"><a href="#cb66-740" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-741"><a href="#cb66-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-742"><a href="#cb66-742" aria-hidden="true" tabindex="-1"></a>About 80 more observations are found *interesting* in the **rgeoda** permutation, and further analysis of implementation details is still in progress:</span>
<span id="cb66-743"><a href="#cb66-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-746"><a href="#cb66-746" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-747"><a href="#cb66-747" aria-hidden="true" tabindex="-1"></a><span class="fu">addmargins</span>(<span class="fu">table</span>(<span class="at">spdep =</span> <span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>hs_MvCa),</span>
<span id="cb66-748"><a href="#cb66-748" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rgeoda =</span> <span class="fu">addNA</span>(pol_pres15<span class="sc">$</span>geoda_mvc)))</span>
<span id="cb66-749"><a href="#cb66-749" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-750"><a href="#cb66-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-751"><a href="#cb66-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-752"><a href="#cb66-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-753"><a href="#cb66-753" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-localCmultix, echo=!knitr::is_latex_output(), message=FALSE}</span></span>
<span id="cb66-754"><a href="#cb66-754" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 100%</span></span>
<span id="cb66-755"><a href="#cb66-755" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb66-756"><a href="#cb66-756" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig.cap: 'FDR local multivariate $C_i$ hotspot cluster core maps, two-sided, *interesting* cutoff $\alpha = 0.0025$ over $[0, 0.5]$: left panel: **spdep**, both turnout rounds; right panel: **rgeoda**, both turnout rounds; row-standardised neighbours'</span></span>
<span id="cb66-757"><a href="#cb66-757" aria-hidden="true" tabindex="-1"></a><span class="in">m5 &lt;- tm_shape(pol_pres15) +</span></span>
<span id="cb66-758"><a href="#cb66-758" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_fill("hs_MvCa", </span></span>
<span id="cb66-759"><a href="#cb66-759" aria-hidden="true" tabindex="-1"></a><span class="in">        palette = RColorBrewer::brewer.pal(4, "Set3")[c(4, 1)],</span></span>
<span id="cb66-760"><a href="#cb66-760" aria-hidden="true" tabindex="-1"></a><span class="in">        colorNA = "grey95", textNA = "Not \"interesting\"",</span></span>
<span id="cb66-761"><a href="#cb66-761" aria-hidden="true" tabindex="-1"></a><span class="in">  title = "Both rounds turnout spdep\nLocal Multivariate Geary C")</span></span>
<span id="cb66-762"><a href="#cb66-762" aria-hidden="true" tabindex="-1"></a><span class="in">m6 &lt;- tm_shape(pol_pres15) +</span></span>
<span id="cb66-763"><a href="#cb66-763" aria-hidden="true" tabindex="-1"></a><span class="in">    tm_fill("geoda_mvc", </span></span>
<span id="cb66-764"><a href="#cb66-764" aria-hidden="true" tabindex="-1"></a><span class="in">        palette = RColorBrewer::brewer.pal(4, "Set3")[c(4, 1)],</span></span>
<span id="cb66-765"><a href="#cb66-765" aria-hidden="true" tabindex="-1"></a><span class="in">        colorNA = "grey95", textNA = "Not \"interesting\"",</span></span>
<span id="cb66-766"><a href="#cb66-766" aria-hidden="true" tabindex="-1"></a><span class="in">  title="Both rounds turnout rgeoda\nLocal Multivariate Geary C")</span></span>
<span id="cb66-767"><a href="#cb66-767" aria-hidden="true" tabindex="-1"></a><span class="in">tmap_arrange(m5, m6, nrow=1)</span></span>
<span id="cb66-768"><a href="#cb66-768" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-769"><a href="#cb66-769" aria-hidden="true" tabindex="-1"></a>@fig-localCmultix shows that while almost all of the 242 observations found *interesting* in the **spdep** implementation were also *interesting* for **rgeoda**, the latter found a further 86 *interesting*. Of course, permutation outcomes are bound to vary, but it remains to establish whether either or both implementations require revision.</span>
<span id="cb66-770"><a href="#cb66-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-771"><a href="#cb66-771" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb66-772"><a href="#cb66-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-773"><a href="#cb66-773" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Why are join-count measures on a chessboard so different between <span class="in">`rook`</span> and <span class="in">`queen`</span> neighbours?</span>
<span id="cb66-774"><a href="#cb66-774" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Please repeat the simulation shown in @sec-measprocmisspec using the chessboard polygons and the row-standardised <span class="in">`queen`</span> contiguity neighbours. Why is it important to understand that spatial autocorrelation usually signals (unavoidable) misspecification in our data?</span>
<span id="cb66-775"><a href="#cb66-775" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Why is false discovery rate adjustment recommended for local measures of spatial autocorrelation? </span>
<span id="cb66-776"><a href="#cb66-776" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Compare the local Moran's $I_i$ standard deviate values for the simulated data from exercise 2 (above) for the analytical conditional approach, and saddlepoint approximation. Consider the advantages and disadvantages of the saddlepoint approximation approach. </span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/edzer/sdsr/edit/main/15-Measures.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>