<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 16 Spatial Regression | Spatial Data Science</title>
  <meta name="description" content="description_xx" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 16 Spatial Regression | Spatial Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="description_xx" />
  <meta name="github-repo" content="edzer/sdsr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 16 Spatial Regression | Spatial Data Science" />
  
  <meta name="twitter:description" content="description_xx" />
  

<meta name="author" content="Edzer Pebesma, Roger Bivand" />


<meta name="date" content="2021-10-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="spatautocorr.html"/>
<link rel="next" href="spatecon.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I Spatial Data</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Getting Started</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-first-map"><i class="fa fa-check"></i><b>1.1</b> A first map</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>1.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#rasterize"><i class="fa fa-check"></i><b>1.3</b> Raster and vector data</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#raster-types"><i class="fa fa-check"></i><b>1.4</b> Raster types</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#time-series-arrays-data-cubes"><i class="fa fa-check"></i><b>1.5</b> Time series, arrays, data cubes</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#support"><i class="fa fa-check"></i><b>1.6</b> Support</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#spatial-data-science-software"><i class="fa fa-check"></i><b>1.7</b> Spatial data science software</a></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cs.html"><a href="cs.html"><i class="fa fa-check"></i><b>2</b> Coordinates</a><ul>
<li class="chapter" data-level="2.1" data-path="cs.html"><a href="cs.html#units"><i class="fa fa-check"></i><b>2.1</b> Quantities, units, datum</a></li>
<li class="chapter" data-level="2.2" data-path="cs.html"><a href="cs.html#ellipsoidal-coordinates"><i class="fa fa-check"></i><b>2.2</b> Ellipsoidal coordinates</a></li>
<li class="chapter" data-level="2.3" data-path="cs.html"><a href="cs.html#crs"><i class="fa fa-check"></i><b>2.3</b> Coordinate Reference Systems</a></li>
<li class="chapter" data-level="2.4" data-path="cs.html"><a href="cs.html#projlib"><i class="fa fa-check"></i><b>2.4</b> PROJ and mapping accuracy</a></li>
<li class="chapter" data-level="2.5" data-path="cs.html"><a href="cs.html#wkt2"><i class="fa fa-check"></i><b>2.5</b> WKT-2</a></li>
<li class="chapter" data-level="2.6" data-path="cs.html"><a href="cs.html#exercises-1"><i class="fa fa-check"></i><b>2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geometries.html"><a href="geometries.html"><i class="fa fa-check"></i><b>3</b> Geometries</a><ul>
<li class="chapter" data-level="3.1" data-path="geometries.html"><a href="geometries.html#simplefeatures"><i class="fa fa-check"></i><b>3.1</b> Simple feature geometries</a></li>
<li class="chapter" data-level="3.2" data-path="geometries.html"><a href="geometries.html#opgeom"><i class="fa fa-check"></i><b>3.2</b> Operations on geometries</a></li>
<li class="chapter" data-level="3.3" data-path="geometries.html"><a href="geometries.html#precision"><i class="fa fa-check"></i><b>3.3</b> Precision</a></li>
<li class="chapter" data-level="3.4" data-path="geometries.html"><a href="geometries.html#coverages"><i class="fa fa-check"></i><b>3.4</b> Coverages: tessellations and rasters</a></li>
<li class="chapter" data-level="3.5" data-path="geometries.html"><a href="geometries.html#networks"><i class="fa fa-check"></i><b>3.5</b> Networks</a></li>
<li class="chapter" data-level="3.6" data-path="geometries.html"><a href="geometries.html#exercises-2"><i class="fa fa-check"></i><b>3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spherical.html"><a href="spherical.html"><i class="fa fa-check"></i><b>4</b> Spherical Geometries</a><ul>
<li class="chapter" data-level="4.1" data-path="spherical.html"><a href="spherical.html#straight-lines"><i class="fa fa-check"></i><b>4.1</b> Straight lines</a></li>
<li class="chapter" data-level="4.2" data-path="spherical.html"><a href="spherical.html#ring-direction"><i class="fa fa-check"></i><b>4.2</b> Ring direction</a></li>
<li class="chapter" data-level="4.3" data-path="spherical.html"><a href="spherical.html#full-polygon"><i class="fa fa-check"></i><b>4.3</b> Full polygon</a></li>
<li class="chapter" data-level="4.4" data-path="spherical.html"><a href="spherical.html#bounding-box-rectangle-and-cap"><i class="fa fa-check"></i><b>4.4</b> Bounding box, rectangle, and cap</a></li>
<li class="chapter" data-level="4.5" data-path="spherical.html"><a href="spherical.html#validity-on-the-sphere"><i class="fa fa-check"></i><b>4.5</b> Validity on the sphere</a></li>
<li class="chapter" data-level="4.6" data-path="spherical.html"><a href="spherical.html#exercises-3"><i class="fa fa-check"></i><b>4.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="featureattributes.html"><a href="featureattributes.html"><i class="fa fa-check"></i><b>5</b> Attributes and Support</a><ul>
<li class="chapter" data-level="5.1" data-path="featureattributes.html"><a href="featureattributes.html#agr"><i class="fa fa-check"></i><b>5.1</b> Attribute-geometry relationships and support</a></li>
<li class="chapter" data-level="5.2" data-path="featureattributes.html"><a href="featureattributes.html#aggregating-and-summarising"><i class="fa fa-check"></i><b>5.2</b> Aggregating and summarising</a></li>
<li class="chapter" data-level="5.3" data-path="featureattributes.html"><a href="featureattributes.html#area-weighted"><i class="fa fa-check"></i><b>5.3</b> Area-weighted interpolation</a></li>
<li class="chapter" data-level="5.4" data-path="featureattributes.html"><a href="featureattributes.html#updownscaling"><i class="fa fa-check"></i><b>5.4</b> Up- and Downscaling</a></li>
<li class="chapter" data-level="5.5" data-path="featureattributes.html"><a href="featureattributes.html#exercises-4"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="datacube.html"><a href="datacube.html"><i class="fa fa-check"></i><b>6</b> Data Cubes</a><ul>
<li class="chapter" data-level="6.1" data-path="datacube.html"><a href="datacube.html#a-four-dimensional-data-cube"><i class="fa fa-check"></i><b>6.1</b> A four-dimensional data cube</a></li>
<li class="chapter" data-level="6.2" data-path="datacube.html"><a href="datacube.html#dimensions-attributes-and-support"><i class="fa fa-check"></i><b>6.2</b> Dimensions, attributes, and support</a></li>
<li class="chapter" data-level="6.3" data-path="datacube.html"><a href="datacube.html#dcoperations"><i class="fa fa-check"></i><b>6.3</b> Operations on data cubes</a></li>
<li class="chapter" data-level="6.4" data-path="datacube.html"><a href="datacube.html#vectordatacubes"><i class="fa fa-check"></i><b>6.4</b> Aggregating raster to vector cubes</a></li>
<li class="chapter" data-level="6.5" data-path="datacube.html"><a href="datacube.html#switching"><i class="fa fa-check"></i><b>6.5</b> Switching dimension with attributes</a></li>
<li class="chapter" data-level="6.6" data-path="datacube.html"><a href="datacube.html#otherdynamic"><i class="fa fa-check"></i><b>6.6</b> Other dynamic spatial data</a></li>
<li class="chapter" data-level="6.7" data-path="datacube.html"><a href="datacube.html#exercises-5"><i class="fa fa-check"></i><b>6.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II R for Spatial Data Science</b></span></li>
<li class="chapter" data-level="7" data-path="sf.html"><a href="sf.html"><i class="fa fa-check"></i><b>7</b> Introduction to sf and stars</a><ul>
<li class="chapter" data-level="7.1" data-path="sf.html"><a href="sf.html#sfintro"><i class="fa fa-check"></i><b>7.1</b> Package <code>sf</code></a></li>
<li class="chapter" data-level="7.2" data-path="sf.html"><a href="sf.html#spatial-joins"><i class="fa fa-check"></i><b>7.2</b> Spatial joins</a></li>
<li class="chapter" data-level="7.3" data-path="sf.html"><a href="sf.html#package-stars"><i class="fa fa-check"></i><b>7.3</b> Package <code>stars</code></a></li>
<li class="chapter" data-level="7.4" data-path="sf.html"><a href="sf.html#vector-data-cube-examples"><i class="fa fa-check"></i><b>7.4</b> Vector data cube examples</a></li>
<li class="chapter" data-level="7.5" data-path="sf.html"><a href="sf.html#raster-to-vector"><i class="fa fa-check"></i><b>7.5</b> raster-to-vector, vector-to-raster</a></li>
<li class="chapter" data-level="7.6" data-path="sf.html"><a href="sf.html#projsf"><i class="fa fa-check"></i><b>7.6</b> Coordinate transformations and conversions</a></li>
<li class="chapter" data-level="7.7" data-path="sf.html"><a href="sf.html#warp"><i class="fa fa-check"></i><b>7.7</b> Transforming and warping rasters</a></li>
<li class="chapter" data-level="7.8" data-path="sf.html"><a href="sf.html#exercises-6"><i class="fa fa-check"></i><b>7.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="large.html"><a href="large.html"><i class="fa fa-check"></i><b>8</b> Large data sets</a><ul>
<li class="chapter" data-level="8.1" data-path="large.html"><a href="large.html#largesf"><i class="fa fa-check"></i><b>8.1</b> Vector data: <code>sf</code></a></li>
<li class="chapter" data-level="8.2" data-path="large.html"><a href="large.html#raster-data-stars"><i class="fa fa-check"></i><b>8.2</b> Raster data: <code>stars</code></a></li>
<li class="chapter" data-level="8.3" data-path="large.html"><a href="large.html#very-large-data-cubes"><i class="fa fa-check"></i><b>8.3</b> Very large data cubes</a></li>
<li class="chapter" data-level="8.4" data-path="large.html"><a href="large.html#exercises-7"><i class="fa fa-check"></i><b>8.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>9</b> Plotting spatial data</a><ul>
<li class="chapter" data-level="9.1" data-path="plotting.html"><a href="plotting.html#transform"><i class="fa fa-check"></i><b>9.1</b> Every plot is a projection</a></li>
<li class="chapter" data-level="9.2" data-path="plotting.html"><a href="plotting.html#plotting-points-lines-polygons-grid-cells"><i class="fa fa-check"></i><b>9.2</b> Plotting points, lines, polygons, grid cells</a></li>
<li class="chapter" data-level="9.3" data-path="plotting.html"><a href="plotting.html#base-plot"><i class="fa fa-check"></i><b>9.3</b> Base <code>plot</code></a></li>
<li class="chapter" data-level="9.4" data-path="plotting.html"><a href="plotting.html#geomsf"><i class="fa fa-check"></i><b>9.4</b> Maps with <code>ggplot2</code></a></li>
<li class="chapter" data-level="9.5" data-path="plotting.html"><a href="plotting.html#tmap"><i class="fa fa-check"></i><b>9.5</b> Maps with <code>tmap</code></a></li>
<li class="chapter" data-level="9.6" data-path="plotting.html"><a href="plotting.html#interactive-maps-leaflet-mapview-tmap"><i class="fa fa-check"></i><b>9.6</b> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code></a></li>
<li class="chapter" data-level="9.7" data-path="plotting.html"><a href="plotting.html#exercises-8"><i class="fa fa-check"></i><b>9.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>III Models for Spatial Data</b></span></li>
<li class="chapter" data-level="10" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html"><i class="fa fa-check"></i><b>10</b> Statistical modelling of spatial data</a><ul>
<li class="chapter" data-level="10.1" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#design"><i class="fa fa-check"></i><b>10.1</b> Design-based and model-based inference</a></li>
<li class="chapter" data-level="10.2" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#predictive-models-with-coordinates"><i class="fa fa-check"></i><b>10.2</b> Predictive models with coordinates</a></li>
<li class="chapter" data-level="10.3" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#further-reading"><i class="fa fa-check"></i><b>10.3</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="pointpatterns.html"><a href="pointpatterns.html"><i class="fa fa-check"></i><b>11</b> Point Pattern Analysis</a><ul>
<li class="chapter" data-level="11.1" data-path="pointpatterns.html"><a href="pointpatterns.html#observation-window"><i class="fa fa-check"></i><b>11.1</b> Observation window</a></li>
<li class="chapter" data-level="11.2" data-path="pointpatterns.html"><a href="pointpatterns.html#coordinate-reference-systems-1"><i class="fa fa-check"></i><b>11.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="11.3" data-path="pointpatterns.html"><a href="pointpatterns.html#marked-point-patterns-points-on-linear-networks"><i class="fa fa-check"></i><b>11.3</b> Marked point patterns, points on linear networks</a></li>
<li class="chapter" data-level="11.4" data-path="pointpatterns.html"><a href="pointpatterns.html#spatial-sampling-and-simulating-a-point-process"><i class="fa fa-check"></i><b>11.4</b> Spatial sampling and simulating a point process</a></li>
<li class="chapter" data-level="11.5" data-path="pointpatterns.html"><a href="pointpatterns.html#simulating-points-on-the-globe"><i class="fa fa-check"></i><b>11.5</b> Simulating points on the globe</a></li>
<li class="chapter" data-level="11.6" data-path="pointpatterns.html"><a href="pointpatterns.html#exercises-9"><i class="fa fa-check"></i><b>11.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="interpolation.html"><a href="interpolation.html"><i class="fa fa-check"></i><b>12</b> Spatial Interpolation</a><ul>
<li class="chapter" data-level="12.1" data-path="interpolation.html"><a href="interpolation.html#a-first-dataset"><i class="fa fa-check"></i><b>12.1</b> A first dataset</a></li>
<li class="chapter" data-level="12.2" data-path="interpolation.html"><a href="interpolation.html#sample-variogram"><i class="fa fa-check"></i><b>12.2</b> Sample variogram</a></li>
<li class="chapter" data-level="12.3" data-path="interpolation.html"><a href="interpolation.html#fitting-variogram-models"><i class="fa fa-check"></i><b>12.3</b> Fitting variogram models</a></li>
<li class="chapter" data-level="12.4" data-path="interpolation.html"><a href="interpolation.html#kriging"><i class="fa fa-check"></i><b>12.4</b> Kriging interpolation</a></li>
<li class="chapter" data-level="12.5" data-path="interpolation.html"><a href="interpolation.html#blockkriging"><i class="fa fa-check"></i><b>12.5</b> Areal means: block kriging</a></li>
<li class="chapter" data-level="12.6" data-path="interpolation.html"><a href="interpolation.html#conditional-simulation"><i class="fa fa-check"></i><b>12.6</b> Conditional simulation</a></li>
<li class="chapter" data-level="12.7" data-path="interpolation.html"><a href="interpolation.html#trend-models"><i class="fa fa-check"></i><b>12.7</b> Trend models</a></li>
<li class="chapter" data-level="12.8" data-path="interpolation.html"><a href="interpolation.html#exercises-10"><i class="fa fa-check"></i><b>12.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="stgeostatistics.html"><a href="stgeostatistics.html"><i class="fa fa-check"></i><b>13</b> Multivariate and Spatiotemporal Geostatistics</a><ul>
<li class="chapter" data-level="13.1" data-path="stgeostatistics.html"><a href="stgeostatistics.html#preparing"><i class="fa fa-check"></i><b>13.1</b> Preparing the air quality dataset</a></li>
<li class="chapter" data-level="13.2" data-path="stgeostatistics.html"><a href="stgeostatistics.html#cokriging"><i class="fa fa-check"></i><b>13.2</b> Multivariable geostatistics</a></li>
<li class="chapter" data-level="13.3" data-path="stgeostatistics.html"><a href="stgeostatistics.html#spatiotemporal-geostatistics"><i class="fa fa-check"></i><b>13.3</b> Spatiotemporal geostatistics</a></li>
<li class="chapter" data-level="13.4" data-path="stgeostatistics.html"><a href="stgeostatistics.html#exercises-11"><i class="fa fa-check"></i><b>13.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="area.html"><a href="area.html"><i class="fa fa-check"></i><b>14</b> Proximity and Areal Data</a><ul>
<li class="chapter" data-level="14.1" data-path="area.html"><a href="area.html#representing-proximity-in-spdep"><i class="fa fa-check"></i><b>14.1</b> Representing proximity in <strong>spdep</strong></a></li>
<li class="chapter" data-level="14.2" data-path="area.html"><a href="area.html#contiguous-neighbours"><i class="fa fa-check"></i><b>14.2</b> Contiguous neighbours</a></li>
<li class="chapter" data-level="14.3" data-path="area.html"><a href="area.html#graph-based-neighbours"><i class="fa fa-check"></i><b>14.3</b> Graph-based neighbours</a></li>
<li class="chapter" data-level="14.4" data-path="area.html"><a href="area.html#distance-based-neighbours"><i class="fa fa-check"></i><b>14.4</b> Distance-based neighbours</a></li>
<li class="chapter" data-level="14.5" data-path="area.html"><a href="area.html#weights-specification"><i class="fa fa-check"></i><b>14.5</b> Weights specification</a></li>
<li class="chapter" data-level="14.6" data-path="area.html"><a href="area.html#higher-order-neighbours"><i class="fa fa-check"></i><b>14.6</b> Higher order neighbours</a></li>
<li class="chapter" data-level="14.7" data-path="area.html"><a href="area.html#exercises-12"><i class="fa fa-check"></i><b>14.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="spatautocorr.html"><a href="spatautocorr.html"><i class="fa fa-check"></i><b>15</b> Measures of spatial autocorrelation</a><ul>
<li class="chapter" data-level="15.1" data-path="spatautocorr.html"><a href="spatautocorr.html#measures-and-process-mis-specification"><i class="fa fa-check"></i><b>15.1</b> Measures and process mis-specification</a></li>
<li class="chapter" data-level="15.2" data-path="spatautocorr.html"><a href="spatautocorr.html#global-measures"><i class="fa fa-check"></i><b>15.2</b> Global measures</a></li>
<li class="chapter" data-level="15.3" data-path="spatautocorr.html"><a href="spatautocorr.html#local-measures"><i class="fa fa-check"></i><b>15.3</b> Local measures</a></li>
<li class="chapter" data-level="15.4" data-path="spatautocorr.html"><a href="spatautocorr.html#exercises-13"><i class="fa fa-check"></i><b>15.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="spatglmm.html"><a href="spatglmm.html"><i class="fa fa-check"></i><b>16</b> Spatial Regression</a><ul>
<li class="chapter" data-level="16.1" data-path="spatglmm.html"><a href="spatglmm.html#markov-random-field-and-multilevel-models-with-spatial-weights"><i class="fa fa-check"></i><b>16.1</b> Markov random field and multilevel models with spatial weights</a></li>
<li class="chapter" data-level="16.2" data-path="spatglmm.html"><a href="spatglmm.html#multilevel-models-of-the-boston-data-set"><i class="fa fa-check"></i><b>16.2</b> Multilevel models of the Boston data set</a></li>
<li class="chapter" data-level="16.3" data-path="spatglmm.html"><a href="spatglmm.html#exercises-14"><i class="fa fa-check"></i><b>16.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="spatecon.html"><a href="spatecon.html"><i class="fa fa-check"></i><b>17</b> Spatial econometrics models</a><ul>
<li class="chapter" data-level="17.1" data-path="spatecon.html"><a href="spatecon.html#spatial-econometric-models-definitions"><i class="fa fa-check"></i><b>17.1</b> Spatial econometric models: definitions</a></li>
<li class="chapter" data-level="17.2" data-path="spatecon.html"><a href="spatecon.html#maximum-likelihood-estimation-in-spatialreg"><i class="fa fa-check"></i><b>17.2</b> Maximum likelihood estimation in <strong>spatialreg</strong></a></li>
<li class="chapter" data-level="17.3" data-path="spatecon.html"><a href="spatecon.html#impacts"><i class="fa fa-check"></i><b>17.3</b> Impacts</a></li>
<li class="chapter" data-level="17.4" data-path="spatecon.html"><a href="spatecon.html#spatecon_pred"><i class="fa fa-check"></i><b>17.4</b> Predictions</a></li>
<li class="chapter" data-level="17.5" data-path="spatecon.html"><a href="spatecon.html#exercises-15"><i class="fa fa-check"></i><b>17.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="older.html"><a href="older.html"><i class="fa fa-check"></i><b>18</b> Older R Spatial Packages</a><ul>
<li class="chapter" data-level="18.1" data-path="older.html"><a href="older.html#retire"><i class="fa fa-check"></i><b>18.1</b> Retiring <code>rgdal</code> and <code>rgeos</code></a></li>
<li class="chapter" data-level="18.2" data-path="older.html"><a href="older.html#links-and-differences-between-sf-and-sp"><i class="fa fa-check"></i><b>18.2</b> Links and differences between sf and sp</a></li>
<li class="chapter" data-level="18.3" data-path="older.html"><a href="older.html#migration-code-and-packages"><i class="fa fa-check"></i><b>18.3</b> Migration code and packages</a></li>
<li class="chapter" data-level="18.4" data-path="older.html"><a href="older.html#package-raster-and-terra"><i class="fa fa-check"></i><b>18.4</b> Package raster and terra</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="all-r-code-in-this-book.html"><a href="all-r-code-in-this-book.html"><i class="fa fa-check"></i>All R code in this book</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html"><i class="fa fa-check"></i>R basics</a><ul>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#pipes"><i class="fa fa-check"></i>Pipes</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#data-structures"><i class="fa fa-check"></i>Data structures</a></li>
<li><a href="r-basics.html#dissecting-a-multipolygon">dissecting a <code>MULTIPOLYGON</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatglmm" class="section level1">
<h1><span class="header-section-number">Chapter 16</span> Spatial Regression</h1>
<p>Even though it may be tempting to focus on interpreting the map pattern of an areal support response variable of interest, the pattern may largely derive from covariates (and their functional forms), as well as the respective spatial footprints of the variables in play. Spatial autoregressive models in two dimensions began without covariates and with clear links to time series <span class="citation">(Whittle <a href="#ref-whittle:54">1954</a>)</span>. Extensions included tests for spatial autocorrelation in linear model residuals, and models applying the autoregressive component to the response or the residuals, where the latter matched the tests for residuals <span class="citation">(Cliff and Ord <a href="#ref-CliffOrd:72">1972</a>, <a href="#ref-cliff+ord:73">1973</a>)</span>. These lattice models of areal data typically express the dependence between observations using a graph of neighbours in the form of a contiguity matrix.</p>
<p>Of course, handling a spatial correlation structure in a generalised least squares model or a (generalized) linear or nonlinear mixed effects model such as those provided in the <strong>nlme</strong> and many other packages does not have to use a graph of neighbours <span class="citation">(Pinheiro and Bates <a href="#ref-R:Pinheiro+Bates:2000">2000</a>)</span>. These models are also spatial regression models, using functions of the distance between observations, and fitted variograms to model the spatial autocorrelation present; such models have been held to yield a clearer picture of the underlying processes <span class="citation">(Wall <a href="#ref-wall:04">2004</a>)</span>, building on geostatistics. For example, the <strong>glmmTMB</strong> package successfully uses this approach to spatial regression <span class="citation">(Brooks et al. <a href="#ref-brookesetal:17">2017</a>)</span>. Here we will only consider spatial regression using spatial weights matrices.</p>
<div id="markov-random-field-and-multilevel-models-with-spatial-weights" class="section level2">
<h2><span class="header-section-number">16.1</span> Markov random field and multilevel models with spatial weights</h2>
<p>There is a large literature in disease mapping using conditional autoregressive (CAR) and intrinsic CAR (ICAR) models in spatially structured random effects. These extend to multilevel models, in which the spatially structured random effects may apply at different levels of the model <span class="citation">(Roger S. Bivand et al. <a href="#ref-bivandetal17a">2017</a>)</span>. In order to try out some of the variants, we need to remove the no-neighbour observations from the tract level, and from the model output zone aggregated level, in two steps as reducing the tract level induces a no-neighbour outcome at the model output zone level. Many of the model estimating functions take <code>family=</code> arguments, and fit generalized linear mixed effects models with per-observation spatial random effects structured using a Markov random field representation of relationships between neighbours. In the multilevel case, the random effects may be modelled at the group level, which is the case presented in the following examples.</p>
<p>We follow <span class="citation">Gmez-Rubio (<a href="#ref-vgr_clubuc3m:19">2019</a>)</span> in summarizing <span class="citation">Pinheiro and Bates (<a href="#ref-R:Pinheiro+Bates:2000">2000</a>)</span> and <span class="citation">McCulloch and Searle (<a href="#ref-mcculloch+searle:2001">2001</a>)</span> to describe the mixed-effects model representation of spatial regression models. In a Gaussian linear mixed model setting, a random effect <span class="math inline">\(u\)</span> is added to the model, with response <span class="math inline">\(Y\)</span>, fixed covariates <span class="math inline">\(X\)</span>, their coefficients <span class="math inline">\(\beta\)</span> and error term <span class="math inline">\(\varepsilon_i \sim N(0, \sigma^2), i=1,\dots, n\)</span>:</p>
<p><span class="math display">\[
Y = X \beta + Z u + \varepsilon
\]</span>
<span class="math inline">\(Z\)</span> is a fixed design matrix for the random effects. If there are <span class="math inline">\(n\)</span> random effects, it will be an <span class="math inline">\(n \times n\)</span> identity matrix, if instead the observations are aggregated into <span class="math inline">\(m\)</span> groups, so with <span class="math inline">\(m &lt; n\)</span> random effects, it will be an <span class="math inline">\(n \times m\)</span> matrix showing which group each observation belongs to. The random effects are modelled as a multivariate Normal distribution <span class="math inline">\(u \sim N(0, \sigma^2_u \Sigma)\)</span>, and <span class="math inline">\(\Sigma\)</span> is the square variance-covariance matrix of the random effects.</p>
<p>A division has grown up, possibly unhelpfully, between scientific fields using CAR models <span class="citation">(Besag <a href="#ref-besag:74">1974</a>)</span>, and simultaneous autoregressive models (SAR) <span class="citation">(Ord <a href="#ref-ord:75">1975</a>; Hepple <a href="#ref-hepple:76">1976</a>)</span>. Although CAR and SAR models are closely related, these fields have found it difficult to share experience of applying similar models, often despite referring to key work summarising the models <span class="citation">(Ripley <a href="#ref-ripley:81">1981</a>, <a href="#ref-ripley:88">1988</a>; Cressie <a href="#ref-Cressie:1993">1993</a>)</span>. Ripley gives the SAR variance as <span class="citation">(<a href="#ref-ripley:81">1981</a>, 89)</span>, here shown as the inverse <span class="math inline">\(\Sigma^{-1}\)</span> (also known as the precision matrix):</p>
<p><span class="math display">\[
\Sigma^{-1} = [(I - \rho W)&#39;(I - \rho W)]
\]</span></p>
<p>where <span class="math inline">\(\rho\)</span> is a spatial autocorrelation parameter and <span class="math inline">\(W\)</span> is a nonsingular spatial weights matrix that represents spatial dependence. The CAR variance is:</p>
<p><span class="math display">\[
\Sigma^{-1} = (I - \rho W)
\]</span>
where <span class="math inline">\(W\)</span> is a symmetric and strictly positive definite spatial weights matrix. In the case of the intrinsic CAR model, avoiding the estimation of a spatial autocorrelation parameter, we have:</p>
<p><span class="math display">\[
\Sigma^{-1} = M = \mathrm{diag}(n_i) - W
\]</span>
where <span class="math inline">\(W\)</span> is a symmetric and strictly positive definite spatial weights matrix as before and <span class="math inline">\(n_i\)</span> are the row sums of <span class="math inline">\(W\)</span>. The Besag-York-Molli model includes intrinsic CAR spatially structured random effects and an unstructured random effects. The Leroux model combines matrix components for unstructured and spatially structured random effects, where the spatially structured random effects are taken as following an intrinsic CAR specification:</p>
<p><span class="math display">\[
\Sigma^{-1} = [(1 - \rho) I_n + \rho M]
\]</span>
References to the definitions of these models may be found in <span class="citation">V. Gmez-Rubio (<a href="#ref-gmez2020bayesian">2020</a>)</span>, and estimation issues affecting the Besag-York-Molli and Leroux models are reviewed by <span class="citation">Gerber and Furrer (<a href="#ref-JSSv063c01">2015</a>)</span>.</p>
<p>More recent books expounding the theoretical bases for modelling with areal data simply point out the similarities between SAR and CAR models in relevant chapters <span class="citation">(Gaetan and Guyon <a href="#ref-gaetan+guyon:10">2010</a>; Lieshout <a href="#ref-vanlieshout:19">2019</a>)</span>; the interested reader is invited to consult these sources for background information.</p>
<div id="boston-house-value-data-set" class="section level3">
<h3><span class="header-section-number">16.1.1</span> Boston house value data set</h3>
<p>Here we shall use the Boston housing data set, which has been restructured and furnished with census tract boundaries <span class="citation">(R. Bivand <a href="#ref-bivand17">2017</a>)</span>. The original data set used 506 census tracts and a hedonic model to try to estimate willingness to pay for clean air. The response was constructed from counts of ordinal answers to a 1970 census question about house value. The response is left and right censored in the census source and has been treated as Gaussian. The key covariate was created from a calibrated meteorological model showing the annual nitrogen oxides (NOX) level for a smaller number of model output zones. The numbers of houses responding also varies by tract and model output zone. There are several other covariates, some measured at the tract level, some by town only, where towns broadly correspond to the air pollution model output zones.</p>
<p>We can start by reading in the 506 tract data set from <strong>spData</strong> <span class="citation">(R. Bivand, Nowosad, and Lovelace <a href="#ref-R-spData">2021</a>)</span>, and creating a contiguity neighbour object and from that again a row standardized spatial weights object.</p>
<div class="sourceCode" id="cb633"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb633-1" title="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb633-2" title="2"><span class="kw">library</span>(spData)</a>
<a class="sourceLine" id="cb633-3" title="3">boston_<span class="dv">506</span> &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="kw">system.file</span>(<span class="st">&quot;shapes/boston_tracts.shp&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;spData&quot;</span>)[<span class="dv">1</span>])</a></code></pre></div>
<pre><code># Reading layer `boston_tracts&#39; from data source 
#   `/home/edzer/R/x86_64-pc-linux-gnu-library/4.0/spData/shapes/boston_tracts.shp&#39; 
#   using driver `ESRI Shapefile&#39;
# Simple feature collection with 506 features and 36 fields
# Geometry type: POLYGON
# Dimension:     XY
# Bounding box:  xmin: -71.5 ymin: 42 xmax: -70.6 ymax: 42.7
# Geodetic CRS:  NAD27</code></pre>
<div class="sourceCode" id="cb635"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb635-1" title="1">nb_q &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">506</span>)</a>
<a class="sourceLine" id="cb635-2" title="2">lw_q &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q, <span class="dt">style =</span> <span class="st">&quot;W&quot;</span>)</a></code></pre></div>
<p>If we examine the median house values, we find that those for censored values have been assigned as missing, and that 17 tracts are affected.</p>
<div class="sourceCode" id="cb636"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb636-1" title="1"><span class="kw">table</span>(boston_<span class="dv">506</span><span class="op">$</span>censored)</a></code></pre></div>
<pre><code># 
#  left    no right 
#     2   489    15</code></pre>
<div class="sourceCode" id="cb638"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb638-1" title="1"><span class="kw">summary</span>(boston_<span class="dv">506</span><span class="op">$</span>median)</a></code></pre></div>
<pre><code>#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA&#39;s 
#    5600   16800   21000   21749   24700   50000      17</code></pre>
<p>Next, we can subset to the remaining 489 tracts with non-censored house values, and the neighbour object to match. The neighbour object now has one observation with no neighbours.</p>
<div class="sourceCode" id="cb640"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb640-1" title="1">boston_<span class="dv">506</span><span class="op">$</span>CHAS &lt;-<span class="st"> </span><span class="kw">as.factor</span>(boston_<span class="dv">506</span><span class="op">$</span>CHAS)</a>
<a class="sourceLine" id="cb640-2" title="2">boston_<span class="dv">489</span> &lt;-<span class="st"> </span>boston_<span class="dv">506</span>[<span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">506</span><span class="op">$</span>median),]</a>
<a class="sourceLine" id="cb640-3" title="3">nb_q_<span class="dv">489</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">489</span>)</a>
<a class="sourceLine" id="cb640-4" title="4">lw_q_<span class="dv">489</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">489</span>, <span class="dt">style =</span> <span class="st">&quot;W&quot;</span>, <span class="dt">zero.policy =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>The <code>NOX_ID</code> variable specifies the upper level aggregation, letting us aggregate the tracts to air pollution model output zones. We can create aggregate neighbour and row standardized spatial weights objects, and aggregate the <code>NOX</code> variable taking means, and the <code>CHAS</code> Charles River dummy variable for observations on the river. Here we follow the principles outlined in section <a href="featureattributes.html#extensiveintensive">5.3.1</a> for spatially extensive and intensive variables; neither <code>NOX</code> nor <code>CHAS</code> can be summed as they are not count variables.</p>
<div class="sourceCode" id="cb641"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb641-1" title="1">agg_<span class="dv">96</span> &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">as.character</span>(boston_<span class="dv">506</span><span class="op">$</span>NOX_ID))</a>
<a class="sourceLine" id="cb641-2" title="2">boston_<span class="dv">96</span> &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span>[, <span class="st">&quot;NOX_ID&quot;</span>], <span class="dt">by =</span> agg_<span class="dv">96</span>, unique)</a>
<a class="sourceLine" id="cb641-3" title="3">nb_q_<span class="dv">96</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">96</span>)</a>
<a class="sourceLine" id="cb641-4" title="4">lw_q_<span class="dv">96</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">96</span>)</a>
<a class="sourceLine" id="cb641-5" title="5">boston_<span class="dv">96</span><span class="op">$</span>NOX &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span><span class="op">$</span>NOX, agg_<span class="dv">96</span>, mean)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb641-6" title="6">boston_<span class="dv">96</span><span class="op">$</span>CHAS &lt;-<span class="st"> </span><span class="kw">aggregate</span>(<span class="kw">as.integer</span>(boston_<span class="dv">506</span><span class="op">$</span>CHAS)<span class="op">-</span><span class="dv">1</span>, agg_<span class="dv">96</span>, max)<span class="op">$</span>x</a></code></pre></div>
<p>The response is aggregated using the <code>weightedMedian()</code> function in <strong>matrixStats</strong>, and midpoint values for the house value classes. Counts of houses by value class were punched to check the published census values, which can be replicated using <code>weightedMedian()</code> at the tract level. Here we find two output zones with calculated weighted medians over the upper census question limit of USD 50,000, and remove them subsequently as they also are affected by not knowing the appropriate value to insert for the top class by value. This is a case of spatially extensive aggregation, for which the summation of counts is appropriate:</p>
<div class="sourceCode" id="cb642"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb642-1" title="1">nms &lt;-<span class="st"> </span><span class="kw">names</span>(boston_<span class="dv">506</span>)</a>
<a class="sourceLine" id="cb642-2" title="2">ccounts &lt;-<span class="st"> </span><span class="dv">23</span><span class="op">:</span><span class="dv">31</span></a>
<a class="sourceLine" id="cb642-3" title="3"><span class="cf">for</span> (nm <span class="cf">in</span> nms[<span class="kw">c</span>(<span class="dv">22</span>, ccounts, <span class="dv">36</span>)]) {</a>
<a class="sourceLine" id="cb642-4" title="4">  boston_<span class="dv">96</span>[[nm]] &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span>[[nm]], agg_<span class="dv">96</span>, sum)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb642-5" title="5">}</a>
<a class="sourceLine" id="cb642-6" title="6">br2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">3.50</span>, <span class="fl">6.25</span>, <span class="fl">8.75</span>, <span class="fl">12.50</span>, <span class="fl">17.50</span>, <span class="fl">22.50</span>, <span class="fl">30.00</span>, <span class="fl">42.50</span>, <span class="fl">60.00</span>)<span class="op">*</span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb642-7" title="7">counts &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(boston_<span class="dv">96</span>)[, nms[ccounts]]</a>
<a class="sourceLine" id="cb642-8" title="8">f &lt;-<span class="st"> </span><span class="cf">function</span>(x) matrixStats<span class="op">::</span><span class="kw">weightedMedian</span>(<span class="dt">x =</span> br2, <span class="dt">w =</span> x, <span class="dt">interpolate =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb642-9" title="9">boston_<span class="dv">96</span><span class="op">$</span>median &lt;-<span class="st"> </span><span class="kw">apply</span>(counts, <span class="dv">1</span>, f)</a>
<a class="sourceLine" id="cb642-10" title="10"><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median) &lt;-<span class="st"> </span>boston_<span class="dv">96</span><span class="op">$</span>median <span class="op">&gt;</span><span class="st"> </span><span class="dv">50000</span></a>
<a class="sourceLine" id="cb642-11" title="11"><span class="kw">summary</span>(boston_<span class="dv">96</span><span class="op">$</span>median)</a></code></pre></div>
<pre><code>#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA&#39;s 
#    9009   20417   23523   25263   30073   49496       2</code></pre>
<p>Before subsetting, we aggregate the remaining covariates by weighted mean using the tract population counts punched from the census <span class="citation">(R. Bivand <a href="#ref-bivand17">2017</a>)</span>; these are spatially intensive variables, not count data.</p>
<div class="sourceCode" id="cb644"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb644-1" title="1">boston_<span class="dv">94</span> &lt;-<span class="st"> </span>boston_<span class="dv">96</span>[<span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median),]</a>
<a class="sourceLine" id="cb644-2" title="2">nb_q_<span class="dv">94</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">subset.nb</span>(nb_q_<span class="dv">96</span>, <span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median))</a>
<a class="sourceLine" id="cb644-3" title="3">lw_q_<span class="dv">94</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">94</span>, <span class="dt">style=</span><span class="st">&quot;W&quot;</span>)</a></code></pre></div>
<p>We now have two data sets at each level, at the lower, census tract level, and at the upper, air pollution model output zone level, one including the censored observations, the other excluding them.</p>
<div class="sourceCode" id="cb645"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb645-1" title="1">boston_94a &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">489</span>[,<span class="st">&quot;NOX_ID&quot;</span>], <span class="kw">list</span>(boston_<span class="dv">489</span><span class="op">$</span>NOX_ID), unique)</a>
<a class="sourceLine" id="cb645-2" title="2">nb_q_94a &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_94a)</a>
<a class="sourceLine" id="cb645-3" title="3">NOX_ID_no_neighs &lt;-<span class="st"> </span>boston_94a<span class="op">$</span>NOX_ID[<span class="kw">which</span>(spdep<span class="op">::</span><span class="kw">card</span>(nb_q_94a) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)]</a>
<a class="sourceLine" id="cb645-4" title="4">boston_<span class="dv">487</span> &lt;-<span class="st"> </span>boston_<span class="dv">489</span>[<span class="kw">is.na</span>(<span class="kw">match</span>(boston_<span class="dv">489</span><span class="op">$</span>NOX_ID, NOX_ID_no_neighs)),]</a>
<a class="sourceLine" id="cb645-5" title="5">boston_<span class="dv">93</span> &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">487</span>[, <span class="st">&quot;NOX_ID&quot;</span>], <span class="kw">list</span>(<span class="dt">ids =</span> boston_<span class="dv">487</span><span class="op">$</span>NOX_ID), unique)</a>
<a class="sourceLine" id="cb645-6" title="6"><span class="kw">row.names</span>(boston_<span class="dv">93</span>) &lt;-<span class="st"> </span><span class="kw">as.character</span>(boston_<span class="dv">93</span><span class="op">$</span>NOX_ID)</a>
<a class="sourceLine" id="cb645-7" title="7">nb_q_<span class="dv">93</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">93</span>, <span class="dt">row.names=</span><span class="kw">unique</span>(<span class="kw">as.character</span>(boston_<span class="dv">93</span><span class="op">$</span>NOX_ID)))</a></code></pre></div>
<p>The original model related the log of median house values by tract to the square of NOX values, including other covariates usually related to house value by tract, such as aggregate room counts, aggregate age, ethnicity, social status, distance to downtown and to the nearest radial road, a crime rate, and town-level variables reflecting land use (zoning, industry), taxation and education <span class="citation">(R. Bivand <a href="#ref-bivand17">2017</a>)</span>. This structure will be used here to exercise issues raised in fitting spatial regression models, including the presence of multiple levels.</p>
</div>
</div>
<div id="multilevel-models-of-the-boston-data-set" class="section level2">
<h2><span class="header-section-number">16.2</span> Multilevel models of the Boston data set</h2>
<p>The ZN, INDUS, NOX, RAD, TAX and PTRATIO variables show effectively no variability within the TASSIM zones, so in a multilevel model the random effect may absorb their influence.</p>
<div class="sourceCode" id="cb646"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb646-1" title="1">form &lt;-<span class="st"> </span><span class="kw">formula</span>(<span class="kw">log</span>(median) <span class="op">~</span><span class="st"> </span>CRIM <span class="op">+</span><span class="st"> </span>ZN <span class="op">+</span><span class="st"> </span>INDUS <span class="op">+</span><span class="st"> </span>CHAS <span class="op">+</span><span class="st"> </span><span class="kw">I</span>((NOX<span class="op">*</span><span class="dv">10</span>)<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(RM<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb646-2" title="2"><span class="st">                  </span>AGE <span class="op">+</span><span class="st"> </span><span class="kw">log</span>(DIS) <span class="op">+</span><span class="st"> </span><span class="kw">log</span>(RAD) <span class="op">+</span><span class="st"> </span>TAX <span class="op">+</span><span class="st"> </span>PTRATIO <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(BB<span class="op">/</span><span class="dv">100</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb646-3" title="3"><span class="st">                  </span><span class="kw">log</span>(<span class="kw">I</span>(LSTAT<span class="op">/</span><span class="dv">100</span>)))</a></code></pre></div>
<div id="iid-random-effects-with-lme4" class="section level3">
<h3><span class="header-section-number">16.2.1</span> IID random effects with lme4</h3>
<p>The <strong>lme4</strong> package <span class="citation">(D. Bates et al. <a href="#ref-R-lme4">2021</a>)</span> lets us add an independent and identically distributed (IID) unstructured random effect at the model output zone level by updating the model formula with a random effects term:</p>
<div class="sourceCode" id="cb647"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb647-1" title="1"><span class="kw">library</span>(Matrix)</a>
<a class="sourceLine" id="cb647-2" title="2"><span class="kw">library</span>(lme4)</a>
<a class="sourceLine" id="cb647-3" title="3">MLM &lt;-<span class="st"> </span><span class="kw">lmer</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>NOX_ID)), <span class="dt">data =</span> boston_<span class="dv">487</span>, <span class="dt">REML =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p>Copying the random effect into the <code>"sf"</code> object for mapping is performed below.</p>
<div class="sourceCode" id="cb648"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb648-1" title="1">boston_<span class="dv">93</span><span class="op">$</span>MLM_re &lt;-<span class="st"> </span><span class="kw">ranef</span>(MLM)[[<span class="dv">1</span>]][,<span class="dv">1</span>]</a></code></pre></div>
</div>
<div id="iid-and-car-random-effects-with-hglm" class="section level3">
<h3><span class="header-section-number">16.2.2</span> IID and CAR random effects with hglm</h3>
<p>The same model may be estimated using the <strong>hglm</strong> package <span class="citation">(Alam, Ronnegard, and Shen <a href="#ref-R-hglm">2019</a>)</span>, which also permits the modelling of discrete responses, this time using an extra one-sided formula to express the random effects term:</p>
<div class="sourceCode" id="cb649"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb649-1" title="1"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(hglm))</a>
<a class="sourceLine" id="cb649-2" title="2"><span class="kw">suppressWarnings</span>(HGLM_iid &lt;-<span class="st"> </span><span class="kw">hglm</span>(<span class="dt">fixed =</span> form, <span class="dt">random =</span> <span class="op">~</span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>NOX_ID, <span class="dt">data =</span> boston_<span class="dv">487</span>,</a>
<a class="sourceLine" id="cb649-3" title="3">    <span class="dt">family =</span> <span class="kw">gaussian</span>()))</a>
<a class="sourceLine" id="cb649-4" title="4">boston_<span class="dv">93</span><span class="op">$</span>HGLM_re &lt;-<span class="st"> </span><span class="kw">unname</span>(HGLM_iid<span class="op">$</span>ranef)</a></code></pre></div>
<p>The same package has been extended to spatially structured SAR and CAR random effects, for which a sparse spatial weights matrix is required <span class="citation">(Alam, Rnnegrd, and Shen <a href="#ref-alam-ronnegard-shen:2015">2015</a>)</span>; we choose binary spatial weights:</p>
<div class="sourceCode" id="cb650"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb650-1" title="1">W &lt;-<span class="st"> </span><span class="kw">as</span>(spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">93</span>, <span class="dt">style =</span> <span class="st">&quot;B&quot;</span>), <span class="st">&quot;CsparseMatrix&quot;</span>)</a></code></pre></div>
<p>We fit a CAR model at the upper level, using the <code>rand.family=</code> argument, where the values of the indexing variable <code>NOX_ID</code> match the row names of <span class="math inline">\(W\)</span>:</p>
<div class="sourceCode" id="cb651"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb651-1" title="1"><span class="kw">suppressWarnings</span>(HGLM_car &lt;-<span class="st"> </span><span class="kw">hglm</span>(<span class="dt">fixed =</span> form, <span class="dt">random =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>NOX_ID, <span class="dt">data =</span> boston_<span class="dv">487</span>,</a>
<a class="sourceLine" id="cb651-2" title="2">    <span class="dt">family =</span> <span class="kw">gaussian</span>(), <span class="dt">rand.family =</span> <span class="kw">CAR</span>(<span class="dt">D=</span>W)))</a>
<a class="sourceLine" id="cb651-3" title="3">boston_<span class="dv">93</span><span class="op">$</span>HGLM_ss &lt;-<span class="st"> </span>HGLM_car<span class="op">$</span>ranef[,<span class="dv">1</span>]</a></code></pre></div>
</div>
<div id="sar-random-effects-with-hsar" class="section level3">
<h3><span class="header-section-number">16.2.3</span> SAR random effects with HSAR</h3>
<p>The <strong>HSAR</strong> package <span class="citation">(Dong, Harris, and Mimis <a href="#ref-R-HSAR">2020</a>)</span> is restricted to the Gaussian response case <span class="citation">(G. Dong and Harris <a href="#ref-dong15">2015</a>; G. Dong et al. <a href="#ref-dongetal15">2015</a>)</span>, and requires the specification of a sparse design matrix mapping the upper level entities onto lower level entities:</p>
<div class="sourceCode" id="cb652"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb652-1" title="1"><span class="kw">library</span>(HSAR)</a>
<a class="sourceLine" id="cb652-2" title="2"><span class="kw">library</span>(MatrixModels, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb652-3" title="3">Z &lt;-<span class="st"> </span><span class="kw">as</span>(<span class="kw">model.Matrix</span>(<span class="op">~</span><span class="st"> </span><span class="dv">-1</span> <span class="op">+</span><span class="st"> </span><span class="kw">as.factor</span>(NOX_ID), <span class="dt">data =</span> boston_<span class="dv">487</span>, <span class="dt">sparse =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb652-4" title="4">    <span class="st">&quot;dgCMatrix&quot;</span>)</a></code></pre></div>
<p><code>hsar()</code> fits an upper level SAR random effect using MCMC; if <code>W=</code> is a lower level weights matrix rather than <code>NULL</code>, it will also fit a lower level spatial econometrics-style spatial lag model, adding the lower level spatially lagged response to the model:</p>
<div class="sourceCode" id="cb653"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb653-1" title="1"><span class="kw">set.seed</span>(<span class="dv">123</span>)</a>
<a class="sourceLine" id="cb653-2" title="2"><span class="kw">suppressWarnings</span>(HSAR_ss &lt;-<span class="st"> </span><span class="kw">hsar</span>(form, <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">W =</span> <span class="ot">NULL</span>, <span class="dt">M =</span> W, <span class="dt">Delta =</span> Z, </a>
<a class="sourceLine" id="cb653-3" title="3">                              <span class="dt">burnin =</span> <span class="dv">2000</span>, <span class="dt">Nsim =</span> <span class="dv">12000</span>, <span class="dt">thinning =</span> <span class="dv">2</span>))</a></code></pre></div>
<div class="sourceCode" id="cb654"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb654-1" title="1">boston_<span class="dv">93</span><span class="op">$</span>HSAR_ss &lt;-<span class="st"> </span>HSAR_ss<span class="op">$</span>Mus[<span class="dv">1</span>,]</a></code></pre></div>
</div>
<div id="iid-and-icar-random-effects-with-r2bayesx" class="section level3">
<h3><span class="header-section-number">16.2.4</span> IID and ICAR random effects with R2BayesX</h3>
<p>The <strong>R2BayesX</strong> package <span class="citation">(Umlauf et al. <a href="#ref-R-R2BayesX">2017</a>)</span> provides flexible support for structured additive regression models, including spatial multilevel models. The models include an IID unstructured random effect at the upper level using the <code>"re"</code> specification in the <code>sx()</code> model term <span class="citation">(Umlauf et al. <a href="#ref-umlaufetal:15">2015</a>)</span>; we choose the <code>"MCMC"</code> method:</p>
<div class="sourceCode" id="cb655"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb655-1" title="1"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(R2BayesX))</a></code></pre></div>
<div class="sourceCode" id="cb656"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb656-1" title="1">BX_iid &lt;-<span class="st"> </span><span class="kw">bayesx</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">sx</span>(NOX_ID, <span class="dt">bs =</span> <span class="st">&quot;re&quot;</span>)), <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>,</a>
<a class="sourceLine" id="cb656-2" title="2">    <span class="dt">data =</span> boston_<span class="dv">487</span>, <span class="dt">method =</span> <span class="st">&quot;MCMC&quot;</span>, <span class="dt">iterations =</span> <span class="dv">12000</span>, <span class="dt">burnin =</span> <span class="dv">2000</span>, <span class="dt">step =</span> <span class="dv">2</span>, <span class="dt">seed =</span> <span class="dv">123</span>)</a></code></pre></div>
<div class="sourceCode" id="cb657"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb657-1" title="1">boston_<span class="dv">93</span><span class="op">$</span>BX_re &lt;-<span class="st"> </span>BX_iid<span class="op">$</span>effects[<span class="st">&quot;sx(NOX_ID):re&quot;</span>][[<span class="dv">1</span>]]<span class="op">$</span>Mean</a></code></pre></div>
<p>and the <code>"mrf"</code> (Markov Random Field) spatially structured intrinsic CAR random effect specification based on a graph derived from converting a suitable <code>"nb"</code> object for the upper level. The <code>"region.id"</code> attribute of the <code>"nb"</code> object needs to contain values corresponding to the indexing variable in the <code>sx()</code> effects term, to facilitate the internal construction of design matrix <span class="math inline">\(Z\)</span>:</p>
<div class="sourceCode" id="cb658"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb658-1" title="1">RBX_gra &lt;-<span class="st"> </span><span class="kw">nb2gra</span>(nb_q_<span class="dv">93</span>)</a>
<a class="sourceLine" id="cb658-2" title="2"><span class="kw">all.equal</span>(<span class="kw">row.names</span>(RBX_gra), <span class="kw">attr</span>(nb_q_<span class="dv">93</span>, <span class="st">&quot;region.id&quot;</span>))</a></code></pre></div>
<pre><code># [1] TRUE</code></pre>
<p>As we saw above in the intrinsic CAR model definition, the counts of neighbours are entered on the diagonal, but the current implementation uses a dense, not sparse, matrix:</p>
<div class="sourceCode" id="cb660"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb660-1" title="1"><span class="kw">all.equal</span>(<span class="kw">unname</span>(<span class="kw">diag</span>(RBX_gra)), spdep<span class="op">::</span><span class="kw">card</span>(nb_q_<span class="dv">93</span>))</a></code></pre></div>
<pre><code># [1] TRUE</code></pre>
<p>The <code>sx()</code> model term continues to include the indexing variable, and now passes through the intrinsic CAR precision matrix:</p>
<div class="sourceCode" id="cb662"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb662-1" title="1">BX_mrf &lt;-<span class="st"> </span><span class="kw">bayesx</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">sx</span>(NOX_ID, <span class="dt">bs =</span> <span class="st">&quot;mrf&quot;</span>, <span class="dt">map =</span> RBX_gra)), </a>
<a class="sourceLine" id="cb662-2" title="2">                 <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">data =</span> boston_<span class="dv">487</span>, <span class="dt">method =</span> <span class="st">&quot;MCMC&quot;</span>, </a>
<a class="sourceLine" id="cb662-3" title="3">                 <span class="dt">iterations =</span> <span class="dv">12000</span>, <span class="dt">burnin =</span> <span class="dv">2000</span>, <span class="dt">step =</span> <span class="dv">2</span>, <span class="dt">seed =</span> <span class="dv">123</span>)</a></code></pre></div>
<div class="sourceCode" id="cb663"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb663-1" title="1">boston_<span class="dv">93</span><span class="op">$</span>BX_ss &lt;-<span class="st"> </span>BX_mrf<span class="op">$</span>effects[<span class="st">&quot;sx(NOX_ID):mrf&quot;</span>][[<span class="dv">1</span>]]<span class="op">$</span>Mean</a></code></pre></div>
</div>
<div id="iid-icar-and-leroux-random-effects-with-inla" class="section level3">
<h3><span class="header-section-number">16.2.5</span> IID, ICAR and Leroux random effects with INLA</h3>
<p><span class="citation">R. Bivand, Gmez-Rubio, and Rue (<a href="#ref-JSSv063i20">2015</a>)</span> and <span class="citation">V. Gmez-Rubio (<a href="#ref-gmez2020bayesian">2020</a>)</span> present the use of the <strong>INLA</strong> package <span class="citation">(Rue et al. <a href="#ref-R-INLA">2021</a>)</span> and the <code>inla()</code> model fitting function with spatial regression models:</p>
<div class="sourceCode" id="cb664"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb664-1" title="1"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(INLA))</a></code></pre></div>
<p>Although differing in details, the approach by updating the fixed model formula with an unstructured random effects term is very similar to that seen above:</p>
<div class="sourceCode" id="cb665"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb665-1" title="1">INLA_iid &lt;-<span class="st"> </span><span class="kw">inla</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(NOX_ID, <span class="dt">model =</span> <span class="st">&quot;iid&quot;</span>)), <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>, </a>
<a class="sourceLine" id="cb665-2" title="2">    <span class="dt">data =</span> boston_<span class="dv">487</span>)</a></code></pre></div>
<div class="sourceCode" id="cb666"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb666-1" title="1">boston_<span class="dv">93</span><span class="op">$</span>INLA_re &lt;-<span class="st"> </span>INLA_iid<span class="op">$</span>summary.random<span class="op">$</span>NOX_ID<span class="op">$</span>mean</a></code></pre></div>
<p>As with most implementations, care is needed to match the indexing variable with the spatial weights; in this case using indices <span class="math inline">\(1, \dots, 93\)</span> rather than the <code>NOX_ID</code> variable directly:</p>
<div class="sourceCode" id="cb667"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb667-1" title="1">ID2 &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">as.factor</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID))</a></code></pre></div>
<p>The same sparse binary spatial weights matrix is used, and the intrinsic CAR representation is constructed internally:</p>
<div class="sourceCode" id="cb668"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb668-1" title="1">INLA_ss &lt;-<span class="st"> </span><span class="kw">inla</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(ID2, <span class="dt">model =</span> <span class="st">&quot;besag&quot;</span>, <span class="dt">graph =</span> W)), <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>,</a>
<a class="sourceLine" id="cb668-2" title="2">    <span class="dt">data =</span> boston_<span class="dv">487</span>)</a></code></pre></div>
<div class="sourceCode" id="cb669"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb669-1" title="1">boston_<span class="dv">93</span><span class="op">$</span>INLA_ss &lt;-<span class="st"> </span>INLA_ss<span class="op">$</span>summary.random<span class="op">$</span>ID2<span class="op">$</span>mean</a></code></pre></div>
<p>The sparse Leroux representation as given by <span class="citation">V. Gmez-Rubio (<a href="#ref-gmez2020bayesian">2020</a>)</span> can be constructed in the following way:</p>
<div class="sourceCode" id="cb670"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb670-1" title="1">M &lt;-<span class="st"> </span><span class="kw">Diagonal</span>(<span class="kw">nrow</span>(W), <span class="kw">rowSums</span>(W)) <span class="op">-</span><span class="st"> </span>W</a>
<a class="sourceLine" id="cb670-2" title="2">Cmatrix &lt;-<span class="st"> </span><span class="kw">Diagonal</span>(<span class="kw">nrow</span>(M), <span class="dv">1</span>) <span class="op">-</span><span class="st">  </span>M</a></code></pre></div>
<p>This model can be estimated using the <code>"generic1"</code> model with the specified precision matrix:</p>
<div class="sourceCode" id="cb671"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb671-1" title="1">INLA_lr &lt;-<span class="st"> </span><span class="kw">inla</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(ID2, <span class="dt">model =</span> <span class="st">&quot;generic1&quot;</span>, <span class="dt">Cmatrix =</span> Cmatrix)),</a>
<a class="sourceLine" id="cb671-2" title="2">    <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">data =</span> boston_<span class="dv">487</span>)</a></code></pre></div>
<div class="sourceCode" id="cb672"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb672-1" title="1">boston_<span class="dv">93</span><span class="op">$</span>INLA_lr &lt;-<span class="st"> </span>INLA_lr<span class="op">$</span>summary.random<span class="op">$</span>ID2<span class="op">$</span>mean</a></code></pre></div>
</div>
<div id="icar-random-effects-with-mgcvgam" class="section level3">
<h3><span class="header-section-number">16.2.6</span> ICAR random effects with mgcv::gam()</h3>
<p>In a very similar way, the <code>gam()</code> function in the <strong>mgcv</strong> package <span class="citation">(Wood <a href="#ref-R-mgcv">2021</a>)</span> can take an <code>"mrf"</code> term using a suitable <code>"nb"</code> object for the upper level. In this case the <code>"nb"</code> object needs to have the contents of the <code>"region.id"</code> attribute copied as the names of the neighbour list components, and the indexing variable needs to be a factor <span class="citation">(Wood <a href="#ref-wood:17">2017</a>)</span>:</p>
<div class="sourceCode" id="cb673"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb673-1" title="1"><span class="kw">library</span>(mgcv)</a>
<a class="sourceLine" id="cb673-2" title="2"><span class="kw">names</span>(nb_q_<span class="dv">93</span>) &lt;-<span class="st"> </span><span class="kw">attr</span>(nb_q_<span class="dv">93</span>, <span class="st">&quot;region.id&quot;</span>)</a>
<a class="sourceLine" id="cb673-3" title="3">boston_<span class="dv">487</span><span class="op">$</span>NOX_ID &lt;-<span class="st"> </span><span class="kw">as.factor</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID)</a></code></pre></div>
<p>The specification of the spatially structured term again differs in details from those above, but achieves the same purpose. The <code>"REML"</code> method of <code>bayesx()</code> gives the same results as <code>gam()</code> using <code>"REML"</code> in this case:</p>
<div class="sourceCode" id="cb674"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb674-1" title="1">GAM_MRF &lt;-<span class="st"> </span><span class="kw">gam</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(NOX_ID, <span class="dt">bs =</span> <span class="st">&quot;mrf&quot;</span>, <span class="dt">xt =</span> <span class="kw">list</span>(<span class="dt">nb =</span> nb_q_<span class="dv">93</span>))),</a>
<a class="sourceLine" id="cb674-2" title="2">               <span class="dt">data =</span> boston_<span class="dv">487</span>, <span class="dt">method =</span> <span class="st">&quot;REML&quot;</span>)</a></code></pre></div>
<p>The upper level random effects may be extracted by predicting terms; as we can see, the values in all lower-level tracts belonging to the same upper-level air pollution model output zones are identical:</p>
<div class="sourceCode" id="cb675"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb675-1" title="1">ssre &lt;-<span class="st"> </span><span class="kw">predict</span>(GAM_MRF, <span class="dt">type =</span> <span class="st">&quot;terms&quot;</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>)[, <span class="st">&quot;s(NOX_ID)&quot;</span>]</a>
<a class="sourceLine" id="cb675-2" title="2"><span class="kw">all</span>(<span class="kw">sapply</span>(<span class="kw">tapply</span>(ssre, <span class="kw">list</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID), c), <span class="cf">function</span>(x) <span class="kw">length</span>(<span class="kw">unique</span>(x)) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))</a></code></pre></div>
<pre><code># [1] TRUE</code></pre>
<p>so we can return the first value for each upper-level unit:</p>
<div class="sourceCode" id="cb677"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb677-1" title="1">boston_<span class="dv">93</span><span class="op">$</span>GAM_ss &lt;-<span class="st"> </span><span class="kw">aggregate</span>(ssre, <span class="kw">list</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID), head, <span class="dt">n=</span><span class="dv">1</span>)<span class="op">$</span>x</a></code></pre></div>
</div>
<div id="upper-level-random-effects-summary" class="section level3">
<h3><span class="header-section-number">16.2.7</span> Upper level random effects: summary</h3>
<p>In the cases of <code>hglm()</code>, <code>bayesx()</code>, <code>inla()</code> and <code>gam()</code>, we could also model discrete responses without further major difficulty, and <code>bayesx()</code>, <code>inla()</code> and <code>gam()</code> also facilitate the generalization of functional form fitting for included covariates.</p>
<p>Unfortunately, the coefficient estimates for the air pollution variable for these multilevel models are not helpful. All are negative as expected, but the inclusion of the model output zone level effects, IID or spatially structured, makes it is hard to disentangle the influence of the scale of observation from that of covariates observed at that scale rather than at the tract level.</p>
<p>Figure <a href="spatglmm.html#fig:multi-levelmaps1">16.1</a> shows that the air pollution model output zone level IID random effects are very similar across the four model fitting functions reported. In all the maps, the central downtown zones have stronger negative random effect values, but strong positive values are also found in close proximity; suburban areas take values closer to zero.</p>

<div class="sourceCode" id="cb678"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb678-1" title="1"><span class="kw">library</span>(tmap, <span class="dt">warn.conflicts=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb678-2" title="2"><span class="kw">tm_shape</span>(boston_<span class="dv">93</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;MLM_re&quot;</span>, <span class="st">&quot;HGLM_re&quot;</span>, <span class="st">&quot;INLA_re&quot;</span>, <span class="st">&quot;BX_re&quot;</span>), <span class="dt">midpoint =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb678-3" title="3">    <span class="dt">title =</span> <span class="st">&quot;IID&quot;</span>)  <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales =</span> <span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_borders</span>(<span class="dt">lwd =</span> <span class="fl">0.3</span>, <span class="dt">alpha =</span> <span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb678-4" title="4"><span class="st">    </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels =</span> <span class="kw">c</span>(<span class="st">&quot;lmer&quot;</span>, <span class="st">&quot;hglm&quot;</span>, <span class="st">&quot;inla&quot;</span>, <span class="st">&quot;bayesx&quot;</span>))</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:multi-levelmaps1"></span>
<img src="sds_files/figure-html/multi-levelmaps1-1.png" alt="Air pollution model output zone level IID random effects estimated using lme4, hglm, INLA and R2BayesX; the range of the response, log(median) is 2.1893." width="100%" />
<p class="caption">
Figure 16.1: Air pollution model output zone level IID random effects estimated using <strong>lme4</strong>, <strong>hglm</strong>, <strong>INLA</strong> and <strong>R2BayesX</strong>; the range of the response, <code>log(median)</code> is 2.1893.
</p>
</div>
<p>Figure <a href="spatglmm.html#fig:multi-levelmaps2">16.2</a> shows that the spatially structured random effects are also very similar to each other, with the <code>"SAR"</code> spatial smooth being perhaps a little smoother than the <code>"CAR"</code> smooths when considering the range of values taken by the random effect term.</p>

<div class="sourceCode" id="cb679"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb679-1" title="1"><span class="kw">tm_shape</span>(boston_<span class="dv">93</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;HGLM_ss&quot;</span>, <span class="st">&quot;HSAR_ss&quot;</span>, <span class="st">&quot;INLA_lr&quot;</span>, <span class="st">&quot;INLA_ss&quot;</span>, <span class="st">&quot;BX_ss&quot;</span>,</a>
<a class="sourceLine" id="cb679-2" title="2">    <span class="st">&quot;GAM_ss&quot;</span>), <span class="dt">midpoint =</span> <span class="dv">0</span>, <span class="dt">title =</span> <span class="st">&quot;SSRE&quot;</span>)  <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales =</span> <span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb679-3" title="3"><span class="st">    </span><span class="kw">tm_borders</span>(<span class="dt">lwd =</span> <span class="fl">0.3</span>, <span class="dt">alpha =</span> <span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels =</span> <span class="kw">c</span>(<span class="st">&quot;hglm CAR&quot;</span>, <span class="st">&quot;hsar SAR&quot;</span>,</a>
<a class="sourceLine" id="cb679-4" title="4">        <span class="st">&quot;inla Leroux&quot;</span>, <span class="st">&quot;inla ICAR&quot;</span>, <span class="st">&quot;bayesx ICAR&quot;</span>, <span class="st">&quot;gam ICAR&quot;</span>))</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:multi-levelmaps2"></span>
<img src="sds_files/figure-html/multi-levelmaps2-1.png" alt="Air pollution model output zone level spatially structured random effects estimated using hglm, HSAR, INLA, R2BayesX and mgcv." width="100%" />
<p class="caption">
Figure 16.2: Air pollution model output zone level spatially structured random effects estimated using <strong>hglm</strong>, <strong>HSAR</strong>, <strong>INLA</strong>, <strong>R2BayesX</strong> and <strong>mgcv</strong>.
</p>
</div>
<p>Although there is still a great need for more thorough comparative studies of model fitting functions for spatial regression including multilevel capabilities, there has been much progress over recent years. <span class="citation">Vranckx, Neyens, and Faes (<a href="#ref-VRANCKX2019100302">2019</a>)</span> offer a recent comparative survey of disease mapping spatial regression, typically set in a Poisson regression framework offset by an expected count. In <span class="citation">Roger S Bivand and Gmez-Rubio (<a href="#ref-doi:10.1177/1471082X20967158">2021</a>)</span>, methods for estimating spatial survival models using spatial weights matrices are compared with spatial probit models.</p>
</div>
</div>
<div id="exercises-14" class="section level2">
<h2><span class="header-section-number">16.3</span> Exercises</h2>
<ol style="list-style-type: decimal">
<li>Construct a multilevel dataset using the Athens housing data in <strong>HSAR</strong>, as in the vignette: <a href="https://cran.r-project.org/web/packages/HSAR/vignettes/PropertiesAthens.html" class="uri">https://cran.r-project.org/web/packages/HSAR/vignettes/PropertiesAthens.html</a>. At which point do the municipality department attribute values get copied out to all the point observations within each municipality department?</li>
<li>Create neighbour objects at both levels. Test <code>greensp</code> for spatial autocorrelation at the upper level, and then at the lower level. What has been the chief consequence of copying out the area of green spaces in square meters for the municipality departments to the point support property level?</li>
<li>Using the formula object from the vignette, assess whether adding the copied out upper level variables seems sensible. Use <code>mgcv::gam()</code> to fit a linear mixed effects model (IID of <code>num_dep</code> identifying the municipality departments) using just the lower level variables and the lower and upper level variables. Do your conclusions differ?</li>
<li>Complete the analysis by replacing the IID random effects with an <code>"mrf"</code> Markov random field and the contiguity neighbour object created above. Do you think that it is reasonable to for example draw any conclusions based on the municipality department level variables such as <code>greensp</code>?</li>
</ol>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-R-hglm">
<p>Alam, Moudud, Lars Ronnegard, and Xia Shen. 2019. <em>Hglm: Hierarchical Generalized Linear Models</em>. <a href="https://CRAN.R-project.org/package=hglm">https://CRAN.R-project.org/package=hglm</a>.</p>
</div>
<div id="ref-alam-ronnegard-shen:2015">
<p>Alam, Moudud, Lars Rnnegrd, and Xia Shen. 2015. Fitting Conditional and Simultaneous Autoregressive Spatial Models in Hglm. <em>The R Journal</em> 7 (2): 518. <a href="https://doi.org/10.32614/RJ-2015-017">https://doi.org/10.32614/RJ-2015-017</a>.</p>
</div>
<div id="ref-R-lme4">
<p>Bates, Douglas, Martin Maechler, Ben Bolker, and Steven Walker. 2021. <em>Lme4: Linear Mixed-Effects Models Using Eigen and S4</em>. <a href="https://github.com/lme4/lme4/">https://github.com/lme4/lme4/</a>.</p>
</div>
<div id="ref-besag:74">
<p>Besag, Julian. 1974. Spatial Interaction and the Statistical Analysis of Lattice Systems. <em>Journal of the Royal Statistical Society. Series B (Methodological)</em> 36: pp. 192236.</p>
</div>
<div id="ref-bivand17">
<p>Bivand, Roger. 2017. Revisiting the Boston Data Set  Changing the Units of Observation Affects Estimated Willingness to Pay for Clean Air. <em>REGION</em> 4 (1): 10927. <a href="https://doi.org/10.18335/region.v4i1.107">https://doi.org/10.18335/region.v4i1.107</a>.</p>
</div>
<div id="ref-JSSv063i20">
<p>Bivand, Roger, Virgilio Gmez-Rubio, and Hvard Rue. 2015. Spatial Data Analysis with R-Inla with Some Extensions. <em>Journal of Statistical Software, Articles</em> 63 (20): 131. <a href="https://doi.org/10.18637/jss.v063.i20">https://doi.org/10.18637/jss.v063.i20</a>.</p>
</div>
<div id="ref-R-spData">
<p>Bivand, Roger, Jakub Nowosad, and Robin Lovelace. 2021. <em>SpData: Datasets for Spatial Analysis</em>. <a href="https://nowosad.github.io/spData/">https://nowosad.github.io/spData/</a>.</p>
</div>
<div id="ref-doi:10.1177/1471082X20967158">
<p>Bivand, Roger S, and Virgilio Gmez-Rubio. 2021. Spatial Survival Modelling of Business Re-Opening After Katrina: Survival Modelling Compared to Spatial Probit Modelling of Re-Opening Within 3, 6 or 12 Months. <em>Statistical Modelling</em> 21 (1-2): 13760. <a href="https://doi.org/10.1177/1471082X20967158">https://doi.org/10.1177/1471082X20967158</a>.</p>
</div>
<div id="ref-bivandetal17a">
<p>Bivand, Roger S., Zhe Sha, Liv Osland, and Ingrid Sandvig Thorsen. 2017. A Comparison of Estimation Methods for Multilevel Models of Spatially Structured Data. <em>Spatial Statistics</em>. <a href="https://doi.org/10.1016/j.spasta.2017.01.002">https://doi.org/10.1016/j.spasta.2017.01.002</a>.</p>
</div>
<div id="ref-brookesetal:17">
<p>Brooks, Mollie E., Kasper Kristensen, Koen J. van Benthem, Arni Magnusson, Casper W. Berg, Anders Nielsen, Hans J. Skaug, Martin Maechler, and Benjamin M. Bolker. 2017. glmmTMB Balances Speed and Flexibility Among Packages for Zero-Inflated Generalized Linear Mixed Modeling. <em>The R Journal</em> 9 (2): 378400. <a href="https://journal.r-project.org/archive/2017/RJ-2017-066/index.html">https://journal.r-project.org/archive/2017/RJ-2017-066/index.html</a>.</p>
</div>
<div id="ref-cliff+ord:73">
<p>Cliff, A. D., and J. K. Ord. 1973. <em>Spatial Autocorrelation</em>. London: Pion.</p>
</div>
<div id="ref-CliffOrd:72">
<p>Cliff, A., and J.K. Ord. 1972. Testing for Spatial Autocorrelation Among Regression Residuals. <em>Geographical Analysis</em> 4: 26784.</p>
</div>
<div id="ref-Cressie:1993">
<p>Cressie, N. A. C. 1993. <em>Statistics for Spatial Data</em>. New York:Wiley.</p>
</div>
<div id="ref-dong15">
<p>Dong, G., and R. Harris. 2015. Spatial Autorgressive Models for Geographically Hierarchical Data Structures. <em>Geographical Analysis</em> 47 (2): 17391.</p>
</div>
<div id="ref-dongetal15">
<p>Dong, G., R. Harris, K. Jones, and J. Yu. 2015. Multilevel Modeling with Spatial Interaction Effects with Application to an Emerging Land Market in Beijing, China. <em>PLOS One</em> 10 (6). <a href="https://doi.org/doi:10.1371/journal.pone.0130761">https://doi.org/doi:10.1371/journal.pone.0130761</a>.</p>
</div>
<div id="ref-R-HSAR">
<p>Dong, Guanpeng, Richard Harris, and Angelos Mimis. 2020. <em>HSAR: Hierarchical Spatial Autoregressive Model</em>. <a href="https://CRAN.R-project.org/package=HSAR">https://CRAN.R-project.org/package=HSAR</a>.</p>
</div>
<div id="ref-gaetan+guyon:10">
<p>Gaetan, Carlo, and Xavier Guyon. 2010. <em>Spatial Statistics and Modeling</em>. New York: Springer.</p>
</div>
<div id="ref-JSSv063c01">
<p>Gerber, Florian, and Reinhard Furrer. 2015. Pitfalls in the Implementation of Bayesian Hierarchical Modeling of Areal Count Data: An Illustration Using Bym and Leroux Models. <em>Journal of Statistical Software, Code Snippets</em> 63 (1): 132. <a href="https://doi.org/10.18637/jss.v063.c01">https://doi.org/10.18637/jss.v063.c01</a>.</p>
</div>
<div id="ref-vgr_clubuc3m:19">
<p>Gmez-Rubio, V. 2019. Spatial Data Analysis with Inla. Coding Club Uc3m Tutorial Series. Universidad Carlos Iii de Madrid. <a href="https://codingclubuc3m.rbind.io/talk/2019-11-05/">https://codingclubuc3m.rbind.io/talk/2019-11-05/</a>.</p>
</div>
<div id="ref-gmez2020bayesian">
<p>Gmez-Rubio, V. 2020. <em>Bayesian Inference with Inla</em>. Boca Raton, FL: CRC Press.</p>
</div>
<div id="ref-hepple:76">
<p>Hepple, Leslie W. 1976. A Maximum Likelihood Model for Econometric Estimation with Spatial Series. In <em>Theory and Practice in Regional Science</em>, edited by I. Masser, 90104. London Papers in Regional Science. London: Pion.</p>
</div>
<div id="ref-vanlieshout:19">
<p>Lieshout, M. N. M. van. 2019. <em>Theory of Spatial Statistics</em>. Boca Raton, FL: Chapman; Hall/CRC.</p>
</div>
<div id="ref-mcculloch+searle:2001">
<p>McCulloch, Charles E., and Shayle R. Searle. 2001. <em>Generalized, Linear, and Mixed Models</em>. New York: Wiley.</p>
</div>
<div id="ref-ord:75">
<p>Ord, J. K. 1975. Estimation Methods for Models of Spatial Interaction. <em>Journal of the American Statistical Association</em> 70 (349): 12026.</p>
</div>
<div id="ref-R:Pinheiro+Bates:2000">
<p>Pinheiro, Jose C., and Douglas M. Bates. 2000. <em>Mixed-Effects Models in S and S-Plus</em>. New York: Springer.</p>
</div>
<div id="ref-ripley:81">
<p>Ripley, B. D. 1981. <em>Spatial Statistics</em>. New York: Wiley.</p>
</div>
<div id="ref-ripley:88">
<p>Ripley, B. 1988. <em>Statistical Inference for Spatial Processes</em>. Cambridge: Cambridge University Press.</p>
</div>
<div id="ref-R-INLA">
<p>Rue, Havard, Finn Lindgren, Daniel Simpson, Sara Martino, Elias Teixeira Krainski, Haakon Bakka, Andrea Riebler, and Geir-Arne Fuglstad. 2021. <em>INLA: Full Bayesian Analysis of Latent Gaussian Models Using Integrated Nested Laplace Approximations</em>.</p>
</div>
<div id="ref-umlaufetal:15">
<p>Umlauf, Nikolaus, Daniel Adler, Thomas Kneib, Stefan Lang, and Achim Zeileis. 2015. Structured Additive Regression Models: An R Interface to BayesX. <em>Journal of Statistical Software</em> 63 (21): 146. <a href="http://www.jstatsoft.org/v63/i21/">http://www.jstatsoft.org/v63/i21/</a>.</p>
</div>
<div id="ref-R-R2BayesX">
<p>Umlauf, Nikolaus, Thomas Kneib, Stefan Lang, and Achim Zeileis. 2017. <em>R2BayesX: Estimate Structured Additive Regression Models with Bayesx</em>. <a href="https://CRAN.R-project.org/package=R2BayesX">https://CRAN.R-project.org/package=R2BayesX</a>.</p>
</div>
<div id="ref-VRANCKX2019100302">
<p>Vranckx, M., T. Neyens, and C. Faes. 2019. Comparison of Different Software Implementations for Spatial Disease Mapping. <em>Spatial and Spatio-Temporal Epidemiology</em> 31: 100302. <a href="https://doi.org/10.1016/j.sste.2019.100302">https://doi.org/10.1016/j.sste.2019.100302</a>.</p>
</div>
<div id="ref-wall:04">
<p>Wall, M. M. 2004. A Close Look at the Spatial Structure Implied by the CAR and SAR Models. <em>Journal of Statistical Planning and Inference</em> 121: 31124.</p>
</div>
<div id="ref-whittle:54">
<p>Whittle, P. 1954. On Stationary Processes in the Plane. <em>Biometrika</em> 41 (3-4): 43449. <a href="https://doi.org/10.1093/biomet/41.3-4.434">https://doi.org/10.1093/biomet/41.3-4.434</a>.</p>
</div>
<div id="ref-R-mgcv">
<p>Wood, Simon. 2021. <em>Mgcv: Mixed Gam Computation Vehicle with Automatic Smoothness Estimation</em>. <a href="https://CRAN.R-project.org/package=mgcv">https://CRAN.R-project.org/package=mgcv</a>.</p>
</div>
<div id="ref-wood:17">
<p>Wood, S.N. 2017. <em>Generalized Additive Models: An Introduction with R</em>. 2nd ed. Chapman; Hall/CRC.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="spatautocorr.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="spatecon.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/edzer/sdsr/edit/master/18-SpatialRegression.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
