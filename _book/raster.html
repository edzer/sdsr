<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Raster and vector datacubes | Spatial Data Science</title>
  <meta name="description" content="description_xx" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Raster and vector datacubes | Spatial Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="description_xx" />
  <meta name="github-repo" content="edzer/sdsr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Raster and vector datacubes | Spatial Data Science" />
  
  <meta name="twitter:description" content="description_xx" />
  

<meta name="author" content="Edzer Pebesma, Roger Bivand" />


<meta name="date" content="2020-09-02" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="geometries.html"/>
<link rel="next" href="geommanip.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.3/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.3/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="part"><span><b>I Spatial Data</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Getting Started</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-first-map"><i class="fa fa-check"></i><b>1.1</b> A first map</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#raster-and-vector-data"><i class="fa fa-check"></i><b>1.2</b> Raster and vector data</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#time-series-arrays-data-cubes"><i class="fa fa-check"></i><b>1.3</b> Time series, arrays, data cubes</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#support-attribute-geometry-relationships"><i class="fa fa-check"></i><b>1.4</b> Support, attribute-geometry relationships</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#the-spatial-data-science-software-ecosystem"><i class="fa fa-check"></i><b>1.5</b> The Spatial Data Science software ecosystem</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cs.html"><a href="cs.html"><i class="fa fa-check"></i><b>2</b> Coordinate systems</a><ul>
<li class="chapter" data-level="2.1" data-path="cs.html"><a href="cs.html#cartesian-and-geodetic-coordinates"><i class="fa fa-check"></i><b>2.1</b> Cartesian and geodetic coordinates</a></li>
<li class="chapter" data-level="2.2" data-path="cs.html"><a href="cs.html#ellipsoidal-coordinates"><i class="fa fa-check"></i><b>2.2</b> Ellipsoidal coordinates</a></li>
<li class="chapter" data-level="2.3" data-path="cs.html"><a href="cs.html#distances"><i class="fa fa-check"></i><b>2.3</b> Distances</a></li>
<li class="chapter" data-level="2.4" data-path="cs.html"><a href="cs.html#bounded-spaces"><i class="fa fa-check"></i><b>2.4</b> Bounded spaces</a></li>
<li class="chapter" data-level="2.5" data-path="cs.html"><a href="cs.html#time"><i class="fa fa-check"></i><b>2.5</b> Time</a></li>
<li class="chapter" data-level="2.6" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geometries.html"><a href="geometries.html"><i class="fa fa-check"></i><b>3</b> Geometries</a><ul>
<li class="chapter" data-level="3.1" data-path="geometries.html"><a href="geometries.html#simple-feature-geometry-types"><i class="fa fa-check"></i><b>3.1</b> Simple feature geometry types</a></li>
<li class="chapter" data-level="3.2" data-path="geometries.html"><a href="geometries.html#simple-features-in-sf"><i class="fa fa-check"></i><b>3.2</b> Simple features in <code>sf</code></a></li>
<li class="chapter" data-level="3.3" data-path="geometries.html"><a href="geometries.html#geomraster"><i class="fa fa-check"></i><b>3.3</b> Tesselations: coverages, rasters</a></li>
<li class="chapter" data-level="3.4" data-path="geometries.html"><a href="geometries.html#networks"><i class="fa fa-check"></i><b>3.4</b> Networks</a></li>
<li class="chapter" data-level="3.5" data-path="geometries.html"><a href="geometries.html#geometries-on-the-sphere"><i class="fa fa-check"></i><b>3.5</b> Geometries on the sphere</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="raster.html"><a href="raster.html"><i class="fa fa-check"></i><b>4</b> Raster and vector datacubes</a><ul>
<li class="chapter" data-level="4.1" data-path="raster.html"><a href="raster.html#package-stars"><i class="fa fa-check"></i><b>4.1</b> Package <code>stars</code></a></li>
<li class="chapter" data-level="4.2" data-path="raster.html"><a href="raster.html#raster-data"><i class="fa fa-check"></i><b>4.2</b> Raster data</a></li>
<li class="chapter" data-level="4.3" data-path="raster.html"><a href="raster.html#datacubes"><i class="fa fa-check"></i><b>4.3</b> Vector Datacubes</a></li>
<li class="chapter" data-level="4.4" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="geommanip.html"><a href="geommanip.html"><i class="fa fa-check"></i><b>5</b> Manipulating Geometries</a><ul>
<li class="chapter" data-level="5.1" data-path="geommanip.html"><a href="geommanip.html#predicates"><i class="fa fa-check"></i><b>5.1</b> Predicates</a></li>
<li class="chapter" data-level="5.2" data-path="geommanip.html"><a href="geommanip.html#measures"><i class="fa fa-check"></i><b>5.2</b> Measures</a></li>
<li class="chapter" data-level="5.3" data-path="geommanip.html"><a href="geommanip.html#geometry-generating-functions"><i class="fa fa-check"></i><b>5.3</b> Geometry generating functions</a></li>
<li class="chapter" data-level="5.4" data-path="geommanip.html"><a href="geommanip.html#precision"><i class="fa fa-check"></i><b>5.4</b> Precision</a></li>
<li class="chapter" data-level="5.5" data-path="geommanip.html"><a href="geommanip.html#invalid"><i class="fa fa-check"></i><b>5.5</b> Generating invalid geometries</a></li>
<li class="chapter" data-level="5.6" data-path="geommanip.html"><a href="geommanip.html#longlat"><i class="fa fa-check"></i><b>5.6</b> Warnings for longitude/latitude geometries</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="featureattributes.html"><a href="featureattributes.html"><i class="fa fa-check"></i><b>6</b> Feature attributes</a><ul>
<li class="chapter" data-level="6.1" data-path="featureattributes.html"><a href="featureattributes.html#agr"><i class="fa fa-check"></i><b>6.1</b> Attribute-geometry relationships</a></li>
<li class="chapter" data-level="6.2" data-path="featureattributes.html"><a href="featureattributes.html#spatial-join"><i class="fa fa-check"></i><b>6.2</b> Spatial join</a></li>
<li class="chapter" data-level="6.3" data-path="featureattributes.html"><a href="featureattributes.html#aggregate-and-summarise"><i class="fa fa-check"></i><b>6.3</b> Aggregate and summarise</a></li>
<li class="chapter" data-level="6.4" data-path="featureattributes.html"><a href="featureattributes.html#intersections"><i class="fa fa-check"></i><b>6.4</b> Intersections</a></li>
<li class="chapter" data-level="6.5" data-path="featureattributes.html"><a href="featureattributes.html#area-weighted-interpolation"><i class="fa fa-check"></i><b>6.5</b> Area-weighted interpolation</a></li>
<li class="chapter" data-level="6.6" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>6.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="rs.html"><a href="rs.html"><i class="fa fa-check"></i><b>7</b> Reference Systems</a><ul>
<li class="chapter" data-level="7.1" data-path="rs.html"><a href="rs.html#units"><i class="fa fa-check"></i><b>7.1</b> Units of measurement</a></li>
<li class="chapter" data-level="7.2" data-path="rs.html"><a href="rs.html#temporal-reference-systems"><i class="fa fa-check"></i><b>7.2</b> Temporal Reference Systems</a></li>
<li class="chapter" data-level="7.3" data-path="rs.html"><a href="rs.html#crs"><i class="fa fa-check"></i><b>7.3</b> Coordinate Reference Systems</a></li>
</ul></li>
<li class="part"><span><b>II Maps</b></span></li>
<li class="chapter" data-level="8" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>8</b> Plotting spatial data</a><ul>
<li class="chapter" data-level="8.1" data-path="plotting.html"><a href="plotting.html#transform"><i class="fa fa-check"></i><b>8.1</b> Every plot is a projection</a></li>
<li class="chapter" data-level="8.2" data-path="plotting.html"><a href="plotting.html#plotting-points-lines-polygons-grid-cells"><i class="fa fa-check"></i><b>8.2</b> Plotting points, lines, polygons, grid cells</a></li>
<li class="chapter" data-level="8.3" data-path="plotting.html"><a href="plotting.html#classintervals"><i class="fa fa-check"></i><b>8.3</b> Color palettes and class intervals</a></li>
<li class="chapter" data-level="8.4" data-path="plotting.html"><a href="plotting.html#poles-and-datelines"><i class="fa fa-check"></i><b>8.4</b> Poles and datelines</a></li>
<li class="chapter" data-level="8.5" data-path="plotting.html"><a href="plotting.html#graticule"><i class="fa fa-check"></i><b>8.5</b> Graticules and other navigation aids</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="plot.html"><a href="plot.html"><i class="fa fa-check"></i><b>9</b> Base and grid plots</a><ul>
<li class="chapter" data-level="9.1" data-path="plot.html"><a href="plot.html#base-plots"><i class="fa fa-check"></i><b>9.1</b> Base plots</a></li>
<li class="chapter" data-level="9.2" data-path="plot.html"><a href="plot.html#combining-base-plots"><i class="fa fa-check"></i><b>9.2</b> Combining base plots</a></li>
<li class="chapter" data-level="9.3" data-path="plot.html"><a href="plot.html#grid-plots-and-viewports"><i class="fa fa-check"></i><b>9.3</b> Grid plots and viewports</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="ggplot2.html"><a href="ggplot2.html"><i class="fa fa-check"></i><b>10</b> ggplot2</a><ul>
<li class="chapter" data-level="10.1" data-path="ggplot2.html"><a href="ggplot2.html#geom_sf"><i class="fa fa-check"></i><b>10.1</b> <code>geom_sf</code></a></li>
<li class="chapter" data-level="10.2" data-path="ggplot2.html"><a href="ggplot2.html#geom_stars"><i class="fa fa-check"></i><b>10.2</b> <code>geom_stars</code></a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="interactive.html"><a href="interactive.html"><i class="fa fa-check"></i><b>11</b> Interactive Maps</a></li>
<li class="part"><span><b>III Spatial Analysis</b></span></li>
<li class="chapter" data-level="12" data-path="summarizing-geometries.html"><a href="summarizing-geometries.html"><i class="fa fa-check"></i><b>12</b> Summarizing Geometries</a></li>
<li class="chapter" data-level="13" data-path="pointpatterns.html"><a href="pointpatterns.html"><i class="fa fa-check"></i><b>13</b> Point Pattern Analysis</a></li>
<li class="chapter" data-level="14" data-path="manipulating-attributes-summarise-aggregate-union-sample.html"><a href="manipulating-attributes-summarise-aggregate-union-sample.html"><i class="fa fa-check"></i><b>14</b> Manipulating attributes: summarise, aggregate, union, sample</a></li>
<li class="chapter" data-level="15" data-path="updownscaling.html"><a href="updownscaling.html"><i class="fa fa-check"></i><b>15</b> Up- and Downscaling</a></li>
<li class="chapter" data-level="16" data-path="interpolation.html"><a href="interpolation.html"><i class="fa fa-check"></i><b>16</b> Interpolation and Geostatistics</a></li>
<li class="chapter" data-level="17" data-path="area-data-and-spatial-autocorrelation.html"><a href="area-data-and-spatial-autocorrelation.html"><i class="fa fa-check"></i><b>17</b> Area Data and Spatial Autocorrelation</a><ul>
<li class="chapter" data-level="17.1" data-path="area-data-and-spatial-autocorrelation.html"><a href="area-data-and-spatial-autocorrelation.html#spatial-autocorrelation"><i class="fa fa-check"></i><b>17.1</b> Spatial autocorrelation</a></li>
<li class="chapter" data-level="17.2" data-path="area-data-and-spatial-autocorrelation.html"><a href="area-data-and-spatial-autocorrelation.html#spatial-weight-matrices"><i class="fa fa-check"></i><b>17.2</b> Spatial weight matrices</a></li>
<li class="chapter" data-level="17.3" data-path="area-data-and-spatial-autocorrelation.html"><a href="area-data-and-spatial-autocorrelation.html#measures-of-spatial-autocorrelation"><i class="fa fa-check"></i><b>17.3</b> Measures of spatial autocorrelation</a></li>
<li class="chapter" data-level="17.4" data-path="area-data-and-spatial-autocorrelation.html"><a href="area-data-and-spatial-autocorrelation.html#spatial-heterogeneity"><i class="fa fa-check"></i><b>17.4</b> Spatial heterogeneity</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="spatial-regression.html"><a href="spatial-regression.html"><i class="fa fa-check"></i><b>18</b> Spatial Regression</a><ul>
<li class="chapter" data-level="18.1" data-path="spatial-regression.html"><a href="spatial-regression.html#spatial-regression-with-spatial-weights"><i class="fa fa-check"></i><b>18.1</b> Spatial regression with spatial weights</a></li>
<li class="chapter" data-level="18.2" data-path="spatial-regression.html"><a href="spatial-regression.html#estimators"><i class="fa fa-check"></i><b>18.2</b> Estimators</a></li>
<li class="chapter" data-level="18.3" data-path="spatial-regression.html"><a href="spatial-regression.html#implementation-details"><i class="fa fa-check"></i><b>18.3</b> Implementation details</a></li>
<li class="chapter" data-level="18.4" data-path="spatial-regression.html"><a href="spatial-regression.html#markov-random-field-and-multilevel-models-with-spatial-weights"><i class="fa fa-check"></i><b>18.4</b> Markov random field and multilevel models with spatial weights</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="movement-data.html"><a href="movement-data.html"><i class="fa fa-check"></i><b>19</b> Movement data</a></li>
<li class="chapter" data-level="20" data-path="statistical-modelling-of-spatiotemporal-data.html"><a href="statistical-modelling-of-spatiotemporal-data.html"><i class="fa fa-check"></i><b>20</b> Statistical modelling of spatiotemporal data</a></li>
<li class="chapter" data-level="21" data-path="sp-and-raster.html"><a href="sp-and-raster.html"><i class="fa fa-check"></i><b>21</b> sp and raster</a><ul>
<li class="chapter" data-level="21.1" data-path="sp-and-raster.html"><a href="sp-and-raster.html#links-and-differences-between-sf-and-sp"><i class="fa fa-check"></i><b>21.1</b> links and differences between sf and sp</a></li>
<li class="chapter" data-level="21.2" data-path="sp-and-raster.html"><a href="sp-and-raster.html#migration-packages"><i class="fa fa-check"></i><b>21.2</b> migration packages</a></li>
<li class="chapter" data-level="21.3" data-path="sp-and-raster.html"><a href="sp-and-raster.html#raster-stars-and-sf"><i class="fa fa-check"></i><b>21.3</b> raster, stars and sf</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html"><i class="fa fa-check"></i>R basics</a><ul>
<li class="chapter" data-level="21.4" data-path="r-basics.html"><a href="r-basics.html#pipes"><i class="fa fa-check"></i><b>21.4</b> Pipes</a></li>
<li class="chapter" data-level="21.5" data-path="r-basics.html"><a href="r-basics.html#data-structures"><i class="fa fa-check"></i><b>21.5</b> Data structures</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="raster" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Raster and vector datacubes</h1>
<p>Array data are data where values are indexed along multiple array <em>dimensions</em>. Raster and vector datacubes refer to array data, where one or more of the dimensions refer to space, and often other dimensions refer to time.</p>
<div id="package-stars" class="section level2">
<h2><span class="header-section-number">4.1</span> Package <code>stars</code></h2>
<p>Athough package <code>sp</code> has always had limited support for raster data, over the last decade R package <code>raster</code> has clearly been dominant as the prime package for powerful, flexible and scalable raster analysis. Its data model is that of a 2D raster, or a set of raster layers (a &quot;raster stack&quot;). This follows the classical static GIS world view, where the world is modelled as a set of layers, each representing a different theme. A lot of data available today however is dynamic, and comes as time series of rasters for different themes. A raster stack does not meaningfully reflect this, requiring the user to do shadow book keeping of which layer represents what. Also, the <code>raster</code> package does an excellent job in scaling computations up to datasizes no larger than the local storage (the computer's hard drives). Recent datasets however, including satellite imagery, climate model or weather forecasting data, often no longer fit in local storage. Package <code>spacetime</code> addresses the analysis of time series of vector geometries or raster grid cells, but does not extend to higher-dimensional arrays.</p>
<p>Here, we introduce a new package for raster analysis, called <code>stars</code> (for scalable, spatiotemporal tidy arrays) that</p>
<ul>
<li>allows for representing dynamic raster stacks,</li>
<li>in addition to regular grids handles rotated, sheared, rectilinear and curvilinear rasters,</li>
<li>provides a tight integration with package <code>sf</code>,</li>
<li>follows the tidyverse design principles,</li>
<li>aims at being scalable, also beyond local disk size,</li>
<li>also handles array data with non-raster spatial dimensions, the <em>vector datacubes</em>,</li>
<li>provides further integration of novel features in the GDAL library than other R packages have given so far.</li>
</ul>
<p>Vector data cubes include for instance time series for simple features, or spatial graph data such as origin-destination matrices. The wider concept of spatial vector and raster data cubes is explained in section <a href="raster.html#datacubes">4.3</a></p>
</div>
<div id="raster-data" class="section level2">
<h2><span class="header-section-number">4.2</span> Raster data</h2>
<p>As introduced in section <a href="geometries.html#geomraster">3.3</a>, raster data are spatial datasets where observations are aligned on a regular grid usually with square grid cells (in some coordinate reference system, chapter <a href="rs.html#rs">7</a>). Raster datasets are used often to represent spatially continuously varying phenomena such as temperature or elevation, and also for observed imagery for instance obtained from satellites.</p>
<div id="reading-and-writing-raster-data" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Reading and writing raster data</h3>
<p>Raster data typically are read from a file. We read an example file of a regular, non-rotated grid from the package <code>stars</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)
<span class="kw">library</span>(stars)
x =<span class="st"> </span><span class="kw">read_stars</span>(tif)</code></pre></div>
<p>The dataset contains (a section of) a Landsat 7 scene, with the 6 30m-resolution bands (bands 1-5 and 7) for a region covering the city of Olinda, Brazil. A short summary of the data is given by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x
<span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;   L7_ETMs.tif   </span>
<span class="co">#&gt;  Min.   :  1.0  </span>
<span class="co">#&gt;  1st Qu.: 54.0  </span>
<span class="co">#&gt;  Median : 69.0  </span>
<span class="co">#&gt;  Mean   : 68.9  </span>
<span class="co">#&gt;  3rd Qu.: 86.0  </span>
<span class="co">#&gt;  Max.   :255.0  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from  to  offset delta                       refsys point values x/y</span>
<span class="co">#&gt; x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">#&gt; y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="co">#&gt; band    1   6      NA    NA                           NA    NA   NULL</span></code></pre></div>
<p>where we see the offset, cellsize, coordinate reference system, and dimensions. The object <code>x</code> is a simple list of length one, holding a three-dimensional array:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(x)
<span class="co">#&gt; [1] 1</span>
<span class="kw">class</span>(x[[<span class="dv">1</span>]])
<span class="co">#&gt; [1] &quot;array&quot;</span>
<span class="kw">dim</span>(x[[<span class="dv">1</span>]])
<span class="co">#&gt;    x    y band </span>
<span class="co">#&gt;  349  352    6</span></code></pre></div>
<p>and in addition holds an attribute with a dimensions table with all the metadata required to know what the array values refer to, obtained by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_dimensions</span>(x)
<span class="co">#&gt;      from  to  offset delta                       refsys point values x/y</span>
<span class="co">#&gt; x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">#&gt; y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="co">#&gt; band    1   6      NA    NA                           NA    NA   NULL</span></code></pre></div>
<p>We can get the spatial extent of the array by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_bbox</span>(x)
<span class="co">#&gt;    xmin    ymin    xmax    ymax </span>
<span class="co">#&gt;  288776 9110729  298723 9120761</span></code></pre></div>
<p>Raster data can be written to local disk using <code>write_stars</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tf =<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext=</span><span class="st">&quot;.tif&quot;</span>)
<span class="kw">write_stars</span>(x, tf)</code></pre></div>
<p>where the format (in this case, GeoTIFF) is derived from the file extension. As for simple features, reading and writing uses the GDAL library; the list of available drivers for raster data is obtained by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_drivers</span>(<span class="st">&quot;raster&quot;</span>)</code></pre></div>
</div>
<div id="plotting-raster-data" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Plotting raster data</h3>
<p>We can use the base plot method for <code>stars</code> objects, shown in figure <a href="raster.html#fig:firststars">4.1</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(x)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:firststars"></span>
<img src="sds_files/figure-html/firststars-1.png" alt="6 30m Landsat bands downsampled to 90m for Olinda, Br." width="672" />
<p class="caption">
Figure 4.1: 6 30m Landsat bands downsampled to 90m for Olinda, Br.
</p>
</div>
<p>The default color scale uses grey tones, and stretches this such that color breaks correspond to data quantiles over all bands. A more familiar view is the rgb or false color composite:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
<span class="kw">plot</span>(x, <span class="dt">rgb =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">&quot;RGB&quot;</span>)    <span class="co"># rgb</span>
<span class="kw">plot</span>(x, <span class="dt">rgb =</span> <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>), <span class="dt">main =</span> <span class="st">&quot;False color (NIR-R-G)&quot;</span>) <span class="co"># false color</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:starsrgb"></span>
<img src="sds_files/figure-html/starsrgb-1.png" alt="two RGB composites" width="100%" />
<p class="caption">
Figure 4.2: two RGB composites
</p>
</div>
</div>
<div id="analysing-raster-data" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Analysing raster data</h3>
<p>Element-wise mathematical operations on <code>stars</code> objects are just passed on to the arrays. This means that we can call functions and create expressions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">log</span>(x)
<span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;   L7_ETMs.tif  </span>
<span class="co">#&gt;  Min.   :0.00  </span>
<span class="co">#&gt;  1st Qu.:3.99  </span>
<span class="co">#&gt;  Median :4.23  </span>
<span class="co">#&gt;  Mean   :4.12  </span>
<span class="co">#&gt;  3rd Qu.:4.45  </span>
<span class="co">#&gt;  Max.   :5.54  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from  to  offset delta                       refsys point values x/y</span>
<span class="co">#&gt; x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">#&gt; y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="co">#&gt; band    1   6      NA    NA                           NA    NA   NULL</span>
x <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">log</span>(x)
<span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;   L7_ETMs.tif   </span>
<span class="co">#&gt;  Min.   :  1.0  </span>
<span class="co">#&gt;  1st Qu.: 62.0  </span>
<span class="co">#&gt;  Median : 77.5  </span>
<span class="co">#&gt;  Mean   : 77.1  </span>
<span class="co">#&gt;  3rd Qu.: 94.9  </span>
<span class="co">#&gt;  Max.   :266.1  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from  to  offset delta                       refsys point values x/y</span>
<span class="co">#&gt; x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">#&gt; y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="co">#&gt; band    1   6      NA    NA                           NA    NA   NULL</span></code></pre></div>
<p>or even mask out certain values:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x2 =<span class="st"> </span>x
x2[x <span class="op">&lt;</span><span class="st"> </span><span class="dv">50</span>] =<span class="st"> </span><span class="ot">NA</span>
x2
<span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;   L7_ETMs.tif    </span>
<span class="co">#&gt;  Min.   : 50     </span>
<span class="co">#&gt;  1st Qu.: 64     </span>
<span class="co">#&gt;  Median : 75     </span>
<span class="co">#&gt;  Mean   : 79     </span>
<span class="co">#&gt;  3rd Qu.: 90     </span>
<span class="co">#&gt;  Max.   :255     </span>
<span class="co">#&gt;  NA&#39;s   :149170  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from  to  offset delta                       refsys point values x/y</span>
<span class="co">#&gt; x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">#&gt; y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="co">#&gt; band    1   6      NA    NA                           NA    NA   NULL</span></code></pre></div>
<p>or un-mask areas:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x2[<span class="kw">is.na</span>(x2)] =<span class="st"> </span><span class="dv">0</span>
x2
<span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;   L7_ETMs.tif </span>
<span class="co">#&gt;  Min.   :  0  </span>
<span class="co">#&gt;  1st Qu.: 54  </span>
<span class="co">#&gt;  Median : 69  </span>
<span class="co">#&gt;  Mean   : 63  </span>
<span class="co">#&gt;  3rd Qu.: 86  </span>
<span class="co">#&gt;  Max.   :255  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from  to  offset delta                       refsys point values x/y</span>
<span class="co">#&gt; x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">#&gt; y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="co">#&gt; band    1   6      NA    NA                           NA    NA   NULL</span></code></pre></div>
<p>Dimension-wise, we can apply functions to array dimensions of stars objects just like <code>apply</code> does this to matrices. For instance, to compute for each pixel the mean of the 6 band values we can do</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_apply</span>(x, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), mean)
<span class="co">#&gt; stars object with 2 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;      mean       </span>
<span class="co">#&gt;  Min.   : 25.5  </span>
<span class="co">#&gt;  1st Qu.: 53.3  </span>
<span class="co">#&gt;  Median : 68.3  </span>
<span class="co">#&gt;  Mean   : 68.9  </span>
<span class="co">#&gt;  3rd Qu.: 82.0  </span>
<span class="co">#&gt;  Max.   :255.0  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;   from  to  offset delta                       refsys point values x/y</span>
<span class="co">#&gt; x    1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">#&gt; y    1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span></code></pre></div>
<p>A more meaningful function would e.g. compute the NDVI (normalized differenced vegetation index):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ndvi =<span class="st"> </span><span class="cf">function</span>(x) (x[<span class="dv">4</span>]<span class="op">-</span>x[<span class="dv">3</span>])<span class="op">/</span>(x[<span class="dv">4</span>]<span class="op">+</span>x[<span class="dv">3</span>])
<span class="kw">st_apply</span>(x, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), ndvi)
<span class="co">#&gt; stars object with 2 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;      ndvi        </span>
<span class="co">#&gt;  Min.   :-0.753  </span>
<span class="co">#&gt;  1st Qu.:-0.203  </span>
<span class="co">#&gt;  Median :-0.069  </span>
<span class="co">#&gt;  Mean   :-0.064  </span>
<span class="co">#&gt;  3rd Qu.: 0.187  </span>
<span class="co">#&gt;  Max.   : 0.587  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;   from  to  offset delta                       refsys point values x/y</span>
<span class="co">#&gt; x    1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">#&gt; y    1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span></code></pre></div>
<p>Alternatively, to compute for each band the mean of the whole image we can do</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.data.frame</span>(<span class="kw">st_apply</span>(x, <span class="kw">c</span>(<span class="st">&quot;band&quot;</span>), mean))
<span class="co">#&gt;   band mean</span>
<span class="co">#&gt; 1    1 79.1</span>
<span class="co">#&gt; 2    2 67.6</span>
<span class="co">#&gt; 3    3 64.4</span>
<span class="co">#&gt; 4    4 59.2</span>
<span class="co">#&gt; 5    5 83.2</span>
<span class="co">#&gt; 6    6 60.0</span></code></pre></div>
<p>which is so small it can be printed here as a <code>data.frame</code>. In these two examples, entire dimensions disappear. Sometimes, this does not happen; we can for instance compute the three quartiles for each band</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_apply</span>(x, <span class="kw">c</span>(<span class="st">&quot;band&quot;</span>), quantile, <span class="kw">c</span>(.<span class="dv">25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>))
<span class="co">#&gt; stars object with 2 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;   L7_ETMs.tif   </span>
<span class="co">#&gt;  Min.   : 32.0  </span>
<span class="co">#&gt;  1st Qu.: 60.8  </span>
<span class="co">#&gt;  Median : 66.5  </span>
<span class="co">#&gt;  Mean   : 69.8  </span>
<span class="co">#&gt;  3rd Qu.: 78.8  </span>
<span class="co">#&gt;  Max.   :112.0  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;          from to offset delta refsys point        values</span>
<span class="co">#&gt; quantile    1  3     NA    NA     NA    NA 25%, 50%, 75%</span>
<span class="co">#&gt; band        1  6     NA    NA     NA    NA          NULL</span></code></pre></div>
<p>and see that this <em>creates</em> a new dimension, <code>quantile</code>, with three values. Alternatively, the three quantiles over the 6 bands for each pixel are obtained by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_apply</span>(x, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), quantile, <span class="kw">c</span>(.<span class="dv">25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>))
<span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;   L7_ETMs.tif   </span>
<span class="co">#&gt;  Min.   :  4.0  </span>
<span class="co">#&gt;  1st Qu.: 55.0  </span>
<span class="co">#&gt;  Median : 69.2  </span>
<span class="co">#&gt;  Mean   : 67.2  </span>
<span class="co">#&gt;  3rd Qu.: 81.2  </span>
<span class="co">#&gt;  Max.   :255.0  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;          from  to  offset delta                       refsys point</span>
<span class="co">#&gt; quantile    1   3      NA    NA                           NA    NA</span>
<span class="co">#&gt; x           1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE</span>
<span class="co">#&gt; y           1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE</span>
<span class="co">#&gt;                 values x/y</span>
<span class="co">#&gt; quantile 25%, 50%, 75%    </span>
<span class="co">#&gt; x                 NULL [x]</span>
<span class="co">#&gt; y                 NULL [y]</span></code></pre></div>
</div>
<div id="raster-varieties-rectilinear-curvilinear" class="section level3">
<h3><span class="header-section-number">4.2.4</span> Raster varieties: rectilinear, curvilinear</h3>
<p>Besides the regular raster with square cells and axes aligned with <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, several other raster types exist. The ones supported by package <code>stars</code> are shown in figure <a href="raster.html#fig:rastertypes">4.3</a>.</p>
<div class="figure" style="text-align: center"><span id="fig:rastertypes"></span>
<img src="sds_files/figure-html/rastertypes-1.png" alt="raster types supported by the stars package" width="672" />
<p class="caption">
Figure 4.3: raster types supported by the stars package
</p>
</div>
<p>The <a href="https://r-spatial.github.io/stars/articles/data_model.html">data model</a> vignette of the package explains the models in detail, and points out how they can be constructed.</p>
<p>There are several reasons why non-regular rasters occur. For one, when the data is Earth-bound, a regular raster does not fit the Earth surface, which is curved. Other reasons are:</p>
<ul>
<li>when we convert or transform a regular raster data into another coordinate reference system, it will become curvilinear unless we resample; resampling always goes at the cost of some loss of data and is not reversible.</li>
<li>observation may lead to irregular rasters; e.g. for satellite swaths, we may have a regular raster in the direction of the satellite (not aligned with <span class="math inline">\(x\)</span> or <span class="math inline">\(y\)</span>), and rectilinear perpendicular to that (e.g. if the sensor discretizes the viewing <em>angle</em> in equal sections)</li>
</ul>
</div>
<div id="handling-large-raster-datasets" class="section level3">
<h3><span class="header-section-number">4.2.5</span> Handling large raster datasets</h3>
<p>A common challenge with raster datasets is not only that they come in large files (single Sentinel-2 tiles are around 1 Gb), but that many of these files, potentially thousands, are needed to address the area and time period of interest. At time of writing this, the Copernicus program which runs all Sentinel satellites publishes 160 Tb of images per day. This means that a classic pattern in using R, consisting of</p>
<ul>
<li>downloading data to local disc,</li>
<li>loading the data in memory,</li>
<li>analysing it</li>
</ul>
<p>is not going to work.</p>
<p>Cloud-based Earth Observation processing platforms like Google Earth Engine <span class="citation">(Gorelick et al. <a href="#ref-gorelick">2017</a>)</span> or <a href="https://www.sentinel-hub.com/">Sentinel Hub</a> recognize this and let users work with datasets up to 20 petabyte rather easily and with a great deal of interactivity. They share the following properties:</p>
<ul>
<li>computations are posponed as long as possible (lazy evaluation),</li>
<li>only the data you ask for are being computed and returned, and nothing more,</li>
<li>storing intermediate results is avoided in favour of on-the-fly computations,</li>
<li>maps with useful results are generated and shown quickly to allow for interactive model development.</li>
</ul>
<p>This is similar to the <code>dbplyr</code> interface to databases and cloud-based analytics environments, but differs in the aspect of <em>what</em> we want to see quickly: rather than the first <span class="math inline">\(n\)</span> records, we want a quick <em>overview</em> of the results, in the form of a map covering the whole area, or part of it, but at screen resolution rather than native (observation) resolution.</p>
<p>If for instance we want to &quot;see&quot; results for the United States on screen with 1000 x 1000 pixels, we only need to compute results for this many pixels, which corresponds roughly to data on a grid with 3000 m x 3000 m grid cells. For Sentinel-2 data with 10 m resolution, this means we can subsample with a factor 300, giving 3 km x 3 km resolution. Processing, storage and network requirements then drop a factor <span class="math inline">\(300^2 \approx 10^5\)</span>, compared to working on the native 10 m x 10 m resolution. On the platforms mentioned, zooming in the map triggers further computations on a finer resolution and smaller extent.</p>
<p>A simple optimisation that follows these lines is how stars' plot method works: in case of plotting large rasters, it subsamples the array before it plots, drastically saving time. The degree of subsampling is derived from the plotting region size and the plotting resolution (pixel density). For vector devices, such as pdf, R sets plot resolution to 75 dpi, corresponding to 0.3 mm per pixel. Enlarging plots may reveal this, but replotting to an enlarged devices will create a plot at target density.</p>
</div>
<div id="stars-proxy-objects" class="section level3">
<h3><span class="header-section-number">4.2.6</span> <code>stars</code> proxy objects</h3>
<p>To handle datasets that are too large to fit in memory, <code>stars</code> provides <code>stars_proxy</code> objects. To demonstrate its use, we will use the <code>starsdata</code> package, an R data package with larger datasets (around 1 Gb total). It can be installed by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;starsdata&quot;</span>, <span class="dt">repos =</span> <span class="st">&quot;http://pebesma.staff.ifgi.de&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;source&quot;</span>)</code></pre></div>
<p>We can &quot;load&quot; a Sentinel-2 image from it by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">granule =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;sentinel/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.zip&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;starsdata&quot;</span>)
<span class="kw">file.size</span>(granule)
<span class="co">#&gt; [1] 7.69e+08</span>
base_name =<span class="st"> </span><span class="kw">strsplit</span>(<span class="kw">basename</span>(granule), <span class="st">&quot;.zip&quot;</span>)[[<span class="dv">1</span>]]
s2 =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;SENTINEL2_L1C:/vsizip/&quot;</span>, granule, <span class="st">&quot;/&quot;</span>, base_name, <span class="st">&quot;.SAFE/MTD_MSIL1C.xml:10m:EPSG_32632&quot;</span>)
(<span class="dt">p =</span> <span class="kw">read_stars</span>(s2, <span class="dt">proxy =</span> <span class="ot">TRUE</span>))
<span class="co">#&gt; stars_proxy object with 1 attribute in file:</span>
<span class="co">#&gt; $`MTD_MSIL1C.xml:10m:EPSG_32632`</span>
<span class="co">#&gt; [1] &quot;[...]/MTD_MSIL1C.xml:10m:EPSG_32632&quot;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from    to offset delta                refsys point    values x/y</span>
<span class="co">#&gt; x       1 10980  3e+05    10 WGS 84 / UTM zone 32N    NA      NULL [x]</span>
<span class="co">#&gt; y       1 10980  6e+06   -10 WGS 84 / UTM zone 32N    NA      NULL [y]</span>
<span class="co">#&gt; band    1     4     NA    NA                    NA    NA B4,...,B8</span>
<span class="kw">object.size</span>(p)
<span class="co">#&gt; 11384 bytes</span></code></pre></div>
<p>and we see that this does not actually load <em>any</em> of the pixel values, but keeps the reference to the dataset and fills the dimensions table. (The convoluted <code>s2</code> name is needed to point GDAL to the right file inside the <code>.zip</code> file containing 115 files in total).</p>
<p>The idea of a proxy object is that we can build expressions like</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p2 =<span class="st"> </span>p <span class="op">*</span><span class="st"> </span><span class="dv">2</span></code></pre></div>
<p>but that the computations for this are postponed. Only when we really need the data, e.g. because we want to plot it, is <code>p * 2</code> evaluated. We need data when either</p>
<ul>
<li>we want to <code>plot</code> data, or</li>
<li>we want to write an object to disk, with <code>write_stars</code>, or</li>
<li>we want to explicitly load an object in memory, with <code>st_as_stars</code></li>
</ul>
<p>In case the entire object does not fit in memory, <code>plot</code> and <code>write_stars</code> choose different strategies to deal with this:</p>
<ul>
<li><code>plot</code> fetches only the pixels that can be seen, rather than all pixels available, and</li>
<li><code>write_stars</code> reads, processes, and writes data chunk by chunk.</li>
</ul>
<p>Downsampling and chunking is implemented for spatially dense images, not e.g. for dense time series, or other dense dimensions.</p>
<p>As an example,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(p)</code></pre></div>
<p><img src="sds_files/figure-html/unnamed-chunk-70-1.png" width="672" style="display: block; margin: auto;" /> only fetches the pixels that can be seen on the plot device, rather than the 10980 x 10980 pixels available in each band. The downsampling ratio taken is</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">floor</span>(<span class="kw">sqrt</span>(<span class="kw">prod</span>(<span class="kw">dim</span>(p)) <span class="op">/</span><span class="st"> </span><span class="kw">prod</span>(<span class="kw">dev.size</span>(<span class="st">&quot;px&quot;</span>))))
<span class="co">#&gt; [1] 19</span></code></pre></div>
<p>meaning that for every 19 x 19 sub-image in the original image, only one pixel is read, and plotted. This value is still a bit too high as it ignores the white space and space for the key on the plotting device.</p>
</div>
<div id="operations-on-proxy-objects" class="section level3">
<h3><span class="header-section-number">4.2.7</span> Operations on proxy objects</h3>
<p>A few dedicated methods are available for <code>stars_proxy</code> objects:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">&quot;stars_proxy&quot;</span>)
<span class="co">#&gt;  [1] [              adrop          aggregate      aperm          as.data.frame </span>
<span class="co">#&gt;  [6] c              coerce         dim            droplevels     filter        </span>
<span class="co">#&gt; [11] initialize     mapView        Math           merge          mutate        </span>
<span class="co">#&gt; [16] Ops            plot           predict        print          pull          </span>
<span class="co">#&gt; [21] select         show           slice          slotsFromS3    split         </span>
<span class="co">#&gt; [26] st_apply       st_as_stars    st_crop        st_extract     st_mosaic     </span>
<span class="co">#&gt; [31] st_redimension st_sample      st_set_bbox    write_stars   </span>
<span class="co">#&gt; see &#39;?methods&#39; for accessing help and source code</span></code></pre></div>
<p>We have seen <code>plot</code> and <code>print</code> in action; <code>dim</code> reads out the dimension from the dimensions metadata table.</p>
<p>The three methods that actually fetch data are <code>st_as_stars</code>, <code>plot</code> and <code>write_stars</code>. <code>st_as_stars</code> reads the actual data into a <code>stars</code> object, its argument <code>downsample</code> controls the downsampling rate. <code>plot</code> does this too, choosing an appropriate <code>downsample</code> value from the device resolution, and plots the object. <code>write_stars</code> writes a <code>star_proxy</code> object to disc.</p>
<p>All other methods for <code>stars_proxy</code> objects do not actually operate on the raster data but add the operations to a <em>to do</em> list, attached to the object. Only when actual raster data are fetched, e.g. by calling <code>plot</code> or <code>st_as_stars</code>, the commands in this list are executed.</p>
<p><code>st_crop</code> limits the extent (area) of the raster that will be read. <code>c</code> combines <code>stars_proxy</code> objects, but still doesn't read any data. <code>adrop</code> drops empty dimensions, <code>aperm</code> changes dimension order.</p>
<p><code>write_stars</code> reads and processes its input chunk-wise; it has an argument <code>chunk_size</code> that lets users control the size of spatial chunks.</p>
</div>
</div>
<div id="datacubes" class="section level2">
<h2><span class="header-section-number">4.3</span> Vector Datacubes</h2>
<p>Data cubes are multi-dimensional array data, where array dimensions are meaningfully related to categorical or continuous variables that may include space and time <span class="citation">(Lu, Appel, and Pebesma <a href="#ref-lu2018multidimensional">2018</a>)</span>. We have seen raster data cubes so far, e.g.</p>
<ul>
<li>raster data naturally fit in two-dimensional arrays,</li>
<li>multi-spectral raster data fit in three-dimensional arrays (cubes), and</li>
<li>time series of multi-spectral raster data fit in four-dimensional arrays (hyper-cubes).</li>
</ul>
<p>Besides Earth Observation/satellite imagery data, a large class of datacubes come from modelling data, e.g. from oceanographic, meteorologic or climate models, where dimensions may include</p>
<ul>
<li>latitude and longitude</li>
<li>altitude, or depth</li>
<li>pressure level (substituting altitude)</li>
<li>time</li>
<li>time to forecast, in addition to time when a forecast was made</li>
</ul>
<p>we can add to this as an additional dimension</p>
<ul>
<li>variable of interest (pressure, temperature, humidity, wind speed, salinity, ...)</li>
</ul>
<p>when we accept that categorical variables also &quot;take&quot; a dimension. The alternative would be to consider these as &quot;fields&quot;, or &quot;attributes&quot; of array records. Being able to swap dimensions to attributes flexibly and vice-versa leads to powerful analysis, as e.g. shown by the powerful array database SciDB <span class="citation">(Brown <a href="#ref-brown2010overview">2010</a>)</span>.</p>
<p>We go from raster data cubes to <em>vector data cubes</em> if we replace the two or three raster dimensions with one dimension listing a set of feature geometries (points, lines or polygons). One example would be air quality data, where we could have <span class="math inline">\(PM_{10}\)</span> measurements for</p>
<ul>
<li>a set of monitoring stations, and</li>
<li>a sequence of time intervals</li>
</ul>
<p>aligned in a vector data cube. Another example would be demographic or epidemiological data, where we have a time series of (population, disease) counts, with number of persons</p>
<ul>
<li>by region, for <span class="math inline">\(n\)</span> regions</li>
<li>by age class, for <span class="math inline">\(m\)</span> age classes, and</li>
<li>by year, for <span class="math inline">\(p\)</span> years.</li>
</ul>
<p>which forms an array with <span class="math inline">\(n m p\)</span> elements.</p>
<p>R has strong native support for arbitrarily dimensioned arrays, and we can get the value for year <span class="math inline">\(i\)</span>, age class <span class="math inline">\(j\)</span> and year <span class="math inline">\(k\)</span> from array <code>a</code> by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a[i,j,k]</code></pre></div>
<p>and e.g. the sub-array for age class <span class="math inline">\(j\)</span> by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a[,j,]</code></pre></div>
<p>Thinking along the classical GIS lines, where we would have either raster or vector data, one is left with the question what to do when we have a raster time series data cube (e.g. a climate model forecast) and want to obtain a vector time series data cube with aggregates of the model forecast over polygons, as time series. For spatial data science, support of vector and raster data cubes is extremely useful, because many variables are both spatially and temporaly varying, and because we often want to either change dimensions or aggregate them out, but in a fully flexible manner and order. Examples of changing dimensions are</p>
<ul>
<li>interpolating air quality measurements to values on a regular grid (raster)</li>
<li>estimating density maps from points or lines, e.g. with the number of flights passing by per week within a range of 1 km</li>
<li>aggregating climate model predictions to summary indicators for administrative regions</li>
<li>combining Earth observation data from different sensors, e.g. Modis (250 m pixels, every 16 days) with Sentinel-2 (10 m, every 5 days).</li>
</ul>
<p>Examples of aggregating one ore more full dimensions are assessments of</p>
<ul>
<li>which air quality monitoring stations indicate unhealthy conditions</li>
<li>which region has the highest increase in disease incidence</li>
<li>global warming (e.g. in degrees per year)</li>
</ul>
<div id="example-aggregating-air-quality-time-series" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Example: aggregating air quality time series</h3>
<p>Air quality data from package <code>spacetime</code> were obtained from the <a href="https://www.eea.europa.eu/data-and-maps/data/aqereporting-8">airBase European air quality data base</a>. Downloaded were daily average PM<span class="math inline">\(_{10}\)</span> values for rural background stations in Germany, 1998-2009.</p>
<p>We can create a <code>stars</code> object from the <code>air</code> matrix, the <code>dates</code> Date vector and the <code>stations</code> <code>SpatialPoints</code> objects by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(spacetime)
<span class="kw">data</span>(air) <span class="co"># this loads several datasets in .GlobalEnv</span>
<span class="kw">dim</span>(air)
<span class="co">#&gt; space  time </span>
<span class="co">#&gt;    70  4383</span>
d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">station =</span> <span class="kw">st_as_sfc</span>(stations), <span class="dt">time =</span> dates)
(<span class="dt">aq =</span> <span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">PM10 =</span> air), <span class="dt">dimensions =</span> d))
<span class="co">#&gt; stars object with 2 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;      PM10        </span>
<span class="co">#&gt;  Min.   :  0     </span>
<span class="co">#&gt;  1st Qu.: 10     </span>
<span class="co">#&gt;  Median : 15     </span>
<span class="co">#&gt;  Mean   : 18     </span>
<span class="co">#&gt;  3rd Qu.: 22     </span>
<span class="co">#&gt;  Max.   :274     </span>
<span class="co">#&gt;  NA&#39;s   :157659  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;         from   to     offset  delta                     refsys point</span>
<span class="co">#&gt; station    1   70         NA     NA +proj=longlat +datum=WGS84  TRUE</span>
<span class="co">#&gt; time       1 4383 1998-01-01 1 days                       Date FALSE</span>
<span class="co">#&gt;                                          values</span>
<span class="co">#&gt; station POINT (9.59 53.7),...,POINT (9.45 49.2)</span>
<span class="co">#&gt; time                                       NULL</span></code></pre></div>
<p>We can see from figure <a href="raster.html#fig:airst">4.4</a> that the time series are quite long, but also have large missing value gaps. Figure <a href="raster.html#fig:airmap">4.5</a> shows the spatial distribution measurement stations and mean PM<span class="math inline">\(_{10}\)</span> values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">image</span>(<span class="kw">aperm</span>(<span class="kw">log</span>(aq), <span class="dv">2</span><span class="op">:</span><span class="dv">1</span>), <span class="dt">main =</span> <span class="st">&quot;NA pattern (white) in PM10 station time series&quot;</span>)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:airst"></span>
<img src="sds_files/figure-html/airst-1.png" alt="space-time diagram of PM$_{10}$ measurements by time and station" width="672" />
<p class="caption">
Figure 4.4: space-time diagram of PM<span class="math inline">\(_{10}\)</span> measurements by time and station
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">st_as_sf</span>(<span class="kw">st_apply</span>(aq, <span class="dv">1</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">pch =</span> <span class="dv">16</span>,
    <span class="dt">ylim =</span> <span class="kw">st_bbox</span>(DE)[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>)])
<span class="kw">plot</span>(DE, <span class="dt">add=</span><span class="ot">TRUE</span>)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:airmap"></span>
<img src="sds_files/figure-html/airmap-1.png" alt="locations of PM$_{10}$ measurement stations, showing mean values" width="672" />
<p class="caption">
Figure 4.5: locations of PM<span class="math inline">\(_{10}\)</span> measurement stations, showing mean values
</p>
</div>
<p>We can now aggregate these station time series to area means, mostly as a simple exercise. For this, we use the <code>aggregate</code> method for <code>stars</code> objects</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(<span class="dt">a =</span> <span class="kw">aggregate</span>(aq, <span class="kw">st_as_sf</span>(DE_NUTS1), mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
<span class="co">#&gt; stars object with 2 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;      PM10       </span>
<span class="co">#&gt;  Min.   :  1    </span>
<span class="co">#&gt;  1st Qu.: 11    </span>
<span class="co">#&gt;  Median : 15    </span>
<span class="co">#&gt;  Mean   : 18    </span>
<span class="co">#&gt;  3rd Qu.: 22    </span>
<span class="co">#&gt;  Max.   :172    </span>
<span class="co">#&gt;  NA&#39;s   :25679  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;          from   to     offset  delta                     refsys point</span>
<span class="co">#&gt; geometry    1   16         NA     NA +proj=longlat +datum=WGS84 FALSE</span>
<span class="co">#&gt; time        1 4383 1998-01-01 1 days                       Date FALSE</span>
<span class="co">#&gt;                                                                     values</span>
<span class="co">#&gt; geometry MULTIPOLYGON (((9.65 49.8, ...,...,MULTIPOLYGON (((10.8 51.6, ...</span>
<span class="co">#&gt; time                                                                  NULL</span></code></pre></div>
<p>and we can now for instance show the maps for six arbitrarily chosen days (figure <a href="raster.html#fig:airagg">4.6</a>),</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
a <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(time <span class="op">&gt;=</span><span class="st"> &quot;2008-01-01&quot;</span>, time <span class="op">&lt;</span><span class="st"> &quot;2008-01-07&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">plot</span>(<span class="dt">key.pos =</span> <span class="dv">4</span>)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:airagg"></span>
<img src="sds_files/figure-html/airagg-1.png" alt="areal mean PM$_{10}$ values, for six days" width="672" />
<p class="caption">
Figure 4.6: areal mean PM<span class="math inline">\(_{10}\)</span> values, for six days
</p>
</div>
<p>or a time series of mean values for a single state (figure <a href="raster.html#fig:airts">4.7</a>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(xts))
<span class="kw">plot</span>(<span class="kw">as.xts</span>(a)[,<span class="dv">4</span>], <span class="dt">main =</span> DE_NUTS1<span class="op">$</span>NAME_<span class="dv">1</span>[<span class="dv">4</span>])</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:airts"></span>
<img src="sds_files/figure-html/airts-1.png" alt="areal mean PM$_{10}$ values, for six days" width="672" />
<p class="caption">
Figure 4.7: areal mean PM<span class="math inline">\(_{10}\)</span> values, for six days
</p>
</div>
</div>
<div id="example-bristol-origin-destination-datacube" class="section level3">
<h3><span class="header-section-number">4.3.2</span> Example: Bristol origin-destination datacube</h3>
<p>The data used for this example come from <span class="citation">(Lovelace, Nowosad, and Muenchow <a href="#ref-geocomp">2019</a>)</span>, and concern origin-destination (OD) counts: the number of persons going from region A to region B, by transportation mode. We have feature geometries for the 102 origin and destination regions, shown in figure <a href="raster.html#fig:bristol1">4.8</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(spDataLarge)
<span class="kw">plot</span>(<span class="kw">st_geometry</span>(bristol_zones), <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">graticule =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(<span class="kw">st_geometry</span>(bristol_zones)[<span class="dv">33</span>], <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:bristol1"></span>
<img src="sds_files/figure-html/bristol1-1.png" alt="Origin destination data zones for Bristol, UK, with zone 33 (E02003043) colored red" width="672" />
<p class="caption">
Figure 4.8: Origin destination data zones for Bristol, UK, with zone 33 (E02003043) colored red
</p>
</div>
<p>and the OD counts come in a table with OD pairs as records, and transportation mode as variables:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(bristol_od)
<span class="co">#&gt; # A tibble: 6 x 7</span>
<span class="co">#&gt;   o         d           all bicycle  foot car_driver train</span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 E02002985 E02002985   209       5   127         59     0</span>
<span class="co">#&gt; 2 E02002985 E02002987   121       7    35         62     0</span>
<span class="co">#&gt; 3 E02002985 E02003036    32       2     1         10     1</span>
<span class="co">#&gt; 4 E02002985 E02003043   141       1     2         56    17</span>
<span class="co">#&gt; 5 E02002985 E02003049    56       2     4         36     0</span>
<span class="co">#&gt; 6 E02002985 E02003054    42       4     0         21     0</span></code></pre></div>
<p>We see that many combinations of origin and destination are implicit zeroes, otherwise these two numbers would have been the same:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">nrow</span>(bristol_zones)<span class="op">^</span><span class="dv">2</span>
<span class="co">#&gt; [1] 10404</span>
<span class="kw">nrow</span>(bristol_od)
<span class="co">#&gt; [1] 2910</span></code></pre></div>
<p>We will form a three-dimensional vector datacube with origin, destination and transportation mode as dimensions. For this, we first &quot;tidy&quot; the <code>bristol_od</code> table to have origin (o), destination (d), transportation mode (mode), and count (n) as variables, using <code>gather</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># create O-D-mode array:</span>
bristol_tidy &lt;-<span class="st"> </span>bristol_od <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>all) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(<span class="st">&quot;mode&quot;</span>, <span class="st">&quot;n&quot;</span>, <span class="op">-</span>o, <span class="op">-</span>d)
<span class="kw">head</span>(bristol_tidy)
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;   o         d         mode        n</span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1 E02002985 E02002985 bicycle     5</span>
<span class="co">#&gt; 2 E02002985 E02002987 bicycle     7</span>
<span class="co">#&gt; 3 E02002985 E02003036 bicycle     2</span>
<span class="co">#&gt; 4 E02002985 E02003043 bicycle     1</span>
<span class="co">#&gt; 5 E02002985 E02003049 bicycle     2</span>
<span class="co">#&gt; 6 E02002985 E02003054 bicycle     4</span></code></pre></div>
<p>Next, we form the three-dimensional array <code>a</code>, filled with zeroes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">od =<span class="st"> </span>bristol_tidy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(<span class="st">&quot;o&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>unique
nod =<span class="st"> </span><span class="kw">length</span>(od)
mode =<span class="st"> </span>bristol_tidy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(<span class="st">&quot;mode&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>unique
nmode =<span class="st"> </span><span class="kw">length</span>(mode)
a =<span class="st"> </span><span class="kw">array</span>(0L,  <span class="kw">c</span>(nod, nod, nmode), 
    <span class="dt">dimnames =</span> <span class="kw">list</span>(<span class="dt">o =</span> od, <span class="dt">d =</span> od, <span class="dt">mode =</span> mode))</code></pre></div>
<p>We see that the dimensions are named with the zone names (o, d) and the transportation mode name (mode). Every row of <code>bristol_tidy</code> denotes an array entry, and we can use this to to fill the non-zero entries of the <code>bristol_tidy</code> table with their appropriate value (<code>n</code>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a[<span class="kw">as.matrix</span>(bristol_tidy[<span class="kw">c</span>(<span class="st">&quot;o&quot;</span>, <span class="st">&quot;d&quot;</span>, <span class="st">&quot;mode&quot;</span>)])] =<span class="st"> </span>bristol_tidy<span class="op">$</span>n</code></pre></div>
<p>To be sure that there is not an order mismatch between the zones in <code>bristol_zones</code> and the zone names in <code>bristol_tidy</code>, we can get the right set of zones by:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">order =<span class="st"> </span><span class="kw">match</span>(od, bristol_zones<span class="op">$</span>geo_code) <span class="co"># it happens this equals 1:102</span>
zones =<span class="st"> </span><span class="kw">st_geometry</span>(bristol_zones)[order]</code></pre></div>
<p>(It happens that the order is already correct, but it is good practice to not assume this).</p>
<p>Next, with zones and modes we can create a stars dimensions object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stars)
(<span class="dt">d =</span> <span class="kw">st_dimensions</span>(<span class="dt">o =</span> zones, <span class="dt">d =</span> zones, <span class="dt">mode =</span> mode))
<span class="co">#&gt;      from  to offset delta refsys point</span>
<span class="co">#&gt; o       1 102     NA    NA WGS 84 FALSE</span>
<span class="co">#&gt; d       1 102     NA    NA WGS 84 FALSE</span>
<span class="co">#&gt; mode    1   4     NA    NA     NA FALSE</span>
<span class="co">#&gt;                                                                 values</span>
<span class="co">#&gt; o    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span>
<span class="co">#&gt; d    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span>
<span class="co">#&gt; mode                                                 bicycle,...,train</span></code></pre></div>
<p>and finally build or stars object from <code>a</code> and <code>d</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(<span class="dt">odm =</span> <span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">N =</span> a), <span class="dt">dimensions =</span> d))
<span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;        N       </span>
<span class="co">#&gt;  Min.   :   0  </span>
<span class="co">#&gt;  1st Qu.:   0  </span>
<span class="co">#&gt;  Median :   0  </span>
<span class="co">#&gt;  Mean   :   5  </span>
<span class="co">#&gt;  3rd Qu.:   0  </span>
<span class="co">#&gt;  Max.   :1296  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from  to offset delta refsys point</span>
<span class="co">#&gt; o       1 102     NA    NA WGS 84 FALSE</span>
<span class="co">#&gt; d       1 102     NA    NA WGS 84 FALSE</span>
<span class="co">#&gt; mode    1   4     NA    NA     NA FALSE</span>
<span class="co">#&gt;                                                                 values</span>
<span class="co">#&gt; o    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span>
<span class="co">#&gt; d    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span>
<span class="co">#&gt; mode                                                 bicycle,...,train</span></code></pre></div>
<p>We can take a single slice through from this three-dimensional array, e.g. for zone 33 (figure <a href="raster.html#fig:bristol1">4.8</a>), by <code>odm[,,33]</code>, and plot it:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(odm[,,<span class="dv">33</span>] <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">logz =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Warning in st_as_sf.stars(x): working on the first sfc dimension only</span>
<span class="co">#&gt; Warning in st_bbox.dimensions(st_dimensions(obj), ...): returning the bounding</span>
<span class="co">#&gt; box of the first geometry dimension</span>

<span class="co">#&gt; Warning in st_bbox.dimensions(st_dimensions(obj), ...): returning the bounding</span>
<span class="co">#&gt; box of the first geometry dimension</span></code></pre></div>
<p><img src="sds_files/figure-html/unnamed-chunk-85-1.png" width="672" style="display: block; margin: auto;" /> Subsetting this way, we take all attributes (there is only one: N) since the first argument is empty, we take all origin regions (second argument empty), we take destination zone 33 (third argument), and all transportation modes (fourth argument empty, or missing).</p>
<p>We plotted this particular zone because it has the largest number of travelers as its destination. We can find this out by summing all origins and travel modes by destination:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">2</span>, sum)
<span class="kw">which.max</span>(d[[<span class="dv">1</span>]])
<span class="co">#&gt; [1] 33</span></code></pre></div>
<p>Other aggregations we can carry out include: total transportation by OD (102 x 102):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_apply</span>(odm, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, sum)
<span class="co">#&gt; stars object with 2 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;       sum      </span>
<span class="co">#&gt;  Min.   :   0  </span>
<span class="co">#&gt;  1st Qu.:   0  </span>
<span class="co">#&gt;  Median :   0  </span>
<span class="co">#&gt;  Mean   :  19  </span>
<span class="co">#&gt;  3rd Qu.:  19  </span>
<span class="co">#&gt;  Max.   :1434  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;   from  to offset delta refsys point</span>
<span class="co">#&gt; o    1 102     NA    NA WGS 84 FALSE</span>
<span class="co">#&gt; d    1 102     NA    NA WGS 84 FALSE</span>
<span class="co">#&gt;                                                              values</span>
<span class="co">#&gt; o MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span>
<span class="co">#&gt; d MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span></code></pre></div>
<p>Origin totals, by mode:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_apply</span>(odm, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), sum)
<span class="co">#&gt; stars object with 2 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;       sum      </span>
<span class="co">#&gt;  Min.   :   1  </span>
<span class="co">#&gt;  1st Qu.:  58  </span>
<span class="co">#&gt;  Median : 214  </span>
<span class="co">#&gt;  Mean   : 490  </span>
<span class="co">#&gt;  3rd Qu.: 771  </span>
<span class="co">#&gt;  Max.   :2903  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from  to offset delta refsys point</span>
<span class="co">#&gt; o       1 102     NA    NA WGS 84 FALSE</span>
<span class="co">#&gt; mode    1   4     NA    NA     NA FALSE</span>
<span class="co">#&gt;                                                                 values</span>
<span class="co">#&gt; o    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span>
<span class="co">#&gt; mode                                                 bicycle,...,train</span></code></pre></div>
<p>Destination totals, by mode:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">st_apply</span>(odm, <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), sum)
<span class="co">#&gt; stars object with 2 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;       sum       </span>
<span class="co">#&gt;  Min.   :    0  </span>
<span class="co">#&gt;  1st Qu.:   13  </span>
<span class="co">#&gt;  Median :  104  </span>
<span class="co">#&gt;  Mean   :  490  </span>
<span class="co">#&gt;  3rd Qu.:  408  </span>
<span class="co">#&gt;  Max.   :12948  </span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from  to offset delta refsys point</span>
<span class="co">#&gt; d       1 102     NA    NA WGS 84 FALSE</span>
<span class="co">#&gt; mode    1   4     NA    NA     NA FALSE</span>
<span class="co">#&gt;                                                                 values</span>
<span class="co">#&gt; d    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span>
<span class="co">#&gt; mode                                                 bicycle,...,train</span></code></pre></div>
<p>Origin totals, summed over modes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">o =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">1</span>, sum)</code></pre></div>
<p>Destination totals, summed over modes (we had this):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">2</span>, sum)</code></pre></div>
<p>We take <code>o</code> and <code>d</code> together and plot them by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x =<span class="st"> </span>(<span class="kw">c</span>(o, d, <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">od =</span> <span class="kw">c</span>(<span class="st">&quot;origin&quot;</span>, <span class="st">&quot;destination&quot;</span>))))
<span class="kw">plot</span>(x, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="sds_files/figure-html/unnamed-chunk-92-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>There is something to say for the argument that such maps give the wrong message, as both amount (color) and polygon size give an impression of amount. To take out the amount in the count, we can compute densities (count / km<span class="math inline">\(^2\)</span>), by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(units)
<span class="co">#&gt; udunits system database from /usr/share/xml/udunits</span>
a =<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">set_units</span>(<span class="kw">st_area</span>(<span class="kw">st_as_sf</span>(o)), km<span class="op">^</span><span class="dv">2</span>))
dens_o =<span class="st"> </span>o <span class="op">/</span><span class="st"> </span>a
dens_d =<span class="st"> </span>d <span class="op">/</span><span class="st"> </span>a
<span class="kw">plot</span>(<span class="kw">c</span>(dens_o, dens_d, <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">od =</span> <span class="kw">c</span>(<span class="st">&quot;origin&quot;</span>, <span class="st">&quot;destination&quot;</span>))), <span class="dt">logz =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="sds_files/figure-html/unnamed-chunk-93-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="are-datacubes-tidy" class="section level3">
<h3><span class="header-section-number">4.3.3</span> Are datacubes tidy?</h3>
<p>Yes! The <em>tidy data</em> paper <span class="citation">(Wickham <a href="#ref-tidy">2014</a><a href="#ref-tidy">b</a>)</span> may suggest that such array data should be processed not as an array, but in a long table where each row holds (region, class, year, value), and it is always good to be able to do this. For primary handling and storage however, this is often not an option, because</p>
<ul>
<li>a lot of array data are collected or generated as array data, e.g. by imagery or other sensory devices, or e.g. by climate models</li>
<li>it is easier to derive the long table form from the array than vice versa</li>
<li>the long table form requires much more memory, since the space occupied by dimension values is <span class="math inline">\(O(nmp)\)</span>, rather than <span class="math inline">\(O(n+m+p)\)</span></li>
<li>when missing-valued cells are dropped, the long table form loses the implicit indexing of the array form</li>
</ul>
<p>To put this argument to the extreme, consider for instance that all image, video and sound data are stored in array form; few people would make a real case for storing them in a long table form instead. Nevertheless, R packages like <code>tsibble</code> take this approach, and have to deal with ambiguous ordering of multiple records with identical time steps for different spatial features and index them, which is solved for both <em>automatically</em> by using the array form.</p>
<p>Package <code>stars</code> tries to follow the <a href="https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html">tidy manifesto</a> to handle array sets, and has particularly developed support for the case where one or more of the dimensions refer to space, and/or time.</p>
</div>
</div>
<div id="exercises" class="section level2">
<h2><span class="header-section-number">4.4</span> Exercises</h2>
<ol style="list-style-type: decimal">
<li>NDVI, normalized differenced vegetation index, is coputed as (NIR-R)/(NIR+R), with NIR the near infrared and R the red band. Read the <code>L7_ETMs.tif</code> file into object <code>x</code>, and distribute the band dimensions over attributes by <code>split(x, &quot;band&quot;)</code>. Then, compute NDVI by using an expression that uses the NIR (band 4) and R (band 3) attributes directly.</li>
<li>Compute NDVI for the S2 image, using <code>st_apply</code> and an a function <code>ndvi = function(x) (x[4]-x[3])/(x[4]+x[3])</code>. Plot the result, and write the result to a GeoTIFF. Explain the difference in runtime between plotting and writing.</li>
<li>Use <code>st_transform</code> to transform the <code>stars</code> object read from <code>L7_ETMs.tif</code> to EPSG 4326. Print the object. Is this a regular grid? Plot the first band using arguments <code>axes=TRUE</code> and <code>border=NA</code>, and explain why this takes such a long time.</li>
<li>Use <code>st_warp</code> to warp the <code>L7_ETMs.tif</code> object to EPSG 4326, and plot the resulting object with <code>axes=TRUE</code>. Why is the plot created much faster than after <code>st_transform</code>?</li>
</ol>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-brown2010overview">
<p>Brown, Paul G. 2010. Overview of SciDB: Large Scale Array Storage, Processing and Analysis. In <em>Proceedings of the 2010 ACM SIGMOD International Conference on Management of Data</em>, 96368. ACM.</p>
</div>
<div id="ref-gorelick">
<p>Gorelick, Noel, Matt Hancher, Mike Dixon, Simon Ilyushchenko, David Thau, and Rebecca Moore. 2017. Google Earth Engine: Planetary-Scale Geospatial Analysis for Everyone. <em>Remote Sensing of Environment</em> 202: 1827. doi:<a href="https://doi.org/10.1016/j.rse.2017.06.031">10.1016/j.rse.2017.06.031</a>.</p>
</div>
<div id="ref-geocomp">
<p>Lovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2019. <em>Geocomputation with R</em>. Chapman; Hall/CRC. <a href=" https://geocompr.robinlovelace.net/ ">https://geocompr.robinlovelace.net/</a>.</p>
</div>
<div id="ref-lu2018multidimensional">
<p>Lu, Meng, Marius Appel, and Edzer Pebesma. 2018. Multidimensional Arrays for Analysing Geoscientific Data. <em>ISPRS International Journal of Geo-Information</em> 7 (8). Multidisciplinary Digital Publishing Institute: 313.</p>
</div>
<div id="ref-tidy">
<p>Wickham, Hadley. 2014b. Tidy Data. <em>Journal of Statistical Software</em> 59 (1). <a href=" https://www.jstatsoft.org/article/view/v059i10 ">https://www.jstatsoft.org/article/view/v059i10</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="geometries.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="geommanip.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/edzer/sdsr/edit/master/04-Raster-Cube.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["sds.pdf", "sds.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
