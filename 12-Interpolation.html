<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>12&nbsp; Spatial Interpolation â€“ Spatial Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./13-Geostatistics.html" rel="next">
<link href="./11-PointPattern.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-d58359eb3ecc31d3bec1ed479c2cbb3a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-04YTZNEH1K"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
 
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'analytics_storage': 'denied'
  });
gtag('config', 'G-04YTZNEH1K', { 'anonymize_ip': true});
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-3.html">Models for Spatial Data</a></li><li class="breadcrumb-item"><a href="./12-Interpolation.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/edzer/sdsr/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-hello.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting Started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-Spaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Coordinates</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-Geometries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Spherical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spherical Geometries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-Attributes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Attributes and Support</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-Cubes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R for Spatial Data Science</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-Introsf.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-Plotting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-Large.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Models for Spatial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Statistical modelling of spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-PointPattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Point Pattern Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-Interpolation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-Geostatistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-Areal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-Measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of Spatial Autocorrelation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-SpatialRegression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-Econometrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Spatial Econometrics Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sp-raster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Older R Spatial Packages</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rbasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">R Basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ERRATA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Errata to the printed ed.</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#a-first-dataset" id="toc-a-first-dataset" class="nav-link active" data-scroll-target="#a-first-dataset"><span class="header-section-number">12.1</span> A first dataset</a></li>
  <li><a href="#sample-variogram" id="toc-sample-variogram" class="nav-link" data-scroll-target="#sample-variogram"><span class="header-section-number">12.2</span> Sample variogram</a></li>
  <li><a href="#fitting-variogram-models" id="toc-fitting-variogram-models" class="nav-link" data-scroll-target="#fitting-variogram-models"><span class="header-section-number">12.3</span> Fitting variogram models</a></li>
  <li><a href="#sec-kriging" id="toc-sec-kriging" class="nav-link" data-scroll-target="#sec-kriging"><span class="header-section-number">12.4</span> Kriging interpolation</a></li>
  <li><a href="#sec-blockkriging" id="toc-sec-blockkriging" class="nav-link" data-scroll-target="#sec-blockkriging"><span class="header-section-number">12.5</span> Areal means: block kriging</a></li>
  <li><a href="#conditional-simulation" id="toc-conditional-simulation" class="nav-link" data-scroll-target="#conditional-simulation"><span class="header-section-number">12.6</span> Conditional simulation</a></li>
  <li>
<a href="#trend-models" id="toc-trend-models" class="nav-link" data-scroll-target="#trend-models"><span class="header-section-number">12.7</span> Trend models</a>
  <ul class="collapse">
<li><a href="#a-population-grid" id="toc-a-population-grid" class="nav-link" data-scroll-target="#a-population-grid">A population grid</a></li>
  </ul>
</li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">12.8</span> Exercises</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/edzer/sdsr/edit/python/12-Interpolation.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part-3.html">Models for Spatial Data</a></li><li class="breadcrumb-item"><a href="./12-Interpolation.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-interpolation" class="quarto-section-identifier"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p> </p>
<p>Spatial interpolation is the activity of estimating values of spatially continuous variables (fields) for spatial locations where they have not been observed, based on observations. The statistical methodology for spatial interpolation, called geostatistics, is concerned with the modelling, prediction, and simulation of spatially continuous phenomena. The typical problem is a missing value problem: we observe a property of a phenomenon <span class="math inline">\(Z(s)\)</span> at a limited number of sample locations <span class="math inline">\(s_i, i = 1,...,n\)</span>, and are interested in the property value at all locations <span class="math inline">\(s_0\)</span> covering an area of interest, so we have to predict it for unobserved locations. This is also called <em>kriging</em>, or Gaussian Process prediction. In case <span class="math inline">\(Z(s)\)</span> contains a white noise component <span class="math inline">\(\epsilon\)</span>, as in <span class="math inline">\(Z(s)=S(s)+\epsilon\)</span> (possibly reflecting measurement error) an alternative but similar goal is to predict or simulate <span class="math inline">\(S(s)\)</span> rather than <span class="math inline">\(Z(s)\)</span>, which may be called <em>spatial filtering</em> or <em>smoothing</em>.</p>
<p>In this chapter we will show simple approaches for handling geostatistical data, demonstrate simple interpolation methods, and explore modelling spatial correlation, spatial prediction and simulation. <a href="13-Geostatistics.html" class="quarto-xref"><span>Chapter 13</span></a> focuses on more complex multivariate and spatiotemporal geostatistical models. We will use package <strong>gstat</strong> <span class="citation" data-cites="R-gstat gstatcg">(<a href="references.html#ref-R-gstat" role="doc-biblioref">Pebesma and Graeler 2022</a>; <a href="references.html#ref-gstatcg" role="doc-biblioref">Pebesma 2004</a>)</span>, which offers a fairly wide palette of models and options for non-Bayesian geostatistical analysis. Bayesian methods with R implementations are found in <span class="citation" data-cites="DiggleTawnMoyeed:98">Diggle, Tawn, and Moyeed (<a href="references.html#ref-DiggleTawnMoyeed:98" role="doc-biblioref">1998</a>)</span>, <span class="citation" data-cites="Diggle:2007">Diggle and Ribeiro Jr. (<a href="references.html#ref-Diggle:2007" role="doc-biblioref">2007</a>)</span>, <span class="citation" data-cites="blangiardo2015spatial">Blangiardo and Cameletti (<a href="references.html#ref-blangiardo2015spatial" role="doc-biblioref">2015</a>)</span>, and <span class="citation" data-cites="wikle2019spatio">Wikle, Zammit-Mangion, and Cressie (<a href="references.html#ref-wikle2019spatio" role="doc-biblioref">2019</a>)</span>. An overview and comparison of methods for large datasets is given in <span class="citation" data-cites="Heaton2018">Heaton et al. (<a href="references.html#ref-Heaton2018" role="doc-biblioref">2018</a>)</span>.</p>
<p></p>
<section id="a-first-dataset" class="level2" data-number="12.1"><h2 data-number="12.1" class="anchored" data-anchor-id="a-first-dataset">
<span class="header-section-number">12.1</span> A first dataset</h2>
<p>We can read station mean NO<span class="math inline">\(_2\)</span> values, a dataset that is prepared in <a href="13-Geostatistics.html" class="quarto-xref"><span>Chapter 13</span></a>, by loading it from package <strong>gstat</strong> using</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">no2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"external/no2.csv"</span>, </span>
<span>    package <span class="op">=</span> <span class="st">"gstat"</span><span class="op">)</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>no2 <span class="op">=</span> pd.read_csv(<span class="st">"https://github.com/r-spatial/gstat/raw/main/inst/external/no2.csv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
<p>and convert it into an <code>sf</code> object with an appropriate UTM projection using</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="co"># Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</span></span>
<span><span class="va">crs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">"EPSG:32632"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">no2</span>, crs <span class="op">=</span> <span class="st">"OGC:CRS84"</span>, coords <span class="op">=</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"station_longitude_deg"</span>, <span class="st">"station_latitude_deg"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">crs</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">no2.sf</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyproj <span class="im">import</span> CRS</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert NO2 data to GeoDataFrame and set coordinate reference systems</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>no2 <span class="op">=</span> gpd.GeoDataFrame(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    no2,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    geometry<span class="op">=</span>gpd.points_from_xy(no2[<span class="st">"station_longitude_deg"</span>], no2[<span class="st">"station_latitude_deg"</span>]),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    crs<span class="op">=</span><span class="st">"OGC:CRS84"</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>no2_sf <span class="op">=</span> no2.to_crs(CRS.from_epsg(<span class="dv">32632</span>))  <span class="co"># Transform to UTM (EPSG:32632)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
<p>Next, we can load country boundaries and plot these data using <code>ggplot</code>, shown in <a href="#fig-plotDE" class="quarto-xref">Figure&nbsp;<span>12.1</span></a>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"data/de_nuts1.gpkg"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">crs</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">de</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>de <span class="op">=</span> gpd.read_file(<span class="st">"data/de_nuts1.gpkg"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>de <span class="op">=</span> de.to_crs(CRS.from_epsg(<span class="dv">32632</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">de</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">no2.sf</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">NO2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-plotDE" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plotDE-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-plotDE-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plotDE-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.1: Mean NO<span class="math inline">\(_2\)</span> concentrations in air for rural background stations in Germany, in 2017
</figcaption></figure>
</div>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>de.plot(ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">"black"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>no2_sf.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">"NO2"</span>, legend<span class="op">=</span><span class="va">True</span>, cmap<span class="op">=</span><span class="st">"viridis"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="12-Interpolation_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p> </p>
<p>If we want to interpolate, we first need to decide where. This is typically done on a regular grid covering the area of interest. Starting with the country outline in object <code>de</code> we can create a regular 10 km <span class="math inline">\(\times\)</span> 10 km grid over Germany by</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">de</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span>dx <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">de</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">grd</span></span>
<span><span class="va">grd</span></span>
<span><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#         Min. 1st Qu. Median Mean 3rd Qu. Max. NA's</span></span>
<span><span class="co"># values     0       0      0    0       0    0 2076</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#   from to  offset  delta            refsys x/y</span></span>
<span><span class="co"># x    1 65  280741  10000 WGS 84 / UTM z... [x]</span></span>
<span><span class="co"># y    1 87 6101239 -10000 WGS 84 / UTM z... [y]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> box</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create bounding box of the country (Germany)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>bounds <span class="op">=</span> de.total_bounds  <span class="co"># [minx, miny, maxx, maxy]</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a 10 km x 10 km grid</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>x_coords <span class="op">=</span> np.arange(bounds[<span class="dv">0</span>], bounds[<span class="dv">2</span>], <span class="dv">10000</span>)  <span class="co"># 10,000 meters</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>y_coords <span class="op">=</span> np.arange(bounds[<span class="dv">1</span>], bounds[<span class="dv">3</span>], <span class="dv">10000</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create grid cells</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>grid_cells <span class="op">=</span> [</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    box(x, y, x <span class="op">+</span> <span class="dv">10000</span>, y <span class="op">+</span> <span class="dv">10000</span>) <span class="cf">for</span> x <span class="kw">in</span> x_coords <span class="cf">for</span> y <span class="kw">in</span> y_coords</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop grid cells to the country boundary</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>grid_gdf <span class="op">=</span> gpd.GeoDataFrame(geometry<span class="op">=</span>grid_cells, crs<span class="op">=</span>de.crs)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>grid_gdf <span class="op">=</span> gpd.overlay(grid_gdf, de, how<span class="op">=</span><span class="st">"intersection"</span>)  <span class="co"># Crop to country boundary</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
<p>Here, we chose grid cells not too fine, so that we still see them in plots.</p>
<p>Perhaps the simplest interpolation method is inverse distance weighted interpolation, which is a weighted average, using weights inverse proportional to distances from the interpolation location:</p>
<p> </p>
<p><span class="math display">\[
\hat{z}(s_0) = \frac{\sum_{i=1}^{n} w_i z(s_i)}{\sum_{i=1}^n w_i}
\]</span></p>
<p>with <span class="math inline">\(w_i = |s_0-s_i|^{-p}\)</span>, and the inverse distance power <span class="math inline">\(p\)</span> typically taken as 2, or optimised using cross-validation. We can compute inverse distance interpolated values using <code><a href="https://r-spatial.github.io/gstat/reference/krige.html">gstat::idw</a></code>,</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/gstat/">gstat</a></span><span class="op">)</span></span>
<span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/krige.html">idw</a></span><span class="op">(</span><span class="va">NO2</span><span class="op">~</span><span class="fl">1</span>, <span class="va">no2.sf</span>, <span class="va">grd</span><span class="op">)</span></span>
<span><span class="co"># [inverse distance weighted interpolation]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial <span class="im">import</span> cKDTree</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inverse_distance_weighting(data_points, grid_points, values, power<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Perform inverse distance weighting (IDW) interpolation.</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    tree <span class="op">=</span> cKDTree(data_points)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    distances, indices <span class="op">=</span> tree.query(grid_points, k<span class="op">=</span><span class="bu">len</span>(data_points))</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> np.power(distances, power)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    weights[distances <span class="op">==</span> <span class="dv">0</span>] <span class="op">=</span> <span class="fl">1e12</span>  <span class="co"># Handle zero distances</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    interpolated <span class="op">=</span> np.<span class="bu">sum</span>(weights <span class="op">*</span> values[indices], axis<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> np.<span class="bu">sum</span>(weights, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> interpolated</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data points and grid</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>data_points <span class="op">=</span> np.array(<span class="bu">list</span>(<span class="bu">zip</span>(no2_sf.geometry.x, no2_sf.geometry.y)))</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>grid_points <span class="op">=</span> np.array(<span class="bu">list</span>(<span class="bu">zip</span>(grid_gdf.geometry.centroid.x, grid_gdf.geometry.centroid.y)))</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> no2_sf[<span class="st">"NO2"</span>].values</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform IDW</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>grid_gdf[<span class="st">"NO2_IDW"</span>] <span class="op">=</span> inverse_distance_weighting(data_points, grid_points, values)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
<p>and plot them in <a href="#fig-idw" class="quarto-xref">Figure&nbsp;<span>12.2</span></a>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" role="tab" aria-controls="tabset-7-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" role="tab" aria-controls="tabset-7-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-7-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-7-1-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">i</span>, </span>
<span>                      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">var1.pred</span>, x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="va">de</span>, <span class="st">"MULTILINESTRING"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">no2.sf</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-idw" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-idw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-idw-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-idw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.2: Inverse distance weighted interpolated values for NO<span class="math inline">\(_2\)</span> over Germany
</figcaption></figure>
</div>
</div>
</div>
</div>
<div id="tabset-7-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-7-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot IDW interpolated values</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>grid_gdf.plot(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">"NO2_IDW"</span>, cmap<span class="op">=</span><span class="st">"viridis"</span>, legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    legend_kwds<span class="op">=</span>{<span class="st">"label"</span>: <span class="st">"NO2 (IDW Interpolation)"</span>}</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay country boundaries</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>de.boundary.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay measurement points</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>no2_sf.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"red"</span>, markersize<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">""</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">""</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Inverse Distance Weighted Interpolation for NO2"</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="12-Interpolation_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section><section id="sample-variogram" class="level2" data-number="12.2"><h2 data-number="12.2" class="anchored" data-anchor-id="sample-variogram">
<span class="header-section-number">12.2</span> Sample variogram</h2>
<p> </p>
<p>In order to make spatial predictions using geostatistical methods, we first need to identify a model for the mean and for the spatial correlation. In the simplest model, <span class="math inline">\(Z(s) = m + e(s)\)</span>, the mean is an unknown constant <span class="math inline">\(m\)</span>, and in this case the spatial correlation can be modelled using the variogram, <span class="math inline">\(\gamma(h) = 0.5 E (Z(s)-Z(s+h))^2\)</span>. For processes with a finite variance <span class="math inline">\(C(0)\)</span>, the variogram is related to the covariogram or covariance function through <span class="math inline">\(\gamma(h) = C(0)-C(h)\)</span>.</p>
<p>The sample variogram is obtained by computing estimates of <span class="math inline">\(\gamma(h)\)</span> for distance intervals, <span class="math inline">\(h_i = [h_{i,0},h_{i,1}]\)</span>: <span id="eq-samplevariogram"><span class="math display">\[
\hat{\gamma}(h_i) = \frac{1}{2N(h_i)}\sum_{j=1}^{N(h_i)}(z(s_i)-z(s_i+h'))^2, \ \ h_{i,0} \le h' &lt; h_{i,1}
\tag{12.1}\]</span></span></p>
<p>with <span class="math inline">\(N(h_i)\)</span> the number of sample pairs available for distance interval <span class="math inline">\(h_i\)</span>. Function <code><a href="https://r-spatial.github.io/gstat/reference/variogram.html">gstat::variogram</a></code> computes sample variograms,</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-8-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-1" role="tab" aria-controls="tabset-8-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-2" role="tab" aria-controls="tabset-8-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-8-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-8-1-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogram.html">variogram</a></span><span class="op">(</span><span class="va">NO2</span><span class="op">~</span><span class="fl">1</span>, <span class="va">no2.sf</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>and the result of plotting this is shown in <a href="#fig-vgm" class="quarto-xref">Figure&nbsp;<span>12.3</span></a>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">v</span>, plot.numbers <span class="op">=</span> <span class="cn">TRUE</span>, xlab <span class="op">=</span> <span class="st">"distance h [m]"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">gamma</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.055</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">v</span><span class="op">$</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-vgm" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-vgm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-vgm-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-vgm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.3: Sample variogram plot
</figcaption></figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial.distance <span class="im">import</span> pdist, squareform</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_variogram(data_points, values, bins):</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute a sample variogram.</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    distances <span class="op">=</span> pdist(data_points)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    diffs <span class="op">=</span> pdist(values[:, <span class="va">None</span>], metric<span class="op">=</span><span class="st">"sqeuclidean"</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    distances, diffs <span class="op">=</span> squareform(distances), squareform(diffs)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bin distances</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    binned <span class="op">=</span> pd.cut(distances.flatten(), bins<span class="op">=</span>bins, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    gamma <span class="op">=</span> [</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        np.mean(diffs.flatten()[binned <span class="op">==</span> i]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(bins) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gamma, bins[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute variogram</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>bins <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">100000</span>, num<span class="op">=</span><span class="dv">10</span>)  <span class="co"># Define bins ## EJP: </span><span class="al">TBD</span><span class="co"> - num=15 and deal with empty bins!</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>data_points <span class="op">=</span> np.array(<span class="bu">list</span>(<span class="bu">zip</span>(no2_sf.geometry.x, no2_sf.geometry.y)))</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> no2_sf[<span class="st">"NO2"</span>].values</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>variogram, bin_centers <span class="op">=</span> compute_variogram(data_points, values, bins)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div>
</div>
</div>
<p>Function <code>variogram</code> chooses default for maximum distance (<code>cutoff</code>: one-third of the length of the bounding box diagonal) and (constant) interval widths (<code>width</code>: cutoff divided by 15). These defaults can be changed by</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-9-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-1" role="tab" aria-controls="tabset-9-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-2" role="tab" aria-controls="tabset-9-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-9-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-9-1-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">v0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogram.html">variogram</a></span><span class="op">(</span><span class="va">NO2</span><span class="op">~</span><span class="fl">1</span>, <span class="va">no2.sf</span>, cutoff <span class="op">=</span> <span class="fl">100000</span>, width <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-9-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-2-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_variogram_with_cutoff(data_points, values, bins):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute a sample variogram with a custom cutoff and bin width.</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    distances <span class="op">=</span> pdist(data_points)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    diffs <span class="op">=</span> pdist(values[:, <span class="va">None</span>], metric<span class="op">=</span><span class="st">"sqeuclidean"</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    distances, diffs <span class="op">=</span> squareform(distances), squareform(diffs)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply cutoff</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    valid <span class="op">=</span> distances <span class="op">&lt;</span> bins[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    distances <span class="op">=</span> distances[valid]</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    diffs <span class="op">=</span> diffs[valid]</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bin distances</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    binned <span class="op">=</span> pd.cut(distances.flatten(), bins<span class="op">=</span>bins, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    gamma <span class="op">=</span> [</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        np.mean(diffs.flatten()[binned <span class="op">==</span> i]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(bins) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gamma, bins[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Define bins with cutoff and width</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>bins <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="dv">100000</span> <span class="op">+</span> <span class="dv">10000</span>, <span class="dv">10000</span>)  <span class="co"># Lags of 10,000 meters up to 100,000</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>variogram_cutoff, bin_centers_cutoff <span class="op">=</span> compute_variogram_with_cutoff(data_points, values, bins)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it:</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot only the symbols (points) without a connecting line</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>ax.scatter(bin_centers_cutoff, variogram_cutoff, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"Sample Variogram"</span>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Set x-axis and y-axis limits to start at zero and include the cutoff</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="fl">1.055</span> <span class="op">*</span> bins[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="co"># (0.0, 105500.0)</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="co"># (0.0, 17.526628260602124)</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels, title, and grid</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Distance h [m]"</span>)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r"</span><span class="dv">$</span><span class="er">\</span><span class="vs">gamma</span><span class="kw">(</span><span class="vs">h</span><span class="kw">)</span><span class="dv">$</span><span class="vs">"</span>)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Sample Variogram with Cutoff"</span>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>)</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.legend()</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="12-Interpolation_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>shown in <a href="#fig-vgm2" class="quarto-xref">Figure&nbsp;<span>12.4</span></a>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-10-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-1" role="tab" aria-controls="tabset-10-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-10-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-2" role="tab" aria-controls="tabset-10-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-10-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-10-1-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">v0</span>, plot.numbers <span class="op">=</span> <span class="cn">TRUE</span>, xlab <span class="op">=</span> <span class="st">"distance h [m]"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">gamma</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.055</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">v0</span><span class="op">$</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-vgm2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-vgm2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-vgm2-3.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-vgm2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.4: Sample variogram plot with adjusted cutoff and lag width
</figcaption></figure>
</div>
</div>
</div>
</div>
<div id="tabset-10-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-10-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot only the symbols (points) without a connecting line</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>ax.scatter(bin_centers_cutoff, variogram_cutoff, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"Sample Variogram"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Set x-axis and y-axis limits to start at zero and include the cutoff</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="fl">1.055</span> <span class="op">*</span> bins[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># (0.0, 105500.0)</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># (0.0, 17.526628260602124)</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels, title, and grid</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Distance h [m]"</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r"</span><span class="dv">$</span><span class="er">\</span><span class="vs">gamma</span><span class="kw">(</span><span class="vs">h</span><span class="kw">)</span><span class="dv">$</span><span class="vs">"</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Sample Variogram with Cutoff"</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.legend()</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="12-Interpolation_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Note that the formula <code>NO2~1</code> is used to select the variable of interest from the data file (<code>NO2</code>), and to specify the mean model: <code>~1</code> specifies an intercept-only (unknown, constant mean) model.</p>
</section><section id="fitting-variogram-models" class="level2" data-number="12.3"><h2 data-number="12.3" class="anchored" data-anchor-id="fitting-variogram-models">
<span class="header-section-number">12.3</span> Fitting variogram models</h2>
<p></p>
<p>In order to progress towards spatial predictions, we need a variogram <em>model</em> <span class="math inline">\(\gamma(h)\)</span> for (potentially) all distances <span class="math inline">\(h\)</span>, rather than the set of estimates derived above. If we would connect these estimates with straight lines, or assume they reflect constant values over their respective distance intervals, it would lead to statistical models with non-positive definite covariance matrices, which would block using them in prediction.</p>
<p> </p>
<p>To avoid this, we fit parametric models <span class="math inline">\(\gamma(h)\)</span> to the estimates <span class="math inline">\(\hat{\gamma}(h_i)\)</span>, where we take <span class="math inline">\(h_i\)</span> as the mean value of all the <span class="math inline">\(h'\)</span> values involved in estimating <span class="math inline">\(\hat{\gamma}(h_i)\)</span>. We can fit for instance a model with an exponential variogram by</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-11-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-1" role="tab" aria-controls="tabset-11-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-11-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-2" role="tab" aria-controls="tabset-11-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-11-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-11-1-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">v.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/fit.variogram.html">fit.variogram</a></span><span class="op">(</span><span class="va">v</span>, <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/vgm.html">vgm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"Exp"</span>, <span class="fl">50000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-11-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-11-2-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> curve_fit</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define exponential variogram model</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> exponential_model(h, sill, range_, nugget):</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nugget <span class="op">+</span> sill <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> np.exp(<span class="op">-</span>h <span class="op">/</span> range_))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define exponential variogram model without nugget:</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> exponential_model_zero_nugget(h, sill, range_):</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sill <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> np.exp(<span class="op">-</span>h <span class="op">/</span> range_))</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial guesses for sill, range, and nugget</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>initial_guess <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">50000</span>, <span class="dv">1</span>]</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the variogram model</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>params, _ <span class="op">=</span> curve_fit(</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    exponential_model, bin_centers_cutoff, variogram_cutoff, </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    p0<span class="op">=</span>initial_guess</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract fitted parameters</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>fitted_sill, fitted_range, fitted_nugget <span class="op">=</span> params</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fitted_nugget <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    fitted_nugget <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Ensure nugget is non-negative</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    params, _ <span class="op">=</span> curve_fit(</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        exponential_model_zero_nugget, bin_centers_cutoff, variogram_cutoff, </span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>        p0<span class="op">=</span>[fitted_sill, fitted_range]</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    fitted_sill, fitted_range <span class="op">=</span> params</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="co">## Plotted:</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate model curve</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>model_curve <span class="op">=</span> exponential_model(bin_centers_cutoff, fitted_sill, fitted_range, fitted_nugget)</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="bu">max</span>(bin_centers_cutoff) <span class="op">*</span> <span class="fl">1.05</span>)</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="co"># (0.0, 94500.0)</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="bu">max</span>(variogram_cutoff) <span class="op">*</span> <span class="fl">1.05</span>)</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="co"># (0.0, 17.573528479638522)</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot sample variogram points</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>ax.scatter(bin_centers_cutoff, variogram_cutoff, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"Sample Variogram"</span>)</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;matplotlib.collections.PathCollection object at 0x7f41cfc5ead0&gt;</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot fitted variogram model</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>ax.plot(bin_centers_cutoff, model_curve, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"Fitted Model"</span>)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="co"># [&lt;matplotlib.lines.Line2D object at 0x7f41cfc5e990&gt;]</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels, title, and grid</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Distance h [m]"</span>)</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Text(0.5, 0, 'Distance h [m]')</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r"</span><span class="dv">$</span><span class="er">\</span><span class="vs">gamma</span><span class="kw">(</span><span class="vs">h</span><span class="kw">)</span><span class="dv">$</span><span class="vs">"</span>)</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Text(0, 0.5, '$\\gamma(h)$')</span></span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Fitted Variogram Model"</span>)</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Text(0.5, 1.0, 'Fitted Variogram Model')</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>)</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;matplotlib.legend.Legend object at 0x7f41d0401fd0&gt;</span></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>plt.show() <span class="co"># </span><span class="al">TBD</span><span class="co">: note the negative nugget!</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="12-Interpolation_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>shown by the solid line in <a href="#fig-fitvariogrammodel" class="quarto-xref">Figure&nbsp;<span>12.5</span></a>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit.variogram_ml</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span>, <span class="va">init</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">init</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"sf"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">formula</span>, <span class="st">"formula"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">init</span>, <span class="st">"variogramModel"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">init</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="st">"Nug"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">init</span><span class="op">$</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># convert from parameter vector to "variogramModel" class:</span></span>
<span>  <span class="co"># x is c(sill, range) or: c(sill, range, nugget)</span></span>
<span>  <span class="va">get_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">model</span>, <span class="va">min_range</span> <span class="op">=</span> <span class="fl">1e-10</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sill</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">min_range</span><span class="op">)</span></span>
<span>    <span class="va">nugget</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span></span>
<span>            <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span>      <span class="kw">else</span></span>
<span>            <span class="fl">0.</span></span>
<span>    <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/vgm.html">vgm</a></span><span class="op">(</span><span class="va">sill</span>, <span class="va">model</span>, <span class="va">range</span>, <span class="va">nugget</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># with A &lt;- chol(Q), solve Q x = b for x:</span></span>
<span>  <span class="va">ch_solve</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span>, <span class="va">b</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/backsolve.html">backsolve</a></span><span class="op">(</span><span class="va">A</span>, <span class="fu"><a href="https://rdrr.io/r/base/backsolve.html">forwardsolve</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">b</span>, upper.tri <span class="op">=</span> <span class="cn">TRUE</span>, transpose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># negative log likelihood, excluding the constant:</span></span>
<span>  <span class="va">nll</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">d</span>, <span class="va">res</span>, <span class="va">model</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu">get_model</span><span class="op">(</span><span class="va">x</span>, <span class="va">model</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogramLine.html">variogramLine</a></span><span class="op">(</span><span class="va">m</span>, dist_vector <span class="op">=</span> <span class="va">d</span>, covariance <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">Qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chol.html">chol</a></span><span class="op">(</span><span class="va">Q</span><span class="op">)</span></span>
<span>    <span class="va">det</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">Qc</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">det</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu">ch_solve</span><span class="op">(</span><span class="va">Qc</span>, <span class="va">res</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># distance matrix, for optim stability rescaled to [0,1] range</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_distance</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/drop_units.html">drop_units</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">max_d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op">/</span> <span class="va">max_d</span></span>
<span>  <span class="co"># residuals y - X beta: scale to sd 1</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">init</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">o.init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">init</span><span class="op">$</span><span class="va">psill</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">init</span><span class="op">$</span><span class="va">range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">init</span><span class="op">$</span><span class="va">psill</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">init</span><span class="op">$</span><span class="va">model</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">o.init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">init</span><span class="op">$</span><span class="va">psill</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">init</span><span class="op">$</span><span class="va">range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">init</span><span class="op">$</span><span class="va">model</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">o.init</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">o.init</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="va">max_d</span> <span class="co"># scale to [0,1]</span></span>
<span>  <span class="va">o.init</span><span class="op">[</span><span class="op">-</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">o.init</span><span class="op">[</span><span class="op">-</span><span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="va">v</span>   <span class="co"># scale to sd 1</span></span>
<span>  <span class="va">o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="va">o.init</span>, <span class="va">nll</span>, d <span class="op">=</span> <span class="va">d</span>, res <span class="op">=</span> <span class="va">res</span>, model <span class="op">=</span> <span class="va">model</span>, </span>
<span>            lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">o.init</span><span class="op">)</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>, <span class="va">...</span><span class="op">)</span><span class="op">$</span><span class="va">par</span></span>
<span>  <span class="va">o</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">o</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">max_d</span> <span class="co"># scale back to distance units</span></span>
<span>  <span class="va">o</span><span class="op">[</span><span class="op">-</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">o</span><span class="op">[</span><span class="op">-</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">v</span> <span class="co"># scale back to variance v</span></span>
<span>  <span class="fu">get_model</span><span class="op">(</span><span class="va">o</span>, <span class="va">model</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># use WLS fit model v.m for initial parameters:</span></span>
<span><span class="va">v.ml</span> <span class="op">&lt;-</span> <span class="fu">fit.variogram_ml</span><span class="op">(</span><span class="va">NO2</span><span class="op">~</span><span class="fl">1</span>, <span class="va">no2.sf</span>, <span class="va">v.m</span><span class="op">)</span></span>
<span><span class="co"># plot(v, v.ml, plot.numbers = TRUE)</span></span>
<span><span class="co"># plot(v, v.m, plot.numbers = TRUE) ## draws a single model; draw 2 models in single plot:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>xaxs <span class="op">=</span> <span class="st">"i"</span>, yaxs <span class="op">=</span> <span class="st">"i"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">gamma</span> <span class="op">~</span> <span class="va">dist</span>, <span class="va">v</span>, </span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.075</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">v</span><span class="op">$</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.05</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">v</span><span class="op">$</span><span class="va">gamma</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"distance h [m]"</span>, ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">gamma</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogramLine.html">variogramLine</a></span><span class="op">(</span><span class="va">v.m</span>, <span class="fl">1.075</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">v</span><span class="op">$</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">'blue'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogramLine.html">variogramLine</a></span><span class="op">(</span><span class="va">v.ml</span>, <span class="fl">1.075</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">v</span><span class="op">$</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'blue'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">v</span><span class="op">$</span><span class="va">dist</span>, <span class="va">v</span><span class="op">$</span><span class="va">gamma</span>, <span class="va">v</span><span class="op">$</span><span class="va">np</span>, pos <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-fitvariogrammodel" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-fitvariogrammodel-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-fitvariogrammodel-3.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fitvariogrammodel-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.5: Sample variogram (circles) with models fitted using weighted least squares (solid line) and maximum likelihood estimation (dashed line)
</figcaption></figure>
</div>
</div>
</div>
<p>The fitting for the drawn line was done by weighted least squares, minimising <span id="eq-wlsweights"><span class="math display">\[
\sum_{i=1}^{n}w_i(\gamma(h_i)-\hat{\gamma}(h_i))^2,
\tag{12.2}\]</span></span> with weights <span class="math inline">\(w_i\)</span> by default equal to <span class="math inline">\(N(h_i)/h^2\)</span>. Other weight options are available through argument <code>fit.method</code>.</p>
<p></p>
<p>As an alternative to weighted least squares fitting, one can use maximum likelihood (ML) or restricted maximum likelihood parameter estimation <span class="citation" data-cites="kitanidis1985maximum">(<a href="references.html#ref-kitanidis1985maximum" role="doc-biblioref">Kitanidis and Lane 1985</a>)</span>, which for this case leads to a relatively similar fitted model, shown as the dashed line in <a href="#fig-fitvariogrammodel" class="quarto-xref">Figure&nbsp;<span>12.5</span></a>. An advantage of ML-type approaches is that they do not require choosing distance intervals <span class="math inline">\(h_i\)</span> in <a href="#eq-samplevariogram" class="quarto-xref">Equation&nbsp;<span>12.1</span></a> or weights <span class="math inline">\(w_i\)</span> in <a href="#eq-wlsweights" class="quarto-xref">Equation&nbsp;<span>12.2</span></a>. Disadvantages are that they lean on stronger assumptions of multivariate normally distributed data, and for larger datasets require iteratively solving linear systems of size equal to the number of observations; <span class="citation" data-cites="Heaton2018">Heaton et al. (<a href="references.html#ref-Heaton2018" role="doc-biblioref">2018</a>)</span> compare approaches dedicated to fitting models to large datasets.</p>
</section><section id="sec-kriging" class="level2" data-number="12.4"><h2 data-number="12.4" class="anchored" data-anchor-id="sec-kriging">
<span class="header-section-number">12.4</span> Kriging interpolation</h2>
<p> </p>
<p>Typically, when we interpolate a variable, we do that on points on a regular grid covering the target area. We first create a <code>stars</code> object with a raster covering the target area, and <code>NA</code>s outside it.</p>
<p>Kriging involves the prediction of <span class="math inline">\(Z(s_0)\)</span> at arbitrary locations <span class="math inline">\(s_0\)</span>. We can krige NO<span class="math inline">\(_2\)</span> by using <code><a href="https://r-spatial.github.io/gstat/reference/krige.html">gstat::krige</a></code>, with the model for the trend, the data, the prediction grid, and the variogram model as arguments (<a href="#fig-krigeovergermany" class="quarto-xref">Figure&nbsp;<span>12.6</span></a>) by:</p>
<p></p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-12-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-1" role="tab" aria-controls="tabset-12-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-12-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-2" role="tab" aria-controls="tabset-12-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-12-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-12-1-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/krige.html">krige</a></span><span class="op">(</span><span class="va">NO2</span><span class="op">~</span><span class="fl">1</span>, <span class="va">no2.sf</span>, <span class="va">grd</span>, <span class="va">v.m</span><span class="op">)</span></span>
<span><span class="co"># [using ordinary kriging]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">k</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">var1.pred</span>, x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="va">de</span>, <span class="st">"MULTILINESTRING"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">no2.sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>lims_method <span class="op">=</span> <span class="st">"geometry_bbox"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-krigeovergermany" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-krigeovergermany-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-krigeovergermany-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-krigeovergermany-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.6: Kriged NO<span class="math inline">\(_2\)</span> concentrations over Germany
</figcaption></figure>
</div>
</div>
</div>
</div>
<div id="tabset-12-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-12-2-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pykrige.ok <span class="im">import</span> OrdinaryKriging</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract coordinates and values from observed data</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>data_points_x <span class="op">=</span> no2_sf.geometry.x.values</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>data_points_y <span class="op">=</span> no2_sf.geometry.y.values</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> no2_sf[<span class="st">"NO2"</span>].values</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate grid coordinates for interpolation</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>grid_x, grid_y <span class="op">=</span> np.meshgrid(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    np.linspace(grid_gdf.total_bounds[<span class="dv">0</span>], grid_gdf.total_bounds[<span class="dv">2</span>], <span class="dv">100</span>),</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    np.linspace(grid_gdf.total_bounds[<span class="dv">1</span>], grid_gdf.total_bounds[<span class="dv">3</span>], <span class="dv">100</span>),</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>fitted_sill <span class="op">=</span> fitted_sill <span class="op">*</span> <span class="dv">3</span> <span class="co"># see docs of variogram_model in pykrige</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the ordinary kriging model</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>ok <span class="op">=</span> OrdinaryKriging(</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    data_points_x,</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    data_points_y,</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    values,</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    variogram_model<span class="op">=</span><span class="st">"exponential"</span>,  <span class="co"># Use the exponential model</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    variogram_parameters<span class="op">=</span>{<span class="st">"sill"</span>: fitted_sill, <span class="st">"range"</span>: fitted_range, <span class="st">"nugget"</span>: fitted_nugget},</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform kriging interpolation on the grid</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>z, ss <span class="op">=</span> ok.execute(<span class="st">"grid"</span>, grid_x[<span class="dv">0</span>], grid_y[:, <span class="dv">0</span>])  <span class="co"># z: predicted values, ss: standard error</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> Normalize</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the kriging results</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the kriging predictions</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> ax.pcolormesh(</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    grid_x, grid_y, z, shading<span class="op">=</span><span class="st">"auto"</span>, cmap<span class="op">=</span><span class="st">"viridis"</span>,</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    norm<span class="op">=</span>Normalize(vmin<span class="op">=</span>np.nanmin(z), vmax<span class="op">=</span>np.nanmax(z))</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>plt.colorbar(c, ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">"Kriged NO2 Predictions"</span>)</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;matplotlib.colorbar.Colorbar object at 0x7f41d022c050&gt;</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay country boundaries as multilinestrings</span></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>de.boundary.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;Axes: &gt;</span></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay measurement points</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>no2_sf.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"red"</span>, markersize<span class="op">=</span><span class="dv">5</span>, label<span class="op">=</span><span class="st">"Measurement Points"</span>)</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;Axes: &gt;</span></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Set axis labels and title</span></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">""</span>)</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Text(0.5, 80.7222222222222, '')</span></span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">""</span>)</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Text(137.6366087992258, 0.5, '')</span></span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Kriged NO2 Predictions"</span>)</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Text(0.5, 1.0, 'Kriged NO2 Predictions')</span></span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;matplotlib.legend.Legend object at 0x7f41d045a0d0&gt;</span></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="12-Interpolation_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section><section id="sec-blockkriging" class="level2" data-number="12.5"><h2 data-number="12.5" class="anchored" data-anchor-id="sec-blockkriging">
<span class="header-section-number">12.5</span> Areal means: block kriging</h2>
<p> </p>
<p>Computing areal means can be done in several ways. The simplest is to take the average of point samples falling inside the target polygons:</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-13-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-1" role="tab" aria-controls="tabset-13-1" aria-selected="true" href="">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-13-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-2" role="tab" aria-controls="tabset-13-2" aria-selected="false" href="">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-13-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-13-1-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">no2.sf</span><span class="op">[</span><span class="st">"NO2"</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">de</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-13-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-13-2-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatially join the NO2 points with the regions in 'de'</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>joined <span class="op">=</span> gpd.sjoin(no2_sf, de, how<span class="op">=</span><span class="st">"inner"</span>, predicate<span class="op">=</span><span class="st">"within"</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean NO2 value for each region</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>region_means <span class="op">=</span> joined.groupby(<span class="st">"index_right"</span>)[<span class="st">"NO2"</span>].mean().reset_index()</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the computed mean NO2 values back to the 'de' GeoDataFrame</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>de[<span class="st">"NO2_mean"</span>] <span class="op">=</span> region_means[<span class="st">"NO2"</span>]</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>de.NO2_mean  </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 0      8.135623</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 1     10.018981</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 2     12.203338</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 3      6.542402</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 4      9.150268</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 5      5.920487</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 6      9.211080</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 7     11.833104</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 8      6.411625</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 9      9.226796</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 10     8.727092</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 11     5.904579</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 12     7.141790</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 13     5.778018</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 14          NaN</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 15          NaN</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Name: NO2_mean, dtype: float64</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
<p>A more complicated way is to use <em>block kriging</em> <span class="citation" data-cites="jh78">(<a href="references.html#ref-jh78" role="doc-biblioref">Journel and Huijbregts 1978</a>)</span>, which uses <em>all</em> the data to estimate the mean of the variable over the target areas. With <code>krige</code>, this can be done by giving the target areas (polygons) as the <code>newdata</code> argument:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/krige.html">krige</a></span><span class="op">(</span><span class="va">NO2</span><span class="op">~</span><span class="fl">1</span>, <span class="va">no2.sf</span>, <span class="va">de</span>, <span class="va">v.m</span><span class="op">)</span></span>
<span><span class="co"># [using ordinary kriging]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>we can now merge the two maps into a single object to create a single plot (<a href="#fig-aggregations" class="quarto-xref">Figure&nbsp;<span>12.7</span></a>):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">b</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">$</span><span class="va">NO2</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">kriging</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="va">var1.pred</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">b</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sample</span>, <span class="va">kriging</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, names_to <span class="op">=</span> <span class="st">"var"</span>, values_to <span class="op">=</span> <span class="st">"NO2"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">b2</span></span>
<span><span class="va">b2</span><span class="op">$</span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">b2</span><span class="op">$</span><span class="va">var</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample"</span>, <span class="st">"kriging"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">b2</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">NO2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">var</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span>colors <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">sf.colors</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div id="fig-aggregations" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-aggregations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-aggregations-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-aggregations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.7: Aggregated NO<span class="math inline">\(_2\)</span> values from simple averaging (left) and block kriging (right)
</figcaption></figure>
</div>
</div>
</div>
<p>We see that the signal is similar, but that the sample means from simple averaging are more variable than the block kriging values; this may be due to the smoothing effect of kriging: data points outside the aggregation area receive weight, too.</p>
<p></p>
<p>To compare the standard errors of means, for the sample mean we can get a rough guess of the standard error by <span class="math inline">\(\sqrt{(\sigma^2/n)}\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SE</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">no2.sf</span><span class="op">[</span><span class="st">"NO2"</span><span class="op">]</span>, <span class="va">de</span>, <span class="va">SE</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>which would have been the actual estimate in design-based inference (<a href="10-Models.html#sec-design" class="quarto-xref"><span>Section 10.4</span></a>) if the sample were obtained by spatially random sampling. The block kriging variance is the model-based estimate and is a by-product of kriging. We can compare the two in <a href="#fig-aggrSE" class="quarto-xref">Figure&nbsp;<span>12.8</span></a> where we see that the simple averaging approach gives more variability and mostly larger values for prediction errors of areal means, compared to block kriging.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">b</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">$</span><span class="va">NO2</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">kriging</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">var1.var</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sample</span>, <span class="va">kriging</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, names_to <span class="op">=</span> <span class="st">"var"</span>, </span>
<span>                     values_to <span class="op">=</span> <span class="st">"Standard_error"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">b2</span></span>
<span><span class="va">b2</span><span class="op">$</span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">b2</span><span class="op">$</span><span class="va">var</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample"</span>, <span class="st">"kriging"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">b2</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Standard_error</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">var</span>, as.table <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span>colors <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">sf.colors</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-aggrSE" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-aggrSE-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-aggrSE-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-aggrSE-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.8: Standard errors for mean NO<span class="math inline">\(_2\)</span> values obtained by simple averaging (left) and block kriging (right)
</figcaption></figure>
</div>
</div>
</div>
</section><section id="conditional-simulation" class="level2" data-number="12.6"><h2 data-number="12.6" class="anchored" data-anchor-id="conditional-simulation">
<span class="header-section-number">12.6</span> Conditional simulation</h2>
<p> </p>
<p>In case one or more conditional realisation of the field <span class="math inline">\(Z(s)\)</span> are needed rather than their conditional mean, we can obtain this by <em>conditional simulation</em>. A reason for wanting this may be the need to estimate areal mean values of <span class="math inline">\(g(Z(s))\)</span> with <span class="math inline">\(g(\cdot)\)</span> a non-linear function; a simple example is the areal fraction where <span class="math inline">\(Z(s)\)</span> exceeds a threshold.</p>
<p>The default approach used by <code>gstat</code> is to use the sequential simulation algorithm for this. This is a simple algorithm that randomly steps through the prediction locations and at each location:</p>
<ul>
<li>carries out a kriging prediction</li>
<li>draws a random variable from the normal distribution with mean and variance equal to the kriging variance</li>
<li>adds this value to the conditioning dataset</li>
<li>finds a new random simulation location</li>
</ul>
<p>until all locations have been visited.</p>
<p>This is carried out by <code><a href="https://r-spatial.github.io/gstat/reference/krige.html">gstat::krige</a></code> when <code>nsim</code> is set to a positive value:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">13341</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/krige.html">krige</a></span><span class="op">(</span><span class="va">NO2</span><span class="op">~</span><span class="fl">1</span>, <span class="va">no2.sf</span>, <span class="va">grd</span>, <span class="va">v.m</span>, nmax <span class="op">=</span> <span class="fl">30</span>, nsim <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># drawing 6 GLS realisations of beta...</span></span>
<span><span class="co"># [using conditional Gaussian simulation]</span></span>
<span><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co"># attribute(s):</span></span>
<span><span class="co">#       Min. 1st Qu. Median Mean 3rd Qu. Max.  NA's</span></span>
<span><span class="co"># var1  -5.7    6.12   8.68 8.88    11.5 23.9 12456</span></span>
<span><span class="co"># dimension(s):</span></span>
<span><span class="co">#        from to  offset  delta            refsys        values x/y</span></span>
<span><span class="co"># x         1 65  280741  10000 WGS 84 / UTM z...          NULL [x]</span></span>
<span><span class="co"># y         1 87 6101239 -10000 WGS 84 / UTM z...          NULL [y]</span></span>
<span><span class="co"># sample    1  6      NA     NA                NA sim1,...,sim6</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>where <code><a href="https://rdrr.io/r/base/Random.html">set.seed()</a></code> was called here to allow reproducibility.</p>
<p>It is usually needed to constrain the (maximum) number of nearest neighbours to include in kriging estimation by setting <code>nmax</code> because the dataset grows each step, leading otherwise quickly to very long computing times and large memory requirements. Resulting conditional simulations are shown in (<a href="#fig-plotkrigingvalues" class="quarto-xref">Figure&nbsp;<span>12.9</span></a>).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/">viridis</a></span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html">scale_fill_viridis</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">s</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">sample</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-plotkrigingvalues" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plotkrigingvalues-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-plotkrigingvalues-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plotkrigingvalues-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.9: Six conditional simulations for NO<span class="math inline">\(_2\)</span> values
</figcaption></figure>
</div>
</div>
</div>
<p>Alternative methods for conditional simulation have recently been added to <code>gstat</code>, and include <code>krigeSimCE</code> implementing the circular embedding method <span class="citation" data-cites="JSSv055i09">(<a href="references.html#ref-JSSv055i09" role="doc-biblioref">Davies and Bryant 2013</a>)</span>, and <code>krigeSTSimTB</code> implementing the turning bands method <span class="citation" data-cites="schlather">(<a href="references.html#ref-schlather" role="doc-biblioref">Schlather 2011</a>)</span>. These are of particular of interest for larger datasets or conditional simulations of spatiotemporal data.</p>
</section><section id="trend-models" class="level2" data-number="12.7"><h2 data-number="12.7" class="anchored" data-anchor-id="trend-models">
<span class="header-section-number">12.7</span> Trend models</h2>
<p></p>
<p>Kriging and conditional simulation, as used so far in this chapter, assume that all spatial variability is a random process, characterised by a spatial covariance model. In case we have other variables that are meaningfully correlated with the target variable, we can use them in a linear regression model for the trend, <span class="math display">\[
Z(s) = \sum_{j=0}^p \beta_j X_j(s) + e(s)
\]</span> with <span class="math inline">\(X_0(s) = 1\)</span> and <span class="math inline">\(\beta_0\)</span> an intercept, but with the other <span class="math inline">\(\beta_j\)</span> regression coefficients. Adding variables typically reduces both the spatial correlation in the residual <span class="math inline">\(e(s)\)</span>, as well as its variance, and leads to more accurate predictions and more similar conditional simulations. As an example, we will use population density to partly explain variation in NO<span class="math inline">\(_2\)</span>.</p>
<section id="a-population-grid" class="level3"><h3 class="anchored" data-anchor-id="a-population-grid">A population grid</h3>
<p></p>
<p>As a potential predictor for NO<span class="math inline">\(_2\)</span> in the air, we use population density. NO<span class="math inline">\(_2\)</span> is mostly caused by traffic, and traffic is more intense in densely populated areas. Population density is obtained from the <a href="https://www.zensus2011.de/DE/Home/Aktuelles/DemografischeGrunddaten.html">2011 census</a> and is downloaded as a csv file with the number of inhabitants per 100 m <span class="math inline">\(\times\)</span> 100 m grid cell. We can aggregate these data to the target grid cells by summing the inhabitants:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op">(</span><span class="st">"aq/pop/Zensus_Bevoelkerung_100m-Gitter.csv"</span><span class="op">)</span></span>
<span><span class="va">v</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Einwohner</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Gitter_ID_100m</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x_mp_100m"</span>, <span class="st">"y_mp_100m"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">3035</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">grd</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">b</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">b</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">grd</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we have the population counts per grid cell in <code>a</code>. To get to population density, we need to find the area of each cell; for cells crossing the country border, this will be less than 10 <span class="math inline">\(\times\)</span> 10 km:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grd</span><span class="op">$</span><span class="va">ID</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/prod.html">prod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">grd</span><span class="op">)</span><span class="op">)</span> <span class="co"># to identify grid cells</span></span>
<span><span class="va">ii</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">grd</span><span class="op">[</span><span class="st">"ID"</span><span class="op">]</span>,</span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="va">de</span><span class="op">)</span>, <span class="st">"MULTILINESTRING"</span><span class="op">)</span>, as_points <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">grd_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">grd</span><span class="op">[</span><span class="st">"ID"</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html">lengths</a></span><span class="op">(</span><span class="va">ii</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_agr.html">st_agr</a></span><span class="op">(</span><span class="va">grd_sf</span><span class="op">)</span> <span class="op">=</span> <span class="st">"identity"</span></span>
<span><span class="va">iii</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">grd_sf</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="va">de</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">grd</span><span class="op">$</span><span class="va">area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">grd</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> </span>
<span>    <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">grd</span><span class="op">$</span><span class="va">values</span>, <span class="va">m</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">grd</span><span class="op">$</span><span class="va">area</span><span class="op">[</span><span class="va">iii</span><span class="op">$</span><span class="va">ID</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">iii</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Instead of doing the two-stage procedure above, first finding cells that have a border crossing it then computing its area, we could also directly use <code>st_intersection</code> on all cells, but that takes considerably longer. From the counts and areas we can compute densities (<a href="#fig-popdens" class="quarto-xref">Figure&nbsp;<span>12.10</span></a>) and verify totals</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grd</span><span class="op">$</span><span class="va">pop_dens</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">$</span><span class="va">Einwohner</span> <span class="op">/</span> <span class="va">grd</span><span class="op">$</span><span class="va">area</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">grd</span><span class="op">$</span><span class="va">pop_dens</span> <span class="op">*</span> <span class="va">grd</span><span class="op">$</span><span class="va">area</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># verify</span></span>
<span><span class="co"># 80323301 [1]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">Einwohner</span><span class="op">)</span></span>
<span><span class="co"># [1] 0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>which indicates strong agreement. Using <code>st_interpolate_aw</code> would have given an exact match.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">grd</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">pop_dens</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-popdens" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-popdens-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-popdens-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-popdens-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.10: Population density for 100 m <span class="math inline">\(\times\)</span> 100 m grid cells
</figcaption></figure>
</div>
</div>
</div>
<p>We need to divide the number of inhabitants by the number of 100 m <span class="math inline">\(\times\)</span> 100 m grid cells contributing to it, in order to convert population counts into population density.</p>
<p> To obtain population density values at monitoring network stations, we can use <code>st_extract</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grd</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"pop_dens"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op">(</span><span class="va">no2.sf</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="st">"pop_dens"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">no2.sf</span>, pop_dens <span class="op">=</span> <span class="va">_</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">no2.sf</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can then investigate the linear relationship between NO<span class="math inline">\(_2\)</span> and population density at monitoring station locations:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">NO2</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">pop_dens</span><span class="op">)</span>, <span class="va">no2.sf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = NO2 ~ sqrt(pop_dens), data = no2.sf)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#    Min     1Q Median     3Q    Max </span></span>
<span><span class="co"># -7.990 -2.052 -0.505  1.610  8.095 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#                Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># (Intercept)       4.537      0.685    6.62  5.5e-09 ***</span></span>
<span><span class="co"># sqrt(pop_dens)  326.154     49.366    6.61  5.8e-09 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 3.13 on 72 degrees of freedom</span></span>
<span><span class="co"># Multiple R-squared:  0.377,   Adjusted R-squared:  0.369 </span></span>
<span><span class="co"># F-statistic: 43.7 on 1 and 72 DF,  p-value: 5.82e-09</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>for which the corresponding scatterplot is shown in <a href="#fig-no2scat" class="quarto-xref">Figure&nbsp;<span>12.11</span></a>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">NO2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">pop_dens</span><span class="op">)</span>, <span class="va">no2.sf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">NO2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">pop_dens</span><span class="op">)</span>, <span class="va">no2.sf</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-no2scat" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-no2scat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-no2scat-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-no2scat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.11: Scatter plot of 2017 annual mean NO<span class="math inline">\(_2\)</span> concentration against population density, for rural background air quality stations
</figcaption></figure>
</div>
</div>
</div>
<p> Prediction under this new model involves first modelling a residual variogram</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">no2.sf</span> <span class="op">&lt;-</span> <span class="va">no2.sf</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">no2.sf</span><span class="op">$</span><span class="va">pop_dens</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">vr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogram.html">variogram</a></span><span class="op">(</span><span class="va">NO2</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">pop_dens</span><span class="op">)</span>, <span class="va">no2.sf</span><span class="op">)</span></span>
<span><span class="va">vr.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/fit.variogram.html">fit.variogram</a></span><span class="op">(</span><span class="va">vr</span>, <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/vgm.html">vgm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"Exp"</span>, <span class="fl">50000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">vr</span>, <span class="va">vr.m</span>, plot.numbers <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-predictusingpopulationdensity" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-predictusingpopulationdensity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-predictusingpopulationdensity-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-predictusingpopulationdensity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.12: Residual variogram after subtracting population density trend
</figcaption></figure>
</div>
</div>
</div>
<p>which is shown in <a href="#fig-predictusingpopulationdensity" class="quarto-xref">Figure&nbsp;<span>12.12</span></a>. Subsequently, kriging prediction (<a href="#fig-residualkriging" class="quarto-xref">Figure&nbsp;<span>12.13</span></a>) is done by</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">kr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/krige.html">krige</a></span><span class="op">(</span><span class="va">NO2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">pop_dens</span><span class="op">)</span>, <span class="va">no2.sf</span>, </span>
<span>            <span class="va">grd</span><span class="op">[</span><span class="st">"pop_dens"</span><span class="op">]</span>, <span class="va">vr.m</span><span class="op">)</span></span>
<span><span class="co"># [using universal kriging]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">k</span><span class="op">$</span><span class="va">kr1</span> <span class="op">&lt;-</span> <span class="va">k</span><span class="op">$</span><span class="va">var1.pred</span></span>
<span><span class="va">k</span><span class="op">$</span><span class="va">kr2</span> <span class="op">&lt;-</span> <span class="va">kr</span><span class="op">$</span><span class="va">var1.pred</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/redimension.html">st_redimension</a></span><span class="op">(</span><span class="va">k</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"kr1"</span>, <span class="st">"kr2"</span><span class="op">)</span><span class="op">]</span>, </span>
<span>    along <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>what <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"kriging"</span>, <span class="st">"residual kriging"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"NO2"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">km</span></span>
<span><span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">km</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">NO2</span>, x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="va">de</span>, <span class="st">"MULTILINESTRING"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">no2.sf</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">what</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>lims_method <span class="op">=</span> <span class="st">"geometry_bbox"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-residualkriging" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-residualkriging-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12-Interpolation_files/figure-html/fig-residualkriging-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-residualkriging-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.13: Kriging NO<span class="math inline">\(_2\)</span> values using population density as a trend variable
</figcaption></figure>
</div>
</div>
</div>
<p>where, critically, the <code>pop_dens</code> values are now available for prediction locations in the <code>newdata</code> object <code>grd</code>.</p>
<p>Compared to (ordinary) kriging We see some clear differences: the map using population density in the trend follows the extremes of the population density rather than those of the measurement stations, and has a value range that extends that of ordinary kriging. It should be taken with a large grain of salt however, since the stations used were filtered for the category â€œrural backgroundâ€, indicating that they only represent conditions of lower populations density. The scatter-plot of <a href="#fig-no2scat" class="quarto-xref">Figure&nbsp;<span>12.11</span></a> reveals that the the population density at the locations of stations is much more limited than that in the population density map, and hence the right-hand side map is based on strongly extrapolating the relationship shown in <a href="#fig-no2scat" class="quarto-xref">Figure&nbsp;<span>12.11</span></a>.</p>
</section></section><section id="exercises" class="level2" data-number="12.8"><h2 data-number="12.8" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">12.8</span> Exercises</h2>
<ol type="1">
<li>Create a plot like the one in <a href="#fig-residualkriging" class="quarto-xref">Figure&nbsp;<span>12.13</span></a> that has the inverse distance interpolated map of <a href="#fig-idw" class="quarto-xref">Figure&nbsp;<span>12.2</span></a> added on the left side.</li>
<li>Create a scatter-plot of the map values of the idw and kriging map, and a scatter-plot of map values of idw and residual kriging.</li>
<li>Carry out a <em>block kriging</em>, predicting block averages for blocks centred over grid cells, by setting the <code>block</code> argument in <code><a href="https://r-spatial.github.io/gstat/reference/krige.html">krige()</a></code>, and do this for block sizes of 10 km (grid cell size), 50 km, and 200 km. Compare the resulting maps of estimates for these three block sizes with those obtained by point kriging, and do the same thing for all associated kriging standard errors.</li>
<li>Based on the residual kriging results obtained above, compute maps of the lower and upper boundary of a 95% confidence interval, when assuming that the kriging error is normally distributed, and show them in a plot with a single (joint) legend.</li>
<li>Compute and show the map with the probabilities that NO<span class="math inline">\(_2\)</span> point values exceed the level of 15 ppm, assuming normally distributed kriging errors.</li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-blangiardo2015spatial" class="csl-entry" role="listitem">
Blangiardo, Marta, and Michela Cameletti. 2015. <em>Spatial and Spatio-Temporal Bayesian Models with r-INLA</em>. John Wiley &amp; Sons.
</div>
<div id="ref-JSSv055i09" class="csl-entry" role="listitem">
Davies, Tilman, and David Bryant. 2013. <span>â€œOn Circulant Embedding for Gaussian Random Fields in <span>R</span>.â€</span> <em>Journal of Statistical Software, Articles</em> 55 (9): 1â€“21. <a href="https://doi.org/10.18637/jss.v055.i09">https://doi.org/10.18637/jss.v055.i09</a>.
</div>
<div id="ref-Diggle:2007" class="csl-entry" role="listitem">
Diggle, P. J., and P. J. Ribeiro Jr. 2007. <em>Model-Based Geostatistics</em>. New York: Springer.
</div>
<div id="ref-DiggleTawnMoyeed:98" class="csl-entry" role="listitem">
Diggle, P. J., J. A. Tawn, and R. A. Moyeed. 1998. <span>â€œModel-Based Geostatistics.â€</span> <em>Applied Statistics</em>, 299â€“350.
</div>
<div id="ref-Heaton2018" class="csl-entry" role="listitem">
Heaton, Matthew J., Abhirup Datta, Andrew O. Finley, Reinhard Furrer, Joseph Guinness, Rajarshi Guhaniyogi, Florian Gerber, et al. 2018. <span>â€œA Case Study Competition Among Methods for Analyzing Large Spatial Data.â€</span> <em>Journal of Agricultural, Biological and Environmental Statistics</em>, December. <a href="https://doi.org/10.1007/s13253-018-00348-w">https://doi.org/10.1007/s13253-018-00348-w</a>.
</div>
<div id="ref-jh78" class="csl-entry" role="listitem">
Journel, Andre G., and Charles J. Huijbregts. 1978. <em>Mining Geostatistics</em>. Academic Press, London.
</div>
<div id="ref-kitanidis1985maximum" class="csl-entry" role="listitem">
Kitanidis, Peter K., and Robert W. Lane. 1985. <span>â€œMaximum Likelihood Parameter Estimation of Hydrologic Spatial Processes by the Gauss-Newton Method.â€</span> <em>Journal of Hydrology</em> 79 (1-2): 53â€“71. <a href="https://doi.org/10.1016/0022-1694(85)90181-7">https://doi.org/10.1016/0022-1694(85)90181-7</a>.
</div>
<div id="ref-gstatcg" class="csl-entry" role="listitem">
Pebesma, Edzer. 2004. <span>â€œMultivariable Geostatistics in <span>S</span>: The Gstat Package.â€</span> <em>Computers &amp; Geosciences</em> 30: 683â€“91.
</div>
<div id="ref-R-gstat" class="csl-entry" role="listitem">
Pebesma, Edzer, and Benedikt Graeler. 2022. <em>Gstat: Spatial and Spatio-Temporal Geostatistical Modelling, Prediction and Simulation</em>. <a href="https://github.com/r-spatial/gstat/">https://github.com/r-spatial/gstat/</a>.
</div>
<div id="ref-schlather" class="csl-entry" role="listitem">
Schlather, Martin. 2011. <span>â€œConstruction of Covariance Functions and Unconditional Simulation of Random Fields.â€</span> In <em>Space-Time Processes and Challenges Related to Environmental Problems</em>, edited by E. Porcu, Montero J. M., and M. Schlather. New York: Springer.
</div>
<div id="ref-wikle2019spatio" class="csl-entry" role="listitem">
Wikle, Christopher K, Andrew Zammit-Mangion, and Noel Cressie. 2019. <em>Spatio-Temporal Statistics with <span>R</span></em>. CRC Press.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/r-spatial\.org\/python\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./11-PointPattern.html" class="pagination-link" aria-label="Point Pattern Analysis">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Point Pattern Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./13-Geostatistics.html" class="pagination-link" aria-label="Multivariate and Spatiotemporal Geostatistics">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Spatial Interpolation {#sec-interpolation}</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>\index{spatial interpolation}</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>\index{interpolation}</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>Spatial interpolation is the activity of estimating values of spatially</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>continuous variables (fields) for spatial locations where they have not</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>been observed, based on observations.  The statistical methodology</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>for spatial interpolation, called geostatistics, is concerned with</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>the modelling, prediction, and simulation of spatially continuous</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>phenomena.  The typical problem is a missing value problem: we</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>observe a property of a phenomenon $Z(s)$ at a limited number</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>of sample locations $s_i, i = 1,...,n$, and are interested in</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>the property value at all locations $s_0$ covering an area of</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>interest, so we have to predict it for unobserved locations. This</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>is also called _kriging_, or Gaussian Process prediction.</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>In case $Z(s)$ contains a white noise component $\epsilon$, as in</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>$Z(s)=S(s)+\epsilon$ (possibly reflecting measurement error) an</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>alternative but similar goal is to predict or simulate $S(s)$ rather</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>than $Z(s)$, which may be called _spatial filtering_ or _smoothing_.</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>In this chapter we will show simple approaches for handling</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>geostatistical data, demonstrate simple interpolation methods,</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>and explore modelling spatial correlation, spatial prediction and</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>simulation. @sec-stgeostatistics focuses on more complex</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>multivariate and spatiotemporal geostatistical models.  We will</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>use package **gstat** <span class="co">[</span><span class="ot">@R-gstat; @gstatcg</span><span class="co">]</span>, which offers a fairly</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>wide palette of models and options for non-Bayesian geostatistical</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>analysis.  Bayesian methods with R implementations are found in</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>@DiggleTawnMoyeed:98, @Diggle:2007, @blangiardo2015spatial, and</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>@wikle2019spatio. An overview and comparison of methods for large</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>datasets is given in @Heaton2018.</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>\index{spatial autocorrelation in fields}</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, eval=FALSE}</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a><span class="co"># after running the "Spatiotemporal Geostatistics" chapter, write NO2 means by</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(<span class="fu">right_join</span>(a2, tb), <span class="st">"no2.csv"</span>)</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>CI <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">"CI"</span>) <span class="sc">==</span> <span class="st">"true"</span> <span class="co"># TRUE when inside GitHub Actions</span></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a><span class="fu">## A first dataset</span></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>We can read station mean NO$_2$ values, a dataset that is prepared </span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>in @sec-stgeostatistics, by loading it from package **gstat** using</span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="sc">|&gt;</span> <span class="fu">suppressPackageStartupMessages</span>()</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>no2 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">system.file</span>(<span class="st">"external/no2.csv"</span>, </span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">package =</span> <span class="st">"gstat"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>no2 <span class="op">=</span> pd.read_csv(<span class="st">"https://github.com/r-spatial/gstat/raw/main/inst/external/no2.csv"</span>)</span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a>and convert it into an <span class="in">`sf`</span> object with an appropriate UTM projection using</span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a>crs <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(<span class="st">"EPSG:32632"</span>)</span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a><span class="fu">st_as_sf</span>(no2, <span class="at">crs =</span> <span class="st">"OGC:CRS84"</span>, <span class="at">coords =</span> </span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"station_longitude_deg"</span>, <span class="st">"station_latitude_deg"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(crs) <span class="ot">-&gt;</span> no2.sf</span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyproj <span class="im">import</span> CRS</span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert NO2 data to GeoDataFrame and set coordinate reference systems</span></span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a>no2 <span class="op">=</span> gpd.GeoDataFrame(</span>
<span id="cb48-88"><a href="#cb48-88" aria-hidden="true" tabindex="-1"></a>    no2,</span>
<span id="cb48-89"><a href="#cb48-89" aria-hidden="true" tabindex="-1"></a>    geometry<span class="op">=</span>gpd.points_from_xy(no2[<span class="st">"station_longitude_deg"</span>], no2[<span class="st">"station_latitude_deg"</span>]),</span>
<span id="cb48-90"><a href="#cb48-90" aria-hidden="true" tabindex="-1"></a>    crs<span class="op">=</span><span class="st">"OGC:CRS84"</span></span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a>no2_sf <span class="op">=</span> no2.to_crs(CRS.from_epsg(<span class="dv">32632</span>))  <span class="co"># Transform to UTM (EPSG:32632)</span></span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a>Next, we can load country boundaries and plot these data using <span class="in">`ggplot`</span>, shown</span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a>in @fig-plotDE.</span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-100"><a href="#cb48-100" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-101"><a href="#cb48-101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot}</span></span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(<span class="st">"data/de_nuts1.gpkg"</span>) <span class="sc">|&gt;</span> <span class="fu">st_transform</span>(crs) <span class="ot">-&gt;</span> de</span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a>de <span class="op">=</span> gpd.read_file(<span class="st">"data/de_nuts1.gpkg"</span>)</span>
<span id="cb48-109"><a href="#cb48-109" aria-hidden="true" tabindex="-1"></a>de <span class="op">=</span> de.to_crs(CRS.from_epsg(<span class="dv">32632</span>))</span>
<span id="cb48-110"><a href="#cb48-110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-111"><a href="#cb48-111" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-112"><a href="#cb48-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-113"><a href="#cb48-113" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-114"><a href="#cb48-114" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-115"><a href="#cb48-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-plotDE, echo = !knitr::is_latex_output()}</span></span>
<span id="cb48-116"><a href="#cb48-116" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Mean NO$_2$ concentrations in air for rural background stations in Germany, in 2017"</span></span>
<span id="cb48-117"><a href="#cb48-117" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-118"><a href="#cb48-118" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="at">data =</span> de) <span class="sc">+</span> </span>
<span id="cb48-119"><a href="#cb48-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> no2.sf, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">col =</span> NO2))</span>
<span id="cb48-120"><a href="#cb48-120" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-121"><a href="#cb48-121" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-124"><a href="#cb48-124" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-125"><a href="#cb48-125" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-126"><a href="#cb48-126" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb48-127"><a href="#cb48-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-128"><a href="#cb48-128" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb48-129"><a href="#cb48-129" aria-hidden="true" tabindex="-1"></a>de.plot(ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">"black"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb48-130"><a href="#cb48-130" aria-hidden="true" tabindex="-1"></a>no2_sf.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">"NO2"</span>, legend<span class="op">=</span><span class="va">True</span>, cmap<span class="op">=</span><span class="st">"viridis"</span>)</span>
<span id="cb48-131"><a href="#cb48-131" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb48-132"><a href="#cb48-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-133"><a href="#cb48-133" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-134"><a href="#cb48-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-135"><a href="#cb48-135" aria-hidden="true" tabindex="-1"></a>\index{interpolation!target grid}</span>
<span id="cb48-136"><a href="#cb48-136" aria-hidden="true" tabindex="-1"></a>\index{st<span class="sc">\_</span>as<span class="sc">\_</span>stars!for generating a grid}</span>
<span id="cb48-137"><a href="#cb48-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-138"><a href="#cb48-138" aria-hidden="true" tabindex="-1"></a>If we want to interpolate, we first need to decide where. This</span>
<span id="cb48-139"><a href="#cb48-139" aria-hidden="true" tabindex="-1"></a>is typically done on a regular grid covering the area of</span>
<span id="cb48-140"><a href="#cb48-140" aria-hidden="true" tabindex="-1"></a>interest. Starting with the country outline in object <span class="in">`de`</span> we can</span>
<span id="cb48-141"><a href="#cb48-141" aria-hidden="true" tabindex="-1"></a>create a regular 10 km $\times$ 10 km grid over Germany by</span>
<span id="cb48-142"><a href="#cb48-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-143"><a href="#cb48-143" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-144"><a href="#cb48-144" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-145"><a href="#cb48-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{r buildgridgermany}</span></span>
<span id="cb48-146"><a href="#cb48-146" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars) <span class="sc">|&gt;</span> <span class="fu">suppressPackageStartupMessages</span>()</span>
<span id="cb48-147"><a href="#cb48-147" aria-hidden="true" tabindex="-1"></a><span class="fu">st_bbox</span>(de) <span class="sc">|&gt;</span></span>
<span id="cb48-148"><a href="#cb48-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_stars</span>(<span class="at">dx =</span> <span class="dv">10000</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-149"><a href="#cb48-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_crop</span>(de) <span class="ot">-&gt;</span> grd</span>
<span id="cb48-150"><a href="#cb48-150" aria-hidden="true" tabindex="-1"></a>grd</span>
<span id="cb48-151"><a href="#cb48-151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-152"><a href="#cb48-152" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-155"><a href="#cb48-155" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-156"><a href="#cb48-156" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-157"><a href="#cb48-157" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> box</span>
<span id="cb48-158"><a href="#cb48-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-159"><a href="#cb48-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Create bounding box of the country (Germany)</span></span>
<span id="cb48-160"><a href="#cb48-160" aria-hidden="true" tabindex="-1"></a>bounds <span class="op">=</span> de.total_bounds  <span class="co"># [minx, miny, maxx, maxy]</span></span>
<span id="cb48-161"><a href="#cb48-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-162"><a href="#cb48-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a 10 km x 10 km grid</span></span>
<span id="cb48-163"><a href="#cb48-163" aria-hidden="true" tabindex="-1"></a>x_coords <span class="op">=</span> np.arange(bounds[<span class="dv">0</span>], bounds[<span class="dv">2</span>], <span class="dv">10000</span>)  <span class="co"># 10,000 meters</span></span>
<span id="cb48-164"><a href="#cb48-164" aria-hidden="true" tabindex="-1"></a>y_coords <span class="op">=</span> np.arange(bounds[<span class="dv">1</span>], bounds[<span class="dv">3</span>], <span class="dv">10000</span>)</span>
<span id="cb48-165"><a href="#cb48-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-166"><a href="#cb48-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Create grid cells</span></span>
<span id="cb48-167"><a href="#cb48-167" aria-hidden="true" tabindex="-1"></a>grid_cells <span class="op">=</span> [</span>
<span id="cb48-168"><a href="#cb48-168" aria-hidden="true" tabindex="-1"></a>    box(x, y, x <span class="op">+</span> <span class="dv">10000</span>, y <span class="op">+</span> <span class="dv">10000</span>) <span class="cf">for</span> x <span class="kw">in</span> x_coords <span class="cf">for</span> y <span class="kw">in</span> y_coords</span>
<span id="cb48-169"><a href="#cb48-169" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb48-170"><a href="#cb48-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-171"><a href="#cb48-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop grid cells to the country boundary</span></span>
<span id="cb48-172"><a href="#cb48-172" aria-hidden="true" tabindex="-1"></a>grid_gdf <span class="op">=</span> gpd.GeoDataFrame(geometry<span class="op">=</span>grid_cells, crs<span class="op">=</span>de.crs)</span>
<span id="cb48-173"><a href="#cb48-173" aria-hidden="true" tabindex="-1"></a>grid_gdf <span class="op">=</span> gpd.overlay(grid_gdf, de, how<span class="op">=</span><span class="st">"intersection"</span>)  <span class="co"># Crop to country boundary</span></span>
<span id="cb48-174"><a href="#cb48-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-175"><a href="#cb48-175" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-176"><a href="#cb48-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-177"><a href="#cb48-177" aria-hidden="true" tabindex="-1"></a>Here, we chose grid cells not too fine, so that we still see</span>
<span id="cb48-178"><a href="#cb48-178" aria-hidden="true" tabindex="-1"></a>them in plots.</span>
<span id="cb48-179"><a href="#cb48-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-180"><a href="#cb48-180" aria-hidden="true" tabindex="-1"></a>Perhaps the simplest interpolation method is inverse distance weighted</span>
<span id="cb48-181"><a href="#cb48-181" aria-hidden="true" tabindex="-1"></a>interpolation, which is a weighted average, using weights inverse</span>
<span id="cb48-182"><a href="#cb48-182" aria-hidden="true" tabindex="-1"></a>proportional to distances from the interpolation location:</span>
<span id="cb48-183"><a href="#cb48-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-184"><a href="#cb48-184" aria-hidden="true" tabindex="-1"></a>\index{interpolation!inverse distance weighted}</span>
<span id="cb48-185"><a href="#cb48-185" aria-hidden="true" tabindex="-1"></a>\index{inverse distance weighted interpolation}</span>
<span id="cb48-186"><a href="#cb48-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-187"><a href="#cb48-187" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-188"><a href="#cb48-188" aria-hidden="true" tabindex="-1"></a>\hat{z}(s_0) = \frac{\sum_{i=1}^{n} w_i z(s_i)}{\sum_{i=1}^n w_i}</span>
<span id="cb48-189"><a href="#cb48-189" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-190"><a href="#cb48-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-191"><a href="#cb48-191" aria-hidden="true" tabindex="-1"></a>with $w_i = |s_0-s_i|^{-p}$, and the inverse distance power $p$ typically</span>
<span id="cb48-192"><a href="#cb48-192" aria-hidden="true" tabindex="-1"></a>taken as 2, or optimised using cross-validation. We can compute</span>
<span id="cb48-193"><a href="#cb48-193" aria-hidden="true" tabindex="-1"></a>inverse distance interpolated values using <span class="in">`gstat::idw`</span>, </span>
<span id="cb48-194"><a href="#cb48-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-195"><a href="#cb48-195" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-196"><a href="#cb48-196" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-197"><a href="#cb48-197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb48-198"><a href="#cb48-198" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gstat)</span>
<span id="cb48-199"><a href="#cb48-199" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="fu">idw</span>(NO2<span class="sc">~</span><span class="dv">1</span>, no2.sf, grd)</span>
<span id="cb48-200"><a href="#cb48-200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-201"><a href="#cb48-201" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-204"><a href="#cb48-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-205"><a href="#cb48-205" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial <span class="im">import</span> cKDTree</span>
<span id="cb48-206"><a href="#cb48-206" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-207"><a href="#cb48-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-208"><a href="#cb48-208" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inverse_distance_weighting(data_points, grid_points, values, power<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb48-209"><a href="#cb48-209" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb48-210"><a href="#cb48-210" aria-hidden="true" tabindex="-1"></a><span class="co">    Perform inverse distance weighting (IDW) interpolation.</span></span>
<span id="cb48-211"><a href="#cb48-211" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb48-212"><a href="#cb48-212" aria-hidden="true" tabindex="-1"></a>    tree <span class="op">=</span> cKDTree(data_points)</span>
<span id="cb48-213"><a href="#cb48-213" aria-hidden="true" tabindex="-1"></a>    distances, indices <span class="op">=</span> tree.query(grid_points, k<span class="op">=</span><span class="bu">len</span>(data_points))</span>
<span id="cb48-214"><a href="#cb48-214" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-215"><a href="#cb48-215" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> np.power(distances, power)</span>
<span id="cb48-216"><a href="#cb48-216" aria-hidden="true" tabindex="-1"></a>    weights[distances <span class="op">==</span> <span class="dv">0</span>] <span class="op">=</span> <span class="fl">1e12</span>  <span class="co"># Handle zero distances</span></span>
<span id="cb48-217"><a href="#cb48-217" aria-hidden="true" tabindex="-1"></a>    interpolated <span class="op">=</span> np.<span class="bu">sum</span>(weights <span class="op">*</span> values[indices], axis<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> np.<span class="bu">sum</span>(weights, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb48-218"><a href="#cb48-218" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> interpolated</span>
<span id="cb48-219"><a href="#cb48-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-220"><a href="#cb48-220" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data points and grid</span></span>
<span id="cb48-221"><a href="#cb48-221" aria-hidden="true" tabindex="-1"></a>data_points <span class="op">=</span> np.array(<span class="bu">list</span>(<span class="bu">zip</span>(no2_sf.geometry.x, no2_sf.geometry.y)))</span>
<span id="cb48-222"><a href="#cb48-222" aria-hidden="true" tabindex="-1"></a>grid_points <span class="op">=</span> np.array(<span class="bu">list</span>(<span class="bu">zip</span>(grid_gdf.geometry.centroid.x, grid_gdf.geometry.centroid.y)))</span>
<span id="cb48-223"><a href="#cb48-223" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> no2_sf[<span class="st">"NO2"</span>].values</span>
<span id="cb48-224"><a href="#cb48-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-225"><a href="#cb48-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform IDW</span></span>
<span id="cb48-226"><a href="#cb48-226" aria-hidden="true" tabindex="-1"></a>grid_gdf[<span class="st">"NO2_IDW"</span>] <span class="op">=</span> inverse_distance_weighting(data_points, grid_points, values)</span>
<span id="cb48-227"><a href="#cb48-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-228"><a href="#cb48-228" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-229"><a href="#cb48-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-230"><a href="#cb48-230" aria-hidden="true" tabindex="-1"></a>and plot them in @fig-idw.</span>
<span id="cb48-231"><a href="#cb48-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-232"><a href="#cb48-232" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-233"><a href="#cb48-233" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-234"><a href="#cb48-234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-idw, echo=!knitr::is_latex_output()}</span></span>
<span id="cb48-235"><a href="#cb48-235" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Inverse distance weighted interpolated values for NO$_2$ over Germany"</span></span>
<span id="cb48-236"><a href="#cb48-236" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-237"><a href="#cb48-237" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_stars</span>(<span class="at">data =</span> i, </span>
<span id="cb48-238"><a href="#cb48-238" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">aes</span>(<span class="at">fill =</span> var1.pred, <span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span> </span>
<span id="cb48-239"><a href="#cb48-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb48-240"><a href="#cb48-240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_cast</span>(de, <span class="st">"MULTILINESTRING"</span>)) <span class="sc">+</span> </span>
<span id="cb48-241"><a href="#cb48-241" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> no2.sf)</span>
<span id="cb48-242"><a href="#cb48-242" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-243"><a href="#cb48-243" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-246"><a href="#cb48-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-247"><a href="#cb48-247" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-248"><a href="#cb48-248" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb48-249"><a href="#cb48-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-250"><a href="#cb48-250" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot IDW interpolated values</span></span>
<span id="cb48-251"><a href="#cb48-251" aria-hidden="true" tabindex="-1"></a>grid_gdf.plot(</span>
<span id="cb48-252"><a href="#cb48-252" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">"NO2_IDW"</span>, cmap<span class="op">=</span><span class="st">"viridis"</span>, legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb48-253"><a href="#cb48-253" aria-hidden="true" tabindex="-1"></a>    legend_kwds<span class="op">=</span>{<span class="st">"label"</span>: <span class="st">"NO2 (IDW Interpolation)"</span>}</span>
<span id="cb48-254"><a href="#cb48-254" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-255"><a href="#cb48-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-256"><a href="#cb48-256" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay country boundaries</span></span>
<span id="cb48-257"><a href="#cb48-257" aria-hidden="true" tabindex="-1"></a>de.boundary.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb48-258"><a href="#cb48-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-259"><a href="#cb48-259" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay measurement points</span></span>
<span id="cb48-260"><a href="#cb48-260" aria-hidden="true" tabindex="-1"></a>no2_sf.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"red"</span>, markersize<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb48-261"><a href="#cb48-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-262"><a href="#cb48-262" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">""</span>)</span>
<span id="cb48-263"><a href="#cb48-263" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">""</span>)</span>
<span id="cb48-264"><a href="#cb48-264" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Inverse Distance Weighted Interpolation for NO2"</span>)</span>
<span id="cb48-265"><a href="#cb48-265" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb48-266"><a href="#cb48-266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-267"><a href="#cb48-267" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-268"><a href="#cb48-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-269"><a href="#cb48-269" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sample variogram </span></span>
<span id="cb48-270"><a href="#cb48-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-271"><a href="#cb48-271" aria-hidden="true" tabindex="-1"></a>\index{variogram!sample}</span>
<span id="cb48-272"><a href="#cb48-272" aria-hidden="true" tabindex="-1"></a>\index{sample variogram}</span>
<span id="cb48-273"><a href="#cb48-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-274"><a href="#cb48-274" aria-hidden="true" tabindex="-1"></a>In order to make spatial predictions using geostatistical methods, we first need to identify a model for the mean and for the spatial correlation. In the simplest model, $Z(s) = m + e(s)$, the mean is an unknown constant $m$, and in this case the spatial correlation can be modelled using the variogram, $\gamma(h) = 0.5 E (Z(s)-Z(s+h))^2$. For processes with a finite variance $C(0)$, the variogram is related to the covariogram or covariance function through $\gamma(h) = C(0)-C(h)$.</span>
<span id="cb48-275"><a href="#cb48-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-276"><a href="#cb48-276" aria-hidden="true" tabindex="-1"></a>The sample variogram is obtained by computing estimates of $\gamma(h)$ for distance intervals, $h_i = <span class="co">[</span><span class="ot">h_{i,0},h_{i,1}</span><span class="co">]</span>$:</span>
<span id="cb48-277"><a href="#cb48-277" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-278"><a href="#cb48-278" aria-hidden="true" tabindex="-1"></a>\hat{\gamma}(h_i) = \frac{1}{2N(h_i)}\sum_{j=1}^{N(h_i)}(z(s_i)-z(s_i+h'))^2, \ \ h_{i,0} \le h' &lt; h_{i,1}</span>
<span id="cb48-279"><a href="#cb48-279" aria-hidden="true" tabindex="-1"></a>$$ {#eq-samplevariogram}</span>
<span id="cb48-280"><a href="#cb48-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-281"><a href="#cb48-281" aria-hidden="true" tabindex="-1"></a>with $N(h_i)$ the number of sample pairs available for distance interval $h_i$.</span>
<span id="cb48-282"><a href="#cb48-282" aria-hidden="true" tabindex="-1"></a>Function <span class="in">`gstat::variogram`</span> computes sample variograms,</span>
<span id="cb48-283"><a href="#cb48-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-284"><a href="#cb48-284" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-285"><a href="#cb48-285" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-286"><a href="#cb48-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r computevariogram}</span></span>
<span id="cb48-287"><a href="#cb48-287" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">variogram</span>(NO2<span class="sc">~</span><span class="dv">1</span>, no2.sf)</span>
<span id="cb48-288"><a href="#cb48-288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-289"><a href="#cb48-289" aria-hidden="true" tabindex="-1"></a>and the result of plotting this is shown in @fig-vgm.</span>
<span id="cb48-290"><a href="#cb48-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-vgm, echo=!knitr::is_latex_output()}</span></span>
<span id="cb48-291"><a href="#cb48-291" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Sample variogram plot"</span></span>
<span id="cb48-292"><a href="#cb48-292" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-293"><a href="#cb48-293" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v, <span class="at">plot.numbers =</span> <span class="cn">TRUE</span>, <span class="at">xlab =</span> <span class="st">"distance h [m]"</span>,</span>
<span id="cb48-294"><a href="#cb48-294" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="fu">gamma</span>(h)),</span>
<span id="cb48-295"><a href="#cb48-295" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.055</span> <span class="sc">*</span> <span class="fu">max</span>(v<span class="sc">$</span>dist)))</span>
<span id="cb48-296"><a href="#cb48-296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-297"><a href="#cb48-297" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-300"><a href="#cb48-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-301"><a href="#cb48-301" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-302"><a href="#cb48-302" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial.distance <span class="im">import</span> pdist, squareform</span>
<span id="cb48-303"><a href="#cb48-303" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb48-304"><a href="#cb48-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-305"><a href="#cb48-305" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_variogram(data_points, values, bins):</span>
<span id="cb48-306"><a href="#cb48-306" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb48-307"><a href="#cb48-307" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute a sample variogram.</span></span>
<span id="cb48-308"><a href="#cb48-308" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb48-309"><a href="#cb48-309" aria-hidden="true" tabindex="-1"></a>    distances <span class="op">=</span> pdist(data_points)</span>
<span id="cb48-310"><a href="#cb48-310" aria-hidden="true" tabindex="-1"></a>    diffs <span class="op">=</span> pdist(values[:, <span class="va">None</span>], metric<span class="op">=</span><span class="st">"sqeuclidean"</span>)</span>
<span id="cb48-311"><a href="#cb48-311" aria-hidden="true" tabindex="-1"></a>    distances, diffs <span class="op">=</span> squareform(distances), squareform(diffs)</span>
<span id="cb48-312"><a href="#cb48-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-313"><a href="#cb48-313" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bin distances</span></span>
<span id="cb48-314"><a href="#cb48-314" aria-hidden="true" tabindex="-1"></a>    binned <span class="op">=</span> pd.cut(distances.flatten(), bins<span class="op">=</span>bins, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb48-315"><a href="#cb48-315" aria-hidden="true" tabindex="-1"></a>    gamma <span class="op">=</span> [</span>
<span id="cb48-316"><a href="#cb48-316" aria-hidden="true" tabindex="-1"></a>        np.mean(diffs.flatten()[binned <span class="op">==</span> i]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb48-317"><a href="#cb48-317" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(bins) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb48-318"><a href="#cb48-318" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb48-319"><a href="#cb48-319" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gamma, bins[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb48-320"><a href="#cb48-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-321"><a href="#cb48-321" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute variogram</span></span>
<span id="cb48-322"><a href="#cb48-322" aria-hidden="true" tabindex="-1"></a>bins <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">100000</span>, num<span class="op">=</span><span class="dv">10</span>)  <span class="co"># Define bins ## EJP: </span><span class="al">TBD</span><span class="co"> - num=15 and deal with empty bins!</span></span>
<span id="cb48-323"><a href="#cb48-323" aria-hidden="true" tabindex="-1"></a>data_points <span class="op">=</span> np.array(<span class="bu">list</span>(<span class="bu">zip</span>(no2_sf.geometry.x, no2_sf.geometry.y)))</span>
<span id="cb48-324"><a href="#cb48-324" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> no2_sf[<span class="st">"NO2"</span>].values</span>
<span id="cb48-325"><a href="#cb48-325" aria-hidden="true" tabindex="-1"></a>variogram, bin_centers <span class="op">=</span> compute_variogram(data_points, values, bins)</span>
<span id="cb48-326"><a href="#cb48-326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-327"><a href="#cb48-327" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-328"><a href="#cb48-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-329"><a href="#cb48-329" aria-hidden="true" tabindex="-1"></a>Function <span class="in">`variogram`</span> chooses default for maximum distance (<span class="in">`cutoff`</span>: one-third of the length of the bounding box diagonal) and (constant) interval widths (<span class="in">`width`</span>: cutoff divided by 15). These defaults can be changed by</span>
<span id="cb48-330"><a href="#cb48-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-331"><a href="#cb48-331" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-332"><a href="#cb48-332" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-333"><a href="#cb48-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r controlcutoff}</span></span>
<span id="cb48-334"><a href="#cb48-334" aria-hidden="true" tabindex="-1"></a>v0 <span class="ot">&lt;-</span> <span class="fu">variogram</span>(NO2<span class="sc">~</span><span class="dv">1</span>, no2.sf, <span class="at">cutoff =</span> <span class="dv">100000</span>, <span class="at">width =</span> <span class="dv">10000</span>)</span>
<span id="cb48-335"><a href="#cb48-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-336"><a href="#cb48-336" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-339"><a href="#cb48-339" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-340"><a href="#cb48-340" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_variogram_with_cutoff(data_points, values, bins):</span>
<span id="cb48-341"><a href="#cb48-341" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb48-342"><a href="#cb48-342" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute a sample variogram with a custom cutoff and bin width.</span></span>
<span id="cb48-343"><a href="#cb48-343" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb48-344"><a href="#cb48-344" aria-hidden="true" tabindex="-1"></a>    distances <span class="op">=</span> pdist(data_points)</span>
<span id="cb48-345"><a href="#cb48-345" aria-hidden="true" tabindex="-1"></a>    diffs <span class="op">=</span> pdist(values[:, <span class="va">None</span>], metric<span class="op">=</span><span class="st">"sqeuclidean"</span>)</span>
<span id="cb48-346"><a href="#cb48-346" aria-hidden="true" tabindex="-1"></a>    distances, diffs <span class="op">=</span> squareform(distances), squareform(diffs)</span>
<span id="cb48-347"><a href="#cb48-347" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-348"><a href="#cb48-348" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply cutoff</span></span>
<span id="cb48-349"><a href="#cb48-349" aria-hidden="true" tabindex="-1"></a>    valid <span class="op">=</span> distances <span class="op">&lt;</span> bins[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb48-350"><a href="#cb48-350" aria-hidden="true" tabindex="-1"></a>    distances <span class="op">=</span> distances[valid]</span>
<span id="cb48-351"><a href="#cb48-351" aria-hidden="true" tabindex="-1"></a>    diffs <span class="op">=</span> diffs[valid]</span>
<span id="cb48-352"><a href="#cb48-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-353"><a href="#cb48-353" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bin distances</span></span>
<span id="cb48-354"><a href="#cb48-354" aria-hidden="true" tabindex="-1"></a>    binned <span class="op">=</span> pd.cut(distances.flatten(), bins<span class="op">=</span>bins, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb48-355"><a href="#cb48-355" aria-hidden="true" tabindex="-1"></a>    gamma <span class="op">=</span> [</span>
<span id="cb48-356"><a href="#cb48-356" aria-hidden="true" tabindex="-1"></a>        np.mean(diffs.flatten()[binned <span class="op">==</span> i]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb48-357"><a href="#cb48-357" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(bins) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb48-358"><a href="#cb48-358" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb48-359"><a href="#cb48-359" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gamma, bins[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb48-360"><a href="#cb48-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-361"><a href="#cb48-361" aria-hidden="true" tabindex="-1"></a><span class="co"># Define bins with cutoff and width</span></span>
<span id="cb48-362"><a href="#cb48-362" aria-hidden="true" tabindex="-1"></a>bins <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="dv">100000</span> <span class="op">+</span> <span class="dv">10000</span>, <span class="dv">10000</span>)  <span class="co"># Lags of 10,000 meters up to 100,000</span></span>
<span id="cb48-363"><a href="#cb48-363" aria-hidden="true" tabindex="-1"></a>variogram_cutoff, bin_centers_cutoff <span class="op">=</span> compute_variogram_with_cutoff(data_points, values, bins)</span>
<span id="cb48-364"><a href="#cb48-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-365"><a href="#cb48-365" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it:</span></span>
<span id="cb48-366"><a href="#cb48-366" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb48-367"><a href="#cb48-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-368"><a href="#cb48-368" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot only the symbols (points) without a connecting line</span></span>
<span id="cb48-369"><a href="#cb48-369" aria-hidden="true" tabindex="-1"></a>ax.scatter(bin_centers_cutoff, variogram_cutoff, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"Sample Variogram"</span>)</span>
<span id="cb48-370"><a href="#cb48-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-371"><a href="#cb48-371" aria-hidden="true" tabindex="-1"></a><span class="co"># Set x-axis and y-axis limits to start at zero and include the cutoff</span></span>
<span id="cb48-372"><a href="#cb48-372" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="fl">1.055</span> <span class="op">*</span> bins[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb48-373"><a href="#cb48-373" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>)</span>
<span id="cb48-374"><a href="#cb48-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-375"><a href="#cb48-375" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels, title, and grid</span></span>
<span id="cb48-376"><a href="#cb48-376" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Distance h [m]"</span>)</span>
<span id="cb48-377"><a href="#cb48-377" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r"</span><span class="dv">$</span><span class="er">\</span><span class="vs">gamma</span><span class="kw">(</span><span class="vs">h</span><span class="kw">)</span><span class="dv">$</span><span class="vs">"</span>)</span>
<span id="cb48-378"><a href="#cb48-378" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Sample Variogram with Cutoff"</span>)</span>
<span id="cb48-379"><a href="#cb48-379" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>)</span>
<span id="cb48-380"><a href="#cb48-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-381"><a href="#cb48-381" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.legend()</span></span>
<span id="cb48-382"><a href="#cb48-382" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb48-383"><a href="#cb48-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-384"><a href="#cb48-384" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-385"><a href="#cb48-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-386"><a href="#cb48-386" aria-hidden="true" tabindex="-1"></a>shown in @fig-vgm2.</span>
<span id="cb48-387"><a href="#cb48-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-388"><a href="#cb48-388" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-389"><a href="#cb48-389" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-390"><a href="#cb48-390" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-vgm2, echo=!knitr::is_latex_output()}</span></span>
<span id="cb48-391"><a href="#cb48-391" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Sample variogram plot with adjusted cutoff and lag width"</span></span>
<span id="cb48-392"><a href="#cb48-392" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-393"><a href="#cb48-393" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v0, <span class="at">plot.numbers =</span> <span class="cn">TRUE</span>, <span class="at">xlab =</span> <span class="st">"distance h [m]"</span>,</span>
<span id="cb48-394"><a href="#cb48-394" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="fu">gamma</span>(h)),</span>
<span id="cb48-395"><a href="#cb48-395" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.055</span> <span class="sc">*</span> <span class="fu">max</span>(v0<span class="sc">$</span>dist)))</span>
<span id="cb48-396"><a href="#cb48-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-397"><a href="#cb48-397" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-400"><a href="#cb48-400" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-401"><a href="#cb48-401" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-402"><a href="#cb48-402" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb48-403"><a href="#cb48-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-404"><a href="#cb48-404" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot only the symbols (points) without a connecting line</span></span>
<span id="cb48-405"><a href="#cb48-405" aria-hidden="true" tabindex="-1"></a>ax.scatter(bin_centers_cutoff, variogram_cutoff, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"Sample Variogram"</span>)</span>
<span id="cb48-406"><a href="#cb48-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-407"><a href="#cb48-407" aria-hidden="true" tabindex="-1"></a><span class="co"># Set x-axis and y-axis limits to start at zero and include the cutoff</span></span>
<span id="cb48-408"><a href="#cb48-408" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="fl">1.055</span> <span class="op">*</span> bins[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb48-409"><a href="#cb48-409" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>)</span>
<span id="cb48-410"><a href="#cb48-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-411"><a href="#cb48-411" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels, title, and grid</span></span>
<span id="cb48-412"><a href="#cb48-412" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Distance h [m]"</span>)</span>
<span id="cb48-413"><a href="#cb48-413" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r"</span><span class="dv">$</span><span class="er">\</span><span class="vs">gamma</span><span class="kw">(</span><span class="vs">h</span><span class="kw">)</span><span class="dv">$</span><span class="vs">"</span>)</span>
<span id="cb48-414"><a href="#cb48-414" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Sample Variogram with Cutoff"</span>)</span>
<span id="cb48-415"><a href="#cb48-415" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>)</span>
<span id="cb48-416"><a href="#cb48-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-417"><a href="#cb48-417" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.legend()</span></span>
<span id="cb48-418"><a href="#cb48-418" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb48-419"><a href="#cb48-419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-420"><a href="#cb48-420" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-421"><a href="#cb48-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-422"><a href="#cb48-422" aria-hidden="true" tabindex="-1"></a>Note that the formula <span class="in">`NO2~1`</span> is used to select the variable of interest from the data file (<span class="in">`NO2`</span>), and to specify the mean model: <span class="in">`~1`</span> specifies an intercept-only (unknown, constant mean) model.</span>
<span id="cb48-423"><a href="#cb48-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-424"><a href="#cb48-424" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fitting variogram models</span></span>
<span id="cb48-425"><a href="#cb48-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-426"><a href="#cb48-426" aria-hidden="true" tabindex="-1"></a>\index{variogram!model}</span>
<span id="cb48-427"><a href="#cb48-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-428"><a href="#cb48-428" aria-hidden="true" tabindex="-1"></a>In order to progress towards spatial predictions, we need a variogram _model_ $\gamma(h)$ for (potentially) all distances $h$, rather than the set of estimates derived above. If we would connect these estimates with straight lines, or assume they reflect constant values over their respective distance intervals, it would lead to statistical models with non-positive definite covariance matrices, which would block using them in prediction.</span>
<span id="cb48-429"><a href="#cb48-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-430"><a href="#cb48-430" aria-hidden="true" tabindex="-1"></a>\index{variogram!model!WLS fitting}</span>
<span id="cb48-431"><a href="#cb48-431" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">function</span><span class="co">]</span>{fit.variogram}</span>
<span id="cb48-432"><a href="#cb48-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-433"><a href="#cb48-433" aria-hidden="true" tabindex="-1"></a>To avoid this, we fit parametric models $\gamma(h)$ to the estimates $\hat{\gamma}(h_i)$, where we take $h_i$ as the mean value of all the $h'$ values involved in estimating $\hat{\gamma}(h_i)$. We can fit for instance a model with an exponential variogram by</span>
<span id="cb48-434"><a href="#cb48-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-435"><a href="#cb48-435" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-436"><a href="#cb48-436" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-439"><a href="#cb48-439" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-440"><a href="#cb48-440" aria-hidden="true" tabindex="-1"></a>v.m <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(v, <span class="fu">vgm</span>(<span class="dv">1</span>, <span class="st">"Exp"</span>, <span class="dv">50000</span>, <span class="dv">1</span>))</span>
<span id="cb48-441"><a href="#cb48-441" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-442"><a href="#cb48-442" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-445"><a href="#cb48-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-446"><a href="#cb48-446" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> curve_fit</span>
<span id="cb48-447"><a href="#cb48-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-448"><a href="#cb48-448" aria-hidden="true" tabindex="-1"></a><span class="co"># Define exponential variogram model</span></span>
<span id="cb48-449"><a href="#cb48-449" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> exponential_model(h, sill, range_, nugget):</span>
<span id="cb48-450"><a href="#cb48-450" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nugget <span class="op">+</span> sill <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> np.exp(<span class="op">-</span>h <span class="op">/</span> range_))</span>
<span id="cb48-451"><a href="#cb48-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-452"><a href="#cb48-452" aria-hidden="true" tabindex="-1"></a><span class="co"># Define exponential variogram model without nugget:</span></span>
<span id="cb48-453"><a href="#cb48-453" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> exponential_model_zero_nugget(h, sill, range_):</span>
<span id="cb48-454"><a href="#cb48-454" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sill <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> np.exp(<span class="op">-</span>h <span class="op">/</span> range_))</span>
<span id="cb48-455"><a href="#cb48-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-456"><a href="#cb48-456" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial guesses for sill, range, and nugget</span></span>
<span id="cb48-457"><a href="#cb48-457" aria-hidden="true" tabindex="-1"></a>initial_guess <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">50000</span>, <span class="dv">1</span>]</span>
<span id="cb48-458"><a href="#cb48-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-459"><a href="#cb48-459" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the variogram model</span></span>
<span id="cb48-460"><a href="#cb48-460" aria-hidden="true" tabindex="-1"></a>params, _ <span class="op">=</span> curve_fit(</span>
<span id="cb48-461"><a href="#cb48-461" aria-hidden="true" tabindex="-1"></a>    exponential_model, bin_centers_cutoff, variogram_cutoff, </span>
<span id="cb48-462"><a href="#cb48-462" aria-hidden="true" tabindex="-1"></a>    p0<span class="op">=</span>initial_guess</span>
<span id="cb48-463"><a href="#cb48-463" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-464"><a href="#cb48-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-465"><a href="#cb48-465" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract fitted parameters</span></span>
<span id="cb48-466"><a href="#cb48-466" aria-hidden="true" tabindex="-1"></a>fitted_sill, fitted_range, fitted_nugget <span class="op">=</span> params</span>
<span id="cb48-467"><a href="#cb48-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-468"><a href="#cb48-468" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fitted_nugget <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb48-469"><a href="#cb48-469" aria-hidden="true" tabindex="-1"></a>    fitted_nugget <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Ensure nugget is non-negative</span></span>
<span id="cb48-470"><a href="#cb48-470" aria-hidden="true" tabindex="-1"></a>    params, _ <span class="op">=</span> curve_fit(</span>
<span id="cb48-471"><a href="#cb48-471" aria-hidden="true" tabindex="-1"></a>        exponential_model_zero_nugget, bin_centers_cutoff, variogram_cutoff, </span>
<span id="cb48-472"><a href="#cb48-472" aria-hidden="true" tabindex="-1"></a>        p0<span class="op">=</span>[fitted_sill, fitted_range]</span>
<span id="cb48-473"><a href="#cb48-473" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-474"><a href="#cb48-474" aria-hidden="true" tabindex="-1"></a>    fitted_sill, fitted_range <span class="op">=</span> params</span>
<span id="cb48-475"><a href="#cb48-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-476"><a href="#cb48-476" aria-hidden="true" tabindex="-1"></a><span class="co">## Plotted:</span></span>
<span id="cb48-477"><a href="#cb48-477" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate model curve</span></span>
<span id="cb48-478"><a href="#cb48-478" aria-hidden="true" tabindex="-1"></a>model_curve <span class="op">=</span> exponential_model(bin_centers_cutoff, fitted_sill, fitted_range, fitted_nugget)</span>
<span id="cb48-479"><a href="#cb48-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-480"><a href="#cb48-480" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb48-481"><a href="#cb48-481" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="bu">max</span>(bin_centers_cutoff) <span class="op">*</span> <span class="fl">1.05</span>)</span>
<span id="cb48-482"><a href="#cb48-482" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="bu">max</span>(variogram_cutoff) <span class="op">*</span> <span class="fl">1.05</span>)</span>
<span id="cb48-483"><a href="#cb48-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-484"><a href="#cb48-484" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot sample variogram points</span></span>
<span id="cb48-485"><a href="#cb48-485" aria-hidden="true" tabindex="-1"></a>ax.scatter(bin_centers_cutoff, variogram_cutoff, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"Sample Variogram"</span>)</span>
<span id="cb48-486"><a href="#cb48-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-487"><a href="#cb48-487" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot fitted variogram model</span></span>
<span id="cb48-488"><a href="#cb48-488" aria-hidden="true" tabindex="-1"></a>ax.plot(bin_centers_cutoff, model_curve, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"Fitted Model"</span>)</span>
<span id="cb48-489"><a href="#cb48-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-490"><a href="#cb48-490" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels, title, and grid</span></span>
<span id="cb48-491"><a href="#cb48-491" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Distance h [m]"</span>)</span>
<span id="cb48-492"><a href="#cb48-492" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r"</span><span class="dv">$</span><span class="er">\</span><span class="vs">gamma</span><span class="kw">(</span><span class="vs">h</span><span class="kw">)</span><span class="dv">$</span><span class="vs">"</span>)</span>
<span id="cb48-493"><a href="#cb48-493" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Fitted Variogram Model"</span>)</span>
<span id="cb48-494"><a href="#cb48-494" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>)</span>
<span id="cb48-495"><a href="#cb48-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-496"><a href="#cb48-496" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb48-497"><a href="#cb48-497" aria-hidden="true" tabindex="-1"></a>plt.show() <span class="co"># </span><span class="al">TBD</span><span class="co">: note the negative nugget!</span></span>
<span id="cb48-498"><a href="#cb48-498" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-499"><a href="#cb48-499" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-500"><a href="#cb48-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-501"><a href="#cb48-501" aria-hidden="true" tabindex="-1"></a>shown by the solid line in @fig-fitvariogrammodel.</span>
<span id="cb48-502"><a href="#cb48-502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-fitvariogrammodel, echo = !knitr::is_latex_output()}</span></span>
<span id="cb48-503"><a href="#cb48-503" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Sample variogram (circles) with models fitted using weighted least squares (solid line) and maximum likelihood estimation (dashed line)"</span></span>
<span id="cb48-504"><a href="#cb48-504" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-505"><a href="#cb48-505" aria-hidden="true" tabindex="-1"></a>fit.variogram_ml <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data, init, ...) {</span>
<span id="cb48-506"><a href="#cb48-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(init) <span class="sc">&lt;=</span> <span class="dv">2</span>, <span class="fu">inherits</span>(data, <span class="st">"sf"</span>), <span class="fu">inherits</span>(formula, <span class="st">"formula"</span>),</span>
<span id="cb48-507"><a href="#cb48-507" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inherits</span>(init, <span class="st">"variogramModel"</span>))</span>
<span id="cb48-508"><a href="#cb48-508" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(init) <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb48-509"><a href="#cb48-509" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="st">"Nug"</span> <span class="sc">%in%</span> init<span class="sc">$</span>model)</span>
<span id="cb48-510"><a href="#cb48-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-511"><a href="#cb48-511" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert from parameter vector to "variogramModel" class:</span></span>
<span id="cb48-512"><a href="#cb48-512" aria-hidden="true" tabindex="-1"></a>  <span class="co"># x is c(sill, range) or: c(sill, range, nugget)</span></span>
<span id="cb48-513"><a href="#cb48-513" aria-hidden="true" tabindex="-1"></a>  get_model <span class="ot">&lt;-</span> <span class="cf">function</span>(x, model, <span class="at">min_range =</span> <span class="fl">1e-10</span>) {</span>
<span id="cb48-514"><a href="#cb48-514" aria-hidden="true" tabindex="-1"></a>    sill <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb48-515"><a href="#cb48-515" aria-hidden="true" tabindex="-1"></a>    range <span class="ot">&lt;-</span> <span class="fu">max</span>(x[<span class="dv">2</span>], min_range)</span>
<span id="cb48-516"><a href="#cb48-516" aria-hidden="true" tabindex="-1"></a>    nugget <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">3</span>)</span>
<span id="cb48-517"><a href="#cb48-517" aria-hidden="true" tabindex="-1"></a>            x[<span class="dv">3</span>]</span>
<span id="cb48-518"><a href="#cb48-518" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb48-519"><a href="#cb48-519" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.</span></span>
<span id="cb48-520"><a href="#cb48-520" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">vgm</span>(sill, model, range, nugget)</span>
<span id="cb48-521"><a href="#cb48-521" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb48-522"><a href="#cb48-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-523"><a href="#cb48-523" aria-hidden="true" tabindex="-1"></a>  <span class="co"># with A &lt;- chol(Q), solve Q x = b for x:</span></span>
<span id="cb48-524"><a href="#cb48-524" aria-hidden="true" tabindex="-1"></a>  ch_solve <span class="ot">&lt;-</span> <span class="cf">function</span>(A, b) {</span>
<span id="cb48-525"><a href="#cb48-525" aria-hidden="true" tabindex="-1"></a>    <span class="fu">backsolve</span>(A, <span class="fu">forwardsolve</span>(A, b, <span class="at">upper.tri =</span> <span class="cn">TRUE</span>, <span class="at">transpose =</span> <span class="cn">TRUE</span>))</span>
<span id="cb48-526"><a href="#cb48-526" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb48-527"><a href="#cb48-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-528"><a href="#cb48-528" aria-hidden="true" tabindex="-1"></a>  <span class="co"># negative log likelihood, excluding the constant:</span></span>
<span id="cb48-529"><a href="#cb48-529" aria-hidden="true" tabindex="-1"></a>  nll <span class="ot">&lt;-</span> <span class="cf">function</span>(x, d, res, model, ...) {</span>
<span id="cb48-530"><a href="#cb48-530" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">get_model</span>(x, model, ...)</span>
<span id="cb48-531"><a href="#cb48-531" aria-hidden="true" tabindex="-1"></a>    Q <span class="ot">&lt;-</span> <span class="fu">variogramLine</span>(m, <span class="at">dist_vector =</span> d, <span class="at">covariance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-532"><a href="#cb48-532" aria-hidden="true" tabindex="-1"></a>    Qc <span class="ot">&lt;-</span> <span class="fu">chol</span>(Q)</span>
<span id="cb48-533"><a href="#cb48-533" aria-hidden="true" tabindex="-1"></a>    det <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sum</span>(<span class="fu">log</span>(<span class="fu">diag</span>(Qc)))</span>
<span id="cb48-534"><a href="#cb48-534" aria-hidden="true" tabindex="-1"></a>    det <span class="sc">+</span> <span class="fu">t</span>(res) <span class="sc">%*%</span> <span class="fu">ch_solve</span>(Qc, res)</span>
<span id="cb48-535"><a href="#cb48-535" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb48-536"><a href="#cb48-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-537"><a href="#cb48-537" aria-hidden="true" tabindex="-1"></a>  <span class="co"># distance matrix, for optim stability rescaled to [0,1] range</span></span>
<span id="cb48-538"><a href="#cb48-538" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(data) <span class="sc">|&gt;</span> units<span class="sc">::</span><span class="fu">drop_units</span>()</span>
<span id="cb48-539"><a href="#cb48-539" aria-hidden="true" tabindex="-1"></a>  max_d <span class="ot">&lt;-</span> <span class="fu">max</span>(d)</span>
<span id="cb48-540"><a href="#cb48-540" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> d <span class="sc">/</span> max_d</span>
<span id="cb48-541"><a href="#cb48-541" aria-hidden="true" tabindex="-1"></a>  <span class="co"># residuals y - X beta: scale to sd 1</span></span>
<span id="cb48-542"><a href="#cb48-542" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">residuals</span>(<span class="fu">lm</span>(formula, data))</span>
<span id="cb48-543"><a href="#cb48-543" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> <span class="fu">var</span>(res)</span>
<span id="cb48-544"><a href="#cb48-544" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> res<span class="sc">/</span><span class="fu">sqrt</span>(v)</span>
<span id="cb48-545"><a href="#cb48-545" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(init) <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb48-546"><a href="#cb48-546" aria-hidden="true" tabindex="-1"></a>    o.init <span class="ot">&lt;-</span> <span class="fu">c</span>(init<span class="sc">$</span>psill[<span class="dv">2</span>], init<span class="sc">$</span>range[<span class="dv">2</span>], init<span class="sc">$</span>psill[<span class="dv">0</span>])</span>
<span id="cb48-547"><a href="#cb48-547" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">as.character</span>(init<span class="sc">$</span>model[<span class="dv">2</span>])</span>
<span id="cb48-548"><a href="#cb48-548" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb48-549"><a href="#cb48-549" aria-hidden="true" tabindex="-1"></a>    o.init <span class="ot">&lt;-</span> <span class="fu">c</span>(init<span class="sc">$</span>psill[<span class="dv">1</span>], init<span class="sc">$</span>range[<span class="dv">1</span>])</span>
<span id="cb48-550"><a href="#cb48-550" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">as.character</span>(init<span class="sc">$</span>model[<span class="dv">1</span>])</span>
<span id="cb48-551"><a href="#cb48-551" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb48-552"><a href="#cb48-552" aria-hidden="true" tabindex="-1"></a>  o.init[<span class="dv">2</span>] <span class="ot">&lt;-</span> o.init[<span class="dv">2</span>] <span class="sc">/</span> max_d <span class="co"># scale to [0,1]</span></span>
<span id="cb48-553"><a href="#cb48-553" aria-hidden="true" tabindex="-1"></a>  o.init[<span class="sc">-</span><span class="dv">2</span>] <span class="ot">&lt;-</span> o.init[<span class="sc">-</span><span class="dv">2</span>] <span class="sc">/</span> v   <span class="co"># scale to sd 1</span></span>
<span id="cb48-554"><a href="#cb48-554" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> <span class="fu">optim</span>(o.init, nll, <span class="at">d =</span> d, <span class="at">res =</span> res, <span class="at">model =</span> model, </span>
<span id="cb48-555"><a href="#cb48-555" aria-hidden="true" tabindex="-1"></a>            <span class="at">lower =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(o.init)), <span class="at">method =</span> <span class="st">"L-BFGS-B"</span>, ...)<span class="sc">$</span>par</span>
<span id="cb48-556"><a href="#cb48-556" aria-hidden="true" tabindex="-1"></a>  o[<span class="dv">2</span>] <span class="ot">&lt;-</span> o[<span class="dv">2</span>] <span class="sc">*</span> max_d <span class="co"># scale back to distance units</span></span>
<span id="cb48-557"><a href="#cb48-557" aria-hidden="true" tabindex="-1"></a>  o[<span class="sc">-</span><span class="dv">2</span>] <span class="ot">&lt;-</span> o[<span class="sc">-</span><span class="dv">2</span>] <span class="sc">*</span> v <span class="co"># scale back to variance v</span></span>
<span id="cb48-558"><a href="#cb48-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_model</span>(o, model)</span>
<span id="cb48-559"><a href="#cb48-559" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-560"><a href="#cb48-560" aria-hidden="true" tabindex="-1"></a><span class="co"># use WLS fit model v.m for initial parameters:</span></span>
<span id="cb48-561"><a href="#cb48-561" aria-hidden="true" tabindex="-1"></a>v.ml <span class="ot">&lt;-</span> <span class="fu">fit.variogram_ml</span>(NO2<span class="sc">~</span><span class="dv">1</span>, no2.sf, v.m)</span>
<span id="cb48-562"><a href="#cb48-562" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(v, v.ml, plot.numbers = TRUE)</span></span>
<span id="cb48-563"><a href="#cb48-563" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(v, v.m, plot.numbers = TRUE) ## draws a single model; draw 2 models in single plot:</span></span>
<span id="cb48-564"><a href="#cb48-564" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">xaxs =</span> <span class="st">"i"</span>, <span class="at">yaxs =</span> <span class="st">"i"</span>)</span>
<span id="cb48-565"><a href="#cb48-565" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gamma <span class="sc">~</span> dist, v, </span>
<span id="cb48-566"><a href="#cb48-566" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.075</span> <span class="sc">*</span> <span class="fu">max</span>(v<span class="sc">$</span>dist)), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.05</span> <span class="sc">*</span> <span class="fu">max</span>(v<span class="sc">$</span>gamma)),</span>
<span id="cb48-567"><a href="#cb48-567" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"distance h [m]"</span>, <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="fu">gamma</span>(h)))</span>
<span id="cb48-568"><a href="#cb48-568" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">variogramLine</span>(v.m, <span class="fl">1.075</span> <span class="sc">*</span> <span class="fu">max</span>(v<span class="sc">$</span>dist)), <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">'blue'</span>)</span>
<span id="cb48-569"><a href="#cb48-569" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">variogramLine</span>(v.ml, <span class="fl">1.075</span> <span class="sc">*</span> <span class="fu">max</span>(v<span class="sc">$</span>dist)), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">'blue'</span>)</span>
<span id="cb48-570"><a href="#cb48-570" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(v<span class="sc">$</span>dist, v<span class="sc">$</span>gamma, v<span class="sc">$</span>np, <span class="at">pos =</span> <span class="dv">4</span>)</span>
<span id="cb48-571"><a href="#cb48-571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-572"><a href="#cb48-572" aria-hidden="true" tabindex="-1"></a>The fitting for the drawn line was done by weighted least squares,</span>
<span id="cb48-573"><a href="#cb48-573" aria-hidden="true" tabindex="-1"></a>minimising </span>
<span id="cb48-574"><a href="#cb48-574" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-575"><a href="#cb48-575" aria-hidden="true" tabindex="-1"></a>\sum_{i=1}^{n}w_i(\gamma(h_i)-\hat{\gamma}(h_i))^2,</span>
<span id="cb48-576"><a href="#cb48-576" aria-hidden="true" tabindex="-1"></a>$$ {#eq-wlsweights}</span>
<span id="cb48-577"><a href="#cb48-577" aria-hidden="true" tabindex="-1"></a>with weights $w_i$ by default equal to $N(h_i)/h^2$. Other weight</span>
<span id="cb48-578"><a href="#cb48-578" aria-hidden="true" tabindex="-1"></a>options are available through argument <span class="in">`fit.method`</span>.</span>
<span id="cb48-579"><a href="#cb48-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-580"><a href="#cb48-580" aria-hidden="true" tabindex="-1"></a>\index{variogram!model!maximum likelihood estimation}</span>
<span id="cb48-581"><a href="#cb48-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-582"><a href="#cb48-582" aria-hidden="true" tabindex="-1"></a>As an alternative to weighted least squares fitting, one can</span>
<span id="cb48-583"><a href="#cb48-583" aria-hidden="true" tabindex="-1"></a>use maximum likelihood (ML) or restricted maximum likelihood</span>
<span id="cb48-584"><a href="#cb48-584" aria-hidden="true" tabindex="-1"></a>parameter estimation <span class="co">[</span><span class="ot">@kitanidis1985maximum</span><span class="co">]</span>, which for</span>
<span id="cb48-585"><a href="#cb48-585" aria-hidden="true" tabindex="-1"></a>this case leads to a relatively similar fitted model, shown</span>
<span id="cb48-586"><a href="#cb48-586" aria-hidden="true" tabindex="-1"></a>as the dashed line in @fig-fitvariogrammodel. An advantage of</span>
<span id="cb48-587"><a href="#cb48-587" aria-hidden="true" tabindex="-1"></a>ML-type approaches is that they do not require choosing distance</span>
<span id="cb48-588"><a href="#cb48-588" aria-hidden="true" tabindex="-1"></a>intervals $h_i$ in @eq-samplevariogram or weights $w_i$ in</span>
<span id="cb48-589"><a href="#cb48-589" aria-hidden="true" tabindex="-1"></a>@eq-wlsweights. Disadvantages are that they lean on stronger</span>
<span id="cb48-590"><a href="#cb48-590" aria-hidden="true" tabindex="-1"></a>assumptions of multivariate normally distributed data, and for</span>
<span id="cb48-591"><a href="#cb48-591" aria-hidden="true" tabindex="-1"></a>larger datasets require iteratively solving linear systems of size</span>
<span id="cb48-592"><a href="#cb48-592" aria-hidden="true" tabindex="-1"></a>equal to the number of observations; @Heaton2018 compare approaches</span>
<span id="cb48-593"><a href="#cb48-593" aria-hidden="true" tabindex="-1"></a>dedicated to fitting models to large datasets.</span>
<span id="cb48-594"><a href="#cb48-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-595"><a href="#cb48-595" aria-hidden="true" tabindex="-1"></a><span class="fu">## Kriging interpolation {#sec-kriging}</span></span>
<span id="cb48-596"><a href="#cb48-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-597"><a href="#cb48-597" aria-hidden="true" tabindex="-1"></a>\index{interpolation!kriging}</span>
<span id="cb48-598"><a href="#cb48-598" aria-hidden="true" tabindex="-1"></a>\index{kriging!ordinary}</span>
<span id="cb48-599"><a href="#cb48-599" aria-hidden="true" tabindex="-1"></a>\index{ordinary kriging}</span>
<span id="cb48-600"><a href="#cb48-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-601"><a href="#cb48-601" aria-hidden="true" tabindex="-1"></a>Typically, when we interpolate a variable, we do that on</span>
<span id="cb48-602"><a href="#cb48-602" aria-hidden="true" tabindex="-1"></a>points on a regular grid covering the target area. We first create</span>
<span id="cb48-603"><a href="#cb48-603" aria-hidden="true" tabindex="-1"></a>a <span class="in">`stars`</span> object with a raster covering the target area, and <span class="in">`NA`</span>s</span>
<span id="cb48-604"><a href="#cb48-604" aria-hidden="true" tabindex="-1"></a>outside it.</span>
<span id="cb48-605"><a href="#cb48-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-606"><a href="#cb48-606" aria-hidden="true" tabindex="-1"></a>Kriging involves the prediction of $Z(s_0)$ at arbitrary locations</span>
<span id="cb48-607"><a href="#cb48-607" aria-hidden="true" tabindex="-1"></a>$s_0$.  We can krige NO$_2$ by using <span class="in">`gstat::krige`</span>, with the model</span>
<span id="cb48-608"><a href="#cb48-608" aria-hidden="true" tabindex="-1"></a>for the trend, the data, the prediction grid, and the variogram</span>
<span id="cb48-609"><a href="#cb48-609" aria-hidden="true" tabindex="-1"></a>model as arguments (@fig-krigeovergermany) by:</span>
<span id="cb48-610"><a href="#cb48-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-611"><a href="#cb48-611" aria-hidden="true" tabindex="-1"></a>\index{krige}</span>
<span id="cb48-612"><a href="#cb48-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-613"><a href="#cb48-613" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-614"><a href="#cb48-614" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-617"><a href="#cb48-617" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-618"><a href="#cb48-618" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">krige</span>(NO2<span class="sc">~</span><span class="dv">1</span>, no2.sf, grd, v.m)</span>
<span id="cb48-619"><a href="#cb48-619" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-620"><a href="#cb48-620" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-krigeovergermany, echo = !knitr::is_latex_output()}</span></span>
<span id="cb48-621"><a href="#cb48-621" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Kriged NO$_2$ concentrations over Germany"</span></span>
<span id="cb48-622"><a href="#cb48-622" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_stars</span>(<span class="at">data =</span> k, <span class="fu">aes</span>(<span class="at">fill =</span> var1.pred, <span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span> </span>
<span id="cb48-623"><a href="#cb48-623" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb48-624"><a href="#cb48-624" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_cast</span>(de, <span class="st">"MULTILINESTRING"</span>)) <span class="sc">+</span> </span>
<span id="cb48-625"><a href="#cb48-625" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> no2.sf) <span class="sc">+</span></span>
<span id="cb48-626"><a href="#cb48-626" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_sf</span>(<span class="at">lims_method =</span> <span class="st">"geometry_bbox"</span>)</span>
<span id="cb48-627"><a href="#cb48-627" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-628"><a href="#cb48-628" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-631"><a href="#cb48-631" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-632"><a href="#cb48-632" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pykrige.ok <span class="im">import</span> OrdinaryKriging</span>
<span id="cb48-633"><a href="#cb48-633" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-634"><a href="#cb48-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-635"><a href="#cb48-635" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract coordinates and values from observed data</span></span>
<span id="cb48-636"><a href="#cb48-636" aria-hidden="true" tabindex="-1"></a>data_points_x <span class="op">=</span> no2_sf.geometry.x.values</span>
<span id="cb48-637"><a href="#cb48-637" aria-hidden="true" tabindex="-1"></a>data_points_y <span class="op">=</span> no2_sf.geometry.y.values</span>
<span id="cb48-638"><a href="#cb48-638" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> no2_sf[<span class="st">"NO2"</span>].values</span>
<span id="cb48-639"><a href="#cb48-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-640"><a href="#cb48-640" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate grid coordinates for interpolation</span></span>
<span id="cb48-641"><a href="#cb48-641" aria-hidden="true" tabindex="-1"></a>grid_x, grid_y <span class="op">=</span> np.meshgrid(</span>
<span id="cb48-642"><a href="#cb48-642" aria-hidden="true" tabindex="-1"></a>    np.linspace(grid_gdf.total_bounds[<span class="dv">0</span>], grid_gdf.total_bounds[<span class="dv">2</span>], <span class="dv">100</span>),</span>
<span id="cb48-643"><a href="#cb48-643" aria-hidden="true" tabindex="-1"></a>    np.linspace(grid_gdf.total_bounds[<span class="dv">1</span>], grid_gdf.total_bounds[<span class="dv">3</span>], <span class="dv">100</span>),</span>
<span id="cb48-644"><a href="#cb48-644" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-645"><a href="#cb48-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-646"><a href="#cb48-646" aria-hidden="true" tabindex="-1"></a>fitted_sill <span class="op">=</span> fitted_sill <span class="op">*</span> <span class="dv">3</span> <span class="co"># see docs of variogram_model in pykrige</span></span>
<span id="cb48-647"><a href="#cb48-647" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the ordinary kriging model</span></span>
<span id="cb48-648"><a href="#cb48-648" aria-hidden="true" tabindex="-1"></a>ok <span class="op">=</span> OrdinaryKriging(</span>
<span id="cb48-649"><a href="#cb48-649" aria-hidden="true" tabindex="-1"></a>    data_points_x,</span>
<span id="cb48-650"><a href="#cb48-650" aria-hidden="true" tabindex="-1"></a>    data_points_y,</span>
<span id="cb48-651"><a href="#cb48-651" aria-hidden="true" tabindex="-1"></a>    values,</span>
<span id="cb48-652"><a href="#cb48-652" aria-hidden="true" tabindex="-1"></a>    variogram_model<span class="op">=</span><span class="st">"exponential"</span>,  <span class="co"># Use the exponential model</span></span>
<span id="cb48-653"><a href="#cb48-653" aria-hidden="true" tabindex="-1"></a>    variogram_parameters<span class="op">=</span>{<span class="st">"sill"</span>: fitted_sill, <span class="st">"range"</span>: fitted_range, <span class="st">"nugget"</span>: fitted_nugget},</span>
<span id="cb48-654"><a href="#cb48-654" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-655"><a href="#cb48-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-656"><a href="#cb48-656" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform kriging interpolation on the grid</span></span>
<span id="cb48-657"><a href="#cb48-657" aria-hidden="true" tabindex="-1"></a>z, ss <span class="op">=</span> ok.execute(<span class="st">"grid"</span>, grid_x[<span class="dv">0</span>], grid_y[:, <span class="dv">0</span>])  <span class="co"># z: predicted values, ss: standard error</span></span>
<span id="cb48-658"><a href="#cb48-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-659"><a href="#cb48-659" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb48-660"><a href="#cb48-660" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb48-661"><a href="#cb48-661" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> Normalize</span>
<span id="cb48-662"><a href="#cb48-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-663"><a href="#cb48-663" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the kriging results</span></span>
<span id="cb48-664"><a href="#cb48-664" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb48-665"><a href="#cb48-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-666"><a href="#cb48-666" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the kriging predictions</span></span>
<span id="cb48-667"><a href="#cb48-667" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> ax.pcolormesh(</span>
<span id="cb48-668"><a href="#cb48-668" aria-hidden="true" tabindex="-1"></a>    grid_x, grid_y, z, shading<span class="op">=</span><span class="st">"auto"</span>, cmap<span class="op">=</span><span class="st">"viridis"</span>,</span>
<span id="cb48-669"><a href="#cb48-669" aria-hidden="true" tabindex="-1"></a>    norm<span class="op">=</span>Normalize(vmin<span class="op">=</span>np.nanmin(z), vmax<span class="op">=</span>np.nanmax(z))</span>
<span id="cb48-670"><a href="#cb48-670" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-671"><a href="#cb48-671" aria-hidden="true" tabindex="-1"></a>plt.colorbar(c, ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">"Kriged NO2 Predictions"</span>)</span>
<span id="cb48-672"><a href="#cb48-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-673"><a href="#cb48-673" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay country boundaries as multilinestrings</span></span>
<span id="cb48-674"><a href="#cb48-674" aria-hidden="true" tabindex="-1"></a>de.boundary.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb48-675"><a href="#cb48-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-676"><a href="#cb48-676" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay measurement points</span></span>
<span id="cb48-677"><a href="#cb48-677" aria-hidden="true" tabindex="-1"></a>no2_sf.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"red"</span>, markersize<span class="op">=</span><span class="dv">5</span>, label<span class="op">=</span><span class="st">"Measurement Points"</span>)</span>
<span id="cb48-678"><a href="#cb48-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-679"><a href="#cb48-679" aria-hidden="true" tabindex="-1"></a><span class="co"># Set axis labels and title</span></span>
<span id="cb48-680"><a href="#cb48-680" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">""</span>)</span>
<span id="cb48-681"><a href="#cb48-681" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">""</span>)</span>
<span id="cb48-682"><a href="#cb48-682" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Kriged NO2 Predictions"</span>)</span>
<span id="cb48-683"><a href="#cb48-683" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb48-684"><a href="#cb48-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-685"><a href="#cb48-685" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb48-686"><a href="#cb48-686" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-687"><a href="#cb48-687" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-688"><a href="#cb48-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-689"><a href="#cb48-689" aria-hidden="true" tabindex="-1"></a><span class="fu">## Areal means: block kriging {#sec-blockkriging}</span></span>
<span id="cb48-690"><a href="#cb48-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-691"><a href="#cb48-691" aria-hidden="true" tabindex="-1"></a>\index{kriging!block}</span>
<span id="cb48-692"><a href="#cb48-692" aria-hidden="true" tabindex="-1"></a>\index{kriging!areal means}</span>
<span id="cb48-693"><a href="#cb48-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-694"><a href="#cb48-694" aria-hidden="true" tabindex="-1"></a>Computing areal means can be done in several ways. The simplest is to take</span>
<span id="cb48-695"><a href="#cb48-695" aria-hidden="true" tabindex="-1"></a>the average of point samples falling inside the target polygons:</span>
<span id="cb48-696"><a href="#cb48-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-697"><a href="#cb48-697" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb48-698"><a href="#cb48-698" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb48-701"><a href="#cb48-701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-702"><a href="#cb48-702" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(no2.sf[<span class="st">"NO2"</span>], <span class="at">by =</span> de, <span class="at">FUN =</span> mean)</span>
<span id="cb48-703"><a href="#cb48-703" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-704"><a href="#cb48-704" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb48-707"><a href="#cb48-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-708"><a href="#cb48-708" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb48-709"><a href="#cb48-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-710"><a href="#cb48-710" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatially join the NO2 points with the regions in 'de'</span></span>
<span id="cb48-711"><a href="#cb48-711" aria-hidden="true" tabindex="-1"></a>joined <span class="op">=</span> gpd.sjoin(no2_sf, de, how<span class="op">=</span><span class="st">"inner"</span>, predicate<span class="op">=</span><span class="st">"within"</span>)</span>
<span id="cb48-712"><a href="#cb48-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-713"><a href="#cb48-713" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean NO2 value for each region</span></span>
<span id="cb48-714"><a href="#cb48-714" aria-hidden="true" tabindex="-1"></a>region_means <span class="op">=</span> joined.groupby(<span class="st">"index_right"</span>)[<span class="st">"NO2"</span>].mean().reset_index()</span>
<span id="cb48-715"><a href="#cb48-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-716"><a href="#cb48-716" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the computed mean NO2 values back to the 'de' GeoDataFrame</span></span>
<span id="cb48-717"><a href="#cb48-717" aria-hidden="true" tabindex="-1"></a>de[<span class="st">"NO2_mean"</span>] <span class="op">=</span> region_means[<span class="st">"NO2"</span>]</span>
<span id="cb48-718"><a href="#cb48-718" aria-hidden="true" tabindex="-1"></a>de.NO2_mean  </span>
<span id="cb48-719"><a href="#cb48-719" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-720"><a href="#cb48-720" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-721"><a href="#cb48-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-722"><a href="#cb48-722" aria-hidden="true" tabindex="-1"></a>A more complicated way is to use _block kriging_ <span class="co">[</span><span class="ot">@jh78</span><span class="co">]</span>, which</span>
<span id="cb48-723"><a href="#cb48-723" aria-hidden="true" tabindex="-1"></a>uses _all_ the data to estimate the mean of the variable over the</span>
<span id="cb48-724"><a href="#cb48-724" aria-hidden="true" tabindex="-1"></a>target areas. With <span class="in">`krige`</span>, this can be done by giving the target</span>
<span id="cb48-725"><a href="#cb48-725" aria-hidden="true" tabindex="-1"></a>areas (polygons) as the <span class="in">`newdata`</span> argument:</span>
<span id="cb48-726"><a href="#cb48-726" aria-hidden="true" tabindex="-1"></a><span class="in">```{r krigeNO2regionmeans}</span></span>
<span id="cb48-727"><a href="#cb48-727" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">krige</span>(NO2<span class="sc">~</span><span class="dv">1</span>, no2.sf, de, v.m)</span>
<span id="cb48-728"><a href="#cb48-728" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-729"><a href="#cb48-729" aria-hidden="true" tabindex="-1"></a>we can now merge the two maps into a single object to create a single plot (@fig-aggregations):</span>
<span id="cb48-732"><a href="#cb48-732" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-733"><a href="#cb48-733" aria-hidden="true" tabindex="-1"></a>b<span class="sc">$</span>sample <span class="ot">&lt;-</span> a<span class="sc">$</span>NO2</span>
<span id="cb48-734"><a href="#cb48-734" aria-hidden="true" tabindex="-1"></a>b<span class="sc">$</span>kriging <span class="ot">&lt;-</span> b<span class="sc">$</span>var1.pred</span>
<span id="cb48-735"><a href="#cb48-735" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-736"><a href="#cb48-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-737"><a href="#cb48-737" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-aggregations, echo = !knitr::is_latex_output()}</span></span>
<span id="cb48-738"><a href="#cb48-738" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Aggregated NO$_2$ values from simple averaging (left) and block kriging (right)"</span></span>
<span id="cb48-739"><a href="#cb48-739" aria-hidden="true" tabindex="-1"></a>b <span class="sc">|&gt;</span> <span class="fu">select</span>(sample, kriging) <span class="sc">|&gt;</span> </span>
<span id="cb48-740"><a href="#cb48-740" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_longer</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">names_to =</span> <span class="st">"var"</span>, <span class="at">values_to =</span> <span class="st">"NO2"</span>) <span class="ot">-&gt;</span> b2</span>
<span id="cb48-741"><a href="#cb48-741" aria-hidden="true" tabindex="-1"></a>b2<span class="sc">$</span>var <span class="ot">&lt;-</span> <span class="fu">factor</span>(b2<span class="sc">$</span>var, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"sample"</span>, <span class="st">"kriging"</span>))</span>
<span id="cb48-742"><a href="#cb48-742" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="at">data =</span> b2, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> NO2)) <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>var) <span class="sc">+</span></span>
<span id="cb48-743"><a href="#cb48-743" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_fill_gradientn</span>(<span class="at">colors =</span> <span class="fu">sf.colors</span>(<span class="dv">20</span>))</span>
<span id="cb48-744"><a href="#cb48-744" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-745"><a href="#cb48-745" aria-hidden="true" tabindex="-1"></a>We see that the signal is similar, but that the sample means from simple </span>
<span id="cb48-746"><a href="#cb48-746" aria-hidden="true" tabindex="-1"></a>averaging are more variable than the block kriging values; this may be due to</span>
<span id="cb48-747"><a href="#cb48-747" aria-hidden="true" tabindex="-1"></a>the smoothing effect of kriging: data points outside the aggregation</span>
<span id="cb48-748"><a href="#cb48-748" aria-hidden="true" tabindex="-1"></a>area receive weight, too.</span>
<span id="cb48-749"><a href="#cb48-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-750"><a href="#cb48-750" aria-hidden="true" tabindex="-1"></a>\index{kriging!standard errors}</span>
<span id="cb48-751"><a href="#cb48-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-752"><a href="#cb48-752" aria-hidden="true" tabindex="-1"></a>To compare the standard errors of means, for the sample mean we</span>
<span id="cb48-753"><a href="#cb48-753" aria-hidden="true" tabindex="-1"></a>can get a rough guess of the standard error by $\sqrt{(\sigma^2/n)}$:</span>
<span id="cb48-756"><a href="#cb48-756" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-757"><a href="#cb48-757" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sqrt</span>(<span class="fu">var</span>(x)<span class="sc">/</span><span class="fu">length</span>(x))</span>
<span id="cb48-758"><a href="#cb48-758" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(no2.sf[<span class="st">"NO2"</span>], de, SE)</span>
<span id="cb48-759"><a href="#cb48-759" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-760"><a href="#cb48-760" aria-hidden="true" tabindex="-1"></a>which would have been the actual estimate in design-based inference (@sec-design)</span>
<span id="cb48-761"><a href="#cb48-761" aria-hidden="true" tabindex="-1"></a>if the sample were obtained by spatially random sampling.</span>
<span id="cb48-762"><a href="#cb48-762" aria-hidden="true" tabindex="-1"></a>The block kriging variance is the model-based estimate and is</span>
<span id="cb48-763"><a href="#cb48-763" aria-hidden="true" tabindex="-1"></a>a by-product of kriging. We can compare the two in @fig-aggrSE where</span>
<span id="cb48-764"><a href="#cb48-764" aria-hidden="true" tabindex="-1"></a>we see that the simple averaging approach gives more variability and mostly</span>
<span id="cb48-765"><a href="#cb48-765" aria-hidden="true" tabindex="-1"></a>larger values for prediction errors of areal means, compared to</span>
<span id="cb48-766"><a href="#cb48-766" aria-hidden="true" tabindex="-1"></a>block kriging.</span>
<span id="cb48-767"><a href="#cb48-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-768"><a href="#cb48-768" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-aggrSE, echo = !knitr::is_latex_output()}</span></span>
<span id="cb48-769"><a href="#cb48-769" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Standard errors for mean NO$_2$ values obtained by simple averaging (left) and block kriging (right)"</span></span>
<span id="cb48-770"><a href="#cb48-770" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-771"><a href="#cb48-771" aria-hidden="true" tabindex="-1"></a>b<span class="sc">$</span>sample <span class="ot">&lt;-</span> a<span class="sc">$</span>NO2</span>
<span id="cb48-772"><a href="#cb48-772" aria-hidden="true" tabindex="-1"></a>b<span class="sc">$</span>kriging <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(b<span class="sc">$</span>var1.var)</span>
<span id="cb48-773"><a href="#cb48-773" aria-hidden="true" tabindex="-1"></a>b <span class="sc">|&gt;</span> <span class="fu">select</span>(sample, kriging) <span class="sc">|&gt;</span> </span>
<span id="cb48-774"><a href="#cb48-774" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_longer</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">names_to =</span> <span class="st">"var"</span>, </span>
<span id="cb48-775"><a href="#cb48-775" aria-hidden="true" tabindex="-1"></a>                     <span class="at">values_to =</span> <span class="st">"Standard_error"</span>) <span class="ot">-&gt;</span> b2</span>
<span id="cb48-776"><a href="#cb48-776" aria-hidden="true" tabindex="-1"></a>b2<span class="sc">$</span>var <span class="ot">&lt;-</span> <span class="fu">factor</span>(b2<span class="sc">$</span>var, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"sample"</span>, <span class="st">"kriging"</span>))</span>
<span id="cb48-777"><a href="#cb48-777" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb48-778"><a href="#cb48-778" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> b2, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> Standard_error)) <span class="sc">+</span></span>
<span id="cb48-779"><a href="#cb48-779" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>var, <span class="at">as.table =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb48-780"><a href="#cb48-780" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradientn</span>(<span class="at">colors =</span> <span class="fu">sf.colors</span>(<span class="dv">20</span>))</span>
<span id="cb48-781"><a href="#cb48-781" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-782"><a href="#cb48-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-783"><a href="#cb48-783" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conditional simulation</span></span>
<span id="cb48-784"><a href="#cb48-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-785"><a href="#cb48-785" aria-hidden="true" tabindex="-1"></a>\index{kriging!conditional simulation}</span>
<span id="cb48-786"><a href="#cb48-786" aria-hidden="true" tabindex="-1"></a>\index{conditional simulation}</span>
<span id="cb48-787"><a href="#cb48-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-788"><a href="#cb48-788" aria-hidden="true" tabindex="-1"></a>In case one or more conditional realisation of the field $Z(s)$</span>
<span id="cb48-789"><a href="#cb48-789" aria-hidden="true" tabindex="-1"></a>are needed rather than their conditional mean, we can obtain this</span>
<span id="cb48-790"><a href="#cb48-790" aria-hidden="true" tabindex="-1"></a>by _conditional simulation_. A reason for wanting this may be the</span>
<span id="cb48-791"><a href="#cb48-791" aria-hidden="true" tabindex="-1"></a>need to estimate areal mean values of $g(Z(s))$ with $g(\cdot)$</span>
<span id="cb48-792"><a href="#cb48-792" aria-hidden="true" tabindex="-1"></a>a non-linear function; a simple example is the areal fraction where</span>
<span id="cb48-793"><a href="#cb48-793" aria-hidden="true" tabindex="-1"></a>$Z(s)$ exceeds a threshold.</span>
<span id="cb48-794"><a href="#cb48-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-795"><a href="#cb48-795" aria-hidden="true" tabindex="-1"></a>The default approach used by <span class="in">`gstat`</span> is to use the sequential</span>
<span id="cb48-796"><a href="#cb48-796" aria-hidden="true" tabindex="-1"></a>simulation algorithm for this. This is a simple algorithm that</span>
<span id="cb48-797"><a href="#cb48-797" aria-hidden="true" tabindex="-1"></a>randomly steps through the prediction locations and at each location:</span>
<span id="cb48-798"><a href="#cb48-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-799"><a href="#cb48-799" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>carries out a kriging prediction</span>
<span id="cb48-800"><a href="#cb48-800" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>draws a random variable from the normal distribution with mean and variance equal to the kriging variance</span>
<span id="cb48-801"><a href="#cb48-801" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>adds this value to the conditioning dataset</span>
<span id="cb48-802"><a href="#cb48-802" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>finds a new random simulation location</span>
<span id="cb48-803"><a href="#cb48-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-804"><a href="#cb48-804" aria-hidden="true" tabindex="-1"></a>until all locations have been visited. </span>
<span id="cb48-805"><a href="#cb48-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-806"><a href="#cb48-806" aria-hidden="true" tabindex="-1"></a>This is carried out by <span class="in">`gstat::krige`</span> when <span class="in">`nsim`</span> is set to a</span>
<span id="cb48-807"><a href="#cb48-807" aria-hidden="true" tabindex="-1"></a>positive value:</span>
<span id="cb48-808"><a href="#cb48-808" aria-hidden="true" tabindex="-1"></a><span class="in">```{r condsim}</span></span>
<span id="cb48-809"><a href="#cb48-809" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13341</span>)</span>
<span id="cb48-810"><a href="#cb48-810" aria-hidden="true" tabindex="-1"></a>(s <span class="ot">&lt;-</span> <span class="fu">krige</span>(NO2<span class="sc">~</span><span class="dv">1</span>, no2.sf, grd, v.m, <span class="at">nmax =</span> <span class="dv">30</span>, <span class="at">nsim =</span> <span class="dv">6</span>))</span>
<span id="cb48-811"><a href="#cb48-811" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-812"><a href="#cb48-812" aria-hidden="true" tabindex="-1"></a>where <span class="in">`set.seed()`</span> was called here to allow reproducibility.</span>
<span id="cb48-813"><a href="#cb48-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-814"><a href="#cb48-814" aria-hidden="true" tabindex="-1"></a>It is usually needed to constrain the (maximum) number of nearest</span>
<span id="cb48-815"><a href="#cb48-815" aria-hidden="true" tabindex="-1"></a>neighbours to include in kriging estimation by setting <span class="in">`nmax`</span></span>
<span id="cb48-816"><a href="#cb48-816" aria-hidden="true" tabindex="-1"></a>because the dataset grows each step, leading otherwise quickly</span>
<span id="cb48-817"><a href="#cb48-817" aria-hidden="true" tabindex="-1"></a>to very long computing times and large memory requirements. Resulting</span>
<span id="cb48-818"><a href="#cb48-818" aria-hidden="true" tabindex="-1"></a>conditional simulations are shown in (@fig-plotkrigingvalues).</span>
<span id="cb48-819"><a href="#cb48-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-820"><a href="#cb48-820" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-plotkrigingvalues, echo=!knitr::is_latex_output(), message=FALSE}</span></span>
<span id="cb48-821"><a href="#cb48-821" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Six conditional simulations for NO$_2$ values"</span></span>
<span id="cb48-822"><a href="#cb48-822" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-823"><a href="#cb48-823" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb48-824"><a href="#cb48-824" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb48-825"><a href="#cb48-825" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis</span>() <span class="sc">+</span></span>
<span id="cb48-826"><a href="#cb48-826" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb48-827"><a href="#cb48-827" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">expand=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb48-828"><a href="#cb48-828" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_discrete</span>(<span class="at">expand=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb48-829"><a href="#cb48-829" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_stars</span>(<span class="at">data =</span> s[,,,<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]) <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>sample)</span>
<span id="cb48-830"><a href="#cb48-830" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-831"><a href="#cb48-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-832"><a href="#cb48-832" aria-hidden="true" tabindex="-1"></a>Alternative methods for conditional simulation have recently been</span>
<span id="cb48-833"><a href="#cb48-833" aria-hidden="true" tabindex="-1"></a>added to <span class="in">`gstat`</span>, and include <span class="in">`krigeSimCE`</span> implementing the circular</span>
<span id="cb48-834"><a href="#cb48-834" aria-hidden="true" tabindex="-1"></a>embedding method <span class="co">[</span><span class="ot">@JSSv055i09</span><span class="co">]</span>, and <span class="in">`krigeSTSimTB`</span> implementing</span>
<span id="cb48-835"><a href="#cb48-835" aria-hidden="true" tabindex="-1"></a>the turning bands method <span class="co">[</span><span class="ot">@schlather</span><span class="co">]</span>. These are of particular</span>
<span id="cb48-836"><a href="#cb48-836" aria-hidden="true" tabindex="-1"></a>of interest for larger datasets or conditional simulations of</span>
<span id="cb48-837"><a href="#cb48-837" aria-hidden="true" tabindex="-1"></a>spatiotemporal data.</span>
<span id="cb48-838"><a href="#cb48-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-839"><a href="#cb48-839" aria-hidden="true" tabindex="-1"></a><span class="fu">## Trend models</span></span>
<span id="cb48-840"><a href="#cb48-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-841"><a href="#cb48-841" aria-hidden="true" tabindex="-1"></a>\index{kriging!trend model}</span>
<span id="cb48-842"><a href="#cb48-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-843"><a href="#cb48-843" aria-hidden="true" tabindex="-1"></a>Kriging and conditional simulation, as used so far in this</span>
<span id="cb48-844"><a href="#cb48-844" aria-hidden="true" tabindex="-1"></a>chapter, assume that all spatial variability is a random process,</span>
<span id="cb48-845"><a href="#cb48-845" aria-hidden="true" tabindex="-1"></a>characterised by a spatial covariance model. In case we have other</span>
<span id="cb48-846"><a href="#cb48-846" aria-hidden="true" tabindex="-1"></a>variables that are meaningfully correlated with the target variable,</span>
<span id="cb48-847"><a href="#cb48-847" aria-hidden="true" tabindex="-1"></a>we can use them in a linear regression model for the trend,</span>
<span id="cb48-848"><a href="#cb48-848" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-849"><a href="#cb48-849" aria-hidden="true" tabindex="-1"></a>Z(s) = \sum_{j=0}^p \beta_j X_j(s) + e(s)</span>
<span id="cb48-850"><a href="#cb48-850" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-851"><a href="#cb48-851" aria-hidden="true" tabindex="-1"></a>with $X_0(s) = 1$ and $\beta_0$ an intercept, but with the other</span>
<span id="cb48-852"><a href="#cb48-852" aria-hidden="true" tabindex="-1"></a>$\beta_j$ regression coefficients. Adding variables typically</span>
<span id="cb48-853"><a href="#cb48-853" aria-hidden="true" tabindex="-1"></a>reduces both the spatial correlation in the residual $e(s)$, as</span>
<span id="cb48-854"><a href="#cb48-854" aria-hidden="true" tabindex="-1"></a>well as its variance, and leads to more accurate predictions and</span>
<span id="cb48-855"><a href="#cb48-855" aria-hidden="true" tabindex="-1"></a>more similar conditional simulations. As an example, we will use</span>
<span id="cb48-856"><a href="#cb48-856" aria-hidden="true" tabindex="-1"></a>population density to partly explain variation in NO$_2$.</span>
<span id="cb48-857"><a href="#cb48-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-858"><a href="#cb48-858" aria-hidden="true" tabindex="-1"></a><span class="fu">### A population grid</span></span>
<span id="cb48-859"><a href="#cb48-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-860"><a href="#cb48-860" aria-hidden="true" tabindex="-1"></a>\index{population density grid}</span>
<span id="cb48-861"><a href="#cb48-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-862"><a href="#cb48-862" aria-hidden="true" tabindex="-1"></a>As a potential predictor for NO$_2$ in the air, we use population</span>
<span id="cb48-863"><a href="#cb48-863" aria-hidden="true" tabindex="-1"></a>density. NO$_2$ is mostly caused by traffic, and traffic is more intense</span>
<span id="cb48-864"><a href="#cb48-864" aria-hidden="true" tabindex="-1"></a>in densely populated areas.</span>
<span id="cb48-865"><a href="#cb48-865" aria-hidden="true" tabindex="-1"></a>Population density is obtained from the <span class="co">[</span><span class="ot">2011 census</span><span class="co">](https://www.zensus2011.de/DE/Home/Aktuelles/DemografischeGrunddaten.html)</span> and is downloaded as a csv file with the number of inhabitants per 100 m $\times$ 100 m grid cell. We can aggregate these data to the target grid cells by summing the inhabitants:</span>
<span id="cb48-866"><a href="#cb48-866" aria-hidden="true" tabindex="-1"></a><span class="in">```{r vroom1, message=FALSE, eval=!CI}</span></span>
<span id="cb48-867"><a href="#cb48-867" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> vroom<span class="sc">::</span><span class="fu">vroom</span>(<span class="st">"aq/pop/Zensus_Bevoelkerung_100m-Gitter.csv"</span>)</span>
<span id="cb48-868"><a href="#cb48-868" aria-hidden="true" tabindex="-1"></a>v <span class="sc">|&gt;</span> <span class="fu">filter</span>(Einwohner <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb48-869"><a href="#cb48-869" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Gitter_ID_100m) <span class="sc">|&gt;</span></span>
<span id="cb48-870"><a href="#cb48-870" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x_mp_100m"</span>, <span class="st">"y_mp_100m"</span>), <span class="at">crs =</span> <span class="dv">3035</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-871"><a href="#cb48-871" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(grd)) <span class="ot">-&gt;</span> b</span>
<span id="cb48-872"><a href="#cb48-872" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(b, <span class="fu">st_as_sf</span>(grd, <span class="at">na.rm =</span> <span class="cn">FALSE</span>), sum)</span>
<span id="cb48-873"><a href="#cb48-873" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-874"><a href="#cb48-874" aria-hidden="true" tabindex="-1"></a><span class="in">```{r vroom0, echo=FALSE, eval=CI}</span></span>
<span id="cb48-875"><a href="#cb48-875" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/ch12.rda"</span>) <span class="co"># instead of reading v &amp; processing b and a, load object a</span></span>
<span id="cb48-876"><a href="#cb48-876" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-877"><a href="#cb48-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-878"><a href="#cb48-878" aria-hidden="true" tabindex="-1"></a>Now we have the population counts per grid cell in <span class="in">`a`</span>. To get to</span>
<span id="cb48-879"><a href="#cb48-879" aria-hidden="true" tabindex="-1"></a>population density, we need to find the area of each cell; for cells</span>
<span id="cb48-880"><a href="#cb48-880" aria-hidden="true" tabindex="-1"></a>crossing the country border, this will be less than 10 $\times$ 10 km:</span>
<span id="cb48-881"><a href="#cb48-881" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb48-882"><a href="#cb48-882" aria-hidden="true" tabindex="-1"></a>grd<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">prod</span>(<span class="fu">dim</span>(grd)) <span class="co"># to identify grid cells</span></span>
<span id="cb48-883"><a href="#cb48-883" aria-hidden="true" tabindex="-1"></a>ii <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(grd[<span class="st">"ID"</span>],</span>
<span id="cb48-884"><a href="#cb48-884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_cast</span>(<span class="fu">st_union</span>(de), <span class="st">"MULTILINESTRING"</span>), <span class="at">as_points =</span> <span class="cn">FALSE</span>)</span>
<span id="cb48-885"><a href="#cb48-885" aria-hidden="true" tabindex="-1"></a>grd_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(grd[<span class="st">"ID"</span>], <span class="at">na.rm =</span> <span class="cn">FALSE</span>)[<span class="fu">lengths</span>(ii) <span class="sc">&gt;</span> <span class="dv">0</span>,]</span>
<span id="cb48-886"><a href="#cb48-886" aria-hidden="true" tabindex="-1"></a><span class="fu">st_agr</span>(grd_sf) <span class="ot">=</span> <span class="st">"identity"</span></span>
<span id="cb48-887"><a href="#cb48-887" aria-hidden="true" tabindex="-1"></a>iii <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(grd_sf, <span class="fu">st_union</span>(de))</span>
<span id="cb48-888"><a href="#cb48-888" aria-hidden="true" tabindex="-1"></a>grd<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(grd)[[<span class="dv">1</span>]] <span class="sc">+</span> </span>
<span id="cb48-889"><a href="#cb48-889" aria-hidden="true" tabindex="-1"></a>    units<span class="sc">::</span><span class="fu">set_units</span>(grd<span class="sc">$</span>values, m<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb48-890"><a href="#cb48-890" aria-hidden="true" tabindex="-1"></a>grd<span class="sc">$</span>area[iii<span class="sc">$</span>ID] <span class="ot">&lt;-</span> <span class="fu">st_area</span>(iii)</span>
<span id="cb48-891"><a href="#cb48-891" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-892"><a href="#cb48-892" aria-hidden="true" tabindex="-1"></a>Instead of doing the two-stage procedure above, first finding cells that</span>
<span id="cb48-893"><a href="#cb48-893" aria-hidden="true" tabindex="-1"></a>have a border crossing it then computing its area, we could also directly</span>
<span id="cb48-894"><a href="#cb48-894" aria-hidden="true" tabindex="-1"></a>use <span class="in">`st_intersection`</span> on all cells, but that takes considerably longer.</span>
<span id="cb48-895"><a href="#cb48-895" aria-hidden="true" tabindex="-1"></a>From the counts and areas we can compute densities (@fig-popdens)</span>
<span id="cb48-896"><a href="#cb48-896" aria-hidden="true" tabindex="-1"></a>and verify totals </span>
<span id="cb48-899"><a href="#cb48-899" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-900"><a href="#cb48-900" aria-hidden="true" tabindex="-1"></a>grd<span class="sc">$</span>pop_dens <span class="ot">&lt;-</span> a<span class="sc">$</span>Einwohner <span class="sc">/</span> grd<span class="sc">$</span>area</span>
<span id="cb48-901"><a href="#cb48-901" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(grd<span class="sc">$</span>pop_dens <span class="sc">*</span> grd<span class="sc">$</span>area, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># verify</span></span>
<span id="cb48-902"><a href="#cb48-902" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(b<span class="sc">$</span>Einwohner)</span>
<span id="cb48-903"><a href="#cb48-903" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-904"><a href="#cb48-904" aria-hidden="true" tabindex="-1"></a>which indicates strong agreement. Using <span class="in">`st_interpolate_aw`</span> would</span>
<span id="cb48-905"><a href="#cb48-905" aria-hidden="true" tabindex="-1"></a>have given an exact match.</span>
<span id="cb48-906"><a href="#cb48-906" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-popdens, echo = !knitr::is_latex_output()}</span></span>
<span id="cb48-907"><a href="#cb48-907" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Population density for 100 m $\\times$ 100 m grid cells"</span></span>
<span id="cb48-908"><a href="#cb48-908" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-909"><a href="#cb48-909" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_stars</span>(<span class="at">data =</span> grd, <span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">sqrt</span>(pop_dens), <span class="at">x =</span> x, <span class="at">y =</span> y))</span>
<span id="cb48-910"><a href="#cb48-910" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-911"><a href="#cb48-911" aria-hidden="true" tabindex="-1"></a>We need to divide the number of inhabitants by the number of 100</span>
<span id="cb48-912"><a href="#cb48-912" aria-hidden="true" tabindex="-1"></a>m $\times$ 100 m grid cells contributing to it, in order to convert population</span>
<span id="cb48-913"><a href="#cb48-913" aria-hidden="true" tabindex="-1"></a>counts into population density.</span>
<span id="cb48-914"><a href="#cb48-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-915"><a href="#cb48-915" aria-hidden="true" tabindex="-1"></a>\index{st<span class="sc">\_</span>extract}</span>
<span id="cb48-916"><a href="#cb48-916" aria-hidden="true" tabindex="-1"></a>To obtain population density values at monitoring network stations,</span>
<span id="cb48-917"><a href="#cb48-917" aria-hidden="true" tabindex="-1"></a>we can use <span class="in">`st_extract`</span>:</span>
<span id="cb48-920"><a href="#cb48-920" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-921"><a href="#cb48-921" aria-hidden="true" tabindex="-1"></a>grd <span class="sc">|&gt;</span></span>
<span id="cb48-922"><a href="#cb48-922" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">"pop_dens"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-923"><a href="#cb48-923" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_extract</span>(no2.sf) <span class="sc">|&gt;</span></span>
<span id="cb48-924"><a href="#cb48-924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(<span class="st">"pop_dens"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb48-925"><a href="#cb48-925" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(no2.sf, <span class="at">pop_dens =</span> _) <span class="ot">-&gt;</span> no2.sf</span>
<span id="cb48-926"><a href="#cb48-926" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-927"><a href="#cb48-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-928"><a href="#cb48-928" aria-hidden="true" tabindex="-1"></a>We can then investigate the linear relationship between NO$_2$ and</span>
<span id="cb48-929"><a href="#cb48-929" aria-hidden="true" tabindex="-1"></a>population density at monitoring station locations:</span>
<span id="cb48-932"><a href="#cb48-932" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-933"><a href="#cb48-933" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(NO2<span class="sc">~</span><span class="fu">sqrt</span>(pop_dens), no2.sf))</span>
<span id="cb48-934"><a href="#cb48-934" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-935"><a href="#cb48-935" aria-hidden="true" tabindex="-1"></a>for which the corresponding scatterplot is shown in @fig-no2scat.</span>
<span id="cb48-936"><a href="#cb48-936" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-no2scat, echo=!knitr::is_latex_output()}</span></span>
<span id="cb48-937"><a href="#cb48-937" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Scatter plot of 2017 annual mean NO$_2$ concentration against population density, for rural background air quality stations"</span></span>
<span id="cb48-938"><a href="#cb48-938" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-939"><a href="#cb48-939" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(NO2 <span class="sc">~</span> <span class="fu">sqrt</span>(pop_dens), no2.sf)</span>
<span id="cb48-940"><a href="#cb48-940" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(NO2 <span class="sc">~</span> <span class="fu">sqrt</span>(pop_dens), no2.sf))</span>
<span id="cb48-941"><a href="#cb48-941" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-942"><a href="#cb48-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-943"><a href="#cb48-943" aria-hidden="true" tabindex="-1"></a>\index{variogram!residual}</span>
<span id="cb48-944"><a href="#cb48-944" aria-hidden="true" tabindex="-1"></a>Prediction under this new model involves first modelling a residual</span>
<span id="cb48-945"><a href="#cb48-945" aria-hidden="true" tabindex="-1"></a>variogram </span>
<span id="cb48-948"><a href="#cb48-948" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-949"><a href="#cb48-949" aria-hidden="true" tabindex="-1"></a>no2.sf <span class="ot">&lt;-</span> no2.sf[<span class="sc">!</span><span class="fu">is.na</span>(no2.sf<span class="sc">$</span>pop_dens),]</span>
<span id="cb48-950"><a href="#cb48-950" aria-hidden="true" tabindex="-1"></a>vr <span class="ot">&lt;-</span> <span class="fu">variogram</span>(NO2<span class="sc">~</span><span class="fu">sqrt</span>(pop_dens), no2.sf)</span>
<span id="cb48-951"><a href="#cb48-951" aria-hidden="true" tabindex="-1"></a>vr.m <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vr, <span class="fu">vgm</span>(<span class="dv">1</span>, <span class="st">"Exp"</span>, <span class="dv">50000</span>, <span class="dv">1</span>))</span>
<span id="cb48-952"><a href="#cb48-952" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-953"><a href="#cb48-953" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-predictusingpopulationdensity,echo=!knitr::is_latex_output()}</span></span>
<span id="cb48-954"><a href="#cb48-954" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Residual variogram after subtracting population density trend"</span></span>
<span id="cb48-955"><a href="#cb48-955" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-956"><a href="#cb48-956" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(vr, vr.m, <span class="at">plot.numbers =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-957"><a href="#cb48-957" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-958"><a href="#cb48-958" aria-hidden="true" tabindex="-1"></a>which is shown in @fig-predictusingpopulationdensity.</span>
<span id="cb48-959"><a href="#cb48-959" aria-hidden="true" tabindex="-1"></a>Subsequently, kriging prediction (@fig-residualkriging) is done by </span>
<span id="cb48-962"><a href="#cb48-962" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-963"><a href="#cb48-963" aria-hidden="true" tabindex="-1"></a>kr <span class="ot">&lt;-</span> <span class="fu">krige</span>(NO2 <span class="sc">~</span> <span class="fu">sqrt</span>(pop_dens), no2.sf, </span>
<span id="cb48-964"><a href="#cb48-964" aria-hidden="true" tabindex="-1"></a>            grd[<span class="st">"pop_dens"</span>], vr.m)</span>
<span id="cb48-965"><a href="#cb48-965" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-966"><a href="#cb48-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-967"><a href="#cb48-967" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig-residualkriging, echo=!knitr::is_latex_output(), message=FALSE}</span></span>
<span id="cb48-968"><a href="#cb48-968" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.cap: "Kriging NO$_2$ values using population density as a trend variable"</span></span>
<span id="cb48-969"><a href="#cb48-969" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb48-970"><a href="#cb48-970" aria-hidden="true" tabindex="-1"></a>k<span class="sc">$</span>kr1 <span class="ot">&lt;-</span> k<span class="sc">$</span>var1.pred</span>
<span id="cb48-971"><a href="#cb48-971" aria-hidden="true" tabindex="-1"></a>k<span class="sc">$</span>kr2 <span class="ot">&lt;-</span> kr<span class="sc">$</span>var1.pred</span>
<span id="cb48-972"><a href="#cb48-972" aria-hidden="true" tabindex="-1"></a><span class="fu">st_redimension</span>(k[<span class="fu">c</span>(<span class="st">"kr1"</span>, <span class="st">"kr2"</span>)], </span>
<span id="cb48-973"><a href="#cb48-973" aria-hidden="true" tabindex="-1"></a>    <span class="at">along =</span> <span class="fu">list</span>(<span class="at">what =</span> <span class="fu">c</span>(<span class="st">"kriging"</span>, <span class="st">"residual kriging"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb48-974"><a href="#cb48-974" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(<span class="st">"NO2"</span>) <span class="ot">-&gt;</span> km</span>
<span id="cb48-975"><a href="#cb48-975" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_stars</span>(<span class="at">data =</span> km, <span class="fu">aes</span>(<span class="at">fill =</span> NO2, <span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span> </span>
<span id="cb48-976"><a href="#cb48-976" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_cast</span>(de, <span class="st">"MULTILINESTRING"</span>)) <span class="sc">+</span> </span>
<span id="cb48-977"><a href="#cb48-977" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> no2.sf) <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>what) <span class="sc">+</span></span>
<span id="cb48-978"><a href="#cb48-978" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_sf</span>(<span class="at">lims_method =</span> <span class="st">"geometry_bbox"</span>)</span>
<span id="cb48-979"><a href="#cb48-979" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-980"><a href="#cb48-980" aria-hidden="true" tabindex="-1"></a>where, critically, the <span class="in">`pop_dens`</span> values are now available for</span>
<span id="cb48-981"><a href="#cb48-981" aria-hidden="true" tabindex="-1"></a>prediction locations in the <span class="in">`newdata`</span> object <span class="in">`grd`</span>.  </span>
<span id="cb48-982"><a href="#cb48-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-983"><a href="#cb48-983" aria-hidden="true" tabindex="-1"></a>Compared to (ordinary) kriging We see some clear differences:</span>
<span id="cb48-984"><a href="#cb48-984" aria-hidden="true" tabindex="-1"></a>the map using population density in the trend follows the extremes of</span>
<span id="cb48-985"><a href="#cb48-985" aria-hidden="true" tabindex="-1"></a>the population density rather than those of the measurement stations,</span>
<span id="cb48-986"><a href="#cb48-986" aria-hidden="true" tabindex="-1"></a>and has a value range that extends that of ordinary kriging. It</span>
<span id="cb48-987"><a href="#cb48-987" aria-hidden="true" tabindex="-1"></a>should be taken with a large grain of salt however, since the</span>
<span id="cb48-988"><a href="#cb48-988" aria-hidden="true" tabindex="-1"></a>stations used were filtered for the category "rural background",</span>
<span id="cb48-989"><a href="#cb48-989" aria-hidden="true" tabindex="-1"></a>indicating that they only represent conditions of lower populations</span>
<span id="cb48-990"><a href="#cb48-990" aria-hidden="true" tabindex="-1"></a>density. The scatter-plot of @fig-no2scat  reveals that the the</span>
<span id="cb48-991"><a href="#cb48-991" aria-hidden="true" tabindex="-1"></a>population density at the locations of stations is much more limited</span>
<span id="cb48-992"><a href="#cb48-992" aria-hidden="true" tabindex="-1"></a>than that in the population density map, and hence the right-hand</span>
<span id="cb48-993"><a href="#cb48-993" aria-hidden="true" tabindex="-1"></a>side map is based on strongly extrapolating the relationship shown</span>
<span id="cb48-994"><a href="#cb48-994" aria-hidden="true" tabindex="-1"></a>in @fig-no2scat.</span>
<span id="cb48-995"><a href="#cb48-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-996"><a href="#cb48-996" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises </span></span>
<span id="cb48-997"><a href="#cb48-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-998"><a href="#cb48-998" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Create a plot like the one in @fig-residualkriging </span>
<span id="cb48-999"><a href="#cb48-999" aria-hidden="true" tabindex="-1"></a>that has the inverse distance interpolated map of </span>
<span id="cb48-1000"><a href="#cb48-1000" aria-hidden="true" tabindex="-1"></a>@fig-idw added on the left side.</span>
<span id="cb48-1001"><a href="#cb48-1001" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Create a scatter-plot of the map values of the idw and kriging</span>
<span id="cb48-1002"><a href="#cb48-1002" aria-hidden="true" tabindex="-1"></a>map, and a scatter-plot of map values of idw and residual kriging.</span>
<span id="cb48-1003"><a href="#cb48-1003" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Carry out a _block kriging_, predicting block averages for blocks</span>
<span id="cb48-1004"><a href="#cb48-1004" aria-hidden="true" tabindex="-1"></a>centred over grid cells, by setting the <span class="in">`block`</span> argument in</span>
<span id="cb48-1005"><a href="#cb48-1005" aria-hidden="true" tabindex="-1"></a><span class="in">`krige()`</span>, and do this for block sizes of 10 km (grid cell size),</span>
<span id="cb48-1006"><a href="#cb48-1006" aria-hidden="true" tabindex="-1"></a>50 km, and 200 km. Compare the resulting maps of estimates for these</span>
<span id="cb48-1007"><a href="#cb48-1007" aria-hidden="true" tabindex="-1"></a>three block sizes with those obtained by point kriging, and</span>
<span id="cb48-1008"><a href="#cb48-1008" aria-hidden="true" tabindex="-1"></a>do the same thing for all associated kriging standard errors.</span>
<span id="cb48-1009"><a href="#cb48-1009" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Based on the residual kriging results obtained above, compute</span>
<span id="cb48-1010"><a href="#cb48-1010" aria-hidden="true" tabindex="-1"></a>maps of the lower and upper boundary of a 95% confidence interval,</span>
<span id="cb48-1011"><a href="#cb48-1011" aria-hidden="true" tabindex="-1"></a>when assuming that the kriging error is normally distributed,</span>
<span id="cb48-1012"><a href="#cb48-1012" aria-hidden="true" tabindex="-1"></a>and show them in a plot with a single (joint) legend.</span>
<span id="cb48-1013"><a href="#cb48-1013" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Compute and show the map with the probabilities that NO$_2$ point</span>
<span id="cb48-1014"><a href="#cb48-1014" aria-hidden="true" tabindex="-1"></a>values exceed the level of 15 ppm, assuming normally distributed</span>
<span id="cb48-1015"><a href="#cb48-1015" aria-hidden="true" tabindex="-1"></a>kriging errors.</span>
<span id="cb48-1016"><a href="#cb48-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1017"><a href="#cb48-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, eval=!CI}</span></span>
<span id="cb48-1018"><a href="#cb48-1018" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(v, b)</span>
<span id="cb48-1019"><a href="#cb48-1019" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(<span class="at">list =</span> <span class="fu">ls</span>(), <span class="at">file =</span> <span class="st">"ch12.RData"</span>)</span>
<span id="cb48-1020"><a href="#cb48-1020" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/edzer/sdsr/edit/python/12-Interpolation.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>